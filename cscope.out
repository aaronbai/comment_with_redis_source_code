cscope 15 $HOME/src/redis/src -q 0000009616 0001731128
	@adlist.c

32 
	~<¡dlib.h
>

33 
	~"adli¡.h
"

34 
	~"zm®loc.h
"

41 
li¡
 *
	$li¡C»©e
()

43 
li¡
 *list;

45 ià((
li¡
 = 
	`zm®loc
((*li¡))è=ğ
NULL
)

46  
NULL
;

47 
li¡
->
h—d
 =†i¡->

 = 
NULL
;

48 
li¡
->
Ën
 = 0;

49 
li¡
->
dup
 = 
NULL
;

50 
li¡
->
ä“
 = 
NULL
;

51 
li¡
->
m©ch
 = 
NULL
;

52  
li¡
;

53 
	}
}

58 
	$li¡R–—£
(
li¡
 *list)

60 
Ën
;

61 
li¡Node
 *
cu¼’t
, *
Ãxt
;

63 
cu¼’t
 = 
li¡
->
h—d
;

64 
Ën
 = 
li¡
->len;

65 
Ën
--) {

66 
Ãxt
 = 
cu¼’t
->next;

67 ià(
li¡
->
ä“
èli¡->
	`ä“
(
cu¼’t
->
v®ue
);

68 
	`zä“
(
cu¼’t
);

69 
cu¼’t
 = 
Ãxt
;

71 
	`zä“
(
li¡
);

72 
	}
}

80 
li¡
 *
	$li¡AddNodeH—d
(
li¡
 *li¡, *
v®ue
)

82 
li¡Node
 *
node
;

84 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

85  
NULL
;

86 
node
->
v®ue
 = value;

87 ià(
li¡
->
Ën
 == 0) {

88 
li¡
->
h—d
 =†i¡->

 = 
node
;

89 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

91 
node
->
´ev
 = 
NULL
;

92 
node
->
Ãxt
 = 
li¡
->
h—d
;

93 
li¡
->
h—d
->
´ev
 = 
node
;

94 
li¡
->
h—d
 = 
node
;

96 
li¡
->
Ën
++;

97  
li¡
;

98 
	}
}

106 
li¡
 *
	$li¡AddNodeTa
(
li¡
 *li¡, *
v®ue
)

108 
li¡Node
 *
node
;

110 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

111  
NULL
;

112 
node
->
v®ue
 = value;

113 ià(
li¡
->
Ën
 == 0) {

114 
li¡
->
h—d
 =†i¡->

 = 
node
;

115 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

117 
node
->
´ev
 = 
li¡
->

;

118 
node
->
Ãxt
 = 
NULL
;

119 
li¡
->

->
Ãxt
 = 
node
;

120 
li¡
->

 = 
node
;

122 
li¡
->
Ën
++;

123  
li¡
;

124 
	}
}

126 
li¡
 *
	$li¡In£¹Node
(
li¡
 *li¡, 
li¡Node
 *
Şd_node
, *
v®ue
, 
aá”
) {

127 
li¡Node
 *
node
;

129 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

130  
NULL
;

131 
node
->
v®ue
 = value;

132 ià(
aá”
) {

133 
node
->
´ev
 = 
Şd_node
;

134 
node
->
Ãxt
 = 
Şd_node
->next;

135 ià(
li¡
->

 =ğ
Şd_node
) {

136 
li¡
->

 = 
node
;

139 
node
->
Ãxt
 = 
Şd_node
;

140 
node
->
´ev
 = 
Şd_node
->prev;

141 ià(
li¡
->
h—d
 =ğ
Şd_node
) {

142 
li¡
->
h—d
 = 
node
;

145 ià(
node
->
´ev
 !ğ
NULL
) {

146 
node
->
´ev
->
Ãxt
 =‚ode;

148 ià(
node
->
Ãxt
 !ğ
NULL
) {

149 
node
->
Ãxt
->
´ev
 =‚ode;

151 
li¡
->
Ën
++;

152  
li¡
;

153 
	}
}

159 
	$li¡D–Node
(
li¡
 *li¡, 
li¡Node
 *
node
)

161 ià(
node
->
´ev
)

162 
node
->
´ev
->
Ãxt
 =‚ode->next;

164 
li¡
->
h—d
 = 
node
->
Ãxt
;

165 ià(
node
->
Ãxt
)

166 
node
->
Ãxt
->
´ev
 =‚ode->prev;

168 
li¡
->

 = 
node
->
´ev
;

169 ià(
li¡
->
ä“
èli¡->
	`ä“
(
node
->
v®ue
);

170 
	`zä“
(
node
);

171 
li¡
->
Ën
--;

172 
	}
}

178 
li¡I‹r
 *
	$li¡G‘I‹¿tÜ
(
li¡
 *li¡, 
dœeùiÚ
)

180 
li¡I‹r
 *
™”
;

182 ià((
™”
 = 
	`zm®loc
((*™”))è=ğ
NULL
)  NULL;

183 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
)

184 
™”
->
Ãxt
 = 
li¡
->
h—d
;

186 
™”
->
Ãxt
 = 
li¡
->

;

187 
™”
->
dœeùiÚ
 = direction;

188  
™”
;

189 
	}
}

192 
	$li¡R–—£I‹¿tÜ
(
li¡I‹r
 *
™”
) {

193 
	`zä“
(
™”
);

194 
	}
}

197 
	$li¡Rewšd
(
li¡
 *li¡, 
li¡I‹r
 *
li
) {

198 
li
->
Ãxt
 = 
li¡
->
h—d
;

199 
li
->
dœeùiÚ
 = 
AL_START_HEAD
;

200 
	}
}

202 
	$li¡RewšdTa
(
li¡
 *li¡, 
li¡I‹r
 *
li
) {

203 
li
->
Ãxt
 = 
li¡
->

;

204 
li
->
dœeùiÚ
 = 
AL_START_TAIL
;

205 
	}
}

221 
li¡Node
 *
	$li¡Next
(
li¡I‹r
 *
™”
)

223 
li¡Node
 *
cu¼’t
 = 
™”
->
Ãxt
;

225 ià(
cu¼’t
 !ğ
NULL
) {

226 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
)

227 
™”
->
Ãxt
 = 
cu¼’t
->next;

229 
™”
->
Ãxt
 = 
cu¼’t
->
´ev
;

231  
cu¼’t
;

232 
	}
}

242 
li¡
 *
	$li¡Dup
(
li¡
 *
Üig
)

244 
li¡
 *
cİy
;

245 
li¡I‹r
 
™”
;

246 
li¡Node
 *
node
;

248 ià((
cİy
 = 
	`li¡C»©e
()è=ğ
NULL
)

249  
NULL
;

250 
cİy
->
dup
 = 
Üig
->dup;

251 
cİy
->
ä“
 = 
Üig
->free;

252 
cİy
->
m©ch
 = 
Üig
->match;

253 
	`li¡Rewšd
(
Üig
, &
™”
);

254 (
node
 = 
	`li¡Next
(&
™”
)è!ğ
NULL
) {

255 *
v®ue
;

257 ià(
cİy
->
dup
) {

258 
v®ue
 = 
cİy
->
	`dup
(
node
->value);

259 ià(
v®ue
 =ğ
NULL
) {

260 
	`li¡R–—£
(
cİy
);

261  
NULL
;

264 
v®ue
 = 
node
->value;

265 ià(
	`li¡AddNodeTa
(
cİy
, 
v®ue
è=ğ
NULL
) {

266 
	`li¡R–—£
(
cİy
);

267  
NULL
;

270  
cİy
;

271 
	}
}

282 
li¡Node
 *
	$li¡S—rchKey
(
li¡
 *li¡, *
key
)

284 
li¡I‹r
 
™”
;

285 
li¡Node
 *
node
;

287 
	`li¡Rewšd
(
li¡
, &
™”
);

288 (
node
 = 
	`li¡Next
(&
™”
)è!ğ
NULL
) {

289 ià(
li¡
->
m©ch
) {

290 ià(
li¡
->
	`m©ch
(
node
->
v®ue
, 
key
)) {

291  
node
;

294 ià(
key
 =ğ
node
->
v®ue
) {

295  
node
;

299  
NULL
;

300 
	}
}

307 
li¡Node
 *
	$li¡Index
(
li¡
 *li¡, 
šdex
) {

308 
li¡Node
 *
n
;

310 ià(
šdex
 < 0) {

311 
šdex
 = (-index)-1;

312 
n
 = 
li¡
->

;

313 
šdex
-- && 
n
èÀğn->
´ev
;

315 
n
 = 
li¡
->
h—d
;

316 
šdex
-- && 
n
èÀğn->
Ãxt
;

318  
n
;

319 
	}
}

322 
	$li¡RÙ©e
(
li¡
 *list) {

323 
li¡Node
 *

 = 
li¡
->tail;

325 ià(
	`li¡L’gth
(
li¡
) <= 1) ;

328 
li¡
->

 =a->
´ev
;

329 
li¡
->

->
Ãxt
 = 
NULL
;

331 
li¡
->
h—d
->
´ev
 = 

;

332 

->
´ev
 = 
NULL
;

333 

->
Ãxt
 = 
li¡
->
h—d
;

334 
li¡
->
h—d
 = 

;

335 
	}
}

	@adlist.h

31 #iâdeà
__ADLIST_H__


32 
	#__ADLIST_H__


	)

36 
	sli¡Node
 {

37 
li¡Node
 *
	m´ev
;

38 
li¡Node
 *
	mÃxt
;

39 *
	mv®ue
;

40 } 
	tli¡Node
;

42 
	sli¡I‹r
 {

43 
li¡Node
 *
	mÃxt
;

44 
	mdœeùiÚ
;

45 } 
	tli¡I‹r
;

47 
	sli¡
 {

48 
li¡Node
 *
	mh—d
;

49 
li¡Node
 *
	m
;

50 *(*
	mdup
)(*
	m±r
);

51 (*
	mä“
)(*
	m±r
);

52 (*
	mm©ch
)(*
	m±r
, *
	mkey
);

53 
	mËn
;

54 } 
	tli¡
;

57 
	#li¡L’gth
(
l
è(Ö)->
Ën
)

	)

58 
	#li¡Fœ¡
(
l
è(Ö)->
h—d
)

	)

59 
	#li¡La¡
(
l
è(Ö)->

)

	)

60 
	#li¡P»vNode
(
n
è(Ò)->
´ev
)

	)

61 
	#li¡NextNode
(
n
è(Ò)->
Ãxt
)

	)

62 
	#li¡NodeV®ue
(
n
è(Ò)->
v®ue
)

	)

64 
	#li¡S‘DupM‘hod
(
l
,
m
è(Ö)->
dup
 = (m))

	)

65 
	#li¡S‘F»eM‘hod
(
l
,
m
è(Ö)->
ä“
 = (m))

	)

66 
	#li¡S‘M©chM‘hod
(
l
,
m
è(Ö)->
m©ch
 = (m))

	)

68 
	#li¡G‘DupM‘hod
(
l
è(Ö)->
dup
)

	)

69 
	#li¡G‘F»e
(
l
è(Ö)->
ä“
)

	)

70 
	#li¡G‘M©chM‘hod
(
l
è(Ö)->
m©ch
)

	)

73 
li¡
 *
li¡C»©e
();

74 
li¡R–—£
(
li¡
 *list);

75 
li¡
 *
li¡AddNodeH—d
Öi¡ *li¡, *
v®ue
);

76 
li¡
 *
li¡AddNodeTa
Öi¡ *li¡, *
v®ue
);

77 
li¡
 *
li¡In£¹Node
Öi¡ *li¡, 
li¡Node
 *
Şd_node
, *
v®ue
, 
aá”
);

78 
li¡D–Node
(
li¡
 *li¡, 
li¡Node
 *
node
);

79 
li¡I‹r
 *
li¡G‘I‹¿tÜ
(
li¡
 *li¡, 
dœeùiÚ
);

80 
li¡Node
 *
li¡Next
(
li¡I‹r
 *
™”
);

81 
li¡R–—£I‹¿tÜ
(
li¡I‹r
 *
™”
);

82 
li¡
 *
li¡Dup
Öi¡ *
Üig
);

83 
li¡Node
 *
li¡S—rchKey
(
li¡
 *li¡, *
key
);

84 
li¡Node
 *
li¡Index
(
li¡
 *li¡, 
šdex
);

85 
li¡Rewšd
(
li¡
 *li¡, 
li¡I‹r
 *
li
);

86 
li¡RewšdTa
(
li¡
 *li¡, 
li¡I‹r
 *
li
);

87 
li¡RÙ©e
(
li¡
 *list);

90 
	#AL_START_HEAD
 0

	)

91 
	#AL_START_TAIL
 1

	)

	@ae.c

33 
	~<¡dio.h
>

34 
	~<sys/time.h
>

35 
	~<sys/ty³s.h
>

36 
	~<uni¡d.h
>

37 
	~<¡dlib.h
>

38 
	~<pŞl.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

41 
	~<”ºo.h
>

43 
	~"«.h
"

44 
	~"zm®loc.h
"

45 
	~"cÚfig.h
"

49 #ifdeà
HAVE_EVPORT


50 
	~"«_evpÜt.c
"

52 #ifdeà
HAVE_EPOLL


53 
	~"«_•Şl.c
"

55 #ifdeà
HAVE_KQUEUE


56 
	~"«_kqueue.c
"

58 
	~"«_£Ëù.c
"

63 
«Ev’tLoİ
 *
	$«C»©eEv’tLoİ
(
£tsize
) {

64 
«Ev’tLoİ
 *
ev’tLoİ
;

65 
i
;

67 ià((
ev’tLoİ
 = 
	`zm®loc
((*ev’tLoİ))è=ğ
NULL
è
”r
;

68 
ev’tLoİ
->
ev’ts
 = 
	`zm®loc
((
«FeEv’t
)*
£tsize
);

69 
ev’tLoİ
->
fœed
 = 
	`zm®loc
((
«FœedEv’t
)*
£tsize
);

70 ià(
ev’tLoİ
->
ev’ts
 =ğ
NULL
 ||ƒv’tLoİ->
fœed
 =ğNULLè
”r
;

71 
ev’tLoİ
->
£tsize
 = setsize;

72 
ev’tLoİ
->
Ï¡Time
 = 
	`time
(
NULL
);

73 
ev’tLoİ
->
timeEv’tH—d
 = 
NULL
;

74 
ev’tLoİ
->
timeEv’tNextId
 = 0;

75 
ev’tLoİ
->
¡İ
 = 0;

76 
ev’tLoİ
->
maxfd
 = -1;

77 
ev’tLoİ
->
befÜe¦“p
 = 
NULL
;

78 ià(
	`«ApiC»©e
(
ev’tLoİ
è=ğ-1è
”r
;

81 
i
 = 0; i < 
£tsize
; i++)

82 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

83  
ev’tLoİ
;

85 
”r
:

86 ià(
ev’tLoİ
) {

87 
	`zä“
(
ev’tLoİ
->
ev’ts
);

88 
	`zä“
(
ev’tLoİ
->
fœed
);

89 
	`zä“
(
ev’tLoİ
);

91  
NULL
;

92 
	}
}

95 
	$«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
) {

96  
ev’tLoİ
->
£tsize
;

97 
	}
}

106 
	$«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

107 
i
;

109 ià(
£tsize
 =ğ
ev’tLoİ
->£tsizeè 
AE_OK
;

110 ià(
ev’tLoİ
->
maxfd
 >ğ
£tsize
è 
AE_ERR
;

111 ià(
	`«ApiResize
(
ev’tLoİ
,
£tsize
è=ğ-1è 
AE_ERR
;

113 
ev’tLoİ
->
ev’ts
 = 
	`z»®loc
Óv’tLoİ->ev’ts,(
«FeEv’t
)*
£tsize
);

114 
ev’tLoİ
->
fœed
 = 
	`z»®loc
Óv’tLoİ->fœed,(
«FœedEv’t
)*
£tsize
);

115 
ev’tLoİ
->
£tsize
 = setsize;

119 
i
 = 
ev’tLoİ
->
maxfd
+1; i < 
£tsize
; i++)

120 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

121  
AE_OK
;

122 
	}
}

124 
	$«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

125 
	`«ApiF»e
(
ev’tLoİ
);

126 
	`zä“
(
ev’tLoİ
->
ev’ts
);

127 
	`zä“
(
ev’tLoİ
->
fœed
);

128 
	`zä“
(
ev’tLoİ
);

129 
	}
}

131 
	$«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

132 
ev’tLoİ
->
¡İ
 = 1;

133 
	}
}

135 
	$«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

136 
«FeProc
 *
´oc
, *
ş›ÁD©a
)

138 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) {

139 
”ºo
 = 
ERANGE
;

140  
AE_ERR
;

142 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

144 ià(
	`«ApiAddEv’t
(
ev’tLoİ
, 
fd
, 
mask
) == -1)

145  
AE_ERR
;

146 
ã
->
mask
 |= mask;

147 ià(
mask
 & 
AE_READABLE
è
ã
->
rfeProc
 = 
´oc
;

148 ià(
mask
 & 
AE_WRITABLE
è
ã
->
wfeProc
 = 
´oc
;

149 
ã
->
ş›ÁD©a
 = clientData;

150 ià(
fd
 > 
ev’tLoİ
->
maxfd
)

151 
ev’tLoİ
->
maxfd
 = 
fd
;

152  
AE_OK
;

153 
	}
}

155 
	$«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
)

157 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) ;

158 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

159 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

161 
	`«ApiD–Ev’t
(
ev’tLoİ
, 
fd
, 
mask
);

162 
ã
->
mask
 = fe->mask & (~mask);

163 ià(
fd
 =ğ
ev’tLoİ
->
maxfd
 && 
ã
->
mask
 =ğ
AE_NONE
) {

165 
j
;

167 
j
 = 
ev’tLoİ
->
maxfd
-1; j >= 0; j--)

168 ià(
ev’tLoİ
->
ev’ts
[
j
].
mask
 !ğ
AE_NONE
) ;

169 
ev’tLoİ
->
maxfd
 = 
j
;

171 
	}
}

173 
	$«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
) {

174 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
)  0;

175 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

177  
ã
->
mask
;

178 
	}
}

180 
	$«G‘Time
(*
£cÚds
, *
mli£cÚds
)

182 
timev®
 
tv
;

184 
	`g‘timeofday
(&
tv
, 
NULL
);

185 *
£cÚds
 = 
tv
.
tv_£c
;

186 *
mli£cÚds
 = 
tv
.
tv_u£c
/1000;

187 
	}
}

189 
	$«AddMli£cÚdsToNow
(
mli£cÚds
, *
£c
, *
ms
) {

190 
cur_£c
, 
cur_ms
, 
wh’_£c
, 
wh’_ms
;

192 
	`«G‘Time
(&
cur_£c
, &
cur_ms
);

193 
wh’_£c
 = 
cur_£c
 + 
mli£cÚds
/1000;

194 
wh’_ms
 = 
cur_ms
 + 
mli£cÚds
%1000;

195 ià(
wh’_ms
 >= 1000) {

196 
wh’_£c
 ++;

197 
wh’_ms
 -= 1000;

199 *
£c
 = 
wh’_£c
;

200 *
ms
 = 
wh’_ms
;

201 
	}
}

203 
	$«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

204 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

205 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
)

207 
id
 = 
ev’tLoİ
->
timeEv’tNextId
++;

208 
«TimeEv’t
 *
‹
;

210 
‹
 = 
	`zm®loc
((*te));

211 ià(
‹
 =ğ
NULL
è 
AE_ERR
;

212 
‹
->
id
 = id;

213 
	`«AddMli£cÚdsToNow
(
mli£cÚds
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

214 
‹
->
timeProc
 = 
´oc
;

215 
‹
->
fš®iz”Proc
 = finalizerProc;

216 
‹
->
ş›ÁD©a
 = clientData;

217 
‹
->
Ãxt
 = 
ev’tLoİ
->
timeEv’tH—d
;

218 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
;

219  
id
;

220 
	}
}

222 
	$«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
)

224 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

225 
‹
) {

226 ià(
‹
->
id
 == id) {

227 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

228  
AE_OK
;

230 
‹
 =e->
Ãxt
;

232  
AE_ERR
;

233 
	}
}

246 
«TimeEv’t
 *
	$«S—rchN—»¡Tim”
(
«Ev’tLoİ
 *
ev’tLoİ
)

248 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

249 
«TimeEv’t
 *
Ã¬e¡
 = 
NULL
;

251 
‹
) {

252 ià(!
Ã¬e¡
 || 
‹
->
wh’_£c
 <‚earest->when_sec ||

253 (
‹
->
wh’_£c
 =ğ
Ã¬e¡
->when_sec &&

254 
‹
->
wh’_ms
 < 
Ã¬e¡
->when_ms))

255 
Ã¬e¡
 = 
‹
;

256 
‹
 =e->
Ãxt
;

258  
Ã¬e¡
;

259 
	}
}

262 
	$´oûssTimeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
) {

263 
´oûs£d
 = 0;

264 
«TimeEv’t
 *
‹
, *
´ev
;

265 
maxId
;

266 
time_t
 
now
 = 
	`time
(
NULL
);

276 ià(
now
 < 
ev’tLoİ
->
Ï¡Time
) {

277 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

278 
‹
) {

279 
‹
->
wh’_£c
 = 0;

280 
‹
 =e->
Ãxt
;

283 
ev’tLoİ
->
Ï¡Time
 = 
now
;

285 
´ev
 = 
NULL
;

286 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

287 
maxId
 = 
ev’tLoİ
->
timeEv’tNextId
-1;

288 
‹
) {

289 
now_£c
, 
now_ms
;

290 
id
;

293 ià(
‹
->
id
 =ğ
AE_DELETED_EVENT_ID
) {

294 
«TimeEv’t
 *
Ãxt
 = 
‹
->next;

295 ià(
´ev
 =ğ
NULL
)

296 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
->
Ãxt
;

298 
´ev
->
Ãxt
 = 
‹
->next;

299 ià(
‹
->
fš®iz”Proc
)

300 
‹
->
	`fš®iz”Proc
(
ev’tLoİ
,e->
ş›ÁD©a
);

301 
	`zä“
(
‹
);

302 
‹
 = 
Ãxt
;

311 ià(
‹
->
id
 > 
maxId
) {

312 
‹
 =e->
Ãxt
;

315 
	`«G‘Time
(&
now_£c
, &
now_ms
);

316 ià(
now_£c
 > 
‹
->
wh’_£c
 ||

317 (
now_£c
 =ğ
‹
->
wh’_£c
 && 
now_ms
 >ğ‹->
wh’_ms
))

319 
»tv®
;

321 
id
 = 
‹
->id;

322 
»tv®
 = 
‹
->
	`timeProc
(
ev’tLoİ
, 
id
,e->
ş›ÁD©a
);

323 
´oûs£d
++;

324 ià(
»tv®
 !ğ
AE_NOMORE
) {

325 
	`«AddMli£cÚdsToNow
(
»tv®
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

327 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

330 
´ev
 = 
‹
;

331 
‹
 =e->
Ãxt
;

333  
´oûs£d
;

334 
	}
}

349 
	$«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
)

351 
´oûs£d
 = 0, 
numev’ts
;

354 ià(!(
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_FILE_EVENTS
))  0;

360 ià(
ev’tLoİ
->
maxfd
 != -1 ||

361 ((
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_DONT_WAIT
))) {

362 
j
;

363 
«TimeEv’t
 *
shÜ‹¡
 = 
NULL
;

364 
timev®
 
tv
, *
tvp
;

366 ià(
æags
 & 
AE_TIME_EVENTS
 && !(æag & 
AE_DONT_WAIT
))

367 
shÜ‹¡
 = 
	`«S—rchN—»¡Tim”
(
ev’tLoİ
);

368 ià(
shÜ‹¡
) {

369 
now_£c
, 
now_ms
;

371 
	`«G‘Time
(&
now_£c
, &
now_ms
);

372 
tvp
 = &
tv
;

376 
ms
 =

377 (
shÜ‹¡
->
wh’_£c
 - 
now_£c
)*1000 +

378 
shÜ‹¡
->
wh’_ms
 - 
now_ms
;

380 ià(
ms
 > 0) {

381 
tvp
->
tv_£c
 = 
ms
/1000;

382 
tvp
->
tv_u£c
 = (
ms
 % 1000)*1000;

384 
tvp
->
tv_£c
 = 0;

385 
tvp
->
tv_u£c
 = 0;

391 ià(
æags
 & 
AE_DONT_WAIT
) {

392 
tv
.
tv_£c
 =v.
tv_u£c
 = 0;

393 
tvp
 = &
tv
;

396 
tvp
 = 
NULL
;

400 
numev’ts
 = 
	`«ApiPŞl
(
ev’tLoİ
, 
tvp
);

401 
j
 = 0; j < 
numev’ts
; j++) {

402 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[ev’tLoİ->
fœed
[
j
].
fd
];

403 
mask
 = 
ev’tLoİ
->
fœed
[
j
].mask;

404 
fd
 = 
ev’tLoİ
->
fœed
[
j
].fd;

405 
rfœed
 = 0;

410 ià(
ã
->
mask
 & mask & 
AE_READABLE
) {

411 
rfœed
 = 1;

412 
ã
->
	`rfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

414 ià(
ã
->
mask
 & mask & 
AE_WRITABLE
) {

415 ià(!
rfœed
 || 
ã
->
wfeProc
 !ğã->
rfeProc
)

416 
ã
->
	`wfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

418 
´oûs£d
++;

422 ià(
æags
 & 
AE_TIME_EVENTS
)

423 
´oûs£d
 +ğ
	`´oûssTimeEv’ts
(
ev’tLoİ
);

425  
´oûs£d
;

426 
	}
}

430 
	$«Wa™
(
fd
, 
mask
, 
mli£cÚds
) {

431 
pŞlfd
 
pfd
;

432 
»tmask
 = 0, 
»tv®
;

434 
	`mem£t
(&
pfd
, 0, (pfd));

435 
pfd
.
fd
 = fd;

436 ià(
mask
 & 
AE_READABLE
è
pfd
.
ev’ts
 |ğ
POLLIN
;

437 ià(
mask
 & 
AE_WRITABLE
è
pfd
.
ev’ts
 |ğ
POLLOUT
;

439 ià((
»tv®
 = 
	`pŞl
(&
pfd
, 1, 
mli£cÚds
))== 1) {

440 ià(
pfd
.
»v’ts
 & 
POLLIN
è
»tmask
 |ğ
AE_READABLE
;

441 ià(
pfd
.
»v’ts
 & 
POLLOUT
è
»tmask
 |ğ
AE_WRITABLE
;

442 ià(
pfd
.
»v’ts
 & 
POLLERR
è
»tmask
 |ğ
AE_WRITABLE
;

443 ià(
pfd
.
»v’ts
 & 
POLLHUP
è
»tmask
 |ğ
AE_WRITABLE
;

444  
»tmask
;

446  
»tv®
;

448 
	}
}

450 
	$«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
) {

451 
ev’tLoİ
->
¡İ
 = 0;

452 !
ev’tLoİ
->
¡İ
) {

453 ià(
ev’tLoİ
->
befÜe¦“p
 !ğ
NULL
)

454 
ev’tLoİ
->
	`befÜe¦“p
(eventLoop);

455 
	`«ProûssEv’ts
(
ev’tLoİ
, 
AE_ALL_EVENTS
);

457 
	}
}

459 *
	$«G‘ApiName
() {

460  
	`«ApiName
();

461 
	}
}

463 
	$«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
) {

464 
ev’tLoİ
->
befÜe¦“p
 = beforesleep;

465 
	}
}

	@ae.h

33 #iâdeà
__AE_H__


34 
	#__AE_H__


	)

36 
	~<time.h
>

38 
	#AE_OK
 0

	)

39 
	#AE_ERR
 -1

	)

41 
	#AE_NONE
 0

	)

42 
	#AE_READABLE
 1

	)

43 
	#AE_WRITABLE
 2

	)

45 
	#AE_FILE_EVENTS
 1

	)

46 
	#AE_TIME_EVENTS
 2

	)

47 
	#AE_ALL_EVENTS
 (
AE_FILE_EVENTS
|
AE_TIME_EVENTS
)

	)

48 
	#AE_DONT_WAIT
 4

	)

50 
	#AE_NOMORE
 -1

	)

51 
	#AE_DELETED_EVENT_ID
 -1

	)

54 
	#AE_NOTUSED
(
V
è((èV)

	)

56 
	g«Ev’tLoİ
;

59 
	t«FeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tfd
, *
	tş›ÁD©a
, 
	tmask
);

60 
	t«TimeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tid
, *
	tş›ÁD©a
);

61 
	t«Ev’tFš®iz”Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, *
	tş›ÁD©a
);

62 
	t«BefÜeSË•Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
);

65 
	s«FeEv’t
 {

66 
	mmask
;

67 
«FeProc
 *
	mrfeProc
;

68 
«FeProc
 *
	mwfeProc
;

69 *
	mş›ÁD©a
;

70 } 
	t«FeEv’t
;

73 
	s«TimeEv’t
 {

74 
	mid
;

75 
	mwh’_£c
;

76 
	mwh’_ms
;

77 
«TimeProc
 *
	mtimeProc
;

78 
«Ev’tFš®iz”Proc
 *
	mfš®iz”Proc
;

79 *
	mş›ÁD©a
;

80 
«TimeEv’t
 *
	mÃxt
;

81 } 
	t«TimeEv’t
;

84 
	s«FœedEv’t
 {

85 
	mfd
;

86 
	mmask
;

87 } 
	t«FœedEv’t
;

90 
	s«Ev’tLoİ
 {

91 
	mmaxfd
;

92 
	m£tsize
;

93 
	mtimeEv’tNextId
;

94 
time_t
 
	mÏ¡Time
;

95 
«FeEv’t
 *
	mev’ts
;

96 
«FœedEv’t
 *
	mfœed
;

97 
«TimeEv’t
 *
	mtimeEv’tH—d
;

98 
	m¡İ
;

99 *
	m­id©a
;

100 
«BefÜeSË•Proc
 *
	mbefÜe¦“p
;

101 } 
	t«Ev’tLoİ
;

104 
«Ev’tLoİ
 *
«C»©eEv’tLoİ
(
£tsize
);

105 
«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

106 
«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

107 
«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

108 
«FeProc
 *
´oc
, *
ş›ÁD©a
);

109 
«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
);

110 
«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
);

111 
«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

112 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

113 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
);

114 
«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
);

115 
«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
);

116 
«Wa™
(
fd
, 
mask
, 
mli£cÚds
);

117 
«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
);

118 *
«G‘ApiName
();

119 
«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
);

120 
«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
);

121 
«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
);

	@ae_epoll.c

32 
	~<sys/•Şl.h
>

34 
	s«ApiS‹
 {

35 
	m•fd
;

36 
•Şl_ev’t
 *
	mev’ts
;

37 } 
	t«ApiS‹
;

39 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

40 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

42 ià(!
¡©e
)  -1;

43 
¡©e
->
ev’ts
 = 
	`zm®loc
((
•Şl_ev’t
)*
ev’tLoİ
->
£tsize
);

44 ià(!
¡©e
->
ev’ts
) {

45 
	`zä“
(
¡©e
);

48 
¡©e
->
•fd
 = 
	`•Şl_ü—‹
(1024);

49 ià(
¡©e
->
•fd
 == -1) {

50 
	`zä“
(
¡©e
->
ev’ts
);

51 
	`zä“
(
¡©e
);

54 
ev’tLoİ
->
­id©a
 = 
¡©e
;

56 
	}
}

58 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

59 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

61 
¡©e
->
ev’ts
 = 
	`z»®loc
(¡©e->ev’ts, (
•Şl_ev’t
)*
£tsize
);

63 
	}
}

65 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

66 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

68 
	`şo£
(
¡©e
->
•fd
);

69 
	`zä“
(
¡©e
->
ev’ts
);

70 
	`zä“
(
¡©e
);

71 
	}
}

73 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

74 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

75 
•Şl_ev’t
 
“
 = {0};

78 
İ
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
 =ğ
AE_NONE
 ?

79 
EPOLL_CTL_ADD
 : 
EPOLL_CTL_MOD
;

81 
“
.
ev’ts
 = 0;

82 
mask
 |ğ
ev’tLoİ
->
ev’ts
[
fd
].mask;

83 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

84 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

85 
“
.
d©a
.
fd
 = fd;

86 ià(
	`•Şl_ùl
(
¡©e
->
•fd
,
İ
,
fd
,&
“
) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
d–mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
•Şl_ev’t
 
“
 = {0};

93 
mask
 = 
ev’tLoİ
->
ev’ts
[
fd
].mask & (~
d–mask
);

95 
“
.
ev’ts
 = 0;

96 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

97 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

98 
“
.
d©a
.
fd
 = fd;

99 ià(
mask
 !ğ
AE_NONE
) {

100 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_MOD
,
fd
,&
“
);

104 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_DEL
,
fd
,&
“
);

106 
	}
}

108 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

109 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

110 
»tv®
, 
numev’ts
 = 0;

112 
»tv®
 = 
	`•Şl_wa™
(
¡©e
->
•fd
,¡©e->
ev’ts
,
ev’tLoİ
->
£tsize
,

113 
tvp
 ? (tvp->
tv_£c
*1000 +vp->
tv_u£c
/1000) : -1);

114 ià(
»tv®
 > 0) {

115 
j
;

117 
numev’ts
 = 
»tv®
;

118 
j
 = 0; j < 
numev’ts
; j++) {

119 
mask
 = 0;

120 
•Şl_ev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

122 ià(
e
->
ev’ts
 & 
EPOLLIN
è
mask
 |ğ
AE_READABLE
;

123 ià(
e
->
ev’ts
 & 
EPOLLOUT
è
mask
 |ğ
AE_WRITABLE
;

124 ià(
e
->
ev’ts
 & 
EPOLLERR
è
mask
 |ğ
AE_WRITABLE
;

125 ià(
e
->
ev’ts
 & 
EPOLLHUP
è
mask
 |ğ
AE_WRITABLE
;

126 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
d©a
.fd;

127 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

130  
numev’ts
;

131 
	}
}

133 *
	$«ApiName
() {

135 
	}
}

	@ae_evport.c

31 
	~<as£¹.h
>

32 
	~<”ºo.h
>

33 
	~<pÜt.h
>

34 
	~<pŞl.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/time.h
>

39 
	~<¡dio.h
>

41 
	gevpÜt_debug
 = 0;

66 
	#MAX_EVENT_BATCHSZ
 512

	)

68 
	s«ApiS‹
 {

69 
	mpÜtfd
;

70 
	mÅ’dšg
;

71 
	m³ndšg_fds
[
MAX_EVENT_BATCHSZ
];

72 
	m³ndšg_masks
[
MAX_EVENT_BATCHSZ
];

73 } 
	t«ApiS‹
;

75 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

76 
i
;

77 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

78 ià(!
¡©e
)  -1;

80 
¡©e
->
pÜtfd
 = 
	`pÜt_ü—‹
();

81 ià(
¡©e
->
pÜtfd
 == -1) {

82 
	`zä“
(
¡©e
);

86 
¡©e
->
Å’dšg
 = 0;

88 
i
 = 0; i < 
MAX_EVENT_BATCHSZ
; i++) {

89 
¡©e
->
³ndšg_fds
[
i
] = -1;

90 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

93 
ev’tLoİ
->
­id©a
 = 
¡©e
;

95 
	}
}

97 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

100 
	}
}

102 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

103 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

105 
	`şo£
(
¡©e
->
pÜtfd
);

106 
	`zä“
(
¡©e
);

107 
	}
}

109 
	$«ApiLookupP’dšg
(
«ApiS‹
 *
¡©e
, 
fd
) {

110 
i
;

112 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

113 ià(
¡©e
->
³ndšg_fds
[
i
] =ğ
fd
)

114  (
i
);

118 
	}
}

123 
	$«ApiAssocŸ‹
(cÚ¡ *
wh”e
, 
pÜtfd
, 
fd
, 
mask
) {

124 
ev’ts
 = 0;

125 
rv
, 
”r
;

127 ià(
mask
 & 
AE_READABLE
)

128 
ev’ts
 |ğ
POLLIN
;

129 ià(
mask
 & 
AE_WRITABLE
)

130 
ev’ts
 |ğ
POLLOUT
;

132 ià(
evpÜt_debug
)

133 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹(%d, 0x%xèğ", 
wh”e
, 
fd
, 
ev’ts
);

135 
rv
 = 
	`pÜt_assocŸ‹
(
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
, 
ev’ts
,

136 (*)(
ušŒ_t
)
mask
);

137 
”r
 = 
”ºo
;

139 ià(
evpÜt_debug
)

140 
	`årštf
(
¡d”r
, "%d (%s)\n", 
rv
,„v =ğ0 ? "nØ”rÜ" : 
	`¡»¼Ü
(
”r
));

142 ià(
rv
 == -1) {

143 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹: %s\n", 
wh”e
, 
	`¡»¼Ü
(
”r
));

145 ià(
”r
 =ğ
EAGAIN
)

146 
	`årštf
(
¡d”r
, "aeApiAssociate:ƒvent…ort†imitƒxceeded.");

149  
rv
;

150 
	}
}

152 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

153 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

154 
fuÎmask
, 
pfd
;

156 ià(
evpÜt_debug
)

157 
	`årštf
(
¡d”r
, "«ApiAddEv’t: fd %d mask 0x%x\n", 
fd
, 
mask
);

164 
fuÎmask
 = 
mask
 | 
ev’tLoİ
->
ev’ts
[
fd
].mask;

165 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

167 ià(
pfd
 != -1) {

174 ià(
evpÜt_debug
)

175 
	`årštf
(
¡d”r
, "«ApiAddEv’t:‡ddšgØ³ndšg fd %d\n", 
fd
);

176 
¡©e
->
³ndšg_masks
[
pfd
] |ğ
fuÎmask
;

180  (
	`«ApiAssocŸ‹
("«ApiAddEv’t", 
¡©e
->
pÜtfd
, 
fd
, 
fuÎmask
));

181 
	}
}

183 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

184 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

185 
fuÎmask
, 
pfd
;

187 ià(
evpÜt_debug
)

188 
	`årštf
(
¡d”r
, "d– fd %d mask 0x%x\n", 
fd
, 
mask
);

190 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

192 ià(
pfd
 != -1) {

193 ià(
evpÜt_debug
)

194 
	`årštf
(
¡d”r
, "d–‘šgƒv’ˆäom…’dšg fd %d\n", 
fd
);

201 
¡©e
->
³ndšg_masks
[
pfd
] &ğ~
mask
;

203 ià(
¡©e
->
³ndšg_masks
[
pfd
] =ğ
AE_NONE
)

204 
¡©e
->
³ndšg_fds
[
pfd
] = -1;

217 
fuÎmask
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
;

218 ià(
fuÎmask
 =ğ
AE_NONE
) {

223 ià(
evpÜt_debug
)

224 
	`årštf
(
¡d”r
, "«ApiD–Ev’t:…Üt_dissocŸ‹(%d)\n", 
fd
);

226 ià(
	`pÜt_dissocŸ‹
(
¡©e
->
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
) != 0) {

227 
	`³¼Ü
("aeApiDelEvent:…ort_dissociate");

228 
	`abÜt
();

230 } ià(
	`«ApiAssocŸ‹
("«ApiD–Ev’t", 
¡©e
->
pÜtfd
, 
fd
,

231 
fuÎmask
) != 0) {

239 
	`abÜt
();

241 
	}
}

243 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

244 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

245 
time¥ec
 
timeout
, *
t¥
;

246 
mask
, 
i
;

247 
ušt_t
 
Ãv’ts
;

248 
pÜt_ev’t_t
 
ev’t
[
MAX_EVENT_BATCHSZ
];

255 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

256 ià(
¡©e
->
³ndšg_fds
[
i
] == -1)

260 ià(
	`«ApiAssocŸ‹
("«ApiPŞl", 
¡©e
->
pÜtfd
,

261 
¡©e
->
³ndšg_fds
[
i
], s‹->
³ndšg_masks
[i]) != 0) {

263 
	`abÜt
();

266 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

267 
¡©e
->
³ndšg_fds
[
i
] = -1;

270 
¡©e
->
Å’dšg
 = 0;

272 ià(
tvp
 !ğ
NULL
) {

273 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

274 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

275 
t¥
 = &
timeout
;

277 
t¥
 = 
NULL
;

284 
Ãv’ts
 = 1;

285 ià(
	`pÜt_g‘n
(
¡©e
->
pÜtfd
, 
ev’t
, 
MAX_EVENT_BATCHSZ
, &
Ãv’ts
,

286 
t¥
è=ğ-1 && (
”ºo
 !ğ
ETIME
 || 
Ãv’ts
 == 0)) {

287 ià(
”ºo
 =ğ
ETIME
 ||ƒ¼nØ=ğ
EINTR
)

291 
	`³¼Ü
("aeApiPoll:…ort_get");

292 
	`abÜt
();

295 
¡©e
->
Å’dšg
 = 
Ãv’ts
;

297 
i
 = 0; i < 
Ãv’ts
; i++) {

298 
mask
 = 0;

299 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLIN
)

300 
mask
 |ğ
AE_READABLE
;

301 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLOUT
)

302 
mask
 |ğ
AE_WRITABLE
;

304 
ev’tLoİ
->
fœed
[
i
].
fd
 = 
ev’t
[i].
pÜ‹v_objeù
;

305 
ev’tLoİ
->
fœed
[
i
].
mask
 = mask;

307 ià(
evpÜt_debug
)

308 
	`årštf
(
¡d”r
, "aeApiPoll: fd %d mask 0x%x\n",

309 ()
ev’t
[
i
].
pÜ‹v_objeù
, 
mask
);

311 
¡©e
->
³ndšg_fds
[
i
] = 
ev’t
[i].
pÜ‹v_objeù
;

312 
¡©e
->
³ndšg_masks
[
i
] = (
ušŒ_t
)
ev’t
[i].
pÜ‹v_u£r
;

315  
Ãv’ts
;

316 
	}
}

318 *
	$«ApiName
() {

320 
	}
}

	@ae_kqueue.c

32 
	~<sys/ty³s.h
>

33 
	~<sys/ev’t.h
>

34 
	~<sys/time.h
>

36 
	s«ApiS‹
 {

37 
	mkqfd
;

38 
kev’t
 *
	mev’ts
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
¡©e
->
ev’ts
 = 
	`zm®loc
((
kev’t
)*
ev’tLoİ
->
£tsize
);

46 ià(!
¡©e
->
ev’ts
) {

47 
	`zä“
(
¡©e
);

50 
¡©e
->
kqfd
 = 
	`kqueue
();

51 ià(
¡©e
->
kqfd
 == -1) {

52 
	`zä“
(
¡©e
->
ev’ts
);

53 
	`zä“
(
¡©e
);

56 
ev’tLoİ
->
­id©a
 = 
¡©e
;

58 
	}
}

60 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

61 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

63 
¡©e
->
ev’ts
 = 
	`z»®loc
(¡©e->ev’ts, (
kev’t
)*
£tsize
);

65 
	}
}

67 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

68 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

70 
	`şo£
(
¡©e
->
kqfd
);

71 
	`zä“
(
¡©e
->
ev’ts
);

72 
	`zä“
(
¡©e
);

73 
	}
}

75 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

76 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

77 
kev’t
 
ke
;

79 ià(
mask
 & 
AE_READABLE
) {

80 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_ADD
, 0, 0, 
NULL
);

81 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

83 ià(
mask
 & 
AE_WRITABLE
) {

84 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_ADD
, 0, 0, 
NULL
);

85 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
kev’t
 
ke
;

94 ià(
mask
 & 
AE_READABLE
) {

95 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

96 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

98 ià(
mask
 & 
AE_WRITABLE
) {

99 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 
NULL
);

100 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

102 
	}
}

104 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

105 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

106 
»tv®
, 
numev’ts
 = 0;

108 ià(
tvp
 !ğ
NULL
) {

109 
time¥ec
 
timeout
;

110 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

111 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

112 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

113 &
timeout
);

115 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

116 
NULL
);

119 ià(
»tv®
 > 0) {

120 
j
;

122 
numev’ts
 = 
»tv®
;

123 
j
 = 0; j < 
numev’ts
; j++) {

124 
mask
 = 0;

125 
kev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

127 ià(
e
->
f‹r
 =ğ
EVFILT_READ
è
mask
 |ğ
AE_READABLE
;

128 ià(
e
->
f‹r
 =ğ
EVFILT_WRITE
è
mask
 |ğ
AE_WRITABLE
;

129 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
id’t
;

130 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

133  
numev’ts
;

134 
	}
}

136 *
	$«ApiName
() {

138 
	}
}

	@ae_select.c

32 
	~<sys/£Ëù.h
>

33 
	~<¡ršg.h
>

35 
	s«ApiS‹
 {

36 
fd_£t
 
	mrfds
, 
	mwfds
;

39 
fd_£t
 
	m_rfds
, 
	m_wfds
;

40 } 
	t«ApiS‹
;

42 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

43 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

45 ià(!
¡©e
)  -1;

46 
	`FD_ZERO
(&
¡©e
->
rfds
);

47 
	`FD_ZERO
(&
¡©e
->
wfds
);

48 
ev’tLoİ
->
­id©a
 = 
¡©e
;

50 
	}
}

52 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

54 ià(
£tsize
 >ğ
FD_SETSIZE
)  -1;

56 
	}
}

58 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

59 
	`zä“
(
ev’tLoİ
->
­id©a
);

60 
	}
}

62 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

63 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

65 ià(
mask
 & 
AE_READABLE
è
	`FD_SET
(
fd
,&
¡©e
->
rfds
);

66 ià(
mask
 & 
AE_WRITABLE
è
	`FD_SET
(
fd
,&
¡©e
->
wfds
);

68 
	}
}

70 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

71 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

73 ià(
mask
 & 
AE_READABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
rfds
);

74 ià(
mask
 & 
AE_WRITABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
wfds
);

75 
	}
}

77 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

78 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

79 
»tv®
, 
j
, 
numev’ts
 = 0;

81 
	`memıy
(&
¡©e
->
_rfds
,&¡©e->
rfds
,(
fd_£t
));

82 
	`memıy
(&
¡©e
->
_wfds
,&¡©e->
wfds
,(
fd_£t
));

84 
»tv®
 = 
	`£Ëù
(
ev’tLoİ
->
maxfd
+1,

85 &
¡©e
->
_rfds
,&¡©e->
_wfds
,
NULL
,
tvp
);

86 ià(
»tv®
 > 0) {

87 
j
 = 0; j <ğ
ev’tLoİ
->
maxfd
; j++) {

88 
mask
 = 0;

89 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
j
];

91 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

92 ià(
ã
->
mask
 & 
AE_READABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_rfds
))

93 
mask
 |ğ
AE_READABLE
;

94 ià(
ã
->
mask
 & 
AE_WRITABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_wfds
))

95 
mask
 |ğ
AE_WRITABLE
;

96 
ev’tLoİ
->
fœed
[
numev’ts
].
fd
 = 
j
;

97 
ev’tLoİ
->
fœed
[
numev’ts
].
mask
 = mask;

98 
numev’ts
++;

101  
numev’ts
;

102 
	}
}

104 *
	$«ApiName
() {

106 
	}
}

	@anet.c

31 
	~"fmaüos.h
"

33 
	~<sys/ty³s.h
>

34 
	~<sys/sock‘.h
>

35 
	~<sys/¡©.h
>

36 
	~<sys/un.h
>

37 
	~<sys/time.h
>

38 
	~<Ãtš‘/š.h
>

39 
	~<Ãtš‘/tı.h
>

40 
	~<¬·/š‘.h
>

41 
	~<uni¡d.h
>

42 
	~<fú.h
>

43 
	~<¡ršg.h
>

44 
	~<Ãtdb.h
>

45 
	~<”ºo.h
>

46 
	~<¡d¬g.h
>

47 
	~<¡dio.h
>

49 
	~"ª‘.h
"

51 
	$ª‘S‘E¼Ü
(*
”r
, cÚ¡ *
fmt
, ...)

53 
va_li¡
 
­
;

55 ià(!
”r
) ;

56 
	`va_¡¬t
(
­
, 
fmt
);

57 
	`v¢´štf
(
”r
, 
ANET_ERR_LEN
, 
fmt
, 
­
);

58 
	`va_’d
(
­
);

59 
	}
}

61 
	$ª‘S‘Block
(*
”r
, 
fd
, 
nÚ_block
) {

62 
æags
;

67 ià((
æags
 = 
	`fú
(
fd
, 
F_GETFL
)) == -1) {

68 
	`ª‘S‘E¼Ü
(
”r
, "fú(F_GETFL): %s", 
	`¡»¼Ü
(
”ºo
));

69  
ANET_ERR
;

72 ià(
nÚ_block
)

73 
æags
 |ğ
O_NONBLOCK
;

75 
æags
 &ğ~
O_NONBLOCK
;

77 ià(
	`fú
(
fd
, 
F_SETFL
, 
æags
) == -1) {

78 
	`ª‘S‘E¼Ü
(
”r
, "fú(F_SETFL,O_NONBLOCK): %s", 
	`¡»¼Ü
(
”ºo
));

79  
ANET_ERR
;

81  
ANET_OK
;

82 
	}
}

84 
	$ª‘NÚBlock
(*
”r
, 
fd
) {

85  
	`ª‘S‘Block
(
”r
,
fd
,1);

86 
	}
}

88 
	$ª‘Block
(*
”r
, 
fd
) {

89  
	`ª‘S‘Block
(
”r
,
fd
,0);

90 
	}
}

95 
	$ª‘K“pAlive
(*
”r
, 
fd
, 
š‹rv®
)

97 
v®
 = 1;

99 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
v®
, (val)) == -1)

101 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_KEEPALIVE: %s", 
	`¡»¼Ü
(
”ºo
));

102  
ANET_ERR
;

105 #ifdeà
__lšux__


111 
v®
 = 
š‹rv®
;

112 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPIDLE
, &
v®
, (val)) < 0) {

113 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPIDLE: %s\n", 
	`¡»¼Ü
(
”ºo
));

114  
ANET_ERR
;

120 
v®
 = 
š‹rv®
/3;

121 ià(
v®
 == 0) val = 1;

122 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPINTVL
, &
v®
, (val)) < 0) {

123 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPINTVL: %s\n", 
	`¡»¼Ü
(
”ºo
));

124  
ANET_ERR
;

129 
v®
 = 3;

130 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPCNT
, &
v®
, (val)) < 0) {

131 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPCNT: %s\n", 
	`¡»¼Ü
(
”ºo
));

132  
ANET_ERR
;

135 ((è
š‹rv®
);

138  
ANET_OK
;

139 
	}
}

141 
	$ª‘S‘TıNoD–ay
(*
”r
, 
fd
, 
v®
)

143 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
v®
, (val)) == -1)

145 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_NODELAY: %s", 
	`¡»¼Ü
(
”ºo
));

146  
ANET_ERR
;

148  
ANET_OK
;

149 
	}
}

151 
	$ª‘EÇbËTıNoD–ay
(*
”r
, 
fd
)

153  
	`ª‘S‘TıNoD–ay
(
”r
, 
fd
, 1);

154 
	}
}

156 
	$ª‘Di§bËTıNoD–ay
(*
”r
, 
fd
)

158  
	`ª‘S‘TıNoD–ay
(
”r
, 
fd
, 0);

159 
	}
}

162 
	$ª‘S‘S’dBufãr
(*
”r
, 
fd
, 
buffsize
)

164 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
buffsize
, (buffsize)) == -1)

166 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_SNDBUF: %s", 
	`¡»¼Ü
(
”ºo
));

167  
ANET_ERR
;

169  
ANET_OK
;

170 
	}
}

172 
	$ª‘TıK“pAlive
(*
”r
, 
fd
)

174 
yes
 = 1;

175 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
yes
, (yes)) == -1) {

176 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_KEEPALIVE: %s", 
	`¡»¼Ü
(
”ºo
));

177  
ANET_ERR
;

179  
ANET_OK
;

180 
	}
}

184 
	$ª‘S’dTimeout
(*
”r
, 
fd
, 
ms
) {

185 
timev®
 
tv
;

187 
tv
.
tv_£c
 = 
ms
/1000;

188 
tv
.
tv_u£c
 = (
ms
%1000)*1000;

189 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDTIMEO
, &
tv
, (tv)) == -1) {

190 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_SNDTIMEO: %s", 
	`¡»¼Ü
(
”ºo
));

191  
ANET_ERR
;

193  
ANET_OK
;

194 
	}
}

203 
	$ª‘G’”icResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
,

204 
æags
)

206 
addršfo
 
hšts
, *
šfo
;

207 
rv
;

209 
	`mem£t
(&
hšts
,0,(hints));

210 ià(
æags
 & 
ANET_IP_ONLY
è
hšts
.
ai_æags
 = 
AI_NUMERICHOST
;

211 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

212 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

214 ià((
rv
 = 
	`g‘addršfo
(
ho¡
, 
NULL
, &
hšts
, &
šfo
)) != 0) {

215 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

216  
ANET_ERR
;

218 ià(
šfo
->
ai_çmy
 =ğ
AF_INET
) {

219 
sockaddr_š
 *
§
 = (sockaddr_š *)
šfo
->
ai_addr
;

220 
	`š‘_Áİ
(
AF_INET
, &(
§
->
sš_addr
), 
buf
, 
buf_Ën
);

222 
sockaddr_š6
 *
§
 = (sockaddr_š6 *)
šfo
->
ai_addr
;

223 
	`š‘_Áİ
(
AF_INET6
, &(
§
->
sš6_addr
), 
buf
, 
buf_Ën
);

226 
	`ä“addršfo
(
šfo
);

227  
ANET_OK
;

228 
	}
}

230 
	$ª‘ResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
) {

231  
	`ª‘G’”icResŞve
(
”r
,
ho¡
,
buf
,
buf_Ën
,
ANET_NONE
);

232 
	}
}

234 
	$ª‘ResŞveIP
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
) {

235  
	`ª‘G’”icResŞve
(
”r
,
ho¡
,
buf
,
buf_Ën
,
ANET_IP_ONLY
);

236 
	}
}

238 
	$ª‘S‘Reu£Addr
(*
”r
, 
fd
) {

239 
yes
 = 1;

242 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes)) == -1) {

243 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_REUSEADDR: %s", 
	`¡»¼Ü
(
”ºo
));

244  
ANET_ERR
;

246  
ANET_OK
;

247 
	}
}

249 
	$ª‘C»©eSock‘
(*
”r
, 
domaš
) {

250 
s
;

251 ià((
s
 = 
	`sock‘
(
domaš
, 
SOCK_STREAM
, 0)) == -1) {

252 
	`ª‘S‘E¼Ü
(
”r
, "ü—tšg sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

253  
ANET_ERR
;

258 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
) {

259 
	`şo£
(
s
);

260  
ANET_ERR
;

262  
s
;

263 
	}
}

265 
	#ANET_CONNECT_NONE
 0

	)

266 
	#ANET_CONNECT_NONBLOCK
 1

	)

267 
	#ANET_CONNECT_BE_BINDING
 2

	)

268 
	$ª‘TıG’”icCÚÃù
(*
”r
, *
addr
, 
pÜt
,

269 *
sourû_addr
, 
æags
)

271 
s
 = 
ANET_ERR
, 
rv
;

272 
pÜt¡r
[6];

273 
addršfo
 
hšts
, *
£rvšfo
, *
b£rvšfo
, *
p
, *
b
;

275 
	`¢´štf
(
pÜt¡r
,ÕÜt¡r),"%d",
pÜt
);

276 
	`mem£t
(&
hšts
,0,(hints));

277 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

278 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

280 ià((
rv
 = 
	`g‘addršfo
(
addr
,
pÜt¡r
,&
hšts
,&
£rvšfo
)) != 0) {

281 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

282  
ANET_ERR
;

284 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

288 ià((
s
 = 
	`sock‘
(
p
->
ai_çmy
,p->
ai_sockty³
,p->
ai_´ÙocŞ
)) == -1)

290 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

291 ià(
æags
 & 
ANET_CONNECT_NONBLOCK
 && 
	`ª‘NÚBlock
(
”r
,
s
è!ğ
ANET_OK
)

292 
”rÜ
;

293 ià(
sourû_addr
) {

294 
bound
 = 0;

296 ià((
rv
 = 
	`g‘addršfo
(
sourû_addr
, 
NULL
, &
hšts
, &
b£rvšfo
)) != 0)

298 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

299 
”rÜ
;

301 
b
 = 
b£rvšfo
; b !ğ
NULL
; b = b->
ai_Ãxt
) {

302 ià(
	`bšd
(
s
,
b
->
ai_addr
,b->
ai_add¾’
) != -1) {

303 
bound
 = 1;

307 
	`ä“addršfo
(
b£rvšfo
);

308 ià(!
bound
) {

309 
	`ª‘S‘E¼Ü
(
”r
, "bšd: %s", 
	`¡»¼Ü
(
”ºo
));

310 
”rÜ
;

313 ià(
	`cÚÃù
(
s
,
p
->
ai_addr
,p->
ai_add¾’
) == -1) {

316 ià(
”ºo
 =ğ
EINPROGRESS
 && 
æags
 & 
ANET_CONNECT_NONBLOCK
)

317 
’d
;

318 
	`şo£
(
s
);

319 
s
 = 
ANET_ERR
;

325 
’d
;

327 ià(
p
 =ğ
NULL
)

328 
	`ª‘S‘E¼Ü
(
”r
, "ü—tšg sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

330 
”rÜ
:

331 ià(
s
 !ğ
ANET_ERR
) {

332 
	`şo£
(
s
);

333 
s
 = 
ANET_ERR
;

336 
’d
:

337 
	`ä“addršfo
(
£rvšfo
);

341 ià(
s
 =ğ
ANET_ERR
 && 
sourû_addr
 && (
æags
 & 
ANET_CONNECT_BE_BINDING
)) {

342  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
æags
);

344  
s
;

346 
	}
}

348 
	$ª‘TıCÚÃù
(*
”r
, *
addr
, 
pÜt
)

350  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
ANET_CONNECT_NONE
);

351 
	}
}

353 
	$ª‘TıNÚBlockCÚÃù
(*
”r
, *
addr
, 
pÜt
)

355  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
ANET_CONNECT_NONBLOCK
);

356 
	}
}

358 
	$ª‘TıNÚBlockBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
,

359 *
sourû_addr
)

361  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
sourû_addr
,

362 
ANET_CONNECT_NONBLOCK
);

363 
	}
}

365 
	$ª‘TıNÚBlockBe¡EffÜtBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
,

366 *
sourû_addr
)

368  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
sourû_addr
,

369 
ANET_CONNECT_NONBLOCK
|
ANET_CONNECT_BE_BINDING
);

370 
	}
}

372 
	$ª‘UnixG’”icCÚÃù
(*
”r
, *
·th
, 
æags
)

374 
s
;

375 
sockaddr_un
 
§
;

377 ià((
s
 = 
	`ª‘C»©eSock‘
(
”r
,
AF_LOCAL
)è=ğ
ANET_ERR
)

378  
ANET_ERR
;

380 
§
.
sun_çmy
 = 
AF_LOCAL
;

381 
	`¡ºıy
(
§
.
sun_·th
,
·th
,(sa.sun_path)-1);

382 ià(
æags
 & 
ANET_CONNECT_NONBLOCK
) {

383 ià(
	`ª‘NÚBlock
(
”r
,
s
è!ğ
ANET_OK
)

384  
ANET_ERR
;

386 ià(
	`cÚÃù
(
s
,(
sockaddr
*)&
§
,(sa)) == -1) {

387 ià(
”ºo
 =ğ
EINPROGRESS
 &&

388 
æags
 & 
ANET_CONNECT_NONBLOCK
)

389  
s
;

391 
	`ª‘S‘E¼Ü
(
”r
, "cÚÃù: %s", 
	`¡»¼Ü
(
”ºo
));

392 
	`şo£
(
s
);

393  
ANET_ERR
;

395  
s
;

396 
	}
}

398 
	$ª‘UnixCÚÃù
(*
”r
, *
·th
)

400  
	`ª‘UnixG’”icCÚÃù
(
”r
,
·th
,
ANET_CONNECT_NONE
);

401 
	}
}

403 
	$ª‘UnixNÚBlockCÚÃù
(*
”r
, *
·th
)

405  
	`ª‘UnixG’”icCÚÃù
(
”r
,
·th
,
ANET_CONNECT_NONBLOCK
);

406 
	}
}

410 
	$ª‘R—d
(
fd
, *
buf
, 
couÁ
)

412 
ssize_t
 
Ä—d
, 
tÙËn
 = 0;

413 
tÙËn
 !ğ
couÁ
) {

414 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
couÁ
-
tÙËn
);

415 ià(
Ä—d
 =ğ0è 
tÙËn
;

416 ià(
Ä—d
 == -1)  -1;

417 
tÙËn
 +ğ
Ä—d
;

418 
buf
 +ğ
Ä—d
;

420  
tÙËn
;

421 
	}
}

425 
	$ª‘Wr™e
(
fd
, *
buf
, 
couÁ
)

427 
ssize_t
 
nwr™‹n
, 
tÙËn
 = 0;

428 
tÙËn
 !ğ
couÁ
) {

429 
nwr™‹n
 = 
	`wr™e
(
fd
,
buf
,
couÁ
-
tÙËn
);

430 ià(
nwr™‹n
 =ğ0è 
tÙËn
;

431 ià(
nwr™‹n
 == -1)  -1;

432 
tÙËn
 +ğ
nwr™‹n
;

433 
buf
 +ğ
nwr™‹n
;

435  
tÙËn
;

436 
	}
}

438 
	$ª‘Li¡’
(*
”r
, 
s
, 
sockaddr
 *
§
, 
sockËn_t
 
Ën
, 
backlog
) {

439 ià(
	`bšd
(
s
,
§
,
Ën
) == -1) {

440 
	`ª‘S‘E¼Ü
(
”r
, "bšd: %s", 
	`¡»¼Ü
(
”ºo
));

441 
	`şo£
(
s
);

442  
ANET_ERR
;

445 ià(
	`li¡’
(
s
, 
backlog
) == -1) {

446 
	`ª‘S‘E¼Ü
(
”r
, "li¡’: %s", 
	`¡»¼Ü
(
”ºo
));

447 
	`şo£
(
s
);

448  
ANET_ERR
;

450  
ANET_OK
;

451 
	}
}

453 
	$ª‘V6OÆy
(*
”r
, 
s
) {

454 
yes
 = 1;

455 ià(
	`£tsockİt
(
s
,
IPPROTO_IPV6
,
IPV6_V6ONLY
,&
yes
,(yes)) == -1) {

456 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİt: %s", 
	`¡»¼Ü
(
”ºo
));

457 
	`şo£
(
s
);

458  
ANET_ERR
;

460  
ANET_OK
;

461 
	}
}

463 
	$_ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
af
, 
backlog
)

465 
s
, 
rv
;

466 
_pÜt
[6];

467 
addršfo
 
hšts
, *
£rvšfo
, *
p
;

469 
	`¢´štf
(
_pÜt
,6,"%d",
pÜt
);

470 
	`mem£t
(&
hšts
,0,(hints));

471 
hšts
.
ai_çmy
 = 
af
;

472 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

473 
hšts
.
ai_æags
 = 
AI_PASSIVE
;

475 ià((
rv
 = 
	`g‘addršfo
(
bšdaddr
,
_pÜt
,&
hšts
,&
£rvšfo
)) != 0) {

476 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

477  
ANET_ERR
;

479 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

480 ià((
s
 = 
	`sock‘
(
p
->
ai_çmy
,p->
ai_sockty³
,p->
ai_´ÙocŞ
)) == -1)

483 ià(
af
 =ğ
AF_INET6
 && 
	`ª‘V6OÆy
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

484 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

485 ià(
	`ª‘Li¡’
(
”r
,
s
,
p
->
ai_addr
,p->
ai_add¾’
,
backlog
è=ğ
ANET_ERR
è
”rÜ
;

486 
’d
;

488 ià(
p
 =ğ
NULL
) {

489 
	`ª‘S‘E¼Ü
(
”r
, "unableo bind socket");

490 
”rÜ
;

493 
”rÜ
:

494 
s
 = 
ANET_ERR
;

495 
’d
:

496 
	`ä“addršfo
(
£rvšfo
);

497  
s
;

498 
	}
}

500 
	$ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
)

502  
	`_ª‘TıS”v”
(
”r
, 
pÜt
, 
bšdaddr
, 
AF_INET
, 
backlog
);

503 
	}
}

505 
	$ª‘Tı6S”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
)

507  
	`_ª‘TıS”v”
(
”r
, 
pÜt
, 
bšdaddr
, 
AF_INET6
, 
backlog
);

508 
	}
}

510 
	$ª‘UnixS”v”
(*
”r
, *
·th
, 
mode_t
 
³rm
, 
backlog
)

512 
s
;

513 
sockaddr_un
 
§
;

515 ià((
s
 = 
	`ª‘C»©eSock‘
(
”r
,
AF_LOCAL
)è=ğ
ANET_ERR
)

516  
ANET_ERR
;

518 
	`mem£t
(&
§
,0,(sa));

519 
§
.
sun_çmy
 = 
AF_LOCAL
;

520 
	`¡ºıy
(
§
.
sun_·th
,
·th
,(sa.sun_path)-1);

521 ià(
	`ª‘Li¡’
(
”r
,
s
,(
sockaddr
*)&
§
,(§),
backlog
è=ğ
ANET_ERR
)

522  
ANET_ERR
;

523 ià(
³rm
)

524 
	`chmod
(
§
.
sun_·th
, 
³rm
);

525  
s
;

526 
	}
}

528 
	$ª‘G’”icAcû±
(*
”r
, 
s
, 
sockaddr
 *
§
, 
sockËn_t
 *
Ën
) {

529 
fd
;

531 
fd
 = 
	`acû±
(
s
,
§
,
Ën
);

532 ià(
fd
 == -1) {

533 ià(
”ºo
 =ğ
EINTR
)

536 
	`ª‘S‘E¼Ü
(
”r
, "acû±: %s", 
	`¡»¼Ü
(
”ºo
));

537  
ANET_ERR
;

542  
fd
;

543 
	}
}

545 
	$ª‘TıAcû±
(*
”r
, 
s
, *

, 
size_t
 
_Ën
, *
pÜt
) {

546 
fd
;

547 
sockaddr_¡Üage
 
§
;

548 
sockËn_t
 
§Ën
 = (
§
);

549 ià((
fd
 = 
	`ª‘G’”icAcû±
(
”r
,
s
,(
sockaddr
*)&
§
,&
§Ën
)) == -1)

550  
ANET_ERR
;

552 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

553 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

554 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

555 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

557 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

558 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

559 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

561  
fd
;

562 
	}
}

564 
	$ª‘UnixAcû±
(*
”r
, 
s
) {

565 
fd
;

566 
sockaddr_un
 
§
;

567 
sockËn_t
 
§Ën
 = (
§
);

568 ià((
fd
 = 
	`ª‘G’”icAcû±
(
”r
,
s
,(
sockaddr
*)&
§
,&
§Ën
)) == -1)

569  
ANET_ERR
;

571  
fd
;

572 
	}
}

574 
	$ª‘P“rToSŒšg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

575 
sockaddr_¡Üage
 
§
;

576 
sockËn_t
 
§Ën
 = (
§
);

578 ià(
	`g‘³”Çme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
è=ğ-1è
”rÜ
;

579 ià(
_Ën
 =ğ0è
”rÜ
;

581 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

582 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

583 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

584 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

585 } ià(
§
.
ss_çmy
 =ğ
AF_INET6
) {

586 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

587 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

588 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

589 } ià(
§
.
ss_çmy
 =ğ
AF_UNIX
) {

590 ià(

è
	`¡ºıy
(,"/unixsock‘",
_Ën
);

591 ià(
pÜt
) *port = 0;

593 
”rÜ
;

597 
”rÜ
:

598 ià(

) {

599 ià(
_Ën
 >= 2) {

600 

[0] = '?';

601 

[1] = '\0';

602 } ià(
_Ën
 == 1) {

603 

[0] = '\0';

606 ià(
pÜt
) *port = 0;

608 
	}
}

613 
	$ª‘FÜm©Addr
(*
buf
, 
size_t
 
buf_Ën
, *

, 
pÜt
) {

614  
	`¢´štf
(
buf
,
buf_Ën
, 
	`¡rchr
(

,':') ?

615 "[%s]:%d" : "%s:%d", 

, 
pÜt
);

616 
	}
}

619 
	$ª‘FÜm©P“r
(
fd
, *
buf
, 
size_t
 
buf_Ën
) {

620 

[
INET6_ADDRSTRLEN
];

621 
pÜt
;

623 
	`ª‘P“rToSŒšg
(
fd
,

,(),&
pÜt
);

624  
	`ª‘FÜm©Addr
(
buf
, 
buf_Ën
, 

, 
pÜt
);

625 
	}
}

627 
	$ª‘SockName
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

628 
sockaddr_¡Üage
 
§
;

629 
sockËn_t
 
§Ën
 = (
§
);

631 ià(
	`g‘sockÇme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
) == -1) {

632 ià(
pÜt
) *port = 0;

633 

[0] = '?';

634 

[1] = '\0';

637 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

638 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

639 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

640 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

642 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

643 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

644 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

647 
	}
}

649 
	$ª‘FÜm©Sock
(
fd
, *
fmt
, 
size_t
 
fmt_Ën
) {

650 

[
INET6_ADDRSTRLEN
];

651 
pÜt
;

653 
	`ª‘SockName
(
fd
,

,(),&
pÜt
);

654  
	`ª‘FÜm©Addr
(
fmt
, 
fmt_Ën
, 

, 
pÜt
);

655 
	}
}

	@anet.h

31 #iâdeà
ANET_H


32 
	#ANET_H


	)

34 
	~<sys/ty³s.h
>

36 
	#ANET_OK
 0

	)

37 
	#ANET_ERR
 -1

	)

38 
	#ANET_ERR_LEN
 256

	)

41 
	#ANET_NONE
 0

	)

42 
	#ANET_IP_ONLY
 (1<<0)

	)

44 #ià
defšed
(
__sun
è|| defšed(
_AIX
)

45 
	#AF_LOCAL
 
AF_UNIX


	)

48 #ifdeà
_AIX


49 #undeà
_Ën


52 
ª‘TıCÚÃù
(*
”r
, *
addr
, 
pÜt
);

53 
ª‘TıNÚBlockCÚÃù
(*
”r
, *
addr
, 
pÜt
);

54 
ª‘TıNÚBlockBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
, *
sourû_addr
);

55 
ª‘TıNÚBlockBe¡EffÜtBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
, *
sourû_addr
);

56 
ª‘UnixCÚÃù
(*
”r
, *
·th
);

57 
ª‘UnixNÚBlockCÚÃù
(*
”r
, *
·th
);

58 
ª‘R—d
(
fd
, *
buf
, 
couÁ
);

59 
ª‘ResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
);

60 
ª‘ResŞveIP
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
);

61 
ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
);

62 
ª‘Tı6S”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
);

63 
ª‘UnixS”v”
(*
”r
, *
·th
, 
mode_t
 
³rm
, 
backlog
);

64 
ª‘TıAcû±
(*
”r
, 
£rv”sock
, *

, 
size_t
 
_Ën
, *
pÜt
);

65 
ª‘UnixAcû±
(*
”r
, 
£rv”sock
);

66 
ª‘Wr™e
(
fd
, *
buf
, 
couÁ
);

67 
ª‘NÚBlock
(*
”r
, 
fd
);

68 
ª‘Block
(*
”r
, 
fd
);

69 
ª‘EÇbËTıNoD–ay
(*
”r
, 
fd
);

70 
ª‘Di§bËTıNoD–ay
(*
”r
, 
fd
);

71 
ª‘TıK“pAlive
(*
”r
, 
fd
);

72 
ª‘S’dTimeout
(*
”r
, 
fd
, 
ms
);

73 
ª‘P“rToSŒšg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
);

74 
ª‘K“pAlive
(*
”r
, 
fd
, 
š‹rv®
);

75 
ª‘SockName
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
);

76 
ª‘FÜm©Addr
(*
fmt
, 
size_t
 
fmt_Ën
, *

, 
pÜt
);

77 
ª‘FÜm©P“r
(
fd
, *
fmt
, 
size_t
 
fmt_Ën
);

78 
ª‘FÜm©Sock
(
fd
, *
fmt
, 
size_t
 
fmt_Ën
);

	@aof.c

30 
	~"£rv”.h
"

31 
	~"bio.h
"

32 
	~"rio.h
"

34 
	~<sigÇl.h
>

35 
	~<fú.h
>

36 
	~<sys/¡©.h
>

37 
	~<sys/ty³s.h
>

38 
	~<sys/time.h
>

39 
	~<sys/»sourû.h
>

40 
	~<sys/wa™.h
>

41 
	~<sys/·¿m.h
>

43 
aofUpd©eCu¼’tSize
();

44 
aofClo£Pes
();

60 
	#AOF_RW_BUF_BLOCK_SIZE
 (1024*1024*10è

	)

62 
	saoäwblock
 {

63 
	mu£d
, 
	mä“
;

64 
	mbuf
[
AOF_RW_BUF_BLOCK_SIZE
];

65 } 
	taoäwblock
;

70 
	$aofRewr™eBufãrRe£t
() {

71 ià(
£rv”
.
aof_»wr™e_buf_blocks
)

72 
	`li¡R–—£
(
£rv”
.
aof_»wr™e_buf_blocks
);

74 
£rv”
.
aof_»wr™e_buf_blocks
 = 
	`li¡C»©e
();

75 
	`li¡S‘F»eM‘hod
(
£rv”
.
aof_»wr™e_buf_blocks
,
zä“
);

76 
	}
}

79 
	$aofRewr™eBufãrSize
() {

80 
li¡Node
 *
Ê
;

81 
li¡I‹r
 
li
;

82 
size
 = 0;

84 
	`li¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

85 (
Ê
 = 
	`li¡Next
(&
li
))) {

86 
aoäwblock
 *
block
 = 
	`li¡NodeV®ue
(
Ê
);

87 
size
 +ğ
block
->
u£d
;

89  
size
;

90 
	}
}

95 
	$aofChdWr™eDiffD©a
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

96 
li¡Node
 *
Ê
;

97 
aoäwblock
 *
block
;

98 
ssize_t
 
nwr™‹n
;

99 
	`UNUSED
(
–
);

100 
	`UNUSED
(
fd
);

101 
	`UNUSED
(
´ivd©a
);

102 
	`UNUSED
(
mask
);

105 
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

106 
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

107 ià(
£rv”
.
aof_¡İ_£ndšg_diff
 || !
block
) {

108 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,

109 
AE_WRITABLE
);

112 ià(
block
->
u£d
 > 0) {

113 
nwr™‹n
 = 
	`wr™e
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
,

114 
block
->
buf
,block->
u£d
);

115 ià(
nwr™‹n
 <= 0) ;

116 
	`memmove
(
block
->
buf
,block->buf+
nwr™‹n
,block->
u£d
-nwritten);

117 
block
->
u£d
 -ğ
nwr™‹n
;

119 ià(
block
->
u£d
 =ğ0è
	`li¡D–Node
(
£rv”
.
aof_»wr™e_buf_blocks
,
Ê
);

121 
	}
}

124 
	$aofRewr™eBufãrAµ’d
(*
s
, 
Ën
) {

125 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

126 
aoäwblock
 *
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

128 
Ën
) {

131 ià(
block
) {

132 
thi¦’
 = (
block
->
ä“
 < 
Ën
) ? block->free :†en;

133 ià(
thi¦’
) {

134 
	`memıy
(
block
->
buf
+block->
u£d
, 
s
, 
thi¦’
);

135 
block
->
u£d
 +ğ
thi¦’
;

136 
block
->
ä“
 -ğ
thi¦’
;

137 
s
 +ğ
thi¦’
;

138 
Ën
 -ğ
thi¦’
;

142 ià(
Ën
) {

143 
numblocks
;

145 
block
 = 
	`zm®loc
((*block));

146 
block
->
ä“
 = 
AOF_RW_BUF_BLOCK_SIZE
;

147 
block
->
u£d
 = 0;

148 
	`li¡AddNodeTa
(
£rv”
.
aof_»wr™e_buf_blocks
,
block
);

152 
numblocks
 = 
	`li¡L’gth
(
£rv”
.
aof_»wr™e_buf_blocks
);

153 ià(((
numblocks
+1) % 10) == 0) {

154 
Ëv–
 = ((
numblocks
+1è% 100è=ğ0 ? 
LL_WARNING
 :

155 
LL_NOTICE
;

156 
	`£rv”Log
(
Ëv–
,"Background AOF buffer size: %lu MB",

157 
	`aofRewr™eBufãrSize
()/(1024*1024));

164 ià(
	`«G‘FeEv’ts
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
) == 0) {

165 
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
aof_pe_wr™e_d©a_to_chd
,

166 
AE_WRITABLE
, 
aofChdWr™eDiffD©a
, 
NULL
);

168 
	}
}

173 
ssize_t
 
	$aofRewr™eBufãrWr™e
(
fd
) {

174 
li¡Node
 *
Ê
;

175 
li¡I‹r
 
li
;

176 
ssize_t
 
couÁ
 = 0;

178 
	`li¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

179 (
Ê
 = 
	`li¡Next
(&
li
))) {

180 
aoäwblock
 *
block
 = 
	`li¡NodeV®ue
(
Ê
);

181 
ssize_t
 
nwr™‹n
;

183 ià(
block
->
u£d
) {

184 
nwr™‹n
 = 
	`wr™e
(
fd
,
block
->
buf
,block->
u£d
);

185 ià(
nwr™‹n
 !ğ(
ssize_t
)
block
->
u£d
) {

186 ià(
nwr™‹n
 =ğ0è
”ºo
 = 
EIO
;

189 
couÁ
 +ğ
nwr™‹n
;

192  
couÁ
;

193 
	}
}

201 
	$aof_background_fsync
(
fd
) {

202 
	`bioC»©eBackgroundJob
(
BIO_AOF_FSYNC
,(*)()
fd
,
NULL
,NULL);

203 
	}
}

207 
	$¡İAµ’dOÆy
() {

208 
	`£rv”As£¹
(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
);

209 
	`æushAµ’dOÆyFe
(1);

210 
	`aof_fsync
(
£rv”
.
aof_fd
);

211 
	`şo£
(
£rv”
.
aof_fd
);

213 
£rv”
.
aof_fd
 = -1;

214 
£rv”
.
aof_£Ëùed_db
 = -1;

215 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

217 ià(
£rv”
.
aof_chd_pid
 != -1) {

218 
¡©loc
;

220 
	`£rv”Log
(
LL_NOTICE
,"Killing„unning AOF„ewrite child: %ld",

221 (è
£rv”
.
aof_chd_pid
);

222 ià(
	`kl
(
£rv”
.
aof_chd_pid
,
SIGUSR1
) != -1) {

223 
	`wa™3
(&
¡©loc
,0,
NULL
è!ğ
£rv”
.
aof_chd_pid
);

226 
	`aofRewr™eBufãrRe£t
();

227 
	`aofRemoveTempFe
(
£rv”
.
aof_chd_pid
);

228 
£rv”
.
aof_chd_pid
 = -1;

229 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

231 
	`aofClo£Pes
();

233 
	}
}

237 
	$¡¬tAµ’dOÆy
() {

238 
cwd
[
MAXPATHLEN
];

240 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

241 
£rv”
.
aof_fd
 = 
	`İ’
(£rv”.
aof_f’ame
,
O_WRONLY
|
O_APPEND
|
O_CREAT
,0644);

242 
	`£rv”As£¹
(
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
);

243 ià(
£rv”
.
aof_fd
 == -1) {

244 *
cwdp
 = 
	`g‘cwd
(
cwd
,
MAXPATHLEN
);

246 
	`£rv”Log
(
LL_WARNING
,

249 
£rv”
.
aof_f’ame
,

250 
cwdp
 ? cwdp : "unknown",

251 
	`¡»¼Ü
(
”ºo
));

252  
C_ERR
;

254 ià(
	`»wr™eAµ’dOÆyFeBackground
(è=ğ
C_ERR
) {

255 
	`şo£
(
£rv”
.
aof_fd
);

256 
	`£rv”Log
(
LL_WARNING
,"Redis‚eedsoƒnablehe AOF but can'trigger‡ background AOF„ewrite operation. Checkhe‡bove†ogs for more info‡boutheƒrror.");

257  
C_ERR
;

261 
£rv”
.
aof_¡©e
 = 
AOF_WAIT_REWRITE
;

262  
C_OK
;

263 
	}
}

283 
	#AOF_WRITE_LOG_ERROR_RATE
 30

	)

284 
	$æushAµ’dOÆyFe
(
fÜû
) {

285 
ssize_t
 
nwr™‹n
;

286 
sync_š_´og»ss
 = 0;

287 
m¡ime_t
 
Ï‹ncy
;

289 ià(
	`sd¦’
(
£rv”
.
aof_buf
) == 0) ;

291 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
)

292 
sync_š_´og»ss
 = 
	`bioP’dšgJobsOfTy³
(
BIO_AOF_FSYNC
) != 0;

294 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
 && !
fÜû
) {

298 ià(
sync_š_´og»ss
) {

299 ià(
£rv”
.
aof_æush_po¡pÚed_¡¬t
 == 0) {

302 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = s”v”.
unixtime
;

304 } ià(
£rv”
.
unixtime
 - s”v”.
aof_æush_po¡pÚed_¡¬t
 < 2) {

311 
£rv”
.
aof_d–ayed_fsync
++;

312 
	`£rv”Log
(
LL_NOTICE
,"Asynchronous AOF fsync isakingoo†ong (disk is busy?). Writinghe AOF buffer without waiting for fsynco complete,his may slow down Redis.");

321 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

322 
nwr™‹n
 = 
	`wr™e
(
£rv”
.
aof_fd
,£rv”.
aof_buf
,
	`sd¦’
(server.aof_buf));

323 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

329 ià(
sync_š_´og»ss
) {

330 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-³ndšg-fsync",
Ï‹ncy
);

331 } ià(
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 != -1) {

332 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-aùive-chd",
Ï‹ncy
);

334 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-®Úe",
Ï‹ncy
);

336 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e",
Ï‹ncy
);

339 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = 0;

341 ià(
nwr™‹n
 !ğ(sigÃd)
	`sd¦’
(
£rv”
.
aof_buf
)) {

342 
time_t
 
Ï¡_wr™e_”rÜ_log
 = 0;

343 
ÿn_log
 = 0;

346 ià((
£rv”
.
unixtime
 - 
Ï¡_wr™e_”rÜ_log
è> 
AOF_WRITE_LOG_ERROR_RATE
) {

347 
ÿn_log
 = 1;

348 
Ï¡_wr™e_”rÜ_log
 = 
£rv”
.
unixtime
;

352 ià(
nwr™‹n
 == -1) {

353 ià(
ÿn_log
) {

354 
	`£rv”Log
(
LL_WARNING
,"Error writingohe AOF file: %s",

355 
	`¡»¼Ü
(
”ºo
));

356 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 
”ºo
;

359 ià(
ÿn_log
) {

360 
	`£rv”Log
(
LL_WARNING
,"Short write while writingo "

363 ()
nwr™‹n
,

364 ()
	`sd¦’
(
£rv”
.
aof_buf
));

367 ià(
	`árunÿ‹
(
£rv”
.
aof_fd
, s”v”.
aof_cu¼’t_size
) == -1) {

368 ià(
ÿn_log
) {

369 
	`£rv”Log
(
LL_WARNING
, "Could‚ot„emove short write "

372 "árunÿ‹: %s", 
	`¡»¼Ü
(
”ºo
));

377 
nwr™‹n
 = -1;

379 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 
ENOSPC
;

383 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

388 
	`£rv”Log
(
LL_WARNING
,"Can't„ecover from AOF writeƒrror whenhe AOF fsync…olicy is 'always'. Exiting...");

389 
	`ex™
(1);

394 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
C_ERR
;

398 ià(
nwr™‹n
 > 0) {

399 
£rv”
.
aof_cu¼’t_size
 +ğ
nwr™‹n
;

400 
	`sd¤ªge
(
£rv”
.
aof_buf
,
nwr™‹n
,-1);

407 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_ERR
) {

408 
	`£rv”Log
(
LL_WARNING
,

410 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
C_OK
;

413 
£rv”
.
aof_cu¼’t_size
 +ğ
nwr™‹n
;

417 ià((
	`sd¦’
(
£rv”
.
aof_buf
)+
	`sd§va
(server.aof_buf)) < 4000) {

418 
	`sdsş—r
(
£rv”
.
aof_buf
);

420 
	`sdsä“
(
£rv”
.
aof_buf
);

421 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

426 ià(
£rv”
.
aof_no_fsync_Ú_»wr™e
 &&

427 (
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 != -1))

431 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

434 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

435 
	`aof_fsync
(
£rv”
.
aof_fd
);

436 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

437 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-fsync-®ways",
Ï‹ncy
);

438 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

439 } ià((
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
 &&

440 
£rv”
.
unixtime
 > s”v”.
aof_Ï¡_fsync
)) {

441 ià(!
sync_š_´og»ss
è
	`aof_background_fsync
(
£rv”
.
aof_fd
);

442 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

444 
	}
}

446 
sds
 
	$ÿtAµ’dOÆyG’”icCommªd
(
sds
 
d¡
, 
¬gc
, 
robj
 **
¬gv
) {

447 
buf
[32];

448 
Ën
, 
j
;

449 
robj
 *
o
;

451 
buf
[0] = '*';

452 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
¬gc
);

453 
buf
[
Ën
++] = '\r';

454 
buf
[
Ën
++] = '\n';

455 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

457 
j
 = 0; j < 
¬gc
; j++) {

458 
o
 = 
	`g‘DecodedObjeù
(
¬gv
[
j
]);

459 
buf
[0] = '$';

460 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
	`sd¦’
(
o
->
±r
));

461 
buf
[
Ën
++] = '\r';

462 
buf
[
Ën
++] = '\n';

463 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

464 
d¡
 = 
	`sdsÿ’
(d¡,
o
->
±r
,
	`sd¦’
(o->ptr));

465 
d¡
 = 
	`sdsÿ’
(dst,"\r\n",2);

466 
	`deüRefCouÁ
(
o
);

468  
d¡
;

469 
	}
}

478 
sds
 
	$ÿtAµ’dOÆyExpœeAtCommªd
(
sds
 
buf
, 
»disCommªd
 *
cmd
, 
robj
 *
key
,„obj *
£cÚds
) {

479 
wh’
;

480 
robj
 *
¬gv
[3];

483 
£cÚds
 = 
	`g‘DecodedObjeù
(seconds);

484 
wh’
 = 
	`¡¹Şl
(
£cÚds
->
±r
,
NULL
,10);

486 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
£‹xCommªd
 ||

487 
cmd
->
´oc
 =ğ
expœ—tCommªd
)

489 
wh’
 *= 1000;

492 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

493 
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
)

495 
wh’
 +ğ
	`m¡ime
();

497 
	`deüRefCouÁ
(
£cÚds
);

499 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PEXPIREAT",9);

500 
¬gv
[1] = 
key
;

501 
¬gv
[2] = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
wh’
);

502 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf, 3, 
¬gv
);

503 
	`deüRefCouÁ
(
¬gv
[0]);

504 
	`deüRefCouÁ
(
¬gv
[2]);

505  
buf
;

506 
	}
}

508 
	$ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

509 
sds
 
buf
 = 
	`sd£m±y
();

510 
robj
 *
tm·rgv
[3];

514 ià(
diùid
 !ğ
£rv”
.
aof_£Ëùed_db
) {

515 
£ldb
[64];

517 
	`¢´štf
(
£ldb
,(£ldb),"%d",
diùid
);

518 
buf
 = 
	`sdsÿrštf
(buf,"*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n",

519 ()
	`¡¾’
(
£ldb
),seldb);

520 
£rv”
.
aof_£Ëùed_db
 = 
diùid
;

523 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

524 
cmd
->
´oc
 =ğ
expœ—tCommªd
) {

526 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

527 } ià(
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
) {

529 
tm·rgv
[0] = 
	`ü—‹SŒšgObjeù
("SET",3);

530 
tm·rgv
[1] = 
¬gv
[1];

531 
tm·rgv
[2] = 
¬gv
[3];

532 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,3,
tm·rgv
);

533 
	`deüRefCouÁ
(
tm·rgv
[0]);

534 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

539 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,
¬gc
,
¬gv
);

545 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
)

546 
£rv”
.
aof_buf
 = 
	`sdsÿ’
(£rv”.aof_buf,
buf
,
	`sd¦’
(buf));

552 ià(
£rv”
.
aof_chd_pid
 != -1)

553 
	`aofRewr™eBufãrAµ’d
((*)
buf
,
	`sd¦’
(buf));

555 
	`sdsä“
(
buf
);

556 
	}
}

564 
ş›Á
 *
	$ü—‹FakeCl›Á
() {

565 
ş›Á
 *
c
 = 
	`zm®loc
((*c));

567 
	`£ËùDb
(
c
,0);

568 
c
->
fd
 = -1;

569 
c
->
Çme
 = 
NULL
;

570 
c
->
qu”ybuf
 = 
	`sd£m±y
();

571 
c
->
qu”ybuf_³ak
 = 0;

572 
c
->
¬gc
 = 0;

573 
c
->
¬gv
 = 
NULL
;

574 
c
->
buåos
 = 0;

575 
c
->
æags
 = 0;

576 
c
->
bty³
 = 
BLOCKED_NONE
;

579 
c
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_START
;

580 
c
->
»¶y
 = 
	`li¡C»©e
();

581 
c
->
»¶y_by‹s
 = 0;

582 
c
->
obuf_soá_lim™_»ached_time
 = 0;

583 
c
->
w©ched_keys
 = 
	`li¡C»©e
();

584 
c
->
³”id
 = 
NULL
;

585 
	`li¡S‘F»eM‘hod
(
c
->
»¶y
,
deüRefCouÁVoid
);

586 
	`li¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

587 
	`š™Cl›ÁMuÉiS‹
(
c
);

588  
c
;

589 
	}
}

591 
	$ä“FakeCl›ÁArgv
(
ş›Á
 *
c
) {

592 
j
;

594 
j
 = 0; j < 
c
->
¬gc
; j++)

595 
	`deüRefCouÁ
(
c
->
¬gv
[
j
]);

596 
	`zä“
(
c
->
¬gv
);

597 
	}
}

599 
	$ä“FakeCl›Á
(
ş›Á
 *
c
) {

600 
	`sdsä“
(
c
->
qu”ybuf
);

601 
	`li¡R–—£
(
c
->
»¶y
);

602 
	`li¡R–—£
(
c
->
w©ched_keys
);

603 
	`ä“Cl›ÁMuÉiS‹
(
c
);

604 
	`zä“
(
c
);

605 
	}
}

610 
	$lßdAµ’dOÆyFe
(*
f’ame
) {

611 
ş›Á
 *
çkeCl›Á
;

612 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r");

613 
»dis_¡©
 
sb
;

614 
Şd_aof_¡©e
 = 
£rv”
.
aof_¡©e
;

615 
loİs
 = 0;

616 
off_t
 
v®id_up_to
 = 0;

618 ià(
å
 && 
	`»dis_f¡©
(
	`f’o
(å),&
sb
è!ğ-1 && sb.
¡_size
 == 0) {

619 
£rv”
.
aof_cu¼’t_size
 = 0;

620 
	`fşo£
(
å
);

621  
C_ERR
;

624 ià(
å
 =ğ
NULL
) {

625 
	`£rv”Log
(
LL_WARNING
,"F©®ƒ¼Ü: cª'ˆİ’h­³nd†og ffÜ„—dšg: %s",
	`¡»¼Ü
(
”ºo
));

626 
	`ex™
(1);

631 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

633 
çkeCl›Á
 = 
	`ü—‹FakeCl›Á
();

634 
	`¡¬tLßdšg
(
å
);

637 
¬gc
, 
j
;

638 
Ën
;

639 
robj
 **
¬gv
;

640 
buf
[128];

641 
sds
 
¬gsds
;

642 
»disCommªd
 *
cmd
;

645 ià(!(
loİs
++ % 1000)) {

646 
	`lßdšgProg»ss
(
	`á–lo
(
å
));

647 
	`´oûssEv’tsWheBlocked
();

650 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

651 ià(
	`ãof
(
å
))

654 
»ad”r
;

656 ià(
buf
[0] !ğ'*'è
fm‹¼
;

657 ià(
buf
[1] =ğ'\0'è
»ad”r
;

658 
¬gc
 = 
	`©oi
(
buf
+1);

659 ià(
¬gc
 < 1è
fm‹¼
;

661 
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

662 
çkeCl›Á
->
¬gc
 =‡rgc;

663 
çkeCl›Á
->
¬gv
 =‡rgv;

665 
j
 = 0; j < 
¬gc
; j++) {

666 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

667 
çkeCl›Á
->
¬gc
 = 
j
;

668 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

669 
»ad”r
;

671 ià(
buf
[0] !ğ'$'è
fm‹¼
;

672 
Ën
 = 
	`¡¹Ş
(
buf
+1,
NULL
,10);

673 
¬gsds
 = 
	`sd¢ewËn
(
NULL
,
Ën
);

674 ià(
Ën
 && 
	`ä—d
(
¬gsds
,Ën,1,
å
) == 0) {

675 
	`sdsä“
(
¬gsds
);

676 
çkeCl›Á
->
¬gc
 = 
j
;

677 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

678 
»ad”r
;

680 
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,
¬gsds
);

681 ià(
	`ä—d
(
buf
,2,1,
å
) == 0) {

682 
çkeCl›Á
->
¬gc
 = 
j
+1;

683 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

684 
»ad”r
;

689 
cmd
 = 
	`lookupCommªd
(
¬gv
[0]->
±r
);

690 ià(!
cmd
) {

691 
	`£rv”Log
(
LL_WARNING
,"UnknowÀcommªd '%s'„—dšgh­³nd oÆy fe", (*)
¬gv
[0]->
±r
);

692 
	`ex™
(1);

696 
çkeCl›Á
->
cmd
 = cmd;

697 
cmd
->
	`´oc
(
çkeCl›Á
);

700 
	`£rv”As£¹
(
çkeCl›Á
->
buåos
 =ğ0 && 
	`li¡L’gth
(çkeCl›Á->
»¶y
) == 0);

702 
	`£rv”As£¹
((
çkeCl›Á
->
æags
 & 
CLIENT_BLOCKED
) == 0);

706 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

707 
çkeCl›Á
->
cmd
 = 
NULL
;

708 ià(
£rv”
.
aof_lßd_Œunÿ‹d
è
v®id_up_to
 = 
	`á–lo
(
å
);

713 ià(
çkeCl›Á
->
æags
 & 
CLIENT_MULTI
è
uxeof
;

715 
lßded_ok
:

716 
	`fşo£
(
å
);

717 
	`ä“FakeCl›Á
(
çkeCl›Á
);

718 
£rv”
.
aof_¡©e
 = 
Şd_aof_¡©e
;

719 
	`¡İLßdšg
();

720 
	`aofUpd©eCu¼’tSize
();

721 
£rv”
.
aof_»wr™e_ba£_size
 = s”v”.
aof_cu¼’t_size
;

722  
C_OK
;

724 
»ad”r
:

725 ià(!
	`ãof
(
å
)) {

726 ià(
çkeCl›Á
è
	`ä“FakeCl›Á
(fakeClient);

727 
	`£rv”Log
(
LL_WARNING
,"UÄecov”abËƒ¼Ü„—dšgh­³nd oÆy fe: %s", 
	`¡»¼Ü
(
”ºo
));

728 
	`ex™
(1);

731 
uxeof
:

732 ià(
£rv”
.
aof_lßd_Œunÿ‹d
) {

733 
	`£rv”Log
(
LL_WARNING
,"!!! Warning: short„ead while†oadinghe AOF file !!!");

734 
	`£rv”Log
(
LL_WARNING
,"!!! Truncatinghe AOF‡t offset %llu !!!",

735 (è
v®id_up_to
);

736 ià(
v®id_up_to
 =ğ-1 || 
	`Œunÿ‹
(
f’ame
,valid_up_to) == -1) {

737 ià(
v®id_up_to
 == -1) {

738 
	`£rv”Log
(
LL_WARNING
,"Last valid command offset is invalid");

740 
	`£rv”Log
(
LL_WARNING
,"Errorruncatinghe AOF file: %s",

741 
	`¡»¼Ü
(
”ºo
));

746 ià(
£rv”
.
aof_fd
 !ğ-1 && 
	`l£ek
(£rv”.aof_fd,0,
SEEK_END
) == -1) {

747 
	`£rv”Log
(
LL_WARNING
,"Can't seekheƒnd ofhe AOF file: %s",

748 
	`¡»¼Ü
(
”ºo
));

750 
	`£rv”Log
(
LL_WARNING
,

752 
lßded_ok
;

756 ià(
çkeCl›Á
è
	`ä“FakeCl›Á
(fakeClient);

757 
	`£rv”Log
(
LL_WARNING
,"Unexpectedƒnd of file„eadinghe‡ppend only file. You can: 1) Make‡ backup of your AOF file,hen use ./redis-check-aof --fix <filename>. 2) Alternatively you can sethe 'aof-load-truncated' configuration optiono yes‡nd„estarthe server.");

758 
	`ex™
(1);

760 
fm‹¼
:

761 ià(
çkeCl›Á
è
	`ä“FakeCl›Á
(fakeClient);

762 
	`£rv”Log
(
LL_WARNING
,"Bad file format„eadinghe‡ppend only file: make‡ backup of your AOF file,hen use ./redis-check-aof --fix <filename>");

763 
	`ex™
(1);

764 
	}
}

772 
	$rioWr™eBulkObjeù
(
rio
 *
r
, 
robj
 *
obj
) {

775 ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

776  
	`rioWr™eBulkLÚgLÚg
(
r
,()
obj
->
±r
);

777 } ià(
	`sdsEncodedObjeù
(
obj
)) {

778  
	`rioWr™eBulkSŒšg
(
r
,
obj
->
±r
,
	`sd¦’
(obj->ptr));

780 
	`£rv”Pªic
("Unknown stringƒncoding");

782 
	}
}

786 
	$»wr™eLi¡Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

787 
couÁ
 = 0, 
™ems
 = 
	`li¡Ty³L’gth
(
o
);

789 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

790 
quickli¡
 *
li¡
 = 
o
->
±r
;

791 
quickli¡I‹r
 *
li
 = 
	`quickli¡G‘I‹¿tÜ
(
li¡
, 
AL_START_HEAD
);

792 
quickli¡EÁry
 
’Œy
;

794 
	`quickli¡Next
(
li
,&
’Œy
)) {

795 ià(
couÁ
 == 0) {

796 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

797 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

798 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

799 ià(
	`rioWr™eBulkSŒšg
(
r
,"RPUSH",5) == 0)  0;

800 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

803 ià(
’Œy
.
v®ue
) {

804 ià(
	`rioWr™eBulkSŒšg
(
r
,(*)
’Œy
.
v®ue
,’Œy.
sz
) == 0)  0;

806 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
’Œy
.
lÚgv®
) == 0)  0;

808 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

809 
™ems
--;

811 
	`quickli¡R–—£I‹¿tÜ
(
li
);

813 
	`£rv”Pªic
("Unknown†istƒncoding");

816 
	}
}

820 
	$»wr™eS‘Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

821 
couÁ
 = 0, 
™ems
 = 
	`£tTy³Size
(
o
);

823 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

824 
ii
 = 0;

825 
št64_t
 
Îv®
;

827 
	`št£tG‘
(
o
->
±r
,
ii
++,&
Îv®
)) {

828 ià(
couÁ
 == 0) {

829 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

830 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

832 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

833 ià(
	`rioWr™eBulkSŒšg
(
r
,"SADD",4) == 0)  0;

834 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

836 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
Îv®
) == 0)  0;

837 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

838 
™ems
--;

840 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

841 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
o
->
±r
);

842 
diùEÁry
 *
de
;

844 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

845 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

846 ià(
couÁ
 == 0) {

847 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

848 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

850 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

851 ià(
	`rioWr™eBulkSŒšg
(
r
,"SADD",4) == 0)  0;

852 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

854 ià(
	`rioWr™eBulkSŒšg
(
r
,
–e
,
	`sd¦’
(ele)) == 0)  0;

855 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

856 
™ems
--;

858 
	`diùR–—£I‹¿tÜ
(
di
);

860 
	`£rv”Pªic
("Unknown setƒncoding");

863 
	}
}

867 
	$»wr™eSÜ‹dS‘Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

868 
couÁ
 = 0, 
™ems
 = 
	`z£tL’gth
(
o
);

870 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

871 *
zl
 = 
o
->
±r
;

872 *
•Œ
, *
¥Œ
;

873 *
v¡r
;

874 
vËn
;

875 
vÎ
;

876 
scÜe
;

878 
•Œ
 = 
	`zli¡Index
(
zl
,0);

879 
	`£rv”As£¹
(
•Œ
 !ğ
NULL
);

880 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

881 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

883 
•Œ
 !ğ
NULL
) {

884 
	`£rv”As£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vÎ
));

885 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

887 ià(
couÁ
 == 0) {

888 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

889 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

891 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

892 ià(
	`rioWr™eBulkSŒšg
(
r
,"ZADD",4) == 0)  0;

893 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

895 ià(
	`rioWr™eBulkDoubË
(
r
,
scÜe
) == 0)  0;

896 ià(
v¡r
 !ğ
NULL
) {

897 ià(
	`rioWr™eBulkSŒšg
(
r
,(*)
v¡r
,
vËn
) == 0)  0;

899 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
vÎ
) == 0)  0;

901 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

902 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

903 
™ems
--;

905 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

906 
z£t
 *
zs
 = 
o
->
±r
;

907 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
zs
->
diù
);

908 
diùEÁry
 *
de
;

910 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

911 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

912 *
scÜe
 = 
	`diùG‘V®
(
de
);

914 ià(
couÁ
 == 0) {

915 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

916 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

918 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

919 ià(
	`rioWr™eBulkSŒšg
(
r
,"ZADD",4) == 0)  0;

920 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

922 ià(
	`rioWr™eBulkDoubË
(
r
,*
scÜe
) == 0)  0;

923 ià(
	`rioWr™eBulkSŒšg
(
r
,
–e
,
	`sd¦’
(ele)) == 0)  0;

924 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

925 
™ems
--;

927 
	`diùR–—£I‹¿tÜ
(
di
);

929 
	`£rv”Pªic
("Unknown sorted zsetƒncoding");

932 
	}
}

940 
	$rioWr™eHashI‹¿tÜCursÜ
(
rio
 *
r
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

941 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

942 *
v¡r
 = 
NULL
;

943 
vËn
 = 
UINT_MAX
;

944 
vÎ
 = 
LLONG_MAX
;

946 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

947 ià(
v¡r
)

948  
	`rioWr™eBulkSŒšg
(
r
, (*)
v¡r
, 
vËn
);

950  
	`rioWr™eBulkLÚgLÚg
(
r
, 
vÎ
);

951 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

952 
sds
 
v®ue
 = 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
);

953  
	`rioWr™eBulkSŒšg
(
r
, 
v®ue
, 
	`sd¦’
(value));

956 
	`£rv”Pªic
("Unknown hashƒncoding");

958 
	}
}

962 
	$»wr™eHashObjeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

963 
hashTy³I‹¿tÜ
 *
hi
;

964 
couÁ
 = 0, 
™ems
 = 
	`hashTy³L’gth
(
o
);

966 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

967 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

968 ià(
couÁ
 == 0) {

969 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

970 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

972 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

973 ià(
	`rioWr™eBulkSŒšg
(
r
,"HMSET",5) == 0)  0;

974 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

977 ià(
	`rioWr™eHashI‹¿tÜCursÜ
(
r
, 
hi
, 
OBJ_HASH_KEY
) == 0)  0;

978 ià(
	`rioWr™eHashI‹¿tÜCursÜ
(
r
, 
hi
, 
OBJ_HASH_VALUE
) == 0)  0;

979 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

980 
™ems
--;

983 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

986 
	}
}

991 
	$»wr™eModuËObjeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

992 
RedisModuËIO
 
io
;

993 
moduËV®ue
 *
mv
 = 
o
->
±r
;

994 
moduËTy³
 *
mt
 = 
mv
->
ty³
;

995 
	`moduËIn™IOCÚ‹xt
(
io
,
mt
,
r
);

996 
mt
->
	`aof_»wr™e
(&
io
,
key
,
mv
->
v®ue
);

997  
io
.
”rÜ
 ? 0 : 1;

998 
	}
}

1003 
ssize_t
 
	$aofR—dDiffFromP¬’t
() {

1004 
buf
[65536];

1005 
ssize_t
 
Ä—d
, 
tÙ®
 = 0;

1007 (
Ä—d
 =

1008 
	`»ad
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
,
buf
,(buf))) > 0) {

1009 
£rv”
.
aof_chd_diff
 = 
	`sdsÿ’
(£rv”.aof_chd_diff,
buf
,
Ä—d
);

1010 
tÙ®
 +ğ
Ä—d
;

1012  
tÙ®
;

1013 
	}
}

1022 
	$»wr™eAµ’dOÆyFe
(*
f’ame
) {

1023 
diùI‹¿tÜ
 *
di
 = 
NULL
;

1024 
diùEÁry
 *
de
;

1025 
rio
 
aof
;

1026 
FILE
 *
å
;

1027 
tmpfe
[256];

1028 
j
;

1029 
now
 = 
	`m¡ime
();

1030 
by‹
;

1031 
size_t
 
´oûs£d
 = 0;

1035 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-%d.aof", (è
	`g‘pid
());

1036 
å
 = 
	`fİ’
(
tmpfe
,"w");

1037 ià(!
å
) {

1038 
	`£rv”Log
(
LL_WARNING
, "O³nšgh‹m°ffÜ AOF„ewr™š„ewr™eAµ’dOÆyFe(): %s", 
	`¡»¼Ü
(
”ºo
));

1039  
C_ERR
;

1042 
£rv”
.
aof_chd_diff
 = 
	`sd£m±y
();

1043 
	`rioIn™W™hFe
(&
aof
,
å
);

1044 ià(
£rv”
.
aof_»wr™e_šüem’l_fsync
)

1045 
	`rioS‘AutoSync
(&
aof
,
AOF_AUTOSYNC_BYTES
);

1046 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1047 
£Ëùcmd
[] = "*2\r\n$6\r\nSELECT\r\n";

1048 
»disDb
 *
db
 = 
£rv”
.db+
j
;

1049 
diù
 *
d
 = 
db
->dict;

1050 ià(
	`diùSize
(
d
) == 0) ;

1051 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
d
);

1052 ià(!
di
) {

1053 
	`fşo£
(
å
);

1054  
C_ERR
;

1058 ià(
	`rioWr™e
(&
aof
,
£Ëùcmd
,(£Ëùcmd)-1è=ğ0è
w”r
;

1059 ià(
	`rioWr™eBulkLÚgLÚg
(&
aof
,
j
è=ğ0è
w”r
;

1062 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1063 
sds
 
key¡r
;

1064 
robj
 
key
, *
o
;

1065 
expœ‘ime
;

1067 
key¡r
 = 
	`diùG‘Key
(
de
);

1068 
o
 = 
	`diùG‘V®
(
de
);

1069 
	`š™SticSŒšgObjeù
(
key
,
key¡r
);

1071 
expœ‘ime
 = 
	`g‘Expœe
(
db
,&
key
);

1074 ià(
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
) ;

1077 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

1079 
cmd
[]="*3\r\n$3\r\nSET\r\n";

1080 ià(
	`rioWr™e
(&
aof
,
cmd
,(cmd)-1è=ğ0è
w”r
;

1082 ià(
	`rioWr™eBulkObjeù
(&
aof
,&
key
è=ğ0è
w”r
;

1083 ià(
	`rioWr™eBulkObjeù
(&
aof
,
o
è=ğ0è
w”r
;

1084 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

1085 ià(
	`»wr™eLi¡Objeù
(&
aof
,&
key
,
o
è=ğ0è
w”r
;

1086 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

1087 ià(
	`»wr™eS‘Objeù
(&
aof
,&
key
,
o
è=ğ0è
w”r
;

1088 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

1089 ià(
	`»wr™eSÜ‹dS‘Objeù
(&
aof
,&
key
,
o
è=ğ0è
w”r
;

1090 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

1091 ià(
	`»wr™eHashObjeù
(&
aof
,&
key
,
o
è=ğ0è
w”r
;

1092 } ià(
o
->
ty³
 =ğ
OBJ_MODULE
) {

1093 ià(
	`»wr™eModuËObjeù
(&
aof
,&
key
,
o
è=ğ0è
w”r
;

1095 
	`£rv”Pªic
("Unknown objectype");

1098 ià(
expœ‘ime
 != -1) {

1099 
cmd
[]="*3\r\n$9\r\nPEXPIREAT\r\n";

1100 ià(
	`rioWr™e
(&
aof
,
cmd
,(cmd)-1è=ğ0è
w”r
;

1101 ià(
	`rioWr™eBulkObjeù
(&
aof
,&
key
è=ğ0è
w”r
;

1102 ià(
	`rioWr™eBulkLÚgLÚg
(&
aof
,
expœ‘ime
è=ğ0è
w”r
;

1105 ià(
aof
.
´oûs£d_by‹s
 > 
´oûs£d
+1024*10) {

1106 
´oûs£d
 = 
aof
.
´oûs£d_by‹s
;

1107 
	`aofR—dDiffFromP¬’t
();

1110 
	`diùR–—£I‹¿tÜ
(
di
);

1111 
di
 = 
NULL
;

1116 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

1117 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

1125 
nod©a
 = 0;

1126 
m¡ime_t
 
¡¬t
 = 
	`m¡ime
();

1127 
	`m¡ime
()-
¡¬t
 < 1000 && 
nod©a
 < 20) {

1128 ià(
	`«Wa™
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
, 
AE_READABLE
, 1) <= 0)

1130 
nod©a
++;

1133 
nod©a
 = 0;

1135 
	`aofR—dDiffFromP¬’t
();

1139 ià(
	`wr™e
(
£rv”
.
aof_pe_wr™e_ack_to_·»Á
,"!",1è!ğ1è
w”r
;

1140 ià(
	`ª‘NÚBlock
(
NULL
,
£rv”
.
aof_pe_»ad_ack_äom_·»Á
è!ğ
ANET_OK
)

1141 
w”r
;

1145 ià(
	`syncR—d
(
£rv”
.
aof_pe_»ad_ack_äom_·»Á
,&
by‹
,1,5000) != 1 ||

1146 
by‹
 !ğ'!'è
w”r
;

1147 
	`£rv”Log
(
LL_NOTICE
,"Parent‡greedo stop sending diffs. Finalizing AOF...");

1150 
	`aofR—dDiffFromP¬’t
();

1153 
	`£rv”Log
(
LL_NOTICE
,

1155 (è
	`sd¦’
(
£rv”
.
aof_chd_diff
) / (1024*1024));

1156 ià(
	`rioWr™e
(&
aof
,
£rv”
.
aof_chd_diff
,
	`sd¦’
(server.aof_child_diff)) == 0)

1157 
w”r
;

1160 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

1161 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

1162 ià(
	`fşo£
(
å
è=ğ
EOF
è
w”r
;

1166 ià(
	`»Çme
(
tmpfe
,
f’ame
) == -1) {

1167 
	`£rv”Log
(
LL_WARNING
,"E¼Ü movšgem°­³nd oÆy fÚhfš® de¡š©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1168 
	`uÆšk
(
tmpfe
);

1169  
C_ERR
;

1171 
	`£rv”Log
(
LL_NOTICE
,"SYNC‡ppend only file„ewrite…erformed");

1172  
C_OK
;

1174 
w”r
:

1175 
	`£rv”Log
(
LL_WARNING
,"Wr™”rÜ wr™šg‡µ’d oÆy fÚ disk: %s", 
	`¡»¼Ü
(
”ºo
));

1176 
	`fşo£
(
å
);

1177 
	`uÆšk
(
tmpfe
);

1178 ià(
di
è
	`diùR–—£I‹¿tÜ
(di);

1179  
C_ERR
;

1180 
	}
}

1189 
	$aofChdPeR—dabË
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1190 
by‹
;

1191 
	`UNUSED
(
–
);

1192 
	`UNUSED
(
´ivd©a
);

1193 
	`UNUSED
(
mask
);

1195 ià(
	`»ad
(
fd
,&
by‹
,1) == 1 && byte == '!') {

1196 
	`£rv”Log
(
LL_NOTICE
,"AOF„ewrite child‡skso stop sending diffs.");

1197 
£rv”
.
aof_¡İ_£ndšg_diff
 = 1;

1198 ià(
	`wr™e
(
£rv”
.
aof_pe_wr™e_ack_to_chd
,"!",1) != 1) {

1203 
	`£rv”Log
(
LL_WARNING
,"Can't send ACKo AOF child: %s",

1204 
	`¡»¼Ü
(
”ºo
));

1209 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_»ad_ack_äom_chd
,
AE_READABLE
);

1210 
	}
}

1217 
	$aofC»©ePes
() {

1218 
fds
[6] = {-1, -1, -1, -1, -1, -1};

1219 
j
;

1221 ià(
	`pe
(
fds
è=ğ-1è
”rÜ
;

1222 ià(
	`pe
(
fds
+2è=ğ-1è
”rÜ
;

1223 ià(
	`pe
(
fds
+4è=ğ-1è
”rÜ
;

1225 ià(
	`ª‘NÚBlock
(
NULL
,
fds
[0]è!ğ
ANET_OK
è
”rÜ
;

1226 ià(
	`ª‘NÚBlock
(
NULL
,
fds
[1]è!ğ
ANET_OK
è
”rÜ
;

1227 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
fds
[2], 
AE_READABLE
, 
aofChdPeR—dabË
, 
NULL
è=ğ
AE_ERR
è
”rÜ
;

1229 
£rv”
.
aof_pe_wr™e_d©a_to_chd
 = 
fds
[1];

1230 
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
 = 
fds
[0];

1231 
£rv”
.
aof_pe_wr™e_ack_to_·»Á
 = 
fds
[3];

1232 
£rv”
.
aof_pe_»ad_ack_äom_chd
 = 
fds
[2];

1233 
£rv”
.
aof_pe_wr™e_ack_to_chd
 = 
fds
[5];

1234 
£rv”
.
aof_pe_»ad_ack_äom_·»Á
 = 
fds
[4];

1235 
£rv”
.
aof_¡İ_£ndšg_diff
 = 0;

1236  
C_OK
;

1238 
”rÜ
:

1239 
	`£rv”Log
(
LL_WARNING
,"Error opening /setting AOF„ewrite IPC…ipes: %s",

1240 
	`¡»¼Ü
(
”ºo
));

1241 
j
 = 0; j < 6; j++èif(
fds
[j] !ğ-1è
	`şo£
(fds[j]);

1242  
C_ERR
;

1243 
	}
}

1245 
	$aofClo£Pes
() {

1246 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_»ad_ack_äom_chd
,
AE_READABLE
);

1247 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,
AE_WRITABLE
);

1248 
	`şo£
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
);

1249 
	`şo£
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
);

1250 
	`şo£
(
£rv”
.
aof_pe_wr™e_ack_to_·»Á
);

1251 
	`şo£
(
£rv”
.
aof_pe_»ad_ack_äom_chd
);

1252 
	`şo£
(
£rv”
.
aof_pe_wr™e_ack_to_chd
);

1253 
	`şo£
(
£rv”
.
aof_pe_»ad_ack_äom_·»Á
);

1254 
	}
}

1272 
	$»wr™eAµ’dOÆyFeBackground
() {

1273 
pid_t
 
chdpid
;

1274 
¡¬t
;

1276 ià(
£rv”
.
aof_chd_pid
 !ğ-1è 
C_ERR
;

1277 ià(
	`aofC»©ePes
(è!ğ
C_OK
è 
C_ERR
;

1278 
¡¬t
 = 
	`u¡ime
();

1279 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1280 
tmpfe
[256];

1283 
	`şo£Li¡’šgSock‘s
(0);

1284 
	`»disS‘ProcT™Ë
("redis-aof-rewrite");

1285 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-bg-%d.aof", (è
	`g‘pid
());

1286 ià(
	`»wr™eAµ’dOÆyFe
(
tmpfe
è=ğ
C_OK
) {

1287 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
();

1289 ià(
´iv©e_dœty
) {

1290 
	`£rv”Log
(
LL_NOTICE
,

1292 
´iv©e_dœty
/(1024*1024));

1294 
	`ex™FromChd
(0);

1296 
	`ex™FromChd
(1);

1300 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1301 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1302 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1303 ià(
chdpid
 == -1) {

1304 
	`£rv”Log
(
LL_WARNING
,

1306 
	`¡»¼Ü
(
”ºo
));

1307  
C_ERR
;

1309 
	`£rv”Log
(
LL_NOTICE
,

1310 "Background‡µ’d oÆy f»wr™šg s¹ed by…id %d",
chdpid
);

1311 
£rv”
.
aof_»wr™e_scheduËd
 = 0;

1312 
£rv”
.
aof_»wr™e_time_¡¬t
 = 
	`time
(
NULL
);

1313 
£rv”
.
aof_chd_pid
 = 
chdpid
;

1314 
	`upd©eDiùResizePŞicy
();

1319 
£rv”
.
aof_£Ëùed_db
 = -1;

1320 
	`»¶iÿtiÚSütCacheFlush
();

1321  
C_OK
;

1323  
C_OK
;

1324 
	}
}

1326 
	$bg»wr™—ofCommªd
(
ş›Á
 *
c
) {

1327 ià(
£rv”
.
aof_chd_pid
 != -1) {

1328 
	`addR•lyE¼Ü
(
c
,"Background‡ppend only file„ewriting‡lready in…rogress");

1329 } ià(
£rv”
.
rdb_chd_pid
 != -1) {

1330 
£rv”
.
aof_»wr™e_scheduËd
 = 1;

1331 
	`addR•lyStus
(
c
,"Background‡ppend only file„ewriting scheduled");

1332 } ià(
	`»wr™eAµ’dOÆyFeBackground
(è=ğ
C_OK
) {

1333 
	`addR•lyStus
(
c
,"Background‡ppend only file„ewriting started");

1335 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

1337 
	}
}

1339 
	$aofRemoveTempFe
(
pid_t
 
chdpid
) {

1340 
tmpfe
[256];

1342 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-bg-%d.aof", (è
chdpid
);

1343 
	`uÆšk
(
tmpfe
);

1344 
	}
}

1350 
	$aofUpd©eCu¼’tSize
() {

1351 
»dis_¡©
 
sb
;

1352 
m¡ime_t
 
Ï‹ncy
;

1354 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1355 ià(
	`»dis_f¡©
(
£rv”
.
aof_fd
,&
sb
) == -1) {

1356 
	`£rv”Log
(
LL_WARNING
,"Unableo obtainhe AOF file†ength. stat: %s",

1357 
	`¡»¼Ü
(
”ºo
));

1359 
£rv”
.
aof_cu¼’t_size
 = 
sb
.
¡_size
;

1361 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1362 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-f¡©",
Ï‹ncy
);

1363 
	}
}

1367 
	$backgroundRewr™eDÚeHªdËr
(
ex™code
, 
bysigÇl
) {

1368 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1369 
Ãwfd
, 
Şdfd
;

1370 
tmpfe
[256];

1371 
now
 = 
	`u¡ime
();

1372 
m¡ime_t
 
Ï‹ncy
;

1374 
	`£rv”Log
(
LL_NOTICE
,

1379 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1380 
	`¢´štf
(
tmpfe
,256,"temp-rewriteaof-bg-%d.aof",

1381 ()
£rv”
.
aof_chd_pid
);

1382 
Ãwfd
 = 
	`İ’
(
tmpfe
,
O_WRONLY
|
O_APPEND
);

1383 ià(
Ãwfd
 == -1) {

1384 
	`£rv”Log
(
LL_WARNING
,

1385 "UÇbËØİ’h‹mpÜ¬y AOF…roduûd byhchd: %s", 
	`¡»¼Ü
(
”ºo
));

1386 
ş—nup
;

1389 ià(
	`aofRewr™eBufãrWr™e
(
Ãwfd
) == -1) {

1390 
	`£rv”Log
(
LL_WARNING
,

1391 "E¼ÜryšgØæushh·»Á difàtØth»wr™‹ÀAOF: %s", 
	`¡»¼Ü
(
”ºo
));

1392 
	`şo£
(
Ãwfd
);

1393 
ş—nup
;

1395 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1396 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-»wr™e-diff-wr™e",
Ï‹ncy
);

1398 
	`£rv”Log
(
LL_NOTICE
,

1399 "Residu®…¬’ˆdifàsucûssfuÎy flushedØth»wr™‹ÀAOF (%.2àMB)", (è
	`aofRewr™eBufãrSize
() / (1024*1024));

1428 ià(
£rv”
.
aof_fd
 == -1) {

1434 
Şdfd
 = 
	`İ’
(
£rv”
.
aof_f’ame
,
O_RDONLY
|
O_NONBLOCK
);

1437 
Şdfd
 = -1;

1442 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1443 ià(
	`»Çme
(
tmpfe
,
£rv”
.
aof_f’ame
) == -1) {

1444 
	`£rv”Log
(
LL_WARNING
,

1446 
tmpfe
,

1447 
£rv”
.
aof_f’ame
,

1448 
	`¡»¼Ü
(
”ºo
));

1449 
	`şo£
(
Ãwfd
);

1450 ià(
Şdfd
 !ğ-1è
	`şo£
(oldfd);

1451 
ş—nup
;

1453 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1454 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-»Çme",
Ï‹ncy
);

1456 ià(
£rv”
.
aof_fd
 == -1) {

1459 
	`şo£
(
Ãwfd
);

1462 
Şdfd
 = 
£rv”
.
aof_fd
;

1463 
£rv”
.
aof_fd
 = 
Ãwfd
;

1464 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
)

1465 
	`aof_fsync
(
Ãwfd
);

1466 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
)

1467 
	`aof_background_fsync
(
Ãwfd
);

1468 
£rv”
.
aof_£Ëùed_db
 = -1;

1469 
	`aofUpd©eCu¼’tSize
();

1470 
£rv”
.
aof_»wr™e_ba£_size
 = s”v”.
aof_cu¼’t_size
;

1474 
	`sdsä“
(
£rv”
.
aof_buf
);

1475 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

1478 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_OK
;

1480 
	`£rv”Log
(
LL_NOTICE
, "Background AOF„ewrite finished successfully");

1482 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_WAIT_REWRITE
)

1483 
£rv”
.
aof_¡©e
 = 
AOF_ON
;

1486 ià(
Şdfd
 !ğ-1è
	`bioC»©eBackgroundJob
(
BIO_CLOSE_FILE
,(*)()Şdfd,
NULL
,NULL);

1488 
	`£rv”Log
(
LL_VERBOSE
,

1489 "Background AOF„ewr™sigÇÈhªdË¸took %Îdus", 
	`u¡ime
()-
now
);

1490 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1493 ià(
bysigÇl
 !ğ
SIGUSR1
)

1494 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_ERR
;

1495 
	`£rv”Log
(
LL_WARNING
,

1498 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_ERR
;

1500 
	`£rv”Log
(
LL_WARNING
,

1501 "Background AOF„ewr™‹rmš©ed by sigÇÈ%d", 
bysigÇl
);

1504 
ş—nup
:

1505 
	`aofClo£Pes
();

1506 
	`aofRewr™eBufãrRe£t
();

1507 
	`aofRemoveTempFe
(
£rv”
.
aof_chd_pid
);

1508 
£rv”
.
aof_chd_pid
 = -1;

1509 
£rv”
.
aof_»wr™e_time_Ï¡
 = 
	`time
(
NULL
)-£rv”.
aof_»wr™e_time_¡¬t
;

1510 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

1512 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_WAIT_REWRITE
)

1513 
£rv”
.
aof_»wr™e_scheduËd
 = 1;

1514 
	}
}

	@asciilogo.h

30 *
	gascii_logo
 =

	@atomicvar.h

49 
	~<±h»ad.h
>

51 #iâdeà
__ATOMIC_VAR_H


52 
	#__ATOMIC_VAR_H


	)

54 #ià
defšed
(
__ATOMIC_RELAXED
)

57 
	#©omicInü
(
v¬
,
couÁ
,
mu‹x
è
	`__©omic_add_ãtch
(&v¬,(couÁ),
__ATOMIC_RELAXED
)

	)

58 
	#©omicDeü
(
v¬
,
couÁ
,
mu‹x
è
	`__©omic_sub_ãtch
(&v¬,(couÁ),
__ATOMIC_RELAXED
)

	)

59 
	#©omicG‘
(
v¬
,
d¡v¬
,
mu‹x
) do { \

60 
d¡v¬
 = 
	`__©omic_lßd_n
(&
v¬
,
__ATOMIC_RELAXED
); \

61 } 0)

	)

63 #–ià
defšed
(
HAVE_ATOMIC
)

66 
	#©omicInü
(
v¬
,
couÁ
,
mu‹x
è
	`__sync_add_ªd_ãtch
(&v¬,(couÁ))

	)

67 
	#©omicDeü
(
v¬
,
couÁ
,
mu‹x
è
	`__sync_sub_ªd_ãtch
(&v¬,(couÁ))

	)

68 
	#©omicG‘
(
v¬
,
d¡v¬
,
mu‹x
) do { \

69 
d¡v¬
 = 
	`__sync_sub_ªd_ãtch
(&
v¬
,0); \

70 } 0)

	)

75 
	#©omicInü
(
v¬
,
couÁ
,
mu‹x
) do { \

76 
	`±h»ad_mu‹x_lock
(&
mu‹x
); \

77 
v¬
 +ğ(
couÁ
); \

78 
	`±h»ad_mu‹x_uÆock
(&
mu‹x
); \

79 } 0)

	)

81 
	#©omicDeü
(
v¬
,
couÁ
,
mu‹x
) do { \

82 
	`±h»ad_mu‹x_lock
(&
mu‹x
); \

83 
v¬
 -ğ(
couÁ
); \

84 
	`±h»ad_mu‹x_uÆock
(&
mu‹x
); \

85 } 0)

	)

87 
	#©omicG‘
(
v¬
,
d¡v¬
,
mu‹x
) do { \

88 
	`±h»ad_mu‹x_lock
(&
mu‹x
); \

89 
d¡v¬
 = 
v¬
; \

90 
	`±h»ad_mu‹x_uÆock
(&
mu‹x
); \

91 } 0)

	)

	@bio.c

61 
	~"£rv”.h
"

62 
	~"bio.h
"

64 
±h»ad_t
 
	gbio_th»ads
[
BIO_NUM_OPS
];

65 
±h»ad_mu‹x_t
 
	gbio_mu‹x
[
BIO_NUM_OPS
];

66 
±h»ad_cÚd_t
 
	gbio_Ãwjob_cÚd
[
BIO_NUM_OPS
];

67 
±h»ad_cÚd_t
 
	gbio_¡•_cÚd
[
BIO_NUM_OPS
];

68 
li¡
 *
	gbio_jobs
[
BIO_NUM_OPS
];

75 
	gbio_³ndšg
[
BIO_NUM_OPS
];

79 
	sbio_job
 {

80 
time_t
 
	mtime
;

83 *
	m¬g1
, *
	m¬g2
, *
	m¬g3
;

86 *
bioProûssBackgroundJobs
(*
¬g
);

87 
Ïzyä“F»eObjeùFromBioTh»ad
(
robj
 *
o
);

88 
Ïzyä“F»eD©aba£FromBioTh»ad
(
diù
 *
ht1
, diù *
ht2
);

89 
Ïzyä“F»eSlÙsM­FromBioTh»ad
(
zskli¡
 *
¦
);

93 
	#REDIS_THREAD_STACK_SIZE
 (1024*1024*4)

	)

96 
	$bioIn™
() {

97 
±h»ad_©Œ_t
 
©Œ
;

98 
±h»ad_t
 
th»ad
;

99 
size_t
 
¡acksize
;

100 
j
;

103 
j
 = 0; j < 
BIO_NUM_OPS
; j++) {

104 
	`±h»ad_mu‹x_š™
(&
bio_mu‹x
[
j
],
NULL
);

105 
	`±h»ad_cÚd_š™
(&
bio_Ãwjob_cÚd
[
j
],
NULL
);

106 
	`±h»ad_cÚd_š™
(&
bio_¡•_cÚd
[
j
],
NULL
);

107 
bio_jobs
[
j
] = 
	`li¡C»©e
();

108 
bio_³ndšg
[
j
] = 0;

112 
	`±h»ad_©Œ_š™
(&
©Œ
);

113 
	`±h»ad_©Œ_g‘¡acksize
(&
©Œ
,&
¡acksize
);

114 ià(!
¡acksize
) stacksize = 1;

115 
¡acksize
 < 
REDIS_THREAD_STACK_SIZE
) stacksize *= 2;

116 
	`±h»ad_©Œ_£t¡acksize
(&
©Œ
, 
¡acksize
);

121 
j
 = 0; j < 
BIO_NUM_OPS
; j++) {

122 *
¬g
 = (*)(è
j
;

123 ià(
	`±h»ad_ü—‹
(&
th»ad
,&
©Œ
,
bioProûssBackgroundJobs
,
¬g
) != 0) {

124 
	`£rv”Log
(
LL_WARNING
,"Fatal: Can't initialize Background Jobs.");

125 
	`ex™
(1);

127 
bio_th»ads
[
j
] = 
th»ad
;

129 
	}
}

131 
	$bioC»©eBackgroundJob
(
ty³
, *
¬g1
, *
¬g2
, *
¬g3
) {

132 
bio_job
 *
job
 = 
	`zm®loc
((*job));

134 
job
->
time
 = 
	`time
(
NULL
);

135 
job
->
¬g1
 =‡rg1;

136 
job
->
¬g2
 =‡rg2;

137 
job
->
¬g3
 =‡rg3;

138 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

139 
	`li¡AddNodeTa
(
bio_jobs
[
ty³
],
job
);

140 
bio_³ndšg
[
ty³
]++;

141 
	`±h»ad_cÚd_sigÇl
(&
bio_Ãwjob_cÚd
[
ty³
]);

142 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

143 
	}
}

145 *
	$bioProûssBackgroundJobs
(*
¬g
) {

146 
bio_job
 *
job
;

147 
ty³
 = (è
¬g
;

148 
sig£t_t
 
sig£t
;

151 ià(
ty³
 >ğ
BIO_NUM_OPS
) {

152 
	`£rv”Log
(
LL_WARNING
,

153 "W¬nšg: biØth»ad s¹ed w™h wrÚgy³ %lu",
ty³
);

154  
NULL
;

159 
	`±h»ad_£tÿnûl¡©e
(
PTHREAD_CANCEL_ENABLE
, 
NULL
);

160 
	`±h»ad_£tÿnûÉy³
(
PTHREAD_CANCEL_ASYNCHRONOUS
, 
NULL
);

162 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

165 
	`sigem±y£t
(&
sig£t
);

166 
	`sigadd£t
(&
sig£t
, 
SIGALRM
);

167 ià(
	`±h»ad_sigmask
(
SIG_BLOCK
, &
sig£t
, 
NULL
))

168 
	`£rv”Log
(
LL_WARNING
,

169 "W¬nšg: cª'ˆmask SIGALRM iÀbio.øth»ad: %s", 
	`¡»¼Ü
(
”ºo
));

172 
li¡Node
 *
Ê
;

175 ià(
	`li¡L’gth
(
bio_jobs
[
ty³
]) == 0) {

176 
	`±h»ad_cÚd_wa™
(&
bio_Ãwjob_cÚd
[
ty³
],&
bio_mu‹x
[type]);

180 
Ê
 = 
	`li¡Fœ¡
(
bio_jobs
[
ty³
]);

181 
job
 = 
Ê
->
v®ue
;

184 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

187 ià(
ty³
 =ğ
BIO_CLOSE_FILE
) {

188 
	`şo£
(()
job
->
¬g1
);

189 } ià(
ty³
 =ğ
BIO_AOF_FSYNC
) {

190 
	`aof_fsync
(()
job
->
¬g1
);

191 } ià(
ty³
 =ğ
BIO_LAZY_FREE
) {

196 ià(
job
->
¬g1
)

197 
	`Ïzyä“F»eObjeùFromBioTh»ad
(
job
->
¬g1
);

198 ià(
job
->
¬g2
 && job->
¬g3
)

199 
	`Ïzyä“F»eD©aba£FromBioTh»ad
(
job
->
¬g2
,job->
¬g3
);

200 ià(
job
->
¬g3
)

201 
	`Ïzyä“F»eSlÙsM­FromBioTh»ad
(
job
->
¬g3
);

203 
	`£rv”Pªic
("Wrong jobype in bioProcessBackgroundJobs().");

205 
	`zä“
(
job
);

208 
	`±h»ad_cÚd_brßdÿ¡
(&
bio_¡•_cÚd
[
ty³
]);

212 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

213 
	`li¡D–Node
(
bio_jobs
[
ty³
],
Ê
);

214 
bio_³ndšg
[
ty³
]--;

216 
	}
}

219 
	$bioP’dšgJobsOfTy³
(
ty³
) {

220 
v®
;

221 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

222 
v®
 = 
bio_³ndšg
[
ty³
];

223 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

224  
v®
;

225 
	}
}

237 
	$bioWa™S‹pOfTy³
(
ty³
) {

238 
v®
;

239 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

240 
v®
 = 
bio_³ndšg
[
ty³
];

241 ià(
v®
 != 0) {

242 
	`±h»ad_cÚd_wa™
(&
bio_¡•_cÚd
[
ty³
],&
bio_mu‹x
[type]);

243 
v®
 = 
bio_³ndšg
[
ty³
];

245 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

246  
v®
;

247 
	}
}

253 
	$bioKlTh»ads
() {

254 
”r
, 
j
;

256 
j
 = 0; j < 
BIO_NUM_OPS
; j++) {

257 ià(
	`±h»ad_ÿnûl
(
bio_th»ads
[
j
]) == 0) {

258 ià((
”r
 = 
	`±h»ad_još
(
bio_th»ads
[
j
],
NULL
)) != 0) {

259 
	`£rv”Log
(
LL_WARNING
,

261 
j
, 
	`¡»¼Ü
(
”r
));

263 
	`£rv”Log
(
LL_WARNING
,

264 "BiØth»ad fÜ joby³ #%d”mš©ed",
j
);

268 
	}
}

	@bio.h

31 
bioIn™
();

32 
bioC»©eBackgroundJob
(
ty³
, *
¬g1
, *
¬g2
, *
¬g3
);

33 
bioP’dšgJobsOfTy³
(
ty³
);

34 
bioWa™S‹pOfTy³
(
ty³
);

35 
time_t
 
bioOld”JobOfTy³
(
ty³
);

36 
bioKlTh»ads
();

39 
	#BIO_CLOSE_FILE
 0

	)

40 
	#BIO_AOF_FSYNC
 1

	)

41 
	#BIO_LAZY_FREE
 2

	)

42 
	#BIO_NUM_OPS
 3

	)

	@bitops.c

31 
	~"£rv”.h
"

40 
size_t
 
	$»disPİcouÁ
(*
s
, 
couÁ
) {

41 
size_t
 
b™s
 = 0;

42 *
p
 = 
s
;

43 
ušt32_t
 *
p4
;

44 cÚ¡ 
b™sšby‹
[256] = {0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8};

47 ()
p
 & 3 && 
couÁ
) {

48 
b™s
 +ğ
b™sšby‹
[*
p
++];

49 
couÁ
--;

53 
p4
 = (
ušt32_t
*)
p
;

54 
couÁ
>=28) {

55 
ušt32_t
 
aux1
, 
aux2
, 
aux3
, 
aux4
, 
aux5
, 
aux6
, 
aux7
;

57 
aux1
 = *
p4
++;

58 
aux2
 = *
p4
++;

59 
aux3
 = *
p4
++;

60 
aux4
 = *
p4
++;

61 
aux5
 = *
p4
++;

62 
aux6
 = *
p4
++;

63 
aux7
 = *
p4
++;

64 
couÁ
 -= 28;

66 
aux1
 =‡ux1 - ((aux1 >> 1) & 0x55555555);

67 
aux1
 = (aux1 & 0x33333333) + ((aux1 >> 2) & 0x33333333);

68 
aux2
 =‡ux2 - ((aux2 >> 1) & 0x55555555);

69 
aux2
 = (aux2 & 0x33333333) + ((aux2 >> 2) & 0x33333333);

70 
aux3
 =‡ux3 - ((aux3 >> 1) & 0x55555555);

71 
aux3
 = (aux3 & 0x33333333) + ((aux3 >> 2) & 0x33333333);

72 
aux4
 =‡ux4 - ((aux4 >> 1) & 0x55555555);

73 
aux4
 = (aux4 & 0x33333333) + ((aux4 >> 2) & 0x33333333);

74 
aux5
 =‡ux5 - ((aux5 >> 1) & 0x55555555);

75 
aux5
 = (aux5 & 0x33333333) + ((aux5 >> 2) & 0x33333333);

76 
aux6
 =‡ux6 - ((aux6 >> 1) & 0x55555555);

77 
aux6
 = (aux6 & 0x33333333) + ((aux6 >> 2) & 0x33333333);

78 
aux7
 =‡ux7 - ((aux7 >> 1) & 0x55555555);

79 
aux7
 = (aux7 & 0x33333333) + ((aux7 >> 2) & 0x33333333);

80 
b™s
 +ğ((((
aux1
 + (aux1 >> 4)) & 0x0F0F0F0F) +

81 ((
aux2
 + (aux2 >> 4)) & 0x0F0F0F0F) +

82 ((
aux3
 + (aux3 >> 4)) & 0x0F0F0F0F) +

83 ((
aux4
 + (aux4 >> 4)) & 0x0F0F0F0F) +

84 ((
aux5
 + (aux5 >> 4)) & 0x0F0F0F0F) +

85 ((
aux6
 + (aux6 >> 4)) & 0x0F0F0F0F) +

86 ((
aux7
 + (aux7 >> 4)) & 0x0F0F0F0F))* 0x01010101) >> 24;

89 
p
 = (*)
p4
;

90 
couÁ
--è
b™s
 +ğ
b™sšby‹
[*
p
++];

91  
b™s
;

92 
	}
}

101 
	$»disB™pos
(*
s
, 
couÁ
, 
b™
) {

102 *
l
;

103 *
c
;

104 
skv®
, 
wÜd
 = 0, 
Úe
;

105 
pos
 = 0;

106 
j
;

118 
skv®
 = 
b™
 ? 0 : 
UCHAR_MAX
;

119 
c
 = (*è
s
;

120 ()
c
 & ((*
l
)-1è&& 
couÁ
) {

121 ià(*
c
 !ğ
skv®
) ;

122 
c
++;

123 
couÁ
--;

124 
pos
 += 8;

128 
skv®
 = 
b™
 ? 0 : 
ULONG_MAX
;

129 
l
 = (*è
c
;

130 
couÁ
 >ğ(*
l
)) {

131 ià(*
l
 !ğ
skv®
) ;

132 
l
++;

133 
couÁ
 -ğ(*
l
);

134 
pos
 +ğ(*
l
)*8;

144 
c
 = (*)
l
;

145 
j
 = 0; j < (*
l
); j++) {

146 
wÜd
 <<= 8;

147 ià(
couÁ
) {

148 
wÜd
 |ğ*
c
;

149 
c
++;

150 
couÁ
--;

159 ià(
b™
 =ğ1 && 
wÜd
 == 0)  -1;

165 
Úe
 = 
ULONG_MAX
;

166 
Úe
 >>= 1;

167 
Úe
 = ~one;

169 
Úe
) {

170 ià(((
Úe
 & 
wÜd
è!ğ0è=ğ
b™
è 
pos
;

171 
pos
++;

172 
Úe
 >>= 1;

177 
	`£rv”Pªic
("End of„edisBitpos()„eached.");

179 
	}
}

202 
	$£tUnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, ušt64_ˆ
v®ue
) {

203 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
;

205 
j
 = 0; j < 
b™s
; j++) {

206 
b™v®
 = (
v®ue
 & ((
ušt64_t
)1<<(
b™s
-1-
j
))) != 0;

207 
by‹
 = 
off£t
 >> 3;

208 
b™
 = 7 - (
off£t
 & 0x7);

209 
by‹v®
 = 
p
[
by‹
];

210 
by‹v®
 &ğ~(1 << 
b™
);

211 
by‹v®
 |ğ
b™v®
 << 
b™
;

212 
p
[
by‹
] = 
by‹v®
 & 0xff;

213 
off£t
++;

215 
	}
}

217 
	$£tSigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, 
št64_t
 
v®ue
) {

218 
ušt64_t
 
uv
 = 
v®ue
;

219 
	`£tUnsigÃdB™f›ld
(
p
,
off£t
,
b™s
,
uv
);

220 
	}
}

222 
ušt64_t
 
	$g‘UnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

223 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
, 
v®ue
 = 0;

225 
j
 = 0; j < 
b™s
; j++) {

226 
by‹
 = 
off£t
 >> 3;

227 
b™
 = 7 - (
off£t
 & 0x7);

228 
by‹v®
 = 
p
[
by‹
];

229 
b™v®
 = (
by‹v®
 >> 
b™
) & 1;

230 
v®ue
 = (v®ue<<1è| 
b™v®
;

231 
off£t
++;

233  
v®ue
;

234 
	}
}

236 
št64_t
 
	$g‘SigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

237 
št64_t
 
v®ue
;

238 uniÚ {
ušt64_t
 
u
; 
št64_t
 
i
;} 
cÚv
;

247 
cÚv
.
u
 = 
	`g‘UnsigÃdB™f›ld
(
p
,
off£t
,
b™s
);

248 
v®ue
 = 
cÚv
.
i
;

253 ià(
v®ue
 & ((
ušt64_t
)1 << (
b™s
-1)))

254 
v®ue
 |ğ((
ušt64_t
)-1è<< 
b™s
;

255  
v®ue
;

256 
	}
}

277 
	#BFOVERFLOW_WRAP
 0

	)

278 
	#BFOVERFLOW_SAT
 1

	)

279 
	#BFOVERFLOW_FAIL
 2

	)

281 
	$checkUnsigÃdB™f›ldOv”æow
(
ušt64_t
 
v®ue
, 
št64_t
 
šü
, ušt64_ˆ
b™s
, 
owty³
, ušt64_ˆ*
lim™
) {

282 
ušt64_t
 
max
 = (
b™s
 =ğ64è? 
UINT64_MAX
 : (((uint64_t)1<<bits)-1);

283 
št64_t
 
maxšü
 = 
max
-
v®ue
;

284 
št64_t
 
mššü
 = -
v®ue
;

286 ià(
v®ue
 > 
max
 || (
šü
 > 0 && inü > 
maxšü
)) {

287 ià(
lim™
) {

288 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

289 
hªdË_w¿p
;

290 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

291 *
lim™
 = 
max
;

295 } ià(
šü
 < 0 && inü < 
mššü
) {

296 ià(
lim™
) {

297 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

298 
hªdË_w¿p
;

299 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

300 *
lim™
 = 0;

307 
hªdË_w¿p
:

309 
ušt64_t
 
mask
 = ((ušt64_t)-1è<< 
b™s
;

310 
ušt64_t
 
»s
 = 
v®ue
+
šü
;

312 
»s
 &ğ~
mask
;

313 *
lim™
 = 
»s
;

316 
	}
}

318 
	$checkSigÃdB™f›ldOv”æow
(
št64_t
 
v®ue
, iÁ64_ˆ
šü
, 
ušt64_t
 
b™s
, 
owty³
, iÁ64_ˆ*
lim™
) {

319 
št64_t
 
max
 = (
b™s
 =ğ64è? 
INT64_MAX
 : (((int64_t)1<<(bits-1))-1);

320 
št64_t
 
mš
 = (-
max
)-1;

325 
št64_t
 
maxšü
 = 
max
-
v®ue
;

326 
št64_t
 
mššü
 = 
mš
-
v®ue
;

328 ià(
v®ue
 > 
max
 || (
b™s
 !ğ64 && 
šü
 > 
maxšü
) || (value >= 0 && incr > 0 && incr > maxincr))

330 ià(
lim™
) {

331 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

332 
hªdË_w¿p
;

333 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

334 *
lim™
 = 
max
;

338 } ià(
v®ue
 < 
mš
 || (
b™s
 !ğ64 && 
šü
 < 
mššü
) || (value < 0 && incr < 0 && incr < minincr)) {

339 ià(
lim™
) {

340 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

341 
hªdË_w¿p
;

342 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

343 *
lim™
 = 
mš
;

350 
hªdË_w¿p
:

352 
ušt64_t
 
mask
 = ((ušt64_t)-1è<< 
b™s
;

353 
ušt64_t
 
msb
 = (ušt64_t)1 << (
b™s
-1);

354 
ušt64_t
 
a
 = 
v®ue
, 
b
 = 
šü
, 
c
;

355 
c
 = 
a
+
b
;

360 ià(
c
 & 
msb
) {

361 
c
 |ğ
mask
;

363 
c
 &ğ~
mask
;

365 *
lim™
 = 
c
;

368 
	}
}

372 
	$´štB™s
(*
p
, 
couÁ
) {

373 
j
, 
i
, 
by‹
;

375 
j
 = 0; j < 
couÁ
; j++) {

376 
by‹
 = 
p
[
j
];

377 
i
 = 0x80; i > 0; i /= 2)

378 
	`´štf
("%c", (
by‹
 & 
i
) ? '1' : '0');

379 
	`´štf
("|");

381 
	`´štf
("\n");

382 
	}
}

388 
	#BITOP_AND
 0

	)

389 
	#BITOP_OR
 1

	)

390 
	#BITOP_XOR
 2

	)

391 
	#BITOP_NOT
 3

	)

393 
	#BITFIELDOP_GET
 0

	)

394 
	#BITFIELDOP_SET
 1

	)

395 
	#BITFIELDOP_INCRBY
 2

	)

404 
	$g‘B™Off£tFromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, 
size_t
 *
off£t
, 
hash
, 
b™s
) {

405 
loff£t
;

406 *
”r
 = "bit offset is‚ot‡n integer or out of„ange";

407 *
p
 = 
o
->
±r
;

408 
size_t
 
¶’
 = 
	`sd¦’
(
p
);

409 
u£hash
 = 0;

412 ià(
p
[0] =ğ'#' && 
hash
 && 
b™s
 > 0è
u£hash
 = 1;

414 ià(
	`¡ršg2Î
(
p
+
u£hash
,
¶’
-u£hash,&
loff£t
) == 0) {

415 
	`addR•lyE¼Ü
(
c
,
”r
);

416  
C_ERR
;

420 ià(
u£hash
è
loff£t
 *ğ
b™s
;

423 ià((
loff£t
 < 0) || (()loffset >> 3) >= (512*1024*1024))

425 
	`addR•lyE¼Ü
(
c
,
”r
);

426  
C_ERR
;

429 *
off£t
 = (
size_t
)
loff£t
;

430  
C_OK
;

431 
	}
}

440 
	$g‘B™f›ldTy³FromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, *
sign
, *
b™s
) {

441 *
p
 = 
o
->
±r
;

442 *
”r
 = "Invalid bitfieldype. Use something†ike i16 u8. Notehat u64 is‚ot supported but i64 is.";

443 
Îb™s
;

445 ià(
p
[0] == 'i') {

446 *
sign
 = 1;

447 } ià(
p
[0] == 'u') {

448 *
sign
 = 0;

450 
	`addR•lyE¼Ü
(
c
,
”r
);

451  
C_ERR
;

454 ià((
	`¡ršg2Î
(
p
+1,
	`¡¾’
Õ+1),&
Îb™s
)) == 0 ||

455 
Îb™s
 < 1 ||

456 (*
sign
 =ğ1 && 
Îb™s
 > 64) ||

457 (*
sign
 =ğ0 && 
Îb™s
 > 63))

459 
	`addR•lyE¼Ü
(
c
,
”r
);

460  
C_ERR
;

462 *
b™s
 = 
Îb™s
;

463  
C_OK
;

464 
	}
}

471 
robj
 *
	$lookupSŒšgFÜB™Commªd
(
ş›Á
 *
c
, 
size_t
 
maxb™
) {

472 
size_t
 
by‹
 = 
maxb™
 >> 3;

473 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

475 ià(
o
 =ğ
NULL
) {

476 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
by‹
+1));

477 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

479 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)è 
NULL
;

480 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

481 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
by‹
+1);

483  
o
;

484 
	}
}

499 *
	$g‘ObjeùR—dOÆySŒšg
(
robj
 *
o
, *
Ën
, *
Îbuf
) {

500 
	`£rv”As£¹
(
o
->
ty³
 =ğ
OBJ_STRING
);

501 *
p
 = 
NULL
;

505 ià(
o
 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

506 
p
 = (*è
Îbuf
;

507 ià(
Ën
è*ËÀğ
	`Î2¡ršg
(
Îbuf
,
LONG_STR_SIZE
,()
o
->
±r
);

508 } ià(
o
) {

509 
p
 = (*è
o
->
±r
;

510 ià(
Ën
è*ËÀğ
	`sd¦’
(
o
->
±r
);

512 ià(
Ën
) *len = 0;

514  
p
;

515 
	}
}

518 
	$£tb™Commªd
(
ş›Á
 *
c
) {

519 
robj
 *
o
;

520 *
”r
 = "bit is‚ot‡n integer or out of„ange";

521 
size_t
 
b™off£t
;

522 
ssize_t
 
by‹
, 
b™
;

523 
by‹v®
, 
b™v®
;

524 
Ú
;

526 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
C_OK
)

529 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
Ú
,
”r
è!ğ
C_OK
)

533 ià(
Ú
 & ~1) {

534 
	`addR•lyE¼Ü
(
c
,
”r
);

538 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,
b™off£t
)è=ğ
NULL
) ;

541 
by‹
 = 
b™off£t
 >> 3;

542 
by‹v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
];

543 
b™
 = 7 - (
b™off£t
 & 0x7);

544 
b™v®
 = 
by‹v®
 & (1 << 
b™
);

547 
by‹v®
 &ğ~(1 << 
b™
);

548 
by‹v®
 |ğ((
Ú
 & 0x1è<< 
b™
);

549 ((
ušt8_t
*)
o
->
±r
)[
by‹
] = 
by‹v®
;

550 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

551 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

552 
£rv”
.
dœty
++;

553 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

554 
	}
}

557 
	$g‘b™Commªd
(
ş›Á
 *
c
) {

558 
robj
 *
o
;

559 
Îbuf
[32];

560 
size_t
 
b™off£t
;

561 
size_t
 
by‹
, 
b™
;

562 
size_t
 
b™v®
 = 0;

564 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
C_OK
)

567 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

568 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

570 
by‹
 = 
b™off£t
 >> 3;

571 
b™
 = 7 - (
b™off£t
 & 0x7);

572 ià(
	`sdsEncodedObjeù
(
o
)) {

573 ià(
by‹
 < 
	`sd¦’
(
o
->
±r
))

574 
b™v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
] & (1 << 
b™
);

576 ià(
by‹
 < (
size_t
)
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
))

577 
b™v®
 = 
Îbuf
[
by‹
] & (1 << 
b™
);

580 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

581 
	}
}

584 
	$b™İCommªd
(
ş›Á
 *
c
) {

585 *
İÇme
 = 
c
->
¬gv
[1]->
±r
;

586 
robj
 *
o
, *
rg‘key
 = 
c
->
¬gv
[2];

587 
İ
, 
j
, 
numkeys
;

588 
robj
 **
objeùs
;

589 **
¤c
;

590 *
Ën
, 
maxËn
 = 0;

592 
mšËn
 = 0;

593 *
»s
 = 
NULL
;

596 ià((
İÇme
[0] =ğ'a' || o²ame[0] =ğ'A'è&& !
	`¡rÿ£cmp
(opname,"and"))

597 
İ
 = 
BITOP_AND
;

598 if((
İÇme
[0] =ğ'o' || o²ame[0] =ğ'O'è&& !
	`¡rÿ£cmp
(opname,"or"))

599 
İ
 = 
BITOP_OR
;

600 if((
İÇme
[0] =ğ'x' || o²ame[0] =ğ'X'è&& !
	`¡rÿ£cmp
(opname,"xor"))

601 
İ
 = 
BITOP_XOR
;

602 if((
İÇme
[0] =ğ'n' || o²ame[0] =ğ'N'è&& !
	`¡rÿ£cmp
(opname,"not"))

603 
İ
 = 
BITOP_NOT
;

605 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

610 ià(
İ
 =ğ
BITOP_NOT
 && 
c
->
¬gc
 != 4) {

611 
	`addR•lyE¼Ü
(
c
,"BITOP NOT must be called with‡ single source key.");

616 
numkeys
 = 
c
->
¬gc
 - 3;

617 
¤c
 = 
	`zm®loc
((*è* 
numkeys
);

618 
Ën
 = 
	`zm®loc
((è* 
numkeys
);

619 
objeùs
 = 
	`zm®loc
((
robj
*è* 
numkeys
);

620 
j
 = 0; j < 
numkeys
; j++) {

621 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
+3]);

623 ià(
o
 =ğ
NULL
) {

624 
objeùs
[
j
] = 
NULL
;

625 
¤c
[
j
] = 
NULL
;

626 
Ën
[
j
] = 0;

627 
mšËn
 = 0;

631 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

632 
i
;

633 
i
 = 0; i < 
j
; i++) {

634 ià(
objeùs
[
i
])

635 
	`deüRefCouÁ
(
objeùs
[
i
]);

637 
	`zä“
(
¤c
);

638 
	`zä“
(
Ën
);

639 
	`zä“
(
objeùs
);

642 
objeùs
[
j
] = 
	`g‘DecodedObjeù
(
o
);

643 
¤c
[
j
] = 
objeùs
[j]->
±r
;

644 
Ën
[
j
] = 
	`sd¦’
(
objeùs
[j]->
±r
);

645 ià(
Ën
[
j
] > 
maxËn
) maxlen =†en[j];

646 ià(
j
 =ğ0 || 
Ën
[j] < 
mšËn
) minlen =†en[j];

650 ià(
maxËn
) {

651 
»s
 = (*è
	`sd¢ewËn
(
NULL
,
maxËn
);

652 
ouut
, 
by‹
;

653 
i
;

658 
j
 = 0;

659 ià(
mšËn
 >ğ()*4 && 
numkeys
 <= 16) {

660 *
Í
[16];

661 *
Ìes
 = (*è
»s
;

664 
	`memıy
(
Í
,
¤c
,(*)*
numkeys
);

665 
	`memıy
(
»s
,
¤c
[0],
mšËn
);

668 ià(
İ
 =ğ
BITOP_AND
) {

669 
mšËn
 >= ()*4) {

670 
i
 = 1; i < 
numkeys
; i++) {

671 
Ìes
[0] &ğ
Í
[
i
][0];

672 
Ìes
[1] &ğ
Í
[
i
][1];

673 
Ìes
[2] &ğ
Í
[
i
][2];

674 
Ìes
[3] &ğ
Í
[
i
][3];

675 
Í
[
i
]+=4;

677 
Ìes
+=4;

678 
j
 += ()*4;

679 
mšËn
 -= ()*4;

681 } ià(
İ
 =ğ
BITOP_OR
) {

682 
mšËn
 >= ()*4) {

683 
i
 = 1; i < 
numkeys
; i++) {

684 
Ìes
[0] |ğ
Í
[
i
][0];

685 
Ìes
[1] |ğ
Í
[
i
][1];

686 
Ìes
[2] |ğ
Í
[
i
][2];

687 
Ìes
[3] |ğ
Í
[
i
][3];

688 
Í
[
i
]+=4;

690 
Ìes
+=4;

691 
j
 += ()*4;

692 
mšËn
 -= ()*4;

694 } ià(
İ
 =ğ
BITOP_XOR
) {

695 
mšËn
 >= ()*4) {

696 
i
 = 1; i < 
numkeys
; i++) {

697 
Ìes
[0] ^ğ
Í
[
i
][0];

698 
Ìes
[1] ^ğ
Í
[
i
][1];

699 
Ìes
[2] ^ğ
Í
[
i
][2];

700 
Ìes
[3] ^ğ
Í
[
i
][3];

701 
Í
[
i
]+=4;

703 
Ìes
+=4;

704 
j
 += ()*4;

705 
mšËn
 -= ()*4;

707 } ià(
İ
 =ğ
BITOP_NOT
) {

708 
mšËn
 >= ()*4) {

709 
Ìes
[0] = ~lres[0];

710 
Ìes
[1] = ~lres[1];

711 
Ìes
[2] = ~lres[2];

712 
Ìes
[3] = ~lres[3];

713 
Ìes
+=4;

714 
j
 += ()*4;

715 
mšËn
 -= ()*4;

721 ; 
j
 < 
maxËn
; j++) {

722 
ouut
 = (
Ën
[0] <ğ
j
è? 0 : 
¤c
[0][j];

723 ià(
İ
 =ğ
BITOP_NOT
è
ouut
 = ~output;

724 
i
 = 1; i < 
numkeys
; i++) {

725 
by‹
 = (
Ën
[
i
] <ğ
j
è? 0 : 
¤c
[i][j];

726 
İ
) {

727 
BITOP_AND
: 
ouut
 &ğ
by‹
; ;

728 
BITOP_OR
: 
ouut
 |ğ
by‹
; ;

729 
BITOP_XOR
: 
ouut
 ^ğ
by‹
; ;

732 
»s
[
j
] = 
ouut
;

735 
j
 = 0; j < 
numkeys
; j++) {

736 ià(
objeùs
[
j
])

737 
	`deüRefCouÁ
(
objeùs
[
j
]);

739 
	`zä“
(
¤c
);

740 
	`zä“
(
Ën
);

741 
	`zä“
(
objeùs
);

744 ià(
maxËn
) {

745 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
»s
);

746 
	`£tKey
(
c
->
db
,
rg‘key
,
o
);

747 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
rg‘key
,
c
->
db
->
id
);

748 
	`deüRefCouÁ
(
o
);

749 } ià(
	`dbD–‘e
(
c
->
db
,
rg‘key
)) {

750 
	`sigÇlModif›dKey
(
c
->
db
,
rg‘key
);

751 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
rg‘key
,
c
->
db
->
id
);

753 
£rv”
.
dœty
++;

754 
	`addR•lyLÚgLÚg
(
c
,
maxËn
);

755 
	}
}

758 
	$b™couÁCommªd
(
ş›Á
 *
c
) {

759 
robj
 *
o
;

760 
¡¬t
, 
’d
, 
¡¾’
;

761 *
p
;

762 
Îbuf
[
LONG_STR_SIZE
];

765 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

766 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

767 
p
 = 
	`g‘ObjeùR—dOÆySŒšg
(
o
,&
¡¾’
,
Îbuf
);

770 ià(
c
->
¬gc
 == 4) {

771 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
C_OK
)

773 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
C_OK
)

776 ià(
¡¬t
 < 0 && 
’d
 < 0 && start >ƒnd) {

777 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

780 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

781 ià(
’d
 < 0è’d = 
¡¾’
+end;

782 ià(
¡¬t
 < 0) start = 0;

783 ià(
’d
 < 0)ƒnd = 0;

784 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

785 } ià(
c
->
¬gc
 == 2) {

787 
¡¬t
 = 0;

788 
’d
 = 
¡¾’
-1;

791 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

797 ià(
¡¬t
 > 
’d
) {

798 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

800 
by‹s
 = 
’d
-
¡¬t
+1;

802 
	`addR•lyLÚgLÚg
(
c
,
	`»disPİcouÁ
(
p
+
¡¬t
,
by‹s
));

804 
	}
}

807 
	$b™posCommªd
(
ş›Á
 *
c
) {

808 
robj
 *
o
;

809 
b™
, 
¡¬t
, 
’d
, 
¡¾’
;

810 *
p
;

811 
Îbuf
[
LONG_STR_SIZE
];

812 
’d_giv’
 = 0;

816 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
b™
,
NULL
è!ğ
C_OK
)

818 ià(
b™
 != 0 && bit != 1) {

819 
	`addR•lyE¼Ü
(
c
, "The bit‡rgument must be 1 or 0.");

826 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

827 
	`addR•lyLÚgLÚg
(
c
, 
b™
 ? -1 : 0);

830 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

831 
p
 = 
	`g‘ObjeùR—dOÆySŒšg
(
o
,&
¡¾’
,
Îbuf
);

834 ià(
c
->
¬gc
 == 4 || c->argc == 5) {

835 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
¡¬t
,
NULL
è!ğ
C_OK
)

837 ià(
c
->
¬gc
 == 5) {

838 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
’d
,
NULL
è!ğ
C_OK
)

840 
’d_giv’
 = 1;

842 
’d
 = 
¡¾’
-1;

845 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

846 ià(
’d
 < 0è’d = 
¡¾’
+end;

847 ià(
¡¬t
 < 0) start = 0;

848 ià(
’d
 < 0)ƒnd = 0;

849 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

850 } ià(
c
->
¬gc
 == 3) {

852 
¡¬t
 = 0;

853 
’d
 = 
¡¾’
-1;

856 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

862 ià(
¡¬t
 > 
’d
) {

863 
	`addR•lyLÚgLÚg
(
c
, -1);

865 
by‹s
 = 
’d
-
¡¬t
+1;

866 
pos
 = 
	`»disB™pos
(
p
+
¡¬t
,
by‹s
,
b™
);

875 ià(
’d_giv’
 && 
b™
 =ğ0 && 
pos
 =ğ
by‹s
*8) {

876 
	`addR•lyLÚgLÚg
(
c
,-1);

879 ià(
pos
 !ğ-1èpo +ğ
¡¬t
*8;

880 
	`addR•lyLÚgLÚg
(
c
,
pos
);

882 
	}
}

894 
	sb™f›ldOp
 {

895 
ušt64_t
 
	moff£t
;

896 
št64_t
 
	mi64
;

897 
	mİcode
;

898 
	mowty³
;

899 
	mb™s
;

900 
	msign
;

903 
	$b™f›ldCommªd
(
ş›Á
 *
c
) {

904 
robj
 *
o
;

905 
size_t
 
b™off£t
;

906 
j
, 
numİs
 = 0, 
chªges
 = 0;

907 
b™f›ldOp
 *
İs
 = 
NULL
;

908 
owty³
 = 
BFOVERFLOW_WRAP
;

909 
»adÚly
 = 1;

910 
hige¡_wr™e_off£t
 = 0;

912 
j
 = 2; j < 
c
->
¬gc
; j++) {

913 
»m¬gs
 = 
c
->
¬gc
-
j
-1;

914 *
subcmd
 = 
c
->
¬gv
[
j
]->
±r
;

915 
İcode
;

916 
i64
 = 0;

917 
sign
 = 0;

918 
b™s
 = 0;

920 ià(!
	`¡rÿ£cmp
(
subcmd
,"g‘"è&& 
»m¬gs
 >= 2)

921 
İcode
 = 
BITFIELDOP_GET
;

922 ià(!
	`¡rÿ£cmp
(
subcmd
,"£t"è&& 
»m¬gs
 >= 3)

923 
İcode
 = 
BITFIELDOP_SET
;

924 ià(!
	`¡rÿ£cmp
(
subcmd
,"šüby"è&& 
»m¬gs
 >= 3)

925 
İcode
 = 
BITFIELDOP_INCRBY
;

926 ià(!
	`¡rÿ£cmp
(
subcmd
,"ov”æow"è&& 
»m¬gs
 >= 1) {

927 *
owty³Çme
 = 
c
->
¬gv
[
j
+1]->
±r
;

928 
j
++;

929 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"wrap"))

930 
owty³
 = 
BFOVERFLOW_WRAP
;

931 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"sat"))

932 
owty³
 = 
BFOVERFLOW_SAT
;

933 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"fail"))

934 
owty³
 = 
BFOVERFLOW_FAIL
;

936 
	`addR•lyE¼Ü
(
c
,"Invalid OVERFLOWype specified");

937 
	`zä“
(
İs
);

942 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

943 
	`zä“
(
İs
);

948 ià(
	`g‘B™f›ldTy³FromArgum’t
(
c
,c->
¬gv
[
j
+1],&
sign
,&
b™s
è!ğ
C_OK
) {

949 
	`zä“
(
İs
);

953 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[
j
+2],&
b™off£t
,1,
b™s
è!ğ
C_OK
){

954 
	`zä“
(
İs
);

958 ià(
İcode
 !ğ
BITFIELDOP_GET
) {

959 
»adÚly
 = 0;

960 
hige¡_wr™e_off£t
 = 
b™off£t
 + 
b™s
 - 1;

962 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+3],&
i64
,
NULL
è!ğ
C_OK
){

963 
	`zä“
(
İs
);

969 
İs
 = 
	`z»®loc
(İs,(*İs)*(
numİs
+1));

970 
İs
[
numİs
].
off£t
 = 
b™off£t
;

971 
İs
[
numİs
].
i64
 = i64;

972 
İs
[
numİs
].
İcode
 = opcode;

973 
İs
[
numİs
].
owty³
 = owtype;

974 
İs
[
numİs
].
b™s
 = bits;

975 
İs
[
numİs
].
sign
 = sign;

976 
numİs
++;

978 
j
 +ğ3 - (
İcode
 =ğ
BITFIELDOP_GET
);

981 ià(
»adÚly
) {

984 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

985 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)) ;

989 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,

990 
hige¡_wr™e_off£t
)è=ğ
NULL
) ;

993 
	`addR•lyMuÉiBulkL’
(
c
,
numİs
);

996 
j
 = 0; j < 
numİs
; j++) {

997 
b™f›ldOp
 *
thisİ
 = 
İs
+
j
;

1000 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_SET
 ||

1001 
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
)

1010 ià(
thisİ
->
sign
) {

1011 
št64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1012 
ov”æow
;

1014 
Şdv®
 = 
	`g‘SigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1015 
thisİ
->
b™s
);

1017 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1018 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1019 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Şdv®
,

1020 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1021 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1022 
»tv®
 = 
Ãwv®
;

1024 
Ãwv®
 = 
thisİ
->
i64
;

1025 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Ãwv®
,

1026 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1027 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1028 
»tv®
 = 
Şdv®
;

1033 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1034 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1035 
	`£tSigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1036 
thisİ
->
b™s
,
Ãwv®
);

1038 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1041 
ušt64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1042 
ov”æow
;

1044 
Şdv®
 = 
	`g‘UnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1045 
thisİ
->
b™s
);

1047 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1048 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1049 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Şdv®
,

1050 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1051 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1052 
»tv®
 = 
Ãwv®
;

1054 
Ãwv®
 = 
thisİ
->
i64
;

1055 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Ãwv®
,

1056 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1057 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1058 
»tv®
 = 
Şdv®
;

1062 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1063 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1064 
	`£tUnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1065 
thisİ
->
b™s
,
Ãwv®
);

1067 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1070 
chªges
++;

1073 
buf
[9];

1074 
¡¾’
 = 0;

1075 *
¤c
 = 
NULL
;

1076 
Îbuf
[
LONG_STR_SIZE
];

1078 ià(
o
 !ğ
NULL
)

1079 
¤c
 = 
	`g‘ObjeùR—dOÆySŒšg
(
o
,&
¡¾’
,
Îbuf
);

1085 
	`mem£t
(
buf
,0,9);

1086 
i
;

1087 
size_t
 
by‹
 = 
thisİ
->
off£t
 >> 3;

1088 
i
 = 0; i < 9; i++) {

1089 ià(
¤c
 =ğ
NULL
 || 
i
+
by‹
 >ğ(
size_t
)
¡¾’
) ;

1090 
buf
[
i
] = 
¤c
[i+
by‹
];

1095 ià(
thisİ
->
sign
) {

1096 
št64_t
 
v®
 = 
	`g‘SigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1097 
thisİ
->
b™s
);

1098 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1100 
ušt64_t
 
v®
 = 
	`g‘UnsigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1101 
thisİ
->
b™s
);

1102 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1107 ià(
chªges
) {

1108 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1109 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

1110 
£rv”
.
dœty
 +ğ
chªges
;

1112 
	`zä“
(
İs
);

1113 
	}
}

	@blocked.c

66 
	~"£rv”.h
"

76 
	$g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, 
m¡ime_t
 *
timeout
, 
un™
) {

77 
tv®
;

79 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
objeù
,&
tv®
,

80 "timeouˆi nÙ‡Àš‹g” o¸ouˆoà¿nge"è!ğ
C_OK
)

81  
C_ERR
;

83 ià(
tv®
 < 0) {

84 
	`addR•lyE¼Ü
(
c
,"timeout is‚egative");

85  
C_ERR
;

88 ià(
tv®
 > 0) {

89 ià(
un™
 =ğ
UNIT_SECONDS
è
tv®
 *= 1000;

90 
tv®
 +ğ
	`m¡ime
();

92 *
timeout
 = 
tv®
;

94  
C_OK
;

95 
	}
}

100 
	$blockCl›Á
(
ş›Á
 *
c
, 
bty³
) {

101 
c
->
æags
 |ğ
CLIENT_BLOCKED
;

102 
c
->
bty³
 = btype;

103 
£rv”
.
bpİ_blocked_ş›Ás
++;

104 
	}
}

109 
	$´oûssUnblockedCl›Ás
() {

110 
li¡Node
 *
Ê
;

111 
ş›Á
 *
c
;

113 
	`li¡L’gth
(
£rv”
.
unblocked_ş›Ás
)) {

114 
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
unblocked_ş›Ás
);

115 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

116 
c
 = 
Ê
->
v®ue
;

117 
	`li¡D–Node
(
£rv”
.
unblocked_ş›Ás
,
Ê
);

118 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

124 ià(!(
c
->
æags
 & 
CLIENT_BLOCKED
)) {

125 ià(
c
->
qu”ybuf
 && 
	`sd¦’
(c->querybuf) > 0) {

126 
	`´oûssIÅutBufãr
(
c
);

130 
	}
}

134 
	$unblockCl›Á
(
ş›Á
 *
c
) {

135 ià(
c
->
bty³
 =ğ
BLOCKED_LIST
) {

136 
	`unblockCl›ÁWa™šgD©a
(
c
);

137 } ià(
c
->
bty³
 =ğ
BLOCKED_WAIT
) {

138 
	`unblockCl›ÁWa™šgR•liÿs
(
c
);

140 
	`£rv”Pªic
("Unknown btype in unblockClient().");

144 
c
->
æags
 &ğ~
CLIENT_BLOCKED
;

145 
c
->
bty³
 = 
BLOCKED_NONE
;

146 
£rv”
.
bpİ_blocked_ş›Ás
--;

149 ià(!(
c
->
æags
 & 
CLIENT_UNBLOCKED
)) {

150 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

151 
	`li¡AddNodeTa
(
£rv”
.
unblocked_ş›Ás
,
c
);

153 
	}
}

157 
	$»¶yToBlockedCl›ÁTimedOut
(
ş›Á
 *
c
) {

158 ià(
c
->
bty³
 =ğ
BLOCKED_LIST
) {

159 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

160 } ià(
c
->
bty³
 =ğ
BLOCKED_WAIT
) {

161 
	`addR•lyLÚgLÚg
(
c
,
	`»¶iÿtiÚCouÁAcksByOff£t
(c->
bpİ
.
»¶off£t
));

163 
	`£rv”Pªic
("Unknown btype in„eplyToBlockedClientTimedOut().");

165 
	}
}

174 
	$discÚÃùAÎBlockedCl›Ás
() {

175 
li¡Node
 *
Ê
;

176 
li¡I‹r
 
li
;

178 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

179 (
Ê
 = 
	`li¡Next
(&
li
))) {

180 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

182 ià(
c
->
æags
 & 
CLIENT_BLOCKED
) {

183 
	`addR•lySds
(
c
,
	`sd¢ew
(

186 
	`unblockCl›Á
(
c
);

187 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

190 
	}
}

	@cluster.c

31 
	~"£rv”.h
"

32 
	~"şu¡”.h
"

33 
	~"’dŸncÚv.h
"

35 
	~<sys/ty³s.h
>

36 
	~<sys/sock‘.h
>

37 
	~<¬·/š‘.h
>

38 
	~<fú.h
>

39 
	~<uni¡d.h
>

40 
	~<sys/sock‘.h
>

41 
	~<sys/¡©.h
>

42 
	~<sys/fe.h
>

43 
	~<m©h.h
>

48 
şu¡”Node
 *
	gmy£lf
 = 
NULL
;

50 
şu¡”Node
 *
ü—‹Clu¡”Node
(*
nod’ame
, 
æags
);

51 
şu¡”AddNode
(
şu¡”Node
 *
node
);

52 
şu¡”Acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

53 
şu¡”R—dHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

54 
şu¡”S’dPšg
(
şu¡”Lšk
 *
lšk
, 
ty³
);

55 
şu¡”S’dFa
(*
nod’ame
);

56 
şu¡”S’dFaov”AuthIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Msg
 *
»que¡
);

57 
şu¡”Upd©eS‹
();

58 
şu¡”NodeG‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
);

59 
sds
 
şu¡”G’NodesDesütiÚ
(
f‹r
);

60 
şu¡”Node
 *
şu¡”LookupNode
(*
Çme
);

61 
şu¡”NodeAddSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
);

62 
şu¡”AddSlÙ
(
şu¡”Node
 *
n
, 
¦Ù
);

63 
şu¡”D–SlÙ
(
¦Ù
);

64 
şu¡”D–NodeSlÙs
(
şu¡”Node
 *
node
);

65 
şu¡”NodeS‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
);

66 
şu¡”S‘Ma¡”
(
şu¡”Node
 *
n
);

67 
şu¡”HªdËSÏveFaov”
();

68 
şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
);

69 
b™m­Te¡B™
(*
b™m­
, 
pos
);

70 
şu¡”DoBefÜeSË•
(
æags
);

71 
şu¡”S’dUpd©e
(
şu¡”Lšk
 *
lšk
, 
şu¡”Node
 *
node
);

72 
»£tMªu®Faov”
();

73 
şu¡”Clo£AÎSlÙs
();

74 
şu¡”S‘NodeAsMa¡”
(
şu¡”Node
 *
n
);

75 
şu¡”D–Node
(
şu¡”Node
 *
d–node
);

76 
sds
 
»´e£ÁClu¡”NodeFÏgs
(sd 
ci
, 
ušt16_t
 
æags
);

77 
ušt64_t
 
şu¡”G‘MaxEpoch
();

78 
şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

90 
	$şu¡”LßdCÚfig
(*
f’ame
) {

91 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r");

92 
¡©
 
sb
;

93 *
lše
;

94 
maxlše
, 
j
;

96 ià(
å
 =ğ
NULL
) {

97 ià(
”ºo
 =ğ
ENOENT
) {

98  
C_ERR
;

100 
	`£rv”Log
(
LL_WARNING
,

102 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

103 
	`ex™
(1);

109 ià(
	`f¡©
(
	`f’o
(
å
),&
sb
è!ğ-1 && sb.
¡_size
 == 0) {

110 
	`fşo£
(
å
);

111  
C_ERR
;

121 
maxlše
 = 1024+
CLUSTER_SLOTS
*128;

122 
lše
 = 
	`zm®loc
(
maxlše
);

123 
	`fg‘s
(
lše
,
maxlše
,
å
è!ğ
NULL
) {

124 
¬gc
;

125 
sds
 *
¬gv
;

126 
şu¡”Node
 *
n
, *
ma¡”
;

127 *
p
, *
s
;

132 ià(
lše
[0] == '\n') ;

135 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

136 ià(
¬gv
 =ğ
NULL
è
fm‹¼
;

140 ià(
	`¡rÿ£cmp
(
¬gv
[0],"vars") == 0) {

141 
j
 = 1; j < 
¬gc
; j += 2) {

142 ià(
	`¡rÿ£cmp
(
¬gv
[
j
],"currentEpoch") == 0) {

143 
£rv”
.
şu¡”
->
cu¼’tEpoch
 =

144 
	`¡¹ouÎ
(
¬gv
[
j
+1],
NULL
,10);

145 } ià(
	`¡rÿ£cmp
(
¬gv
[
j
],"lastVoteEpoch") == 0) {

146 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 =

147 
	`¡¹ouÎ
(
¬gv
[
j
+1],
NULL
,10);

149 
	`£rv”Log
(
LL_WARNING
,

151 
¬gv
[
j
]);

154 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

159 ià(
¬gc
 < 8è
fm‹¼
;

162 
n
 = 
	`şu¡”LookupNode
(
¬gv
[0]);

163 ià(!
n
) {

164 
n
 = 
	`ü—‹Clu¡”Node
(
¬gv
[0],0);

165 
	`şu¡”AddNode
(
n
);

168 ià((
p
 = 
	`¡¼chr
(
¬gv
[1],':')è=ğ
NULL
è
fm‹¼
;

169 *
p
 = '\0';

170 
	`memıy
(
n
->

,
¬gv
[1],
	`¡¾’
(argv[1])+1);

171 *
pÜt
 = 
p
+1;

172 *
bu¥
 = 
	`¡rchr
(
pÜt
,'@');

173 ià(
bu¥
) {

174 *
bu¥
 = '\0';

175 
bu¥
++;

177 
n
->
pÜt
 = 
	`©oi
(port);

181 
n
->
ıÜt
 = 
bu¥
 ? 
	`©oi
(bu¥è:‚->
pÜt
 + 
CLUSTER_PORT_INCR
;

184 
p
 = 
s
 = 
¬gv
[2];

185 
p
) {

186 
p
 = 
	`¡rchr
(
s
,',');

187 ià(
p
) *p = '\0';

188 ià(!
	`¡rÿ£cmp
(
s
,"myself")) {

189 
	`£rv”As£¹
(
£rv”
.
şu¡”
->
my£lf
 =ğ
NULL
);

190 
my£lf
 = 
£rv”
.
şu¡”
->my£làğ
n
;

191 
n
->
æags
 |ğ
CLUSTER_NODE_MYSELF
;

192 } ià(!
	`¡rÿ£cmp
(
s
,"master")) {

193 
n
->
æags
 |ğ
CLUSTER_NODE_MASTER
;

194 } ià(!
	`¡rÿ£cmp
(
s
,"slave")) {

195 
n
->
æags
 |ğ
CLUSTER_NODE_SLAVE
;

196 } ià(!
	`¡rÿ£cmp
(
s
,"fail?")) {

197 
n
->
æags
 |ğ
CLUSTER_NODE_PFAIL
;

198 } ià(!
	`¡rÿ£cmp
(
s
,"fail")) {

199 
n
->
æags
 |ğ
CLUSTER_NODE_FAIL
;

200 
n
->
ç_time
 = 
	`m¡ime
();

201 } ià(!
	`¡rÿ£cmp
(
s
,"handshake")) {

202 
n
->
æags
 |ğ
CLUSTER_NODE_HANDSHAKE
;

203 } ià(!
	`¡rÿ£cmp
(
s
,"noaddr")) {

204 
n
->
æags
 |ğ
CLUSTER_NODE_NOADDR
;

205 } ià(!
	`¡rÿ£cmp
(
s
,"noflags")) {

208 
	`£rv”Pªic
("Unknown flag in„edis cluster config file");

210 ià(
p
è
s
 =…+1;

215 ià(
¬gv
[3][0] != '-') {

216 
ma¡”
 = 
	`şu¡”LookupNode
(
¬gv
[3]);

217 ià(!
ma¡”
) {

218 
ma¡”
 = 
	`ü—‹Clu¡”Node
(
¬gv
[3],0);

219 
	`şu¡”AddNode
(
ma¡”
);

221 
n
->
¦aveof
 = 
ma¡”
;

222 
	`şu¡”NodeAddSÏve
(
ma¡”
,
n
);

226 ià(
	`©oi
(
¬gv
[4])è
n
->
pšg_£Á
 = 
	`m¡ime
();

227 ià(
	`©oi
(
¬gv
[5])è
n
->
pÚg_»ûived
 = 
	`m¡ime
();

230 
n
->
cÚfigEpoch
 = 
	`¡¹ouÎ
(
¬gv
[6],
NULL
,10);

233 
j
 = 8; j < 
¬gc
; j++) {

234 
¡¬t
, 
¡İ
;

236 ià(
¬gv
[
j
][0] == '[') {

238 
¦Ù
;

239 
dœeùiÚ
;

240 
şu¡”Node
 *
ú
;

242 
p
 = 
	`¡rchr
(
¬gv
[
j
],'-');

243 
	`£rv”As£¹
(
p
 !ğ
NULL
);

244 *
p
 = '\0';

245 
dœeùiÚ
 = 
p
[1];

246 
¦Ù
 = 
	`©oi
(
¬gv
[
j
]+1);

247 
p
 += 3;

248 
ú
 = 
	`şu¡”LookupNode
(
p
);

249 ià(!
ú
) {

250 
ú
 = 
	`ü—‹Clu¡”Node
(
p
,0);

251 
	`şu¡”AddNode
(
ú
);

253 ià(
dœeùiÚ
 == '>') {

254 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
ú
;

256 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
ú
;

259 } ià((
p
 = 
	`¡rchr
(
¬gv
[
j
],'-')è!ğ
NULL
) {

260 *
p
 = '\0';

261 
¡¬t
 = 
	`©oi
(
¬gv
[
j
]);

262 
¡İ
 = 
	`©oi
(
p
+1);

264 
¡¬t
 = 
¡İ
 = 
	`©oi
(
¬gv
[
j
]);

266 
¡¬t
 <ğ
¡İ
è
	`şu¡”AddSlÙ
(
n
, start++);

269 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

272 ià(
£rv”
.
şu¡”
->
my£lf
 =ğ
NULL
è
fm‹¼
;

274 
	`zä“
(
lše
);

275 
	`fşo£
(
å
);

277 
	`£rv”Log
(
LL_NOTICE
,"NodcÚfigu¿tiÚ†ßded, I'm %.40s", 
my£lf
->
Çme
);

282 ià(
	`şu¡”G‘MaxEpoch
(è> 
£rv”
.
şu¡”
->
cu¼’tEpoch
) {

283 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
	`şu¡”G‘MaxEpoch
();

285  
C_OK
;

287 
fm‹¼
:

288 
	`£rv”Log
(
LL_WARNING
,

290 
	`zä“
(
lše
);

291 ià(
å
è
	`fşo£
(fp);

292 
	`ex™
(1);

293 
	}
}

307 
	$şu¡”SaveCÚfig
(
do_fsync
) {

308 
sds
 
ci
;

309 
size_t
 
cÚ‹Á_size
;

310 
¡©
 
sb
;

311 
fd
;

313 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_SAVE_CONFIG
;

317 
ci
 = 
	`şu¡”G’NodesDesütiÚ
(
CLUSTER_NODE_HANDSHAKE
);

318 
ci
 = 
	`sdsÿrštf
(ci,"vars currentEpoch %llu†astVoteEpoch %llu\n",

319 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
,

320 (è
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
);

321 
cÚ‹Á_size
 = 
	`sd¦’
(
ci
);

323 ià((
fd
 = 
	`İ’
(
£rv”
.
şu¡”_cÚfigfe
,
O_WRONLY
|
O_CREAT
,0644))

324 =ğ-1è
”r
;

327 ià(
	`f¡©
(
fd
,&
sb
) != -1) {

328 ià(
sb
.
¡_size
 > (
off_t
)
cÚ‹Á_size
) {

329 
ci
 = 
	`sdsgrowz”o
(ci,
sb
.
¡_size
);

330 
	`mem£t
(
ci
+
cÚ‹Á_size
,'\n',
sb
.
¡_size
-content_size);

333 ià(
	`wr™e
(
fd
,
ci
,
	`sd¦’
(ci)è!ğ(
ssize_t
)sd¦’(ci)è
”r
;

334 ià(
do_fsync
) {

335 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_FSYNC_CONFIG
;

336 
	`fsync
(
fd
);

341 ià(
cÚ‹Á_size
 !ğ
	`sd¦’
(
ci
è&& 
	`árunÿ‹
(
fd
,content_size) == -1) {

344 
	`şo£
(
fd
);

345 
	`sdsä“
(
ci
);

348 
”r
:

349 ià(
fd
 !ğ-1è
	`şo£
(fd);

350 
	`sdsä“
(
ci
);

352 
	}
}

354 
	$şu¡”SaveCÚfigOrD›
(
do_fsync
) {

355 ià(
	`şu¡”SaveCÚfig
(
do_fsync
) == -1) {

356 
	`£rv”Log
(
LL_WARNING
,"Fatal: can't update cluster config file.");

357 
	`ex™
(1);

359 
	}
}

370 
	$şu¡”LockCÚfig
(*
f’ame
) {

375 #ià!
	`defšed
(
__sun
)

379 
fd
 = 
	`İ’
(
f’ame
,
O_WRONLY
|
O_CREAT
,0644);

380 ià(
fd
 == -1) {

381 
	`£rv”Log
(
LL_WARNING
,

383 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

384  
C_ERR
;

387 ià(
	`æock
(
fd
,
LOCK_EX
|
LOCK_NB
) == -1) {

388 ià(
”ºo
 =ğ
EWOULDBLOCK
) {

389 
	`£rv”Log
(
LL_WARNING
,

393 "fes.", 
f’ame
);

395 
	`£rv”Log
(
LL_WARNING
,

396 "ImpossibËØlock %s: %s", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

398 
	`şo£
(
fd
);

399  
C_ERR
;

405  
C_OK
;

406 
	}
}

408 
	$şu¡”In™
() {

409 
§vecÚf
 = 0;

411 
£rv”
.
şu¡”
 = 
	`zm®loc
((
şu¡”S‹
));

412 
£rv”
.
şu¡”
->
my£lf
 = 
NULL
;

413 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 0;

414 
£rv”
.
şu¡”
->
¡©e
 = 
CLUSTER_FAIL
;

415 
£rv”
.
şu¡”
->
size
 = 1;

416 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 = 0;

417 
£rv”
.
şu¡”
->
nodes
 = 
	`diùC»©e
(&
şu¡”NodesDiùTy³
,
NULL
);

418 
£rv”
.
şu¡”
->
nodes_bÏck_li¡
 =

419 
	`diùC»©e
(&
şu¡”NodesBÏckLi¡DiùTy³
,
NULL
);

420 
£rv”
.
şu¡”
->
çov”_auth_time
 = 0;

421 
£rv”
.
şu¡”
->
çov”_auth_couÁ
 = 0;

422 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 0;

423 
£rv”
.
şu¡”
->
çov”_auth_•och
 = 0;

424 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
CLUSTER_CANT_FAILOVER_NONE
;

425 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = 0;

426 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
 = 0;

427 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
 = 0;

428 
	`mem£t
(
£rv”
.
şu¡”
->
¦Ùs
,0, (server.cluster->slots));

429 
	`şu¡”Clo£AÎSlÙs
();

433 ià(
	`şu¡”LockCÚfig
(
£rv”
.
şu¡”_cÚfigfe
è=ğ
C_ERR
)

434 
	`ex™
(1);

437 ià(
	`şu¡”LßdCÚfig
(
£rv”
.
şu¡”_cÚfigfe
è=ğ
C_ERR
) {

440 
my£lf
 = 
£rv”
.
şu¡”
->myself =

441 
	`ü—‹Clu¡”Node
(
NULL
,
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_MASTER
);

442 
	`£rv”Log
(
LL_NOTICE
,"No cluster configuration found, I'm %.40s",

443 
my£lf
->
Çme
);

444 
	`şu¡”AddNode
(
my£lf
);

445 
§vecÚf
 = 1;

447 ià(
§vecÚf
è
	`şu¡”SaveCÚfigOrD›
(1);

450 
£rv”
.
cfd_couÁ
 = 0;

455 ià(
£rv”
.
pÜt
 > (65535-
CLUSTER_PORT_INCR
)) {

456 
	`£rv”Log
(
LL_WARNING
, "Redis…ort‚umberoo high. "

461 
	`ex™
(1);

464 ià(
	`li¡’ToPÜt
(
£rv”
.
pÜt
+
CLUSTER_PORT_INCR
,

465 
£rv”
.
cfd
,&£rv”.
cfd_couÁ
è=ğ
C_ERR
)

467 
	`ex™
(1);

469 
j
;

471 
j
 = 0; j < 
£rv”
.
cfd_couÁ
; j++) {

472 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
cfd
[
j
], 
AE_READABLE
,

473 
şu¡”Acû±HªdËr
, 
NULL
è=ğ
AE_ERR
)

474 
	`£rv”Pªic
("Unrecoverableƒrror creating Redis Cluster "

480 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`z¦C»©e
();

484 
my£lf
->
pÜt
 = 
£rv”
.port;

485 
my£lf
->
ıÜt
 = 
£rv”
.
pÜt
+
CLUSTER_PORT_INCR
;

486 ià(
£rv”
.
şu¡”_ªnounû_pÜt
)

487 
my£lf
->
pÜt
 = 
£rv”
.
şu¡”_ªnounû_pÜt
;

488 ià(
£rv”
.
şu¡”_ªnounû_bus_pÜt
)

489 
my£lf
->
ıÜt
 = 
£rv”
.
şu¡”_ªnounû_bus_pÜt
;

491 
£rv”
.
şu¡”
->
mf_’d
 = 0;

492 
	`»£tMªu®Faov”
();

493 
	}
}

504 
	$şu¡”Re£t
(
h¬d
) {

505 
diùI‹¿tÜ
 *
di
;

506 
diùEÁry
 *
de
;

507 
j
;

510 ià(
	`nodeIsSÏve
(
my£lf
)) {

511 
	`şu¡”S‘NodeAsMa¡”
(
my£lf
);

512 
	`»¶iÿtiÚUn£tMa¡”
();

513 
	`em±yDb
(-1,
EMPTYDB_NO_FLAGS
,
NULL
);

517 
	`şu¡”Clo£AÎSlÙs
();

518 
	`»£tMªu®Faov”
();

521 
j
 = 0; j < 
CLUSTER_SLOTS
; j++è
	`şu¡”D–SlÙ
(j);

524 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

525 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

526 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

528 ià(
node
 =ğ
my£lf
) ;

529 
	`şu¡”D–Node
(
node
);

531 
	`diùR–—£I‹¿tÜ
(
di
);

534 ià(
h¬d
) {

535 
sds
 
ŞdÇme
;

537 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 0;

538 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = 0;

539 
my£lf
->
cÚfigEpoch
 = 0;

540 
	`£rv”Log
(
LL_WARNING
, "configEpoch seto 0 via CLUSTER RESET HARD");

544 
ŞdÇme
 = 
	`sd¢ewËn
(
my£lf
->
Çme
, 
CLUSTER_NAMELEN
);

545 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
,
ŞdÇme
);

546 
	`sdsä“
(
ŞdÇme
);

547 
	`g‘RªdomHexCh¬s
(
my£lf
->
Çme
, 
CLUSTER_NAMELEN
);

548 
	`şu¡”AddNode
(
my£lf
);

549 
	`£rv”Log
(
LL_NOTICE
,"Nodh¬d„e£t,‚ow I'm %.40s", 
my£lf
->
Çme
);

553 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

554 
CLUSTER_TODO_UPDATE_STATE
|

555 
CLUSTER_TODO_FSYNC_CONFIG
);

556 
	}
}

562 
şu¡”Lšk
 *
	$ü—‹Clu¡”Lšk
(
şu¡”Node
 *
node
) {

563 
şu¡”Lšk
 *
lšk
 = 
	`zm®loc
((*link));

564 
lšk
->
ùime
 = 
	`m¡ime
();

565 
lšk
->
¢dbuf
 = 
	`sd£m±y
();

566 
lšk
->
rcvbuf
 = 
	`sd£m±y
();

567 
lšk
->
node
 =‚ode;

568 
lšk
->
fd
 = -1;

569  
lšk
;

570 
	}
}

575 
	$ä“Clu¡”Lšk
(
şu¡”Lšk
 *
lšk
) {

576 ià(
lšk
->
fd
 != -1) {

577 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_WRITABLE
);

578 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_READABLE
);

580 
	`sdsä“
(
lšk
->
¢dbuf
);

581 
	`sdsä“
(
lšk
->
rcvbuf
);

582 ià(
lšk
->
node
)

583 
lšk
->
node
->lšk = 
NULL
;

584 
	`şo£
(
lšk
->
fd
);

585 
	`zä“
(
lšk
);

586 
	}
}

588 
	#MAX_CLUSTER_ACCEPTS_PER_CALL
 1000

	)

589 
	$şu¡”Acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

590 
ıÜt
, 
cfd
;

591 
max
 = 
MAX_CLUSTER_ACCEPTS_PER_CALL
;

592 
c
[
NET_IP_STR_LEN
];

593 
şu¡”Lšk
 *
lšk
;

594 
	`UNUSED
(
–
);

595 
	`UNUSED
(
mask
);

596 
	`UNUSED
(
´ivd©a
);

600 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && s”v”.
lßdšg
) ;

602 
max
--) {

603 
cfd
 = 
	`ª‘TıAcû±
(
£rv”
.
Ã‹¼
, 
fd
, 
c
, (c), &
ıÜt
);

604 ià(
cfd
 =ğ
ANET_ERR
) {

605 ià(
”ºo
 !ğ
EWOULDBLOCK
)

606 
	`£rv”Log
(
LL_VERBOSE
,

607 "E¼Ü‡cû±šg clu¡”‚ode: %s", 
£rv”
.
Ã‹¼
);

610 
	`ª‘NÚBlock
(
NULL
,
cfd
);

611 
	`ª‘EÇbËTıNoD–ay
(
NULL
,
cfd
);

614 
	`£rv”Log
(
LL_VERBOSE
,"Acû±ed clu¡”‚od%s:%d", 
c
, 
ıÜt
);

620 
lšk
 = 
	`ü—‹Clu¡”Lšk
(
NULL
);

621 
lšk
->
fd
 = 
cfd
;

622 
	`«C»©eFeEv’t
(
£rv”
.
–
,
cfd
,
AE_READABLE
,
şu¡”R—dHªdËr
,
lšk
);

624 
	}
}

636 
	$keyHashSlÙ
(*
key
, 
keyËn
) {

637 
s
, 
e
;

639 
s
 = 0; s < 
keyËn
; s++)

640 ià(
key
[
s
] == '{') ;

643 ià(
s
 =ğ
keyËn
è 
	`üc16
(
key
,keylen) & 0x3FFF;

646 
e
 = 
s
+1;ƒ < 
keyËn
;ƒ++)

647 ià(
key
[
e
] == '}') ;

650 ià(
e
 =ğ
keyËn
 ||ƒ =ğ
s
+1è 
	`üc16
(
key
,keylen) & 0x3FFF;

654  
	`üc16
(
key
+
s
+1,
e
-s-1) & 0x3FFF;

655 
	}
}

668 
şu¡”Node
 *
	$ü—‹Clu¡”Node
(*
nod’ame
, 
æags
) {

669 
şu¡”Node
 *
node
 = 
	`zm®loc
((*node));

671 ià(
nod’ame
)

672 
	`memıy
(
node
->
Çme
, 
nod’ame
, 
CLUSTER_NAMELEN
);

674 
	`g‘RªdomHexCh¬s
(
node
->
Çme
, 
CLUSTER_NAMELEN
);

675 
node
->
ùime
 = 
	`m¡ime
();

676 
node
->
cÚfigEpoch
 = 0;

677 
node
->
æags
 = flags;

678 
	`mem£t
(
node
->
¦Ùs
,0,(node->slots));

679 
node
->
num¦Ùs
 = 0;

680 
node
->
num¦aves
 = 0;

681 
node
->
¦aves
 = 
NULL
;

682 
node
->
¦aveof
 = 
NULL
;

683 
node
->
pšg_£Á
 =‚ode->
pÚg_»ûived
 = 0;

684 
node
->
ç_time
 = 0;

685 
node
->
lšk
 = 
NULL
;

686 
	`mem£t
(
node
->

,0,(node->ip));

687 
node
->
pÜt
 = 0;

688 
node
->
ıÜt
 = 0;

689 
node
->
ç_»pÜts
 = 
	`li¡C»©e
();

690 
node
->
vÙed_time
 = 0;

691 
node
->
Üphªed_time
 = 0;

692 
node
->
»¶_off£t_time
 = 0;

693 
node
->
»¶_off£t
 = 0;

694 
	`li¡S‘F»eM‘hod
(
node
->
ç_»pÜts
,
zä“
);

695  
node
;

696 
	}
}

708 
	$şu¡”NodeAddFau»R•Üt
(
şu¡”Node
 *
çšg
, clu¡”Nod*
£nd”
) {

709 
li¡
 *
l
 = 
çšg
->
ç_»pÜts
;

710 
li¡Node
 *
Ê
;

711 
li¡I‹r
 
li
;

712 
şu¡”NodeFaR•Üt
 *
ä
;

716 
	`li¡Rewšd
(
l
,&
li
);

717 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

718 
ä
 = 
Ê
->
v®ue
;

719 ià(
ä
->
node
 =ğ
£nd”
) {

720 
ä
->
time
 = 
	`m¡ime
();

726 
ä
 = 
	`zm®loc
((*fr));

727 
ä
->
node
 = 
£nd”
;

728 
ä
->
time
 = 
	`m¡ime
();

729 
	`li¡AddNodeTa
(
l
,
ä
);

731 
	}
}

738 
	$şu¡”NodeCËªupFau»R•Üts
(
şu¡”Node
 *
node
) {

739 
li¡
 *
l
 = 
node
->
ç_»pÜts
;

740 
li¡Node
 *
Ê
;

741 
li¡I‹r
 
li
;

742 
şu¡”NodeFaR•Üt
 *
ä
;

743 
m¡ime_t
 
maxtime
 = 
£rv”
.
şu¡”_node_timeout
 *

744 
CLUSTER_FAIL_REPORT_VALIDITY_MULT
;

745 
m¡ime_t
 
now
 = 
	`m¡ime
();

747 
	`li¡Rewšd
(
l
,&
li
);

748 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

749 
ä
 = 
Ê
->
v®ue
;

750 ià(
now
 - 
ä
->
time
 > 
maxtime
è
	`li¡D–Node
(
l
,
Ê
);

752 
	}
}

765 
	$şu¡”NodeD–Fau»R•Üt
(
şu¡”Node
 *
node
, clu¡”Nod*
£nd”
) {

766 
li¡
 *
l
 = 
node
->
ç_»pÜts
;

767 
li¡Node
 *
Ê
;

768 
li¡I‹r
 
li
;

769 
şu¡”NodeFaR•Üt
 *
ä
;

772 
	`li¡Rewšd
(
l
,&
li
);

773 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

774 
ä
 = 
Ê
->
v®ue
;

775 ià(
ä
->
node
 =ğ
£nd”
) ;

777 ià(!
Ê
)  0;

780 
	`li¡D–Node
(
l
,
Ê
);

781 
	`şu¡”NodeCËªupFau»R•Üts
(
node
);

783 
	}
}

788 
	$şu¡”NodeFau»R•ÜtsCouÁ
(
şu¡”Node
 *
node
) {

789 
	`şu¡”NodeCËªupFau»R•Üts
(
node
);

790  
	`li¡L’gth
(
node
->
ç_»pÜts
);

791 
	}
}

793 
	$şu¡”NodeRemoveSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
) {

794 
j
;

796 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++) {

797 ià(
ma¡”
->
¦aves
[
j
] =ğ
¦ave
) {

798 ià((
j
+1è< 
ma¡”
->
num¦aves
) {

799 
»maššg_¦aves
 = (
ma¡”
->
num¦aves
 - 
j
) - 1;

800 
	`memmove
(
ma¡”
->
¦aves
+
j
,master->slaves+(j+1),

801 ((*
ma¡”
->
¦aves
è* 
»maššg_¦aves
));

803 
ma¡”
->
num¦aves
--;

804 ià(
ma¡”
->
num¦aves
 == 0)

805 
ma¡”
->
æags
 &ğ~
CLUSTER_NODE_MIGRATE_TO
;

806  
C_OK
;

809  
C_ERR
;

810 
	}
}

812 
	$şu¡”NodeAddSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
) {

813 
j
;

816 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++)

817 ià(
ma¡”
->
¦aves
[
j
] =ğ
¦ave
è 
C_ERR
;

818 
ma¡”
->
¦aves
 = 
	`z»®loc
(master->slaves,

819 (
şu¡”Node
*)*(
ma¡”
->
num¦aves
+1));

820 
ma¡”
->
¦aves
[ma¡”->
num¦aves
] = 
¦ave
;

821 
ma¡”
->
num¦aves
++;

822 
ma¡”
->
æags
 |ğ
CLUSTER_NODE_MIGRATE_TO
;

823  
C_OK
;

824 
	}
}

826 
	$şu¡”CouÁNÚFašgSÏves
(
şu¡”Node
 *
n
) {

827 
j
, 
ok¦aves
 = 0;

829 
j
 = 0; j < 
n
->
num¦aves
; j++)

830 ià(!
	`nodeFaed
(
n
->
¦aves
[
j
])è
ok¦aves
++;

831  
ok¦aves
;

832 
	}
}

835 
	$ä“Clu¡”Node
(
şu¡”Node
 *
n
) {

836 
sds
 
nod’ame
;

837 
j
;

841 
j
 = 0; j < 
n
->
num¦aves
; j++)

842 
n
->
¦aves
[
j
]->
¦aveof
 = 
NULL
;

845 ià(
	`nodeIsSÏve
(
n
è&&‚->
¦aveof
è
	`şu¡”NodeRemoveSÏve
(n->slaveof,n);

848 
nod’ame
 = 
	`sd¢ewËn
(
n
->
Çme
, 
CLUSTER_NAMELEN
);

849 
	`£rv”As£¹
(
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
,
nod’ame
è=ğ
DICT_OK
);

850 
	`sdsä“
(
nod’ame
);

853 ià(
n
->
lšk
è
	`ä“Clu¡”Lšk
(n->link);

854 
	`li¡R–—£
(
n
->
ç_»pÜts
);

855 
	`zä“
(
n
->
¦aves
);

856 
	`zä“
(
n
);

857 
	}
}

860 
	$şu¡”AddNode
(
şu¡”Node
 *
node
) {

861 
»tv®
;

863 
»tv®
 = 
	`diùAdd
(
£rv”
.
şu¡”
->
nodes
,

864 
	`sd¢ewËn
(
node
->
Çme
,
CLUSTER_NAMELEN
),‚ode);

865  (
»tv®
 =ğ
DICT_OK
è? 
C_OK
 : 
C_ERR
;

866 
	}
}

879 
	$şu¡”D–Node
(
şu¡”Node
 *
d–node
) {

880 
j
;

881 
diùI‹¿tÜ
 *
di
;

882 
diùEÁry
 *
de
;

885 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

886 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] =ğ
d–node
)

887 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = 
NULL
;

888 ià(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
] =ğ
d–node
)

889 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
] = 
NULL
;

890 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
d–node
)

891 
	`şu¡”D–SlÙ
(
j
);

895 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

896 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

897 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

899 ià(
node
 =ğ
d–node
) ;

900 
	`şu¡”NodeD–Fau»R•Üt
(
node
,
d–node
);

902 
	`diùR–—£I‹¿tÜ
(
di
);

905 
	`ä“Clu¡”Node
(
d–node
);

906 
	}
}

909 
şu¡”Node
 *
	$şu¡”LookupNode
(*
Çme
) {

910 
sds
 
s
 = 
	`sd¢ewËn
(
Çme
, 
CLUSTER_NAMELEN
);

911 
diùEÁry
 *
de
;

913 
de
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes
,
s
);

914 
	`sdsä“
(
s
);

915 ià(
de
 =ğ
NULL
)  NULL;

916  
	`diùG‘V®
(
de
);

917 
	}
}

923 
	$şu¡”R’ameNode
(
şu¡”Node
 *
node
, *
ÃwÇme
) {

924 
»tv®
;

925 
sds
 
s
 = 
	`sd¢ewËn
(
node
->
Çme
, 
CLUSTER_NAMELEN
);

927 
	`£rv”Log
(
LL_DEBUG
,"Renaming‚ode %.40s into %.40s",

928 
node
->
Çme
, 
ÃwÇme
);

929 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
, 
s
);

930 
	`sdsä“
(
s
);

931 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

932 
	`memıy
(
node
->
Çme
, 
ÃwÇme
, 
CLUSTER_NAMELEN
);

933 
	`şu¡”AddNode
(
node
);

934 
	}
}

942 
ušt64_t
 
	$şu¡”G‘MaxEpoch
() {

943 
ušt64_t
 
max
 = 0;

944 
diùI‹¿tÜ
 *
di
;

945 
diùEÁry
 *
de
;

947 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

948 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

949 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

950 ià(
node
->
cÚfigEpoch
 > 
max
) max =‚ode->configEpoch;

952 
	`diùR–—£I‹¿tÜ
(
di
);

953 ià(
max
 < 
£rv”
.
şu¡”
->
cu¼’tEpoch
) max = server.cluster->currentEpoch;

954  
max
;

955 
	}
}

986 
	$şu¡”BumpCÚfigEpochW™houtCÚ£nsus
() {

987 
ušt64_t
 
maxEpoch
 = 
	`şu¡”G‘MaxEpoch
();

989 ià(
my£lf
->
cÚfigEpoch
 == 0 ||

990 
my£lf
->
cÚfigEpoch
 !ğ
maxEpoch
)

992 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

993 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
cu¼’tEpoch
;

994 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

995 
CLUSTER_TODO_FSYNC_CONFIG
);

996 
	`£rv”Log
(
LL_WARNING
,

998 (è
my£lf
->
cÚfigEpoch
);

999  
C_OK
;

1001  
C_ERR
;

1003 
	}
}

1051 
	$şu¡”HªdËCÚfigEpochCŞlisiÚ
(
şu¡”Node
 *
£nd”
) {

1053 ià(
£nd”
->
cÚfigEpoch
 !ğ
my£lf
->configEpoch ||

1054 !
	`nodeIsMa¡”
(
£nd”
è|| !nodeIsMa¡”(
my£lf
)) ;

1056 ià(
	`memcmp
(
£nd”
->
Çme
,
my£lf
->Çme,
CLUSTER_NAMELEN
) <= 0) ;

1058 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

1059 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
cu¼’tEpoch
;

1060 
	`şu¡”SaveCÚfigOrD›
(1);

1061 
	`£rv”Log
(
LL_VERBOSE
,

1064 
£nd”
->
Çme
,

1065 (è
my£lf
->
cÚfigEpoch
);

1066 
	}
}

1090 
	#CLUSTER_BLACKLIST_TTL
 60

	)

1099 
	$şu¡”BÏckli¡CËªup
() {

1100 
diùI‹¿tÜ
 *
di
;

1101 
diùEÁry
 *
de
;

1103 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
);

1104 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1105 
št64_t
 
expœe
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

1107 ià(
expœe
 < 
£rv”
.
unixtime
)

1108 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
	`diùG‘Key
(
de
));

1110 
	`diùR–—£I‹¿tÜ
(
di
);

1111 
	}
}

1114 
	$şu¡”BÏckli¡AddNode
(
şu¡”Node
 *
node
) {

1115 
diùEÁry
 *
de
;

1116 
sds
 
id
 = 
	`sd¢ewËn
(
node
->
Çme
,
CLUSTER_NAMELEN
);

1118 
	`şu¡”BÏckli¡CËªup
();

1119 ià(
	`diùAdd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
,
NULL
è=ğ
DICT_OK
) {

1122 
id
 = 
	`sdsdup
(id);

1124 
de
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
);

1125 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,
	`time
(
NULL
)+
CLUSTER_BLACKLIST_TTL
);

1126 
	`sdsä“
(
id
);

1127 
	}
}

1132 
	$şu¡”BÏckli¡Exi¡s
(*
nodeid
) {

1133 
sds
 
id
 = 
	`sd¢ewËn
(
nodeid
,
CLUSTER_NAMELEN
);

1134 
»tv®
;

1136 
	`şu¡”BÏckli¡CËªup
();

1137 
»tv®
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
è!ğ
NULL
;

1138 
	`sdsä“
(
id
);

1139  
»tv®
;

1140 
	}
}

1167 
	$m¬kNodeAsFašgIfN“ded
(
şu¡”Node
 *
node
) {

1168 
çu»s
;

1169 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

1171 ià(!
	`nodeTimedOut
(
node
)) ;

1172 ià(
	`nodeFaed
(
node
)) ;

1174 
çu»s
 = 
	`şu¡”NodeFau»R•ÜtsCouÁ
(
node
);

1176 ià(
	`nodeIsMa¡”
(
my£lf
)è
çu»s
++;

1177 ià(
çu»s
 < 
Ãeded_quÜum
) ;

1179 
	`£rv”Log
(
LL_NOTICE
,

1180 "M¬kšg‚od%.40 a çšg (quÜum„—ched).", 
node
->
Çme
);

1183 
node
->
æags
 &ğ~
CLUSTER_NODE_PFAIL
;

1184 
node
->
æags
 |ğ
CLUSTER_NODE_FAIL
;

1185 
node
->
ç_time
 = 
	`m¡ime
();

1189 ià(
	`nodeIsMa¡”
(
my£lf
)è
	`şu¡”S’dFa
(
node
->
Çme
);

1190 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1191 
	}
}

1196 
	$ş—rNodeFau»IfN“ded
(
şu¡”Node
 *
node
) {

1197 
m¡ime_t
 
now
 = 
	`m¡ime
();

1199 
	`£rv”As£¹
(
	`nodeFaed
(
node
));

1203 ià(
	`nodeIsSÏve
(
node
è||‚ode->
num¦Ùs
 == 0) {

1204 
	`£rv”Log
(
LL_NOTICE
,

1206 
node
->
Çme
,

1207 
	`nodeIsSÏve
(
node
) ? "slave" : "master without slots");

1208 
node
->
æags
 &ğ~
CLUSTER_NODE_FAIL
;

1209 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1216 ià(
	`nodeIsMa¡”
(
node
è&&‚ode->
num¦Ùs
 > 0 &&

1217 (
now
 - 
node
->
ç_time
) >

1218 (
£rv”
.
şu¡”_node_timeout
 * 
CLUSTER_FAIL_UNDO_TIME_MULT
))

1220 
	`£rv”Log
(
LL_NOTICE
,

1222 
node
->
Çme
);

1223 
node
->
æags
 &ğ~
CLUSTER_NODE_FAIL
;

1224 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1226 
	}
}

1231 
	$şu¡”HªdshakeInProg»ss
(*

, 
pÜt
, 
ıÜt
) {

1232 
diùI‹¿tÜ
 *
di
;

1233 
diùEÁry
 *
de
;

1235 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

1236 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1237 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

1239 ià(!
	`nodeInHªdshake
(
node
)) ;

1240 ià(!
	`¡rÿ£cmp
(
node
->

,ip) &&

1241 
node
->
pÜt
 ==…ort &&

1242 
node
->
ıÜt
 == cport) ;

1244 
	`diùR–—£I‹¿tÜ
(
di
);

1245  
de
 !ğ
NULL
;

1246 
	}
}

1255 
	$şu¡”S¹Hªdshake
(*

, 
pÜt
, 
ıÜt
) {

1256 
şu¡”Node
 *
n
;

1257 
nÜm_
[
NET_IP_STR_LEN
];

1258 
sockaddr_¡Üage
 
§
;

1261 ià(
	`š‘_±Ú
(
AF_INET
,

,

1262 &(((
sockaddr_š
 *)&
§
)->
sš_addr
)))

1264 
§
.
ss_çmy
 = 
AF_INET
;

1265 } ià(
	`š‘_±Ú
(
AF_INET6
,

,

1266 &(((
sockaddr_š6
 *)&
§
)->
sš6_addr
)))

1268 
§
.
ss_çmy
 = 
AF_INET6
;

1270 
”ºo
 = 
EINVAL
;

1275 ià(
pÜt
 <ğ0 ||…Üˆ> 65535 || 
ıÜt
 <= 0 || cport > 65535) {

1276 
”ºo
 = 
EINVAL
;

1282 
	`mem£t
(
nÜm_
,0,
NET_IP_STR_LEN
);

1283 ià(
§
.
ss_çmy
 =ğ
AF_INET
)

1284 
	`š‘_Áİ
(
AF_INET
,

1285 (*)&(((
sockaddr_š
 *)&
§
)->
sš_addr
),

1286 
nÜm_
,
NET_IP_STR_LEN
);

1288 
	`š‘_Áİ
(
AF_INET6
,

1289 (*)&(((
sockaddr_š6
 *)&
§
)->
sš6_addr
),

1290 
nÜm_
,
NET_IP_STR_LEN
);

1292 ià(
	`şu¡”HªdshakeInProg»ss
(
nÜm_
,
pÜt
,
ıÜt
)) {

1293 
”ºo
 = 
EAGAIN
;

1300 
n
 = 
	`ü—‹Clu¡”Node
(
NULL
,
CLUSTER_NODE_HANDSHAKE
|
CLUSTER_NODE_MEET
);

1301 
	`memıy
(
n
->

,
nÜm_
,(n->ip));

1302 
n
->
pÜt
 =…ort;

1303 
n
->
ıÜt
 = cport;

1304 
	`şu¡”AddNode
(
n
);

1306 
	}
}

1312 
	$şu¡”ProûssGossSeùiÚ
(
şu¡”Msg
 *
hdr
, 
şu¡”Lšk
 *
lšk
) {

1313 
ušt16_t
 
couÁ
 = 
	`Áohs
(
hdr
->count);

1314 
şu¡”MsgD©aGoss
 *
g
 = (şu¡”MsgD©aGoss*è
hdr
->
d©a
.
pšg
.
goss
;

1315 
şu¡”Node
 *
£nd”
 = 
lšk
->
node
 ?†šk->nod: 
	`şu¡”LookupNode
(
hdr
->sender);

1317 
couÁ
--) {

1318 
ušt16_t
 
æags
 = 
	`Áohs
(
g
->flags);

1319 
şu¡”Node
 *
node
;

1320 
sds
 
ci
;

1322 
ci
 = 
	`»´e£ÁClu¡”NodeFÏgs
(
	`sd£m±y
(), 
æags
);

1323 
	`£rv”Log
(
LL_DEBUG
,"GOSSIP %.40s %s:%d@%d %s",

1324 
g
->
nod’ame
,

1325 
g
->

,

1326 
	`Áohs
(
g
->
pÜt
),

1327 
	`Áohs
(
g
->
ıÜt
),

1328 
ci
);

1329 
	`sdsä“
(
ci
);

1332 
node
 = 
	`şu¡”LookupNode
(
g
->
nod’ame
);

1333 ià(
node
) {

1336 ià(
£nd”
 && 
	`nodeIsMa¡”
(£nd”è&& 
node
 !ğ
my£lf
) {

1337 ià(
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) {

1338 ià(
	`şu¡”NodeAddFau»R•Üt
(
node
,
£nd”
)) {

1339 
	`£rv”Log
(
LL_VERBOSE
,

1341 
£nd”
->
Çme
, 
node
->name);

1343 
	`m¬kNodeAsFašgIfN“ded
(
node
);

1345 ià(
	`şu¡”NodeD–Fau»R•Üt
(
node
,
£nd”
)) {

1346 
	`£rv”Log
(
LL_VERBOSE
,

1348 
£nd”
->
Çme
, 
node
->name);

1358 ià(
node
->
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
) &&

1359 !(
æags
 & 
CLUSTER_NODE_NOADDR
) &&

1360 !(
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) &&

1361 (
	`¡rÿ£cmp
(
node
->

,
g
->ip) ||

1362 
node
->
pÜt
 !ğ
	`Áohs
(
g
->port) ||

1363 
node
->
ıÜt
 !ğ
	`Áohs
(
g
->cport)))

1365 ià(
node
->
lšk
è
	`ä“Clu¡”Lšk
(node->link);

1366 
	`memıy
(
node
->

,
g
->,
NET_IP_STR_LEN
);

1367 
node
->
pÜt
 = 
	`Áohs
(
g
->port);

1368 
node
->
ıÜt
 = 
	`Áohs
(
g
->cport);

1369 
node
->
æags
 &ğ~
CLUSTER_NODE_NOADDR
;

1378 ià(
£nd”
 &&

1379 !(
æags
 & 
CLUSTER_NODE_NOADDR
) &&

1380 !
	`şu¡”BÏckli¡Exi¡s
(
g
->
nod’ame
))

1382 
	`şu¡”S¹Hªdshake
(
g
->

,
	`Áohs
(g->
pÜt
),Áohs(g->
ıÜt
));

1387 
g
++;

1389 
	}
}

1394 
	$nodeIp2SŒšg
(*
buf
, 
şu¡”Lšk
 *
lšk
, *
ªnounûd_
) {

1395 ià(
ªnounûd_
[0] != '\0') {

1396 
	`memıy
(
buf
,
ªnounûd_
,
NET_IP_STR_LEN
);

1397 
buf
[
NET_IP_STR_LEN
-1] = '\0';

1399 
	`ª‘P“rToSŒšg
(
lšk
->
fd
, 
buf
, 
NET_IP_STR_LEN
, 
NULL
);

1401 
	}
}

1415 
	$nodeUpd©eAdd»ssIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Lšk
 *
lšk
,

1416 
şu¡”Msg
 *
hdr
)

1418 

[
NET_IP_STR_LEN
] = {0};

1419 
pÜt
 = 
	`Áohs
(
hdr
->port);

1420 
ıÜt
 = 
	`Áohs
(
hdr
->cport);

1428 ià(
lšk
 =ğ
node
->link)  0;

1430 
	`nodeIp2SŒšg
(

,
lšk
,
hdr
->
my
);

1431 ià(
node
->
pÜt
 =ğpÜˆ&&‚ode->
ıÜt
 == cport &&

1432 
	`¡rcmp
(

,
node
->ip) == 0)  0;

1435 
	`memıy
(
node
->

,ip,(ip));

1436 
node
->
pÜt
 =…ort;

1437 
node
->
ıÜt
 = cport;

1438 ià(
node
->
lšk
è
	`ä“Clu¡”Lšk
(node->link);

1439 
node
->
æags
 &ğ~
CLUSTER_NODE_NOADDR
;

1440 
	`£rv”Log
(
LL_WARNING
,"Address updated for‚ode %.40s,‚ow %s:%d",

1441 
node
->
Çme
,‚ode->

,‚ode->
pÜt
);

1445 ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
node
)

1446 
	`»¶iÿtiÚS‘Ma¡”
(
node
->

,‚ode->
pÜt
);

1448 
	}
}

1453 
	$şu¡”S‘NodeAsMa¡”
(
şu¡”Node
 *
n
) {

1454 ià(
	`nodeIsMa¡”
(
n
)) ;

1456 ià(
n
->
¦aveof
) {

1457 
	`şu¡”NodeRemoveSÏve
(
n
->
¦aveof
,n);

1458 ià(
n
 !ğ
my£lf
èn->
æags
 |ğ
CLUSTER_NODE_MIGRATE_TO
;

1460 
n
->
æags
 &ğ~
CLUSTER_NODE_SLAVE
;

1461 
n
->
æags
 |ğ
CLUSTER_NODE_MASTER
;

1462 
n
->
¦aveof
 = 
NULL
;

1465 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1466 
CLUSTER_TODO_UPDATE_STATE
);

1467 
	}
}

1480 
	$şu¡”Upd©eSlÙsCÚfigW™h
(
şu¡”Node
 *
£nd”
, 
ušt64_t
 
£nd”CÚfigEpoch
, *
¦Ùs
) {

1481 
j
;

1482 
şu¡”Node
 *
curma¡”
, *
Ãwma¡”
 = 
NULL
;

1490 
ušt16_t
 
dœty_¦Ùs
[
CLUSTER_SLOTS
];

1491 
dœty_¦Ùs_couÁ
 = 0;

1496 
curma¡”
 = 
	`nodeIsMa¡”
(
my£lf
è? my£là: my£lf->
¦aveof
;

1498 ià(
£nd”
 =ğ
my£lf
) {

1499 
	`£rv”Log
(
LL_WARNING
,"Discarding UPDATE message‡bout myself.");

1503 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

1504 ià(
	`b™m­Te¡B™
(
¦Ùs
,
j
)) {

1506 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
£nd”
) ;

1512 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]) ;

1518 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

1519 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 < 
£nd”CÚfigEpoch
)

1523 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
my£lf
 &&

1524 
	`couÁKeysInSlÙ
(
j
) &&

1525 
£nd”
 !ğ
my£lf
)

1527 
dœty_¦Ùs
[
dœty_¦Ùs_couÁ
] = 
j
;

1528 
dœty_¦Ùs_couÁ
++;

1531 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
curma¡”
)

1532 
Ãwma¡”
 = 
£nd”
;

1533 
	`şu¡”D–SlÙ
(
j
);

1534 
	`şu¡”AddSlÙ
(
£nd”
,
j
);

1535 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1536 
CLUSTER_TODO_UPDATE_STATE
|

1537 
CLUSTER_TODO_FSYNC_CONFIG
);

1549 ià(
Ãwma¡”
 && 
curma¡”
->
num¦Ùs
 == 0) {

1550 
	`£rv”Log
(
LL_WARNING
,

1552 "a ¨»¶iÿ oà%.40s", 
£nd”
->
Çme
);

1553 
	`şu¡”S‘Ma¡”
(
£nd”
);

1554 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1555 
CLUSTER_TODO_UPDATE_STATE
|

1556 
CLUSTER_TODO_FSYNC_CONFIG
);

1557 } ià(
dœty_¦Ùs_couÁ
) {

1565 
j
 = 0; j < 
dœty_¦Ùs_couÁ
; j++)

1566 
	`d–KeysInSlÙ
(
dœty_¦Ùs
[
j
]);

1568 
	}
}

1579 
	$şu¡”ProûssPack‘
(
şu¡”Lšk
 *
lšk
) {

1580 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
lšk
->
rcvbuf
;

1581 
ušt32_t
 
tÙËn
 = 
	`Áohl
(
hdr
->totlen);

1582 
ušt16_t
 
ty³
 = 
	`Áohs
(
hdr
->type);

1584 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
++;

1585 
	`£rv”Log
(
LL_DEBUG
,"--- Processing…acket ofype %d, %lu bytes",

1586 
ty³
, (è
tÙËn
);

1589 ià(
tÙËn
 < 16)  1;

1590 ià(
tÙËn
 > 
	`sd¦’
(
lšk
->
rcvbuf
))  1;

1592 ià(
	`Áohs
(
hdr
->
v”
è!ğ
CLUSTER_PROTO_VER
) {

1597 
ušt16_t
 
æags
 = 
	`Áohs
(
hdr
->flags);

1598 
ušt64_t
 
£nd”Cu¼’tEpoch
 = 0, 
£nd”CÚfigEpoch
 = 0;

1599 
şu¡”Node
 *
£nd”
;

1601 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_PONG
 ||

1602 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1604 
ušt16_t
 
couÁ
 = 
	`Áohs
(
hdr
->count);

1605 
ušt32_t
 
ex¶’
;

1607 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1608 
ex¶’
 +ğ((
şu¡”MsgD©aGoss
)*
couÁ
);

1609 ià(
tÙËn
 !ğ
ex¶’
)  1;

1610 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

1611 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1613 
ex¶’
 +ğ(
şu¡”MsgD©aFa
);

1614 ià(
tÙËn
 !ğ
ex¶’
)  1;

1615 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PUBLISH
) {

1616 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1618 
ex¶’
 +ğ(
şu¡”MsgD©aPublish
) -

1620 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.
chªÃl_Ën
) +

1621 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.
mes§ge_Ën
);

1622 ià(
tÙËn
 !ğ
ex¶’
)  1;

1623 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
 ||

1624 
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
 ||

1625 
ty³
 =ğ
CLUSTERMSG_TYPE_MFSTART
)

1627 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1629 ià(
tÙËn
 !ğ
ex¶’
)  1;

1630 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

1631 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1633 
ex¶’
 +ğ(
şu¡”MsgD©aUpd©e
);

1634 ià(
tÙËn
 !ğ
ex¶’
)  1;

1638 
£nd”
 = 
	`şu¡”LookupNode
(
hdr
->sender);

1639 ià(
£nd”
 && !
	`nodeInHªdshake
(sender)) {

1641 
£nd”Cu¼’tEpoch
 = 
	`Áohu64
(
hdr
->
cu¼’tEpoch
);

1642 
£nd”CÚfigEpoch
 = 
	`Áohu64
(
hdr
->
cÚfigEpoch
);

1643 ià(
£nd”Cu¼’tEpoch
 > 
£rv”
.
şu¡”
->
cu¼’tEpoch
)

1644 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
£nd”Cu¼’tEpoch
;

1646 ià(
£nd”CÚfigEpoch
 > 
£nd”
->
cÚfigEpoch
) {

1647 
£nd”
->
cÚfigEpoch
 = 
£nd”CÚfigEpoch
;

1648 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1649 
CLUSTER_TODO_FSYNC_CONFIG
);

1652 
£nd”
->
»¶_off£t
 = 
	`Áohu64
(
hdr
->
off£t
);

1653 
£nd”
->
»¶_off£t_time
 = 
	`m¡ime
();

1656 ià(
£rv”
.
şu¡”
->
mf_’d
 &&

1657 
	`nodeIsSÏve
(
my£lf
) &&

1658 
my£lf
->
¦aveof
 =ğ
£nd”
 &&

1659 
hdr
->
mæags
[0] & 
CLUSTERMSG_FLAG0_PAUSED
 &&

1660 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 == 0)

1662 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 = 
£nd”
->
»¶_off£t
;

1663 
	`£rv”Log
(
LL_WARNING
,

1666 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
);

1671 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_MEET
) {

1672 
	`£rv”Log
(
LL_DEBUG
,"Pšg…ack‘„eûived: %p", (*)
lšk
->
node
);

1685 ià((
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
 || 
my£lf
->

[0] == '\0') &&

1686 
£rv”
.
şu¡”_ªnounû_
 =ğ
NULL
)

1688 

[
NET_IP_STR_LEN
];

1690 ià(
	`ª‘SockName
(
lšk
->
fd
,

,(),
NULL
) != -1 &&

1691 
	`¡rcmp
(

,
my£lf
->ip))

1693 
	`memıy
(
my£lf
->

,,
NET_IP_STR_LEN
);

1694 
	`£rv”Log
(
LL_WARNING
,"IP‡ddress forhis‚ode updatedo %s",

1695 
my£lf
->

);

1696 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1704 ià(!
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
) {

1705 
şu¡”Node
 *
node
;

1707 
node
 = 
	`ü—‹Clu¡”Node
(
NULL
,
CLUSTER_NODE_HANDSHAKE
);

1708 
	`nodeIp2SŒšg
(
node
->

,
lšk
,
hdr
->
my
);

1709 
node
->
pÜt
 = 
	`Áohs
(
hdr
->port);

1710 
node
->
ıÜt
 = 
	`Áohs
(
hdr
->cport);

1711 
	`şu¡”AddNode
(
node
);

1712 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1718 ià(!
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1719 
	`şu¡”ProûssGossSeùiÚ
(
hdr
,
lšk
);

1722 
	`şu¡”S’dPšg
(
lšk
,
CLUSTERMSG_TYPE_PONG
);

1726 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_PONG
 ||

1727 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1729 
	`£rv”Log
(
LL_DEBUG
,"%s…acket„eceived: %p",

1730 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ? "ping" : "pong",

1731 (*)
lšk
->
node
);

1732 ià(
lšk
->
node
) {

1733 ià(
	`nodeInHªdshake
(
lšk
->
node
)) {

1736 ià(
£nd”
) {

1737 
	`£rv”Log
(
LL_VERBOSE
,

1739 "upd©šghadd»s iàÃeded.", 
£nd”
->
Çme
);

1740 ià(
	`nodeUpd©eAdd»ssIfN“ded
(
£nd”
,
lšk
,
hdr
))

1742 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1743 
CLUSTER_TODO_UPDATE_STATE
);

1747 
	`şu¡”D–Node
(
lšk
->
node
);

1753 
	`şu¡”R’ameNode
(
lšk
->
node
, 
hdr
->
£nd”
);

1754 
	`£rv”Log
(
LL_DEBUG
,"Handshake with‚ode %.40s completed.",

1755 
lšk
->
node
->
Çme
);

1756 
lšk
->
node
->
æags
 &ğ~
CLUSTER_NODE_HANDSHAKE
;

1757 
lšk
->
node
->
æags
 |ğæags&(
CLUSTER_NODE_MASTER
|
CLUSTER_NODE_SLAVE
);

1758 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1759 } ià(
	`memcmp
(
lšk
->
node
->
Çme
,
hdr
->
£nd”
,

1760 
CLUSTER_NAMELEN
) != 0)

1765 
	`£rv”Log
(
LL_DEBUG
,"PONG contains mismatching sender ID. About‚ode %.40s‡dded %d ms‡go, having flags %d",

1766 
lšk
->
node
->
Çme
,

1767 ()(
	`m¡ime
()-(
lšk
->
node
->
ùime
)),

1768 
lšk
->
node
->
æags
);

1769 
lšk
->
node
->
æags
 |ğ
CLUSTER_NODE_NOADDR
;

1770 
lšk
->
node
->

[0] = '\0';

1771 
lšk
->
node
->
pÜt
 = 0;

1772 
lšk
->
node
->
ıÜt
 = 0;

1773 
	`ä“Clu¡”Lšk
(
lšk
);

1774 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1780 ià(
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 &&

1781 !
	`nodeInHªdshake
(
£nd”
) &&

1782 
	`nodeUpd©eAdd»ssIfN“ded
(
£nd”
,
lšk
,
hdr
))

1784 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1785 
CLUSTER_TODO_UPDATE_STATE
);

1789 ià(
lšk
->
node
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PONG
) {

1790 
lšk
->
node
->
pÚg_»ûived
 = 
	`m¡ime
();

1791 
lšk
->
node
->
pšg_£Á
 = 0;

1799 ià(
	`nodeTimedOut
(
lšk
->
node
)) {

1800 
lšk
->
node
->
æags
 &ğ~
CLUSTER_NODE_PFAIL
;

1801 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1802 
CLUSTER_TODO_UPDATE_STATE
);

1803 } ià(
	`nodeFaed
(
lšk
->
node
)) {

1804 
	`ş—rNodeFau»IfN“ded
(
lšk
->
node
);

1809 ià(
£nd”
) {

1810 ià(!
	`memcmp
(
hdr
->
¦aveof
,
CLUSTER_NODE_NULL_NAME
,

1811 (
hdr
->
¦aveof
)))

1814 
	`şu¡”S‘NodeAsMa¡”
(
£nd”
);

1817 
şu¡”Node
 *
ma¡”
 = 
	`şu¡”LookupNode
(
hdr
->
¦aveof
);

1819 ià(
	`nodeIsMa¡”
(
£nd”
)) {

1821 
	`şu¡”D–NodeSlÙs
(
£nd”
);

1822 
£nd”
->
æags
 &ğ~(
CLUSTER_NODE_MASTER
|

1823 
CLUSTER_NODE_MIGRATE_TO
);

1824 
£nd”
->
æags
 |ğ
CLUSTER_NODE_SLAVE
;

1827 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1828 
CLUSTER_TODO_UPDATE_STATE
);

1832 ià(
ma¡”
 && 
£nd”
->
¦aveof
 != master) {

1833 ià(
£nd”
->
¦aveof
)

1834 
	`şu¡”NodeRemoveSÏve
(
£nd”
->
¦aveof
,sender);

1835 
	`şu¡”NodeAddSÏve
(
ma¡”
,
£nd”
);

1836 
£nd”
->
¦aveof
 = 
ma¡”
;

1839 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1853 
şu¡”Node
 *
£nd”_ma¡”
 = 
NULL
;

1854 
dœty_¦Ùs
 = 0;

1856 ià(
£nd”
) {

1857 
£nd”_ma¡”
 = 
	`nodeIsMa¡”
(
£nd”
è? s’d” : s’d”->
¦aveof
;

1858 ià(
£nd”_ma¡”
) {

1859 
dœty_¦Ùs
 = 
	`memcmp
(
£nd”_ma¡”
->
¦Ùs
,

1860 
hdr
->
my¦Ùs
,(hdr->myslots)) != 0;

1867 ià(
£nd”
 && 
	`nodeIsMa¡”
(£nd”è&& 
dœty_¦Ùs
)

1868 
	`şu¡”Upd©eSlÙsCÚfigW™h
(
£nd”
,
£nd”CÚfigEpoch
,
hdr
->
my¦Ùs
);

1888 ià(
£nd”
 && 
dœty_¦Ùs
) {

1889 
j
;

1891 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

1892 ià(
	`b™m­Te¡B™
(
hdr
->
my¦Ùs
,
j
)) {

1893 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
£nd”
 ||

1894 
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
) ;

1895 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 >

1896 
£nd”CÚfigEpoch
)

1898 
	`£rv”Log
(
LL_VERBOSE
,

1901 
£nd”
->
Çme
, 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->name);

1902 
	`şu¡”S’dUpd©e
(
£nd”
->
lšk
,

1903 
£rv”
.
şu¡”
->
¦Ùs
[
j
]);

1916 ià(
£nd”
 &&

1917 
	`nodeIsMa¡”
(
my£lf
è&&‚odeIsMa¡”(
£nd”
) &&

1918 
£nd”CÚfigEpoch
 =ğ
my£lf
->
cÚfigEpoch
)

1920 
	`şu¡”HªdËCÚfigEpochCŞlisiÚ
(
£nd”
);

1924 ià(
£nd”
è
	`şu¡”ProûssGossSeùiÚ
(
hdr
,
lšk
);

1925 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

1926 
şu¡”Node
 *
çšg
;

1928 ià(
£nd”
) {

1929 
çšg
 = 
	`şu¡”LookupNode
(
hdr
->
d©a
.
ç
.
about
.
nod’ame
);

1930 ià(
çšg
 &&

1931 !(
çšg
->
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_MYSELF
)))

1933 
	`£rv”Log
(
LL_NOTICE
,

1935 
hdr
->
£nd”
, hdr->
d©a
.
ç
.
about
.
nod’ame
);

1936 
çšg
->
æags
 |ğ
CLUSTER_NODE_FAIL
;

1937 
çšg
->
ç_time
 = 
	`m¡ime
();

1938 
çšg
->
æags
 &ğ~
CLUSTER_NODE_PFAIL
;

1939 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1940 
CLUSTER_TODO_UPDATE_STATE
);

1943 
	`£rv”Log
(
LL_NOTICE
,

1945 
hdr
->
£nd”
, hdr->
d©a
.
ç
.
about
.
nod’ame
);

1947 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PUBLISH
) {

1948 
robj
 *
chªÃl
, *
mes§ge
;

1949 
ušt32_t
 
chªÃl_Ën
, 
mes§ge_Ën
;

1953 ià(
	`diùSize
(
£rv”
.
pubsub_chªÃls
) ||

1954 
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
))

1956 
chªÃl_Ën
 = 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.channel_len);

1957 
mes§ge_Ën
 = 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.message_len);

1958 
chªÃl
 = 
	`ü—‹SŒšgObjeù
(

1959 (*)
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
,
chªÃl_Ën
);

1960 
mes§ge
 = 
	`ü—‹SŒšgObjeù
(

1961 (*)
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
+
chªÃl_Ën
,

1962 
mes§ge_Ën
);

1963 
	`pubsubPublishMes§ge
(
chªÃl
,
mes§ge
);

1964 
	`deüRefCouÁ
(
chªÃl
);

1965 
	`deüRefCouÁ
(
mes§ge
);

1967 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
) {

1968 ià(!
£nd”
)  1;

1969 
	`şu¡”S’dFaov”AuthIfN“ded
(
£nd”
,
hdr
);

1970 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
) {

1971 ià(!
£nd”
)  1;

1975 ià(
	`nodeIsMa¡”
(
£nd”
è&& s’d”->
num¦Ùs
 > 0 &&

1976 
£nd”Cu¼’tEpoch
 >ğ
£rv”
.
şu¡”
->
çov”_auth_•och
)

1978 
£rv”
.
şu¡”
->
çov”_auth_couÁ
++;

1981 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_HANDLE_FAILOVER
);

1983 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_MFSTART
) {

1986 ià(!
£nd”
 || s’d”->
¦aveof
 !ğ
my£lf
)  1;

1989 
	`»£tMªu®Faov”
();

1990 
£rv”
.
şu¡”
->
mf_’d
 = 
	`m¡ime
(è+ 
CLUSTER_MF_TIMEOUT
;

1991 
£rv”
.
şu¡”
->
mf_¦ave
 = 
£nd”
;

1992 
	`·u£Cl›Ás
(
	`m¡ime
()+(
CLUSTER_MF_TIMEOUT
*2));

1993 
	`£rv”Log
(
LL_WARNING
,"Manual failover„equested by slave %.40s.",

1994 
£nd”
->
Çme
);

1995 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

1996 
şu¡”Node
 *
n
;

1997 
ušt64_t
 
»pÜ‹dCÚfigEpoch
 =

1998 
	`Áohu64
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
cÚfigEpoch
);

2000 ià(!
£nd”
)  1;

2001 
n
 = 
	`şu¡”LookupNode
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
nod’ame
);

2002 ià(!
n
)  1;

2003 ià(
n
->
cÚfigEpoch
 >ğ
»pÜ‹dCÚfigEpoch
)  1;

2006 ià(
	`nodeIsSÏve
(
n
)è
	`şu¡”S‘NodeAsMa¡”
(n);

2009 
n
->
cÚfigEpoch
 = 
»pÜ‹dCÚfigEpoch
;

2010 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

2011 
CLUSTER_TODO_FSYNC_CONFIG
);

2015 
	`şu¡”Upd©eSlÙsCÚfigW™h
(
n
,
»pÜ‹dCÚfigEpoch
,

2016 
hdr
->
d©a
.
upd©e
.
nodecfg
.
¦Ùs
);

2018 
	`£rv”Log
(
LL_WARNING
,"Reûived unknowÀ·ck‘y³: %d", 
ty³
);

2021 
	}
}

2029 
	$hªdËLškIOE¼Ü
(
şu¡”Lšk
 *
lšk
) {

2030 
	`ä“Clu¡”Lšk
(
lšk
);

2031 
	}
}

2036 
	$şu¡”Wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

2037 
şu¡”Lšk
 *
lšk
 = (şu¡”Lšk*è
´ivd©a
;

2038 
ssize_t
 
nwr™‹n
;

2039 
	`UNUSED
(
–
);

2040 
	`UNUSED
(
mask
);

2042 
nwr™‹n
 = 
	`wr™e
(
fd
, 
lšk
->
¢dbuf
, 
	`sd¦’
(link->sndbuf));

2043 ià(
nwr™‹n
 <= 0) {

2044 
	`£rv”Log
(
LL_DEBUG
,"I/Oƒrror writingo‚ode†ink: %s",

2045 
	`¡»¼Ü
(
”ºo
));

2046 
	`hªdËLškIOE¼Ü
(
lšk
);

2049 
	`sd¤ªge
(
lšk
->
¢dbuf
,
nwr™‹n
,-1);

2050 ià(
	`sd¦’
(
lšk
->
¢dbuf
) == 0)

2051 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_WRITABLE
);

2052 
	}
}

2057 
	$şu¡”R—dHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

2058 
buf
[(
şu¡”Msg
)];

2059 
ssize_t
 
Ä—d
;

2060 
şu¡”Msg
 *
hdr
;

2061 
şu¡”Lšk
 *
lšk
 = (şu¡”Lšk*è
´ivd©a
;

2062 
»adËn
, 
rcvbuæ’
;

2063 
	`UNUSED
(
–
);

2064 
	`UNUSED
(
mask
);

2067 
rcvbuæ’
 = 
	`sd¦’
(
lšk
->
rcvbuf
);

2068 ià(
rcvbuæ’
 < 8) {

2071 
»adËn
 = 8 - 
rcvbuæ’
;

2074 
hdr
 = (
şu¡”Msg
*è
lšk
->
rcvbuf
;

2075 ià(
rcvbuæ’
 == 8) {

2078 ià(
	`memcmp
(
hdr
->
sig
,"RCmb",4) != 0 ||

2079 
	`Áohl
(
hdr
->
tÙËn
è< 
CLUSTERMSG_MIN_LEN
)

2081 
	`£rv”Log
(
LL_WARNING
,

2084 
	`hªdËLškIOE¼Ü
(
lšk
);

2088 
»adËn
 = 
	`Áohl
(
hdr
->
tÙËn
è- 
rcvbuæ’
;

2089 ià(
»adËn
 > (
buf
))„eadlen = (buf);

2092 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
»adËn
);

2093 ià(
Ä—d
 =ğ-1 && 
”ºo
 =ğ
EAGAIN
) ;

2095 ià(
Ä—d
 <= 0) {

2097 
	`£rv”Log
(
LL_DEBUG
,"I/Oƒrror„eading from‚ode†ink: %s",

2098 (
Ä—d
 =ğ0è? "cÚÃùiÚ clo£d" : 
	`¡»¼Ü
(
”ºo
));

2099 
	`hªdËLškIOE¼Ü
(
lšk
);

2103 
lšk
->
rcvbuf
 = 
	`sdsÿ’
Öšk->rcvbuf,
buf
,
Ä—d
);

2104 
hdr
 = (
şu¡”Msg
*è
lšk
->
rcvbuf
;

2105 
rcvbuæ’
 +ğ
Ä—d
;

2109 ià(
rcvbuæ’
 >ğ8 &&„cvbuæ’ =ğ
	`Áohl
(
hdr
->
tÙËn
)) {

2110 ià(
	`şu¡”ProûssPack‘
(
lšk
)) {

2111 
	`sdsä“
(
lšk
->
rcvbuf
);

2112 
lšk
->
rcvbuf
 = 
	`sd£m±y
();

2118 
	}
}

2125 
	$şu¡”S’dMes§ge
(
şu¡”Lšk
 *
lšk
, *
msg
, 
size_t
 
msgËn
) {

2126 ià(
	`sd¦’
(
lšk
->
¢dbuf
è=ğ0 && 
msgËn
 != 0)

2127 
	`«C»©eFeEv’t
(
£rv”
.
–
,
lšk
->
fd
,
AE_WRITABLE
,

2128 
şu¡”Wr™eHªdËr
,
lšk
);

2130 
lšk
->
¢dbuf
 = 
	`sdsÿ’
Öšk->¢dbuf, 
msg
, 
msgËn
);

2131 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
++;

2132 
	}
}

2140 
	$şu¡”Brßdÿ¡Mes§ge
(*
buf
, 
size_t
 
Ën
) {

2141 
diùI‹¿tÜ
 *
di
;

2142 
diùEÁry
 *
de
;

2144 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2145 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2146 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2148 ià(!
node
->
lšk
) ;

2149 ià(
node
->
æags
 & (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_HANDSHAKE
))

2151 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
Ën
);

2153 
	`diùR–—£I‹¿tÜ
(
di
);

2154 
	}
}

2158 
	$şu¡”BudMes§geHdr
(
şu¡”Msg
 *
hdr
, 
ty³
) {

2159 
tÙËn
 = 0;

2160 
ušt64_t
 
off£t
;

2161 
şu¡”Node
 *
ma¡”
;

2167 
ma¡”
 = (
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
) ?

2168 
my£lf
->
¦aveof
 : myself;

2170 
	`mem£t
(
hdr
,0,(*hdr));

2171 
hdr
->
v”
 = 
	`htÚs
(
CLUSTER_PROTO_VER
);

2172 
hdr
->
sig
[0] = 'R';

2173 
hdr
->
sig
[1] = 'C';

2174 
hdr
->
sig
[2] = 'm';

2175 
hdr
->
sig
[3] = 'b';

2176 
hdr
->
ty³
 = 
	`htÚs
(type);

2177 
	`memıy
(
hdr
->
£nd”
,
my£lf
->
Çme
,
CLUSTER_NAMELEN
);

2182 
	`mem£t
(
hdr
->
my
,0,
NET_IP_STR_LEN
);

2183 ià(
£rv”
.
şu¡”_ªnounû_
) {

2184 
	`¡ºıy
(
hdr
->
my
,
£rv”
.
şu¡”_ªnounû_
,
NET_IP_STR_LEN
);

2185 
hdr
->
my
[
NET_IP_STR_LEN
-1] = '\0';

2189 
ªnounûd_pÜt
 = 
£rv”
.
şu¡”_ªnounû_pÜt
 ?

2190 
£rv”
.
şu¡”_ªnounû_pÜt
 : s”v”.
pÜt
;

2191 
ªnounûd_ıÜt
 = 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 ?

2192 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 :

2193 (
£rv”
.
pÜt
 + 
CLUSTER_PORT_INCR
);

2195 
	`memıy
(
hdr
->
my¦Ùs
,
ma¡”
->
¦Ùs
,(hdr->myslots));

2196 
	`mem£t
(
hdr
->
¦aveof
,0,
CLUSTER_NAMELEN
);

2197 ià(
my£lf
->
¦aveof
 !ğ
NULL
)

2198 
	`memıy
(
hdr
->
¦aveof
,
my£lf
->¦aveof->
Çme
, 
CLUSTER_NAMELEN
);

2199 
hdr
->
pÜt
 = 
	`htÚs
(
ªnounûd_pÜt
);

2200 
hdr
->
ıÜt
 = 
	`htÚs
(
ªnounûd_ıÜt
);

2201 
hdr
->
æags
 = 
	`htÚs
(
my£lf
->flags);

2202 
hdr
->
¡©e
 = 
£rv”
.
şu¡”
->state;

2205 
hdr
->
cu¼’tEpoch
 = 
	`htÚu64
(
£rv”
.
şu¡”
->currentEpoch);

2206 
hdr
->
cÚfigEpoch
 = 
	`htÚu64
(
ma¡”
->configEpoch);

2209 ià(
	`nodeIsSÏve
(
my£lf
))

2210 
off£t
 = 
	`»¶iÿtiÚG‘SÏveOff£t
();

2212 
off£t
 = 
£rv”
.
ma¡”_»¶_off£t
;

2213 
hdr
->
off£t
 = 
	`htÚu64
(offset);

2216 ià(
	`nodeIsMa¡”
(
my£lf
è&& 
£rv”
.
şu¡”
->
mf_’d
)

2217 
hdr
->
mæags
[0] |ğ
CLUSTERMSG_FLAG0_PAUSED
;

2221 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

2222 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2223 
tÙËn
 +ğ(
şu¡”MsgD©aFa
);

2224 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

2225 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2226 
tÙËn
 +ğ(
şu¡”MsgD©aUpd©e
);

2228 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2230 
	}
}

2234 
	$şu¡”S’dPšg
(
şu¡”Lšk
 *
lšk
, 
ty³
) {

2235 *
buf
;

2236 
şu¡”Msg
 *
hdr
;

2237 
gosscouÁ
 = 0;

2238 
wª‹d
;

2239 
tÙËn
;

2244 
äeshnodes
 = 
	`diùSize
(
£rv”
.
şu¡”
->
nodes
)-2;

2272 
wª‹d
 = 
	`æoÜ
(
	`diùSize
(
£rv”
.
şu¡”
->
nodes
)/10);

2273 ià(
wª‹d
 < 3) wanted = 3;

2274 ià(
wª‹d
 > 
äeshnodes
) wanted = freshnodes;

2279 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2280 
tÙËn
 +ğ((
şu¡”MsgD©aGoss
)*
wª‹d
);

2283 ià(
tÙËn
 < ()(
şu¡”Msg
))otlen = (clusterMsg);

2284 
buf
 = 
	`zÿÎoc
(
tÙËn
);

2285 
hdr
 = (
şu¡”Msg
*è
buf
;

2288 ià(
lšk
->
node
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
)

2289 
lšk
->
node
->
pšg_£Á
 = 
	`m¡ime
();

2290 
	`şu¡”BudMes§geHdr
(
hdr
,
ty³
);

2293 
max™”©iÚs
 = 
wª‹d
*3;

2294 
äeshnodes
 > 0 && 
gosscouÁ
 < 
wª‹d
 && 
max™”©iÚs
--) {

2295 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
şu¡”
->
nodes
);

2296 
şu¡”Node
 *
this
 = 
	`diùG‘V®
(
de
);

2297 
şu¡”MsgD©aGoss
 *
goss
;

2298 
j
;

2302 ià(
this
 =ğ
my£lf
) ;

2305 ià(
max™”©iÚs
 > 
wª‹d
*2 &&

2306 !(
this
->
æags
 & (
CLUSTER_NODE_PFAIL
|
CLUSTER_NODE_FAIL
)))

2314 ià(
this
->
æags
 & (
CLUSTER_NODE_HANDSHAKE
|
CLUSTER_NODE_NOADDR
) ||

2315 (
this
->
lšk
 =ğ
NULL
 &&his->
num¦Ùs
 == 0))

2317 
äeshnodes
--;

2322 
j
 = 0; j < 
gosscouÁ
; j++) {

2323 ià(
	`memcmp
(
hdr
->
d©a
.
pšg
.
goss
[
j
].
nod’ame
,
this
->
Çme
,

2324 
CLUSTER_NAMELEN
) == 0) ;

2326 ià(
j
 !ğ
gosscouÁ
) ;

2329 
äeshnodes
--;

2330 
goss
 = &(
hdr
->
d©a
.
pšg
.goss[
gosscouÁ
]);

2331 
	`memıy
(
goss
->
nod’ame
,
this
->
Çme
,
CLUSTER_NAMELEN
);

2332 
goss
->
pšg_£Á
 = 
	`htÚl
(
this
->ping_sent);

2333 
goss
->
pÚg_»ûived
 = 
	`htÚl
(
this
->pong_received);

2334 
	`memıy
(
goss
->

,
this
->ip,(this->ip));

2335 
goss
->
pÜt
 = 
	`htÚs
(
this
->port);

2336 
goss
->
ıÜt
 = 
	`htÚs
(
this
->cport);

2337 
goss
->
æags
 = 
	`htÚs
(
this
->flags);

2338 
goss
->
nÙu£d1
 = 0;

2339 
gosscouÁ
++;

2344 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2345 
tÙËn
 +ğ((
şu¡”MsgD©aGoss
)*
gosscouÁ
);

2346 
hdr
->
couÁ
 = 
	`htÚs
(
gosscouÁ
);

2347 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2348 
	`şu¡”S’dMes§ge
(
lšk
,
buf
,
tÙËn
);

2349 
	`zä“
(
buf
);

2350 
	}
}

2366 
	#CLUSTER_BROADCAST_ALL
 0

	)

2367 
	#CLUSTER_BROADCAST_LOCAL_SLAVES
 1

	)

2368 
	$şu¡”Brßdÿ¡PÚg
(
rg‘
) {

2369 
diùI‹¿tÜ
 *
di
;

2370 
diùEÁry
 *
de
;

2372 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2373 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2374 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2376 ià(!
node
->
lšk
) ;

2377 ià(
node
 =ğ
my£lf
 || 
	`nodeInHªdshake
(node)) ;

2378 ià(
rg‘
 =ğ
CLUSTER_BROADCAST_LOCAL_SLAVES
) {

2379 
loÿl_¦ave
 =

2380 
	`nodeIsSÏve
(
node
è&&‚ode->
¦aveof
 &&

2381 (
node
->
¦aveof
 =ğ
my£lf
 ||‚ode->slaveof == myself->slaveof);

2382 ià(!
loÿl_¦ave
) ;

2384 
	`şu¡”S’dPšg
(
node
->
lšk
,
CLUSTERMSG_TYPE_PONG
);

2386 
	`diùR–—£I‹¿tÜ
(
di
);

2387 
	}
}

2392 
	$şu¡”S’dPublish
(
şu¡”Lšk
 *
lšk
, 
robj
 *
chªÃl
,„obj *
mes§ge
) {

2393 
buf
[(
şu¡”Msg
)], *
·ylßd
;

2394 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2395 
ušt32_t
 
tÙËn
;

2396 
ušt32_t
 
chªÃl_Ën
, 
mes§ge_Ën
;

2398 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

2399 
mes§ge
 = 
	`g‘DecodedObjeù
(message);

2400 
chªÃl_Ën
 = 
	`sd¦’
(
chªÃl
->
±r
);

2401 
mes§ge_Ën
 = 
	`sd¦’
(
mes§ge
->
±r
);

2403 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_PUBLISH
);

2404 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2405 
tÙËn
 +ğ(
şu¡”MsgD©aPublish
è- 8 + 
chªÃl_Ën
 + 
mes§ge_Ën
;

2407 
hdr
->
d©a
.
publish
.
msg
.
chªÃl_Ën
 = 
	`htÚl
(channel_len);

2408 
hdr
->
d©a
.
publish
.
msg
.
mes§ge_Ën
 = 
	`htÚl
(message_len);

2409 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2412 ià(
tÙËn
 < (
buf
)) {

2413 
·ylßd
 = 
buf
;

2415 
·ylßd
 = 
	`zm®loc
(
tÙËn
);

2416 
	`memıy
(
·ylßd
,
hdr
,(*hdr));

2417 
hdr
 = (
şu¡”Msg
*è
·ylßd
;

2419 
	`memıy
(
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
,
chªÃl
->
±r
,
	`sd¦’
(channel->ptr));

2420 
	`memıy
(
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
+
	`sd¦’
(
chªÃl
->
±r
),

2421 
mes§ge
->
±r
,
	`sd¦’
(message->ptr));

2423 ià(
lšk
)

2424 
	`şu¡”S’dMes§ge
(
lšk
,
·ylßd
,
tÙËn
);

2426 
	`şu¡”Brßdÿ¡Mes§ge
(
·ylßd
,
tÙËn
);

2428 
	`deüRefCouÁ
(
chªÃl
);

2429 
	`deüRefCouÁ
(
mes§ge
);

2430 ià(
·ylßd
 !ğ
buf
è
	`zä“
(payload);

2431 
	}
}

2438 
	$şu¡”S’dFa
(*
nod’ame
) {

2439 
buf
[(
şu¡”Msg
)];

2440 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2442 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAIL
);

2443 
	`memıy
(
hdr
->
d©a
.
ç
.
about
.
nod’ame
,nod’ame,
CLUSTER_NAMELEN
);

2444 
	`şu¡”Brßdÿ¡Mes§ge
(
buf
,
	`Áohl
(
hdr
->
tÙËn
));

2445 
	}
}

2450 
	$şu¡”S’dUpd©e
(
şu¡”Lšk
 *
lšk
, 
şu¡”Node
 *
node
) {

2451 
buf
[(
şu¡”Msg
)];

2452 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2454 ià(
lšk
 =ğ
NULL
) ;

2455 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_UPDATE
);

2456 
	`memıy
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
nod’ame
,
node
->
Çme
,
CLUSTER_NAMELEN
);

2457 
hdr
->
d©a
.
upd©e
.
nodecfg
.
cÚfigEpoch
 = 
	`htÚu64
(
node
->configEpoch);

2458 
	`memıy
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
¦Ùs
,
node
->slots,(node->slots));

2459 
	`şu¡”S’dMes§ge
(
lšk
,
buf
,
	`Áohl
(
hdr
->
tÙËn
));

2460 
	}
}

2469 
	$şu¡”Prİag©ePublish
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

2470 
	`şu¡”S’dPublish
(
NULL
, 
chªÃl
, 
mes§ge
);

2471 
	}
}

2483 
	$şu¡”Reque¡Faov”Auth
() {

2484 
buf
[(
şu¡”Msg
)];

2485 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2486 
ušt32_t
 
tÙËn
;

2488 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
);

2492 ià(
£rv”
.
şu¡”
->
mf_’d
è
hdr
->
mæags
[0] |ğ
CLUSTERMSG_FLAG0_FORCEACK
;

2493 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2494 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2495 
	`şu¡”Brßdÿ¡Mes§ge
(
buf
,
tÙËn
);

2496 
	}
}

2499 
	$şu¡”S’dFaov”Auth
(
şu¡”Node
 *
node
) {

2500 
buf
[(
şu¡”Msg
)];

2501 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2502 
ušt32_t
 
tÙËn
;

2504 ià(!
node
->
lšk
) ;

2505 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
);

2506 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2507 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2508 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
tÙËn
);

2509 
	}
}

2512 
	$şu¡”S’dMFS¹
(
şu¡”Node
 *
node
) {

2513 
buf
[(
şu¡”Msg
)];

2514 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2515 
ušt32_t
 
tÙËn
;

2517 ià(!
node
->
lšk
) ;

2518 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_MFSTART
);

2519 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2520 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2521 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
tÙËn
);

2522 
	}
}

2525 
	$şu¡”S’dFaov”AuthIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Msg
 *
»que¡
) {

2526 
şu¡”Node
 *
ma¡”
 = 
node
->
¦aveof
;

2527 
ušt64_t
 
»que¡Cu¼’tEpoch
 = 
	`Áohu64
(
»que¡
->
cu¼’tEpoch
);

2528 
ušt64_t
 
»que¡CÚfigEpoch
 = 
	`Áohu64
(
»que¡
->
cÚfigEpoch
);

2529 *
şaimed_¦Ùs
 = 
»que¡
->
my¦Ùs
;

2530 
fÜû_ack
 = 
»que¡
->
mæags
[0] & 
CLUSTERMSG_FLAG0_FORCEACK
;

2531 
j
;

2537 ià(
	`nodeIsSÏve
(
my£lf
è|| my£lf->
num¦Ùs
 == 0) ;

2543 ià(
»que¡Cu¼’tEpoch
 < 
£rv”
.
şu¡”
->
cu¼’tEpoch
) {

2544 
	`£rv”Log
(
LL_WARNING
,

2546 
node
->
Çme
,

2547 (è
»que¡Cu¼’tEpoch
,

2548 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2553 ià(
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 =ğ£rv”.şu¡”->
cu¼’tEpoch
) {

2554 
	`£rv”Log
(
LL_WARNING
,

2556 
node
->
Çme
,

2557 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2564 ià(
	`nodeIsMa¡”
(
node
è|| 
ma¡”
 =ğ
NULL
 ||

2565 (!
	`nodeFaed
(
ma¡”
è&& !
fÜû_ack
))

2567 ià(
	`nodeIsMa¡”
(
node
)) {

2568 
	`£rv”Log
(
LL_WARNING
,

2570 
node
->
Çme
);

2571 } ià(
ma¡”
 =ğ
NULL
) {

2572 
	`£rv”Log
(
LL_WARNING
,

2574 
node
->
Çme
);

2575 } ià(!
	`nodeFaed
(
ma¡”
)) {

2576 
	`£rv”Log
(
LL_WARNING
,

2578 
node
->
Çme
);

2586 ià(
	`m¡ime
(è- 
node
->
¦aveof
->
vÙed_time
 < 
£rv”
.
şu¡”_node_timeout
 * 2)

2588 
	`£rv”Log
(
LL_WARNING
,

2591 
node
->
Çme
,

2592 (è((
£rv”
.
şu¡”_node_timeout
*2)-

2593 (
	`m¡ime
(è- 
node
->
¦aveof
->
vÙed_time
)));

2600 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

2601 ià(
	`b™m­Te¡B™
(
şaimed_¦Ùs
, 
j
) == 0) ;

2602 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

2603 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 <ğ
»que¡CÚfigEpoch
)

2610 
	`£rv”Log
(
LL_WARNING
,

2613 
node
->
Çme
, 
j
,

2614 (è
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
,

2615 (è
»que¡CÚfigEpoch
);

2620 
	`şu¡”S’dFaov”Auth
(
node
);

2621 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = s”v”.şu¡”->
cu¼’tEpoch
;

2622 
node
->
¦aveof
->
vÙed_time
 = 
	`m¡ime
();

2623 
	`£rv”Log
(
LL_WARNING
, "Failover‡uth grantedo %.40s forƒpoch %llu",

2624 
node
->
Çme
, (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2625 
	}
}

2639 
	$şu¡”G‘SÏveRªk
() {

2640 
myoff£t
;

2641 
j
, 
¿nk
 = 0;

2642 
şu¡”Node
 *
ma¡”
;

2644 
	`£rv”As£¹
(
	`nodeIsSÏve
(
my£lf
));

2645 
ma¡”
 = 
my£lf
->
¦aveof
;

2646 ià(
ma¡”
 =ğ
NULL
)  0;

2648 
myoff£t
 = 
	`»¶iÿtiÚG‘SÏveOff£t
();

2649 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++)

2650 ià(
ma¡”
->
¦aves
[
j
] !ğ
my£lf
 &&

2651 
ma¡”
->
¦aves
[
j
]->
»¶_off£t
 > 
myoff£t
è
¿nk
++;

2652  
¿nk
;

2653 
	}
}

2677 
	$şu¡”LogCªtFaov”
(
»asÚ
) {

2678 *
msg
;

2679 
time_t
 
Ï¡log_time
 = 0;

2680 
m¡ime_t
 
nŞog_ç_time
 = 
£rv”
.
şu¡”_node_timeout
 + 5000;

2683 ià(
»asÚ
 =ğ
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 &&

2684 
	`time
(
NULL
)-
Ï¡log_time
 < 
CLUSTER_CANT_FAILOVER_RELOG_PERIOD
)

2687 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
»asÚ
;

2692 ià(
my£lf
->
¦aveof
 &&

2693 
	`nodeFaed
(
my£lf
->
¦aveof
) &&

2694 (
	`m¡ime
(è- 
my£lf
->
¦aveof
->
ç_time
è< 
nŞog_ç_time
) ;

2696 
»asÚ
) {

2697 
CLUSTER_CANT_FAILOVER_DATA_AGE
:

2698 
msg
 = "Disconnected from master for†ongerhan‡llowed. "

2702 
CLUSTER_CANT_FAILOVER_WAITING_DELAY
:

2703 
msg
 = "Waitinghe delay before I can start‡‚ew failover.";

2705 
CLUSTER_CANT_FAILOVER_EXPIRED
:

2706 
msg
 = "Failover‡ttemptƒxpired.";

2708 
CLUSTER_CANT_FAILOVER_WAITING_VOTES
:

2709 
msg
 = "Waiting for votes, but majority still‚ot„eached.";

2712 
msg
 = "Unknown„eason code.";

2715 
Ï¡log_time
 = 
	`time
(
NULL
);

2716 
	`£rv”Log
(
LL_WARNING
,"Cu¼’y uÇbËØçov”: %s", 
msg
);

2717 
	}
}

2725 
	$şu¡”Faov”R•ÏûYourMa¡”
() {

2726 
j
;

2727 
şu¡”Node
 *
Şdma¡”
 = 
my£lf
->
¦aveof
;

2729 ià(
	`nodeIsMa¡”
(
my£lf
è|| 
Şdma¡”
 =ğ
NULL
) ;

2732 
	`şu¡”S‘NodeAsMa¡”
(
my£lf
);

2733 
	`»¶iÿtiÚUn£tMa¡”
();

2736 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

2737 ià(
	`şu¡”NodeG‘SlÙB™
(
Şdma¡”
,
j
)) {

2738 
	`şu¡”D–SlÙ
(
j
);

2739 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

2744 
	`şu¡”Upd©eS‹
();

2745 
	`şu¡”SaveCÚfigOrD›
(1);

2749 
	`şu¡”Brßdÿ¡PÚg
(
CLUSTER_BROADCAST_ALL
);

2752 
	`»£tMªu®Faov”
();

2753 
	}
}

2763 
	$şu¡”HªdËSÏveFaov”
() {

2764 
m¡ime_t
 
d©a_age
;

2765 
m¡ime_t
 
auth_age
 = 
	`m¡ime
(è- 
£rv”
.
şu¡”
->
çov”_auth_time
;

2766 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

2767 
mªu®_çov”
 = 
£rv”
.
şu¡”
->
mf_’d
 != 0 &&

2768 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
;

2769 
m¡ime_t
 
auth_timeout
, 
auth_»Œy_time
;

2771 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_HANDLE_FAILOVER
;

2780 
auth_timeout
 = 
£rv”
.
şu¡”_node_timeout
*2;

2781 ià(
auth_timeout
 < 2000)‡uth_timeout = 2000;

2782 
auth_»Œy_time
 = 
auth_timeout
*2;

2789 ià(
	`nodeIsMa¡”
(
my£lf
) ||

2790 
my£lf
->
¦aveof
 =ğ
NULL
 ||

2791 (!
	`nodeFaed
(
my£lf
->
¦aveof
è&& !
mªu®_çov”
) ||

2792 
my£lf
->
¦aveof
->
num¦Ùs
 == 0)

2796 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
CLUSTER_CANT_FAILOVER_NONE
;

2802 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTED
) {

2803 
d©a_age
 = (
m¡ime_t
)(
£rv”
.
unixtime
 - s”v”.
ma¡”
->
Ï¡š‹¿ùiÚ
)

2806 
d©a_age
 = (
m¡ime_t
)(
£rv”
.
unixtime
 - s”v”.
»¶_down_sšû
) * 1000;

2812 ià(
d©a_age
 > 
£rv”
.
şu¡”_node_timeout
)

2813 
d©a_age
 -ğ
£rv”
.
şu¡”_node_timeout
;

2819 ià(
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 &&

2820 
d©a_age
 >

2821 (((
m¡ime_t
)
£rv”
.
»¶_pšg_¦ave_³riod
 * 1000) +

2822 (
£rv”
.
şu¡”_node_timeout
 * s”v”.
şu¡”_¦ave_v®id™y_çùÜ
)))

2824 ià(!
mªu®_çov”
) {

2825 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_DATA_AGE
);

2832 ià(
auth_age
 > 
auth_»Œy_time
) {

2833 
£rv”
.
şu¡”
->
çov”_auth_time
 = 
	`m¡ime
() +

2835 
	`¿ndom
() % 500;

2836 
£rv”
.
şu¡”
->
çov”_auth_couÁ
 = 0;

2837 
£rv”
.
şu¡”
->
çov”_auth_£Á
 = 0;

2838 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 
	`şu¡”G‘SÏveRªk
();

2842 
£rv”
.
şu¡”
->
çov”_auth_time
 +=

2843 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 * 1000;

2845 ià(
£rv”
.
şu¡”
->
mf_’d
) {

2846 
£rv”
.
şu¡”
->
çov”_auth_time
 = 
	`m¡ime
();

2847 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 0;

2849 
	`£rv”Log
(
LL_WARNING
,

2852 
£rv”
.
şu¡”
->
çov”_auth_time
 - 
	`m¡ime
(),

2853 
£rv”
.
şu¡”
->
çov”_auth_¿nk
,

2854 
	`»¶iÿtiÚG‘SÏveOff£t
());

2858 
	`şu¡”Brßdÿ¡PÚg
(
CLUSTER_BROADCAST_LOCAL_SLAVES
);

2867 ià(
£rv”
.
şu¡”
->
çov”_auth_£Á
 == 0 &&

2868 
£rv”
.
şu¡”
->
mf_’d
 == 0)

2870 
Ãw¿nk
 = 
	`şu¡”G‘SÏveRªk
();

2871 ià(
Ãw¿nk
 > 
£rv”
.
şu¡”
->
çov”_auth_¿nk
) {

2872 
added_d–ay
 =

2873 (
Ãw¿nk
 - 
£rv”
.
şu¡”
->
çov”_auth_¿nk
) * 1000;

2874 
£rv”
.
şu¡”
->
çov”_auth_time
 +ğ
added_d–ay
;

2875 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 
Ãw¿nk
;

2876 
	`£rv”Log
(
LL_WARNING
,

2878 
Ãw¿nk
, 
added_d–ay
);

2883 ià(
	`m¡ime
(è< 
£rv”
.
şu¡”
->
çov”_auth_time
) {

2884 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_WAITING_DELAY
);

2889 ià(
auth_age
 > 
auth_timeout
) {

2890 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_EXPIRED
);

2895 ià(
£rv”
.
şu¡”
->
çov”_auth_£Á
 == 0) {

2896 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

2897 
£rv”
.
şu¡”
->
çov”_auth_•och
 = s”v”.şu¡”->
cu¼’tEpoch
;

2898 
	`£rv”Log
(
LL_WARNING
,"Starting‡ failoverƒlection forƒpoch %llu.",

2899 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2900 
	`şu¡”Reque¡Faov”Auth
();

2901 
£rv”
.
şu¡”
->
çov”_auth_£Á
 = 1;

2902 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

2903 
CLUSTER_TODO_UPDATE_STATE
|

2904 
CLUSTER_TODO_FSYNC_CONFIG
);

2909 ià(
£rv”
.
şu¡”
->
çov”_auth_couÁ
 >ğ
Ãeded_quÜum
) {

2912 
	`£rv”Log
(
LL_WARNING
,

2916 ià(
my£lf
->
cÚfigEpoch
 < 
£rv”
.
şu¡”
->
çov”_auth_•och
) {

2917 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
çov”_auth_•och
;

2918 
	`£rv”Log
(
LL_WARNING
,

2920 (è
my£lf
->
cÚfigEpoch
);

2924 
	`şu¡”Faov”R•ÏûYourMa¡”
();

2926 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_WAITING_VOTES
);

2928 
	}
}

2957 
	$şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
) {

2958 
j
, 
ok¦aves
 = 0;

2959 
şu¡”Node
 *
myma¡”
 = 
my£lf
->
¦aveof
, *
rg‘
 = 
NULL
, *
ÿndid©e
 = NULL;

2960 
diùI‹¿tÜ
 *
di
;

2961 
diùEÁry
 *
de
;

2964 ià(
£rv”
.
şu¡”
->
¡©e
 !ğ
CLUSTER_OK
) ;

2968 ià(
myma¡”
 =ğ
NULL
) ;

2969 
j
 = 0; j < 
myma¡”
->
num¦aves
; j++)

2970 ià(!
	`nodeFaed
(
myma¡”
->
¦aves
[
j
]) &&

2971 !
	`nodeTimedOut
(
myma¡”
->
¦aves
[
j
])è
ok¦aves
++;

2972 ià(
ok¦aves
 <ğ
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
) ;

2984 
ÿndid©e
 = 
my£lf
;

2985 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2986 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2987 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2988 
ok¦aves
 = 0, 
is_Üphªed
 = 1;

2994 ià(
	`nodeIsSÏve
(
node
è|| 
	`nodeFaed
Òode)è
is_Üphªed
 = 0;

2995 ià(!(
node
->
æags
 & 
CLUSTER_NODE_MIGRATE_TO
)è
is_Üphªed
 = 0;

2998 ià(
	`nodeIsMa¡”
(
node
)è
ok¦aves
 = 
	`şu¡”CouÁNÚFašgSÏves
(node);

2999 ià(
ok¦aves
 > 0è
is_Üphªed
 = 0;

3001 ià(
is_Üphªed
) {

3002 ià(!
rg‘
 && 
node
->
num¦Ùs
 > 0)arget =‚ode;

3006 ià(!
node
->
Üphªed_time
ènode->Üphªed_timğ
	`m¡ime
();

3008 
node
->
Üphªed_time
 = 0;

3014 ià(
ok¦aves
 =ğ
max_¦aves
) {

3015 
j
 = 0; j < 
node
->
num¦aves
; j++) {

3016 ià(
	`memcmp
(
node
->
¦aves
[
j
]->
Çme
,

3017 
ÿndid©e
->
Çme
,

3018 
CLUSTER_NAMELEN
) < 0)

3020 
ÿndid©e
 = 
node
->
¦aves
[
j
];

3025 
	`diùR–—£I‹¿tÜ
(
di
);

3032 ià(
rg‘
 && 
ÿndid©e
 =ğ
my£lf
 &&

3033 (
	`m¡ime
()-
rg‘
->
Üphªed_time
è> 
CLUSTER_SLAVE_MIGRATION_DELAY
)

3035 
	`£rv”Log
(
LL_WARNING
,"Migratingo orphaned master %.40s",

3036 
rg‘
->
Çme
);

3037 
	`şu¡”S‘Ma¡”
(
rg‘
);

3039 
	}
}

3075 
	$»£tMªu®Faov”
() {

3076 ià(
£rv”
.
şu¡”
->
mf_’d
 && 
	`ş›ÁsA»Pau£d
()) {

3077 
£rv”
.
ş›Ás_·u£_’d_time
 = 0;

3078 
	`ş›ÁsA»Pau£d
();

3080 
£rv”
.
şu¡”
->
mf_’d
 = 0;

3081 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 0;

3082 
£rv”
.
şu¡”
->
mf_¦ave
 = 
NULL
;

3083 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 = 0;

3084 
	}
}

3087 
	$mªu®Faov”CheckTimeout
() {

3088 ià(
£rv”
.
şu¡”
->
mf_’d
 && s”v”.şu¡”->mf_’d < 
	`m¡ime
()) {

3089 
	`£rv”Log
(
LL_WARNING
,"Manual failoverimed out.");

3090 
	`»£tMªu®Faov”
();

3092 
	}
}

3096 
	$şu¡”HªdËMªu®Faov”
() {

3098 ià(
£rv”
.
şu¡”
->
mf_’d
 == 0) ;

3102 ià(
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
) ;

3104 ià(
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 == 0) ;

3106 ià(
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 =ğ
	`»¶iÿtiÚG‘SÏveOff£t
()) {

3109 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 1;

3110 
	`£rv”Log
(
LL_WARNING
,

3114 
	}
}

3121 
	$şu¡”CrÚ
() {

3122 
diùI‹¿tÜ
 *
di
;

3123 
diùEÁry
 *
de
;

3124 
upd©e_¡©e
 = 0;

3125 
Üphªed_ma¡”s
;

3126 
max_¦aves
;

3127 
this_¦aves
;

3128 
m¡ime_t
 
mš_pÚg
 = 0, 
now
 = 
	`m¡ime
();

3129 
şu¡”Node
 *
mš_pÚg_node
 = 
NULL
;

3130 
™”©iÚ
 = 0;

3131 
m¡ime_t
 
hªdshake_timeout
;

3133 
™”©iÚ
++;

3139 *
´ev_
 = 
NULL
;

3140 *
cu¼_
 = 
£rv”
.
şu¡”_ªnounû_
;

3141 
chªged
 = 0;

3143 ià(
´ev_
 =ğ
NULL
 && 
cu¼_
 !ğNULLè
chªged
 = 1;

3144 ià(
´ev_
 !ğ
NULL
 && 
cu¼_
 =ğNULLè
chªged
 = 1;

3145 ià(
´ev_
 && 
cu¼_
 && 
	`¡rcmp
Õ»v_,cu¼_)è
chªged
 = 1;

3147 ià(
chªged
) {

3148 
´ev_
 = 
cu¼_
;

3149 ià(
´ev_
è´ev_ = 
	`z¡rdup
(prev_ip);

3151 ià(
cu¼_
) {

3152 
	`¡ºıy
(
my£lf
->

,
£rv”
.
şu¡”_ªnounû_
,
NET_IP_STR_LEN
);

3153 
my£lf
->

[
NET_IP_STR_LEN
-1] = '\0';

3155 
my£lf
->

[0] = '\0';

3164 
hªdshake_timeout
 = 
£rv”
.
şu¡”_node_timeout
;

3165 ià(
hªdshake_timeout
 < 1000) handshake_timeout = 1000;

3168 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3169 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3170 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3172 ià(
node
->
æags
 & (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_NOADDR
)) ;

3176 ià(
	`nodeInHªdshake
(
node
è&& 
now
 -‚ode->
ùime
 > 
hªdshake_timeout
) {

3177 
	`şu¡”D–Node
(
node
);

3181 ià(
node
->
lšk
 =ğ
NULL
) {

3182 
fd
;

3183 
m¡ime_t
 
Şd_pšg_£Á
;

3184 
şu¡”Lšk
 *
lšk
;

3186 
fd
 = 
	`ª‘TıNÚBlockBšdCÚÃù
(
£rv”
.
Ã‹¼
, 
node
->

,

3187 
node
->
ıÜt
, 
NET_FIRST_BIND_ADDR
);

3188 ià(
fd
 == -1) {

3194 ià(
node
->
pšg_£Á
 =ğ0ènode->pšg_£Á = 
	`m¡ime
();

3195 
	`£rv”Log
(
LL_DEBUG
, "Unableo connecto "

3196 "Clu¡” Nod[%s]:%d -> %s", 
node
->

,

3197 
node
->
ıÜt
, 
£rv”
.
Ã‹¼
);

3200 
lšk
 = 
	`ü—‹Clu¡”Lšk
(
node
);

3201 
lšk
->
fd
 = fd;

3202 
node
->
lšk
 =†ink;

3203 
	`«C»©eFeEv’t
(
£rv”
.
–
,
lšk
->
fd
,
AE_READABLE
,

3204 
şu¡”R—dHªdËr
,
lšk
);

3211 
Şd_pšg_£Á
 = 
node
->
pšg_£Á
;

3212 
	`şu¡”S’dPšg
(
lšk
, 
node
->
æags
 & 
CLUSTER_NODE_MEET
 ?

3213 
CLUSTERMSG_TYPE_MEET
 : 
CLUSTERMSG_TYPE_PING
);

3214 ià(
Şd_pšg_£Á
) {

3218 
node
->
pšg_£Á
 = 
Şd_pšg_£Á
;

3225 
node
->
æags
 &ğ~
CLUSTER_NODE_MEET
;

3227 
	`£rv”Log
(
LL_DEBUG
,"Connecting with Node %.40s‡t %s:%d",

3228 
node
->
Çme
,‚ode->

,‚ode->
ıÜt
);

3231 
	`diùR–—£I‹¿tÜ
(
di
);

3235 ià(!(
™”©iÚ
 % 10)) {

3236 
j
;

3240 
j
 = 0; j < 5; j++) {

3241 
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
şu¡”
->
nodes
);

3242 
şu¡”Node
 *
this
 = 
	`diùG‘V®
(
de
);

3245 ià(
this
->
lšk
 =ğ
NULL
 ||his->
pšg_£Á
 != 0) ;

3246 ià(
this
->
æags
 & (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_HANDSHAKE
))

3248 ià(
mš_pÚg_node
 =ğ
NULL
 || 
mš_pÚg
 > 
this
->
pÚg_»ûived
) {

3249 
mš_pÚg_node
 = 
this
;

3250 
mš_pÚg
 = 
this
->
pÚg_»ûived
;

3253 ià(
mš_pÚg_node
) {

3254 
	`£rv”Log
(
LL_DEBUG
,"Pšgšg‚od%.40s", 
mš_pÚg_node
->
Çme
);

3255 
	`şu¡”S’dPšg
(
mš_pÚg_node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3265 
Üphªed_ma¡”s
 = 0;

3266 
max_¦aves
 = 0;

3267 
this_¦aves
 = 0;

3268 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3269 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3270 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3271 
now
 = 
	`m¡ime
();

3272 
m¡ime_t
 
d–ay
;

3274 ià(
node
->
æags
 &

3275 (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_NOADDR
|
CLUSTER_NODE_HANDSHAKE
))

3280 ià(
	`nodeIsSÏve
(
my£lf
è&& 
	`nodeIsMa¡”
(
node
è&& !
	`nodeFaed
(node)) {

3281 
ok¦aves
 = 
	`şu¡”CouÁNÚFašgSÏves
(
node
);

3286 ià(
ok¦aves
 =ğ0 && 
node
->
num¦Ùs
 > 0 &&

3287 
node
->
æags
 & 
CLUSTER_NODE_MIGRATE_TO
)

3289 
Üphªed_ma¡”s
++;

3291 ià(
ok¦aves
 > 
max_¦aves
) max_slaves = okslaves;

3292 ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
node
)

3293 
this_¦aves
 = 
ok¦aves
;

3299 ià(
node
->
lšk
 &&

3300 
now
 - 
node
->
lšk
->
ùime
 >

3301 
£rv”
.
şu¡”_node_timeout
 &&

3302 
node
->
pšg_£Á
 &&

3303 
node
->
pÚg_»ûived
 <‚ode->
pšg_£Á
 &&

3305 
now
 - 
node
->
pšg_£Á
 > 
£rv”
.
şu¡”_node_timeout
/2)

3308 
	`ä“Clu¡”Lšk
(
node
->
lšk
);

3315 ià(
node
->
lšk
 &&

3316 
node
->
pšg_£Á
 == 0 &&

3317 (
now
 - 
node
->
pÚg_»ûived
è> 
£rv”
.
şu¡”_node_timeout
/2)

3319 
	`şu¡”S’dPšg
(
node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3325 ià(
£rv”
.
şu¡”
->
mf_’d
 &&

3326 
	`nodeIsMa¡”
(
my£lf
) &&

3327 
£rv”
.
şu¡”
->
mf_¦ave
 =ğ
node
 &&

3328 
node
->
lšk
)

3330 
	`şu¡”S’dPšg
(
node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3335 ià(
node
->
pšg_£Á
 == 0) ;

3340 
d–ay
 = 
now
 - 
node
->
pšg_£Á
;

3342 ià(
d–ay
 > 
£rv”
.
şu¡”_node_timeout
) {

3345 ià(!(
node
->
æags
 & (
CLUSTER_NODE_PFAIL
|
CLUSTER_NODE_FAIL
))) {

3346 
	`£rv”Log
(
LL_DEBUG
,"*** NODE %.40s…ossibly failing",

3347 
node
->
Çme
);

3348 
node
->
æags
 |ğ
CLUSTER_NODE_PFAIL
;

3349 
upd©e_¡©e
 = 1;

3353 
	`diùR–—£I‹¿tÜ
(
di
);

3358 ià(
	`nodeIsSÏve
(
my£lf
) &&

3359 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

3360 
my£lf
->
¦aveof
 &&

3361 
	`nodeHasAddr
(
my£lf
->
¦aveof
))

3363 
	`»¶iÿtiÚS‘Ma¡”
(
my£lf
->
¦aveof
->

, my£lf->¦aveof->
pÜt
);

3367 
	`mªu®Faov”CheckTimeout
();

3369 ià(
	`nodeIsSÏve
(
my£lf
)) {

3370 
	`şu¡”HªdËMªu®Faov”
();

3371 
	`şu¡”HªdËSÏveFaov”
();

3377 ià(
Üphªed_ma¡”s
 && 
max_¦aves
 >ğ2 && 
this_¦aves
 == max_slaves)

3378 
	`şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
);

3381 ià(
upd©e_¡©e
 || 
£rv”
.
şu¡”
->
¡©e
 =ğ
CLUSTER_FAIL
)

3382 
	`şu¡”Upd©eS‹
();

3383 
	}
}

3390 
	$şu¡”BefÜeSË•
() {

3393 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_HANDLE_FAILOVER
)

3394 
	`şu¡”HªdËSÏveFaov”
();

3397 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_UPDATE_STATE
)

3398 
	`şu¡”Upd©eS‹
();

3401 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_SAVE_CONFIG
) {

3402 
fsync
 = 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &

3403 
CLUSTER_TODO_FSYNC_CONFIG
;

3404 
	`şu¡”SaveCÚfigOrD›
(
fsync
);

3409 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 = 0;

3410 
	}
}

3412 
	$şu¡”DoBefÜeSË•
(
æags
) {

3413 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 |ğ
æags
;

3414 
	}
}

3422 
	$b™m­Te¡B™
(*
b™m­
, 
pos
) {

3423 
off_t
 
by‹
 = 
pos
/8;

3424 
b™
 = 
pos
&7;

3425  (
b™m­
[
by‹
] & (1<<
b™
)) != 0;

3426 
	}
}

3429 
	$b™m­S‘B™
(*
b™m­
, 
pos
) {

3430 
off_t
 
by‹
 = 
pos
/8;

3431 
b™
 = 
pos
&7;

3432 
b™m­
[
by‹
] |ğ1<<
b™
;

3433 
	}
}

3436 
	$b™m­CË¬B™
(*
b™m­
, 
pos
) {

3437 
off_t
 
by‹
 = 
pos
/8;

3438 
b™
 = 
pos
&7;

3439 
b™m­
[
by‹
] &ğ~(1<<
b™
);

3440 
	}
}

3445 
	$şu¡”Ma¡”sHaveSÏves
() {

3446 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3447 
diùEÁry
 *
de
;

3448 
¦aves
 = 0;

3449 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3450 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3452 ià(
	`nodeIsSÏve
(
node
)) ;

3453 
¦aves
 +ğ
node
->
num¦aves
;

3455 
	`diùR–—£I‹¿tÜ
(
di
);

3456  
¦aves
 != 0;

3457 
	}
}

3460 
	$şu¡”NodeS‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3461 
Şd
 = 
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3462 
	`b™m­S‘B™
(
n
->
¦Ùs
,
¦Ù
);

3463 ià(!
Şd
) {

3464 
n
->
num¦Ùs
++;

3478 ià(
n
->
num¦Ùs
 =ğ1 && 
	`şu¡”Ma¡”sHaveSÏves
())

3479 
n
->
æags
 |ğ
CLUSTER_NODE_MIGRATE_TO
;

3481  
Şd
;

3482 
	}
}

3485 
	$şu¡”NodeCË¬SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3486 
Şd
 = 
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3487 
	`b™m­CË¬B™
(
n
->
¦Ùs
,
¦Ù
);

3488 ià(
Şd
è
n
->
num¦Ùs
--;

3489  
Şd
;

3490 
	}
}

3493 
	$şu¡”NodeG‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3494  
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3495 
	}
}

3501 
	$şu¡”AddSlÙ
(
şu¡”Node
 *
n
, 
¦Ù
) {

3502 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
]è 
C_ERR
;

3503 
	`şu¡”NodeS‘SlÙB™
(
n
,
¦Ù
);

3504 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] = 
n
;

3505  
C_OK
;

3506 
	}
}

3511 
	$şu¡”D–SlÙ
(
¦Ù
) {

3512 
şu¡”Node
 *
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

3514 ià(!
n
è 
C_ERR
;

3515 
	`£rv”As£¹
(
	`şu¡”NodeCË¬SlÙB™
(
n
,
¦Ù
) == 1);

3516 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] = 
NULL
;

3517  
C_OK
;

3518 
	}
}

3522 
	$şu¡”D–NodeSlÙs
(
şu¡”Node
 *
node
) {

3523 
d–‘ed
 = 0, 
j
;

3525 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3526 ià(
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)è
	`şu¡”D–SlÙ
(j);

3527 
d–‘ed
++;

3529  
d–‘ed
;

3530 
	}
}

3534 
	$şu¡”Clo£AÎSlÙs
() {

3535 
	`mem£t
(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
,0,

3536 (
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
));

3537 
	`mem£t
(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
,0,

3538 (
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
));

3539 
	}
}

3549 
	#CLUSTER_MAX_REJOIN_DELAY
 5000

	)

3550 
	#CLUSTER_MIN_REJOIN_DELAY
 500

	)

3551 
	#CLUSTER_WRITABLE_DELAY
 2000

	)

3553 
	$şu¡”Upd©eS‹
() {

3554 
j
, 
Ãw_¡©e
;

3555 
»achabË_ma¡”s
 = 0;

3556 
m¡ime_t
 
amÚg_mšÜ™y_time
;

3557 
m¡ime_t
 
fœ¡_ÿÎ_time
 = 0;

3559 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_UPDATE_STATE
;

3567 ià(
fœ¡_ÿÎ_time
 =ğ0èfœ¡_ÿÎ_timğ
	`m¡ime
();

3568 ià(
	`nodeIsMa¡”
(
my£lf
) &&

3569 
£rv”
.
şu¡”
->
¡©e
 =ğ
CLUSTER_FAIL
 &&

3570 
	`m¡ime
(è- 
fœ¡_ÿÎ_time
 < 
CLUSTER_WRITABLE_DELAY
) ;

3574 
Ãw_¡©e
 = 
CLUSTER_OK
;

3577 ià(
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
) {

3578 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3579 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

3580 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
æags
 & (
CLUSTER_NODE_FAIL
))

3582 
Ãw_¡©e
 = 
CLUSTER_FAIL
;

3594 
diùI‹¿tÜ
 *
di
;

3595 
diùEÁry
 *
de
;

3597 
£rv”
.
şu¡”
->
size
 = 0;

3598 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3599 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3600 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3602 ià(
	`nodeIsMa¡”
(
node
è&&‚ode->
num¦Ùs
) {

3603 
£rv”
.
şu¡”
->
size
++;

3604 ià((
node
->
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) == 0)

3605 
»achabË_ma¡”s
++;

3608 
	`diùR–—£I‹¿tÜ
(
di
);

3614 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

3616 ià(
»achabË_ma¡”s
 < 
Ãeded_quÜum
) {

3617 
Ãw_¡©e
 = 
CLUSTER_FAIL
;

3618 
amÚg_mšÜ™y_time
 = 
	`m¡ime
();

3623 ià(
Ãw_¡©e
 !ğ
£rv”
.
şu¡”
->
¡©e
) {

3624 
m¡ime_t
 
»još_d–ay
 = 
£rv”
.
şu¡”_node_timeout
;

3630 ià(
»još_d–ay
 > 
CLUSTER_MAX_REJOIN_DELAY
)

3631 
»još_d–ay
 = 
CLUSTER_MAX_REJOIN_DELAY
;

3632 ià(
»još_d–ay
 < 
CLUSTER_MIN_REJOIN_DELAY
)

3633 
»još_d–ay
 = 
CLUSTER_MIN_REJOIN_DELAY
;

3635 ià(
Ãw_¡©e
 =ğ
CLUSTER_OK
 &&

3636 
	`nodeIsMa¡”
(
my£lf
) &&

3637 
	`m¡ime
(è- 
amÚg_mšÜ™y_time
 < 
»još_d–ay
)

3643 
	`£rv”Log
(
LL_WARNING
,"Cluster state changed: %s",

3644 
Ãw_¡©e
 =ğ
CLUSTER_OK
 ? "ok" : "fail");

3645 
£rv”
.
şu¡”
->
¡©e
 = 
Ãw_¡©e
;

3647 
	}
}

3671 
	$v”ifyClu¡”CÚfigW™hD©a
() {

3672 
j
;

3673 
upd©e_cÚfig
 = 0;

3677 ià(
	`nodeIsSÏve
(
my£lf
)è 
C_OK
;

3680 
j
 = 1; j < 
£rv”
.
dbnum
; j++) {

3681 ià(
	`diùSize
(
£rv”
.
db
[
j
].
diù
)è 
C_ERR
;

3686 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3687 ià(!
	`couÁKeysInSlÙ
(
j
)) ;

3691 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
my£lf
 ||

3692 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] !ğ
NULL
) ;

3698 
upd©e_cÚfig
++;

3700 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
) {

3701 
	`£rv”Log
(
LL_WARNING
, "I have keys for unassigned slot %d. "

3702 "Takšg„e¥Úsib™y fÜ it.",
j
);

3703 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

3705 
	`£rv”Log
(
LL_WARNING
, "I have keys for slot %d, buthe slot is "

3707 "S‘tšg iˆtØimpÜtšg s‹.",
j
);

3708 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = s”v”.şu¡”->
¦Ùs
[j];

3711 ià(
upd©e_cÚfig
è
	`şu¡”SaveCÚfigOrD›
(1);

3712  
C_OK
;

3713 
	}
}

3721 
	$şu¡”S‘Ma¡”
(
şu¡”Node
 *
n
) {

3722 
	`£rv”As£¹
(
n
 !ğ
my£lf
);

3723 
	`£rv”As£¹
(
my£lf
->
num¦Ùs
 == 0);

3725 ià(
	`nodeIsMa¡”
(
my£lf
)) {

3726 
my£lf
->
æags
 &ğ~(
CLUSTER_NODE_MASTER
|
CLUSTER_NODE_MIGRATE_TO
);

3727 
my£lf
->
æags
 |ğ
CLUSTER_NODE_SLAVE
;

3728 
	`şu¡”Clo£AÎSlÙs
();

3730 ià(
my£lf
->
¦aveof
)

3731 
	`şu¡”NodeRemoveSÏve
(
my£lf
->
¦aveof
,myself);

3733 
my£lf
->
¦aveof
 = 
n
;

3734 
	`şu¡”NodeAddSÏve
(
n
,
my£lf
);

3735 
	`»¶iÿtiÚS‘Ma¡”
(
n
->

,‚->
pÜt
);

3736 
	`»£tMªu®Faov”
();

3737 
	}
}

3743 
	s»disNodeFÏgs
 {

3744 
ušt16_t
 
	mæag
;

3745 *
	mÇme
;

3748 
»disNodeFÏgs
 
	g»disNodeFÏgsTabË
[] = {

3749 {
CLUSTER_NODE_MYSELF
, "myself,"},

3750 {
CLUSTER_NODE_MASTER
, "master,"},

3751 {
CLUSTER_NODE_SLAVE
, "slave,"},

3752 {
CLUSTER_NODE_PFAIL
, "fail?,"},

3753 {
CLUSTER_NODE_FAIL
, "fail,"},

3754 {
CLUSTER_NODE_HANDSHAKE
, "handshake,"},

3755 {
CLUSTER_NODE_NOADDR
, "noaddr,"}

3760 
sds
 
	$»´e£ÁClu¡”NodeFÏgs
(
sds
 
ci
, 
ušt16_t
 
æags
) {

3761 ià(
æags
 == 0) {

3762 
ci
 = 
	`sdsÿt
(ci,"noflags,");

3764 
i
, 
size
 = (
»disNodeFÏgsTabË
)/(
»disNodeFÏgs
);

3765 
i
 = 0; i < 
size
; i++) {

3766 
»disNodeFÏgs
 *
nodeæag
 = 
»disNodeFÏgsTabË
 + 
i
;

3767 ià(
æags
 & 
nodeæag
->
æag
è
ci
 = 
	`sdsÿt
(ci,‚odeæag->
Çme
);

3770 
	`sdsInüL’
(
ci
,-1);

3771  
ci
;

3772 
	}
}

3778 
sds
 
	$şu¡”G’NodeDesütiÚ
(
şu¡”Node
 *
node
) {

3779 
j
, 
¡¬t
;

3780 
sds
 
ci
;

3783 
ci
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%.40s %s:%d@%d ",

3784 
node
->
Çme
,

3785 
node
->

,

3786 
node
->
pÜt
,

3787 
node
->
ıÜt
);

3790 
ci
 = 
	`»´e£ÁClu¡”NodeFÏgs
(ci, 
node
->
æags
);

3793 ià(
node
->
¦aveof
)

3794 
ci
 = 
	`sdsÿrštf
(ci," %.40 ",
node
->
¦aveof
->
Çme
);

3796 
ci
 = 
	`sdsÿ’
(ci," - ",3);

3799 
ci
 = 
	`sdsÿrštf
(ci,"%lld %lld %llu %s",

3800 (è
node
->
pšg_£Á
,

3801 (è
node
->
pÚg_»ûived
,

3802 (è
node
->
cÚfigEpoch
,

3803 (
node
->
lšk
 ||‚ode->
æags
 & 
CLUSTER_NODE_MYSELF
) ?

3807 
¡¬t
 = -1;

3808 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3809 
b™
;

3811 ià((
b™
 = 
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)) != 0) {

3812 ià(
¡¬t
 =ğ-1è¡¬ˆğ
j
;

3814 ià(
¡¬t
 !ğ-1 && (!
b™
 || 
j
 =ğ
CLUSTER_SLOTS
-1)) {

3815 ià(
b™
 && 
j
 =ğ
CLUSTER_SLOTS
-1) j++;

3817 ià(
¡¬t
 =ğ
j
-1) {

3818 
ci
 = 
	`sdsÿrštf
(ci," %d",
¡¬t
);

3820 
ci
 = 
	`sdsÿrštf
(ci," %d-%d",
¡¬t
,
j
-1);

3822 
¡¬t
 = -1;

3829 ià(
node
->
æags
 & 
CLUSTER_NODE_MYSELF
) {

3830 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3831 ià(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
]) {

3832 
ci
 = 
	`sdsÿrštf
(ci," [%d->-%.40s]",
j
,

3833 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
]->
Çme
);

3834 } ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]) {

3835 
ci
 = 
	`sdsÿrštf
(ci," [%d-<-%.40s]",
j
,

3836 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]->
Çme
);

3840  
ci
;

3841 
	}
}

3855 
sds
 
	$şu¡”G’NodesDesütiÚ
(
f‹r
) {

3856 
sds
 
ci
 = 
	`sd£m±y
(), 
ni
;

3857 
diùI‹¿tÜ
 *
di
;

3858 
diùEÁry
 *
de
;

3860 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3861 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3862 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3864 ià(
node
->
æags
 & 
f‹r
) ;

3865 
ni
 = 
	`şu¡”G’NodeDesütiÚ
(
node
);

3866 
ci
 = 
	`sdsÿtsds
(ci,
ni
);

3867 
	`sdsä“
(
ni
);

3868 
ci
 = 
	`sdsÿ’
(ci,"\n",1);

3870 
	`diùR–—£I‹¿tÜ
(
di
);

3871  
ci
;

3872 
	}
}

3878 
	$g‘SlÙOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
) {

3879 
¦Ù
;

3881 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
¦Ù
è!ğ
C_OK
 ||

3882 
¦Ù
 < 0 || slÙ >ğ
CLUSTER_SLOTS
)

3884 
	`addR•lyE¼Ü
(
c
,"Invalid or out of„ange slot");

3887  (è
¦Ù
;

3888 
	}
}

3890 
	$şu¡”R•lyMuÉiBulkSlÙs
(
ş›Á
 *
c
) {

3902 
num_ma¡”s
 = 0;

3903 *
¦Ù_»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

3905 
diùEÁry
 *
de
;

3906 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3907 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3908 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3909 
j
 = 0, 
¡¬t
 = -1;

3913 ià(!
	`nodeIsMa¡”
(
node
è||‚ode->
num¦Ùs
 == 0) ;

3915 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3916 
b™
, 
i
;

3918 ià((
b™
 = 
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)) != 0) {

3919 ià(
¡¬t
 =ğ-1è¡¬ˆğ
j
;

3921 ià(
¡¬t
 !ğ-1 && (!
b™
 || 
j
 =ğ
CLUSTER_SLOTS
-1)) {

3922 
Ã¡ed_–em’ts
 = 3;

3923 *
Ã¡ed_»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

3925 ià(
b™
 && 
j
 =ğ
CLUSTER_SLOTS
-1) j++;

3929 ià(
¡¬t
 =ğ
j
-1) {

3930 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

3931 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

3933 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

3934 
	`addR•lyLÚgLÚg
(
c
, 
j
-1);

3936 
¡¬t
 = -1;

3939 
	`addR•lyMuÉiBulkL’
(
c
, 3);

3940 
	`addR•lyBulkCSŒšg
(
c
, 
node
->

);

3941 
	`addR•lyLÚgLÚg
(
c
, 
node
->
pÜt
);

3942 
	`addR•lyBulkCBufãr
(
c
, 
node
->
Çme
, 
CLUSTER_NAMELEN
);

3945 
i
 = 0; i < 
node
->
num¦aves
; i++) {

3948 ià(
	`nodeFaed
(
node
->
¦aves
[
i
])) ;

3949 
	`addR•lyMuÉiBulkL’
(
c
, 3);

3950 
	`addR•lyBulkCSŒšg
(
c
, 
node
->
¦aves
[
i
]->

);

3951 
	`addR•lyLÚgLÚg
(
c
, 
node
->
¦aves
[
i
]->
pÜt
);

3952 
	`addR•lyBulkCBufãr
(
c
, 
node
->
¦aves
[
i
]->
Çme
, 
CLUSTER_NAMELEN
);

3953 
Ã¡ed_–em’ts
++;

3955 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
Ã¡ed_»¶yËn
, 
Ã¡ed_–em’ts
);

3956 
num_ma¡”s
++;

3960 
	`diùR–—£I‹¿tÜ
(
di
);

3961 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
¦Ù_»¶yËn
, 
num_ma¡”s
);

3962 
	}
}

3964 
	$şu¡”Commªd
(
ş›Á
 *
c
) {

3965 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

3966 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

3970 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"m“t"è&& (c->
¬gc
 == 4 || c->argc == 5)) {

3972 
pÜt
, 
ıÜt
;

3974 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[3], &
pÜt
è!ğ
C_OK
) {

3975 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid TCP base…ort specified: %s",

3976 (*)
c
->
¬gv
[3]->
±r
);

3980 ià(
c
->
¬gc
 == 5) {

3981 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[4], &
ıÜt
è!ğ
C_OK
) {

3982 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid TCP bus…ort specified: %s",

3983 (*)
c
->
¬gv
[4]->
±r
);

3987 
ıÜt
 = 
pÜt
 + 
CLUSTER_PORT_INCR
;

3990 ià(
	`şu¡”S¹Hªdshake
(
c
->
¬gv
[2]->
±r
,
pÜt
,
ıÜt
) == 0 &&

3991 
”ºo
 =ğ
EINVAL
)

3993 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‚ode‡ddress specified: %s:%s",

3994 (*)
c
->
¬gv
[2]->
±r
, (*)c->argv[3]->ptr);

3996 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3998 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nodes"è&& c->
¬gc
 == 2) {

4000 
robj
 *
o
;

4001 
sds
 
ci
 = 
	`şu¡”G’NodesDesütiÚ
(0);

4003 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
ci
);

4004 
	`addR•lyBulk
(
c
,
o
);

4005 
	`deüRefCouÁ
(
o
);

4006 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"myid"è&& c->
¬gc
 == 2) {

4008 
	`addR•lyBulkCBufãr
(
c
,
my£lf
->
Çme
, 
CLUSTER_NAMELEN
);

4009 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦Ùs"è&& c->
¬gc
 == 2) {

4011 
	`şu¡”R•lyMuÉiBulkSlÙs
(
c
);

4012 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"æush¦Ùs"è&& c->
¬gc
 == 2) {

4014 ià(
	`diùSize
(
£rv”
.
db
[0].
diù
) != 0) {

4015 
	`addR•lyE¼Ü
(
c
,"DB must beƒmptyo…erform CLUSTER FLUSHSLOTS.");

4018 
	`şu¡”D–NodeSlÙs
(
my£lf
);

4019 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

4020 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4021 } ià((!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"addslots") ||

4022 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"d–¦Ùs")è&& c->
¬gc
 >= 3)

4026 
j
, 
¦Ù
;

4027 *
¦Ùs
 = 
	`zm®loc
(
CLUSTER_SLOTS
);

4028 
d–
 = !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"delslots");

4030 
	`mem£t
(
¦Ùs
,0,
CLUSTER_SLOTS
);

4033 
j
 = 2; j < 
c
->
¬gc
; j++) {

4034 ià((
¦Ù
 = 
	`g‘SlÙOrR•ly
(
c
,c->
¬gv
[
j
])) == -1) {

4035 
	`zä“
(
¦Ùs
);

4038 ià(
d–
 && 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
NULL
) {

4039 
	`addR•lyE¼ÜFÜm©
(
c
,"SlÙ %d i ®»ady uÇssigÃd", 
¦Ù
);

4040 
	`zä“
(
¦Ùs
);

4042 } ià(!
d–
 && 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
]) {

4043 
	`addR•lyE¼ÜFÜm©
(
c
,"SlÙ %d i ®»ady busy", 
¦Ù
);

4044 
	`zä“
(
¦Ùs
);

4047 ià(
¦Ùs
[
¦Ù
]++ == 1) {

4048 
	`addR•lyE¼ÜFÜm©
(
c
,"Slot %d specified multipleimes",

4049 ()
¦Ù
);

4050 
	`zä“
(
¦Ùs
);

4054 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

4055 ià(
¦Ùs
[
j
]) {

4056 
»tv®
;

4060 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
])

4061 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = 
NULL
;

4063 
»tv®
 = 
d–
 ? 
	`şu¡”D–SlÙ
(
j
) :

4064 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

4065 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
»tv®
 =ğ
C_OK
);

4068 
	`zä“
(
¦Ùs
);

4069 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

4070 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4071 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£t¦Ù"è&& c->
¬gc
 >= 4) {

4076 
¦Ù
;

4077 
şu¡”Node
 *
n
;

4079 ià(
	`nodeIsSÏve
(
my£lf
)) {

4080 
	`addR•lyE¼Ü
(
c
,"Please use SETSLOT only with masters.");

4084 ià((
¦Ù
 = 
	`g‘SlÙOrR•ly
(
c
,c->
¬gv
[2])) == -1) ;

4086 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"mig¿tšg"è&& c->
¬gc
 == 5) {

4087 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] !ğ
my£lf
) {

4088 
	`addR•lyE¼ÜFÜm©
(
c
,"I'm‚ÙhowÃ¸oàhash slÙ %u",
¦Ù
);

4091 ià((
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
)è=ğ
NULL
) {

4092 
	`addR•lyE¼ÜFÜm©
(
c
,"I don't know‡bout‚ode %s",

4093 (*)
c
->
¬gv
[4]->
±r
);

4096 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
n
;

4097 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"impÜtšg"è&& c->
¬gc
 == 5) {

4098 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
my£lf
) {

4099 
	`addR•lyE¼ÜFÜm©
(
c
,

4100 "I'm‡Ì—dyhowÃ¸oàhash slÙ %u",
¦Ù
);

4103 ià((
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
)è=ğ
NULL
) {

4104 
	`addR•lyE¼ÜFÜm©
(
c
,"I don't know‡bout‚ode %s",

4105 (*)
c
->
¬gv
[3]->
±r
);

4108 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
n
;

4109 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"¡abË"è&& c->
¬gc
 == 4) {

4111 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
NULL
;

4112 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
NULL
;

4113 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"node"è&& c->
¬gc
 == 5) {

4115 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
);

4117 ià(!
n
) {

4118 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown‚ode %s",

4119 (*)
c
->
¬gv
[4]->
±r
);

4124 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
my£lf
 && 
n
 != myself) {

4125 ià(
	`couÁKeysInSlÙ
(
¦Ù
) != 0) {

4126 
	`addR•lyE¼ÜFÜm©
(
c
,

4128 "whI stÈhŞd key fÜhi hash slÙ.", 
¦Ù
);

4135 ià(
	`couÁKeysInSlÙ
(
¦Ù
) == 0 &&

4136 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
])

4137 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
NULL
;

4141 ià(
n
 =ğ
my£lf
 &&

4142 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
])

4153 ià(
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
(è=ğ
C_OK
) {

4154 
	`£rv”Log
(
LL_WARNING
,

4155 "cÚfigEpoch upd©ed‡á” impÜtšg slÙ %d", 
¦Ù
);

4157 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
NULL
;

4159 
	`şu¡”D–SlÙ
(
¦Ù
);

4160 
	`şu¡”AddSlÙ
(
n
,
¦Ù
);

4162 
	`addR•lyE¼Ü
(
c
,

4166 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|
CLUSTER_TODO_UPDATE_STATE
);

4167 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4168 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"bum³poch"è&& c->
¬gc
 == 2) {

4170 
»tv®
 = 
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

4171 
sds
 
»¶y
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"+%s %llu\r\n",

4172 (
»tv®
 =ğ
C_OK
) ? "BUMPED" : "STILL",

4173 (è
my£lf
->
cÚfigEpoch
);

4174 
	`addR•lySds
(
c
,
»¶y
);

4175 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"šfo"è&& c->
¬gc
 == 2) {

4177 *
¡©e¡r
[] = {"ok","fail","needhelp"};

4178 
¦Ùs_assigÃd
 = 0, 
¦Ùs_ok
 = 0, 
¦Ùs_pç
 = 0, 
¦Ùs_ç
 = 0;

4179 
ušt64_t
 
my•och
;

4180 
j
;

4182 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

4183 
şu¡”Node
 *
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
j
];

4185 ià(
n
 =ğ
NULL
) ;

4186 
¦Ùs_assigÃd
++;

4187 ià(
	`nodeFaed
(
n
)) {

4188 
¦Ùs_ç
++;

4189 } ià(
	`nodeTimedOut
(
n
)) {

4190 
¦Ùs_pç
++;

4192 
¦Ùs_ok
++;

4196 
my•och
 = (
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
) ?

4197 
my£lf
->
¦aveof
->
cÚfigEpoch
 : myself->configEpoch;

4199 
sds
 
šfo
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

4211 , 
¡©e¡r
[
£rv”
.
şu¡”
->
¡©e
],

4212 
¦Ùs_assigÃd
,

4213 
¦Ùs_ok
,

4214 
¦Ùs_pç
,

4215 
¦Ùs_ç
,

4216 
	`diùSize
(
£rv”
.
şu¡”
->
nodes
),

4217 
£rv”
.
şu¡”
->
size
,

4218 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
,

4219 (è
my•och
,

4220 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
,

4221 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived


4223 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"$%lu\r\n",

4224 ()
	`sd¦’
(
šfo
)));

4225 
	`addR•lySds
(
c
,
šfo
);

4226 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

4227 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"§vecÚfig"è&& c->
¬gc
 == 2) {

4228 
»tv®
 = 
	`şu¡”SaveCÚfig
(1);

4230 ià(
»tv®
 == 0)

4231 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4233 
	`addR•lyE¼ÜFÜm©
(
c
,"error savinghe cluster‚ode config: %s",

4234 
	`¡»¼Ü
(
”ºo
));

4235 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"key¦Ù"è&& c->
¬gc
 == 3) {

4237 
sds
 
key
 = 
c
->
¬gv
[2]->
±r
;

4239 
	`addR•lyLÚgLÚg
(
c
,
	`keyHashSlÙ
(
key
,
	`sd¦’
(key)));

4240 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"couÁkeysš¦Ù"è&& c->
¬gc
 == 3) {

4242 
¦Ù
;

4244 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¦Ù
,
NULL
è!ğ
C_OK
)

4246 ià(
¦Ù
 < 0 || slÙ >ğ
CLUSTER_SLOTS
) {

4247 
	`addR•lyE¼Ü
(
c
,"Invalid slot");

4250 
	`addR•lyLÚgLÚg
(
c
,
	`couÁKeysInSlÙ
(
¦Ù
));

4251 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keysš¦Ù"è&& c->
¬gc
 == 4) {

4253 
maxkeys
, 
¦Ù
;

4254 
numkeys
, 
j
;

4255 
robj
 **
keys
;

4257 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¦Ù
,
NULL
è!ğ
C_OK
)

4259 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
maxkeys
,
NULL
)

4260 !ğ
C_OK
)

4262 ià(
¦Ù
 < 0 || slÙ >ğ
CLUSTER_SLOTS
 || 
maxkeys
 < 0) {

4263 
	`addR•lyE¼Ü
(
c
,"Invalid slot or‚umber of keys");

4267 
keys
 = 
	`zm®loc
((
robj
*)*
maxkeys
);

4268 
numkeys
 = 
	`g‘KeysInSlÙ
(
¦Ù
, 
keys
, 
maxkeys
);

4269 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

4270 
j
 = 0; j < 
numkeys
; j++) {

4271 
	`addR•lyBulk
(
c
,
keys
[
j
]);

4272 
	`deüRefCouÁ
(
keys
[
j
]);

4274 
	`zä“
(
keys
);

4275 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"fÜg‘"è&& c->
¬gc
 == 3) {

4277 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4279 ià(!
n
) {

4280 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4282 } ià(
n
 =ğ
my£lf
) {

4283 
	`addR•lyE¼Ü
(
c
,"Iried hard but I can't forget myself...");

4285 } ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
n
) {

4286 
	`addR•lyE¼Ü
(
c
,"Can't forget my master!");

4289 
	`şu¡”BÏckli¡AddNode
(
n
);

4290 
	`şu¡”D–Node
(
n
);

4291 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|

4292 
CLUSTER_TODO_SAVE_CONFIG
);

4293 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4294 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»¶iÿ‹"è&& c->
¬gc
 == 3) {

4296 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4299 ià(!
n
) {

4300 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4305 ià(
n
 =ğ
my£lf
) {

4306 
	`addR•lyE¼Ü
(
c
,"Can't„eplicate myself");

4311 ià(
	`nodeIsSÏve
(
n
)) {

4312 
	`addR•lyE¼Ü
(
c
,"I can only„eplicate‡ master,‚ot‡ slave.");

4319 ià(
	`nodeIsMa¡”
(
my£lf
) &&

4320 (
my£lf
->
num¦Ùs
 !ğ0 || 
	`diùSize
(
£rv”
.
db
[0].
diù
) != 0)) {

4321 
	`addR•lyE¼Ü
(
c
,

4328 
	`şu¡”S‘Ma¡”
(
n
);

4329 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

4330 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4331 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦aves"è&& c->
¬gc
 == 3) {

4333 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4334 
j
;

4337 ià(!
n
) {

4338 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4342 ià(
	`nodeIsSÏve
(
n
)) {

4343 
	`addR•lyE¼Ü
(
c
,"The specified‚ode is‚ot‡ master");

4347 
	`addR•lyMuÉiBulkL’
(
c
,
n
->
num¦aves
);

4348 
j
 = 0; j < 
n
->
num¦aves
; j++) {

4349 
sds
 
ni
 = 
	`şu¡”G’NodeDesütiÚ
(
n
->
¦aves
[
j
]);

4350 
	`addR•lyBulkCSŒšg
(
c
,
ni
);

4351 
	`sdsä“
(
ni
);

4353 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"count-failure-reports") &&

4354 
c
->
¬gc
 == 3)

4357 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4359 ià(!
n
) {

4360 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4363 
	`addR•lyLÚgLÚg
(
c
,
	`şu¡”NodeFau»R•ÜtsCouÁ
(
n
));

4365 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"failover") &&

4366 (
c
->
¬gc
 == 2 || c->argc == 3))

4369 
fÜû
 = 0, 
keov”
 = 0;

4371 ià(
c
->
¬gc
 == 3) {

4372 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"force")) {

4373 
fÜû
 = 1;

4374 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"takeover")) {

4375 
keov”
 = 1;

4376 
fÜû
 = 1;

4378 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4384 ià(
	`nodeIsMa¡”
(
my£lf
)) {

4385 
	`addR•lyE¼Ü
(
c
,"You should send CLUSTER FAILOVERo‡ slave");

4387 } ià(
my£lf
->
¦aveof
 =ğ
NULL
) {

4388 
	`addR•lyE¼Ü
(
c
,"I'm‡ slave but my master is unknowno me");

4390 } ià(!
fÜû
 &&

4391 (
	`nodeFaed
(
my£lf
->
¦aveof
) ||

4392 
my£lf
->
¦aveof
->
lšk
 =ğ
NULL
))

4394 
	`addR•lyE¼Ü
(
c
,"Master is down or failed, "

4398 
	`»£tMªu®Faov”
();

4399 
£rv”
.
şu¡”
->
mf_’d
 = 
	`m¡ime
(è+ 
CLUSTER_MF_TIMEOUT
;

4401 ià(
keov”
) {

4406 
	`£rv”Log
(
LL_WARNING
,"Taking overhe master (user„equest).");

4407 
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

4408 
	`şu¡”Faov”R•ÏûYourMa¡”
();

4409 } ià(
fÜû
) {

4413 
	`£rv”Log
(
LL_WARNING
,"Forced failover user„equest‡ccepted.");

4414 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 1;

4416 
	`£rv”Log
(
LL_WARNING
,"Manual failover user„equest‡ccepted.");

4417 
	`şu¡”S’dMFS¹
(
my£lf
->
¦aveof
);

4419 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4420 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£t-cÚfig-•och"è&& c->
¬gc
 == 3)

4429 
•och
;

4431 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
•och
,
NULL
è!ğ
C_OK
)

4434 ià(
•och
 < 0) {

4435 
	`addR•lyE¼ÜFÜm©
(
c
,"Inv®id cÚfigƒpoch s³cif›d: %Îd",
•och
);

4436 } ià(
	`diùSize
(
£rv”
.
şu¡”
->
nodes
) > 1) {

4437 
	`addR•lyE¼Ü
(
c
,"The user can‡ssign‡ configƒpoch only whenhe "

4439 } ià(
my£lf
->
cÚfigEpoch
 != 0) {

4440 
	`addR•lyE¼Ü
(
c
,"Node configƒpoch is‡lready‚on-zero");

4442 
my£lf
->
cÚfigEpoch
 = 
•och
;

4443 
	`£rv”Log
(
LL_WARNING
,

4445 (è
my£lf
->
cÚfigEpoch
);

4447 ià(
£rv”
.
şu¡”
->
cu¼’tEpoch
 < (
ušt64_t
)
•och
)

4448 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
•och
;

4452 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|

4453 
CLUSTER_TODO_SAVE_CONFIG
);

4454 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4456 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reset") &&

4457 (
c
->
¬gc
 == 2 || c->argc == 3))

4460 
h¬d
 = 0;

4463 ià(
c
->
¬gc
 == 3) {

4464 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"hard")) {

4465 
h¬d
 = 1;

4466 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"soft")) {

4467 
h¬d
 = 0;

4469 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4476 ià(
	`nodeIsMa¡”
(
my£lf
è&& 
	`diùSize
(
c
->
db
->
diù
) != 0) {

4477 
	`addR•lyE¼Ü
(
c
,"CLUSTER RESET can't be called with "

4481 
	`şu¡”Re£t
(
h¬d
);

4482 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4484 
	`addR•lyE¼Ü
(
c
,"Wrong CLUSTER subcommand or‚umber of‡rguments");

4486 
	}
}

4494 
	$ü—‹DumpPaylßd
(
rio
 *
·ylßd
, 
robj
 *
o
) {

4495 
buf
[2];

4496 
ušt64_t
 
üc
;

4500 
	`rioIn™W™hBufãr
(
·ylßd
,
	`sd£m±y
());

4501 
	`£rv”As£¹
(
	`rdbSaveObjeùTy³
(
·ylßd
,
o
));

4502 
	`£rv”As£¹
(
	`rdbSaveObjeù
(
·ylßd
,
o
));

4512 
buf
[0] = 
RDB_VERSION
 & 0xff;

4513 
buf
[1] = (
RDB_VERSION
 >> 8) & 0xff;

4514 
·ylßd
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Õaylßd->io.bufãr.±r,
buf
,2);

4517 
üc
 = 
	`üc64
(0,(*)
·ylßd
->
io
.
bufãr
.
±r
,

4518 
	`sd¦’
(
·ylßd
->
io
.
bufãr
.
±r
));

4519 
	`mem»v64ifbe
(&
üc
);

4520 
·ylßd
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Õaylßd->io.bufãr.±r,&
üc
,8);

4521 
	}
}

4527 
	$v”ifyDumpPaylßd
(*
p
, 
size_t
 
Ën
) {

4528 *
foÙ”
;

4529 
ušt16_t
 
rdbv”
;

4530 
ušt64_t
 
üc
;

4533 ià(
Ën
 < 10è 
C_ERR
;

4534 
foÙ”
 = 
p
+(
Ën
-10);

4537 
rdbv”
 = (
foÙ”
[1] << 8) | footer[0];

4538 ià(
rdbv”
 > 
RDB_VERSION
è 
C_ERR
;

4541 
üc
 = 
	`üc64
(0,
p
,
Ën
-8);

4542 
	`mem»v64ifbe
(&
üc
);

4543  (
	`memcmp
(&
üc
,
foÙ”
+2,8è=ğ0è? 
C_OK
 : 
C_ERR
;

4544 
	}
}

4549 
	$dumpCommªd
(
ş›Á
 *
c
) {

4550 
robj
 *
o
, *
dumpobj
;

4551 
rio
 
·ylßd
;

4554 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

4555 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

4560 
	`ü—‹DumpPaylßd
(&
·ylßd
,
o
);

4563 
dumpobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
·ylßd
.
io
.
bufãr
.
±r
);

4564 
	`addR•lyBulk
(
c
,
dumpobj
);

4565 
	`deüRefCouÁ
(
dumpobj
);

4567 
	}
}

4570 
	$»¡ÜeCommªd
(
ş›Á
 *
c
) {

4571 
‰l
;

4572 
rio
 
·ylßd
;

4573 
j
, 
ty³
, 
»¶aû
 = 0;

4574 
robj
 *
obj
;

4577 
j
 = 4; j < 
c
->
¬gc
; j++) {

4578 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"replace")) {

4579 
»¶aû
 = 1;

4581 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4587 ià(!
»¶aû
 && 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]è!ğ
NULL
) {

4588 
	`addR•ly
(
c
,
sh¬ed
.
busykey”r
);

4593 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
‰l
,
NULL
è!ğ
C_OK
) {

4595 } ià(
‰l
 < 0) {

4596 
	`addR•lyE¼Ü
(
c
,"Invalid TTL value, must be >= 0");

4601 ià(
	`v”ifyDumpPaylßd
(
c
->
¬gv
[3]->
±r
,
	`sd¦’
(c->¬gv[3]->±r)è=ğ
C_ERR
)

4603 
	`addR•lyE¼Ü
(
c
,"DUMP…ayload version or checksum‡re wrong");

4607 
	`rioIn™W™hBufãr
(&
·ylßd
,
c
->
¬gv
[3]->
±r
);

4608 ià(((
ty³
 = 
	`rdbLßdObjeùTy³
(&
·ylßd
)) == -1) ||

4609 ((
obj
 = 
	`rdbLßdObjeù
(
ty³
,&
·ylßd
)è=ğ
NULL
))

4611 
	`addR•lyE¼Ü
(
c
,"Bad data format");

4616 ià(
»¶aû
è
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

4619 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
obj
);

4620 ià(
‰l
è
	`£tExpœe
(
c
->
db
,c->
¬gv
[1],
	`m¡ime
()+ttl);

4621 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

4622 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4623 
£rv”
.
dœty
++;

4624 
	}
}

4632 
	#MIGRATE_SOCKET_CACHE_ITEMS
 64

	)

4633 
	#MIGRATE_SOCKET_CACHE_TTL
 10

	)

4635 
	smig¿‹CachedSock‘
 {

4636 
	mfd
;

4637 
	mÏ¡_dbid
;

4638 
time_t
 
	mÏ¡_u£_time
;

4639 } 
	tmig¿‹CachedSock‘
;

4652 
mig¿‹CachedSock‘
* 
	$mig¿‹G‘Sock‘
(
ş›Á
 *
c
, 
robj
 *
ho¡
,„obj *
pÜt
, 
timeout
) {

4653 
fd
;

4654 
sds
 
Çme
 = 
	`sd£m±y
();

4655 
mig¿‹CachedSock‘
 *
cs
;

4658 
Çme
 = 
	`sdsÿ’
Òame,
ho¡
->
±r
,
	`sd¦’
(host->ptr));

4659 
Çme
 = 
	`sdsÿ’
(name,":",1);

4660 
Çme
 = 
	`sdsÿ’
Òame,
pÜt
->
±r
,
	`sd¦’
(port->ptr));

4661 
cs
 = 
	`diùF‘chV®ue
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4662 ià(
cs
) {

4663 
	`sdsä“
(
Çme
);

4664 
cs
->
Ï¡_u£_time
 = 
£rv”
.
unixtime
;

4665  
cs
;

4669 ià(
	`diùSize
(
£rv”
.
mig¿‹_ÿched_sock‘s
è=ğ
MIGRATE_SOCKET_CACHE_ITEMS
) {

4671 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
mig¿‹_ÿched_sock‘s
);

4672 
cs
 = 
	`diùG‘V®
(
de
);

4673 
	`şo£
(
cs
->
fd
);

4674 
	`zä“
(
cs
);

4675 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
	`diùG‘Key
(
de
));

4679 
fd
 = 
	`ª‘TıNÚBlockCÚÃù
(
£rv”
.
Ã‹¼
,
c
->
¬gv
[1]->
±r
,

4680 
	`©oi
(
c
->
¬gv
[2]->
±r
));

4681 ià(
fd
 == -1) {

4682 
	`sdsä“
(
Çme
);

4683 
	`addR•lyE¼ÜFÜm©
(
c
,"Can't connectoarget‚ode: %s",

4684 
£rv”
.
Ã‹¼
);

4685  
NULL
;

4687 
	`ª‘EÇbËTıNoD–ay
(
£rv”
.
Ã‹¼
,
fd
);

4690 ià((
	`«Wa™
(
fd
,
AE_WRITABLE
,
timeout
) & AE_WRITABLE) == 0) {

4691 
	`sdsä“
(
Çme
);

4692 
	`addR•lySds
(
c
,

4693 
	`sd¢ew
("-IOERRƒrror orimeout connectingohe client\r\n"));

4694 
	`şo£
(
fd
);

4695  
NULL
;

4699 
cs
 = 
	`zm®loc
((*cs));

4700 
cs
->
fd
 = fd;

4701 
cs
->
Ï¡_dbid
 = -1;

4702 
cs
->
Ï¡_u£_time
 = 
£rv”
.
unixtime
;

4703 
	`diùAdd
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
,
cs
);

4704  
cs
;

4705 
	}
}

4708 
	$mig¿‹Clo£Sock‘
(
robj
 *
ho¡
,„obj *
pÜt
) {

4709 
sds
 
Çme
 = 
	`sd£m±y
();

4710 
mig¿‹CachedSock‘
 *
cs
;

4712 
Çme
 = 
	`sdsÿ’
Òame,
ho¡
->
±r
,
	`sd¦’
(host->ptr));

4713 
Çme
 = 
	`sdsÿ’
(name,":",1);

4714 
Çme
 = 
	`sdsÿ’
Òame,
pÜt
->
±r
,
	`sd¦’
(port->ptr));

4715 
cs
 = 
	`diùF‘chV®ue
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4716 ià(!
cs
) {

4717 
	`sdsä“
(
Çme
);

4721 
	`şo£
(
cs
->
fd
);

4722 
	`zä“
(
cs
);

4723 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4724 
	`sdsä“
(
Çme
);

4725 
	}
}

4727 
	$mig¿‹Clo£TimedoutSock‘s
() {

4728 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
mig¿‹_ÿched_sock‘s
);

4729 
diùEÁry
 *
de
;

4731 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4732 
mig¿‹CachedSock‘
 *
cs
 = 
	`diùG‘V®
(
de
);

4734 ià((
£rv”
.
unixtime
 - 
cs
->
Ï¡_u£_time
è> 
MIGRATE_SOCKET_CACHE_TTL
) {

4735 
	`şo£
(
cs
->
fd
);

4736 
	`zä“
(
cs
);

4737 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
	`diùG‘Key
(
de
));

4740 
	`diùR–—£I‹¿tÜ
(
di
);

4741 
	}
}

4748 
	$mig¿‹Commªd
(
ş›Á
 *
c
) {

4749 
mig¿‹CachedSock‘
 *
cs
;

4750 
cİy
, 
»¶aû
, 
j
;

4751 
timeout
;

4752 
dbid
;

4753 
‰l
, 
expœ—t
;

4754 
robj
 **
ov
 = 
NULL
;

4755 
robj
 **
kv
 = 
NULL
;

4756 
robj
 **
Ãw¬gv
 = 
NULL
;

4757 
rio
 
cmd
, 
·ylßd
;

4758 
may_»Œy
 = 1;

4759 
wr™e_”rÜ
 = 0;

4762 
fœ¡_key
 = 3;

4763 
num_keys
 = 1;

4766 
cİy
 = 0;

4767 
»¶aû
 = 0;

4768 
‰l
 = 0;

4771 
j
 = 6; j < 
c
->
¬gc
; j++) {

4772 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"copy")) {

4773 
cİy
 = 1;

4774 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"replace")) {

4775 
»¶aû
 = 1;

4776 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"keys")) {

4777 ià(
	`sd¦’
(
c
->
¬gv
[3]->
±r
) != 0) {

4778 
	`addR•lyE¼Ü
(
c
,

4783 
fœ¡_key
 = 
j
+1;

4784 
num_keys
 = 
c
->
¬gc
 - 
j
 - 1;

4787 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4793 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[5],&
timeout
,
NULL
è!ğ
C_OK
 ||

4794 
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
dbid
,
NULL
è!ğ
C_OK
)

4798 ià(
timeout
 <= 0)imeout = 1000;

4805 
ov
 = 
	`z»®loc
(ov,(
robj
*)*
num_keys
);

4806 
kv
 = 
	`z»®loc
(kv,(
robj
*)*
num_keys
);

4807 
oi
 = 0;

4809 
j
 = 0; j < 
num_keys
; j++) {

4810 ià((
ov
[
oi
] = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
fœ¡_key
+
j
])è!ğ
NULL
) {

4811 
kv
[
oi
] = 
c
->
¬gv
[
fœ¡_key
+
j
];

4812 
oi
++;

4815 
num_keys
 = 
oi
;

4816 ià(
num_keys
 == 0) {

4817 
	`zä“
(
ov
); zä“(
kv
);

4818 
	`addR•lySds
(
c
,
	`sd¢ew
("+NOKEY\r\n"));

4822 
Œy_agaš
:

4823 
wr™e_”rÜ
 = 0;

4826 
cs
 = 
	`mig¿‹G‘Sock‘
(
c
,c->
¬gv
[1],c->¬gv[2],
timeout
);

4827 ià(
cs
 =ğ
NULL
) {

4828 
	`zä“
(
ov
); zä“(
kv
);

4832 
	`rioIn™W™hBufãr
(&
cmd
,
	`sd£m±y
());

4835 
£Ëù
 = 
cs
->
Ï¡_dbid
 !ğ
dbid
;

4836 ià(
£Ëù
) {

4837 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkCouÁ
(&
cmd
,'*',2));

4838 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"SELECT",6));

4839 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkLÚgLÚg
(&
cmd
,
dbid
));

4843 
j
 = 0; j < 
num_keys
; j++) {

4844 
expœ—t
 = 
	`g‘Expœe
(
c
->
db
,
kv
[
j
]);

4845 ià(
expœ—t
 != -1) {

4846 
‰l
 = 
expœ—t
-
	`m¡ime
();

4847 ià(
‰l
 < 1)tl = 1;

4849 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkCouÁ
(&
cmd
,'*',
»¶aû
 ? 5 : 4));

4850 ià(
£rv”
.
şu¡”_’abËd
)

4851 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,

4852 
	`rioWr™eBulkSŒšg
(&
cmd
,"RESTORE-ASKING",14));

4854 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"RESTORE",7));

4855 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`sdsEncodedObjeù
(
kv
[
j
]));

4856 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,
kv
[
j
]->
±r
,

4857 
	`sd¦’
(
kv
[
j
]->
±r
)));

4858 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkLÚgLÚg
(&
cmd
,
‰l
));

4862 
	`ü—‹DumpPaylßd
(&
·ylßd
,
ov
[
j
]);

4863 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,

4864 
	`rioWr™eBulkSŒšg
(&
cmd
,
·ylßd
.
io
.
bufãr
.
±r
,

4865 
	`sd¦’
(
·ylßd
.
io
.
bufãr
.
±r
)));

4866 
	`sdsä“
(
·ylßd
.
io
.
bufãr
.
±r
);

4870 ià(
»¶aû
)

4871 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"REPLACE",7));

4875 
”ºo
 = 0;

4877 
sds
 
buf
 = 
cmd
.
io
.
bufãr
.
±r
;

4878 
size_t
 
pos
 = 0, 
towr™e
;

4879 
nwr™‹n
 = 0;

4881 (
towr™e
 = 
	`sd¦’
(
buf
)-
pos
) > 0) {

4882 
towr™e
 = (towrite > (64*1024) ? (64*1024) :owrite);

4883 
nwr™‹n
 = 
	`syncWr™e
(
cs
->
fd
,
buf
+
pos
,
towr™e
,
timeout
);

4884 ià(
nwr™‹n
 !ğ(sigÃd)
towr™e
) {

4885 
wr™e_”rÜ
 = 1;

4886 
sock‘_”r
;

4888 
pos
 +ğ
nwr™‹n
;

4892 
buf1
[1024];

4893 
buf2
[1024];

4896 ià(
£Ëù
 && 
	`syncR—dLše
(
cs
->
fd
, 
buf1
, (buf1), 
timeout
) <= 0)

4897 
sock‘_”r
;

4900 
”rÜ_äom_rg‘
 = 0;

4901 
sock‘_”rÜ
 = 0;

4902 
d–_idx
 = 1;

4904 ià(!
cİy
è
Ãw¬gv
 = 
	`zm®loc
((
robj
*)*(
num_keys
+1));

4906 
j
 = 0; j < 
num_keys
; j++) {

4907 ià(
	`syncR—dLše
(
cs
->
fd
, 
buf2
, (buf2), 
timeout
) <= 0) {

4908 
sock‘_”rÜ
 = 1;

4911 ià((
£Ëù
 && 
buf1
[0] =ğ'-'è|| 
buf2
[0] == '-') {

4913 ià(!
”rÜ_äom_rg‘
) {

4914 
cs
->
Ï¡_dbid
 = -1;

4915 
	`addR•lyE¼ÜFÜm©
(
c
,"Target instance„eplied withƒrror: %s",

4916 (
£Ëù
 && 
buf1
[0] =ğ'-'è? buf1+1 : 
buf2
+1);

4917 
”rÜ_äom_rg‘
 = 1;

4920 ià(!
cİy
) {

4922 
	`dbD–‘e
(
c
->
db
,
kv
[
j
]);

4923 
	`sigÇlModif›dKey
(
c
->
db
,
kv
[
j
]);

4924 
£rv”
.
dœty
++;

4927 
Ãw¬gv
[
d–_idx
++] = 
kv
[
j
];

4928 
	`šüRefCouÁ
(
kv
[
j
]);

4936 ià(!
”rÜ_äom_rg‘
 && 
sock‘_”rÜ
 && 
j
 =ğ0 && 
may_»Œy
 &&

4937 
”ºo
 !ğ
ETIMEDOUT
)

4939 
sock‘_”r
;

4942 ià(!
cİy
) {

4944 ià(
d–_idx
 > 1) {

4945 
Ãw¬gv
[0] = 
	`ü—‹SŒšgObjeù
("DEL",3);

4947 
	`»¶aûCl›ÁCommªdVeùÜ
(
c
,
d–_idx
,
Ãw¬gv
);

4950 
	`zä“
(
Ãw¬gv
);

4952 
Ãw¬gv
 = 
NULL
;

4958 ià(!
”rÜ_äom_rg‘
 && 
sock‘_”rÜ
) {

4959 
may_»Œy
 = 0;

4960 
sock‘_”r
;

4963 ià(!
”rÜ_äom_rg‘
) {

4966 
cs
->
Ï¡_dbid
 = 
dbid
;

4967 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4973 
	`sdsä“
(
cmd
.
io
.
bufãr
.
±r
);

4974 
	`zä“
(
ov
); zä“(
kv
); zä“(
Ãw¬gv
);

4975 ià(
sock‘_”rÜ
è
	`mig¿‹Clo£Sock‘
(
c
->
¬gv
[1],c->argv[2]);

4981 
sock‘_”r
:

4984 
	`sdsä“
(
cmd
.
io
.
bufãr
.
±r
);

4985 
	`mig¿‹Clo£Sock‘
(
c
->
¬gv
[1],c->argv[2]);

4986 
	`zä“
(
Ãw¬gv
);

4987 
Ãw¬gv
 = 
NULL
;

4991 ià(
”ºo
 !ğ
ETIMEDOUT
 && 
may_»Œy
) {

4992 
may_»Œy
 = 0;

4993 
Œy_agaš
;

4997 
	`zä“
(
ov
); zä“(
kv
);

4998 
	`addR•lySds
(
c
,

4999 
	`sdsÿrštf
(
	`sd£m±y
(),

5001 
wr™e_”rÜ
 ? "writing" : "reading"));

5003 
	}
}

5013 
	$askšgCommªd
(
ş›Á
 *
c
) {

5014 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

5015 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

5018 
c
->
æags
 |ğ
CLIENT_ASKING
;

5019 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5020 
	}
}

5025 
	$»adÚlyCommªd
(
ş›Á
 *
c
) {

5026 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

5027 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

5030 
c
->
æags
 |ğ
CLIENT_READONLY
;

5031 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5032 
	}
}

5035 
	$»adwr™eCommªd
(
ş›Á
 *
c
) {

5036 
c
->
æags
 &ğ~
CLIENT_READONLY
;

5037 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5038 
	}
}

5072 
şu¡”Node
 *
	$g‘NodeByQu”y
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
hash¦Ù
, *
”rÜ_code
) {

5073 
şu¡”Node
 *
n
 = 
NULL
;

5074 
robj
 *
fœ¡key
 = 
NULL
;

5075 
muÉË_keys
 = 0;

5076 
muÉiS‹
 *
ms
, 
_ms
;

5077 
muÉiCmd
 
mc
;

5078 
i
, 
¦Ù
 = 0, 
mig¿tšg_¦Ù
 = 0, 
impÜtšg_¦Ù
 = 0, 
missšg_keys
 = 0;

5081 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_NONE
;

5085 ià(
cmd
->
´oc
 =ğ
execCommªd
) {

5088 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)è 
my£lf
;

5089 
ms
 = &
c
->
m¡©e
;

5094 
ms
 = &
_ms
;

5095 
_ms
.
commªds
 = &
mc
;

5096 
_ms
.
couÁ
 = 1;

5097 
mc
.
¬gv
 =‡rgv;

5098 
mc
.
¬gc
 =‡rgc;

5099 
mc
.
cmd
 = cmd;

5104 
i
 = 0; i < 
ms
->
couÁ
; i++) {

5105 
»disCommªd
 *
mcmd
;

5106 
robj
 **
m¬gv
;

5107 
m¬gc
, *
keyšdex
, 
numkeys
, 
j
;

5109 
mcmd
 = 
ms
->
commªds
[
i
].
cmd
;

5110 
m¬gc
 = 
ms
->
commªds
[
i
].
¬gc
;

5111 
m¬gv
 = 
ms
->
commªds
[
i
].
¬gv
;

5113 
keyšdex
 = 
	`g‘KeysFromCommªd
(
mcmd
,
m¬gv
,
m¬gc
,&
numkeys
);

5114 
j
 = 0; j < 
numkeys
; j++) {

5115 
robj
 *
thiskey
 = 
m¬gv
[
keyšdex
[
j
]];

5116 
this¦Ù
 = 
	`keyHashSlÙ
((*)
thiskey
->
±r
,

5117 
	`sd¦’
(
thiskey
->
±r
));

5119 ià(
fœ¡key
 =ğ
NULL
) {

5122 
fœ¡key
 = 
thiskey
;

5123 
¦Ù
 = 
this¦Ù
;

5124 
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

5130 ià(
n
 =ğ
NULL
) {

5131 
	`g‘KeysF»eResuÉ
(
keyšdex
);

5132 ià(
”rÜ_code
)

5133 *
”rÜ_code
 = 
CLUSTER_REDIR_DOWN_UNBOUND
;

5134  
NULL
;

5142 ià(
n
 =ğ
my£lf
 &&

5143 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] !ğ
NULL
)

5145 
mig¿tšg_¦Ù
 = 1;

5146 } ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] !ğ
NULL
) {

5147 
impÜtšg_¦Ù
 = 1;

5152 ià(!
	`equ®SŒšgObjeùs
(
fœ¡key
,
thiskey
)) {

5153 ià(
¦Ù
 !ğ
this¦Ù
) {

5155 
	`g‘KeysF»eResuÉ
(
keyšdex
);

5156 ià(
”rÜ_code
)

5157 *
”rÜ_code
 = 
CLUSTER_REDIR_CROSS_SLOT
;

5158  
NULL
;

5162 
muÉË_keys
 = 1;

5168 ià((
mig¿tšg_¦Ù
 || 
impÜtšg_¦Ù
) &&

5169 
	`lookupKeyR—d
(&
£rv”
.
db
[0],
thiskey
è=ğ
NULL
)

5171 
missšg_keys
++;

5174 
	`g‘KeysF»eResuÉ
(
keyšdex
);

5179 ià(
n
 =ğ
NULL
è 
my£lf
;

5182 ià(
£rv”
.
şu¡”
->
¡©e
 !ğ
CLUSTER_OK
) {

5183 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_DOWN_STATE
;

5184  
NULL
;

5188 ià(
hash¦Ù
è*hash¦Ù = 
¦Ù
;

5193 ià((
mig¿tšg_¦Ù
 || 
impÜtšg_¦Ù
è&& 
cmd
->
´oc
 =ğ
mig¿‹Commªd
)

5194  
my£lf
;

5198 ià(
mig¿tšg_¦Ù
 && 
missšg_keys
) {

5199 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_ASK
;

5200  
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
];

5207 ià(
impÜtšg_¦Ù
 &&

5208 (
c
->
æags
 & 
CLIENT_ASKING
 || 
cmd
->æag & 
CMD_ASKING
))

5210 ià(
muÉË_keys
 && 
missšg_keys
) {

5211 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_UNSTABLE
;

5212  
NULL
;

5214  
my£lf
;

5221 ià(
c
->
æags
 & 
CLIENT_READONLY
 &&

5222 
cmd
->
æags
 & 
CMD_READONLY
 &&

5223 
	`nodeIsSÏve
(
my£lf
) &&

5224 
my£lf
->
¦aveof
 =ğ
n
)

5226  
my£lf
;

5231 ià(
n
 !ğ
my£lf
 && 
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_MOVED
;

5232  
n
;

5233 
	}
}

5242 
	$şu¡”RedœeùCl›Á
(
ş›Á
 *
c
, 
şu¡”Node
 *
n
, 
hash¦Ù
, 
”rÜ_code
) {

5243 ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_CROSS_SLOT
) {

5244 
	`addR•lySds
(
c
,
	`sd¢ew
("-CROSSSLOT Keys in„equest don't hashohe same slot\r\n"));

5245 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_UNSTABLE
) {

5249 
	`addR•lySds
(
c
,
	`sd¢ew
("-TRYAGAIN Multiple keys„equest during„ehashing of slot\r\n"));

5250 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_DOWN_STATE
) {

5251 
	`addR•lySds
(
c
,
	`sd¢ew
("-CLUSTERDOWN The cluster is down\r\n"));

5252 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_DOWN_UNBOUND
) {

5253 
	`addR•lySds
(
c
,
	`sd¢ew
("-CLUSTERDOWN Hash slot‚ot served\r\n"));

5254 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_MOVED
 ||

5255 
”rÜ_code
 =ğ
CLUSTER_REDIR_ASK
)

5257 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),

5259 (
”rÜ_code
 =ğ
CLUSTER_REDIR_ASK
) ? "ASK" : "MOVED",

5260 
hash¦Ù
,
n
->

,n->
pÜt
));

5262 
	`£rv”Pªic
("getNodeByQuery() unknownƒrror.");

5264 
	}
}

5277 
	$şu¡”RedœeùBlockedCl›ÁIfN“ded
(
ş›Á
 *
c
) {

5278 ià(
c
->
æags
 & 
CLIENT_BLOCKED
 && c->
bty³
 =ğ
BLOCKED_LIST
) {

5279 
diùEÁry
 *
de
;

5280 
diùI‹¿tÜ
 *
di
;

5283 ià(
£rv”
.
şu¡”
->
¡©e
 =ğ
CLUSTER_FAIL
) {

5284 
	`şu¡”RedœeùCl›Á
(
c
,
NULL
,0,
CLUSTER_REDIR_DOWN_STATE
);

5288 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

5289 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

5290 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

5291 
¦Ù
 = 
	`keyHashSlÙ
((*)
key
->
±r
, 
	`sd¦’
(key->ptr));

5292 
şu¡”Node
 *
node
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

5297 ià(
node
 !ğ
my£lf
 &&

5298 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] =ğ
NULL
)

5300 ià(
node
 =ğ
NULL
) {

5301 
	`şu¡”RedœeùCl›Á
(
c
,
NULL
,0,

5302 
CLUSTER_REDIR_DOWN_UNBOUND
);

5304 
	`şu¡”RedœeùCl›Á
(
c
,
node
,
¦Ù
,

5305 
CLUSTER_REDIR_MOVED
);

5310 
	`diùR–—£I‹¿tÜ
(
di
);

5313 
	}
}

	@cluster.h

1 #iâdeà
__CLUSTER_H


2 
	#__CLUSTER_H


	)

8 
	#CLUSTER_SLOTS
 16384

	)

9 
	#CLUSTER_OK
 0

	)

10 
	#CLUSTER_FAIL
 1

	)

11 
	#CLUSTER_NAMELEN
 40

	)

12 
	#CLUSTER_PORT_INCR
 10000

	)

16 
	#CLUSTER_DEFAULT_NODE_TIMEOUT
 15000

	)

17 
	#CLUSTER_DEFAULT_SLAVE_VALIDITY
 10

	)

18 
	#CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
 1

	)

19 
	#CLUSTER_FAIL_REPORT_VALIDITY_MULT
 2

	)

20 
	#CLUSTER_FAIL_UNDO_TIME_MULT
 2

	)

21 
	#CLUSTER_FAIL_UNDO_TIME_ADD
 10

	)

22 
	#CLUSTER_FAILOVER_DELAY
 5

	)

23 
	#CLUSTER_DEFAULT_MIGRATION_BARRIER
 1

	)

24 
	#CLUSTER_MF_TIMEOUT
 5000

	)

25 
	#CLUSTER_MF_PAUSE_MULT
 2

	)

26 
	#CLUSTER_SLAVE_MIGRATION_DELAY
 5000

	)

29 
	#CLUSTER_REDIR_NONE
 0

	)

30 
	#CLUSTER_REDIR_CROSS_SLOT
 1

	)

31 
	#CLUSTER_REDIR_UNSTABLE
 2

	)

32 
	#CLUSTER_REDIR_ASK
 3

	)

33 
	#CLUSTER_REDIR_MOVED
 4

	)

34 
	#CLUSTER_REDIR_DOWN_STATE
 5

	)

35 
	#CLUSTER_REDIR_DOWN_UNBOUND
 6

	)

37 
	gşu¡”Node
;

40 
	sşu¡”Lšk
 {

41 
m¡ime_t
 
	mùime
;

42 
	mfd
;

43 
sds
 
	m¢dbuf
;

44 
sds
 
	mrcvbuf
;

45 
şu¡”Node
 *
	mnode
;

46 } 
	tşu¡”Lšk
;

49 
	#CLUSTER_NODE_MASTER
 1

	)

50 
	#CLUSTER_NODE_SLAVE
 2

	)

51 
	#CLUSTER_NODE_PFAIL
 4

	)

52 
	#CLUSTER_NODE_FAIL
 8

	)

53 
	#CLUSTER_NODE_MYSELF
 16

	)

54 
	#CLUSTER_NODE_HANDSHAKE
 32

	)

55 
	#CLUSTER_NODE_NOADDR
 64

	)

56 
	#CLUSTER_NODE_MEET
 128

	)

57 
	#CLUSTER_NODE_MIGRATE_TO
 256

	)

58 
	#CLUSTER_NODE_NULL_NAME
 "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"

	)

60 
	#nodeIsMa¡”
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_MASTER
)

	)

61 
	#nodeIsSÏve
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_SLAVE
)

	)

62 
	#nodeInHªdshake
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_HANDSHAKE
)

	)

63 
	#nodeHasAddr
(
n
è(!(Ò)->
æags
 & 
CLUSTER_NODE_NOADDR
))

	)

64 
	#nodeW™houtAddr
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_NOADDR
)

	)

65 
	#nodeTimedOut
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_PFAIL
)

	)

66 
	#nodeFaed
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_FAIL
)

	)

69 
	#CLUSTER_CANT_FAILOVER_NONE
 0

	)

70 
	#CLUSTER_CANT_FAILOVER_DATA_AGE
 1

	)

71 
	#CLUSTER_CANT_FAILOVER_WAITING_DELAY
 2

	)

72 
	#CLUSTER_CANT_FAILOVER_EXPIRED
 3

	)

73 
	#CLUSTER_CANT_FAILOVER_WAITING_VOTES
 4

	)

74 
	#CLUSTER_CANT_FAILOVER_RELOG_PERIOD
 (60*5è

	)

77 
	sşu¡”NodeFaR•Üt
 {

78 
şu¡”Node
 *
	mnode
;

79 
m¡ime_t
 
	mtime
;

80 } 
	tşu¡”NodeFaR•Üt
;

82 
	sşu¡”Node
 {

83 
m¡ime_t
 
	mùime
;

84 
	mÇme
[
CLUSTER_NAMELEN
];

85 
	mæags
;

86 
ušt64_t
 
	mcÚfigEpoch
;

87 
	m¦Ùs
[
CLUSTER_SLOTS
/8];

88 
	mnum¦Ùs
;

89 
	mnum¦aves
;

90 
şu¡”Node
 **
	m¦aves
;

91 
şu¡”Node
 *
	m¦aveof
;

95 
m¡ime_t
 
	mpšg_£Á
;

96 
m¡ime_t
 
	mpÚg_»ûived
;

97 
m¡ime_t
 
	mç_time
;

98 
m¡ime_t
 
	mvÙed_time
;

99 
m¡ime_t
 
	m»¶_off£t_time
;

100 
m¡ime_t
 
	mÜphªed_time
;

101 
	m»¶_off£t
;

102 
	m
[
NET_IP_STR_LEN
];

103 
	mpÜt
;

104 
	mıÜt
;

105 
şu¡”Lšk
 *
	mlšk
;

106 
li¡
 *
	mç_»pÜts
;

107 } 
	tşu¡”Node
;

109 
	sşu¡”S‹
 {

110 
şu¡”Node
 *
	mmy£lf
;

111 
ušt64_t
 
	mcu¼’tEpoch
;

112 
	m¡©e
;

113 
	msize
;

114 
diù
 *
	mnodes
;

115 
diù
 *
	mnodes_bÏck_li¡
;

116 
şu¡”Node
 *
	mmig¿tšg_¦Ùs_to
[
CLUSTER_SLOTS
];

117 
şu¡”Node
 *
	mimpÜtšg_¦Ùs_äom
[
CLUSTER_SLOTS
];

118 
şu¡”Node
 *
	m¦Ùs
[
CLUSTER_SLOTS
];

119 
zskli¡
 *
	m¦Ùs_to_keys
;

121 
m¡ime_t
 
	mçov”_auth_time
;

122 
	mçov”_auth_couÁ
;

123 
	mçov”_auth_£Á
;

124 
	mçov”_auth_¿nk
;

125 
ušt64_t
 
	mçov”_auth_•och
;

126 
	mÿÁ_çov”_»asÚ
;

129 
m¡ime_t
 
	mmf_’d
;

132 
şu¡”Node
 *
	mmf_¦ave
;

134 
	mmf_ma¡”_off£t
;

136 
	mmf_ÿn_¡¬t
;

139 
ušt64_t
 
	mÏ¡VÙeEpoch
;

140 
	mtodo_befÜe_¦“p
;

141 
	m¡©s_bus_mes§ges_£Á
;

142 
	m¡©s_bus_mes§ges_»ûived
;

143 } 
	tşu¡”S‹
;

146 
	#CLUSTER_TODO_HANDLE_FAILOVER
 (1<<0)

	)

147 
	#CLUSTER_TODO_UPDATE_STATE
 (1<<1)

	)

148 
	#CLUSTER_TODO_SAVE_CONFIG
 (1<<2)

	)

149 
	#CLUSTER_TODO_FSYNC_CONFIG
 (1<<3)

	)

157 
	#CLUSTERMSG_TYPE_PING
 0

	)

158 
	#CLUSTERMSG_TYPE_PONG
 1

	)

159 
	#CLUSTERMSG_TYPE_MEET
 2

	)

160 
	#CLUSTERMSG_TYPE_FAIL
 3

	)

161 
	#CLUSTERMSG_TYPE_PUBLISH
 4

	)

162 
	#CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
 5

	)

163 
	#CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
 6

	)

164 
	#CLUSTERMSG_TYPE_UPDATE
 7

	)

165 
	#CLUSTERMSG_TYPE_MFSTART
 8

	)

171 
	mnod’ame
[
CLUSTER_NAMELEN
];

172 
ušt32_t
 
	mpšg_£Á
;

173 
ušt32_t
 
	mpÚg_»ûived
;

174 
	m
[
NET_IP_STR_LEN
];

175 
ušt16_t
 
	mpÜt
;

176 
ušt16_t
 
	mıÜt
;

177 
ušt16_t
 
	mæags
;

178 
ušt32_t
 
	mnÙu£d1
;

179 } 
	tşu¡”MsgD©aGoss
;

182 
	mnod’ame
[
CLUSTER_NAMELEN
];

183 } 
	tşu¡”MsgD©aFa
;

186 
ušt32_t
 
	mchªÃl_Ën
;

187 
ušt32_t
 
	mmes§ge_Ën
;

191 
	mbulk_d©a
[8];

192 } 
	tşu¡”MsgD©aPublish
;

195 
ušt64_t
 
	mcÚfigEpoch
;

196 
	mnod’ame
[
CLUSTER_NAMELEN
];

197 
	m¦Ùs
[
CLUSTER_SLOTS
/8];

198 } 
	tşu¡”MsgD©aUpd©e
;

200 
	uşu¡”MsgD©a
 {

204 
şu¡”MsgD©aGoss
 
	mgoss
[1];

205 } 
	mpšg
;

209 
şu¡”MsgD©aFa
 
	mabout
;

210 } 
	mç
;

214 
şu¡”MsgD©aPublish
 
	mmsg
;

215 } 
	mpublish
;

219 
şu¡”MsgD©aUpd©e
 
	mnodecfg
;

220 } 
	mupd©e
;

223 
	#CLUSTER_PROTO_VER
 1

	)

226 
	msig
[4];

227 
ušt32_t
 
	mtÙËn
;

228 
ušt16_t
 
	mv”
;

229 
ušt16_t
 
	mpÜt
;

230 
ušt16_t
 
	mty³
;

231 
ušt16_t
 
	mcouÁ
;

232 
ušt64_t
 
	mcu¼’tEpoch
;

233 
ušt64_t
 
	mcÚfigEpoch
;

236 
ušt64_t
 
	moff£t
;

238 
	m£nd”
[
CLUSTER_NAMELEN
];

239 
	mmy¦Ùs
[
CLUSTER_SLOTS
/8];

240 
	m¦aveof
[
CLUSTER_NAMELEN
];

241 
	mmy
[
NET_IP_STR_LEN
];

242 
	mnÙu£d1
[34];

243 
ušt16_t
 
	mıÜt
;

244 
ušt16_t
 
	mæags
;

245 
	m¡©e
;

246 
	mmæags
[3];

247 
şu¡”MsgD©a
 
	md©a
;

248 } 
	tşu¡”Msg
;

250 
	#CLUSTERMSG_MIN_LEN
 ((
şu¡”Msg
)-(
şu¡”MsgD©a
))

	)

254 
	#CLUSTERMSG_FLAG0_PAUSED
 (1<<0è

	)

255 
	#CLUSTERMSG_FLAG0_FORCEACK
 (1<<1è

	)

259 
şu¡”Node
 *
g‘NodeByQu”y
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
hash¦Ù
, *
ask
);

260 
şu¡”RedœeùBlockedCl›ÁIfN“ded
(
ş›Á
 *
c
);

261 
şu¡”RedœeùCl›Á
(
ş›Á
 *
c
, 
şu¡”Node
 *
n
, 
hash¦Ù
, 
”rÜ_code
);

	@config.c

31 
	~"£rv”.h
"

32 
	~"şu¡”.h
"

34 
	~<fú.h
>

35 
	~<sys/¡©.h
>

41 
	scÚfigEnum
 {

42 cÚ¡ *
	mÇme
;

43 cÚ¡ 
	mv®
;

44 } 
	tcÚfigEnum
;

46 
cÚfigEnum
 
	gmaxmemÜy_pŞicy_’um
[] = {

47 {"vŞ©e-Ìu", 
MAXMEMORY_VOLATILE_LRU
},

48 {"vŞ©e-lfu", 
MAXMEMORY_VOLATILE_LFU
},

49 {"vŞ©e-¿ndom",
MAXMEMORY_VOLATILE_RANDOM
},

50 {"vŞ©e-‰l",
MAXMEMORY_VOLATILE_TTL
},

51 {"®lkeys-Ìu",
MAXMEMORY_ALLKEYS_LRU
},

52 {"®lkeys-lfu",
MAXMEMORY_ALLKEYS_LFU
},

53 {"®lkeys-¿ndom",
MAXMEMORY_ALLKEYS_RANDOM
},

54 {"nÛviùiÚ",
MAXMEMORY_NO_EVICTION
},

55 {
NULL
, 0}

58 
cÚfigEnum
 
	gsy¦og_çc™y_’um
[] = {

59 {"u£r", 
LOG_USER
},

60 {"loÿl0", 
LOG_LOCAL0
},

61 {"loÿl1", 
LOG_LOCAL1
},

62 {"loÿl2", 
LOG_LOCAL2
},

63 {"loÿl3", 
LOG_LOCAL3
},

64 {"loÿl4", 
LOG_LOCAL4
},

65 {"loÿl5", 
LOG_LOCAL5
},

66 {"loÿl6", 
LOG_LOCAL6
},

67 {"loÿl7", 
LOG_LOCAL7
},

68 {
NULL
, 0}

71 
cÚfigEnum
 
	glogËv–_’um
[] = {

72 {"debug", 
LL_DEBUG
},

73 {"v”bo£", 
LL_VERBOSE
},

74 {"nÙiû", 
LL_NOTICE
},

75 {"w¬nšg", 
LL_WARNING
},

76 {
NULL
,0}

79 
cÚfigEnum
 
	gsu³rvi£d_mode_’um
[] = {

80 {"up¡¬t", 
SUPERVISED_UPSTART
},

81 {"sy¡emd", 
SUPERVISED_SYSTEMD
},

82 {"auto", 
SUPERVISED_AUTODETECT
},

83 {"no", 
SUPERVISED_NONE
},

84 {
NULL
, 0}

87 
cÚfigEnum
 
	gaof_fsync_’um
[] = {

88 {"ev”y£c", 
AOF_FSYNC_EVERYSEC
},

89 {"®ways", 
AOF_FSYNC_ALWAYS
},

90 {"no", 
AOF_FSYNC_NO
},

91 {
NULL
, 0}

95 
ş›ÁBufãrLim™sCÚfig
 
	gş›ÁBufãrLim™sDeçuÉs
[
CLIENT_TYPE_OBUF_COUNT
] = {

106 
	$cÚfigEnumG‘V®ue
(
cÚfigEnum
 *
û
, *
Çme
) {

107 
û
->
Çme
 !ğ
NULL
) {

108 ià(!
	`¡rÿ£cmp
(
û
->
Çme
,Çme)è ce->
v®
;

109 
û
++;

111  
INT_MIN
;

112 
	}
}

115 cÚ¡ *
	$cÚfigEnumG‘Name
(
cÚfigEnum
 *
û
, 
v®
) {

116 
û
->
Çme
 !ğ
NULL
) {

117 ià(
û
->
v®
 =ğv®è ce->
Çme
;

118 
û
++;

120  
NULL
;

121 
	}
}

125 cÚ¡ *
	$cÚfigEnumG‘NameOrUnknown
(
cÚfigEnum
 *
û
, 
v®
) {

126 cÚ¡ *
Çme
 = 
	`cÚfigEnumG‘Name
(
û
,
v®
);

127  
Çme
 ?‚ame : "unknown";

128 
	}
}

131 cÚ¡ *
	$eviùPŞicyToSŒšg
() {

132  
	`cÚfigEnumG‘NameOrUnknown
(
maxmemÜy_pŞicy_’um
,
£rv”
.
maxmemÜy_pŞicy
);

133 
	}
}

139 
	$ye¢Ùoi
(*
s
) {

140 ià(!
	`¡rÿ£cmp
(
s
,"yes"))  1;

141 ià(!
	`¡rÿ£cmp
(
s
,"no"))  0;

143 
	}
}

145 
	$­³ndS”v”SaveP¬ams
(
time_t
 
£cÚds
, 
chªges
) {

146 
£rv”
.
§v•¬ams
 = 
	`z»®loc
(£rv”.§v•¬ams,(
§v•¬am
)*(£rv”.
§v•¬am¦’
+1));

147 
£rv”
.
§v•¬ams
[£rv”.
§v•¬am¦’
].
£cÚds
 = seconds;

148 
£rv”
.
§v•¬ams
[£rv”.
§v•¬am¦’
].
chªges
 = changes;

149 
£rv”
.
§v•¬am¦’
++;

150 
	}
}

152 
	$»£tS”v”SaveP¬ams
() {

153 
	`zä“
(
£rv”
.
§v•¬ams
);

154 
£rv”
.
§v•¬ams
 = 
NULL
;

155 
£rv”
.
§v•¬am¦’
 = 0;

156 
	}
}

158 
	$queueLßdModuË
(
sds
 
·th
, sd *
¬gv
, 
¬gc
) {

159 
i
;

160 
moduËLßdQueueEÁry
 *
lßdmod
;

162 
lßdmod
 = 
	`zm®loc
((
moduËLßdQueueEÁry
));

163 
lßdmod
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

164 
lßdmod
->
·th
 = 
	`sd¢ew
(path);

165 
lßdmod
->
¬gc
 =‡rgc;

166 
i
 = 0; i < 
¬gc
; i++) {

167 
lßdmod
->
¬gv
[
i
] = 
	`ü—‹RawSŒšgObjeù
×rgv[i],
	`sd¦’
(argv[i]));

169 
	`li¡AddNodeTa
(
£rv”
.
lßdmoduË_queue
,
lßdmod
);

170 
	}
}

172 
	$lßdS”v”CÚfigFromSŒšg
(*
cÚfig
) {

173 *
”r
 = 
NULL
;

174 
lš’um
 = 0, 
tÙlšes
, 
i
;

175 
¦aveof_lš’um
 = 0;

176 
sds
 *
lšes
;

178 
lšes
 = 
	`sds¥l™Ën
(
cÚfig
,
	`¡¾’
(cÚfig),"\n",1,&
tÙlšes
);

180 
i
 = 0; i < 
tÙlšes
; i++) {

181 
sds
 *
¬gv
;

182 
¬gc
;

184 
lš’um
 = 
i
+1;

185 
lšes
[
i
] = 
	`sd¡rim
(lines[i]," \t\r\n");

188 ià(
lšes
[
i
][0] == '#' ||†ines[i][0] == '\0') ;

191 
¬gv
 = 
	`sds¥l™¬gs
(
lšes
[
i
],&
¬gc
);

192 ià(
¬gv
 =ğ
NULL
) {

193 
”r
 = "Unbalanced quotes in configuration†ine";

194 
lßd”r
;

198 ià(
¬gc
 == 0) {

199 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

202 
	`sd¡Şow”
(
¬gv
[0]);

205 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"timeout"è&& 
¬gc
 == 2) {

206 
£rv”
.
maxidËtime
 = 
	`©oi
(
¬gv
[1]);

207 ià(
£rv”
.
maxidËtime
 < 0) {

208 
”r
 = "Inv®idimeouˆv®ue"; 
lßd”r
;

210 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"tı-k“·live"è&& 
¬gc
 == 2) {

211 
£rv”
.
tık“·live
 = 
	`©oi
(
¬gv
[1]);

212 ià(
£rv”
.
tık“·live
 < 0) {

213 
”r
 = "Inv®idı-k“·livv®ue"; 
lßd”r
;

215 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"´Ùeùed-mode"è&& 
¬gc
 == 2) {

216 ià((
£rv”
.
´Ùeùed_mode
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

217 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

219 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"pÜt"è&& 
¬gc
 == 2) {

220 
£rv”
.
pÜt
 = 
	`©oi
(
¬gv
[1]);

221 ià(
£rv”
.
pÜt
 < 0 || server.port > 65535) {

222 
”r
 = "Inv®id…Üt"; 
lßd”r
;

224 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"tı-backlog"è&& 
¬gc
 == 2) {

225 
£rv”
.
tı_backlog
 = 
	`©oi
(
¬gv
[1]);

226 ià(
£rv”
.
tı_backlog
 < 0) {

227 
”r
 = "Inv®id backlog v®ue"; 
lßd”r
;

229 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"bšd"è&& 
¬gc
 >= 2) {

230 
j
, 
add»s£s
 = 
¬gc
-1;

232 ià(
add»s£s
 > 
CONFIG_BINDADDR_MAX
) {

233 
”r
 = "ToØmªy bšd‡dd»s£ ¥ecif›d"; 
lßd”r
;

235 
j
 = 0; j < 
add»s£s
; j++)

236 
£rv”
.
bšdaddr
[
j
] = 
	`z¡rdup
(
¬gv
[j+1]);

237 
£rv”
.
bšdaddr_couÁ
 = 
add»s£s
;

238 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"unixsock‘"è&& 
¬gc
 == 2) {

239 
£rv”
.
unixsock‘
 = 
	`z¡rdup
(
¬gv
[1]);

240 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"unixsock‘³rm"è&& 
¬gc
 == 2) {

241 
”ºo
 = 0;

242 
£rv”
.
unixsock‘³rm
 = (
mode_t
)
	`¡¹Ş
(
¬gv
[1], 
NULL
, 8);

243 ià(
”ºo
 || 
£rv”
.
unixsock‘³rm
 > 0777) {

244 
”r
 = "Inv®id sock‘ f³rmissiÚs"; 
lßd”r
;

246 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"save")) {

247 ià(
¬gc
 == 3) {

248 
£cÚds
 = 
	`©oi
(
¬gv
[1]);

249 
chªges
 = 
	`©oi
(
¬gv
[2]);

250 ià(
£cÚds
 < 1 || 
chªges
 < 0) {

251 
”r
 = "Inv®id sav·¿m‘”s"; 
lßd”r
;

253 
	`­³ndS”v”SaveP¬ams
(
£cÚds
,
chªges
);

254 } ià(
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
¬gv
[1],"")) {

255 
	`»£tS”v”SaveP¬ams
();

257 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"dœ"è&& 
¬gc
 == 2) {

258 ià(
	`chdœ
(
¬gv
[1]) == -1) {

259 
	`£rv”Log
(
LL_WARNING
,"Can't chdiro '%s': %s",

260 
¬gv
[1], 
	`¡»¼Ü
(
”ºo
));

261 
	`ex™
(1);

263 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"logËv–"è&& 
¬gc
 == 2) {

264 
£rv”
.
v”bos™y
 = 
	`cÚfigEnumG‘V®ue
(
logËv–_’um
,
¬gv
[1]);

265 ià(
£rv”
.
v”bos™y
 =ğ
INT_MIN
) {

266 
”r
 = "Invalid†og†evel. "

268 
lßd”r
;

270 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"logfe"è&& 
¬gc
 == 2) {

271 
FILE
 *
logå
;

273 
	`zä“
(
£rv”
.
logfe
);

274 
£rv”
.
logfe
 = 
	`z¡rdup
(
¬gv
[1]);

275 ià(
£rv”
.
logfe
[0] != '\0') {

278 
logå
 = 
	`fİ’
(
£rv”
.
logfe
,"a");

279 ià(
logå
 =ğ
NULL
) {

280 
”r
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

281 "Cª'ˆİ’hlog fe: %s", 
	`¡»¼Ü
(
”ºo
));

282 
lßd”r
;

284 
	`fşo£
(
logå
);

286 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-’abËd"è&& 
¬gc
 == 2) {

287 ià((
£rv”
.
sy¦og_’abËd
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

288 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

290 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-id’t"è&& 
¬gc
 == 2) {

291 ià(
£rv”
.
sy¦og_id’t
è
	`zä“
(server.syslog_ident);

292 
£rv”
.
sy¦og_id’t
 = 
	`z¡rdup
(
¬gv
[1]);

293 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-çc™y"è&& 
¬gc
 == 2) {

294 
£rv”
.
sy¦og_çc™y
 =

295 
	`cÚfigEnumG‘V®ue
(
sy¦og_çc™y_’um
,
¬gv
[1]);

296 ià(
£rv”
.
sy¦og_çc™y
 =ğ
INT_MIN
) {

297 
”r
 = "Invalid†og facility. Must be one of USER or between LOCAL0-LOCAL7";

298 
lßd”r
;

300 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"d©aba£s"è&& 
¬gc
 == 2) {

301 
£rv”
.
dbnum
 = 
	`©oi
(
¬gv
[1]);

302 ià(
£rv”
.
dbnum
 < 1) {

303 
”r
 = "Inv®id‚umb” oàd©aba£s"; 
lßd”r
;

305 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"šşude"è&& 
¬gc
 == 2) {

306 
	`lßdS”v”CÚfig
(
¬gv
[1],
NULL
);

307 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxş›Ás"è&& 
¬gc
 == 2) {

308 
£rv”
.
maxş›Ás
 = 
	`©oi
(
¬gv
[1]);

309 ià(
£rv”
.
maxş›Ás
 < 1) {

310 
”r
 = "Inv®id max cl›Á lim™"; 
lßd”r
;

312 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy"è&& 
¬gc
 == 2) {

313 
£rv”
.
maxmemÜy
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

314 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy-pŞicy"è&& 
¬gc
 == 2) {

315 
£rv”
.
maxmemÜy_pŞicy
 =

316 
	`cÚfigEnumG‘V®ue
(
maxmemÜy_pŞicy_’um
,
¬gv
[1]);

317 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
INT_MIN
) {

318 
”r
 = "Invalid maxmemory…olicy";

319 
lßd”r
;

321 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy-§m¶es"è&& 
¬gc
 == 2) {

322 
£rv”
.
maxmemÜy_§m¶es
 = 
	`©oi
(
¬gv
[1]);

323 ià(
£rv”
.
maxmemÜy_§m¶es
 <= 0) {

324 
”r
 = "maxmemory-samples must be 1 or greater";

325 
lßd”r
;

327 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lfu-log-çùÜ"è&& 
¬gc
 == 2) {

328 
£rv”
.
lfu_log_çùÜ
 = 
	`©oi
(
¬gv
[1]);

329 ià(
£rv”
.
maxmemÜy_§m¶es
 < 0) {

330 
”r
 = "lfu-log-factor must be 0 or greater";

331 
lßd”r
;

333 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lfu-deÿy-time"è&& 
¬gc
 == 2) {

334 
£rv”
.
lfu_deÿy_time
 = 
	`©oi
(
¬gv
[1]);

335 ià(
£rv”
.
maxmemÜy_§m¶es
 < 1) {

336 
”r
 = "lfu-decay-time must be 0 or greater";

337 
lßd”r
;

339 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦aveof"è&& 
¬gc
 == 3) {

340 
¦aveof_lš’um
 = 
lš’um
;

341 
£rv”
.
ma¡”ho¡
 = 
	`sd¢ew
(
¬gv
[1]);

342 
£rv”
.
ma¡”pÜt
 = 
	`©oi
(
¬gv
[2]);

343 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

344 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-pšg-¦ave-³riod"è&& 
¬gc
 == 2) {

345 
£rv”
.
»¶_pšg_¦ave_³riod
 = 
	`©oi
(
¬gv
[1]);

346 ià(
£rv”
.
»¶_pšg_¦ave_³riod
 <= 0) {

347 
”r
 = "repl-ping-slave-period must be 1 or greater";

348 
lßd”r
;

350 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-timeout"è&& 
¬gc
 == 2) {

351 
£rv”
.
»¶_timeout
 = 
	`©oi
(
¬gv
[1]);

352 ià(
£rv”
.
»¶_timeout
 <= 0) {

353 
”r
 = "repl-timeout must be 1 or greater";

354 
lßd”r
;

356 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-di§bË-tı-nod–ay"è&& 
¬gc
==2) {

357 ià((
£rv”
.
»¶_di§bË_tı_nod–ay
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

358 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

360 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-diskËss-sync"è&& 
¬gc
==2) {

361 ià((
£rv”
.
»¶_diskËss_sync
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

362 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

364 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-diskËss-sync-d–ay"è&& 
¬gc
==2) {

365 
£rv”
.
»¶_diskËss_sync_d–ay
 = 
	`©oi
(
¬gv
[1]);

366 ià(
£rv”
.
»¶_diskËss_sync_d–ay
 < 0) {

367 
”r
 = "repl-diskless-sync-delay can't be‚egative";

368 
lßd”r
;

370 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-backlog-size"è&& 
¬gc
 == 2) {

371 
size
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

372 ià(
size
 <= 0) {

373 
”r
 = "repl-backlog-size must be 1 or greater.";

374 
lßd”r
;

376 
	`»sizeR•liÿtiÚBacklog
(
size
);

377 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-backlog-‰l"è&& 
¬gc
 == 2) {

378 
£rv”
.
»¶_backlog_time_lim™
 = 
	`©oi
(
¬gv
[1]);

379 ià(
£rv”
.
»¶_backlog_time_lim™
 < 0) {

380 
”r
 = "repl-backlog-ttl can't be‚egative ";

381 
lßd”r
;

383 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ma¡”auth"è&& 
¬gc
 == 2) {

384 
	`zä“
(
£rv”
.
ma¡”auth
);

385 
£rv”
.
ma¡”auth
 = 
	`z¡rdup
(
¬gv
[1]);

386 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-£rve-¡®e-d©a"è&& 
¬gc
 == 2) {

387 ià((
£rv”
.
»¶_£rve_¡®e_d©a
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

388 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

390 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-»ad-Úly"è&& 
¬gc
 == 2) {

391 ià((
£rv”
.
»¶_¦ave_ro
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

392 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

394 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"rdbcom´essiÚ"è&& 
¬gc
 == 2) {

395 ià((
£rv”
.
rdb_com´essiÚ
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

396 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

398 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"rdbchecksum"è&& 
¬gc
 == 2) {

399 ià((
£rv”
.
rdb_checksum
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

400 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

402 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùiv”ehashšg"è&& 
¬gc
 == 2) {

403 ià((
£rv”
.
aùiv”ehashšg
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

404 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

406 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ïzyä“-Ïzy-eviùiÚ"è&& 
¬gc
 == 2) {

407 ià((
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

408 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

410 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ïzyä“-Ïzy-expœe"è&& 
¬gc
 == 2) {

411 ià((
£rv”
.
Ïzyä“_Ïzy_expœe
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

412 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

414 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ïzyä“-Ïzy-£rv”-d–"è&& 
¬gc
 == 2){

415 ià((
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

416 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

418 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-Ïzy-æush"è&& 
¬gc
 == 2) {

419 ià((
£rv”
.
»¶_¦ave_Ïzy_æush
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

420 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

422 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"d«mÚize"è&& 
¬gc
 == 2) {

423 ià((
£rv”
.
d«mÚize
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

424 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

426 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hz"è&& 
¬gc
 == 2) {

427 
£rv”
.
hz
 = 
	`©oi
(
¬gv
[1]);

428 ià(
£rv”
.
hz
 < 
CONFIG_MIN_HZ
) server.hz = CONFIG_MIN_HZ;

429 ià(
£rv”
.
hz
 > 
CONFIG_MAX_HZ
) server.hz = CONFIG_MAX_HZ;

430 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndÚly"è&& 
¬gc
 == 2) {

431 
yes
;

433 ià((
yes
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

434 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

436 
£rv”
.
aof_¡©e
 = 
yes
 ? 
AOF_ON
 : 
AOF_OFF
;

437 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndf’ame"è&& 
¬gc
 == 2) {

438 ià(!
	`·thIsBa£Name
(
¬gv
[1])) {

439 
”r
 = "appendfilename can't be‡…ath, just‡ filename";

440 
lßd”r
;

442 
	`zä“
(
£rv”
.
aof_f’ame
);

443 
£rv”
.
aof_f’ame
 = 
	`z¡rdup
(
¬gv
[1]);

444 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"no-appendfsync-on-rewrite")

445 && 
¬gc
 == 2) {

446 ià((
£rv”
.
aof_no_fsync_Ú_»wr™e
ğ
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

447 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

449 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndfsync"è&& 
¬gc
 == 2) {

450 
£rv”
.
aof_fsync
 = 
	`cÚfigEnumG‘V®ue
(
aof_fsync_’um
,
¬gv
[1]);

451 ià(
£rv”
.
aof_fsync
 =ğ
INT_MIN
) {

452 
”r
 = "argument must be 'no', 'always' or 'everysec'";

453 
lßd”r
;

455 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auto-aof-rewrite-percentage") &&

456 
¬gc
 == 2)

458 
£rv”
.
aof_»wr™e_³rc
 = 
	`©oi
(
¬gv
[1]);

459 ià(
£rv”
.
aof_»wr™e_³rc
 < 0) {

460 
”r
 = "Invalid‚egative…ercentage for AOF‡uto„ewrite";

461 
lßd”r
;

463 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auto-aof-rewrite-min-size") &&

464 
¬gc
 == 2)

466 
£rv”
.
aof_»wr™e_mš_size
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

467 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aof-rewrite-incremental-fsync") &&

468 
¬gc
 == 2)

470 ià((
£rv”
.
aof_»wr™e_šüem’l_fsync
 =

471 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

472 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

474 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aof-lßd-Œunÿ‹d"è&& 
¬gc
 == 2) {

475 ià((
£rv”
.
aof_lßd_Œunÿ‹d
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

476 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

478 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»quœ•ass"è&& 
¬gc
 == 2) {

479 ià(
	`¡¾’
(
¬gv
[1]è> 
CONFIG_AUTHPASS_MAX_LEN
) {

480 
”r
 = "Password is†ongerhan CONFIG_AUTHPASS_MAX_LEN";

481 
lßd”r
;

483 
£rv”
.
»quœ•ass
 = 
	`z¡rdup
(
¬gv
[1]);

484 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"pidfe"è&& 
¬gc
 == 2) {

485 
	`zä“
(
£rv”
.
pidfe
);

486 
£rv”
.
pidfe
 = 
	`z¡rdup
(
¬gv
[1]);

487 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"dbf’ame"è&& 
¬gc
 == 2) {

488 ià(!
	`·thIsBa£Name
(
¬gv
[1])) {

489 
”r
 = "dbfilename can't be‡…ath, just‡ filename";

490 
lßd”r
;

492 
	`zä“
(
£rv”
.
rdb_f’ame
);

493 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
¬gv
[1]);

494 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hash-max-zli¡-’Œ›s"è&& 
¬gc
 == 2) {

495 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

496 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hash-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

497 
£rv”
.
hash_max_zli¡_v®ue
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

498 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-’Œ›s"è&& 
¬gc
 == 2){

500 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

502 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-size"è&& 
¬gc
 == 2) {

503 
£rv”
.
li¡_max_zli¡_size
 = 
	`©oi
(
¬gv
[1]);

504 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-com´ess-d•th"è&& 
¬gc
 == 2) {

505 
£rv”
.
li¡_com´ess_d•th
 = 
	`©oi
(
¬gv
[1]);

506 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"£t-max-št£t-’Œ›s"è&& 
¬gc
 == 2) {

507 
£rv”
.
£t_max_št£t_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

508 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"z£t-max-zli¡-’Œ›s"è&& 
¬gc
 == 2) {

509 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

510 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"z£t-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

511 
£rv”
.
z£t_max_zli¡_v®ue
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

512 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hÎ-¥¬£-max-by‹s"è&& 
¬gc
 == 2) {

513 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

514 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»Çme-commªd"è&& 
¬gc
 == 3) {

515 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
¬gv
[1]);

516 
»tv®
;

518 ià(!
cmd
) {

519 
”r
 = "No such command in„ename-command";

520 
lßd”r
;

525 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
commªds
, 
¬gv
[1]);

526 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

529 ià(
	`sd¦’
(
¬gv
[2]) != 0) {

530 
sds
 
cİy
 = 
	`sdsdup
(
¬gv
[2]);

532 
»tv®
 = 
	`diùAdd
(
£rv”
.
commªds
, 
cİy
, 
cmd
);

533 ià(
»tv®
 !ğ
DICT_OK
) {

534 
	`sdsä“
(
cİy
);

535 
”r
 = "T¬g‘ commªd‚am®»adyƒxi¡s"; 
lßd”r
;

538 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-’abËd"è&& 
¬gc
 == 2) {

539 ià((
£rv”
.
şu¡”_’abËd
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

540 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

542 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-cÚfig-fe"è&& 
¬gc
 == 2) {

543 
	`zä“
(
£rv”
.
şu¡”_cÚfigfe
);

544 
£rv”
.
şu¡”_cÚfigfe
 = 
	`z¡rdup
(
¬gv
[1]);

545 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-ªnounû-"è&& 
¬gc
 == 2) {

546 
	`zä“
(
£rv”
.
şu¡”_ªnounû_
);

547 
£rv”
.
şu¡”_ªnounû_
 = 
	`z¡rdup
(
¬gv
[1]);

548 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-ªnounû-pÜt"è&& 
¬gc
 == 2) {

549 
£rv”
.
şu¡”_ªnounû_pÜt
 = 
	`©oi
(
¬gv
[1]);

550 ià(
£rv”
.
şu¡”_ªnounû_pÜt
 < 0 ||

551 
£rv”
.
şu¡”_ªnounû_pÜt
 > 65535)

553 
”r
 = "Inv®id…Üt"; 
lßd”r
;

555 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-announce-bus-port") &&

556 
¬gc
 == 2)

558 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 = 
	`©oi
(
¬gv
[1]);

559 ià(
£rv”
.
şu¡”_ªnounû_bus_pÜt
 < 0 ||

560 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 > 65535)

562 
”r
 = "Inv®id…Üt"; 
lßd”r
;

564 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-require-full-coverage") &&

565 
¬gc
 == 2)

567 ià((
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1)

569 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

571 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-node-timeout"è&& 
¬gc
 == 2) {

572 
£rv”
.
şu¡”_node_timeout
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

573 ià(
£rv”
.
şu¡”_node_timeout
 <= 0) {

574 
”r
 = "şu¡”‚odtimeouˆmu¡ b1 o¸g»©”"; 
lßd”r
;

576 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-migration-barrier")

577 && 
¬gc
 == 2)

579 
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 = 
	`©oi
(
¬gv
[1]);

580 ià(
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 < 0) {

581 
”r
 = "cluster migration barrier must zero or…ositive";

582 
lßd”r
;

584 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-slave-validity-factor")

585 && 
¬gc
 == 2)

587 
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 = 
	`©oi
(
¬gv
[1]);

588 ià(
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 < 0) {

589 
”r
 = "cluster slave validity factor must be zero or…ositive";

590 
lßd”r
;

592 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lua-time-lim™"è&& 
¬gc
 == 2) {

593 
£rv”
.
lua_time_lim™
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

594 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"slowlog-log-slower-than") &&

595 
¬gc
 == 2)

597 
£rv”
.
¦owlog_log_¦ow”_thª
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

598 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"latency-monitor-threshold") &&

599 
¬gc
 == 2)

601 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

602 ià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 < 0) {

603 
”r
 = "The†atencyhreshold can't be‚egative";

604 
lßd”r
;

606 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦owlog-max-Ën"è&& 
¬gc
 == 2) {

607 
£rv”
.
¦owlog_max_Ën
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

608 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"client-output-buffer-limit") &&

609 
¬gc
 == 5)

611 
şass
 = 
	`g‘Cl›ÁTy³ByName
(
¬gv
[1]);

612 
h¬d
, 
soá
;

613 
soá_£cÚds
;

615 ià(
şass
 == -1) {

616 
”r
 = "Unrecognized client†imit class";

617 
lßd”r
;

619 
h¬d
 = 
	`memtŞl
(
¬gv
[2],
NULL
);

620 
soá
 = 
	`memtŞl
(
¬gv
[3],
NULL
);

621 
soá_£cÚds
 = 
	`©oi
(
¬gv
[4]);

622 ià(
soá_£cÚds
 < 0) {

623 
”r
 = "Negative‚umber of seconds in soft†imit is invalid";

624 
lßd”r
;

626 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 = 
h¬d
;

627 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 = 
soá
;

628 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
 = 
soá_£cÚds
;

629 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"stop-writes-on-bgsave-error") &&

630 
¬gc
 == 2) {

631 ià((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

632 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

634 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-´iÜ™y"è&& 
¬gc
 == 2) {

635 
£rv”
.
¦ave_´iÜ™y
 = 
	`©oi
(
¬gv
[1]);

636 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mš-¦aves-to-wr™e"è&& 
¬gc
 == 2) {

637 
£rv”
.
»¶_mš_¦aves_to_wr™e
 = 
	`©oi
(
¬gv
[1]);

638 ià(
£rv”
.
»¶_mš_¦aves_to_wr™e
 < 0) {

639 
”r
 = "Inv®id v®ufÜ mš-¦aves-to-wr™e."; 
lßd”r
;

641 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mš-¦aves-max-Ïg"è&& 
¬gc
 == 2) {

642 
£rv”
.
»¶_mš_¦aves_max_Ïg
 = 
	`©oi
(
¬gv
[1]);

643 ià(
£rv”
.
»¶_mš_¦aves_max_Ïg
 < 0) {

644 
”r
 = "Inv®id v®ufÜ mš-¦aves-max-Ïg."; 
lßd”r
;

646 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"nÙify-key¥aû-ev’ts"è&& 
¬gc
 == 2) {

647 
æags
 = 
	`key¥aûEv’tsSŒšgToFÏgs
(
¬gv
[1]);

649 ià(
æags
 == -1) {

650 
”r
 = "Invalidƒvent class character. Use 'g$lshzxeA'.";

651 
lßd”r
;

653 
£rv”
.
nÙify_key¥aû_ev’ts
 = 
æags
;

654 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"su³rvi£d"è&& 
¬gc
 == 2) {

655 
£rv”
.
su³rvi£d_mode
 =

656 
	`cÚfigEnumG‘V®ue
(
su³rvi£d_mode_’um
,
¬gv
[1]);

658 ià(
£rv”
.
su³rvi£d_mode
 =ğ
INT_MIN
) {

659 
”r
 = "Invalid option for 'supervised'. "

661 
lßd”r
;

663 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lßdmoduË"è&& 
¬gc
 >= 2) {

664 
	`queueLßdModuË
(
¬gv
[1],&¬gv[2],
¬gc
-2);

665 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sentinel")) {

668 ià(
¬gc
 != 1) {

669 ià(!
£rv”
.
£Áš–_mode
) {

670 
”r
 = "sentinel directive while‚ot in sentinel mode";

671 
lßd”r
;

673 
”r
 = 
	`£Áš–HªdËCÚfigu¿tiÚ
(
¬gv
+1,
¬gc
-1);

674 ià(
”r
è
lßd”r
;

677 
”r
 = "Bad dœeùivÜ wrÚg‚umb” oà¬gum’ts"; 
lßd”r
;

679 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

683 ià(
£rv”
.
şu¡”_’abËd
 && s”v”.
ma¡”ho¡
) {

684 
lš’um
 = 
¦aveof_lš’um
;

685 
i
 = 
lš’um
-1;

686 
”r
 = "slaveof directive‚ot‡llowed in cluster mode";

687 
lßd”r
;

690 
	`sdsä“¥l™»s
(
lšes
,
tÙlšes
);

693 
lßd”r
:

694 
	`årštf
(
¡d”r
, "\n*** FATAL CONFIG FILE ERROR ***\n");

695 
	`årštf
(
¡d”r
, "R—dšghcÚfigu¿tiÚ fe,‡ˆlš%d\n", 
lš’um
);

696 
	`årštf
(
¡d”r
, ">>> '%s'\n", 
lšes
[
i
]);

697 
	`årštf
(
¡d”r
, "%s\n", 
”r
);

698 
	`ex™
(1);

699 
	}
}

708 
	$lßdS”v”CÚfig
(*
f’ame
, *
İtiÚs
) {

709 
sds
 
cÚfig
 = 
	`sd£m±y
();

710 
buf
[
CONFIG_MAX_LINE
+1];

713 ià(
f’ame
) {

714 
FILE
 *
å
;

716 ià(
f’ame
[0] == '-' && filename[1] == '\0') {

717 
å
 = 
¡dš
;

719 ià((
å
 = 
	`fİ’
(
f’ame
,"r")è=ğ
NULL
) {

720 
	`£rv”Log
(
LL_WARNING
,

721 "F©®ƒ¼Ü, cª'ˆİ’ cÚfig f'%s'", 
f’ame
);

722 
	`ex™
(1);

725 
	`fg‘s
(
buf
,
CONFIG_MAX_LINE
+1,
å
è!ğ
NULL
)

726 
cÚfig
 = 
	`sdsÿt
(cÚfig,
buf
);

727 ià(
å
 !ğ
¡dš
è
	`fşo£
(fp);

730 ià(
İtiÚs
) {

731 
cÚfig
 = 
	`sdsÿt
(config,"\n");

732 
cÚfig
 = 
	`sdsÿt
(cÚfig,
İtiÚs
);

734 
	`lßdS”v”CÚfigFromSŒšg
(
cÚfig
);

735 
	`sdsä“
(
cÚfig
);

736 
	}
}

742 
	#cÚfig_£t_boŞ_f›ld
(
_Çme
,
_v¬
) \

743 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

744 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
); \

745 ià(
yn
 =ğ-1è
badfmt
; \

746 
_v¬
 = 
yn
;

	)

748 
	#cÚfig_£t_num”iÿl_f›ld
(
_Çme
,
_v¬
,
mš
,
max
) \

749 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

750 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
è
badfmt
; \

751 ià(
mš
 !ğ
LLONG_MIN
 && 
Î
 < mšè
badfmt
; \

752 ià(
max
 !ğ
LLONG_MAX
 && 
Î
 > maxè
badfmt
; \

753 
_v¬
 = 
Î
;

	)

755 
	#cÚfig_£t_memÜy_f›ld
(
_Çme
,
_v¬
) \

756 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

757 
Î
 = 
	`memtŞl
(
o
->
±r
,&
”r
); \

758 ià(
”r
 || 
Î
 < 0è
badfmt
; \

759 
_v¬
 = 
Î
;

	)

761 
	#cÚfig_£t_’um_f›ld
(
_Çme
,
_v¬
,
_’umv¬
) \

762 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

763 
’umv®
 = 
	`cÚfigEnumG‘V®ue
(
_’umv¬
,
o
->
±r
); \

764 ià(
’umv®
 =ğ
INT_MIN
è
badfmt
; \

765 
_v¬
 = 
’umv®
;

	)

767 
	#cÚfig_£t_¥ecŸl_f›ld
(
_Çme
) \

768 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)è{

	)

770 
	#cÚfig_£t_–£
 } 

	)

772 
	$cÚfigS‘Commªd
(
ş›Á
 *
c
) {

773 
robj
 *
o
;

774 
Î
;

775 
”r
;

776 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[2],
	`sdsEncodedObjeù
(c->argv[2]));

777 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[3],
	`sdsEncodedObjeù
(c->argv[3]));

778 
o
 = 
c
->
¬gv
[3];

783 
	`cÚfig_£t_¥ecŸl_f›ld
("dbfilename") {

784 ià(!
	`·thIsBa£Name
(
o
->
±r
)) {

785 
	`addR•lyE¼Ü
(
c
, "dbfilename can't be‡…ath, just‡ filename");

788 
	`zä“
(
£rv”
.
rdb_f’ame
);

789 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
o
->
±r
);

790 } 
	`cÚfig_£t_¥ecŸl_f›ld
("requirepass") {

791 ià(
	`sd¦’
(
o
->
±r
è> 
CONFIG_AUTHPASS_MAX_LEN
è
badfmt
;

792 
	`zä“
(
£rv”
.
»quœ•ass
);

793 
£rv”
.
»quœ•ass
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

794 } 
	`cÚfig_£t_¥ecŸl_f›ld
("masterauth") {

795 
	`zä“
(
£rv”
.
ma¡”auth
);

796 
£rv”
.
ma¡”auth
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

797 } 
	`cÚfig_£t_¥ecŸl_f›ld
("cluster-announce-ip") {

798 
	`zä“
(
£rv”
.
şu¡”_ªnounû_
);

799 
£rv”
.
şu¡”_ªnounû_
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

800 } 
	`cÚfig_£t_¥ecŸl_f›ld
("maxclients") {

801 
Üig_v®ue
 = 
£rv”
.
maxş›Ás
;

803 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†È< 1è
badfmt
;

806 
£rv”
.
maxş›Ás
 = 
Î
;

807 ià(
Î
 > 
Üig_v®ue
) {

808 
	`adju¡O³nFesLim™
();

809 ià(
£rv”
.
maxş›Ás
 !ğ
Î
) {

810 
	`addR•lyE¼ÜFÜm©
(
c
,"Thİ”©šg sy¡em i nÙ‡bËØhªdËh¥ecif›d‚umb” oàş›Ás,ry w™h %d", 
£rv”
.
maxş›Ás
);

811 
£rv”
.
maxş›Ás
 = 
Üig_v®ue
;

814 ià((è
	`«G‘S‘Size
(
£rv”
.
–
) <

815 
£rv”
.
maxş›Ás
 + 
CONFIG_FDSET_INCR
)

817 ià(
	`«ResizeS‘Size
(
£rv”
.
–
,

818 
£rv”
.
maxş›Ás
 + 
CONFIG_FDSET_INCR
è=ğ
AE_ERR
)

820 
	`addR•lyE¼Ü
(
c
,"Theƒvent†oop API used by Redis is‚ot‡bleo handlehe specified‚umber of clients");

821 
£rv”
.
maxş›Ás
 = 
Üig_v®ue
;

826 } 
	`cÚfig_£t_¥ecŸl_f›ld
("appendonly") {

827 
’abË
 = 
	`ye¢Ùoi
(
o
->
±r
);

829 ià(
’abË
 =ğ-1è
badfmt
;

830 ià(
’abË
 =ğ0 && 
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

831 
	`¡İAµ’dOÆy
();

832 } ià(
’abË
 && 
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
) {

833 ià(
	`¡¬tAµ’dOÆy
(è=ğ
C_ERR
) {

834 
	`addR•lyE¼Ü
(
c
,

839 } 
	`cÚfig_£t_¥ecŸl_f›ld
("save") {

840 
vËn
, 
j
;

841 
sds
 *
v
 = 
	`sds¥l™Ën
(
o
->
±r
,
	`sd¦’
(o->±r)," ",1,&
vËn
);

846 ià(
vËn
 & 1) {

847 
	`sdsä“¥l™»s
(
v
,
vËn
);

848 
badfmt
;

850 
j
 = 0; j < 
vËn
; j++) {

851 *
•Œ
;

852 
v®
;

854 
v®
 = 
	`¡¹Şl
(
v
[
j
], &
•Œ
, 10);

855 ià(
•Œ
[0] != '\0' ||

856 ((
j
 & 1è=ğ0 && 
v®
 < 1) ||

857 ((
j
 & 1è=ğ1 && 
v®
 < 0)) {

858 
	`sdsä“¥l™»s
(
v
,
vËn
);

859 
badfmt
;

863 
	`»£tS”v”SaveP¬ams
();

864 
j
 = 0; j < 
vËn
; j += 2) {

865 
time_t
 
£cÚds
;

866 
chªges
;

868 
£cÚds
 = 
	`¡¹Şl
(
v
[
j
],
NULL
,10);

869 
chªges
 = 
	`¡¹Şl
(
v
[
j
+1],
NULL
,10);

870 
	`­³ndS”v”SaveP¬ams
(
£cÚds
, 
chªges
);

872 
	`sdsä“¥l™»s
(
v
,
vËn
);

873 } 
	`cÚfig_£t_¥ecŸl_f›ld
("dir") {

874 ià(
	`chdœ
((*)
o
->
±r
) == -1) {

875 
	`addR•lyE¼ÜFÜm©
(
c
,"Chªgšg dœeùÜy: %s", 
	`¡»¼Ü
(
”ºo
));

878 } 
	`cÚfig_£t_¥ecŸl_f›ld
("client-output-buffer-limit") {

879 
vËn
, 
j
;

880 
sds
 *
v
 = 
	`sds¥l™Ën
(
o
->
±r
,
	`sd¦’
(o->±r)," ",1,&
vËn
);

883 ià(
vËn
 % 4) {

884 
	`sdsä“¥l™»s
(
v
,
vËn
);

885 
badfmt
;

891 
j
 = 0; j < 
vËn
; j++) {

892 
v®
;

894 ià((
j
 % 4) == 0) {

895 ià(
	`g‘Cl›ÁTy³ByName
(
v
[
j
]) == -1) {

896 
	`sdsä“¥l™»s
(
v
,
vËn
);

897 
badfmt
;

900 
v®
 = 
	`memtŞl
(
v
[
j
], &
”r
);

901 ià(
”r
 || 
v®
 < 0) {

902 
	`sdsä“¥l™»s
(
v
,
vËn
);

903 
badfmt
;

908 
j
 = 0; j < 
vËn
; j += 4) {

909 
şass
;

910 
h¬d
, 
soá
;

911 
soá_£cÚds
;

913 
şass
 = 
	`g‘Cl›ÁTy³ByName
(
v
[
j
]);

914 
h¬d
 = 
	`¡¹Şl
(
v
[
j
+1],
NULL
,10);

915 
soá
 = 
	`¡¹Şl
(
v
[
j
+2],
NULL
,10);

916 
soá_£cÚds
 = 
	`¡¹Şl
(
v
[
j
+3],
NULL
,10);

918 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 = 
h¬d
;

919 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 = 
soá
;

920 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
 = 
soá_£cÚds
;

922 
	`sdsä“¥l™»s
(
v
,
vËn
);

923 } 
	`cÚfig_£t_¥ecŸl_f›ld
("notify-keyspace-events") {

924 
æags
 = 
	`key¥aûEv’tsSŒšgToFÏgs
(
o
->
±r
);

926 ià(
æags
 =ğ-1è
badfmt
;

927 
£rv”
.
nÙify_key¥aû_ev’ts
 = 
æags
;

931 } 
	`cÚfig_£t_boŞ_f›ld
(

932 "rdbcom´essiÚ", 
£rv”
.
rdb_com´essiÚ
) {

933 } 
	`cÚfig_£t_boŞ_f›ld
(

934 "»¶-di§bË-tı-nod–ay",
£rv”
.
»¶_di§bË_tı_nod–ay
) {

935 } 
	`cÚfig_£t_boŞ_f›ld
(

936 "»¶-diskËss-sync",
£rv”
.
»¶_diskËss_sync
) {

937 } 
	`cÚfig_£t_boŞ_f›ld
(

938 "şu¡”-»quœe-fuÎ-cov”age",
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
) {

939 } 
	`cÚfig_£t_boŞ_f›ld
(

940 "aof-»wr™e-šüem’l-fsync",
£rv”
.
aof_»wr™e_šüem’l_fsync
) {

941 } 
	`cÚfig_£t_boŞ_f›ld
(

942 "aof-lßd-Œunÿ‹d",
£rv”
.
aof_lßd_Œunÿ‹d
) {

943 } 
	`cÚfig_£t_boŞ_f›ld
(

944 "¦ave-£rve-¡®e-d©a",
£rv”
.
»¶_£rve_¡®e_d©a
) {

945 } 
	`cÚfig_£t_boŞ_f›ld
(

946 "¦ave-»ad-Úly",
£rv”
.
»¶_¦ave_ro
) {

947 } 
	`cÚfig_£t_boŞ_f›ld
(

948 "aùiv”ehashšg",
£rv”
.
aùiv”ehashšg
) {

949 } 
	`cÚfig_£t_boŞ_f›ld
(

950 "´Ùeùed-mode",
£rv”
.
´Ùeùed_mode
) {

951 } 
	`cÚfig_£t_boŞ_f›ld
(

952 "¡İ-wr™es-Ú-bg§ve-”rÜ",
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
) {

953 } 
	`cÚfig_£t_boŞ_f›ld
(

954 "Ïzyä“-Ïzy-eviùiÚ",
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
) {

955 } 
	`cÚfig_£t_boŞ_f›ld
(

956 "Ïzyä“-Ïzy-expœe",
£rv”
.
Ïzyä“_Ïzy_expœe
) {

957 } 
	`cÚfig_£t_boŞ_f›ld
(

958 "Ïzyä“-Ïzy-£rv”-d–",
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
) {

959 } 
	`cÚfig_£t_boŞ_f›ld
(

960 "¦ave-Ïzy-æush",
£rv”
.
»¶_¦ave_Ïzy_æush
) {

961 } 
	`cÚfig_£t_boŞ_f›ld
(

962 "no-­³ndfsync-Ú-»wr™e",
£rv”
.
aof_no_fsync_Ú_»wr™e
) {

966 } 
	`cÚfig_£t_num”iÿl_f›ld
(

967 "tı-k“·live",
£rv”
.
tık“·live
,0,
LLONG_MAX
) {

968 } 
	`cÚfig_£t_num”iÿl_f›ld
(

969 "maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
,1,
LLONG_MAX
) {

970 } 
	`cÚfig_£t_num”iÿl_f›ld
(

971 "lfu-log-çùÜ",
£rv”
.
lfu_log_çùÜ
,0,
LLONG_MAX
) {

972 } 
	`cÚfig_£t_num”iÿl_f›ld
(

973 "lfu-deÿy-time",
£rv”
.
lfu_deÿy_time
,0,
LLONG_MAX
) {

974 } 
	`cÚfig_£t_num”iÿl_f›ld
(

975 "timeout",
£rv”
.
maxidËtime
,0,
LONG_MAX
) {

976 } 
	`cÚfig_£t_num”iÿl_f›ld
(

977 "auto-aof-»wr™e-³rûÁage",
£rv”
.
aof_»wr™e_³rc
,0,
LLONG_MAX
){

978 } 
	`cÚfig_£t_num”iÿl_f›ld
(

979 "auto-aof-»wr™e-mš-size",
£rv”
.
aof_»wr™e_mš_size
,0,
LLONG_MAX
) {

980 } 
	`cÚfig_£t_num”iÿl_f›ld
(

981 "hash-max-zli¡-’Œ›s",
£rv”
.
hash_max_zli¡_’Œ›s
,0,
LLONG_MAX
) {

982 } 
	`cÚfig_£t_num”iÿl_f›ld
(

983 "hash-max-zli¡-v®ue",
£rv”
.
hash_max_zli¡_v®ue
,0,
LLONG_MAX
) {

984 } 
	`cÚfig_£t_num”iÿl_f›ld
(

985 "li¡-max-zli¡-size",
£rv”
.
li¡_max_zli¡_size
,
INT_MIN
,
INT_MAX
) {

986 } 
	`cÚfig_£t_num”iÿl_f›ld
(

987 "li¡-com´ess-d•th",
£rv”
.
li¡_com´ess_d•th
,0,
INT_MAX
) {

988 } 
	`cÚfig_£t_num”iÿl_f›ld
(

989 "£t-max-št£t-’Œ›s",
£rv”
.
£t_max_št£t_’Œ›s
,0,
LLONG_MAX
) {

990 } 
	`cÚfig_£t_num”iÿl_f›ld
(

991 "z£t-max-zli¡-’Œ›s",
£rv”
.
z£t_max_zli¡_’Œ›s
,0,
LLONG_MAX
) {

992 } 
	`cÚfig_£t_num”iÿl_f›ld
(

993 "z£t-max-zli¡-v®ue",
£rv”
.
z£t_max_zli¡_v®ue
,0,
LLONG_MAX
) {

994 } 
	`cÚfig_£t_num”iÿl_f›ld
(

995 "hÎ-¥¬£-max-by‹s",
£rv”
.
hÎ_¥¬£_max_by‹s
,0,
LLONG_MAX
) {

996 } 
	`cÚfig_£t_num”iÿl_f›ld
(

997 "lua-time-lim™",
£rv”
.
lua_time_lim™
,0,
LLONG_MAX
) {

998 } 
	`cÚfig_£t_num”iÿl_f›ld
(

999 "¦owlog-log-¦ow”-thª",
£rv”
.
¦owlog_log_¦ow”_thª
,0,
LLONG_MAX
) {

1000 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1001 "¦owlog-max-Ën",
Î
,0,
LLONG_MAX
) {

1003 
£rv”
.
¦owlog_max_Ën
 = ()
Î
;

1004 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1005 "Ï‹ncy-mÚ™Ü-th»shŞd",
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
,0,
LLONG_MAX
){

1006 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1007 "»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
,1,
LLONG_MAX
) {

1008 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1009 "»¶-timeout",
£rv”
.
»¶_timeout
,1,
LLONG_MAX
) {

1010 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1011 "»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
,0,
LLONG_MAX
) {

1012 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1013 "»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
,0,
LLONG_MAX
) {

1014 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1015 "¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
,0,
LLONG_MAX
) {

1016 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1017 "mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
,0,
LLONG_MAX
) {

1018 
	`»äeshGoodSÏvesCouÁ
();

1019 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1020 "mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
,0,
LLONG_MAX
) {

1021 
	`»äeshGoodSÏvesCouÁ
();

1022 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1023 "şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
,0,
LLONG_MAX
) {

1024 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1025 "şu¡”-ªnounû-pÜt",
£rv”
.
şu¡”_ªnounû_pÜt
,0,65535) {

1026 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1027 "şu¡”-ªnounû-bus-pÜt",
£rv”
.
şu¡”_ªnounû_bus_pÜt
,0,65535) {

1028 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1029 "şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
,0,
LLONG_MAX
){

1030 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1031 "şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
,0,
LLONG_MAX
) {

1032 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1033 "hz",
£rv”
.
hz
,0,
LLONG_MAX
) {

1036 ià(
£rv”
.
hz
 < 
CONFIG_MIN_HZ
) server.hz = CONFIG_MIN_HZ;

1037 ià(
£rv”
.
hz
 > 
CONFIG_MAX_HZ
) server.hz = CONFIG_MAX_HZ;

1038 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1039 "w©chdog-³riod",
Î
,0,
LLONG_MAX
) {

1040 ià(
Î
)

1041 
	`’abËW©chdog
(
Î
);

1043 
	`di§bËW©chdog
();

1047 } 
	`cÚfig_£t_memÜy_f›ld
("maxmemÜy",
£rv”
.
maxmemÜy
) {

1048 ià(
£rv”
.
maxmemÜy
) {

1049 ià(
£rv”
.
maxmemÜy
 < 
	`zm®loc_u£d_memÜy
()) {

1050 
	`£rv”Log
(
LL_WARNING
,"WARNING:he‚ew maxmemory value set via CONFIG SET is smallerhanhe current memory usage. This will„esult in keysƒviction‡nd/or inabilityo‡ccept‚ew write commands depending onhe maxmemory-policy.");

1052 
	`ä“MemÜyIfN“ded
();

1054 } 
	`cÚfig_£t_memÜy_f›ld
("»¶-backlog-size",
Î
) {

1055 
	`»sizeR•liÿtiÚBacklog
(
Î
);

1059 } 
	`cÚfig_£t_’um_f›ld
(

1060 "logËv–",
£rv”
.
v”bos™y
,
logËv–_’um
) {

1061 } 
	`cÚfig_£t_’um_f›ld
(

1062 "maxmemÜy-pŞicy",
£rv”
.
maxmemÜy_pŞicy
,
maxmemÜy_pŞicy_’um
) {

1063 } 
	`cÚfig_£t_’um_f›ld
(

1064 "­³ndfsync",
£rv”
.
aof_fsync
,
aof_fsync_’um
) {

1067 } 
cÚfig_£t_–£
 {

1068 
	`addR•lyE¼ÜFÜm©
(
c
,"Unsupported CONFIG…arameter: %s",

1069 (*)
c
->
¬gv
[2]->
±r
);

1074 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1077 
badfmt
:

1078 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for CONFIG SET '%s'",

1079 (*)
o
->
±r
,

1080 (*)
c
->
¬gv
[2]->
±r
);

1087 
	#cÚfig_g‘_¡ršg_f›ld
(
_Çme
,
_v¬
) do { \

1088 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1089 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1090 
	`addR•lyBulkCSŒšg
(
c
,
_v¬
 ? _var : ""); \

1091 
m©ches
++; \

1093 } 0);

	)

1095 
	#cÚfig_g‘_boŞ_f›ld
(
_Çme
,
_v¬
) do { \

1096 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1097 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1098 
	`addR•lyBulkCSŒšg
(
c
,
_v¬
 ? "yes" : "no"); \

1099 
m©ches
++; \

1101 } 0);

	)

1103 
	#cÚfig_g‘_num”iÿl_f›ld
(
_Çme
,
_v¬
) do { \

1104 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1105 
	`Î2¡ršg
(
buf
,(buf),
_v¬
); \

1106 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1107 
	`addR•lyBulkCSŒšg
(
c
,
buf
); \

1108 
m©ches
++; \

1110 } 0);

	)

1112 
	#cÚfig_g‘_’um_f›ld
(
_Çme
,
_v¬
,
_’umv¬
) do { \

1113 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1114 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1115 
	`addR•lyBulkCSŒšg
(
c
,
	`cÚfigEnumG‘NameOrUnknown
(
_’umv¬
,
_v¬
)); \

1116 
m©ches
++; \

1118 } 0);

	)

1120 
	`cÚfigG‘Commªd
(
ş›Á
 *
c
) {

1121 
robj
 *
o
 = 
c
->
¬gv
[2];

1122 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1123 *
·‰”n
 = 
o
->
±r
;

1124 
buf
[128];

1125 
m©ches
 = 0;

1126 
	`£rv”As£¹W™hInfo
(
c
,
o
,
	`sdsEncodedObjeù
(o));

1129 
	`cÚfig_g‘_¡ršg_f›ld
("dbf’ame",
£rv”
.
rdb_f’ame
);

1130 
	`cÚfig_g‘_¡ršg_f›ld
("»quœ•ass",
£rv”
.
»quœ•ass
);

1131 
	`cÚfig_g‘_¡ršg_f›ld
("ma¡”auth",
£rv”
.
ma¡”auth
);

1132 
	`cÚfig_g‘_¡ršg_f›ld
("şu¡”-ªnounû-",
£rv”
.
şu¡”_ªnounû_
);

1133 
	`cÚfig_g‘_¡ršg_f›ld
("unixsock‘",
£rv”
.
unixsock‘
);

1134 
	`cÚfig_g‘_¡ršg_f›ld
("logfe",
£rv”
.
logfe
);

1135 
	`cÚfig_g‘_¡ršg_f›ld
("pidfe",
£rv”
.
pidfe
);

1138 
	`cÚfig_g‘_num”iÿl_f›ld
("maxmemÜy",
£rv”
.
maxmemÜy
);

1139 
	`cÚfig_g‘_num”iÿl_f›ld
("maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
);

1140 
	`cÚfig_g‘_num”iÿl_f›ld
("timeout",
£rv”
.
maxidËtime
);

1141 
	`cÚfig_g‘_num”iÿl_f›ld
("auto-aof-rewrite-percentage",

1142 
£rv”
.
aof_»wr™e_³rc
);

1143 
	`cÚfig_g‘_num”iÿl_f›ld
("auto-aof-rewrite-min-size",

1144 
£rv”
.
aof_»wr™e_mš_size
);

1145 
	`cÚfig_g‘_num”iÿl_f›ld
("hash-max-ziplist-entries",

1146 
£rv”
.
hash_max_zli¡_’Œ›s
);

1147 
	`cÚfig_g‘_num”iÿl_f›ld
("hash-max-ziplist-value",

1148 
£rv”
.
hash_max_zli¡_v®ue
);

1149 
	`cÚfig_g‘_num”iÿl_f›ld
("list-max-ziplist-size",

1150 
£rv”
.
li¡_max_zli¡_size
);

1151 
	`cÚfig_g‘_num”iÿl_f›ld
("list-compress-depth",

1152 
£rv”
.
li¡_com´ess_d•th
);

1153 
	`cÚfig_g‘_num”iÿl_f›ld
("set-max-intset-entries",

1154 
£rv”
.
£t_max_št£t_’Œ›s
);

1155 
	`cÚfig_g‘_num”iÿl_f›ld
("zset-max-ziplist-entries",

1156 
£rv”
.
z£t_max_zli¡_’Œ›s
);

1157 
	`cÚfig_g‘_num”iÿl_f›ld
("zset-max-ziplist-value",

1158 
£rv”
.
z£t_max_zli¡_v®ue
);

1159 
	`cÚfig_g‘_num”iÿl_f›ld
("hll-sparse-max-bytes",

1160 
£rv”
.
hÎ_¥¬£_max_by‹s
);

1161 
	`cÚfig_g‘_num”iÿl_f›ld
("lua-time-lim™",
£rv”
.
lua_time_lim™
);

1162 
	`cÚfig_g‘_num”iÿl_f›ld
("slowlog-log-slower-than",

1163 
£rv”
.
¦owlog_log_¦ow”_thª
);

1164 
	`cÚfig_g‘_num”iÿl_f›ld
("latency-monitor-threshold",

1165 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
);

1166 
	`cÚfig_g‘_num”iÿl_f›ld
("slowlog-max-len",

1167 
£rv”
.
¦owlog_max_Ën
);

1168 
	`cÚfig_g‘_num”iÿl_f›ld
("pÜt",
£rv”
.
pÜt
);

1169 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-ªnounû-pÜt",
£rv”
.
şu¡”_ªnounû_pÜt
);

1170 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-ªnounû-bus-pÜt",
£rv”
.
şu¡”_ªnounû_bus_pÜt
);

1171 
	`cÚfig_g‘_num”iÿl_f›ld
("tı-backlog",
£rv”
.
tı_backlog
);

1172 
	`cÚfig_g‘_num”iÿl_f›ld
("d©aba£s",
£rv”
.
dbnum
);

1173 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
);

1174 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-timeout",
£rv”
.
»¶_timeout
);

1175 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-backlog-size",
£rv”
.
»¶_backlog_size
);

1176 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
);

1177 
	`cÚfig_g‘_num”iÿl_f›ld
("maxş›Ás",
£rv”
.
maxş›Ás
);

1178 
	`cÚfig_g‘_num”iÿl_f›ld
("w©chdog-³riod",
£rv”
.
w©chdog_³riod
);

1179 
	`cÚfig_g‘_num”iÿl_f›ld
("¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
);

1180 
	`cÚfig_g‘_num”iÿl_f›ld
("mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
);

1181 
	`cÚfig_g‘_num”iÿl_f›ld
("mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
);

1182 
	`cÚfig_g‘_num”iÿl_f›ld
("hz",
£rv”
.
hz
);

1183 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
);

1184 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
);

1185 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
);

1186 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
);

1187 
	`cÚfig_g‘_num”iÿl_f›ld
("tı-k“·live",
£rv”
.
tık“·live
);

1190 
	`cÚfig_g‘_boŞ_f›ld
("cluster-require-full-coverage",

1191 
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
);

1192 
	`cÚfig_g‘_boŞ_f›ld
("no-appendfsync-on-rewrite",

1193 
£rv”
.
aof_no_fsync_Ú_»wr™e
);

1194 
	`cÚfig_g‘_boŞ_f›ld
("slave-serve-stale-data",

1195 
£rv”
.
»¶_£rve_¡®e_d©a
);

1196 
	`cÚfig_g‘_boŞ_f›ld
("slave-read-only",

1197 
£rv”
.
»¶_¦ave_ro
);

1198 
	`cÚfig_g‘_boŞ_f›ld
("stop-writes-on-bgsave-error",

1199 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
);

1200 
	`cÚfig_g‘_boŞ_f›ld
("d«mÚize", 
£rv”
.
d«mÚize
);

1201 
	`cÚfig_g‘_boŞ_f›ld
("rdbcom´essiÚ", 
£rv”
.
rdb_com´essiÚ
);

1202 
	`cÚfig_g‘_boŞ_f›ld
("rdbchecksum", 
£rv”
.
rdb_checksum
);

1203 
	`cÚfig_g‘_boŞ_f›ld
("aùiv”ehashšg", 
£rv”
.
aùiv”ehashšg
);

1204 
	`cÚfig_g‘_boŞ_f›ld
("´Ùeùed-mode", 
£rv”
.
´Ùeùed_mode
);

1205 
	`cÚfig_g‘_boŞ_f›ld
("repl-disable-tcp-nodelay",

1206 
£rv”
.
»¶_di§bË_tı_nod–ay
);

1207 
	`cÚfig_g‘_boŞ_f›ld
("repl-diskless-sync",

1208 
£rv”
.
»¶_diskËss_sync
);

1209 
	`cÚfig_g‘_boŞ_f›ld
("aof-rewrite-incremental-fsync",

1210 
£rv”
.
aof_»wr™e_šüem’l_fsync
);

1211 
	`cÚfig_g‘_boŞ_f›ld
("aof-load-truncated",

1212 
£rv”
.
aof_lßd_Œunÿ‹d
);

1213 
	`cÚfig_g‘_boŞ_f›ld
("lazyfree-lazy-eviction",

1214 
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
);

1215 
	`cÚfig_g‘_boŞ_f›ld
("lazyfree-lazy-expire",

1216 
£rv”
.
Ïzyä“_Ïzy_expœe
);

1217 
	`cÚfig_g‘_boŞ_f›ld
("lazyfree-lazy-server-del",

1218 
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
);

1219 
	`cÚfig_g‘_boŞ_f›ld
("slave-lazy-flush",

1220 
£rv”
.
»¶_¦ave_Ïzy_æush
);

1223 
	`cÚfig_g‘_’um_f›ld
("maxmemory-policy",

1224 
£rv”
.
maxmemÜy_pŞicy
,
maxmemÜy_pŞicy_’um
);

1225 
	`cÚfig_g‘_’um_f›ld
("loglevel",

1226 
£rv”
.
v”bos™y
,
logËv–_’um
);

1227 
	`cÚfig_g‘_’um_f›ld
("supervised",

1228 
£rv”
.
su³rvi£d_mode
,
su³rvi£d_mode_’um
);

1229 
	`cÚfig_g‘_’um_f›ld
("appendfsync",

1230 
£rv”
.
aof_fsync
,
aof_fsync_’um
);

1231 
	`cÚfig_g‘_’um_f›ld
("syslog-facility",

1232 
£rv”
.
sy¦og_çc™y
,
sy¦og_çc™y_’um
);

1236 ià(
	`¡ršgm©ch
(
·‰”n
,"appendonly",1)) {

1237 
	`addR•lyBulkCSŒšg
(
c
,"appendonly");

1238 
	`addR•lyBulkCSŒšg
(
c
,
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
 ? "no" : "yes");

1239 
m©ches
++;

1241 ià(
	`¡ršgm©ch
(
·‰”n
,"dir",1)) {

1242 
buf
[1024];

1244 ià(
	`g‘cwd
(
buf
,(buf)è=ğ
NULL
)

1245 
buf
[0] = '\0';

1247 
	`addR•lyBulkCSŒšg
(
c
,"dir");

1248 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1249 
m©ches
++;

1251 ià(
	`¡ršgm©ch
(
·‰”n
,"save",1)) {

1252 
sds
 
buf
 = 
	`sd£m±y
();

1253 
j
;

1255 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1256 
buf
 = 
	`sdsÿrštf
(buf,"%jd %d",

1257 (
štmax_t
)
£rv”
.
§v•¬ams
[
j
].
£cÚds
,

1258 
£rv”
.
§v•¬ams
[
j
].
chªges
);

1259 ià(
j
 !ğ
£rv”
.
§v•¬am¦’
-1)

1260 
buf
 = 
	`sdsÿ’
(buf," ",1);

1262 
	`addR•lyBulkCSŒšg
(
c
,"save");

1263 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1264 
	`sdsä“
(
buf
);

1265 
m©ches
++;

1267 ià(
	`¡ršgm©ch
(
·‰”n
,"client-output-buffer-limit",1)) {

1268 
sds
 
buf
 = 
	`sd£m±y
();

1269 
j
;

1271 
j
 = 0; j < 
CLIENT_TYPE_OBUF_COUNT
; j++) {

1272 
buf
 = 
	`sdsÿrštf
(buf,"%s %llu %llu %ld",

1273 
	`g‘Cl›ÁTy³Name
(
j
),

1274 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
,

1275 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
,

1276 (è
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
);

1277 ià(
j
 !ğ
CLIENT_TYPE_OBUF_COUNT
-1)

1278 
buf
 = 
	`sdsÿ’
(buf," ",1);

1280 
	`addR•lyBulkCSŒšg
(
c
,"client-output-buffer-limit");

1281 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1282 
	`sdsä“
(
buf
);

1283 
m©ches
++;

1285 ià(
	`¡ršgm©ch
(
·‰”n
,"unixsocketperm",1)) {

1286 
buf
[32];

1287 
	`¢´štf
(
buf
,(buf),"%o",
£rv”
.
unixsock‘³rm
);

1288 
	`addR•lyBulkCSŒšg
(
c
,"unixsocketperm");

1289 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1290 
m©ches
++;

1292 ià(
	`¡ršgm©ch
(
·‰”n
,"slaveof",1)) {

1293 
buf
[256];

1295 
	`addR•lyBulkCSŒšg
(
c
,"slaveof");

1296 ià(
£rv”
.
ma¡”ho¡
)

1297 
	`¢´štf
(
buf
,(buf),"%s %d",

1298 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

1300 
buf
[0] = '\0';

1301 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1302 
m©ches
++;

1304 ià(
	`¡ršgm©ch
(
·‰”n
,"notify-keyspace-events",1)) {

1305 
robj
 *
æagsobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,

1306 
	`key¥aûEv’tsFÏgsToSŒšg
(
£rv”
.
nÙify_key¥aû_ev’ts
));

1308 
	`addR•lyBulkCSŒšg
(
c
,"notify-keyspace-events");

1309 
	`addR•lyBulk
(
c
,
æagsobj
);

1310 
	`deüRefCouÁ
(
æagsobj
);

1311 
m©ches
++;

1313 ià(
	`¡ršgm©ch
(
·‰”n
,"bind",1)) {

1314 
sds
 
aux
 = 
	`sdsjoš
(
£rv”
.
bšdaddr
,£rv”.
bšdaddr_couÁ
," ");

1316 
	`addR•lyBulkCSŒšg
(
c
,"bind");

1317 
	`addR•lyBulkCSŒšg
(
c
,
aux
);

1318 
	`sdsä“
(
aux
);

1319 
m©ches
++;

1321 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
m©ches
*2);

1328 
	#REDIS_CONFIG_REWRITE_SIGNATURE
 "# G’”©ed by CONFIG REWRITE"

	)

1333 
	`diùSdsCa£Hash
(cÚ¡ *
key
);

1334 
	`diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

1335 
	`diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
);

1336 
	`diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
);

1340 
	`»wr™eCÚfigS’tš–O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
);

1342 
diùTy³
 
İtiÚToLšeDiùTy³
 = {

1343 
diùSdsCa£Hash
,

1344 
NULL
,

1345 
NULL
,

1346 
diùSdsKeyCa£Com·»
,

1347 
diùSdsDe¡ruùÜ
,

1348 
diùLi¡De¡ruùÜ


1351 
diùTy³
 
İtiÚS‘DiùTy³
 = {

1352 
diùSdsCa£Hash
,

1353 
NULL
,

1354 
NULL
,

1355 
diùSdsKeyCa£Com·»
,

1356 
diùSdsDe¡ruùÜ
,

1357 
NULL


1361 
	s»wr™eCÚfigS‹
 {

1362 
diù
 *
İtiÚ_to_lše
;

1363 
diù
 *
»wr™‹n
;

1364 
numlšes
;

1365 
sds
 *
lšes
;

1366 
has_
;

1371 
	`»wr™eCÚfigAµ’dLše
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
lše
) {

1372 
¡©e
->
lšes
 = 
	`z»®loc
(¡©e->lšes, (*è* (¡©e->
numlšes
+1));

1373 
¡©e
->
lšes
[¡©e->
numlšes
++] = 
lše
;

1377 
	`»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
İtiÚ
, 
lš’um
) {

1378 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
İtiÚ
);

1380 ià(
l
 =ğ
NULL
) {

1381 
l
 = 
	`li¡C»©e
();

1382 
	`diùAdd
(
¡©e
->
İtiÚ_to_lše
,
	`sdsdup
(
İtiÚ
),
l
);

1384 
	`li¡AddNodeTa
(
l
,(*)()
lš’um
);

1391 
	`»wr™eCÚfigM¬kAsProûs£d
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
) {

1392 
sds
 
İt
 = 
	`sd¢ew
(
İtiÚ
);

1394 ià(
	`diùAdd
(
¡©e
->
»wr™‹n
,
İt
,
NULL
è!ğ
DICT_OK
è
	`sdsä“
(opt);

1402 
»wr™eCÚfigS‹
 *
	`»wr™eCÚfigR—dOldFe
(*
·th
) {

1403 
FILE
 *
å
 = 
	`fİ’
(
·th
,"r");

1404 
»wr™eCÚfigS‹
 *
¡©e
 = 
	`zm®loc
((*state));

1405 
buf
[
CONFIG_MAX_LINE
+1];

1406 
lš’um
 = -1;

1408 ià(
å
 =ğ
NULL
 && 
”ºo
 !ğ
ENOENT
)  NULL;

1410 
¡©e
->
İtiÚ_to_lše
 = 
	`diùC»©e
(&
İtiÚToLšeDiùTy³
,
NULL
);

1411 
¡©e
->
»wr™‹n
 = 
	`diùC»©e
(&
İtiÚS‘DiùTy³
,
NULL
);

1412 
¡©e
->
numlšes
 = 0;

1413 
¡©e
->
lšes
 = 
NULL
;

1414 
¡©e
->
has_
 = 0;

1415 ià(
å
 =ğ
NULL
è 
¡©e
;

1418 
	`fg‘s
(
buf
,
CONFIG_MAX_LINE
+1,
å
è!ğ
NULL
) {

1419 
¬gc
;

1420 
sds
 *
¬gv
;

1421 
sds
 
lše
 = 
	`sd¡rim
(
	`sd¢ew
(
buf
),"\r\n\t ");

1423 
lš’um
++;

1426 ià(
lše
[0] == '#' ||†ine[0] == '\0') {

1427 ià(!
¡©e
->
has_
 && !
	`¡rcmp
(
lše
,
REDIS_CONFIG_REWRITE_SIGNATURE
))

1428 
¡©e
->
has_
 = 1;

1429 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1434 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

1435 ià(
¬gv
 =ğ
NULL
) {

1439 
sds
 
aux
 = 
	`sd¢ew
("# ??? ");

1440 
aux
 = 
	`sdsÿtsds
×ux,
lše
);

1441 
	`sdsä“
(
lše
);

1442 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
aux
);

1446 
	`sd¡Şow”
(
¬gv
[0]);

1450 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1451 
	`»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
¡©e
,
¬gv
[0],
lš’um
);

1453 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1455 
	`fşo£
(
å
);

1456  
¡©e
;

1475 
	`»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
, 
sds
 
lše
, 
fÜû
) {

1476 
sds
 
o
 = 
	`sd¢ew
(
İtiÚ
);

1477 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
o
);

1479 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1481 ià(!
l
 && !
fÜû
) {

1483 
	`sdsä“
(
lše
);

1484 
	`sdsä“
(
o
);

1488 ià(
l
) {

1489 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

1490 
lš’um
 = (è
Ê
->
v®ue
;

1494 
	`li¡D–Node
(
l
,
Ê
);

1495 ià(
	`li¡L’gth
(
l
è=ğ0è
	`diùD–‘e
(
¡©e
->
İtiÚ_to_lše
,
o
);

1496 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1497 
¡©e
->
lšes
[
lš’um
] = 
lše
;

1500 ià(!
¡©e
->
has_
) {

1501 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,

1502 
	`sd¢ew
(
REDIS_CONFIG_REWRITE_SIGNATURE
));

1503 
¡©e
->
has_
 = 1;

1505 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1507 
	`sdsä“
(
o
);

1512 
	`»wr™eCÚfigFÜm©MemÜy
(*
buf
, 
size_t
 
Ën
, 
by‹s
) {

1513 
gb
 = 1024*1024*1024;

1514 
mb
 = 1024*1024;

1515 
kb
 = 1024;

1517 ià(
by‹s
 && (by‹ % 
gb
) == 0) {

1518  
	`¢´štf
(
buf
,
Ën
,"%Îdgb",
by‹s
/
gb
);

1519 } ià(
by‹s
 && (by‹ % 
mb
) == 0) {

1520  
	`¢´štf
(
buf
,
Ën
,"%Îdmb",
by‹s
/
mb
);

1521 } ià(
by‹s
 && (by‹ % 
kb
) == 0) {

1522  
	`¢´štf
(
buf
,
Ën
,"%Îdkb",
by‹s
/
kb
);

1524  
	`¢´štf
(
buf
,
Ën
,"%Îd",
by‹s
);

1529 
	`»wr™eCÚfigBy‹sO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1530 
buf
[64];

1531 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1532 
sds
 
lše
;

1534 
	`»wr™eCÚfigFÜm©MemÜy
(
buf
,(buf),
v®ue
);

1535 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
buf
);

1536 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1540 
	`»wr™eCÚfigYesNoO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1541 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1542 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,

1543 
v®ue
 ? "yes" : "no");

1545 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1549 
	`»wr™eCÚfigSŒšgO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, *
v®ue
, *
defv®ue
) {

1550 
fÜû
 = 1;

1551 
sds
 
lše
;

1555 ià(
v®ue
 =ğ
NULL
) {

1556 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1561 ià(
defv®ue
 && 
	`¡rcmp
(
v®ue
,defv®ueè=ğ0è
fÜû
 = 0;

1563 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1564 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1565 
lše
 = 
	`sdsÿŒ•r
Öše, 
v®ue
, 
	`¡¾’
(value));

1567 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1571 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1572 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1573 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %Îd",
İtiÚ
,
v®ue
);

1575 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1579 
	`»wr™eCÚfigOù®O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1580 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1581 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %o",
İtiÚ
,
v®ue
);

1583 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1589 
	`»wr™eCÚfigEnumO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
cÚfigEnum
 *
û
, 
defv®
) {

1590 
sds
 
lše
;

1591 cÚ¡ *
Çme
 = 
	`cÚfigEnumG‘NameOrUnknown
(
û
,
v®ue
);

1592 
fÜû
 = 
v®ue
 !ğ
defv®
;

1594 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
Çme
);

1595 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1599 
	`»wr™eCÚfigSy¦ogçc™yO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1600 
v®ue
 = 
£rv”
.
sy¦og_çc™y
;

1601 
fÜû
 = 
v®ue
 !ğ
LOG_LOCAL0
;

1602 cÚ¡ *
Çme
 = 
NULL
, *
İtiÚ
 = "syslog-facility";

1603 
sds
 
lše
;

1605 
Çme
 = 
	`cÚfigEnumG‘NameOrUnknown
(
sy¦og_çc™y_’um
,
v®ue
);

1606 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
Çme
);

1607 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1611 
	`»wr™eCÚfigSaveO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1612 
j
;

1613 
sds
 
lše
;

1618 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1619 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"save %ld %d",

1620 (è
£rv”
.
§v•¬ams
[
j
].
£cÚds
, s”v”.§v•¬ams[j].
chªges
);

1621 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"§ve",
lše
,1);

1624 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"save");

1628 
	`»wr™eCÚfigDœO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1629 
cwd
[1024];

1631 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

1632 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"dir");

1635 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"dœ",
cwd
,
NULL
);

1639 
	`»wr™eCÚfigSÏveofO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1640 *
İtiÚ
 = "slaveof";

1641 
sds
 
lše
;

1646 ià(
£rv”
.
şu¡”_’abËd
 || s”v”.
ma¡”ho¡
 =ğ
NULL
) {

1647 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"slaveof");

1650 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% % %d", 
İtiÚ
,

1651 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

1652 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,1);

1656 
	`»wr™eCÚfigNÙifykey¥aûev’tsO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1657 
fÜû
 = 
£rv”
.
nÙify_key¥aû_ev’ts
 != 0;

1658 *
İtiÚ
 = "notify-keyspace-events";

1659 
sds
 
lše
, 
æags
;

1661 
æags
 = 
	`key¥aûEv’tsFÏgsToSŒšg
(
£rv”
.
nÙify_key¥aû_ev’ts
);

1662 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1663 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1664 
lše
 = 
	`sdsÿŒ•r
Öše, 
æags
, 
	`sd¦’
(flags));

1665 
	`sdsä“
(
æags
);

1666 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1670 
	`»wr™eCÚfigCl›Áouutbufã¾im™O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1671 
j
;

1672 *
İtiÚ
 = "client-output-buffer-limit";

1674 
j
 = 0; j < 
CLIENT_TYPE_OBUF_COUNT
; j++) {

1675 
fÜû
 = (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
 !=

1676 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
h¬d_lim™_by‹s
) ||

1677 (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
 !=

1678 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
soá_lim™_by‹s
) ||

1679 (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
 !=

1680 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
soá_lim™_£cÚds
);

1681 
sds
 
lše
;

1682 
h¬d
[64], 
soá
[64];

1684 
	`»wr™eCÚfigFÜm©MemÜy
(
h¬d
,(hard),

1685 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
);

1686 
	`»wr™eCÚfigFÜm©MemÜy
(
soá
,(soft),

1687 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
);

1689 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%s %s %s %s %ld",

1690 
İtiÚ
, 
	`g‘Cl›ÁTy³Name
(
j
), 
h¬d
, 
soá
,

1691 (è
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
);

1692 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1697 
	`»wr™eCÚfigBšdO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1698 
fÜû
 = 1;

1699 
sds
 
lše
, 
add»s£s
;

1700 *
İtiÚ
 = "bind";

1703 ià(
£rv”
.
bšdaddr_couÁ
 == 0) {

1704 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1709 
add»s£s
 = 
	`sdsjoš
(
£rv”
.
bšdaddr
,£rv”.
bšdaddr_couÁ
," ");

1710 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1711 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1712 
lše
 = 
	`sdsÿtsds
Öše, 
add»s£s
);

1713 
	`sdsä“
(
add»s£s
);

1715 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1720 
sds
 
	`»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1721 
sds
 
cÚ‹Á
 = 
	`sd£m±y
();

1722 
j
, 
was_em±y
 = 0;

1724 
j
 = 0; j < 
¡©e
->
numlšes
; j++) {

1726 ià(
	`sd¦’
(
¡©e
->
lšes
[
j
]) == 0) {

1727 ià(
was_em±y
) ;

1728 
was_em±y
 = 1;

1730 
was_em±y
 = 0;

1732 
cÚ‹Á
 = 
	`sdsÿtsds
(cÚ‹Á,
¡©e
->
lšes
[
j
]);

1733 
cÚ‹Á
 = 
	`sdsÿ’
(content,"\n",1);

1735  
cÚ‹Á
;

1739 
	`»wr™eCÚfigR–—£S‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1740 
	`sdsä“¥l™»s
(
¡©e
->
lšes
,¡©e->
numlšes
);

1741 
	`diùR–—£
(
¡©e
->
İtiÚ_to_lše
);

1742 
	`diùR–—£
(
¡©e
->
»wr™‹n
);

1743 
	`zä“
(
¡©e
);

1754 
	`»wr™eCÚfigRemoveO½hªed
(
»wr™eCÚfigS‹
 *
¡©e
) {

1755 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
¡©e
->
İtiÚ_to_lše
);

1756 
diùEÁry
 *
de
;

1758 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1759 
li¡
 *
l
 = 
	`diùG‘V®
(
de
);

1760 
sds
 
İtiÚ
 = 
	`diùG‘Key
(
de
);

1764 ià(
	`diùFšd
(
¡©e
->
»wr™‹n
,
İtiÚ
è=ğ
NULL
) {

1765 
	`£rv”Log
(
LL_DEBUG
,"NÙ„ewr™‹ÀİtiÚ: %s", 
İtiÚ
);

1769 
	`li¡L’gth
(
l
)) {

1770 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

1771 
lš’um
 = (è
Ê
->
v®ue
;

1773 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1774 
¡©e
->
lšes
[
lš’um
] = 
	`sd£m±y
();

1775 
	`li¡D–Node
(
l
,
Ê
);

1778 
	`diùR–—£I‹¿tÜ
(
di
);

1793 
	`»wr™eCÚfigOv”wr™eFe
(*
cÚfigfe
, 
sds
 
cÚ‹Á
) {

1794 
»tv®
 = 0;

1795 
fd
 = 
	`İ’
(
cÚfigfe
,
O_RDWR
|
O_CREAT
,0644);

1796 
cÚ‹Á_size
 = 
	`sd¦’
(
cÚ‹Á
), 
·ddšg
 = 0;

1797 
¡©
 
sb
;

1798 
sds
 
cÚ‹Á_·dded
;

1802 ià(
fd
 == -1)  -1;

1803 ià(
	`f¡©
(
fd
,&
sb
) == -1) {

1804 
	`şo£
(
fd
);

1809 
cÚ‹Á_·dded
 = 
	`sdsdup
(
cÚ‹Á
);

1810 ià(
cÚ‹Á_size
 < 
sb
.
¡_size
) {

1813 
·ddšg
 = 
sb
.
¡_size
 - 
cÚ‹Á_size
;

1814 
cÚ‹Á_·dded
 = 
	`sdsgrowz”o
(cÚ‹Á_·dded,
sb
.
¡_size
);

1815 
cÚ‹Á_·dded
[
cÚ‹Á_size
] = '\n';

1816 
	`mem£t
(
cÚ‹Á_·dded
+
cÚ‹Á_size
+1,'#',
·ddšg
-1);

1820 ià(
	`wr™e
(
fd
,
cÚ‹Á_·dded
,
	`¡¾’
(content_padded)) == -1) {

1821 
»tv®
 = -1;

1822 
ş—nup
;

1826 ià(
·ddšg
) {

1827 ià(
	`árunÿ‹
(
fd
,
cÚ‹Á_size
) == -1) {

1832 
ş—nup
:

1833 
	`sdsä“
(
cÚ‹Á_·dded
);

1834 
	`şo£
(
fd
);

1835  
»tv®
;

1846 
	`»wr™eCÚfig
(*
·th
) {

1847 
»wr™eCÚfigS‹
 *
¡©e
;

1848 
sds
 
ÃwcÚ‹Á
;

1849 
»tv®
;

1852 ià((
¡©e
 = 
	`»wr™eCÚfigR—dOldFe
(
·th
)è=ğ
NULL
)  -1;

1857 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"d«mÚize",
£rv”
.
d«mÚize
,0);

1858 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"pidfe",
£rv”
.
pidfe
,
CONFIG_DEFAULT_PID_FILE
);

1859 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"pÜt",
£rv”
.
pÜt
,
CONFIG_DEFAULT_SERVER_PORT
);

1860 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-ªnounû-pÜt",
£rv”
.
şu¡”_ªnounû_pÜt
,
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT
);

1861 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-ªnounû-bus-pÜt",
£rv”
.
şu¡”_ªnounû_bus_pÜt
,
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT
);

1862 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"tı-backlog",
£rv”
.
tı_backlog
,
CONFIG_DEFAULT_TCP_BACKLOG
);

1863 
	`»wr™eCÚfigBšdO±iÚ
(
¡©e
);

1864 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"unixsock‘",
£rv”
.
unixsock‘
,
NULL
);

1865 
	`»wr™eCÚfigOù®O±iÚ
(
¡©e
,"unixsock‘³rm",
£rv”
.
unixsock‘³rm
,
CONFIG_DEFAULT_UNIX_SOCKET_PERM
);

1866 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"timeout",
£rv”
.
maxidËtime
,
CONFIG_DEFAULT_CLIENT_TIMEOUT
);

1867 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"tı-k“·live",
£rv”
.
tık“·live
,
CONFIG_DEFAULT_TCP_KEEPALIVE
);

1868 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"logËv–",
£rv”
.
v”bos™y
,
logËv–_’um
,
CONFIG_DEFAULT_VERBOSITY
);

1869 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"logfe",
£rv”
.
logfe
,
CONFIG_DEFAULT_LOGFILE
);

1870 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"sy¦og-’abËd",
£rv”
.
sy¦og_’abËd
,
CONFIG_DEFAULT_SYSLOG_ENABLED
);

1871 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"sy¦og-id’t",
£rv”
.
sy¦og_id’t
,
CONFIG_DEFAULT_SYSLOG_IDENT
);

1872 
	`»wr™eCÚfigSy¦ogçc™yO±iÚ
(
¡©e
);

1873 
	`»wr™eCÚfigSaveO±iÚ
(
¡©e
);

1874 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"d©aba£s",
£rv”
.
dbnum
,
CONFIG_DEFAULT_DBNUM
);

1875 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¡İ-wr™es-Ú-bg§ve-”rÜ",
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
,
CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
);

1876 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"rdbcom´essiÚ",
£rv”
.
rdb_com´essiÚ
,
CONFIG_DEFAULT_RDB_COMPRESSION
);

1877 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"rdbchecksum",
£rv”
.
rdb_checksum
,
CONFIG_DEFAULT_RDB_CHECKSUM
);

1878 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"dbf’ame",
£rv”
.
rdb_f’ame
,
CONFIG_DEFAULT_RDB_FILENAME
);

1879 
	`»wr™eCÚfigDœO±iÚ
(
¡©e
);

1880 
	`»wr™eCÚfigSÏveofO±iÚ
(
¡©e
);

1881 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"ma¡”auth",
£rv”
.
ma¡”auth
,
NULL
);

1882 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"şu¡”-ªnounû-",
£rv”
.
şu¡”_ªnounû_
,
NULL
);

1883 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-£rve-¡®e-d©a",
£rv”
.
»¶_£rve_¡®e_d©a
,
CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA
);

1884 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-»ad-Úly",
£rv”
.
»¶_¦ave_ro
,
CONFIG_DEFAULT_SLAVE_READ_ONLY
);

1885 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
,
CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD
);

1886 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-timeout",
£rv”
.
»¶_timeout
,
CONFIG_DEFAULT_REPL_TIMEOUT
);

1887 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"»¶-backlog-size",
£rv”
.
»¶_backlog_size
,
CONFIG_DEFAULT_REPL_BACKLOG_SIZE
);

1888 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
,
CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
);

1889 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"»¶-di§bË-tı-nod–ay",
£rv”
.
»¶_di§bË_tı_nod–ay
,
CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY
);

1890 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"»¶-diskËss-sync",
£rv”
.
»¶_diskËss_sync
,
CONFIG_DEFAULT_REPL_DISKLESS_SYNC
);

1891 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
,
CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY
);

1892 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
,
CONFIG_DEFAULT_SLAVE_PRIORITY
);

1893 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
,
CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE
);

1894 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
,
CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG
);

1895 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"»quœ•ass",
£rv”
.
»quœ•ass
,
NULL
);

1896 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"maxş›Ás",
£rv”
.
maxş›Ás
,
CONFIG_DEFAULT_MAX_CLIENTS
);

1897 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"maxmemÜy",
£rv”
.
maxmemÜy
,
CONFIG_DEFAULT_MAXMEMORY
);

1898 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"maxmemÜy-pŞicy",
£rv”
.
maxmemÜy_pŞicy
,
maxmemÜy_pŞicy_’um
,
CONFIG_DEFAULT_MAXMEMORY_POLICY
);

1899 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
,
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
);

1900 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"­³ndÚly",
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
,0);

1901 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"­³ndf’ame",
£rv”
.
aof_f’ame
,
CONFIG_DEFAULT_AOF_FILENAME
);

1902 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"­³ndfsync",
£rv”
.
aof_fsync
,
aof_fsync_’um
,
CONFIG_DEFAULT_AOF_FSYNC
);

1903 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"no-­³ndfsync-Ú-»wr™e",
£rv”
.
aof_no_fsync_Ú_»wr™e
,
CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
);

1904 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"auto-aof-»wr™e-³rûÁage",
£rv”
.
aof_»wr™e_³rc
,
AOF_REWRITE_PERC
);

1905 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"auto-aof-»wr™e-mš-size",
£rv”
.
aof_»wr™e_mš_size
,
AOF_REWRITE_MIN_SIZE
);

1906 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"lua-time-lim™",
£rv”
.
lua_time_lim™
,
LUA_SCRIPT_TIME_LIMIT
);

1907 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"şu¡”-’abËd",
£rv”
.
şu¡”_’abËd
,0);

1908 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"şu¡”-cÚfig-fe",
£rv”
.
şu¡”_cÚfigfe
,
CONFIG_DEFAULT_CLUSTER_CONFIG_FILE
);

1909 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"şu¡”-»quœe-fuÎ-cov”age",
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
,
CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
);

1910 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
,
CLUSTER_DEFAULT_NODE_TIMEOUT
);

1911 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
,
CLUSTER_DEFAULT_MIGRATION_BARRIER
);

1912 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
,
CLUSTER_DEFAULT_SLAVE_VALIDITY
);

1913 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦owlog-log-¦ow”-thª",
£rv”
.
¦owlog_log_¦ow”_thª
,
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
);

1914 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"Ï‹ncy-mÚ™Ü-th»shŞd",
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
,
CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD
);

1915 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦owlog-max-Ën",
£rv”
.
¦owlog_max_Ën
,
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
);

1916 
	`»wr™eCÚfigNÙifykey¥aûev’tsO±iÚ
(
¡©e
);

1917 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hash-max-zli¡-’Œ›s",
£rv”
.
hash_max_zli¡_’Œ›s
,
OBJ_HASH_MAX_ZIPLIST_ENTRIES
);

1918 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hash-max-zli¡-v®ue",
£rv”
.
hash_max_zli¡_v®ue
,
OBJ_HASH_MAX_ZIPLIST_VALUE
);

1919 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"li¡-max-zli¡-size",
£rv”
.
li¡_max_zli¡_size
,
OBJ_LIST_MAX_ZIPLIST_SIZE
);

1920 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"li¡-com´ess-d•th",
£rv”
.
li¡_com´ess_d•th
,
OBJ_LIST_COMPRESS_DEPTH
);

1921 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"£t-max-št£t-’Œ›s",
£rv”
.
£t_max_št£t_’Œ›s
,
OBJ_SET_MAX_INTSET_ENTRIES
);

1922 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"z£t-max-zli¡-’Œ›s",
£rv”
.
z£t_max_zli¡_’Œ›s
,
OBJ_ZSET_MAX_ZIPLIST_ENTRIES
);

1923 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"z£t-max-zli¡-v®ue",
£rv”
.
z£t_max_zli¡_v®ue
,
OBJ_ZSET_MAX_ZIPLIST_VALUE
);

1924 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hÎ-¥¬£-max-by‹s",
£rv”
.
hÎ_¥¬£_max_by‹s
,
CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
);

1925 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aùiv”ehashšg",
£rv”
.
aùiv”ehashšg
,
CONFIG_DEFAULT_ACTIVE_REHASHING
);

1926 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"´Ùeùed-mode",
£rv”
.
´Ùeùed_mode
,
CONFIG_DEFAULT_PROTECTED_MODE
);

1927 
	`»wr™eCÚfigCl›Áouutbufã¾im™O±iÚ
(
¡©e
);

1928 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hz",
£rv”
.
hz
,
CONFIG_DEFAULT_HZ
);

1929 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aof-»wr™e-šüem’l-fsync",
£rv”
.
aof_»wr™e_šüem’l_fsync
,
CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
);

1930 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aof-lßd-Œunÿ‹d",
£rv”
.
aof_lßd_Œunÿ‹d
,
CONFIG_DEFAULT_AOF_LOAD_TRUNCATED
);

1931 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"su³rvi£d",
£rv”
.
su³rvi£d_mode
,
su³rvi£d_mode_’um
,
SUPERVISED_NONE
);

1932 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"Ïzyä“-Ïzy-eviùiÚ",
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
,
CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION
);

1933 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"Ïzyä“-Ïzy-expœe",
£rv”
.
Ïzyä“_Ïzy_expœe
,
CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE
);

1934 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"Ïzyä“-Ïzy-£rv”-d–",
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
,
CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL
);

1935 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-Ïzy-æush",
£rv”
.
»¶_¦ave_Ïzy_æush
,
CONFIG_DEFAULT_SLAVE_LAZY_FLUSH
);

1938 ià(
£rv”
.
£Áš–_mode
è
	`»wr™eCÚfigS’tš–O±iÚ
(
¡©e
);

1943 
	`»wr™eCÚfigRemoveO½hªed
(
¡©e
);

1947 
ÃwcÚ‹Á
 = 
	`»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
¡©e
);

1948 
»tv®
 = 
	`»wr™eCÚfigOv”wr™eFe
(
£rv”
.
cÚfigfe
,
ÃwcÚ‹Á
);

1950 
	`sdsä“
(
ÃwcÚ‹Á
);

1951 
	`»wr™eCÚfigR–—£S‹
(
¡©e
);

1952  
»tv®
;

1959 
	`cÚfigCommªd
(
ş›Á
 *
c
) {

1961 ià(
£rv”
.
lßdšg
 && 
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

1962 
	`addR•lyE¼Ü
(
c
,"Only CONFIG GET is‡llowed during†oading");

1966 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

1967 ià(
c
->
¬gc
 !ğ4è
bad¬™y
;

1968 
	`cÚfigS‘Commªd
(
c
);

1969 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

1970 ià(
c
->
¬gc
 !ğ3è
bad¬™y
;

1971 
	`cÚfigG‘Commªd
(
c
);

1972 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"resetstat")) {

1973 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

1974 
	`»£tS”v”Sts
();

1975 
	`»£tCommªdTabËSts
();

1976 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1977 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"rewrite")) {

1978 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

1979 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

1980 
	`addR•lyE¼Ü
(
c
,"The server is„unning without‡ config file");

1983 ià(
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
) == -1) {

1984 
	`£rv”Log
(
LL_WARNING
,"CONFIG REWRITE faed: %s", 
	`¡»¼Ü
(
”ºo
));

1985 
	`addR•lyE¼ÜFÜm©
(
c
,"Rewr™šg cÚfig fe: %s", 
	`¡»¼Ü
(
”ºo
));

1987 
	`£rv”Log
(
LL_WARNING
,"CONFIG REWRITEƒxecuted with success.");

1988 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1991 
	`addR•lyE¼Ü
(
c
,

1996 
bad¬™y
:

1997 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for CONFIG %s",

1998 (*è
c
->
¬gv
[1]->
±r
);

	@config.h

30 #iâdeà
__CONFIG_H


31 
	#__CONFIG_H


	)

33 #ifdeà
__APPLE__


34 
	~<Avaab™yMaüos.h
>

37 #ifdeà
__lšux__


38 
	~<lšux/v”siÚ.h
>

39 
	~<ã©u»s.h
>

43 #ià
defšed
(
__APPLE__
è&& !defšed(
MAC_OS_X_VERSION_10_6
)

44 
	#»dis_f¡©
 
f¡©64


	)

45 
	#»dis_¡©
 
¡©64


	)

47 
	#»dis_f¡©
 
f¡©


	)

48 
	#»dis_¡©
 
¡©


	)

52 #ifdeà
__lšux__


53 
	#HAVE_PROC_STAT
 1

	)

54 
	#HAVE_PROC_MAPS
 1

	)

55 
	#HAVE_PROC_SMAPS
 1

	)

56 
	#HAVE_PROC_SOMAXCONN
 1

	)

60 #ià
defšed
(
__APPLE__
)

61 
	#HAVE_TASKINFO
 1

	)

65 #ià
defšed
(
__APPLE__
è|| (defšed(
__lšux__
è&& defšed(
__GLIBC__
))

66 
	#HAVE_BACKTRACE
 1

	)

70 #ifdeà
__lšux__


71 
	#HAVE_MSG_NOSIGNAL
 1

	)

75 #ifdeà
__lšux__


76 
	#HAVE_EPOLL
 1

	)

79 #ià(
defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)è|| defšed(
__F»eBSD__
è|| defšed(
__O³nBSD__
è|| defšed (
__N‘BSD__
)

80 
	#HAVE_KQUEUE
 1

	)

83 #ifdeà
__sun


84 
	~<sys/ã©u»_‹¡s.h
>

85 #ifdeà
_DTRACE_VERSION


86 
	#HAVE_EVPORT
 1

	)

91 #ifdeà
__lšux__


92 
	#aof_fsync
 
fd©async


	)

94 
	#aof_fsync
 
fsync


	)

99 #ifdeà
__lšux__


100 #ià
defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
)

101 #ià(
LINUX_VERSION_CODE
 >ğ0x020611 && 
__GLIBC_PREREQ
(2, 6))

102 
	#HAVE_SYNC_FILE_RANGE
 1

	)

105 #ià(
LINUX_VERSION_CODE
 >= 0x020611)

106 
	#HAVE_SYNC_FILE_RANGE
 1

	)

111 #ifdeà
HAVE_SYNC_FILE_RANGE


112 
	#rdb_fsync_¿nge
(
fd
,
off
,
size
è
	`sync_fe_¿nge
(fd,off,size,
SYNC_FILE_RANGE_WAIT_BEFORE
|
SYNC_FILE_RANGE_WRITE
)

	)

114 
	#rdb_fsync_¿nge
(
fd
,
off
,
size
è
	`fsync
(fd)

	)

120 #ià(
defšed
 
__N‘BSD__
 || defšed 
__F»eBSD__
 || defšed 
__O³nBSD__
)

121 
	#USE_SETPROCTITLE


	)

124 #ià((
defšed
 
__lšux
 && defšed(
__GLIBC__
)è|| defšed 
__APPLE__
)

125 
	#USE_SETPROCTITLE


	)

126 
	#INIT_SETPROCTITLE_REPLACEMENT


	)

127 
¥t_š™
(
¬gc
, *
¬gv
[]);

128 
£roù™Ë
(cÚ¡ *
fmt
, ...);

132 
	~<sys/ty³s.h
>

134 #iâdeà
BYTE_ORDER


135 #ià(
BSD
 >= 199103)

136 
	~<machše/’dŸn.h
>

138 #ià
defšed
(
lšux
è|| defšed(
__lšux__
)

139 
	~<’dŸn.h
>

141 
	#LITTLE_ENDIAN
 1234

	)

142 
	#BIG_ENDIAN
 4321

	)

143 
	#PDP_ENDIAN
 3412

	)

145 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
è|| defšed(
__amd64__
) || \

146 
defšed
(
vax
è|| defšed(
ns32000
è|| defšed(
sun386
) || \

147 
defšed
(
MIPSEL
è|| defšed(
_MIPSEL
è|| defšed(
BIT_ZERO_ON_RIGHT
) || \

148 
defšed
(
__®pha__
è|| 
	$defšed
(
__®pha
)

149 
	#BYTE_ORDER
 
LITTLE_ENDIAN


	)

152 #ià
	`defšed
(
£l
è|| defšed(
pyr
è|| defšed(
mc68000
è|| defšed(
¥¬c
) || \

153 
	`defšed
(
is68k
è|| defšed(
hÛ
è|| defšed(
ibm032
è|| defšed(
ibm370
) || \

154 
	`defšed
(
MIPSEB
è|| defšed(
_MIPSEB
è|| defšed(
_IBMR2
è|| defšed(
DGUX
) ||\

155 
	`defšed
(
­Şlo
è|| defšed(
__cÚvex__
è|| defšed(
_CRAY
) || \

156 
	`defšed
(
__hµa
è|| defšed(
__hp9000
) || \

157 
	`defšed
(
__hp9000s300
è|| defšed(
__hp9000s700
) || \

158 
	`defšed
 (
BIT_ZERO_ON_LEFT
è|| defšed(
m68k
è|| 
	$defšed
(
__¥¬c
)

159 
	#BYTE_ORDER
 
BIG_ENDIAN


	)

169 #iâdeà
BYTE_ORDER


170 #ifdeà
__BYTE_ORDER


171 #ià
	`defšed
(
__LITTLE_ENDIAN
è&& defšed(
__BIG_ENDIAN
)

172 #iâdeà
LITTLE_ENDIAN


173 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

175 #iâdeà
BIG_ENDIAN


176 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

178 #ià(
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN
)

179 
	#BYTE_ORDER
 
LITTLE_ENDIAN


	)

181 
	#BYTE_ORDER
 
BIG_ENDIAN


	)

187 #ià!
	`defšed
(
BYTE_ORDER
) || \

188 (
BYTE_ORDER
 !ğ
BIG_ENDIAN
 && BYTE_ORDER !ğ
LITTLE_ENDIAN
)

197 #ià(
__i386
 || 
__amd64
 || 
__pow”pc__
è&& 
__GNUC__


198 
	#GNUC_VERSION
 (
__GNUC__
 * 10000 + 
__GNUC_MINOR__
 * 100 + 
__GNUC_PATCHLEVEL__
)

	)

199 #ià
	`defšed
(
__şªg__
)

200 
	#HAVE_ATOMIC


	)

202 #ià(
	`defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
))

203 #ià(
GNUC_VERSION
 >ğ40100 && 
	`__GLIBC_PREREQ
(2, 6))

204 
	#HAVE_ATOMIC


	)

	@crc16.c

1 
	~"£rv”.h
"

47 cÚ¡ 
ušt16_t
 
	güc16b
[256]= {

82 
ušt16_t
 
	$üc16
(cÚ¡ *
buf
, 
Ën
) {

83 
couÁ”
;

84 
ušt16_t
 
üc
 = 0;

85 
couÁ”
 = 0; couÁ” < 
Ën
; counter++)

86 
üc
 = (üc<<8è^ 
üc16b
[((üc>>8è^ *
buf
++)&0x00FF];

87  
üc
;

88 
	}
}

	@crc64.c

40 
	~<¡dšt.h
>

42 cÚ¡ 
ušt64_t
 
	güc64_b
[256] = {

43 
UINT64_C
(0x0000000000000000), UINT64_C(0x7ad870c830358979),

44 
UINT64_C
(0xf5b0e190606b12f2), UINT64_C(0x8f689158505e9b8b),

45 
UINT64_C
(0xc038e5739841b68f), UINT64_C(0xbae095bba8743ff6),

46 
UINT64_C
(0x358804e3f82aa47d), UINT64_C(0x4f50742bc81f2d04),

47 
UINT64_C
(0xab28ecb46814fe75), UINT64_C(0xd1f09c7c5821770c),

48 
UINT64_C
(0x5e980d24087fec87), UINT64_C(0x24407dec384a65fe),

49 
UINT64_C
(0x6b1009c7f05548fa), UINT64_C(0x11c8790fc060c183),

50 
UINT64_C
(0x9ea0e857903e5a08), UINT64_C(0xe478989fa00bd371),

51 
UINT64_C
(0x7d08ff3b88be6f81), UINT64_C(0x07d08ff3b88be6f8),

52 
UINT64_C
(0x88b81eabe8d57d73), UINT64_C(0xf2606e63d8e0f40a),

53 
UINT64_C
(0xbd301a4810ffd90e), UINT64_C(0xc7e86a8020ca5077),

54 
UINT64_C
(0x4880fbd87094cbfc), UINT64_C(0x32588b1040a14285),

55 
UINT64_C
(0xd620138fe0aa91f4), UINT64_C(0xacf86347d09f188d),

56 
UINT64_C
(0x2390f21f80c18306), UINT64_C(0x594882d7b0f40a7f),

57 
UINT64_C
(0x1618f6fc78eb277b), UINT64_C(0x6cc0863448deae02),

58 
UINT64_C
(0xe3a8176c18803589), UINT64_C(0x997067a428b5bcf0),

59 
UINT64_C
(0xfa11fe77117cdf02), UINT64_C(0x80c98ebf2149567b),

60 
UINT64_C
(0x0fa11fe77117cdf0), UINT64_C(0x75796f2f41224489),

61 
UINT64_C
(0x3a291b04893d698d), UINT64_C(0x40f16bccb908e0f4),

62 
UINT64_C
(0xcf99fa94e9567b7f), UINT64_C(0xb5418a5cd963f206),

63 
UINT64_C
(0x513912c379682177), UINT64_C(0x2be1620b495da80e),

64 
UINT64_C
(0xa489f35319033385), UINT64_C(0xde51839b2936bafc),

65 
UINT64_C
(0x9101f7b0e12997f8), UINT64_C(0xebd98778d11c1e81),

66 
UINT64_C
(0x64b116208142850a), UINT64_C(0x1e6966e8b1770c73),

67 
UINT64_C
(0x8719014c99c2b083), UINT64_C(0xfdc17184a9f739fa),

68 
UINT64_C
(0x72a9e0dcf9a9a271), UINT64_C(0x08719014c99c2b08),

69 
UINT64_C
(0x4721e43f0183060c), UINT64_C(0x3df994f731b68f75),

70 
UINT64_C
(0xb29105af61e814fe), UINT64_C(0xc849756751dd9d87),

71 
UINT64_C
(0x2c31edf8f1d64ef6), UINT64_C(0x56e99d30c1e3c78f),

72 
UINT64_C
(0xd9810c6891bd5c04), UINT64_C(0xa3597ca0a188d57d),

73 
UINT64_C
(0xec09088b6997f879), UINT64_C(0x96d1784359a27100),

74 
UINT64_C
(0x19b9e91b09fcea8b), UINT64_C(0x636199d339c963f2),

75 
UINT64_C
(0xdf7adabd7a6e2d6f), UINT64_C(0xa5a2aa754a5ba416),

76 
UINT64_C
(0x2aca3b2d1a053f9d), UINT64_C(0x50124be52a30b6e4),

77 
UINT64_C
(0x1f423fcee22f9be0), UINT64_C(0x659a4f06d21a1299),

78 
UINT64_C
(0xeaf2de5e82448912), UINT64_C(0x902aae96b271006b),

79 
UINT64_C
(0x74523609127ad31a), UINT64_C(0x0e8a46c1224f5a63),

80 
UINT64_C
(0x81e2d7997211c1e8), UINT64_C(0xfb3aa75142244891),

81 
UINT64_C
(0xb46ad37a8a3b6595), UINT64_C(0xceb2a3b2ba0eecec),

82 
UINT64_C
(0x41da32eaea507767), UINT64_C(0x3b024222da65fe1e),

83 
UINT64_C
(0xa2722586f2d042ee), UINT64_C(0xd8aa554ec2e5cb97),

84 
UINT64_C
(0x57c2c41692bb501c), UINT64_C(0x2d1ab4dea28ed965),

85 
UINT64_C
(0x624ac0f56a91f461), UINT64_C(0x1892b03d5aa47d18),

86 
UINT64_C
(0x97fa21650afae693), UINT64_C(0xed2251ad3acf6fea),

87 
UINT64_C
(0x095ac9329ac4bc9b), UINT64_C(0x7382b9faaaf135e2),

88 
UINT64_C
(0xfcea28a2faafae69), UINT64_C(0x8632586aca9a2710),

89 
UINT64_C
(0xc9622c4102850a14), UINT64_C(0xb3ba5c8932b0836d),

90 
UINT64_C
(0x3cd2cdd162ee18e6), UINT64_C(0x460abd1952db919f),

91 
UINT64_C
(0x256b24ca6b12f26d), UINT64_C(0x5fb354025b277b14),

92 
UINT64_C
(0xd0dbc55a0b79e09f), UINT64_C(0xaa03b5923b4c69e6),

93 
UINT64_C
(0xe553c1b9f35344e2), UINT64_C(0x9f8bb171c366cd9b),

94 
UINT64_C
(0x10e3202993385610), UINT64_C(0x6a3b50e1a30ddf69),

95 
UINT64_C
(0x8e43c87e03060c18), UINT64_C(0xf49bb8b633338561),

96 
UINT64_C
(0x7bf329ee636d1eea), UINT64_C(0x012b592653589793),

97 
UINT64_C
(0x4e7b2d0d9b47ba97), UINT64_C(0x34a35dc5ab7233ee),

98 
UINT64_C
(0xbbcbcc9dfb2ca865), UINT64_C(0xc113bc55cb19211c),

99 
UINT64_C
(0x5863dbf1e3ac9dec), UINT64_C(0x22bbab39d3991495),

100 
UINT64_C
(0xadd33a6183c78f1e), UINT64_C(0xd70b4aa9b3f20667),

101 
UINT64_C
(0x985b3e827bed2b63), UINT64_C(0xe2834e4a4bd8a21a),

102 
UINT64_C
(0x6debdf121b863991), UINT64_C(0x1733afda2bb3b0e8),

103 
UINT64_C
(0xf34b37458bb86399), UINT64_C(0x8993478dbb8deae0),

104 
UINT64_C
(0x06fbd6d5ebd3716b), UINT64_C(0x7c23a61ddbe6f812),

105 
UINT64_C
(0x3373d23613f9d516), UINT64_C(0x49aba2fe23cc5c6f),

106 
UINT64_C
(0xc6c333a67392c7e4), UINT64_C(0xbc1b436e43a74e9d),

107 
UINT64_C
(0x95ac9329ac4bc9b5), UINT64_C(0xef74e3e19c7e40cc),

108 
UINT64_C
(0x601c72b9cc20db47), UINT64_C(0x1ac40271fc15523e),

109 
UINT64_C
(0x5594765a340a7f3a), UINT64_C(0x2f4c0692043ff643),

110 
UINT64_C
(0xa02497ca54616dc8), UINT64_C(0xdafce7026454e4b1),

111 
UINT64_C
(0x3e847f9dc45f37c0), UINT64_C(0x445c0f55f46abeb9),

112 
UINT64_C
(0xcb349e0da4342532), UINT64_C(0xb1eceec59401ac4b),

113 
UINT64_C
(0xfebc9aee5c1e814f), UINT64_C(0x8464ea266c2b0836),

114 
UINT64_C
(0x0b0c7b7e3c7593bd), UINT64_C(0x71d40bb60c401ac4),

115 
UINT64_C
(0xe8a46c1224f5a634), UINT64_C(0x927c1cda14c02f4d),

116 
UINT64_C
(0x1d148d82449eb4c6), UINT64_C(0x67ccfd4a74ab3dbf),

117 
UINT64_C
(0x289c8961bcb410bb), UINT64_C(0x5244f9a98c8199c2),

118 
UINT64_C
(0xdd2c68f1dcdf0249), UINT64_C(0xa7f41839ecea8b30),

119 
UINT64_C
(0x438c80a64ce15841), UINT64_C(0x3954f06e7cd4d138),

120 
UINT64_C
(0xb63c61362c8a4ab3), UINT64_C(0xcce411fe1cbfc3ca),

121 
UINT64_C
(0x83b465d5d4a0eece), UINT64_C(0xf96c151de49567b7),

122 
UINT64_C
(0x76048445b4cbfc3c), UINT64_C(0x0cdcf48d84fe7545),

123 
UINT64_C
(0x6fbd6d5ebd3716b7), UINT64_C(0x15651d968d029fce),

124 
UINT64_C
(0x9a0d8ccedd5c0445), UINT64_C(0xe0d5fc06ed698d3c),

125 
UINT64_C
(0xaf85882d2576a038), UINT64_C(0xd55df8e515432941),

126 
UINT64_C
(0x5a3569bd451db2ca), UINT64_C(0x20ed197575283bb3),

127 
UINT64_C
(0xc49581ead523e8c2), UINT64_C(0xbe4df122e51661bb),

128 
UINT64_C
(0x3125607ab548fa30), UINT64_C(0x4bfd10b2857d7349),

129 
UINT64_C
(0x04ad64994d625e4d), UINT64_C(0x7e7514517d57d734),

130 
UINT64_C
(0xf11d85092d094cbf), UINT64_C(0x8bc5f5c11d3cc5c6),

131 
UINT64_C
(0x12b5926535897936), UINT64_C(0x686de2ad05bcf04f),

132 
UINT64_C
(0xe70573f555e26bc4), UINT64_C(0x9ddd033d65d7e2bd),

133 
UINT64_C
(0xd28d7716adc8cfb9), UINT64_C(0xa85507de9dfd46c0),

134 
UINT64_C
(0x273d9686cda3dd4b), UINT64_C(0x5de5e64efd965432),

135 
UINT64_C
(0xb99d7ed15d9d8743), UINT64_C(0xc3450e196da80e3a),

136 
UINT64_C
(0x4c2d9f413df695b1), UINT64_C(0x36f5ef890dc31cc8),

137 
UINT64_C
(0x79a59ba2c5dc31cc), UINT64_C(0x037deb6af5e9b8b5),

138 
UINT64_C
(0x8c157a32a5b7233e), UINT64_C(0xf6cd0afa9582aa47),

139 
UINT64_C
(0x4ad64994d625e4da), UINT64_C(0x300e395ce6106da3),

140 
UINT64_C
(0xbf66a804b64ef628), UINT64_C(0xc5bed8cc867b7f51),

141 
UINT64_C
(0x8aeeace74e645255), UINT64_C(0xf036dc2f7e51db2c),

142 
UINT64_C
(0x7f5e4d772e0f40a7), UINT64_C(0x05863dbf1e3ac9de),

143 
UINT64_C
(0xe1fea520be311aaf), UINT64_C(0x9b26d5e88e0493d6),

144 
UINT64_C
(0x144e44b0de5a085d), UINT64_C(0x6e963478ee6f8124),

145 
UINT64_C
(0x21c640532670ac20), UINT64_C(0x5b1e309b16452559),

146 
UINT64_C
(0xd476a1c3461bbed2), UINT64_C(0xaeaed10b762e37ab),

147 
UINT64_C
(0x37deb6af5e9b8b5b), UINT64_C(0x4d06c6676eae0222),

148 
UINT64_C
(0xc26e573f3ef099a9), UINT64_C(0xb8b627f70ec510d0),

149 
UINT64_C
(0xf7e653dcc6da3dd4), UINT64_C(0x8d3e2314f6efb4ad),

150 
UINT64_C
(0x0256b24ca6b12f26), UINT64_C(0x788ec2849684a65f),

151 
UINT64_C
(0x9cf65a1b368f752e), UINT64_C(0xe62e2ad306bafc57),

152 
UINT64_C
(0x6946bb8b56e467dc), UINT64_C(0x139ecb4366d1eea5),

153 
UINT64_C
(0x5ccebf68aecec3a1), UINT64_C(0x2616cfa09efb4ad8),

154 
UINT64_C
(0xa97e5ef8cea5d153), UINT64_C(0xd3a62e30fe90582a),

155 
UINT64_C
(0xb0c7b7e3c7593bd8), UINT64_C(0xca1fc72bf76cb2a1),

156 
UINT64_C
(0x45775673a732292a), UINT64_C(0x3faf26bb9707a053),

157 
UINT64_C
(0x70ff52905f188d57), UINT64_C(0x0a2722586f2d042e),

158 
UINT64_C
(0x854fb3003f739fa5), UINT64_C(0xff97c3c80f4616dc),

159 
UINT64_C
(0x1bef5b57af4dc5ad), UINT64_C(0x61372b9f9f784cd4),

160 
UINT64_C
(0xee5fbac7cf26d75f), UINT64_C(0x9487ca0fff135e26),

161 
UINT64_C
(0xdbd7be24370c7322), UINT64_C(0xa10fceec0739fa5b),

162 
UINT64_C
(0x2e675fb4576761d0), UINT64_C(0x54bf2f7c6752e8a9),

163 
UINT64_C
(0xcdcf48d84fe75459), UINT64_C(0xb71738107fd2dd20),

164 
UINT64_C
(0x387fa9482f8c46ab), UINT64_C(0x42a7d9801fb9cfd2),

165 
UINT64_C
(0x0df7adabd7a6e2d6), UINT64_C(0x772fdd63e7936baf),

166 
UINT64_C
(0xf8474c3bb7cdf024), UINT64_C(0x829f3cf387f8795d),

167 
UINT64_C
(0x66e7a46c27f3aa2c), UINT64_C(0x1c3fd4a417c62355),

168 
UINT64_C
(0x935745fc4798b8de), UINT64_C(0xe98f353477ad31a7),

169 
UINT64_C
(0xa6df411fbfb21ca3), UINT64_C(0xdc0731d78f8795da),

170 
UINT64_C
(0x536fa08fdfd90e51), UINT64_C(0x29b7d047efec8728),

173 
ušt64_t
 
	$üc64
(
ušt64_t
 
üc
, cÚ¡ *
s
, ušt64_ˆ
l
) {

174 
ušt64_t
 
j
;

176 
j
 = 0; j < 
l
; j++) {

177 
ušt8_t
 
by‹
 = 
s
[
j
];

178 
üc
 = 
üc64_b
[(
ušt8_t
)üø^ 
by‹
] ^ (crc >> 8);

180  
üc
;

181 
	}
}

184 #ifdeà
REDIS_TEST


185 
	~<¡dio.h
>

187 
	#UNUSED
(
x
è()(x)

	)

188 
	$üc64Te¡
(
¬gc
, *
¬gv
[]) {

189 
	`UNUSED
(
¬gc
);

190 
	`UNUSED
(
¬gv
);

191 
	`´štf
("e9c6d914c4b8d9ca == %016llx\n",

192 (è
	`üc64
(0,(*)"123456789",9));

194 
	}
}

	@crc64.h

1 #iâdeà
CRC64_H


2 
	#CRC64_H


	)

4 
	~<¡dšt.h
>

6 
ušt64_t
 
üc64
(ušt64_ˆ
üc
, cÚ¡ *
s
, ušt64_ˆ
l
);

8 #ifdeà
REDIS_TEST


9 
üc64Te¡
(
¬gc
, *
¬gv
[]);

	@db.c

30 
	~"£rv”.h
"

31 
	~"şu¡”.h
"

32 
	~"©omicv¬.h
"

34 
	~<sigÇl.h
>

35 
	~<ùy³.h
>

44 
robj
 *
	$lookupKey
(
»disDb
 *
db
, 
robj
 *
key
, 
æags
) {

45 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

46 ià(
de
) {

47 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

52 ià(
£rv”
.
rdb_chd_pid
 == -1 &&

53 
£rv”
.
aof_chd_pid
 == -1 &&

54 !(
æags
 & 
LOOKUP_NOTOUCH
))

56 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

57 
ldt
 = 
v®
->
Ìu
 >> 8;

58 
couÁ”
 = 
	`LFULogInü
(
v®
->
Ìu
 & 255);

59 
v®
->
Ìu
 = (
ldt
 << 8è| 
couÁ”
;

61 
v®
->
Ìu
 = 
	`LRU_CLOCK
();

64  
v®
;

66  
NULL
;

68 
	}
}

91 
robj
 *
	$lookupKeyR—dW™hFÏgs
(
»disDb
 *
db
, 
robj
 *
key
, 
æags
) {

92 
robj
 *
v®
;

94 ià(
	`expœeIfN“ded
(
db
,
key
) == 1) {

98 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
)  NULL;

112 ià(
£rv”
.
cu¼’t_ş›Á
 &&

113 
£rv”
.
cu¼’t_ş›Á
 !ğ£rv”.
ma¡”
 &&

114 
£rv”
.
cu¼’t_ş›Á
->
cmd
 &&

115 
£rv”
.
cu¼’t_ş›Á
->
cmd
->
æags
 & 
CMD_READONLY
)

117  
NULL
;

120 
v®
 = 
	`lookupKey
(
db
,
key
,
æags
);

121 ià(
v®
 =ğ
NULL
)

122 
£rv”
.
¡©_key¥aû_mis£s
++;

124 
£rv”
.
¡©_key¥aû_h™s
++;

125  
v®
;

126 
	}
}

130 
robj
 *
	$lookupKeyR—d
(
»disDb
 *
db
, 
robj
 *
key
) {

131  
	`lookupKeyR—dW™hFÏgs
(
db
,
key
,
LOOKUP_NONE
);

132 
	}
}

139 
robj
 *
	$lookupKeyWr™e
(
»disDb
 *
db
, 
robj
 *
key
) {

140 
	`expœeIfN“ded
(
db
,
key
);

141  
	`lookupKey
(
db
,
key
,
LOOKUP_NONE
);

142 
	}
}

144 
robj
 *
	$lookupKeyR—dOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

145 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
, 
key
);

146 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

147  
o
;

148 
	}
}

150 
robj
 *
	$lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

151 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
, 
key
);

152 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

153  
o
;

154 
	}
}

160 
	$dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

161 
sds
 
cİy
 = 
	`sdsdup
(
key
->
±r
);

162 
»tv®
 = 
	`diùAdd
(
db
->
diù
, 
cİy
, 
v®
);

164 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
»tv®
 =ğ
DICT_OK
);

165 ià(
v®
->
ty³
 =ğ
OBJ_LIST
è
	`sigÇlLi¡AsR—dy
(
db
, 
key
);

166 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyAdd
(
key
);

167 
	}
}

174 
	$dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

175 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

177 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
de
 != NULL);

178 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

179 
robj
 *
Şd
 = 
	`diùG‘V®
(
de
);

180 
§ved_Ìu
 = 
Şd
->
Ìu
;

181 
	`diùR•Ïû
(
db
->
diù
, 
key
->
±r
, 
v®
);

182 
v®
->
Ìu
 = 
§ved_Ìu
;

184 
	`diùR•Ïû
(
db
->
diù
, 
key
->
±r
, 
v®
);

186 
	}
}

194 
	$£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

195 ià(
	`lookupKeyWr™e
(
db
,
key
è=ğ
NULL
) {

196 
	`dbAdd
(
db
,
key
,
v®
);

198 
	`dbOv”wr™e
(
db
,
key
,
v®
);

200 
	`šüRefCouÁ
(
v®
);

201 
	`»moveExpœe
(
db
,
key
);

202 
	`sigÇlModif›dKey
(
db
,
key
);

203 
	}
}

205 
	$dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
) {

206  
	`diùFšd
(
db
->
diù
,
key
->
±r
è!ğ
NULL
;

207 
	}
}

213 
robj
 *
	$dbRªdomKey
(
»disDb
 *
db
) {

214 
diùEÁry
 *
de
;

217 
sds
 
key
;

218 
robj
 *
keyobj
;

220 
de
 = 
	`diùG‘RªdomKey
(
db
->
diù
);

221 ià(
de
 =ğ
NULL
)  NULL;

223 
key
 = 
	`diùG‘Key
(
de
);

224 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

225 ià(
	`diùFšd
(
db
->
expœes
,
key
)) {

226 ià(
	`expœeIfN“ded
(
db
,
keyobj
)) {

227 
	`deüRefCouÁ
(
keyobj
);

231  
keyobj
;

233 
	}
}

236 
	$dbSyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

239 ià(
	`diùSize
(
db
->
expœes
è> 0è
	`diùD–‘e
(db->expœes,
key
->
±r
);

240 ià(
	`diùD–‘e
(
db
->
diù
,
key
->
±r
è=ğ
DICT_OK
) {

241 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyD–
(
key
);

246 
	}
}

250 
	$dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

251  
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
 ? 
	`dbAsyncD–‘e
(
db
,
key
) :

252 
	`dbSyncD–‘e
(
db
,
key
);

253 
	}
}

282 
robj
 *
	$dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
o
) {

283 
	`£rv”As£¹
(
o
->
ty³
 =ğ
OBJ_STRING
);

284 ià(
o
->
»fcouÁ
 !ğ1 || o->
’codšg
 !ğ
OBJ_ENCODING_RAW
) {

285 
robj
 *
decoded
 = 
	`g‘DecodedObjeù
(
o
);

286 
o
 = 
	`ü—‹RawSŒšgObjeù
(
decoded
->
±r
, 
	`sd¦’
(decoded->ptr));

287 
	`deüRefCouÁ
(
decoded
);

288 
	`dbOv”wr™e
(
db
,
key
,
o
);

290  
o
;

291 
	}
}

307 
em±yDb
(
dbnum
, 
æags
, (
ÿÎback
)(*)) {

308 
j
, 
async
 = (
æags
 & 
EMPTYDB_ASYNC
);

309 
»moved
 = 0;

311 ià(
dbnum
 < -1 || dbnum >ğ
£rv”
.dbnum) {

312 
”ºo
 = 
EINVAL
;

316 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

317 ià(
dbnum
 !ğ-1 && dbnum !ğ
j
) ;

318 
»moved
 +ğ
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

319 ià(
async
) {

320 
	`em±yDbAsync
(&
£rv”
.
db
[
j
]);

322 
	`diùEm±y
(
£rv”
.
db
[
j
].
diù
,
ÿÎback
);

323 
	`diùEm±y
(
£rv”
.
db
[
j
].
expœes
,
ÿÎback
);

326 ià(
£rv”
.
şu¡”_’abËd
) {

327 ià(
async
) {

328 
	`¦ÙToKeyFlushAsync
();

330 
	`¦ÙToKeyFlush
();

333  
»moved
;

334 
	}
}

336 
	$£ËùDb
(
ş›Á
 *
c
, 
id
) {

337 ià(
id
 < 0 || id >ğ
£rv”
.
dbnum
)

338  
C_ERR
;

339 
c
->
db
 = &
£rv”
.db[
id
];

340  
C_OK
;

341 
	}
}

352 
	$sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
) {

353 
	`touchW©chedKey
(
db
,
key
);

354 
	}
}

356 
	$sigÇlFlushedDb
(
dbid
) {

357 
	`touchW©chedKeysOnFlush
(
dbid
);

358 
	}
}

372 
	$g‘FlushCommªdFÏgs
(
ş›Á
 *
c
, *
æags
) {

374 ià(
c
->
¬gc
 > 1) {

375 ià(
c
->
¬gc
 > 2 || 
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"async")) {

376 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

377  
C_ERR
;

379 *
æags
 = 
EMPTYDB_ASYNC
;

381 *
æags
 = 
EMPTYDB_NO_FLAGS
;

383  
C_OK
;

384 
	}
}

389 
	$æushdbCommªd
(
ş›Á
 *
c
) {

390 
æags
;

392 ià(
	`g‘FlushCommªdFÏgs
(
c
,&
æags
è=ğ
C_ERR
) ;

393 
	`sigÇlFlushedDb
(
c
->
db
->
id
);

394 
£rv”
.
dœty
 +ğ
	`em±yDb
(
c
->
db
->
id
,
æags
,
NULL
);

395 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

396 
	}
}

401 
	$æush®lCommªd
(
ş›Á
 *
c
) {

402 
æags
;

404 ià(
	`g‘FlushCommªdFÏgs
(
c
,&
æags
è=ğ
C_ERR
) ;

405 
	`sigÇlFlushedDb
(-1);

406 
£rv”
.
dœty
 +ğ
	`em±yDb
(-1,
æags
,
NULL
);

407 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

408 ià(
£rv”
.
rdb_chd_pid
 != -1) {

409 
	`kl
(
£rv”
.
rdb_chd_pid
,
SIGUSR1
);

410 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

412 ià(
£rv”
.
§v•¬am¦’
 > 0) {

415 
§ved_dœty
 = 
£rv”
.
dœty
;

416 
	`rdbSave
(
£rv”
.
rdb_f’ame
);

417 
£rv”
.
dœty
 = 
§ved_dœty
;

419 
£rv”
.
dœty
++;

420 
	}
}

423 
	$d–G’”icCommªd
(
ş›Á
 *
c
, 
Ïzy
) {

424 
numd–
 = 0, 
j
;

426 
j
 = 1; j < 
c
->
¬gc
; j++) {

427 
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[
j
]);

428 
d–‘ed
 = 
Ïzy
 ? 
	`dbAsyncD–‘e
(
c
->
db
,c->
¬gv
[
j
]) :

429 
	`dbSyncD–‘e
(
c
->
db
,c->
¬gv
[
j
]);

430 ià(
d–‘ed
) {

431 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

432 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

433 "d–",
c
->
¬gv
[
j
],c->
db
->
id
);

434 
£rv”
.
dœty
++;

435 
numd–
++;

438 
	`addR•lyLÚgLÚg
(
c
,
numd–
);

439 
	}
}

441 
	$d–Commªd
(
ş›Á
 *
c
) {

442 
	`d–G’”icCommªd
(
c
,0);

443 
	}
}

445 
	$uÆškCommªd
(
ş›Á
 *
c
) {

446 
	`d–G’”icCommªd
(
c
,1);

447 
	}
}

451 
	$exi¡sCommªd
(
ş›Á
 *
c
) {

452 
couÁ
 = 0;

453 
j
;

455 
j
 = 1; j < 
c
->
¬gc
; j++) {

456 
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[
j
]);

457 ià(
	`dbExi¡s
(
c
->
db
,c->
¬gv
[
j
])è
couÁ
++;

459 
	`addR•lyLÚgLÚg
(
c
,
couÁ
);

460 
	}
}

462 
	$£ËùCommªd
(
ş›Á
 *
c
) {

463 
id
;

465 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[1], &
id
,

466 "šv®id DB index"è!ğ
C_OK
)

469 ià(
£rv”
.
şu¡”_’abËd
 && 
id
 != 0) {

470 
	`addR•lyE¼Ü
(
c
,"SELECT is‚ot‡llowed in cluster mode");

473 ià(
	`£ËùDb
(
c
,
id
è=ğ
C_ERR
) {

474 
	`addR•lyE¼Ü
(
c
,"invalid DB index");

476 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

478 
	}
}

480 
	$¿ndomkeyCommªd
(
ş›Á
 *
c
) {

481 
robj
 *
key
;

483 ià((
key
 = 
	`dbRªdomKey
(
c
->
db
)è=ğ
NULL
) {

484 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

488 
	`addR•lyBulk
(
c
,
key
);

489 
	`deüRefCouÁ
(
key
);

490 
	}
}

492 
	$keysCommªd
(
ş›Á
 *
c
) {

493 
diùI‹¿tÜ
 *
di
;

494 
diùEÁry
 *
de
;

495 
sds
 
·‰”n
 = 
c
->
¬gv
[1]->
±r
;

496 
¶’
 = 
	`sd¦’
(
·‰”n
), 
®lkeys
;

497 
numkeys
 = 0;

498 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

500 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
db
->
diù
);

501 
®lkeys
 = (
·‰”n
[0] == '*' &&…attern[1] == '\0');

502 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

503 
sds
 
key
 = 
	`diùG‘Key
(
de
);

504 
robj
 *
keyobj
;

506 ià(
®lkeys
 || 
	`¡ršgm©chËn
(
·‰”n
,
¶’
,
key
,
	`sd¦’
(key),0)) {

507 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

508 ià(
	`expœeIfN“ded
(
c
->
db
,
keyobj
) == 0) {

509 
	`addR•lyBulk
(
c
,
keyobj
);

510 
numkeys
++;

512 
	`deüRefCouÁ
(
keyobj
);

515 
	`diùR–—£I‹¿tÜ
(
di
);

516 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
numkeys
);

517 
	}
}

521 
	$sÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
) {

522 **
pd
 = (**è
´ivd©a
;

523 
li¡
 *
keys
 = 
pd
[0];

524 
robj
 *
o
 = 
pd
[1];

525 
robj
 *
key
, *
v®
 = 
NULL
;

527 ià(
o
 =ğ
NULL
) {

528 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

529 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
, 
	`sd¦’
(sdskey));

530 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

531 
sds
 
keysds
 = 
	`diùG‘Key
(
de
);

532 
key
 = 
	`ü—‹SŒšgObjeù
(
keysds
,
	`sd¦’
(keysds));

533 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

534 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

535 
sds
 
sdsv®
 = 
	`diùG‘V®
(
de
);

536 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
,
	`sd¦’
(sdskey));

537 
v®
 = 
	`ü—‹SŒšgObjeù
(
sdsv®
,
	`sd¦’
(sdsval));

538 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

539 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

540 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
,
	`sd¦’
(sdskey));

541 
v®
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(*(*)
	`diùG‘V®
(
de
),0);

543 
	`£rv”Pªic
("Type‚ot handled in SCAN callback.");

546 
	`li¡AddNodeTa
(
keys
, 
key
);

547 ià(
v®
è
	`li¡AddNodeTa
(
keys
, val);

548 
	}
}

554 
	$·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
) {

555 *
•Œ
;

559 
”ºo
 = 0;

560 *
cursÜ
 = 
	`¡¹oul
(
o
->
±r
, &
•Œ
, 10);

561 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
)

563 
	`addR•lyE¼Ü
(
c
, "invalid cursor");

564  
C_ERR
;

566  
C_OK
;

567 
	}
}

580 
	$sÿnG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
o
, 
cursÜ
) {

581 
i
, 
j
;

582 
li¡
 *
keys
 = 
	`li¡C»©e
();

583 
li¡Node
 *
node
, *
ÃxŠode
;

584 
couÁ
 = 10;

585 
sds
 
·t
 = 
NULL
;

586 
·’
 = 0, 
u£_·‰”n
 = 0;

587 
diù
 *
ht
;

591 
	`£rv”As£¹
(
o
 =ğ
NULL
 || o->
ty³
 =ğ
OBJ_SET
 || o->ty³ =ğ
OBJ_HASH
 ||

592 
o
->
ty³
 =ğ
OBJ_ZSET
);

595 
i
 = (
o
 =ğ
NULL
) ? 2 : 3;

598 
i
 < 
c
->
¬gc
) {

599 
j
 = 
c
->
¬gc
 - 
i
;

600 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "couÁ"è&& 
j
 >= 2) {

601 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
i
+1], &
couÁ
, 
NULL
)

602 !ğ
C_OK
)

604 
ş—nup
;

607 ià(
couÁ
 < 1) {

608 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

609 
ş—nup
;

612 
i
 += 2;

613 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "m©ch"è&& 
j
 >= 2) {

614 
·t
 = 
c
->
¬gv
[
i
+1]->
±r
;

615 
·’
 = 
	`sd¦’
(
·t
);

619 
u£_·‰”n
 = !(
·t
[0] =ğ'*' && 
·’
 == 1);

621 
i
 += 2;

623 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

624 
ş—nup
;

637 
ht
 = 
NULL
;

638 ià(
o
 =ğ
NULL
) {

639 
ht
 = 
c
->
db
->
diù
;

640 } ià(
o
->
ty³
 =ğ
OBJ_SET
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

641 
ht
 = 
o
->
±r
;

642 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

643 
ht
 = 
o
->
±r
;

644 
couÁ
 *= 2;

645 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
 && o->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

646 
z£t
 *
zs
 = 
o
->
±r
;

647 
ht
 = 
zs
->
diù
;

648 
couÁ
 *= 2;

651 ià(
ht
) {

652 *
´ivd©a
[2];

657 
max™”©iÚs
 = 
couÁ
*10;

662 
´ivd©a
[0] = 
keys
;

663 
´ivd©a
[1] = 
o
;

665 
cursÜ
 = 
	`diùSÿn
(
ht
, cursÜ, 
sÿnC®lback
, 
´ivd©a
);

666 } 
cursÜ
 &&

667 
max™”©iÚs
-- &&

668 
	`li¡L’gth
(
keys
è< ()
couÁ
);

669 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

670 
pos
 = 0;

671 
št64_t
 
Î
;

673 
	`št£tG‘
(
o
->
±r
,
pos
++,&
Î
))

674 
	`li¡AddNodeTa
(
keys
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î
));

675 
cursÜ
 = 0;

676 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 || o->ty³ =ğ
OBJ_ZSET
) {

677 *
p
 = 
	`zli¡Index
(
o
->
±r
,0);

678 *
v¡r
;

679 
vËn
;

680 
vÎ
;

682 
p
) {

683 
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vÎ
);

684 
	`li¡AddNodeTa
(
keys
,

685 (
v¡r
 !ğ
NULL
è? 
	`ü—‹SŒšgObjeù
((*)v¡r,
vËn
) :

686 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
));

687 
p
 = 
	`zli¡Next
(
o
->
±r
,p);

689 
cursÜ
 = 0;

691 
	`£rv”Pªic
("Not handledƒncoding in SCAN.");

695 
node
 = 
	`li¡Fœ¡
(
keys
);

696 
node
) {

697 
robj
 *
kobj
 = 
	`li¡NodeV®ue
(
node
);

698 
ÃxŠode
 = 
	`li¡NextNode
(
node
);

699 
f‹r
 = 0;

702 ià(!
f‹r
 && 
u£_·‰”n
) {

703 ià(
	`sdsEncodedObjeù
(
kobj
)) {

704 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
kobj
->
±r
, 
	`sd¦’
(kobj->ptr), 0))

705 
f‹r
 = 1;

707 
buf
[
LONG_STR_SIZE
];

708 
Ën
;

710 
	`£rv”As£¹
(
kobj
->
’codšg
 =ğ
OBJ_ENCODING_INT
);

711 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
kobj
->
±r
);

712 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
buf
, 
Ën
, 0)è
f‹r
 = 1;

717 ià(!
f‹r
 && 
o
 =ğ
NULL
 && 
	`expœeIfN“ded
(
c
->
db
, 
kobj
)) filter = 1;

720 ià(
f‹r
) {

721 
	`deüRefCouÁ
(
kobj
);

722 
	`li¡D–Node
(
keys
, 
node
);

728 ià(
o
 && (o->
ty³
 =ğ
OBJ_ZSET
 || o->ty³ =ğ
OBJ_HASH
)) {

729 
node
 = 
ÃxŠode
;

730 
ÃxŠode
 = 
	`li¡NextNode
(
node
);

731 ià(
f‹r
) {

732 
kobj
 = 
	`li¡NodeV®ue
(
node
);

733 
	`deüRefCouÁ
(
kobj
);

734 
	`li¡D–Node
(
keys
, 
node
);

737 
node
 = 
ÃxŠode
;

741 
	`addR•lyMuÉiBulkL’
(
c
, 2);

742 
	`addR•lyBulkLÚgLÚg
(
c
,
cursÜ
);

744 
	`addR•lyMuÉiBulkL’
(
c
, 
	`li¡L’gth
(
keys
));

745 (
node
 = 
	`li¡Fœ¡
(
keys
)è!ğ
NULL
) {

746 
robj
 *
kobj
 = 
	`li¡NodeV®ue
(
node
);

747 
	`addR•lyBulk
(
c
, 
kobj
);

748 
	`deüRefCouÁ
(
kobj
);

749 
	`li¡D–Node
(
keys
, 
node
);

752 
ş—nup
:

753 
	`li¡S‘F»eM‘hod
(
keys
,
deüRefCouÁVoid
);

754 
	`li¡R–—£
(
keys
);

755 
	}
}

758 
	$sÿnCommªd
(
ş›Á
 *
c
) {

759 
cursÜ
;

760 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[1],&
cursÜ
è=ğ
C_ERR
) ;

761 
	`sÿnG’”icCommªd
(
c
,
NULL
,
cursÜ
);

762 
	}
}

764 
	$dbsizeCommªd
(
ş›Á
 *
c
) {

765 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
db
->
diù
));

766 
	}
}

768 
	$Ï¡§veCommªd
(
ş›Á
 *
c
) {

769 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
Ï¡§ve
);

770 
	}
}

772 
	$ty³Commªd
(
ş›Á
 *
c
) {

773 
robj
 *
o
;

774 *
ty³
;

776 
o
 = 
	`lookupKeyR—dW™hFÏgs
(
c
->
db
,c->
¬gv
[1],
LOOKUP_NOTOUCH
);

777 ià(
o
 =ğ
NULL
) {

778 
ty³
 = "none";

780 
o
->
ty³
) {

781 
OBJ_STRING
: 
ty³
 = "string"; ;

782 
OBJ_LIST
: 
ty³
 = "list"; ;

783 
OBJ_SET
: 
ty³
 = "set"; ;

784 
OBJ_ZSET
: 
ty³
 = "zset"; ;

785 
OBJ_HASH
: 
ty³
 = "hash"; ;

786 
OBJ_MODULE
: {

787 
moduËV®ue
 *
mv
 = 
o
->
±r
;

788 
ty³
 = 
mv
->ty³->
Çme
;

790 : 
ty³
 = "unknown"; ;

793 
	`addR•lyStus
(
c
,
ty³
);

794 
	}
}

796 
	$shutdownCommªd
(
ş›Á
 *
c
) {

797 
æags
 = 0;

799 ià(
c
->
¬gc
 > 2) {

800 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

802 } ià(
c
->
¬gc
 == 2) {

803 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nosave")) {

804 
æags
 |ğ
SHUTDOWN_NOSAVE
;

805 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"save")) {

806 
æags
 |ğ
SHUTDOWN_SAVE
;

808 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

818 ià(
£rv”
.
lßdšg
 || s”v”.
£Áš–_mode
)

819 
æags
 = (æag & ~
SHUTDOWN_SAVE
è| 
SHUTDOWN_NOSAVE
;

820 ià(
	`´•¬eFÜShutdown
(
æags
è=ğ
C_OK
è
	`ex™
(0);

821 
	`addR•lyE¼Ü
(
c
,"Errorsryingo SHUTDOWN. Check†ogs.");

822 
	}
}

824 
	$»ÇmeG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

825 
robj
 *
o
;

826 
expœe
;

827 
§mekey
 = 0;

831 ià(
	`sdscmp
(
c
->
¬gv
[1]->
±r
,c->¬gv[2]->±rè=ğ0è
§mekey
 = 1;

833 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
)è=ğ
NULL
)

836 ià(
§mekey
) {

837 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
ok
);

841 
	`šüRefCouÁ
(
o
);

842 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

843 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]è!ğ
NULL
) {

844 ià(
nx
) {

845 
	`deüRefCouÁ
(
o
);

846 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

851 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[2]);

853 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
o
);

854 ià(
expœe
 !ğ-1è
	`£tExpœe
(
c
->
db
,c->
¬gv
[2],expire);

855 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

856 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

857 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

858 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_from",

859 
c
->
¬gv
[1],c->
db
->
id
);

860 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_to",

861 
c
->
¬gv
[2],c->
db
->
id
);

862 
£rv”
.
dœty
++;

863 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

864 
	}
}

866 
	$»ÇmeCommªd
(
ş›Á
 *
c
) {

867 
	`»ÇmeG’”icCommªd
(
c
,0);

868 
	}
}

870 
	$»Çm’xCommªd
(
ş›Á
 *
c
) {

871 
	`»ÇmeG’”icCommªd
(
c
,1);

872 
	}
}

874 
	$moveCommªd
(
ş›Á
 *
c
) {

875 
robj
 *
o
;

876 
»disDb
 *
¤c
, *
d¡
;

877 
¤cid
;

878 
dbid
, 
expœe
;

880 ià(
£rv”
.
şu¡”_’abËd
) {

881 
	`addR•lyE¼Ü
(
c
,"MOVE is‚ot‡llowed in cluster mode");

886 
¤c
 = 
c
->
db
;

887 
¤cid
 = 
c
->
db
->
id
;

889 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[2],&
dbid
è=ğ
C_ERR
 ||

890 
dbid
 < 
INT_MIN
 || dbid > 
INT_MAX
 ||

891 
	`£ËùDb
(
c
,
dbid
è=ğ
C_ERR
)

893 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

896 
d¡
 = 
c
->
db
;

897 
	`£ËùDb
(
c
,
¤cid
);

901 ià(
¤c
 =ğ
d¡
) {

902 
	`addR•ly
(
c
,
sh¬ed
.
§meobjeù”r
);

907 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

908 ià(!
o
) {

909 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

912 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

915 ià(
	`lookupKeyWr™e
(
d¡
,
c
->
¬gv
[1]è!ğ
NULL
) {

916 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

919 
	`dbAdd
(
d¡
,
c
->
¬gv
[1],
o
);

920 ià(
expœe
 !ğ-1è
	`£tExpœe
(
d¡
,
c
->
¬gv
[1],expire);

921 
	`šüRefCouÁ
(
o
);

924 
	`dbD–‘e
(
¤c
,
c
->
¬gv
[1]);

925 
£rv”
.
dœty
++;

926 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

927 
	}
}

933 
	$»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

936 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

937  
	`diùD–‘e
(
db
->
expœes
,
key
->
±r
è=ğ
DICT_OK
;

938 
	}
}

940 
	$£tExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
wh’
) {

941 
diùEÁry
 *
kde
, *
de
;

944 
kde
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

945 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
kde
 != NULL);

946 
de
 = 
	`diùR•ÏûRaw
(
db
->
expœes
,
	`diùG‘Key
(
kde
));

947 
	`diùS‘SigÃdIÁeg”V®
(
de
,
wh’
);

948 
	}
}

952 
	$g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
) {

953 
diùEÁry
 *
de
;

956 ià(
	`diùSize
(
db
->
expœes
) == 0 ||

957 (
de
 = 
	`diùFšd
(
db
->
expœes
,
key
->
±r
)è=ğ
NULL
)  -1;

961 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

962  
	`diùG‘SigÃdIÁeg”V®
(
de
);

963 
	}
}

973 
	$´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
Ïzy
) {

974 
robj
 *
¬gv
[2];

976 
¬gv
[0] = 
Ïzy
 ? 
sh¬ed
.
uÆšk
 : sh¬ed.
d–
;

977 
¬gv
[1] = 
key
;

978 
	`šüRefCouÁ
(
¬gv
[0]);

979 
	`šüRefCouÁ
(
¬gv
[1]);

981 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
)

982 
	`ãedAµ’dOÆyFe
(
£rv”
.
d–Commªd
,
db
->
id
,
¬gv
,2);

983 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
,
db
->
id
,
¬gv
,2);

985 
	`deüRefCouÁ
(
¬gv
[0]);

986 
	`deüRefCouÁ
(
¬gv
[1]);

987 
	}
}

989 
	$expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
) {

990 
m¡ime_t
 
wh’
 = 
	`g‘Expœe
(
db
,
key
);

991 
m¡ime_t
 
now
;

993 ià(
wh’
 < 0)  0;

996 ià(
£rv”
.
lßdšg
)  0;

1003 
now
 = 
£rv”
.
lua_ÿÎ”
 ? s”v”.
lua_time_¡¬t
 : 
	`m¡ime
();

1012 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
è 
now
 > 
wh’
;

1015 ià(
now
 <ğ
wh’
)  0;

1018 
£rv”
.
¡©_expœedkeys
++;

1019 
	`´İag©eExpœe
(
db
,
key
,
£rv”
.
Ïzyä“_Ïzy_expœe
);

1020 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EXPIRED
,

1021 "expœed",
key
,
db
->
id
);

1022  
£rv”
.
Ïzyä“_Ïzy_expœe
 ? 
	`dbAsyncD–‘e
(
db
,
key
) :

1023 
	`dbSyncD–‘e
(
db
,
key
);

1024 
	}
}

1032 *
	$g‘KeysUsšgCommªdTabË
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1033 
j
, 
i
 = 0, 
Ï¡
, *
keys
;

1034 
	`UNUSED
(
¬gv
);

1036 ià(
cmd
->
fœ¡key
 == 0) {

1037 *
numkeys
 = 0;

1038  
NULL
;

1040 
Ï¡
 = 
cmd
->
Ï¡key
;

1041 ià(
Ï¡
 < 0èÏ¡ = 
¬gc
+last;

1042 
keys
 = 
	`zm®loc
(()*((
Ï¡
 - 
cmd
->
fœ¡key
)+1));

1043 
j
 = 
cmd
->
fœ¡key
; j <ğ
Ï¡
; j +ğcmd->
key¡•
) {

1044 
	`£rv”As£¹
(
j
 < 
¬gc
);

1045 
keys
[
i
++] = 
j
;

1047 *
numkeys
 = 
i
;

1048  
keys
;

1049 
	}
}

1062 *
	$g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1063 ià(
cmd
->
æags
 & 
CMD_MODULE_GETKEYS
) {

1064  
	`moduËG‘CommªdKeysVŸAPI
(
cmd
,
¬gv
,
¬gc
,
numkeys
);

1065 } ià(!(
cmd
->
æags
 & 
CMD_MODULE
è&& cmd->
g‘keys_´oc
) {

1066  
cmd
->
	`g‘keys_´oc
(cmd,
¬gv
,
¬gc
,
numkeys
);

1068  
	`g‘KeysUsšgCommªdTabË
(
cmd
,
¬gv
,
¬gc
,
numkeys
);

1070 
	}
}

1073 
	$g‘KeysF»eResuÉ
(*
»suÉ
) {

1074 
	`zä“
(
»suÉ
);

1075 
	}
}

1080 *
	$zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1081 
i
, 
num
, *
keys
;

1082 
	`UNUSED
(
cmd
);

1084 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1087 ià(
num
 > (
¬gc
-3)) {

1088 *
numkeys
 = 0;

1089  
NULL
;

1095 
keys
 = 
	`zm®loc
(()*(
num
+1));

1098 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1101 
keys
[
num
] = 1;

1102 *
numkeys
 = 
num
+1;

1103  
keys
;

1104 
	}
}

1109 *
	$ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1110 
i
, 
num
, *
keys
;

1111 
	`UNUSED
(
cmd
);

1113 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1116 ià(
num
 > (
¬gc
-3)) {

1117 *
numkeys
 = 0;

1118  
NULL
;

1121 
keys
 = 
	`zm®loc
(()*
num
);

1122 *
numkeys
 = 
num
;

1125 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1127  
keys
;

1128 
	}
}

1137 *
	$sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1138 
i
, 
j
, 
num
, *
keys
, 
found_¡Üe
 = 0;

1139 
	`UNUSED
(
cmd
);

1141 
num
 = 0;

1142 
keys
 = 
	`zm®loc
(()*2);

1144 
keys
[
num
++] = 1;

1151 *
Çme
;

1152 
sk
;

1153 } 
skli¡
[] = {

1157 {
NULL
, 0}

1160 
i
 = 2; i < 
¬gc
; i++) {

1161 
j
 = 0; 
skli¡
[j].
Çme
 !ğ
NULL
; j++) {

1162 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,
skli¡
[
j
].
Çme
)) {

1163 
i
 +ğ
skli¡
[
j
].
sk
;

1165 } ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"¡Üe"è&& i+1 < 
¬gc
) {

1169 
found_¡Üe
 = 1;

1170 
keys
[
num
] = 
i
+1;

1175 *
numkeys
 = 
num
 + 
found_¡Üe
;

1176  
keys
;

1177 
	}
}

1179 *
	$mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1180 
i
, 
num
, 
fœ¡
, *
keys
;

1181 
	`UNUSED
(
cmd
);

1184 
fœ¡
 = 3;

1185 
num
 = 1;

1188 ià(
¬gc
 > 6) {

1189 
i
 = 6; i < 
¬gc
; i++) {

1190 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"keys") &&

1191 
	`sd¦’
(
¬gv
[3]->
±r
) == 0)

1193 
fœ¡
 = 
i
+1;

1194 
num
 = 
¬gc
-
fœ¡
;

1200 
keys
 = 
	`zm®loc
(()*
num
);

1201 
i
 = 0; i < 
num
; i++è
keys
[i] = 
fœ¡
+i;

1202 *
numkeys
 = 
num
;

1203  
keys
;

1204 
	}
}

1209 
	$¦ÙToKeyAdd
(
robj
 *
key
) {

1210 
hash¦Ù
 = 
	`keyHashSlÙ
(
key
->
±r
,
	`sd¦’
(key->ptr));

1212 
sds
 
sdskey
 = 
	`sdsdup
(
key
->
±r
);

1213 
	`z¦In£¹
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
,
hash¦Ù
,
sdskey
);

1214 
	}
}

1216 
	$¦ÙToKeyD–
(
robj
 *
key
) {

1217 
hash¦Ù
 = 
	`keyHashSlÙ
(
key
->
±r
,
	`sd¦’
(key->ptr));

1218 
	`z¦D–‘e
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
,
hash¦Ù
,
key
->
±r
,
NULL
);

1219 
	}
}

1221 
	$¦ÙToKeyFlush
() {

1222 
	`z¦F»e
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
);

1223 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`z¦C»©e
();

1224 
	}
}

1229 
	$g‘KeysInSlÙ
(
hash¦Ù
, 
robj
 **
keys
, 
couÁ
) {

1230 
zskli¡Node
 *
n
;

1231 
z¿nge¥ec
 
¿nge
;

1232 
j
 = 0;

1234 
¿nge
.
mš
 =„ªge.
max
 = 
hash¦Ù
;

1235 
¿nge
.
mšex
 =„ªge.
maxex
 = 0;

1237 
n
 = 
	`z¦Fœ¡InRªge
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
, &
¿nge
);

1238 
n
 &&‚->
scÜe
 =ğ
hash¦Ù
 && 
couÁ
--) {

1239 
keys
[
j
++] = 
	`ü—‹SŒšgObjeù
(
n
->
–e
,
	`sd¦’
(n->ele));

1240 
n
 =‚->
Ëv–
[0].
fÜw¬d
;

1242  
j
;

1243 
	}
}

1247 
	$d–KeysInSlÙ
(
hash¦Ù
) {

1248 
zskli¡Node
 *
n
;

1249 
z¿nge¥ec
 
¿nge
;

1250 
j
 = 0;

1252 
¿nge
.
mš
 =„ªge.
max
 = 
hash¦Ù
;

1253 
¿nge
.
mšex
 =„ªge.
maxex
 = 0;

1255 
n
 = 
	`z¦Fœ¡InRªge
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
, &
¿nge
);

1256 
n
 &&‚->
scÜe
 =ğ
hash¦Ù
) {

1257 
sds
 
sdskey
 = 
n
->
–e
;

1258 
robj
 *
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
,
	`sd¦’
(sdskey));

1259 
n
 =‚->
Ëv–
[0].
fÜw¬d
;

1260 
	`dbD–‘e
(&
£rv”
.
db
[0],
key
);

1261 
	`deüRefCouÁ
(
key
);

1262 
j
++;

1264  
j
;

1265 
	}
}

1267 
	$couÁKeysInSlÙ
(
hash¦Ù
) {

1268 
zskli¡
 *
z¦
 = 
£rv”
.
şu¡”
->
¦Ùs_to_keys
;

1269 
zskli¡Node
 *
zn
;

1270 
z¿nge¥ec
 
¿nge
;

1271 
¿nk
, 
couÁ
 = 0;

1273 
¿nge
.
mš
 =„ªge.
max
 = 
hash¦Ù
;

1274 
¿nge
.
mšex
 =„ªge.
maxex
 = 0;

1277 
zn
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
);

1280 ià(
zn
 !ğ
NULL
) {

1281 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

1282 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

1285 
zn
 = 
	`z¦La¡InRªge
(
z¦
, &
¿nge
);

1288 ià(
zn
 !ğ
NULL
) {

1289 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

1290 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

1293  
couÁ
;

1294 
	}
}

	@debug.c

30 
	~"£rv”.h
"

31 
	~"sha1.h
"

32 
	~"üc64.h
"

34 
	~<¬·/š‘.h
>

35 
	~<sigÇl.h
>

37 #ifdeà
HAVE_BACKTRACE


38 
	~<execšfo.h
>

39 
	~<ucÚ‹xt.h
>

40 
	~<fú.h
>

41 
	~"bio.h
"

44 #ifdeà
__CYGWIN__


45 #iâdeà
SA_ONSTACK


46 
	#SA_ONSTACK
 0x08000000

	)

58 
	$xÜDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
) {

59 
SHA1_CTX
 
ùx
;

60 
hash
[20], *
s
 = 
±r
;

61 
j
;

63 
	`SHA1In™
(&
ùx
);

64 
	`SHA1Upd©e
(&
ùx
,
s
,
Ën
);

65 
	`SHA1Fš®
(
hash
,&
ùx
);

67 
j
 = 0; j < 20; j++)

68 
dige¡
[
j
] ^ğ
hash
[j];

69 
	}
}

71 
	$xÜObjeùDige¡
(*
dige¡
, 
robj
 *
o
) {

72 
o
 = 
	`g‘DecodedObjeù
(o);

73 
	`xÜDige¡
(
dige¡
,
o
->
±r
,
	`sd¦’
(o->ptr));

74 
	`deüRefCouÁ
(
o
);

75 
	}
}

91 
	$mixDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
) {

92 
SHA1_CTX
 
ùx
;

93 *
s
 = 
±r
;

95 
	`xÜDige¡
(
dige¡
,
s
,
Ën
);

96 
	`SHA1In™
(&
ùx
);

97 
	`SHA1Upd©e
(&
ùx
,
dige¡
,20);

98 
	`SHA1Fš®
(
dige¡
,&
ùx
);

99 
	}
}

101 
	$mixObjeùDige¡
(*
dige¡
, 
robj
 *
o
) {

102 
o
 = 
	`g‘DecodedObjeù
(o);

103 
	`mixDige¡
(
dige¡
,
o
->
±r
,
	`sd¦’
(o->ptr));

104 
	`deüRefCouÁ
(
o
);

105 
	}
}

113 
	$compu‹D©a£tDige¡
(*
fš®
) {

114 
dige¡
[20];

115 
buf
[128];

116 
diùI‹¿tÜ
 *
di
 = 
NULL
;

117 
diùEÁry
 *
de
;

118 
j
;

119 
ušt32_t
 
aux
;

121 
	`mem£t
(
fš®
,0,20);

123 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

124 
»disDb
 *
db
 = 
£rv”
.db+
j
;

126 ià(
	`diùSize
(
db
->
diù
) == 0) ;

127 
di
 = 
	`diùG‘I‹¿tÜ
(
db
->
diù
);

131 
aux
 = 
	`htÚl
(
j
);

132 
	`mixDige¡
(
fš®
,&
aux
,(aux));

135 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

136 
sds
 
key
;

137 
robj
 *
keyobj
, *
o
;

138 
expœ‘ime
;

140 
	`mem£t
(
dige¡
,0,20);

141 
key
 = 
	`diùG‘Key
(
de
);

142 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

144 
	`mixDige¡
(
dige¡
,
key
,
	`sd¦’
(key));

146 
o
 = 
	`diùG‘V®
(
de
);

148 
aux
 = 
	`htÚl
(
o
->
ty³
);

149 
	`mixDige¡
(
dige¡
,&
aux
,(aux));

150 
expœ‘ime
 = 
	`g‘Expœe
(
db
,
keyobj
);

153 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

154 
	`mixObjeùDige¡
(
dige¡
,
o
);

155 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

156 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
o
,0,
LIST_TAIL
);

157 
li¡Ty³EÁry
 
’Œy
;

158 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

159 
robj
 *
–eobj
 = 
	`li¡Ty³G‘
(&
’Œy
);

160 
	`mixObjeùDige¡
(
dige¡
,
–eobj
);

161 
	`deüRefCouÁ
(
–eobj
);

163 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

164 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

165 
£tTy³I‹¿tÜ
 *
si
 = 
	`£tTy³In™I‹¿tÜ
(
o
);

166 
sds
 
sd£Ë
;

167 (
sd£Ë
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

168 
	`xÜDige¡
(
dige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

169 
	`sdsä“
(
sd£Ë
);

171 
	`£tTy³R–—£I‹¿tÜ
(
si
);

172 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

173 
–edige¡
[20];

175 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

176 *
zl
 = 
o
->
±r
;

177 *
•Œ
, *
¥Œ
;

178 *
v¡r
;

179 
vËn
;

180 
vÎ
;

181 
scÜe
;

183 
•Œ
 = 
	`zli¡Index
(
zl
,0);

184 
	`£rv”As£¹
(
•Œ
 !ğ
NULL
);

185 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

186 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

188 
•Œ
 !ğ
NULL
) {

189 
	`£rv”As£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vÎ
));

190 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

192 
	`mem£t
(
–edige¡
,0,20);

193 ià(
v¡r
 !ğ
NULL
) {

194 
	`mixDige¡
(
–edige¡
,
v¡r
,
vËn
);

196 
	`Î2¡ršg
(
buf
,(buf),
vÎ
);

197 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

200 
	`¢´štf
(
buf
,(buf),"%.17g",
scÜe
);

201 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

202 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

203 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

205 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

206 
z£t
 *
zs
 = 
o
->
±r
;

207 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
zs
->
diù
);

208 
diùEÁry
 *
de
;

210 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

211 
sds
 
sd£Ë
 = 
	`diùG‘Key
(
de
);

212 *
scÜe
 = 
	`diùG‘V®
(
de
);

214 
	`¢´štf
(
buf
,(buf),"%.17g",*
scÜe
);

215 
	`mem£t
(
–edige¡
,0,20);

216 
	`mixDige¡
(
–edige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

217 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

218 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

220 
	`diùR–—£I‹¿tÜ
(
di
);

222 
	`£rv”Pªic
("Unknown sorted setƒncoding");

224 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

225 
hashTy³I‹¿tÜ
 *
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

226 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

227 
–edige¡
[20];

228 
sds
 
sd£Ë
;

230 
	`mem£t
(
–edige¡
,0,20);

231 
sd£Ë
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_KEY
);

232 
	`mixDige¡
(
–edige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

233 
	`sdsä“
(
sd£Ë
);

234 
sd£Ë
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_VALUE
);

235 
	`mixDige¡
(
–edige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

236 
	`sdsä“
(
sd£Ë
);

237 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

239 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

241 
	`£rv”Pªic
("Unknown objectype");

244 ià(
expœ‘ime
 !ğ-1è
	`xÜDige¡
(
dige¡
,"!!expire!!",10);

246 
	`xÜDige¡
(
fš®
,
dige¡
,20);

247 
	`deüRefCouÁ
(
keyobj
);

249 
	`diùR–—£I‹¿tÜ
(
di
);

251 
	}
}

253 #ià
defšed
(
USE_JEMALLOC
)

254 
	$šputC©Sds
(*
»suÉ
, cÚ¡ *
¡r
) {

256 
sds
 *
šfo
 = (sd *)
»suÉ
;

257 *
šfo
 = 
	`sdsÿt
(*šfo, 
¡r
);

258 
	}
}

261 
	$debugCommªd
(
ş›Á
 *
c
) {

262 ià(
c
->
¬gc
 == 1) {

263 
	`addR•lyE¼Ü
(
c
,"You must specify‡ subcommand for DEBUG. Try DEBUG HELP for info.");

267 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"help")) {

268 *
bËÅ
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

269 
bËn
 = 0;

270 
bËn
++; 
	`addR•lyStus
(
c
,

272 
bËn
++; 
	`addR•lyStus
(
c
,

274 
bËn
++; 
	`addR•lyStus
(
c
,

276 
bËn
++; 
	`addR•lyStus
(
c
,

278 
bËn
++; 
	`addR•lyStus
(
c
,

280 
bËn
++; 
	`addR•lyStus
(
c
,

282 
bËn
++; 
	`addR•lyStus
(
c
,

284 
bËn
++; 
	`addR•lyStus
(
c
,

286 
bËn
++; 
	`addR•lyStus
(
c
,

288 
bËn
++; 
	`addR•lyStus
(
c
,

290 
bËn
++; 
	`addR•lyStus
(
c
,

292 
bËn
++; 
	`addR•lyStus
(
c
,

294 
bËn
++; 
	`addR•lyStus
(
c
,

296 
bËn
++; 
	`addR•lyStus
(
c
,

298 
bËn
++; 
	`addR•lyStus
(
c
,

300 
bËn
++; 
	`addR•lyStus
(
c
,

302 
bËn
++; 
	`addR•lyStus
(
c
,

304 
bËn
++; 
	`addR•lyStus
(
c
,

306 
bËn
++; 
	`addR•lyStus
(
c
,

308 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
bËÅ
,
bËn
);

309 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"segfault")) {

311 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"restart") ||

312 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"crash-and-recover"))

314 
d–ay
 = 0;

315 ià(
c
->
¬gc
 >= 3) {

316 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
d–ay
, 
NULL
)

317 !ğ
C_OK
) ;

318 ià(
d–ay
 < 0) delay = 0;

320 
æags
 = !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"restart") ?

321 (
RESTART_SERVER_GRACEFULLY
|
RESTART_SERVER_CONFIG_REWRITE
) :

322 
RESTART_SERVER_NONE
;

323 
	`»¡¬tS”v”
(
æags
,
d–ay
);

324 
	`addR•lyE¼Ü
(
c
,"failedo„estarthe server. Check server†ogs.");

325 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"oom")) {

326 *
±r
 = 
	`zm®loc
(
ULONG_MAX
);

327 
	`zä“
(
±r
);

328 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

329 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"assert")) {

330 ià(
c
->
¬gc
 >ğ3èc->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

331 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[0],1 == 2);

332 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reload")) {

333 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
è!ğ
C_OK
) {

334 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

337 
	`em±yDb
(-1,
EMPTYDB_NO_FLAGS
,
NULL
);

338 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
è!ğ
C_OK
) {

339 
	`addR•lyE¼Ü
(
c
,"Errorryingo†oadhe RDB dump");

342 
	`£rv”Log
(
LL_WARNING
,"DB„eloaded by DEBUG RELOAD");

343 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

344 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"loadaof")) {

345 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
è
	`æushAµ’dOÆyFe
(1);

346 
	`em±yDb
(-1,
EMPTYDB_NO_FLAGS
,
NULL
);

347 ià(
	`lßdAµ’dOÆyFe
(
£rv”
.
aof_f’ame
è!ğ
C_OK
) {

348 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

351 
£rv”
.
dœty
 = 0;

352 
	`£rv”Log
(
LL_WARNING
,"Append Only File†oaded by DEBUG LOADAOF");

353 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

354 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"objeù"è&& c->
¬gc
 == 3) {

355 
diùEÁry
 *
de
;

356 
robj
 *
v®
;

357 *
¡»nc
;

359 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[2]->
±r
)è=ğ
NULL
) {

360 
	`addR•ly
(
c
,
sh¬ed
.
nokey”r
);

363 
v®
 = 
	`diùG‘V®
(
de
);

364 
¡»nc
 = 
	`¡rEncodšg
(
v®
->
’codšg
);

366 
exŒa
[128] = {0};

367 ià(
v®
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

368 *
ÃxŒa
 = 
exŒa
;

369 
»maššg
 = (
exŒa
);

370 
quickli¡
 *
ql
 = 
v®
->
±r
;

372 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_nodes:%u", 
ql
->
Ën
);

373 
ÃxŒa
 +ğ
u£d
;

374 
»maššg
 -ğ
u£d
;

376 
avg
 = ()
ql
->
couÁ
/ql->
Ën
;

377 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_avg_node:%.2f", 
avg
);

378 
ÃxŒa
 +ğ
u£d
;

379 
»maššg
 -ğ
u£d
;

381 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_zli¡_max:%d", 
ql
->
fl
);

382 
ÃxŒa
 +ğ
u£d
;

383 
»maššg
 -ğ
u£d
;

385 
com´es£d
 = 
ql
->
com´ess
 != 0;

386 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_com´es£d:%d", 
com´es£d
);

387 
ÃxŒa
 +ğ
u£d
;

388 
»maššg
 -ğ
u£d
;

390 
sz
 = 0;

391 
quickli¡Node
 *
node
 = 
ql
->
h—d
;‚ode;‚odğnode->
Ãxt
) {

392 
sz
 +ğ
node
->sz;

394 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_uncom´es£d_size:%lu", 
sz
);

395 
ÃxŒa
 +ğ
u£d
;

396 
»maššg
 -ğ
u£d
;

399 
	`addR•lyStusFÜm©
(
c
,

403 (*)
v®
, v®->
»fcouÁ
,

404 
¡»nc
, 
	`rdbSavedObjeùL’
(
v®
),

405 
v®
->
Ìu
, 
	`e¡im©eObjeùIdËTime
(v®)/1000, 
exŒa
);

406 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"sd¦’"è&& c->
¬gc
 == 3) {

407 
diùEÁry
 *
de
;

408 
robj
 *
v®
;

409 
sds
 
key
;

411 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[2]->
±r
)è=ğ
NULL
) {

412 
	`addR•ly
(
c
,
sh¬ed
.
nokey”r
);

415 
v®
 = 
	`diùG‘V®
(
de
);

416 
key
 = 
	`diùG‘Key
(
de
);

418 ià(
v®
->
ty³
 !ğ
OBJ_STRING
 || !
	`sdsEncodedObjeù
(val)) {

419 
	`addR•lyE¼Ü
(
c
,"Not‡n sdsƒncoded string.");

421 
	`addR•lyStusFÜm©
(
c
,

424 (è
	`sd¦’
(
key
),

425 (è
	`sd§va
(
key
),

426 (è
	`sd¦’
(
v®
->
±r
),

427 (è
	`sd§va
(
v®
->
±r
));

429 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"populate") &&

430 (
c
->
¬gc
 == 3 || c->argc == 4)) {

431 
keys
, 
j
;

432 
robj
 *
key
, *
v®
;

433 
buf
[128];

435 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
keys
, 
NULL
è!ğ
C_OK
)

437 
	`diùEx·nd
(
c
->
db
->
diù
,
keys
);

438 
j
 = 0; j < 
keys
; j++) {

439 
	`¢´štf
(
buf
,(buf),"%s:%lu",

440 (
c
->
¬gc
 =ğ3è? "key" : (*)c->
¬gv
[3]->
±r
, 
j
);

441 
key
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

442 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
è!ğ
NULL
) {

443 
	`deüRefCouÁ
(
key
);

446 
	`¢´štf
(
buf
,(buf),"v®ue:%lu",
j
);

447 
v®
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

448 
	`dbAdd
(
c
->
db
,
key
,
v®
);

449 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

450 
	`deüRefCouÁ
(
key
);

452 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

453 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"dige¡"è&& c->
¬gc
 == 2) {

454 
dige¡
[20];

455 
sds
 
d
 = 
	`sd£m±y
();

456 
j
;

458 
	`compu‹D©a£tDige¡
(
dige¡
);

459 
j
 = 0; j < 20; j++)

460 
d
 = 
	`sdsÿrštf
(d, "%02x",
dige¡
[
j
]);

461 
	`addR•lyStus
(
c
,
d
);

462 
	`sdsä“
(
d
);

463 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦“p"è&& c->
¬gc
 == 3) {

464 
dtime
 = 
	`¡¹od
(
c
->
¬gv
[2]->
±r
,
NULL
);

465 
utime
 = 
dtime
*1000000;

466 
time¥ec
 
tv
;

468 
tv
.
tv_£c
 = 
utime
 / 1000000;

469 
tv
.
tv_n£c
 = (
utime
 % 1000000) * 1000;

470 
	`Çno¦“p
(&
tv
, 
NULL
);

471 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

472 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set-active-expire") &&

473 
c
->
¬gc
 == 3)

475 
£rv”
.
aùive_expœe_’abËd
 = 
	`©oi
(
c
->
¬gv
[2]->
±r
);

476 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

477 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"lua-always-replicate-commands") &&

478 
c
->
¬gc
 == 3)

480 
£rv”
.
lua_®ways_»¶iÿ‹_commªds
 = 
	`©oi
(
c
->
¬gv
[2]->
±r
);

481 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

482 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"”rÜ"è&& c->
¬gc
 == 3) {

483 
sds
 
”r¡r
 = 
	`sd¢ewËn
("-",1);

485 
”r¡r
 = 
	`sdsÿtsds
Ó¼¡r,
c
->
¬gv
[2]->
±r
);

486 
”r¡r
 = 
	`sdsm­ch¬s
(errstr,"\n\r"," ",2);

487 
”r¡r
 = 
	`sdsÿ’
(errstr,"\r\n",2);

488 
	`addR•lySds
(
c
,
”r¡r
);

489 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¡ruùsize"è&& c->
¬gc
 == 2) {

490 
sds
 
sizes
 = 
	`sd£m±y
();

491 
sizes
 = 
	`sdsÿrštf
(sizes,"bits:%d ",((*) == 8)?64:32);

492 
sizes
 = 
	`sdsÿrštf
(sizes,"robj:%d ",()(
robj
));

493 
sizes
 = 
	`sdsÿrštf
(sizes,"diù’Œy:%d ",()(
diùEÁry
));

494 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr5:%d ",()(
sdshdr5
));

495 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr8:%d ",()(
sdshdr8
));

496 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr16:%d ",()(
sdshdr16
));

497 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr32:%d ",()(
sdshdr32
));

498 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr64:%d ",()(
sdshdr64
));

499 
	`addR•lyBulkSds
(
c
,
sizes
);

500 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"ht¡©s"è&& c->
¬gc
 == 3) {

501 
dbid
;

502 
sds
 
¡©s
 = 
	`sd£m±y
();

503 
buf
[4096];

505 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
dbid
, 
NULL
è!ğ
C_OK
)

507 ià(
dbid
 < 0 || dbid >ğ
£rv”
.
dbnum
) {

508 
	`addR•lyE¼Ü
(
c
,"Out of„ange database");

512 
¡©s
 = 
	`sdsÿrštf
(stats,"[Dictionary HT]\n");

513 
	`diùG‘Sts
(
buf
,(buf),
£rv”
.
db
[
dbid
].
diù
);

514 
¡©s
 = 
	`sdsÿt
(¡©s,
buf
);

516 
¡©s
 = 
	`sdsÿrštf
(stats,"[Expires HT]\n");

517 
	`diùG‘Sts
(
buf
,(buf),
£rv”
.
db
[
dbid
].
expœes
);

518 
¡©s
 = 
	`sdsÿt
(¡©s,
buf
);

520 
	`addR•lyBulkSds
(
c
,
¡©s
);

521 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"jem®loc"è&& c->
¬gc
 == 3) {

522 #ià
	`defšed
(
USE_JEMALLOC
)

523 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
, "info")) {

524 
sds
 
šfo
 = 
	`sd£m±y
();

525 
	`je_m®loc_¡©s_´št
(
šputC©Sds
, &
šfo
, 
NULL
);

526 
	`addR•lyBulkSds
(
c
, 
šfo
);

527 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
, "purge")) {

528 
tmp
[32];

529 
Ç»Çs
 = 0;

530 
size_t
 
sz
 = ();

531 ià(!
	`je_m®lùl
("¬’as.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0)) {

532 
	`¥rštf
(
tmp
, "¬’a.%d.purge", 
Ç»Çs
);

533 ià(!
	`je_m®lùl
(
tmp
, 
NULL
, 0, NULL, 0)) {

534 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

538 
	`addR•lyE¼Ü
(
c
, "Error…urging dirty…ages");

540 
	`addR•lyE¼ÜFÜm©
(
c
, "Valid jemalloc debug fields: info,…urge");

543 
	`addR•lyE¼ÜFÜm©
(
c
, "jemalloc support‚ot‡vailable");

546 
	`addR•lyE¼ÜFÜm©
(
c
, "Unknown DEBUG subcommand or wrong‚umber of‡rguments for '%s'",

547 (*)
c
->
¬gv
[1]->
±r
);

549 
	}
}

553 
	$_£rv”As£¹
(cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
) {

554 
	`bugR•ÜtS¹
();

555 
	`£rv”Log
(
LL_WARNING
,"=== ASSERTION FAILED ===");

556 
	`£rv”Log
(
LL_WARNING
,"==> %s:%d '%s' i nÙrue",
fe
,
lše
,
e¡r
);

557 #ifdeà
HAVE_BACKTRACE


558 
£rv”
.
as£¹_çed
 = 
e¡r
;

559 
£rv”
.
as£¹_fe
 = 
fe
;

560 
£rv”
.
as£¹_lše
 = 
lše
;

561 
	`£rv”Log
(
LL_WARNING
,"(forcing SIGSEGVo…rinthe bug„eport.)");

564 
	}
}

566 
	$_£rv”As£¹PrštCl›ÁInfo
(cÚ¡ 
ş›Á
 *
c
) {

567 
j
;

569 
	`bugR•ÜtS¹
();

570 
	`£rv”Log
(
LL_WARNING
,"=== ASSERTION FAILED CLIENT CONTEXT ===");

571 
	`£rv”Log
(
LL_WARNING
,"ş›Á->æag ğ%d", 
c
->
æags
);

572 
	`£rv”Log
(
LL_WARNING
,"ş›Á->fd = %d", 
c
->
fd
);

573 
	`£rv”Log
(
LL_WARNING
,"ş›Á->¬gøğ%d", 
c
->
¬gc
);

574 
j
=0; j < 
c
->
¬gc
; j++) {

575 
buf
[128];

576 *
¬g
;

578 ià(
c
->
¬gv
[
j
]->
ty³
 =ğ
OBJ_STRING
 && 
	`sdsEncodedObjeù
(c->argv[j])) {

579 
¬g
 = (*è
c
->
¬gv
[
j
]->
±r
;

581 
	`¢´štf
(
buf
,(buf),"Objectype: %u,ƒncoding: %u",

582 
c
->
¬gv
[
j
]->
ty³
, c->¬gv[j]->
’codšg
);

583 
¬g
 = 
buf
;

585 
	`£rv”Log
(
LL_WARNING
,"client->argv[%d] = \"%s\" (refcount: %d)",

586 
j
, 
¬g
, 
c
->
¬gv
[j]->
»fcouÁ
);

588 
	}
}

590 
	$£rv”LogObjeùDebugInfo
(cÚ¡ 
robj
 *
o
) {

591 
	`£rv”Log
(
LL_WARNING
,"Objeùy³: %d", 
o
->
ty³
);

592 
	`£rv”Log
(
LL_WARNING
,"Objeùƒncodšg: %d", 
o
->
’codšg
);

593 
	`£rv”Log
(
LL_WARNING
,"Objeù„efcouÁ: %d", 
o
->
»fcouÁ
);

594 ià(
o
->
ty³
 =ğ
OBJ_STRING
 && 
	`sdsEncodedObjeù
(o)) {

595 
	`£rv”Log
(
LL_WARNING
,"Objeù„aw sŒšg†’: %zu", 
	`sd¦’
(
o
->
±r
));

596 ià(
	`sd¦’
(
o
->
±r
) < 4096) {

597 
sds
 
»´
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
o
->
±r
,
	`sd¦’
(o->ptr));

598 
	`£rv”Log
(
LL_WARNING
,"Objeù„aw sŒšg cÚ‹Á: %s", 
»´
);

599 
	`sdsä“
(
»´
);

601 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

602 
	`£rv”Log
(
LL_WARNING
,"Li¡†’gth: %d", (è
	`li¡Ty³L’gth
(
o
));

603 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

604 
	`£rv”Log
(
LL_WARNING
,"S‘ size: %d", (è
	`£tTy³Size
(
o
));

605 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

606 
	`£rv”Log
(
LL_WARNING
,"Hash size: %d", (è
	`hashTy³L’gth
(
o
));

607 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

608 
	`£rv”Log
(
LL_WARNING
,"SÜ‹d s‘ size: %d", (è
	`z£tL’gth
(
o
));

609 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
)

610 
	`£rv”Log
(
LL_WARNING
,"Skli¡†ev–: %d", (è((cÚ¡ 
z£t
*)
o
->
±r
)->
z¦
->
Ëv–
);

612 
	}
}

614 
	$_£rv”As£¹PrštObjeù
(cÚ¡ 
robj
 *
o
) {

615 
	`bugR•ÜtS¹
();

616 
	`£rv”Log
(
LL_WARNING
,"=== ASSERTION FAILED OBJECT CONTEXT ===");

617 
	`£rv”LogObjeùDebugInfo
(
o
);

618 
	}
}

620 
	$_£rv”As£¹W™hInfo
(cÚ¡ 
ş›Á
 *
c
, cÚ¡ 
robj
 *
o
, cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
) {

621 ià(
c
è
	`_£rv”As£¹PrštCl›ÁInfo
(c);

622 ià(
o
è
	`_£rv”As£¹PrštObjeù
(o);

623 
	`_£rv”As£¹
(
e¡r
,
fe
,
lše
);

624 
	}
}

626 
	$_£rv”Pªic
(cÚ¡ *
msg
, cÚ¡ *
fe
, 
lše
) {

627 
	`bugR•ÜtS¹
();

628 
	`£rv”Log
(
LL_WARNING
,"------------------------------------------------");

629 
	`£rv”Log
(
LL_WARNING
,"!!! Software Failure. Press†eft mouse buttono continue");

630 
	`£rv”Log
(
LL_WARNING
,"Guru Med™©iÚ: % #%s:%d",
msg
,
fe
,
lše
);

631 #ifdeà
HAVE_BACKTRACE


632 
	`£rv”Log
(
LL_WARNING
,"(forcing SIGSEGV in ordero…rinthe stackrace)");

634 
	`£rv”Log
(
LL_WARNING
,"------------------------------------------------");

636 
	}
}

638 
	$bugR•ÜtS¹
() {

639 ià(
£rv”
.
bug_»pÜt_¡¬t
 == 0) {

640 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

642 
£rv”
.
bug_»pÜt_¡¬t
 = 1;

644 
	}
}

646 #ifdeà
HAVE_BACKTRACE


647 *
	$g‘McÚ‹xtE
(
ucÚ‹xt_t
 *
uc
) {

648 #ià
	`defšed
(
__APPLE__
è&& !defšed(
MAC_OS_X_VERSION_10_6
)

650 #ià
	`defšed
(
__x86_64__
)

651  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
;

652 #–ià
	`defšed
(
__i386__
)

653  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
;

655  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__¤r0
;

657 #–ià
	`defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)

659 #ià
	`defšed
(
_STRUCT_X86_THREAD_STATE64
è&& !defšed(
__i386__
)

660  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
;

662  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
;

664 #–ià
	`defšed
(
__lšux__
)

666 #ià
	`defšed
(
__i386__
)

667  (*è
uc
->
uc_mcÚ‹xt
.
g»gs
[14];

668 #–ià
	`defšed
(
__X86_64__
è|| defšed(
__x86_64__
)

669  (*è
uc
->
uc_mcÚ‹xt
.
g»gs
[16];

670 #–ià
	`defšed
(
__Ÿ64__
)

671  (*è
uc
->
uc_mcÚ‹xt
.
sc_
;

674  
NULL
;

676 
	}
}

678 
	$logSckCÚ‹Á
(**
¥
) {

679 
i
;

680 
i
 = 15; i >= 0; i--) {

681 
addr
 = (è
¥
+
i
;

682 
v®
 = (è
¥
[
i
];

685 
	`£rv”Log
(
LL_WARNING
, "(%08lxè-> %08lx", 
addr
, 
v®
);

687 
	`£rv”Log
(
LL_WARNING
, "(%016lxè-> %016lx", 
addr
, 
v®
);

689 
	}
}

691 
	$logRegi¡”s
(
ucÚ‹xt_t
 *
uc
) {

692 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
, "\n------ REGISTERS ------\n");

695 #ià
	`defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)

697 #ià
	`defšed
(
_STRUCT_X86_THREAD_STATE64
è&& !defšed(
__i386__
)

698 
	`£rv”Log
(
LL_WARNING
,

705 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__¿x
,

706 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rbx
,

707 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rcx
,

708 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rdx
,

709 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rdi
,

710 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rsi
,

711 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rbp
,

712 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r¥
,

713 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r8
,

714 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r9
,

715 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r10
,

716 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r11
,

717 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r12
,

718 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r13
,

719 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r14
,

720 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r15
,

721 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
,

722 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ræags
,

723 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__cs
,

724 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__fs
,

725 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__gs


727 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
->
__ss
.
__r¥
);

730 
	`£rv”Log
(
LL_WARNING
,

736 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__—x
,

737 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ebx
,

738 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ecx
,

739 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__edx
,

740 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__edi
,

741 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__esi
,

742 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ebp
,

743 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e¥
,

744 (è
uc
->
uc_mcÚ‹xt
->
__ss
.__ss,

745 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__eæags
,

746 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
,

747 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__cs
,

748 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ds
,

749 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__es
,

750 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__fs
,

751 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__gs


753 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
->
__ss
.
__e¥
);

756 #–ià
	`defšed
(
__lšux__
)

758 #ià
	`defšed
(
__i386__
)

759 
	`£rv”Log
(
LL_WARNING
,

765 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[11],

766 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[8],

767 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[10],

768 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[9],

769 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[4],

770 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[5],

771 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[6],

772 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[7],

773 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[18],

774 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[17],

775 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[14],

776 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[15],

777 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[3],

778 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[2],

779 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[1],

780 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[0]

782 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
.
g»gs
[7]);

783 #–ià
	`defšed
(
__X86_64__
è|| defšed(
__x86_64__
)

785 
	`£rv”Log
(
LL_WARNING
,

792 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[13],

793 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[11],

794 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[14],

795 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[12],

796 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[8],

797 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[9],

798 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[10],

799 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[15],

800 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[0],

801 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[1],

802 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[2],

803 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[3],

804 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[4],

805 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[5],

806 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[6],

807 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[7],

808 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[16],

809 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[17],

810 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[18]

812 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
.
g»gs
[15]);

815 
	`£rv”Log
(
LL_WARNING
,

818 
	}
}

826 
	$İ’DœeùLogFedes
() {

827 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

828 
fd
 = 
log_to_¡dout
 ?

829 
STDOUT_FILENO
 :

830 
	`İ’
(
£rv”
.
logfe
, 
O_APPEND
|
O_CREAT
|
O_WRONLY
, 0644);

831  
fd
;

832 
	}
}

835 
	$şo£DœeùLogFedes
(
fd
) {

836 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

837 ià(!
log_to_¡dout
è
	`şo£
(
fd
);

838 
	}
}

842 
	$logSckT¿û
(
ucÚ‹xt_t
 *
uc
) {

843 *
Œaû
[101];

844 
Œaû_size
 = 0, 
fd
 = 
	`İ’DœeùLogFedes
();

846 ià(
fd
 == -1) ;

849 
Œaû_size
 = 
	`backŒaû
(
Œaû
+1, 100);

851 ià(
	`g‘McÚ‹xtE
(
uc
è!ğ
NULL
) {

852 *
msg1
 = "EIP:\n";

853 *
msg2
 = "\nBacktrace:\n";

854 ià(
	`wr™e
(
fd
,
msg1
,
	`¡¾’
(msg1)) == -1) { };

855 
Œaû
[0] = 
	`g‘McÚ‹xtE
(
uc
);

856 
	`backŒaû_symbŞs_fd
(
Œaû
, 1, 
fd
);

857 ià(
	`wr™e
(
fd
,
msg2
,
	`¡¾’
(msg2)) == -1) { };

861 
	`backŒaû_symbŞs_fd
(
Œaû
+1, 
Œaû_size
, 
fd
);

864 
	`şo£DœeùLogFedes
(
fd
);

865 
	}
}

870 
	$logCu¼’tCl›Á
() {

871 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
NULL
) ;

873 
ş›Á
 *
cc
 = 
£rv”
.
cu¼’t_ş›Á
;

874 
sds
 
ş›Á
;

875 
j
;

877 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ CURRENT CLIENT INFO ------\n");

878 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
cc
);

879 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
,"%s\n", 
ş›Á
);

880 
	`sdsä“
(
ş›Á
);

881 
j
 = 0; j < 
cc
->
¬gc
; j++) {

882 
robj
 *
decoded
;

884 
decoded
 = 
	`g‘DecodedObjeù
(
cc
->
¬gv
[
j
]);

885 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
,"¬gv[%d]: '%s'\n", 
j
,

886 (*)
decoded
->
±r
);

887 
	`deüRefCouÁ
(
decoded
);

891 ià(
cc
->
¬gc
 >= 1) {

892 
robj
 *
v®
, *
key
;

893 
diùEÁry
 *
de
;

895 
key
 = 
	`g‘DecodedObjeù
(
cc
->
¬gv
[1]);

896 
de
 = 
	`diùFšd
(
cc
->
db
->
diù
, 
key
->
±r
);

897 ià(
de
) {

898 
v®
 = 
	`diùG‘V®
(
de
);

899 
	`£rv”Log
(
LL_WARNING
,"key '%s' found iÀDB cÚššghfŞlowšg objeù:", (*)
key
->
±r
);

900 
	`£rv”LogObjeùDebugInfo
(
v®
);

902 
	`deüRefCouÁ
(
key
);

904 
	}
}

906 #ià
defšed
(
HAVE_PROC_MAPS
)

908 
	#MEMTEST_MAX_REGIONS
 128

	)

911 
	$mem‹¡_‹¡_lšux_ªÚymous_m­s
() {

912 
FILE
 *
å
;

913 
lše
[1024];

914 
logbuf
[1024];

915 
size_t
 
¡¬t_addr
, 
’d_addr
, 
size
;

916 
size_t
 
¡¬t_veù
[
MEMTEST_MAX_REGIONS
];

917 
size_t
 
size_veù
[
MEMTEST_MAX_REGIONS
];

918 
»giÚs
 = 0, 
j
;

920 
fd
 = 
	`İ’DœeùLogFedes
();

921 ià(!
fd
)  0;

923 
å
 = 
	`fİ’
("/proc/self/maps","r");

924 ià(!
å
)  0;

925 
	`fg‘s
(
lše
,Öše),
å
è!ğ
NULL
) {

926 *
¡¬t
, *
’d
, *
p
 = 
lše
;

928 
¡¬t
 = 
p
;

929 
p
 = 
	`¡rchr
(p,'-');

930 ià(!
p
) ;

931 *
p
++ = '\0';

932 
’d
 = 
p
;

933 
p
 = 
	`¡rchr
(p,' ');

934 ià(!
p
) ;

935 *
p
++ = '\0';

936 ià(
	`¡r¡r
(
p
,"stack") ||

937 
	`¡r¡r
(
p
,"vdso") ||

938 
	`¡r¡r
(
p
,"vsyscall")) ;

939 ià(!
	`¡r¡r
(
p
,"00:00")) ;

940 ià(!
	`¡r¡r
(
p
,"rw")) ;

942 
¡¬t_addr
 = 
	`¡¹oul
(
¡¬t
,
NULL
,16);

943 
’d_addr
 = 
	`¡¹oul
(
’d
,
NULL
,16);

944 
size
 = 
’d_addr
-
¡¬t_addr
;

946 
¡¬t_veù
[
»giÚs
] = 
¡¬t_addr
;

947 
size_veù
[
»giÚs
] = 
size
;

948 
	`¢´štf
(
logbuf
,(logbuf),

950 (è
¡¬t_veù
[
»giÚs
],

951 (è
size_veù
[
»giÚs
]);

952 ià(
	`wr™e
(
fd
,
logbuf
,
	`¡¾’
(logbuf)) == -1) { }

953 
»giÚs
++;

956 
”rÜs
 = 0;

957 
j
 = 0; j < 
»giÚs
; j++) {

958 ià(
	`wr™e
(
fd
,".",1) == -1) { }

959 
”rÜs
 +ğ
	`mem‹¡_´e£rvšg_‹¡
((*)
¡¬t_veù
[
j
],
size_veù
[j],1);

960 ià(
	`wr™e
(
fd
, 
”rÜs
 ? "E" : "O",1) == -1) { }

962 ià(
	`wr™e
(
fd
,"\n",1) == -1) { }

967 
	`fşo£
(
å
);

968 
	`şo£DœeùLogFedes
(
fd
);

969  
”rÜs
;

970 
	}
}

973 
	$sig£gvHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

974 
ucÚ‹xt_t
 *
uc
 = (ucÚ‹xt_t*è
£ü‘
;

975 *
e
 = 
	`g‘McÚ‹xtE
(
uc
);

976 
sds
 
šfo¡ršg
, 
ş›Ás
;

977 
sigaùiÚ
 
aù
;

978 
	`UNUSED
(
šfo
);

980 
	`bugR•ÜtS¹
();

981 
	`£rv”Log
(
LL_WARNING
,

982 "Redi % üashed by sigÇl: %d", 
REDIS_VERSION
, 
sig
);

983 ià(
e
 !ğ
NULL
) {

984 
	`£rv”Log
(
LL_WARNING
,

985 "C¿shed„uÂšghš¡uùiÚ‡t: %p", 
e
);

987 ià(
sig
 =ğ
SIGSEGV
 || sig =ğ
SIGBUS
) {

988 
	`£rv”Log
(
LL_WARNING
,

989 "Acûssšg‡dd»ss: %p", (*)
šfo
->
si_addr
);

991 
	`£rv”Log
(
LL_WARNING
,

992 "Faed‡s£¹iÚ: % (%s:%d)", 
£rv”
.
as£¹_çed
,

993 
£rv”
.
as£¹_fe
, s”v”.
as£¹_lše
);

996 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ STACK TRACE ------\n");

997 
	`logSckT¿û
(
uc
);

1000 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ INFO OUTPUT ------\n");

1001 
šfo¡ršg
 = 
	`g’RedisInfoSŒšg
("all");

1002 
šfo¡ršg
 = 
	`sdsÿrštf
(infostring, "hash_init_value: %u\n",

1003 
	`diùG‘HashFunùiÚS“d
());

1004 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, 
šfo¡ršg
);

1005 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ CLIENT LIST OUTPUT ------\n");

1006 
ş›Ás
 = 
	`g‘AÎCl›ÁsInfoSŒšg
();

1007 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, 
ş›Ás
);

1008 
	`sdsä“
(
šfo¡ršg
);

1009 
	`sdsä“
(
ş›Ás
);

1012 
	`logCu¼’tCl›Á
();

1015 
	`logRegi¡”s
(
uc
);

1017 #ià
	`defšed
(
HAVE_PROC_MAPS
)

1019 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ FAST MEMORY TEST ------\n");

1020 
	`bioKlTh»ads
();

1021 ià(
	`mem‹¡_‹¡_lšux_ªÚymous_m­s
()) {

1022 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

1025 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

1030 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

1037 ià(
£rv”
.
d«mÚize
 && s”v”.
su³rvi£d
 =ğ0è
	`uÆšk
(£rv”.
pidfe
);

1041 
	`sigem±y£t
 (&
aù
.
§_mask
);

1042 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_ONSTACK
 | 
SA_RESETHAND
;

1043 
aù
.
§_hªdËr
 = 
SIG_DFL
;

1044 
	`sigaùiÚ
 (
sig
, &
aù
, 
NULL
);

1045 
	`kl
(
	`g‘pid
(),
sig
);

1046 
	}
}

1051 
	$£rv”LogHexDump
(
Ëv–
, *
desü
, *
v®ue
, 
size_t
 
Ën
) {

1052 
buf
[65], *
b
;

1053 *
v
 = 
v®ue
;

1054 
ch¬£t
[] = "0123456789abcdef";

1056 
	`£rv”Log
(
Ëv–
,"% (hexdump):", 
desü
);

1057 
b
 = 
buf
;

1058 
Ën
) {

1059 
b
[0] = 
ch¬£t
[(*
v
)>>4];

1060 
b
[1] = 
ch¬£t
[(*
v
)&0xf];

1061 
b
[2] = '\0';

1062 
b
 += 2;

1063 
Ën
--;

1064 
v
++;

1065 ià(
b
-
buf
 =ğ64 || 
Ën
 == 0) {

1066 
	`£rv”LogRaw
(
Ëv–
|
LL_RAW
,
buf
);

1067 
b
 = 
buf
;

1070 
	`£rv”LogRaw
(
Ëv–
|
LL_RAW
,"\n");

1071 
	}
}

1074 
	~<sys/time.h
>

1076 
	$w©chdogSigÇlHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

1077 #ifdeà
HAVE_BACKTRACE


1078 
ucÚ‹xt_t
 *
uc
 = (ucÚ‹xt_t*è
£ü‘
;

1080 
	`UNUSED
(
šfo
);

1081 
	`UNUSED
(
sig
);

1083 
	`£rv”LogFromHªdËr
(
LL_WARNING
,"\n--- WATCHDOG TIMER EXPIRED ---");

1084 #ifdeà
HAVE_BACKTRACE


1085 
	`logSckT¿û
(
uc
);

1087 
	`£rv”LogFromHªdËr
(
LL_WARNING
,"Sorry:‚o support for backtrace().");

1089 
	`£rv”LogFromHªdËr
(
LL_WARNING
,"--------\n");

1090 
	}
}

1095 
	$w©chdogScheduËSigÇl
(
³riod
) {

1096 
™im”v®
 
™
;

1099 
™
.
™_v®ue
.
tv_£c
 = 
³riod
/1000;

1100 
™
.
™_v®ue
.
tv_u£c
 = (
³riod
%1000)*1000;

1102 
™
.
™_š‹rv®
.
tv_£c
 = 0;

1103 
™
.
™_š‹rv®
.
tv_u£c
 = 0;

1104 
	`£t™im”
(
ITIMER_REAL
, &
™
, 
NULL
);

1105 
	}
}

1108 
	$’abËW©chdog
(
³riod
) {

1109 
mš_³riod
;

1111 ià(
£rv”
.
w©chdog_³riod
 == 0) {

1112 
sigaùiÚ
 
aù
;

1116 
	`sigem±y£t
(&
aù
.
§_mask
);

1117 
aù
.
§_æags
 = 
SA_ONSTACK
 | 
SA_SIGINFO
;

1118 
aù
.
§_sigaùiÚ
 = 
w©chdogSigÇlHªdËr
;

1119 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

1124 
mš_³riod
 = (1000/
£rv”
.
hz
)*2;

1125 ià(
³riod
 < 
mš_³riod
)…eriod = min_period;

1126 
	`w©chdogScheduËSigÇl
(
³riod
);

1127 
£rv”
.
w©chdog_³riod
 = 
³riod
;

1128 
	}
}

1131 
	$di§bËW©chdog
() {

1132 
sigaùiÚ
 
aù
;

1133 ià(
£rv”
.
w©chdog_³riod
 == 0) ;

1134 
	`w©chdogScheduËSigÇl
(0);

1138 
	`sigem±y£t
(&
aù
.
§_mask
);

1139 
aù
.
§_æags
 = 0;

1140 
aù
.
§_hªdËr
 = 
SIG_IGN
;

1141 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

1142 
£rv”
.
w©chdog_³riod
 = 0;

1143 
	}
}

	@dict.c

36 
	~"fmaüos.h
"

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<¡ršg.h
>

41 
	~<¡d¬g.h
>

42 
	~<lim™s.h
>

43 
	~<sys/time.h
>

44 
	~<ùy³.h
>

46 
	~"diù.h
"

47 
	~"zm®loc.h
"

48 
	~"»di§s£¹.h
"

58 
	gdiù_ÿn_»size
 = 1;

59 
	gdiù_fÜû_»size_¿tio
 = 5;

63 
_diùEx·ndIfN“ded
(
diù
 *
ht
);

64 
_diùNextPow”
(
size
);

65 
_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
);

66 
_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

71 
	$diùIÁHashFunùiÚ
(
key
)

73 
key
 += ~(key << 15);

74 
key
 ^= (key >> 10);

75 
key
 += (key << 3);

76 
key
 ^= (key >> 6);

77 
key
 += ~(key << 11);

78 
key
 ^= (key >> 16);

79  
key
;

80 
	}
}

82 
ušt32_t
 
	gdiù_hash_funùiÚ_£ed
 = 5381;

84 
	$diùS‘HashFunùiÚS“d
(
ušt32_t
 
£ed
) {

85 
diù_hash_funùiÚ_£ed
 = 
£ed
;

86 
	}
}

88 
ušt32_t
 
	$diùG‘HashFunùiÚS“d
() {

89  
diù_hash_funùiÚ_£ed
;

90 
	}
}

103 
	$diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
) {

106 
ušt32_t
 
£ed
 = 
diù_hash_funùiÚ_£ed
;

107 cÚ¡ 
ušt32_t
 
m
 = 0x5bd1e995;

108 cÚ¡ 
r
 = 24;

111 
ušt32_t
 
h
 = 
£ed
 ^ 
Ën
;

114 cÚ¡ *
d©a
 = (cÚ¡ *)
key
;

116 
Ën
 >= 4) {

117 
ušt32_t
 
k
 = *(ušt32_t*)
d©a
;

119 
k
 *ğ
m
;

120 
k
 ^ğk >> 
r
;

121 
k
 *ğ
m
;

123 
h
 *ğ
m
;

124 
h
 ^ğ
k
;

126 
d©a
 += 4;

127 
Ën
 -= 4;

131 
Ën
) {

132 3: 
h
 ^ğ
d©a
[2] << 16;

133 2: 
h
 ^ğ
d©a
[1] << 8;

134 1: 
h
 ^ğ
d©a
[0]; h *ğ
m
;

139 
h
 ^= h >> 13;

140 
h
 *ğ
m
;

141 
h
 ^= h >> 15;

143  ()
h
;

144 
	}
}

147 
	$diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
) {

148 
hash
 = ()
diù_hash_funùiÚ_£ed
;

150 
Ën
--)

151 
hash
 = ((hash << 5è+ hashè+ (
	`tŞow”
(*
buf
++));

152  
hash
;

153 
	}
}

159 
	$_diùRe£t
(
diùht
 *
ht
)

161 
ht
->
bË
 = 
NULL
;

162 
ht
->
size
 = 0;

163 
ht
->
sizemask
 = 0;

164 
ht
->
u£d
 = 0;

165 
	}
}

168 
diù
 *
	$diùC»©e
(
diùTy³
 *
ty³
,

169 *
´ivD©aPŒ
)

171 
diù
 *
d
 = 
	`zm®loc
((*d));

173 
	`_diùIn™
(
d
,
ty³
,
´ivD©aPŒ
);

174  
d
;

175 
	}
}

178 
	$_diùIn™
(
diù
 *
d
, 
diùTy³
 *
ty³
,

179 *
´ivD©aPŒ
)

181 
	`_diùRe£t
(&
d
->
ht
[0]);

182 
	`_diùRe£t
(&
d
->
ht
[1]);

183 
d
->
ty³
 =ype;

184 
d
->
´ivd©a
 = 
´ivD©aPŒ
;

185 
d
->
»hashidx
 = -1;

186 
d
->
™”©Üs
 = 0;

187  
DICT_OK
;

188 
	}
}

192 
	$diùResize
(
diù
 *
d
)

194 
mšim®
;

196 ià(!
diù_ÿn_»size
 || 
	`diùIsRehashšg
(
d
)è 
DICT_ERR
;

197 
mšim®
 = 
d
->
ht
[0].
u£d
;

198 ià(
mšim®
 < 
DICT_HT_INITIAL_SIZE
)

199 
mšim®
 = 
DICT_HT_INITIAL_SIZE
;

200  
	`diùEx·nd
(
d
, 
mšim®
);

201 
	}
}

204 
	$diùEx·nd
(
diù
 *
d
, 
size
)

206 
diùht
 
n
;

207 
»®size
 = 
	`_diùNextPow”
(
size
);

211 ià(
	`diùIsRehashšg
(
d
è|| d->
ht
[0].
u£d
 > 
size
)

212  
DICT_ERR
;

215 ià(
»®size
 =ğ
d
->
ht
[0].
size
è 
DICT_ERR
;

218 
n
.
size
 = 
»®size
;

219 
n
.
sizemask
 = 
»®size
-1;

220 
n
.
bË
 = 
	`zÿÎoc
(
»®size
*(
diùEÁry
*));

221 
n
.
u£d
 = 0;

225 ià(
d
->
ht
[0].
bË
 =ğ
NULL
) {

226 
d
->
ht
[0] = 
n
;

227  
DICT_OK
;

231 
d
->
ht
[1] = 
n
;

232 
d
->
»hashidx
 = 0;

233  
DICT_OK
;

234 
	}
}

245 
	$diùRehash
(
diù
 *
d
, 
n
) {

246 
em±y_vis™s
 = 
n
*10;

247 ià(!
	`diùIsRehashšg
(
d
))  0;

249 
n
-- && 
d
->
ht
[0].
u£d
 != 0) {

250 
diùEÁry
 *
de
, *
Ãxtde
;

254 
	`as£¹
(
d
->
ht
[0].
size
 > ()d->
»hashidx
);

255 
d
->
ht
[0].
bË
[d->
»hashidx
] =ğ
NULL
) {

256 
d
->
»hashidx
++;

257 ià(--
em±y_vis™s
 == 0)  1;

259 
de
 = 
d
->
ht
[0].
bË
[d->
»hashidx
];

261 
de
) {

262 
h
;

264 
Ãxtde
 = 
de
->
Ãxt
;

266 
h
 = 
	`diùHashKey
(
d
, 
de
->
key
è& d->
ht
[1].
sizemask
;

267 
de
->
Ãxt
 = 
d
->
ht
[1].
bË
[
h
];

268 
d
->
ht
[1].
bË
[
h
] = 
de
;

269 
d
->
ht
[0].
u£d
--;

270 
d
->
ht
[1].
u£d
++;

271 
de
 = 
Ãxtde
;

273 
d
->
ht
[0].
bË
[d->
»hashidx
] = 
NULL
;

274 
d
->
»hashidx
++;

278 ià(
d
->
ht
[0].
u£d
 == 0) {

279 
	`zä“
(
d
->
ht
[0].
bË
);

280 
d
->
ht
[0] = d->ht[1];

281 
	`_diùRe£t
(&
d
->
ht
[1]);

282 
d
->
»hashidx
 = -1;

288 
	}
}

290 
	$timeInMli£cÚds
() {

291 
timev®
 
tv
;

293 
	`g‘timeofday
(&
tv
,
NULL
);

294  ((()
tv
.
tv_£c
)*1000)+Ñv.
tv_u£c
/1000);

295 
	}
}

298 
	$diùRehashMli£cÚds
(
diù
 *
d
, 
ms
) {

299 
¡¬t
 = 
	`timeInMli£cÚds
();

300 
»hashes
 = 0;

302 
	`diùRehash
(
d
,100)) {

303 
»hashes
 += 100;

304 ià(
	`timeInMli£cÚds
()-
¡¬t
 > 
ms
) ;

306  
»hashes
;

307 
	}
}

317 
	$_diùRehashS‹p
(
diù
 *
d
) {

318 ià(
d
->
™”©Üs
 =ğ0è
	`diùRehash
(d,1);

319 
	}
}

322 
	$diùAdd
(
diù
 *
d
, *
key
, *
v®
)

324 
diùEÁry
 *
’Œy
 = 
	`diùAddRaw
(
d
,
key
);

326 ià(!
’Œy
è 
DICT_ERR
;

327 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

328  
DICT_OK
;

329 
	}
}

346 
diùEÁry
 *
	$diùAddRaw
(
diù
 *
d
, *
key
)

348 
šdex
;

349 
diùEÁry
 *
’Œy
;

350 
diùht
 *
ht
;

352 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

356 ià((
šdex
 = 
	`_diùKeyIndex
(
d
, 
key
)) == -1)

357  
NULL
;

363 
ht
 = 
	`diùIsRehashšg
(
d
) ? &d->ht[1] : &d->ht[0];

364 
’Œy
 = 
	`zm®loc
((*entry));

365 
’Œy
->
Ãxt
 = 
ht
->
bË
[
šdex
];

366 
ht
->
bË
[
šdex
] = 
’Œy
;

367 
ht
->
u£d
++;

370 
	`diùS‘Key
(
d
, 
’Œy
, 
key
);

371  
’Œy
;

372 
	}
}

378 
	$diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
)

380 
diùEÁry
 *
’Œy
, 
aux’Œy
;

384 ià(
	`diùAdd
(
d
, 
key
, 
v®
è=ğ
DICT_OK
)

387 
’Œy
 = 
	`diùFšd
(
d
, 
key
);

393 
aux’Œy
 = *
’Œy
;

394 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

395 
	`diùF»eV®
(
d
, &
aux’Œy
);

397 
	}
}

405 
diùEÁry
 *
	$diùR•ÏûRaw
(
diù
 *
d
, *
key
) {

406 
diùEÁry
 *
’Œy
 = 
	`diùFšd
(
d
,
key
);

408  
’Œy
 ?ƒÁry : 
	`diùAddRaw
(
d
,
key
);

409 
	}
}

412 
	$diùG’”icD–‘e
(
diù
 *
d
, cÚ¡ *
key
, 
noä“
)

414 
h
, 
idx
;

415 
diùEÁry
 *
he
, *
´evHe
;

416 
bË
;

418 ià(
d
->
ht
[0].
size
 =ğ0è 
DICT_ERR
;

419 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

420 
h
 = 
	`diùHashKey
(
d
, 
key
);

422 
bË
 = 0;able <= 1;able++) {

423 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

424 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

425 
´evHe
 = 
NULL
;

426 
he
) {

427 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key)) {

429 ià(
´evHe
)

430 
´evHe
->
Ãxt
 = 
he
->next;

432 
d
->
ht
[
bË
].bË[
idx
] = 
he
->
Ãxt
;

433 ià(!
noä“
) {

434 
	`diùF»eKey
(
d
, 
he
);

435 
	`diùF»eV®
(
d
, 
he
);

437 
	`zä“
(
he
);

438 
d
->
ht
[
bË
].
u£d
--;

439  
DICT_OK
;

441 
´evHe
 = 
he
;

442 
he
 = he->
Ãxt
;

444 ià(!
	`diùIsRehashšg
(
d
)) ;

446  
DICT_ERR
;

447 
	}
}

449 
	$diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
) {

450  
	`diùG’”icD–‘e
(
ht
,
key
,0);

451 
	}
}

453 
	$diùD–‘eNoF»e
(
diù
 *
ht
, cÚ¡ *
key
) {

454  
	`diùG’”icD–‘e
(
ht
,
key
,1);

455 
	}
}

458 
_diùCË¬
(
diù
 *
d
, 
diùht
 *
ht
, (
ÿÎback
)(*)) {

459 
i
;

462 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

463 
diùEÁry
 *
he
, *
ÃxtHe
;

465 ià(
ÿÎback
 && (
i
 & 65535è=ğ0è
	`ÿÎback
(
d
->
´ivd©a
);

467 ià((
he
 = 
ht
->
bË
[
i
]è=ğ
NULL
) ;

468 
he
) {

469 
ÃxtHe
 = 
he
->
Ãxt
;

470 
	`diùF»eKey
(
d
, 
he
);

471 
	`diùF»eV®
(
d
, 
he
);

472 
	`zä“
(
he
);

473 
ht
->
u£d
--;

474 
he
 = 
ÃxtHe
;

478 
	`zä“
(
ht
->
bË
);

480 
	`_diùRe£t
(
ht
);

481  
DICT_OK
;

482 
	}
}

485 
	$diùR–—£
(
diù
 *
d
)

487 
	`_diùCË¬
(
d
,&d->
ht
[0],
NULL
);

488 
	`_diùCË¬
(
d
,&d->
ht
[1],
NULL
);

489 
	`zä“
(
d
);

490 
	}
}

492 
diùEÁry
 *
	$diùFšd
(
diù
 *
d
, cÚ¡ *
key
)

494 
diùEÁry
 *
he
;

495 
h
, 
idx
, 
bË
;

497 ià(
d
->
ht
[0].
u£d
 + d->ht[1].u£d =ğ0è 
NULL
;

498 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

499 
h
 = 
	`diùHashKey
(
d
, 
key
);

500 
bË
 = 0;able <= 1;able++) {

501 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

502 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

503 
he
) {

504 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key))

505  
he
;

506 
he
 = he->
Ãxt
;

508 ià(!
	`diùIsRehashšg
(
d
)è 
NULL
;

510  
NULL
;

511 
	}
}

513 *
	$diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
) {

514 
diùEÁry
 *
he
;

516 
he
 = 
	`diùFšd
(
d
,
key
);

517  
he
 ? 
	`diùG‘V®
(heè: 
NULL
;

518 
	}
}

526 
	$diùFšg”´št
(
diù
 *
d
) {

527 
š‹g”s
[6], 
hash
 = 0;

528 
j
;

530 
š‹g”s
[0] = (è
d
->
ht
[0].
bË
;

531 
š‹g”s
[1] = 
d
->
ht
[0].
size
;

532 
š‹g”s
[2] = 
d
->
ht
[0].
u£d
;

533 
š‹g”s
[3] = (è
d
->
ht
[1].
bË
;

534 
š‹g”s
[4] = 
d
->
ht
[1].
size
;

535 
š‹g”s
[5] = 
d
->
ht
[1].
u£d
;

544 
j
 = 0; j < 6; j++) {

545 
hash
 +ğ
š‹g”s
[
j
];

547 
hash
 = (~hash) + (hash << 21);

548 
hash
 = hash ^ (hash >> 24);

549 
hash
 = (hash + (hash << 3)) + (hash << 8);

550 
hash
 = hash ^ (hash >> 14);

551 
hash
 = (hash + (hash << 2)) + (hash << 4);

552 
hash
 = hash ^ (hash >> 28);

553 
hash
 = hash + (hash << 31);

555  
hash
;

556 
	}
}

558 
diùI‹¿tÜ
 *
	$diùG‘I‹¿tÜ
(
diù
 *
d
)

560 
diùI‹¿tÜ
 *
™”
 = 
	`zm®loc
((*iter));

562 
™”
->
d
 = d;

563 
™”
->
bË
 = 0;

564 
™”
->
šdex
 = -1;

565 
™”
->
§ã
 = 0;

566 
™”
->
’Œy
 = 
NULL
;

567 
™”
->
ÃxtEÁry
 = 
NULL
;

568  
™”
;

569 
	}
}

571 
diùI‹¿tÜ
 *
	$diùG‘SaãI‹¿tÜ
(
diù
 *
d
) {

572 
diùI‹¿tÜ
 *
i
 = 
	`diùG‘I‹¿tÜ
(
d
);

574 
i
->
§ã
 = 1;

575  
i
;

576 
	}
}

578 
diùEÁry
 *
	$diùNext
(
diùI‹¿tÜ
 *
™”
)

581 ià(
™”
->
’Œy
 =ğ
NULL
) {

582 
diùht
 *
ht
 = &
™”
->
d
->ht[™”->
bË
];

583 ià(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0) {

584 ià(
™”
->
§ã
)

585 
™”
->
d
->
™”©Üs
++;

587 
™”
->
fšg”´št
 = 
	`diùFšg”´št
(™”->
d
);

589 
™”
->
šdex
++;

590 ià(
™”
->
šdex
 >ğ(è
ht
->
size
) {

591 ià(
	`diùIsRehashšg
(
™”
->
d
è&& i‹r->
bË
 == 0) {

592 
™”
->
bË
++;

593 
™”
->
šdex
 = 0;

594 
ht
 = &
™”
->
d
->ht[1];

599 
™”
->
’Œy
 = 
ht
->
bË
[™”->
šdex
];

601 
™”
->
’Œy
 = i‹r->
ÃxtEÁry
;

603 ià(
™”
->
’Œy
) {

606 
™”
->
ÃxtEÁry
 = i‹r->
’Œy
->
Ãxt
;

607  
™”
->
’Œy
;

610  
NULL
;

611 
	}
}

613 
	$diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
)

615 ià(!(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0)) {

616 ià(
™”
->
§ã
)

617 
™”
->
d
->
™”©Üs
--;

619 
	`as£¹
(
™”
->
fšg”´št
 =ğ
	`diùFšg”´št
(™”->
d
));

621 
	`zä“
(
™”
);

622 
	}
}

626 
diùEÁry
 *
	$diùG‘RªdomKey
(
diù
 *
d
)

628 
diùEÁry
 *
he
, *
Üighe
;

629 
h
;

630 
li¡Ën
, 
li¡–e
;

632 ià(
	`diùSize
(
d
è=ğ0è 
NULL
;

633 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

634 ià(
	`diùIsRehashšg
(
d
)) {

638 
h
 = 
d
->
»hashidx
 + (
	`¿ndom
(è% (d->
ht
[0].
size
 +

639 
d
->
ht
[1].
size
 -

640 
d
->
»hashidx
));

641 
he
 = (
h
 >ğ
d
->
ht
[0].
size
è? d->ht[1].
bË
[h - d->ht[0].size] :

642 
d
->
ht
[0].
bË
[
h
];

643 } 
he
 =ğ
NULL
);

646 
h
 = 
	`¿ndom
(è& 
d
->
ht
[0].
sizemask
;

647 
he
 = 
d
->
ht
[0].
bË
[
h
];

648 } 
he
 =ğ
NULL
);

655 
li¡Ën
 = 0;

656 
Üighe
 = 
he
;

657 
he
) {

658 
he
 = he->
Ãxt
;

659 
li¡Ën
++;

661 
li¡–e
 = 
	`¿ndom
(è% 
li¡Ën
;

662 
he
 = 
Üighe
;

663 
li¡–e
--è
he
 = he->
Ãxt
;

664  
he
;

665 
	}
}

689 
	$diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
) {

690 
j
;

691 
bËs
;

692 
¡Üed
 = 0, 
maxsizemask
;

693 
max¡•s
;

695 ià(
	`diùSize
(
d
è< 
couÁ
) count = dictSize(d);

696 
max¡•s
 = 
couÁ
*10;

699 
j
 = 0; j < 
couÁ
; j++) {

700 ià(
	`diùIsRehashšg
(
d
))

701 
	`_diùRehashS‹p
(
d
);

706 
bËs
 = 
	`diùIsRehashšg
(
d
) ? 2 : 1;

707 
maxsizemask
 = 
d
->
ht
[0].
sizemask
;

708 ià(
bËs
 > 1 && 
maxsizemask
 < 
d
->
ht
[1].
sizemask
)

709 
maxsizemask
 = 
d
->
ht
[1].
sizemask
;

712 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

713 
em±yËn
 = 0;

714 
¡Üed
 < 
couÁ
 && 
max¡•s
--) {

715 
j
 = 0; j < 
bËs
; j++) {

719 ià(
bËs
 =ğ2 && 
j
 =ğ0 && 
i
 < (è
d
->
»hashidx
) {

724 ià(
i
 >ğ
d
->
ht
[1].
size
è˜ğd->
»hashidx
;

727 ià(
i
 >ğ
d
->
ht
[
j
].
size
) ;

728 
diùEÁry
 *
he
 = 
d
->
ht
[
j
].
bË
[
i
];

732 ià(
he
 =ğ
NULL
) {

733 
em±yËn
++;

734 ià(
em±yËn
 >ğ5 &&ƒm±yËÀ> 
couÁ
) {

735 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

736 
em±yËn
 = 0;

739 
em±yËn
 = 0;

740 
he
) {

743 *
des
 = 
he
;

744 
des
++;

745 
he
 = he->
Ãxt
;

746 
¡Üed
++;

747 ià(
¡Üed
 =ğ
couÁ
)  stored;

751 
i
 = (i+1è& 
maxsizemask
;

753  
¡Üed
;

754 
	}
}

758 
	$»v
(
v
) {

759 
s
 = 8 * (
v
);

760 
mask
 = ~0;

761 (
s
 >>= 1) > 0) {

762 
mask
 ^ğ(mask << 
s
);

763 
v
 = ((v >> 
s
è& 
mask
) | ((v << s) & ~mask);

765  
v
;

766 
	}
}

852 
	$diùSÿn
(
diù
 *
d
,

853 
v
,

854 
diùSÿnFunùiÚ
 *
â
,

855 *
´ivd©a
)

857 
diùht
 *
t0
, *
t1
;

858 cÚ¡ 
diùEÁry
 *
de
, *
Ãxt
;

859 
m0
, 
m1
;

861 ià(
	`diùSize
(
d
) == 0)  0;

863 ià(!
	`diùIsRehashšg
(
d
)) {

864 
t0
 = &(
d
->
ht
[0]);

865 
m0
 = 
t0
->
sizemask
;

868 
de
 = 
t0
->
bË
[
v
 & 
m0
];

869 
de
) {

870 
Ãxt
 = 
de
->next;

871 
	`â
(
´ivd©a
, 
de
);

872 
de
 = 
Ãxt
;

876 
t0
 = &
d
->
ht
[0];

877 
t1
 = &
d
->
ht
[1];

880 ià(
t0
->
size
 > 
t1
->size) {

881 
t0
 = &
d
->
ht
[1];

882 
t1
 = &
d
->
ht
[0];

885 
m0
 = 
t0
->
sizemask
;

886 
m1
 = 
t1
->
sizemask
;

889 
de
 = 
t0
->
bË
[
v
 & 
m0
];

890 
de
) {

891 
Ãxt
 = 
de
->next;

892 
	`â
(
´ivd©a
, 
de
);

893 
de
 = 
Ãxt
;

900 
de
 = 
t1
->
bË
[
v
 & 
m1
];

901 
de
) {

902 
Ãxt
 = 
de
->next;

903 
	`â
(
´ivd©a
, 
de
);

904 
de
 = 
Ãxt
;

908 
v
 = (((v | 
m0
) + 1) & ~m0) | (v & m0);

911 } 
v
 & (
m0
 ^ 
m1
));

916 
v
 |ğ~
m0
;

919 
v
 = 
	`»v
(v);

920 
v
++;

921 
v
 = 
	`»v
(v);

923  
v
;

924 
	}
}

929 
	$_diùEx·ndIfN“ded
(
diù
 *
d
)

932 ià(
	`diùIsRehashšg
(
d
)è 
DICT_OK
;

935 ià(
d
->
ht
[0].
size
 =ğ0è 
	`diùEx·nd
(d, 
DICT_HT_INITIAL_SIZE
);

941 ià(
d
->
ht
[0].
u£d
 >ğd->ht[0].
size
 &&

942 (
diù_ÿn_»size
 ||

943 
d
->
ht
[0].
u£d
/d->ht[0].
size
 > 
diù_fÜû_»size_¿tio
))

945  
	`diùEx·nd
(
d
, d->
ht
[0].
u£d
*2);

947  
DICT_OK
;

948 
	}
}

951 
	$_diùNextPow”
(
size
)

953 
i
 = 
DICT_HT_INITIAL_SIZE
;

955 ià(
size
 >ğ
LONG_MAX
)  LONG_MAX;

957 ià(
i
 >ğ
size
)

958  
i
;

959 
i
 *= 2;

961 
	}
}

969 
	$_diùKeyIndex
(
diù
 *
d
, cÚ¡ *
key
)

971 
h
, 
idx
, 
bË
;

972 
diùEÁry
 *
he
;

975 ià(
	`_diùEx·ndIfN“ded
(
d
è=ğ
DICT_ERR
)

978 
h
 = 
	`diùHashKey
(
d
, 
key
);

979 
bË
 = 0;able <= 1;able++) {

980 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

982 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

983 
he
) {

984 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key))

986 
he
 = he->
Ãxt
;

988 ià(!
	`diùIsRehashšg
(
d
)) ;

990  
idx
;

991 
	}
}

993 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*)) {

994 
	`_diùCË¬
(
d
,&d->
ht
[0],
ÿÎback
);

995 
	`_diùCË¬
(
d
,&d->
ht
[1],
ÿÎback
);

996 
d
->
»hashidx
 = -1;

997 
d
->
™”©Üs
 = 0;

998 
	}
}

1000 
	$diùEÇbËResize
() {

1001 
diù_ÿn_»size
 = 1;

1002 
	}
}

1004 
	$diùDi§bËResize
() {

1005 
diù_ÿn_»size
 = 0;

1006 
	}
}

1010 
	#DICT_STATS_VECTLEN
 50

	)

1011 
size_t
 
	$_diùG‘StsHt
(*
buf
, 
size_t
 
bufsize
, 
diùht
 *
ht
, 
bËid
) {

1012 
i
, 
¦Ùs
 = 0, 
chašËn
, 
maxchašËn
 = 0;

1013 
tÙchašËn
 = 0;

1014 
şveùÜ
[
DICT_STATS_VECTLEN
];

1015 
size_t
 
l
 = 0;

1017 ià(
ht
->
u£d
 == 0) {

1018  
	`¢´štf
(
buf
,
bufsize
,

1023 
i
 = 0; i < 
DICT_STATS_VECTLEN
; i++è
şveùÜ
[i] = 0;

1024 
i
 = 0; i < 
ht
->
size
; i++) {

1025 
diùEÁry
 *
he
;

1027 ià(
ht
->
bË
[
i
] =ğ
NULL
) {

1028 
şveùÜ
[0]++;

1031 
¦Ùs
++;

1033 
chašËn
 = 0;

1034 
he
 = 
ht
->
bË
[
i
];

1035 
he
) {

1036 
chašËn
++;

1037 
he
 = he->
Ãxt
;

1039 
şveùÜ
[(
chašËn
 < 
DICT_STATS_VECTLEN
) ? chainlen : (DICT_STATS_VECTLEN-1)]++;

1040 ià(
chašËn
 > 
maxchašËn
) maxchainlen = chainlen;

1041 
tÙchašËn
 +ğ
chašËn
;

1045 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1054 
bËid
, (tableid == 0) ? "main hashable" : "rehashingarget",

1055 
ht
->
size
, ht->
u£d
, 
¦Ùs
, 
maxchašËn
,

1056 ()
tÙchašËn
/
¦Ùs
, ()
ht
->
u£d
/slots);

1058 
i
 = 0; i < 
DICT_STATS_VECTLEN
-1; i++) {

1059 ià(
şveùÜ
[
i
] == 0) ;

1060 ià(
l
 >ğ
bufsize
) ;

1061 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1063 (
i
 =ğ
DICT_STATS_VECTLEN
-1)?">= ":"",

1064 
i
, 
şveùÜ
[i], (()şveùÜ[i]/
ht
->
size
)*100);

1068 ià(
bufsize
è
buf
[bufsize-1] = '\0';

1069  
	`¡¾’
(
buf
);

1070 
	}
}

1072 
	$diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
) {

1073 
size_t
 
l
;

1074 *
Üig_buf
 = 
buf
;

1075 
size_t
 
Üig_bufsize
 = 
bufsize
;

1077 
l
 = 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[0],0);

1078 
buf
 +ğ
l
;

1079 
bufsize
 -ğ
l
;

1080 ià(
	`diùIsRehashšg
(
d
è&& 
bufsize
 > 0) {

1081 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[1],1);

1084 ià(
Üig_bufsize
è
Üig_buf
[orig_bufsize-1] = '\0';

1085 
	}
}

	@dict.h

36 
	~<¡dšt.h
>

38 #iâdeà
__DICT_H


39 
	#__DICT_H


	)

41 
	#DICT_OK
 0

	)

42 
	#DICT_ERR
 1

	)

45 
	#DICT_NOTUSED
(
V
è((èV)

	)

47 
	sdiùEÁry
 {

48 *
	mkey
;

50 *
	mv®
;

51 
ušt64_t
 
	mu64
;

52 
št64_t
 
	ms64
;

53 
	md
;

54 } 
	mv
;

55 
diùEÁry
 *
	mÃxt
;

56 } 
	tdiùEÁry
;

58 
	sdiùTy³
 {

59 (*
	mhashFunùiÚ
)(cÚ¡ *
	mkey
);

60 *(*
	mkeyDup
)(*
	m´ivd©a
, cÚ¡ *
	mkey
);

61 *(*
	mv®Dup
)(*
	m´ivd©a
, cÚ¡ *
	mobj
);

62 (*
	mkeyCom·»
)(*
	m´ivd©a
, cÚ¡ *
	mkey1
, cÚ¡ *
	mkey2
);

63 (*
	mkeyDe¡ruùÜ
)(*
	m´ivd©a
, *
	mkey
);

64 (*
	mv®De¡ruùÜ
)(*
	m´ivd©a
, *
	mobj
);

65 } 
	tdiùTy³
;

69 
	sdiùht
 {

70 
diùEÁry
 **
	mbË
;

71 
	msize
;

72 
	msizemask
;

73 
	mu£d
;

74 } 
	tdiùht
;

76 
	sdiù
 {

77 
diùTy³
 *
	mty³
;

78 *
	m´ivd©a
;

79 
diùht
 
	mht
[2];

80 
	m»hashidx
;

81 
	m™”©Üs
;

82 } 
	tdiù
;

88 
	sdiùI‹¿tÜ
 {

89 
diù
 *
	md
;

90 
	mšdex
;

91 
	mbË
, 
	m§ã
;

92 
diùEÁry
 *
	m’Œy
, *
	mÃxtEÁry
;

94 
	mfšg”´št
;

95 } 
	tdiùI‹¿tÜ
;

97 (
	tdiùSÿnFunùiÚ
)(*
	t´ivd©a
, cÚ¡ 
	tdiùEÁry
 *
	tde
);

100 
	#DICT_HT_INITIAL_SIZE
 4

	)

103 
	#diùF»eV®
(
d
, 
’Œy
) \

104 ià((
d
)->
ty³
->
v®De¡ruùÜ
) \

105 (
d
)->
ty³
->
	`v®De¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
v
.
v®
)

	)

107 
	#diùS‘V®
(
d
, 
’Œy
, 
_v®_
) do { \

108 ià((
d
)->
ty³
->
v®Dup
) \

109 
’Œy
->
v
.
v®
 = (
d
)->
ty³
->
	`v®Dup
((d)->
´ivd©a
, 
_v®_
); \

111 
’Œy
->
v
.
v®
 = (
_v®_
); \

112 
	}
} 0)

	)

114 
	#diùS‘SigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

115 dØ{ 
’Œy
->
v
.
s64
 = 
_v®_
; } 0)

	)

117 
	#diùS‘UnsigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

118 dØ{ 
’Œy
->
v
.
u64
 = 
_v®_
; } 0)

	)

120 
	#diùS‘DoubËV®
(
’Œy
, 
_v®_
) \

121 dØ{ 
’Œy
->
v
.
d
 = 
_v®_
; } 0)

	)

123 
	#diùF»eKey
(
d
, 
’Œy
) \

124 ià((
d
)->
ty³
->
keyDe¡ruùÜ
) \

125 (
d
)->
ty³
->
	`keyDe¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
key
)

	)

127 
	#diùS‘Key
(
d
, 
’Œy
, 
_key_
) do { \

128 ià((
d
)->
ty³
->
keyDup
) \

129 
’Œy
->
key
 = (
d
)->
ty³
->
	`keyDup
((d)->
´ivd©a
, 
_key_
); \

131 
’Œy
->
key
 = (
_key_
); \

132 } 0)

	)

134 
	#diùCom·»Keys
(
d
, 
key1
, 
key2
) \

135 (((
d
)->
ty³
->
keyCom·»
) ? \

136 (
d
)->
ty³
->
	`keyCom·»
((d)->
´ivd©a
, 
key1
, 
key2
) : \

137 (
key1
è=ğ(
key2
))

	)

139 
	#diùHashKey
(
d
, 
key
è(d)->
ty³
->
	`hashFunùiÚ
(key)

	)

140 
	#diùG‘Key
(
he
è((he)->
key
)

	)

141 
	#diùG‘V®
(
he
è((he)->
v
.
v®
)

	)

142 
	#diùG‘SigÃdIÁeg”V®
(
he
è((he)->
v
.
s64
)

	)

143 
	#diùG‘UnsigÃdIÁeg”V®
(
he
è((he)->
v
.
u64
)

	)

144 
	#diùG‘DoubËV®
(
he
è((he)->
v
.
d
)

	)

145 
	#diùSlÙs
(
d
è((d)->
ht
[0].
size
+(d)->ht[1].size)

	)

146 
	#diùSize
(
d
è((d)->
ht
[0].
u£d
+(d)->ht[1].u£d)

	)

147 
	#diùIsRehashšg
(
d
è((d)->
»hashidx
 !ğ-1)

	)

150 
diù
 *
diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

151 
diùEx·nd
(
diù
 *
d
, 
size
);

152 
diùAdd
(
diù
 *
d
, *
key
, *
v®
);

153 
diùEÁry
 *
diùAddRaw
(
diù
 *
d
, *
key
);

154 
diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
);

155 
diùEÁry
 *
diùR•ÏûRaw
(
diù
 *
d
, *
key
);

156 
diùD–‘e
(
diù
 *
d
, cÚ¡ *
key
);

157 
diùD–‘eNoF»e
(
diù
 *
d
, cÚ¡ *
key
);

158 
diùR–—£
(
diù
 *
d
);

159 
diùEÁry
 * 
diùFšd
(
diù
 *
d
, cÚ¡ *
key
);

160 *
diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
);

161 
diùResize
(
diù
 *
d
);

162 
diùI‹¿tÜ
 *
diùG‘I‹¿tÜ
(
diù
 *
d
);

163 
diùI‹¿tÜ
 *
diùG‘SaãI‹¿tÜ
(
diù
 *
d
);

164 
diùEÁry
 *
diùNext
(
diùI‹¿tÜ
 *
™”
);

165 
diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
);

166 
diùEÁry
 *
diùG‘RªdomKey
(
diù
 *
d
);

167 
diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
);

168 
diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
);

169 
diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
);

170 
diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
);

171 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*));

172 
	`diùEÇbËResize
();

173 
	`diùDi§bËResize
();

174 
	`diùRehash
(
diù
 *
d
, 
n
);

175 
	`diùRehashMli£cÚds
(
diù
 *
d
, 
ms
);

176 
	`diùS‘HashFunùiÚS“d
(
š™v®
);

177 
	`diùG‘HashFunùiÚS“d
();

178 
	`diùSÿn
(
diù
 *
d
, 
v
, 
diùSÿnFunùiÚ
 *
â
, *
´ivd©a
);

181 
diùTy³
 
diùTy³H—pSŒšgCİyKey
;

182 
diùTy³
 
diùTy³H—pSŒšgs
;

183 
diùTy³
 
diùTy³H—pSŒšgCİyKeyV®ue
;

	@endianconv.c

45 
	~<¡dšt.h
>

49 
	$mem»v16
(*
p
) {

50 *
x
 = 
p
, 
t
;

52 
t
 = 
x
[0];

53 
x
[0] = x[1];

54 
x
[1] = 
t
;

55 
	}
}

59 
	$mem»v32
(*
p
) {

60 *
x
 = 
p
, 
t
;

62 
t
 = 
x
[0];

63 
x
[0] = x[3];

64 
x
[3] = 
t
;

65 
t
 = 
x
[1];

66 
x
[1] = x[2];

67 
x
[2] = 
t
;

68 
	}
}

72 
	$mem»v64
(*
p
) {

73 *
x
 = 
p
, 
t
;

75 
t
 = 
x
[0];

76 
x
[0] = x[7];

77 
x
[7] = 
t
;

78 
t
 = 
x
[1];

79 
x
[1] = x[6];

80 
x
[6] = 
t
;

81 
t
 = 
x
[2];

82 
x
[2] = x[5];

83 
x
[5] = 
t
;

84 
t
 = 
x
[3];

85 
x
[3] = x[4];

86 
x
[4] = 
t
;

87 
	}
}

89 
ušt16_t
 
	$šŒev16
(
ušt16_t
 
v
) {

90 
	`mem»v16
(&
v
);

91  
v
;

92 
	}
}

94 
ušt32_t
 
	$šŒev32
(
ušt32_t
 
v
) {

95 
	`mem»v32
(&
v
);

96  
v
;

97 
	}
}

99 
ušt64_t
 
	$šŒev64
(
ušt64_t
 
v
) {

100 
	`mem»v64
(&
v
);

101  
v
;

102 
	}
}

104 #ifdeà
REDIS_TEST


105 
	~<¡dio.h
>

107 
	#UNUSED
(
x
è()(x)

	)

108 
	$’dŸncÚvTe¡
(
¬gc
, *
¬gv
[]) {

109 
buf
[32];

111 
	`UNUSED
(
¬gc
);

112 
	`UNUSED
(
¬gv
);

114 
	`¥rštf
(
buf
,"ciaoroma");

115 
	`mem»v16
(
buf
);

116 
	`´štf
("%s\n", 
buf
);

118 
	`¥rštf
(
buf
,"ciaoroma");

119 
	`mem»v32
(
buf
);

120 
	`´štf
("%s\n", 
buf
);

122 
	`¥rštf
(
buf
,"ciaoroma");

123 
	`mem»v64
(
buf
);

124 
	`´štf
("%s\n", 
buf
);

127 
	}
}

	@endianconv.h

33 #iâdeà
__ENDIANCONV_H


34 
	#__ENDIANCONV_H


	)

36 
	~"cÚfig.h
"

37 
	~<¡dšt.h
>

39 
mem»v16
(*
p
);

40 
mem»v32
(*
p
);

41 
mem»v64
(*
p
);

42 
ušt16_t
 
šŒev16
(ušt16_ˆ
v
);

43 
ušt32_t
 
šŒev32
(ušt32_ˆ
v
);

44 
ušt64_t
 
šŒev64
(ušt64_ˆ
v
);

48 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

49 
	#mem»v16ifbe
(
p
)

	)

50 
	#mem»v32ifbe
(
p
)

	)

51 
	#mem»v64ifbe
(
p
)

	)

52 
	#šŒev16ifbe
(
v
è(v)

	)

53 
	#šŒev32ifbe
(
v
è(v)

	)

54 
	#šŒev64ifbe
(
v
è(v)

	)

56 
	#mem»v16ifbe
(
p
è
	`mem»v16
Õ)

	)

57 
	#mem»v32ifbe
(
p
è
	`mem»v32
Õ)

	)

58 
	#mem»v64ifbe
(
p
è
	`mem»v64
Õ)

	)

59 
	#šŒev16ifbe
(
v
è
	`šŒev16
(v)

	)

60 
	#šŒev32ifbe
(
v
è
	`šŒev32
(v)

	)

61 
	#šŒev64ifbe
(
v
è
	`šŒev64
(v)

	)

66 #ià(
BYTE_ORDER
 =ğ
BIG_ENDIAN
)

67 
	#htÚu64
(
v
è(v)

	)

68 
	#Áohu64
(
v
è(v)

	)

70 
	#htÚu64
(
v
è
	`šŒev64
(v)

	)

71 
	#Áohu64
(
v
è
	`šŒev64
(v)

	)

74 #ifdeà
REDIS_TEST


75 
’dŸncÚvTe¡
(
¬gc
, *
¬gv
[]);

	@evict.c

33 
	~"£rv”.h
"

34 
	~"bio.h
"

51 
	#EVPOOL_SIZE
 16

	)

52 
	#EVPOOL_CACHED_SDS_SIZE
 255

	)

53 
	seviùiÚPoŞEÁry
 {

54 
	midË
;

55 
sds
 
	mkey
;

56 
sds
 
	mÿched
;

57 
	mdbid
;

60 
eviùiÚPoŞEÁry
 *
	gEviùiÚPoŞLRU
;

62 
LFUDeüAndR‘uº
(
robj
 *
o
);

71 
	$g‘LRUClock
() {

72  (
	`m¡ime
()/
LRU_CLOCK_RESOLUTION
è& 
LRU_CLOCK_MAX
;

73 
	}
}

77 
	$e¡im©eObjeùIdËTime
(
robj
 *
o
) {

78 
Ìuşock
 = 
	`LRU_CLOCK
();

79 ià(
Ìuşock
 >ğ
o
->
Ìu
) {

80  (
Ìuşock
 - 
o
->
Ìu
è* 
LRU_CLOCK_RESOLUTION
;

82  (
Ìuşock
 + (
LRU_CLOCK_MAX
 - 
o
->
Ìu
)) *

83 
LRU_CLOCK_RESOLUTION
;

85 
	}
}

126 
	$eviùiÚPoŞAÎoc
() {

127 
eviùiÚPoŞEÁry
 *
•
;

128 
j
;

130 
•
 = 
	`zm®loc
((*•)*
EVPOOL_SIZE
);

131 
j
 = 0; j < 
EVPOOL_SIZE
; j++) {

132 
•
[
j
].
idË
 = 0;

133 
•
[
j
].
key
 = 
NULL
;

134 
•
[
j
].
ÿched
 = 
	`sd¢ewËn
(
NULL
,
EVPOOL_CACHED_SDS_SIZE
);

135 
•
[
j
].
dbid
 = 0;

137 
EviùiÚPoŞLRU
 = 
•
;

138 
	}
}

149 
	$eviùiÚPoŞPİuÏ‹
(
dbid
, 
diù
 *
§m¶ediù
, diù *
keydiù
, 
eviùiÚPoŞEÁry
 *
poŞ
) {

150 
j
, 
k
, 
couÁ
;

151 
diùEÁry
 *
§m¶es
[
£rv”
.
maxmemÜy_§m¶es
];

153 
couÁ
 = 
	`diùG‘SomeKeys
(
§m¶ediù
,
§m¶es
,
£rv”
.
maxmemÜy_§m¶es
);

154 
j
 = 0; j < 
couÁ
; j++) {

155 
idË
;

156 
sds
 
key
;

157 
robj
 *
o
;

158 
diùEÁry
 *
de
;

160 
de
 = 
§m¶es
[
j
];

161 
key
 = 
	`diùG‘Key
(
de
);

166 ià(
£rv”
.
maxmemÜy_pŞicy
 !ğ
MAXMEMORY_VOLATILE_TTL
) {

167 ià(
§m¶ediù
 !ğ
keydiù
è
de
 = 
	`diùFšd
(keydiù, 
key
);

168 
o
 = 
	`diùG‘V®
(
de
);

174 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LRU
) {

175 
idË
 = 
	`e¡im©eObjeùIdËTime
(
o
);

176 } ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

184 
idË
 = 255-
	`LFUDeüAndR‘uº
(
o
);

185 } ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_TTL
) {

187 
idË
 = 
ULLONG_MAX
 - ()
	`diùG‘V®
(
de
);

189 
	`£rv”Pªic
("Unknownƒviction…olicy inƒvictionPoolPopulate()");

195 
k
 = 0;

196 
k
 < 
EVPOOL_SIZE
 &&

197 
poŞ
[
k
].
key
 &&

198 
poŞ
[
k
].
idË
 < idle) k++;

199 ià(
k
 =ğ0 && 
poŞ
[
EVPOOL_SIZE
-1].
key
 !ğ
NULL
) {

203 } ià(
k
 < 
EVPOOL_SIZE
 && 
poŞ
[k].
key
 =ğ
NULL
) {

208 ià(
poŞ
[
EVPOOL_SIZE
-1].
key
 =ğ
NULL
) {

213 
sds
 
ÿched
 = 
poŞ
[
EVPOOL_SIZE
-1].cached;

214 
	`memmove
(
poŞ
+
k
+1,pool+k,

215 (
poŞ
[0])*(
EVPOOL_SIZE
-
k
-1));

216 
poŞ
[
k
].
ÿched
 = cached;

219 
k
--;

222 
sds
 
ÿched
 = 
poŞ
[0].cached;

223 ià(
poŞ
[0].
key
 !ğpoŞ[0].
ÿched
è
	`sdsä“
(pool[0].key);

224 
	`memmove
(
poŞ
,poŞ+1,ÕoŞ[0])*
k
);

225 
poŞ
[
k
].
ÿched
 = cached;

233 
kËn
 = 
	`sd¦’
(
key
);

234 ià(
kËn
 > 
EVPOOL_CACHED_SDS_SIZE
) {

235 
poŞ
[
k
].
key
 = 
	`sdsdup
(key);

237 
	`memıy
(
poŞ
[
k
].
ÿched
,
key
,
kËn
+1);

238 
	`sds£’
(
poŞ
[
k
].
ÿched
,
kËn
);

239 
poŞ
[
k
].
key
 =…oŞ[k].
ÿched
;

241 
poŞ
[
k
].
idË
 = idle;

242 
poŞ
[
k
].
dbid
 = dbid;

244 
	}
}

286 
	$LFUG‘TimeInMšu‹s
() {

287  (
£rv”
.
unixtime
/60) & 65535;

288 
	}
}

294 
	$LFUTimeEÏp£d
(
ldt
) {

295 
now
 = 
	`LFUG‘TimeInMšu‹s
();

296 ià(
now
 >ğ
ldt
) ‚ow-ldt;

297  65535-
ldt
+
now
;

298 
	}
}

302 
ušt8_t
 
	$LFULogInü
(
ušt8_t
 
couÁ”
) {

303 ià(
couÁ”
 == 255)  255;

304 
r
 = ()
	`¿nd
()/
RAND_MAX
;

305 
ba£v®
 = 
couÁ”
 - 
LFU_INIT_VAL
;

306 ià(
ba£v®
 < 0) baseval = 0;

307 
p
 = 1.0/(
ba£v®
*
£rv”
.
lfu_log_çùÜ
+1);

308 ià(
r
 < 
p
è
couÁ”
++;

309  
couÁ”
;

310 
	}
}

318 
	#LFU_DECR_INTERVAL
 1

	)

319 
	$LFUDeüAndR‘uº
(
robj
 *
o
) {

320 
ldt
 = 
o
->
Ìu
 >> 8;

321 
couÁ”
 = 
o
->
Ìu
 & 255;

322 ià(
	`LFUTimeEÏp£d
(
ldt
è>ğ
£rv”
.
lfu_deÿy_time
 && 
couÁ”
) {

323 ià(
couÁ”
 > 
LFU_INIT_VAL
*2) {

324 
couÁ”
 /= 2;

325 ià(
couÁ”
 < 
LFU_INIT_VAL
*2) counter = LFU_INIT_VAL*2;

327 
couÁ”
--;

329 
o
->
Ìu
 = (
	`LFUG‘TimeInMšu‹s
()<<8è| 
couÁ”
;

331  
couÁ”
;

332 
	}
}

339 
	$ä“MemÜyIfN“ded
() {

340 
size_t
 
mem_»pÜ‹d
, 
mem_u£d
, 
mem_toä“
, 
mem_ä“d
;

341 
¦aves
 = 
	`li¡L’gth
(
£rv”
.slaves);

342 
m¡ime_t
 
Ï‹ncy
, 
eviùiÚ_Ï‹ncy
;

343 
d–
;

347 
mem_»pÜ‹d
 = 
	`zm®loc_u£d_memÜy
();

348 ià(
mem_»pÜ‹d
 <ğ
£rv”
.
maxmemÜy
è 
C_OK
;

352 
mem_u£d
 = 
mem_»pÜ‹d
;

353 ià(
¦aves
) {

354 
li¡I‹r
 
li
;

355 
li¡Node
 *
Ê
;

357 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

358 (
Ê
 = 
	`li¡Next
(&
li
))) {

359 
ş›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

360 
obuf_by‹s
 = 
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
¦ave
);

361 ià(
obuf_by‹s
 > 
mem_u£d
)

362 
mem_u£d
 = 0;

364 
mem_u£d
 -ğ
obuf_by‹s
;

367 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

368 
mem_u£d
 -ğ
	`sd¦’
(
£rv”
.
aof_buf
);

369 
mem_u£d
 -ğ
	`aofRewr™eBufãrSize
();

373 ià(
mem_u£d
 <ğ
£rv”
.
maxmemÜy
è 
C_OK
;

376 
mem_toä“
 = 
mem_u£d
 - 
£rv”
.
maxmemÜy
;

377 
mem_ä“d
 = 0;

379 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_NO_EVICTION
)

380 
ÿÁ_ä“
;

382 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

383 
mem_ä“d
 < 
mem_toä“
) {

384 
j
, 
k
, 
i
, 
keys_ä“d
 = 0;

385 
Ãxt_db
 = 0;

386 
sds
 
be¡key
 = 
NULL
;

387 
be¡dbid
;

388 
»disDb
 *
db
;

389 
diù
 *dict;

390 
diùEÁry
 *
de
;

392 ià(
£rv”
.
maxmemÜy_pŞicy
 & (
MAXMEMORY_FLAG_LRU
|
MAXMEMORY_FLAG_LFU
) ||

393 
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_TTL
)

395 
eviùiÚPoŞEÁry
 *
poŞ
 = 
EviùiÚPoŞLRU
;

397 
be¡key
 =ğ
NULL
) {

398 
tÙ®_keys
 = 0, 
keys
;

403 
i
 = 0; i < 
£rv”
.
dbnum
; i++) {

404 
db
 = 
£rv”
.db+
i
;

405 
diù
 = (
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_ALLKEYS
) ?

406 
db
->
diù
 : db->
expœes
;

407 ià((
keys
 = 
	`diùSize
(
diù
)) != 0) {

408 
	`eviùiÚPoŞPİuÏ‹
(
i
, 
diù
, 
db
->diù, 
poŞ
);

409 
tÙ®_keys
 +ğ
keys
;

412 ià(!
tÙ®_keys
) ;

415 
k
 = 
EVPOOL_SIZE
-1; k >= 0; k--) {

416 ià(
poŞ
[
k
].
key
 =ğ
NULL
) ;

417 
be¡dbid
 = 
poŞ
[
k
].
dbid
;

419 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_ALLKEYS
) {

420 
de
 = 
	`diùFšd
(
£rv”
.
db
[
poŞ
[
k
].
dbid
].
diù
,

421 
poŞ
[
k
].
key
);

423 
de
 = 
	`diùFšd
(
£rv”
.
db
[
poŞ
[
k
].
dbid
].
expœes
,

424 
poŞ
[
k
].
key
);

428 ià(
poŞ
[
k
].
key
 !ğpoŞ[k].
ÿched
)

429 
	`sdsä“
(
poŞ
[
k
].
key
);

430 
poŞ
[
k
].
key
 = 
NULL
;

431 
poŞ
[
k
].
idË
 = 0;

435 ià(
de
) {

436 
be¡key
 = 
	`diùG‘Key
(
de
);

446 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
 ||

447 
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_RANDOM
)

452 
i
 = 0; i < 
£rv”
.
dbnum
; i++) {

453 
j
 = (++
Ãxt_db
è% 
£rv”
.
dbnum
;

454 
db
 = 
£rv”
.db+
j
;

455 
diù
 = (
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
) ?

456 
db
->
diù
 : db->
expœes
;

457 ià(
	`diùSize
(
diù
) != 0) {

458 
de
 = 
	`diùG‘RªdomKey
(
diù
);

459 
be¡key
 = 
	`diùG‘Key
(
de
);

460 
be¡dbid
 = 
j
;

467 ià(
be¡key
) {

468 
db
 = 
£rv”
.db+
be¡dbid
;

469 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
be¡key
,
	`sd¦’
(bestkey));

470 
	`´İag©eExpœe
(
db
,
keyobj
,
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
);

479 
d–
 = (è
	`zm®loc_u£d_memÜy
();

480 
	`Ï‹ncyS¹MÚ™Ü
(
eviùiÚ_Ï‹ncy
);

481 ià(
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
)

482 
	`dbAsyncD–‘e
(
db
,
keyobj
);

484 
	`dbSyncD–‘e
(
db
,
keyobj
);

485 
	`Ï‹ncyEndMÚ™Ü
(
eviùiÚ_Ï‹ncy
);

486 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-d–",
eviùiÚ_Ï‹ncy
);

487 
	`Ï‹ncyRemoveNe¡edEv’t
(
Ï‹ncy
,
eviùiÚ_Ï‹ncy
);

488 
d–
 -ğ(è
	`zm®loc_u£d_memÜy
();

489 
mem_ä“d
 +ğ
d–
;

490 
£rv”
.
¡©_eviùedkeys
++;

491 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EVICTED
, "evicted",

492 
keyobj
, 
db
->
id
);

493 
	`deüRefCouÁ
(
keyobj
);

494 
keys_ä“d
++;

500 ià(
¦aves
è
	`æushSÏvesOuutBufãrs
();

503 ià(!
keys_ä“d
) {

504 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

505 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-cyşe",
Ï‹ncy
);

506 
ÿÁ_ä“
;

509 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

510 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-cyşe",
Ï‹ncy
);

511  
C_OK
;

513 
ÿÁ_ä“
:

517 
	`bioP’dšgJobsOfTy³
(
BIO_LAZY_FREE
)) {

518 ià(((
mem_»pÜ‹d
 - 
	`zm®loc_u£d_memÜy
()è+ 
mem_ä“d
è>ğ
mem_toä“
)

520 
	`u¦“p
(1000);

522  
C_ERR
;

523 
	}
}

	@expire.c

33 
	~"£rv”.h
"

54 
	$aùiveExpœeCyşeTryExpœe
(
»disDb
 *
db
, 
diùEÁry
 *
de
, 
now
) {

55 
t
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
);

56 ià(
now
 > 
t
) {

57 
sds
 
key
 = 
	`diùG‘Key
(
de
);

58 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

60 
	`´İag©eExpœe
(
db
,
keyobj
,
£rv”
.
Ïzyä“_Ïzy_expœe
);

61 ià(
£rv”
.
Ïzyä“_Ïzy_expœe
)

62 
	`dbAsyncD–‘e
(
db
,
keyobj
);

64 
	`dbSyncD–‘e
(
db
,
keyobj
);

65 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EXPIRED
,

66 "expœed",
keyobj
,
db
->
id
);

67 
	`deüRefCouÁ
(
keyobj
);

68 
£rv”
.
¡©_expœedkeys
++;

73 
	}
}

97 
	$aùiveExpœeCyşe
(
ty³
) {

100 
cu¼’t_db
 = 0;

101 
tim–im™_ex™
 = 0;

102 
Ï¡_ç¡_cyşe
 = 0;

104 
j
, 
™”©iÚ
 = 0;

105 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

106 
¡¬t
 = 
	`u¡ime
(), 
tim–im™
;

108 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
) {

112 ià(!
tim–im™_ex™
) ;

113 ià(
¡¬t
 < 
Ï¡_ç¡_cyşe
 + 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
*2) ;

114 
Ï¡_ç¡_cyşe
 = 
¡¬t
;

124 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
 || 
tim–im™_ex™
)

125 
dbs_³r_ÿÎ
 = 
£rv”
.
dbnum
;

131 
tim–im™
 = 1000000*
ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
/
£rv”
.
hz
/100;

132 
tim–im™_ex™
 = 0;

133 ià(
tim–im™
 <= 0)imelimit = 1;

135 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
)

136 
tim–im™
 = 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
;

138 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

139 
expœed
;

140 
»disDb
 *
db
 = 
£rv”
.db+(
cu¼’t_db
 % s”v”.
dbnum
);

145 
cu¼’t_db
++;

150 
num
, 
¦Ùs
;

151 
now
, 
‰l_sum
;

152 
‰l_§m¶es
;

155 ià((
num
 = 
	`diùSize
(
db
->
expœes
)) == 0) {

156 
db
->
avg_‰l
 = 0;

159 
¦Ùs
 = 
	`diùSlÙs
(
db
->
expœes
);

160 
now
 = 
	`m¡ime
();

165 ià(
num
 && 
¦Ùs
 > 
DICT_HT_INITIAL_SIZE
 &&

166 (
num
*100/
¦Ùs
 < 1)) ;

170 
expœed
 = 0;

171 
‰l_sum
 = 0;

172 
‰l_§m¶es
 = 0;

174 ià(
num
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
)

175 
num
 = 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
;

177 
num
--) {

178 
diùEÁry
 *
de
;

179 
‰l
;

181 ià((
de
 = 
	`diùG‘RªdomKey
(
db
->
expœes
)è=ğ
NULL
) ;

182 
‰l
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
)-
now
;

183 ià(
	`aùiveExpœeCyşeTryExpœe
(
db
,
de
,
now
)è
expœed
++;

184 ià(
‰l
 > 0) {

186 
‰l_sum
 +ğ
‰l
;

187 
‰l_§m¶es
++;

192 ià(
‰l_§m¶es
) {

193 
avg_‰l
 = 
‰l_sum
/
‰l_§m¶es
;

198 ià(
db
->
avg_‰l
 == 0) db->avg_ttl =‡vg_ttl;

199 
db
->
avg_‰l
 = (db->avg_ttl/50)*49 + (avg_ttl/50);

205 
™”©iÚ
++;

206 ià((
™”©iÚ
 & 0xf) == 0) {

207 
–­£d
 = 
	`u¡ime
()-
¡¬t
;

209 
	`Ï‹ncyAddSam¶eIfN“ded
("expœe-cyşe",
–­£d
/1000);

210 ià(
–­£d
 > 
tim–im™
è
tim–im™_ex™
 = 1;

212 ià(
tim–im™_ex™
) ;

215 } 
expœed
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
/4);

217 
	}
}

230 
	$expœeG’”icCommªd
(
ş›Á
 *
c
, 
ba£time
, 
un™
) {

231 
robj
 *
key
 = 
c
->
¬gv
[1], *
·¿m
 = c->argv[2];

232 
wh’
;

234 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
·¿m
, &
wh’
, 
NULL
è!ğ
C_OK
)

237 ià(
un™
 =ğ
UNIT_SECONDS
è
wh’
 *= 1000;

238 
wh’
 +ğ
ba£time
;

241 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
è=ğ
NULL
) {

242 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

252 ià(
wh’
 <ğ
	`m¡ime
(è&& !
£rv”
.
lßdšg
 && !£rv”.
ma¡”ho¡
) {

253 
robj
 *
aux
;

255 
d–‘ed
 = 
£rv”
.
Ïzyä“_Ïzy_expœe
 ? 
	`dbAsyncD–‘e
(
c
->
db
,
key
) :

256 
	`dbSyncD–‘e
(
c
->
db
,
key
);

257 
	`£rv”As£¹W™hInfo
(
c
,
key
,
d–‘ed
);

258 
£rv”
.
dœty
++;

261 
aux
 = 
£rv”
.
Ïzyä“_Ïzy_expœe
 ? 
sh¬ed
.
uÆšk
 : sh¬ed.
d–
;

262 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
aux
,
key
);

263 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

264 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

265 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

268 
	`£tExpœe
(
c
->
db
,
key
,
wh’
);

269 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

270 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

271 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"expœe",
key
,
c
->
db
->
id
);

272 
£rv”
.
dœty
++;

275 
	}
}

278 
	$expœeCommªd
(
ş›Á
 *
c
) {

279 
	`expœeG’”icCommªd
(
c
,
	`m¡ime
(),
UNIT_SECONDS
);

280 
	}
}

283 
	$expœ—tCommªd
(
ş›Á
 *
c
) {

284 
	`expœeG’”icCommªd
(
c
,0,
UNIT_SECONDS
);

285 
	}
}

288 
	$³xpœeCommªd
(
ş›Á
 *
c
) {

289 
	`expœeG’”icCommªd
(
c
,
	`m¡ime
(),
UNIT_MILLISECONDS
);

290 
	}
}

293 
	$³xpœ—tCommªd
(
ş›Á
 *
c
) {

294 
	`expœeG’”icCommªd
(
c
,0,
UNIT_MILLISECONDS
);

295 
	}
}

298 
	$‰lG’”icCommªd
(
ş›Á
 *
c
, 
ouut_ms
) {

299 
expœe
, 
‰l
 = -1;

302 ià(
	`lookupKeyR—dW™hFÏgs
(
c
->
db
,c->
¬gv
[1],
LOOKUP_NOTOUCH
è=ğ
NULL
) {

303 
	`addR•lyLÚgLÚg
(
c
,-2);

308 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

309 ià(
expœe
 != -1) {

310 
‰l
 = 
expœe
-
	`m¡ime
();

311 ià(
‰l
 < 0)tl = 0;

313 ià(
‰l
 == -1) {

314 
	`addR•lyLÚgLÚg
(
c
,-1);

316 
	`addR•lyLÚgLÚg
(
c
,
ouut_ms
 ? 
‰l
 : ((ttl+500)/1000));

318 
	}
}

321 
	$‰lCommªd
(
ş›Á
 *
c
) {

322 
	`‰lG’”icCommªd
(
c
, 0);

323 
	}
}

326 
	$±Commªd
(
ş›Á
 *
c
) {

327 
	`‰lG’”icCommªd
(
c
, 1);

328 
	}
}

331 
	$³rsi¡Commªd
(
ş›Á
 *
c
) {

332 
diùEÁry
 *
de
;

334 
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[1]->
±r
);

335 ià(
de
 =ğ
NULL
) {

336 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

338 ià(
	`»moveExpœe
(
c
->
db
,c->
¬gv
[1])) {

339 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

340 
£rv”
.
dœty
++;

342 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

345 
	}
}

348 
	$touchCommªd
(
ş›Á
 *
c
) {

349 
touched
 = 0;

350 
j
 = 1; j < 
c
->
¬gc
; j++)

351 ià(
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]è!ğ
NULL
è
touched
++;

352 
	`addR•lyLÚgLÚg
(
c
,
touched
);

353 
	}
}

	@fmacros.h

30 #iâdeà
_REDIS_FMACRO_H


31 
	#_REDIS_FMACRO_H


	)

33 
	#_BSD_SOURCE


	)

35 #ià
defšed
(
__lšux__
)

36 
	#_GNU_SOURCE


	)

37 
	#_DEFAULT_SOURCE


	)

40 #ià
defšed
(
_AIX
)

41 
	#_ALL_SOURCE


	)

44 #ià
defšed
(
__lšux__
è|| defšed(
__O³nBSD__
)

45 
	#_XOPEN_SOURCE
 700

	)

50 #–ià!
defšed
(
__N‘BSD__
)

51 
	#_XOPEN_SOURCE


	)

54 #ià
defšed
(
__sun
)

55 
	#_POSIX_C_SOURCE
 199506L

	)

58 
	#_LARGEFILE_SOURCE


	)

59 
	#_FILE_OFFSET_BITS
 64

	)

	@geo.c

31 
	~"geo.h
"

32 
	~"geohash_h–³r.h
"

36 *
zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

37 
z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

52 
geoA¼ay
 *
	$geoA¼ayC»©e
() {

53 
geoA¼ay
 *
ga
 = 
	`zm®loc
((*ga));

55 
ga
->
¬¿y
 = 
NULL
;

56 
ga
->
buck‘s
 = 0;

57 
ga
->
u£d
 = 0;

58  
ga
;

59 
	}
}

63 
geoPošt
 *
	$geoA¼ayAµ’d
(
geoA¼ay
 *
ga
) {

64 ià(
ga
->
u£d
 =ğga->
buck‘s
) {

65 
ga
->
buck‘s
 = (ga->buckets == 0) ? 8 : ga->buckets*2;

66 
ga
->
¬¿y
 = 
	`z»®loc
(ga->¬¿y,(
geoPošt
)*ga->
buck‘s
);

68 
geoPošt
 *
gp
 = 
ga
->
¬¿y
+ga->
u£d
;

69 
ga
->
u£d
++;

70  
gp
;

71 
	}
}

74 
	$geoA¼ayF»e
(
geoA¼ay
 *
ga
) {

75 
size_t
 
i
;

76 
i
 = 0; i < 
ga
->
u£d
; i++è
	`sdsä“
(ga->
¬¿y
[i].
memb”
);

77 
	`zä“
(
ga
->
¬¿y
);

78 
	`zä“
(
ga
);

79 
	}
}

84 
	$decodeGeohash
(
b™s
, *
xy
) {

85 
GeoHashB™s
 
hash
 = { .
b™s
 = (
ušt64_t
)b™s, .
¡•
 = 
GEO_STEP_MAX
 };

86  
	`geohashDecodeToLÚgL©WGS84
(
hash
, 
xy
);

87 
	}
}

92 
	$exŒaùLÚgL©OrR•ly
(
ş›Á
 *
c
, 
robj
 **
¬gv
, *
xy
) {

93 
i
;

94 
i
 = 0; i < 2; i++) {

95 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
, 
¬gv
[
i
], 
xy
 + i, 
NULL
) !=

96 
C_OK
) {

97  
C_ERR
;

100 ià(
xy
[0] < 
GEO_LONG_MIN
 || xy[0] > 
GEO_LONG_MAX
 ||

101 
xy
[1] < 
GEO_LAT_MIN
 || xy[1] > 
GEO_LAT_MAX
) {

102 
	`addR•lySds
(
c
, 
	`sdsÿrštf
(
	`sd£m±y
(),

103 "-ERR inv®id†Úg™ude,Ït™ud·œ %f,%f\r\n",
xy
[0],xy[1]));

104  
C_ERR
;

106  
C_OK
;

107 
	}
}

112 
	$lÚgL©FromMemb”
(
robj
 *
zobj
,„obj *
memb”
, *
xy
) {

113 
scÜe
 = 0;

115 ià(
	`z£tScÜe
(
zobj
, 
memb”
->
±r
, &
scÜe
è=ğ
C_ERR
)  C_ERR;

116 ià(!
	`decodeGeohash
(
scÜe
, 
xy
)è 
C_ERR
;

117  
C_OK
;

118 
	}
}

126 
	$exŒaùUn™OrR•ly
(
ş›Á
 *
c
, 
robj
 *
un™
) {

127 *
u
 = 
un™
->
±r
;

129 ià(!
	`¡rcmp
(
u
, "m")) {

131 } ià(!
	`¡rcmp
(
u
, "km")) {

133 } ià(!
	`¡rcmp
(
u
, "ft")) {

135 } ià(!
	`¡rcmp
(
u
, "mi")) {

138 
	`addR•lyE¼Ü
(
c
,

142 
	}
}

151 
	$exŒaùDi¡ªûOrR•ly
(
ş›Á
 *
c
, 
robj
 **
¬gv
,

152 *
cÚv”siÚ
) {

153 
di¡ªû
;

154 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
, 
¬gv
[0], &
di¡ªû
,

155 "Ãed‚um”iø¿dius"è!ğ
C_OK
) {

159 ià(
di¡ªû
 < 0) {

160 
	`addR•lyE¼Ü
(
c
,"radius cannot be‚egative");

164 
to_m‘”s
 = 
	`exŒaùUn™OrR•ly
(
c
,
¬gv
[1]);

165 ià(
to_m‘”s
 < 0) {

169 ià(
cÚv”siÚ
è*cÚv”siÚ = 
to_m‘”s
;

170  
di¡ªû
 * 
to_m‘”s
;

171 
	}
}

178 
	$addR•lyDoubËDi¡ªû
(
ş›Á
 *
c
, 
d
) {

179 
dbuf
[128];

180 
dËn
 = 
	`¢´štf
(
dbuf
, (dbuf), "%.4f", 
d
);

181 
	`addR•lyBulkCBufãr
(
c
, 
dbuf
, 
dËn
);

182 
	}
}

190 
	$geoAµ’dIfW™hšRadius
(
geoA¼ay
 *
ga
, 
lÚ
, 
Ït
, 
¿dius
, 
scÜe
, 
sds
 
memb”
) {

191 
di¡ªû
, 
xy
[2];

193 ià(!
	`decodeGeohash
(
scÜe
,
xy
)è 
C_ERR
;

196 ià(!
	`geohashG‘Di¡ªûIfInRadiusWGS84
(
lÚ
,
Ït
, 
xy
[0], xy[1],

197 
¿dius
, &
di¡ªû
))

199  
C_ERR
;

203 
geoPošt
 *
gp
 = 
	`geoA¼ayAµ’d
(
ga
);

204 
gp
->
lÚg™ude
 = 
xy
[0];

205 
gp
->
Ït™ude
 = 
xy
[1];

206 
gp
->
di¡
 = 
di¡ªû
;

207 
gp
->
memb”
 = member;

208 
gp
->
scÜe
 = score;

209  
C_OK
;

210 
	}
}

224 
	$geoG‘PoštsInRªge
(
robj
 *
zobj
, 
mš
, 
max
, 
lÚ
, 
Ït
, 
¿dius
, 
geoA¼ay
 *
ga
) {

227 
z¿nge¥ec
 
¿nge
 = { .
mš
 = mš, .
max
 = max, .
mšex
 = 0, .
maxex
 = 1 };

228 
size_t
 
ÜigšcouÁ
 = 
ga
->
u£d
;

229 
sds
 
memb”
;

231 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

232 *
zl
 = 
zobj
->
±r
;

233 *
•Œ
, *
¥Œ
;

234 *
v¡r
 = 
NULL
;

235 
vËn
 = 0;

236 
vlÚg
 = 0;

237 
scÜe
 = 0;

239 ià((
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
, &
¿nge
)è=ğ
NULL
) {

244 
¥Œ
 = 
	`zli¡Next
(
zl
, 
•Œ
);

245 
•Œ
) {

246 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

249 ià(!
	`z¦V®ueL‹Max
(
scÜe
, &
¿nge
))

253 
	`zli¡G‘
(
•Œ
, &
v¡r
, &
vËn
, &
vlÚg
);

254 
memb”
 = (
v¡r
 =ğ
NULL
è? 
	`sdsäomlÚglÚg
(
vlÚg
) :

255 
	`sd¢ewËn
(
v¡r
,
vËn
);

256 ià(
	`geoAµ’dIfW™hšRadius
(
ga
,
lÚ
,
Ït
,
¿dius
,
scÜe
,
memb”
)

257 =ğ
C_ERR
è
	`sdsä“
(
memb”
);

258 
	`zzlNext
(
zl
, &
•Œ
, &
¥Œ
);

260 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

261 
z£t
 *
zs
 = 
zobj
->
±r
;

262 
zskli¡
 *
z¦
 = 
zs
->zsl;

263 
zskli¡Node
 *
Ê
;

265 ià((
Ê
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
)è=ğ
NULL
) {

270 
Ê
) {

271 
sds
 
–e
 = 
Ê
->ele;

273 ià(!
	`z¦V®ueL‹Max
(
Ê
->
scÜe
, &
¿nge
))

276 
–e
 = 
	`sdsdup
(ele);

277 ià(
	`geoAµ’dIfW™hšRadius
(
ga
,
lÚ
,
Ït
,
¿dius
,
Ê
->
scÜe
,
–e
)

278 =ğ
C_ERR
è
	`sdsä“
(
–e
);

279 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

282  
ga
->
u£d
 - 
ÜigšcouÁ
;

283 
	}
}

288 
	$scÜesOfGeoHashBox
(
GeoHashB™s
 
hash
, 
GeoHashFix52B™s
 *
mš
, GeoHashFix52B™ *
max
) {

309 *
mš
 = 
	`geohashAlign52B™s
(
hash
);

310 
hash
.
b™s
++;

311 *
max
 = 
	`geohashAlign52B™s
(
hash
);

312 
	}
}

317 
	$memb”sOfGeoHashBox
(
robj
 *
zobj
, 
GeoHashB™s
 
hash
, 
geoA¼ay
 *
ga
, 
lÚ
, 
Ït
, 
¿dius
) {

318 
GeoHashFix52B™s
 
mš
, 
max
;

320 
	`scÜesOfGeoHashBox
(
hash
,&
mš
,&
max
);

321  
	`geoG‘PoštsInRªge
(
zobj
, 
mš
, 
max
, 
lÚ
, 
Ït
, 
¿dius
, 
ga
);

322 
	}
}

325 
	$memb”sOfAÎNeighbÜs
(
robj
 *
zobj
, 
GeoHashRadius
 
n
, 
lÚ
, 
Ït
, 
¿dius
, 
geoA¼ay
 *
ga
) {

326 
GeoHashB™s
 
ÃighbÜs
[9];

327 
i
, 
couÁ
 = 0, 
Ï¡_´oûs£d
 = 0;

329 
ÃighbÜs
[0] = 
n
.
hash
;

330 
ÃighbÜs
[1] = 
n
.ÃighbÜs.
nÜth
;

331 
ÃighbÜs
[2] = 
n
.ÃighbÜs.
south
;

332 
ÃighbÜs
[3] = 
n
.ÃighbÜs.
—¡
;

333 
ÃighbÜs
[4] = 
n
.ÃighbÜs.
we¡
;

334 
ÃighbÜs
[5] = 
n
.ÃighbÜs.
nÜth_—¡
;

335 
ÃighbÜs
[6] = 
n
.ÃighbÜs.
nÜth_we¡
;

336 
ÃighbÜs
[7] = 
n
.ÃighbÜs.
south_—¡
;

337 
ÃighbÜs
[8] = 
n
.ÃighbÜs.
south_we¡
;

341 
i
 = 0; i < (
ÃighbÜs
) / (*neighbors); i++) {

342 ià(
	`HASHISZERO
(
ÃighbÜs
[
i
]))

349 ià(
Ï¡_´oûs£d
 &&

350 
ÃighbÜs
[
i
].
b™s
 =ğÃighbÜs[
Ï¡_´oûs£d
].bits &&

351 
ÃighbÜs
[
i
].
¡•
 =ğÃighbÜs[
Ï¡_´oûs£d
].step)

353 
couÁ
 +ğ
	`memb”sOfGeoHashBox
(
zobj
, 
ÃighbÜs
[
i
], 
ga
, 
lÚ
, 
Ït
, 
¿dius
);

354 
Ï¡_´oûs£d
 = 
i
;

356  
couÁ
;

357 
	}
}

360 
	$sÜt_gp_asc
(cÚ¡ *
a
, cÚ¡ *
b
) {

361 cÚ¡ 
geoPošt
 *
g·
 = 
a
, *
gpb
 = 
b
;

364 ià(
g·
->
di¡
 > 
gpb
->dist)

366 ià(
g·
->
di¡
 =ğ
gpb
->dist)

370 
	}
}

372 
	$sÜt_gp_desc
(cÚ¡ *
a
, cÚ¡ *
b
) {

373  -
	`sÜt_gp_asc
(
a
, 
b
);

374 
	}
}

381 
	$geßddCommªd
(
ş›Á
 *
c
) {

383 ià((
c
->
¬gc
 - 2) % 3 != 0) {

385 
	`addR•lyE¼Ü
(
c
, "syntaxƒrror. Try GEOADD key [x1] [y1] [name1] "

390 
–em’ts
 = (
c
->
¬gc
 - 2) / 3;

391 
¬gc
 = 2+
–em’ts
*2;

392 
robj
 **
¬gv
 = 
	`zÿÎoc
(
¬gc
*(robj*));

393 
¬gv
[0] = 
	`ü—‹RawSŒšgObjeù
("zadd",4);

394 
¬gv
[1] = 
c
->argv[1];

395 
	`šüRefCouÁ
(
¬gv
[1]);

400 
i
;

401 
i
 = 0; i < 
–em’ts
; i++) {

402 
xy
[2];

404 ià(
	`exŒaùLÚgL©OrR•ly
(
c
, (c->
¬gv
+2)+(
i
*3),
xy
è=ğ
C_ERR
) {

405 
i
 = 0; i < 
¬gc
; i++)

406 ià(
¬gv
[
i
]è
	`deüRefCouÁ
(argv[i]);

407 
	`zä“
(
¬gv
);

412 
GeoHashB™s
 
hash
;

413 
	`geohashEncodeWGS84
(
xy
[0], xy[1], 
GEO_STEP_MAX
, &
hash
);

414 
GeoHashFix52B™s
 
b™s
 = 
	`geohashAlign52B™s
(
hash
);

415 
robj
 *
scÜe
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
	`sdsäomlÚglÚg
(
b™s
));

416 
robj
 *
v®
 = 
c
->
¬gv
[2 + 
i
 * 3 + 2];

417 
¬gv
[2+
i
*2] = 
scÜe
;

418 
¬gv
[3+
i
*2] = 
v®
;

419 
	`šüRefCouÁ
(
v®
);

423 
	`»¶aûCl›ÁCommªdVeùÜ
(
c
,
¬gc
,
¬gv
);

424 
	`zaddCommªd
(
c
);

425 
	}
}

427 
	#SORT_NONE
 0

	)

428 
	#SORT_ASC
 1

	)

429 
	#SORT_DESC
 2

	)

431 
	#RADIUS_COORDS
 1

	)

432 
	#RADIUS_MEMBER
 2

	)

437 
	$geÜadiusG’”ic
(
ş›Á
 *
c
, 
ty³
) {

438 
robj
 *
key
 = 
c
->
¬gv
[1];

439 
robj
 *
¡Üekey
 = 
NULL
;

440 
¡Üedi¡
 = 0;

443 
robj
 *
zobj
 = 
NULL
;

444 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

445 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) {

450 
ba£_¬gs
;

451 
xy
[2] = { 0 };

452 ià(
ty³
 =ğ
RADIUS_COORDS
) {

453 
ba£_¬gs
 = 6;

454 ià(
	`exŒaùLÚgL©OrR•ly
(
c
, c->
¬gv
 + 2, 
xy
è=ğ
C_ERR
)

456 } ià(
ty³
 =ğ
RADIUS_MEMBER
) {

457 
ba£_¬gs
 = 5;

458 
robj
 *
memb”
 = 
c
->
¬gv
[2];

459 ià(
	`lÚgL©FromMemb”
(
zobj
, 
memb”
, 
xy
è=ğ
C_ERR
) {

460 
	`addR•lyE¼Ü
(
c
, "could‚ot decode„equested zset member");

464 
	`addR•lyE¼Ü
(
c
, "unknown georadius searchype");

469 
¿dius_m‘”s
 = 0, 
cÚv”siÚ
 = 1;

470 ià((
¿dius_m‘”s
 = 
	`exŒaùDi¡ªûOrR•ly
(
c
, c->
¬gv
 + 
ba£_¬gs
 - 2,

471 &
cÚv”siÚ
)) < 0) {

476 
w™hdi¡
 = 0, 
w™hhash
 = 0, 
w™hcoÜds
 = 0;

477 
sÜt
 = 
SORT_NONE
;

478 
couÁ
 = 0;

479 ià(
c
->
¬gc
 > 
ba£_¬gs
) {

480 
»maššg
 = 
c
->
¬gc
 - 
ba£_¬gs
;

481 
i
 = 0; i < 
»maššg
; i++) {

482 *
¬g
 = 
c
->
¬gv
[
ba£_¬gs
 + 
i
]->
±r
;

483 ià(!
	`¡rÿ£cmp
(
¬g
, "withdist")) {

484 
w™hdi¡
 = 1;

485 } ià(!
	`¡rÿ£cmp
(
¬g
, "withhash")) {

486 
w™hhash
 = 1;

487 } ià(!
	`¡rÿ£cmp
(
¬g
, "withcoord")) {

488 
w™hcoÜds
 = 1;

489 } ià(!
	`¡rÿ£cmp
(
¬g
, "asc")) {

490 
sÜt
 = 
SORT_ASC
;

491 } ià(!
	`¡rÿ£cmp
(
¬g
, "desc")) {

492 
sÜt
 = 
SORT_DESC
;

493 } ià(!
	`¡rÿ£cmp
(
¬g
, "couÁ"è&& (
i
+1è< 
»maššg
) {

494 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
ba£_¬gs
+
i
+1],

495 &
couÁ
, 
NULL
è!ğ
C_OK
) ;

496 ià(
couÁ
 <= 0) {

497 
	`addR•lyE¼Ü
(
c
,"COUNT must be > 0");

500 
i
++;

501 } ià(!
	`¡rÿ£cmp
(
¬g
, "¡Üe"è&& (
i
+1è< 
»maššg
) {

502 
¡Üekey
 = 
c
->
¬gv
[
ba£_¬gs
+
i
+1];

503 
¡Üedi¡
 = 0;

504 
i
++;

505 } ià(!
	`¡rÿ£cmp
(
¬g
, "¡Üedi¡"è&& (
i
+1è< 
»maššg
) {

506 
¡Üekey
 = 
c
->
¬gv
[
ba£_¬gs
+
i
+1];

507 
¡Üedi¡
 = 1;

508 
i
++;

510 
	`addR•ly
(
c
, 
sh¬ed
.
syÁax”r
);

517 ià(
¡Üekey
 && (
w™hdi¡
 || 
w™hhash
 || 
w™hcoÜds
)) {

518 
	`addR•lyE¼Ü
(
c
,

526 ià(
couÁ
 !ğ0 && 
sÜt
 =ğ
SORT_NONE
èsÜˆğ
SORT_ASC
;

529 
GeoHashRadius
 
geÜadius
 =

530 
	`geohashG‘A»asByRadiusWGS84
(
xy
[0], xy[1], 
¿dius_m‘”s
);

533 
geoA¼ay
 *
ga
 = 
	`geoA¼ayC»©e
();

534 
	`memb”sOfAÎNeighbÜs
(
zobj
, 
geÜadius
, 
xy
[0], xy[1], 
¿dius_m‘”s
, 
ga
);

537 ià(
ga
->
u£d
 =ğ0 && 
¡Üekey
 =ğ
NULL
) {

538 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

539 
	`geoA¼ayF»e
(
ga
);

543 
»suÉ_Ëngth
 = 
ga
->
u£d
;

544 
»tuºed_™ems
 = (
couÁ
 =ğ0 || 
»suÉ_Ëngth
 < count) ?

545 
»suÉ_Ëngth
 : 
couÁ
;

546 
İtiÚ_Ëngth
 = 0;

549 ià(
sÜt
 =ğ
SORT_ASC
) {

550 
	`qsÜt
(
ga
->
¬¿y
, 
»suÉ_Ëngth
, (
geoPošt
), 
sÜt_gp_asc
);

551 } ià(
sÜt
 =ğ
SORT_DESC
) {

552 
	`qsÜt
(
ga
->
¬¿y
, 
»suÉ_Ëngth
, (
geoPošt
), 
sÜt_gp_desc
);

555 ià(
¡Üekey
 =ğ
NULL
) {

560 ià(
w™hdi¡
)

561 
İtiÚ_Ëngth
++;

563 ià(
w™hcoÜds
)

564 
İtiÚ_Ëngth
++;

566 ià(
w™hhash
)

567 
İtiÚ_Ëngth
++;

573 
	`addR•lyMuÉiBulkL’
(
c
, 
»tuºed_™ems
);

576 
i
;

577 
i
 = 0; i < 
»tuºed_™ems
; i++) {

578 
geoPošt
 *
gp
 = 
ga
->
¬¿y
+
i
;

579 
gp
->
di¡
 /ğ
cÚv”siÚ
;

584 ià(
İtiÚ_Ëngth
)

585 
	`addR•lyMuÉiBulkL’
(
c
, 
İtiÚ_Ëngth
 + 1);

587 
	`addR•lyBulkSds
(
c
,
gp
->
memb”
);

588 
gp
->
memb”
 = 
NULL
;

590 ià(
w™hdi¡
)

591 
	`addR•lyDoubËDi¡ªû
(
c
, 
gp
->
di¡
);

593 ià(
w™hhash
)

594 
	`addR•lyLÚgLÚg
(
c
, 
gp
->
scÜe
);

596 ià(
w™hcoÜds
) {

597 
	`addR•lyMuÉiBulkL’
(
c
, 2);

598 
	`addR•lyHumªLÚgDoubË
(
c
, 
gp
->
lÚg™ude
);

599 
	`addR•lyHumªLÚgDoubË
(
c
, 
gp
->
Ït™ude
);

604 
robj
 *
zobj
;

605 
z£t
 *
zs
;

606 
i
;

607 
size_t
 
max––’
 = 0;

609 ià(
»tuºed_™ems
) {

610 
zobj
 = 
	`ü—‹Z£tObjeù
();

611 
zs
 = 
zobj
->
±r
;

614 
i
 = 0; i < 
»tuºed_™ems
; i++) {

615 
zskli¡Node
 *
znode
;

616 
geoPošt
 *
gp
 = 
ga
->
¬¿y
+
i
;

617 
gp
->
di¡
 /ğ
cÚv”siÚ
;

618 
scÜe
 = 
¡Üedi¡
 ? 
gp
->
di¡
 : gp->score;

619 
size_t
 
––’
 = 
	`sd¦’
(
gp
->
memb”
);

621 ià(
max––’
 < 
––’
) maxelelen =ƒlelen;

622 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
gp
->
memb”
);

623 
	`£rv”As£¹
(
	`diùAdd
(
zs
->
diù
,
gp
->
memb”
,&
znode
->
scÜe
è=ğ
DICT_OK
);

624 
gp
->
memb”
 = 
NULL
;

627 ià(
»tuºed_™ems
) {

628 
	`z£tCÚv”tToZli¡IfN“ded
(
zobj
,
max––’
);

629 
	`£tKey
(
c
->
db
,
¡Üekey
,
zobj
);

630 
	`deüRefCouÁ
(
zobj
);

631 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"geÜadius¡Üe",
¡Üekey
,

632 
c
->
db
->
id
);

633 
£rv”
.
dœty
 +ğ
»tuºed_™ems
;

634 } ià(
	`dbD–‘e
(
c
->
db
,
¡Üekey
)) {

635 
	`sigÇlModif›dKey
(
c
->
db
,
¡Üekey
);

636 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
¡Üekey
,
c
->
db
->
id
);

637 
£rv”
.
dœty
++;

639 
	`addR•lyLÚgLÚg
(
c
, 
»tuºed_™ems
);

641 
	`geoA¼ayF»e
(
ga
);

642 
	}
}

645 
	$geÜadiusCommªd
(
ş›Á
 *
c
) {

646 
	`geÜadiusG’”ic
(
c
, 
RADIUS_COORDS
);

647 
	}
}

650 
	$geÜadiusByMemb”Commªd
(
ş›Á
 *
c
) {

651 
	`geÜadiusG’”ic
(
c
, 
RADIUS_MEMBER
);

652 
	}
}

658 
	$geohashCommªd
(
ş›Á
 *
c
) {

659 *
geßÍhab‘
= "0123456789bcdefghjkmnpqrstuvwxyz";

660 
j
;

663 
robj
 *
zobj
 = 
NULL
;

664 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, c->
¬gv
[1], 
sh¬ed
.
em±ymuÉibulk
))

665 =ğ
NULL
 || 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) ;

669 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-2);

670 
j
 = 2; j < 
c
->
¬gc
; j++) {

671 
scÜe
;

672 ià(
	`z£tScÜe
(
zobj
, 
c
->
¬gv
[
j
]->
±r
, &
scÜe
è=ğ
C_ERR
) {

673 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

682 
xy
[2];

683 ià(!
	`decodeGeohash
(
scÜe
,
xy
)) {

684 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

689 
GeoHashRªge
 
r
[2];

690 
GeoHashB™s
 
hash
;

691 
r
[0].
mš
 = -180;

692 
r
[0].
max
 = 180;

693 
r
[1].
mš
 = -90;

694 
r
[1].
max
 = 90;

695 
	`geohashEncode
(&
r
[0],&r[1],
xy
[0],xy[1],26,&
hash
);

697 
buf
[12];

698 
i
;

699 
i
 = 0; i < 11; i++) {

700 
idx
 = (
hash
.
b™s
 >> (52-((
i
+1)*5))) & 0x1f;

701 
buf
[
i
] = 
geßÍhab‘
[
idx
];

703 
buf
[11] = '\0';

704 
	`addR•lyBulkCBufãr
(
c
,
buf
,11);

707 
	}
}

713 
	$geİosCommªd
(
ş›Á
 *
c
) {

714 
j
;

717 
robj
 *
zobj
 = 
NULL
;

718 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, c->
¬gv
[1], 
sh¬ed
.
em±ymuÉibulk
))

719 =ğ
NULL
 || 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) ;

723 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-2);

724 
j
 = 2; j < 
c
->
¬gc
; j++) {

725 
scÜe
;

726 ià(
	`z£tScÜe
(
zobj
, 
c
->
¬gv
[
j
]->
±r
, &
scÜe
è=ğ
C_ERR
) {

727 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

730 
xy
[2];

731 ià(!
	`decodeGeohash
(
scÜe
,
xy
)) {

732 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

735 
	`addR•lyMuÉiBulkL’
(
c
,2);

736 
	`addR•lyHumªLÚgDoubË
(
c
,
xy
[0]);

737 
	`addR•lyHumªLÚgDoubË
(
c
,
xy
[1]);

740 
	}
}

747 
	$geodi¡Commªd
(
ş›Á
 *
c
) {

748 
to_m‘”
 = 1;

751 ià(
c
->
¬gc
 == 5) {

752 
to_m‘”
 = 
	`exŒaùUn™OrR•ly
(
c
,c->
¬gv
[4]);

753 ià(
to_m‘”
 < 0) ;

754 } ià(
c
->
¬gc
 > 5) {

755 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

760 
robj
 *
zobj
 = 
NULL
;

761 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, c->
¬gv
[1], 
sh¬ed
.
em±ybulk
))

762 =ğ
NULL
 || 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) ;

765 
scÜe1
, 
scÜe2
, 
xyxy
[4];

766 ià(
	`z£tScÜe
(
zobj
, 
c
->
¬gv
[2]->
±r
, &
scÜe1
è=ğ
C_ERR
 ||

767 
	`z£tScÜe
(
zobj
, 
c
->
¬gv
[3]->
±r
, &
scÜe2
è=ğ
C_ERR
)

769 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

774 ià(!
	`decodeGeohash
(
scÜe1
,
xyxy
è|| !decodeGeohash(
scÜe2
,xyxy+2))

775 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

777 
	`addR•lyDoubËDi¡ªû
(
c
,

778 
	`geohashG‘Di¡ªû
(
xyxy
[0],xyxy[1],xyxy[2],xyxy[3]è/ 
to_m‘”
);

779 
	}
}

	@geo.h

1 #iâdeà
__GEO_H__


2 
	#__GEO_H__


	)

4 
	~"£rv”.h
"

8 
	sgeoPošt
 {

9 
	mlÚg™ude
;

10 
	mÏt™ude
;

11 
	mdi¡
;

12 
	mscÜe
;

13 *
	mmemb”
;

14 } 
	tgeoPošt
;

16 
	sgeoA¼ay
 {

17 
geoPošt
 *
	m¬¿y
;

18 
size_t
 
	mbuck‘s
;

19 
size_t
 
	mu£d
;

20 } 
	tgeoA¼ay
;

	@geohash.c

31 
	~"geohash.h
"

52 
šlše
 
ušt64_t
 
	$š‹¾—ve64
(
ušt32_t
 
xlo
, ušt32_ˆ
ylo
) {

53 cÚ¡ 
ušt64_t
 
B
[] = {0x5555555555555555ULL, 0x3333333333333333ULL,

56 cÚ¡ 
S
[] = {1, 2, 4, 8, 16};

58 
ušt64_t
 
x
 = 
xlo
;

59 
ušt64_t
 
y
 = 
ylo
;

61 
x
 = (x | (x << 
S
[4])è& 
B
[4];

62 
y
 = (y | (y << 
S
[4])è& 
B
[4];

64 
x
 = (x | (x << 
S
[3])è& 
B
[3];

65 
y
 = (y | (y << 
S
[3])è& 
B
[3];

67 
x
 = (x | (x << 
S
[2])è& 
B
[2];

68 
y
 = (y | (y << 
S
[2])è& 
B
[2];

70 
x
 = (x | (x << 
S
[1])è& 
B
[1];

71 
y
 = (y | (y << 
S
[1])è& 
B
[1];

73 
x
 = (x | (x << 
S
[0])è& 
B
[0];

74 
y
 = (y | (y << 
S
[0])è& 
B
[0];

76  
x
 | (
y
 << 1);

77 
	}
}

82 
šlše
 
ušt64_t
 
	$deš‹¾—ve64
(
ušt64_t
 
š‹¾—ved
) {

83 cÚ¡ 
ušt64_t
 
B
[] = {0x5555555555555555ULL, 0x3333333333333333ULL,

86 cÚ¡ 
S
[] = {0, 1, 2, 4, 8, 16};

88 
ušt64_t
 
x
 = 
š‹¾—ved
;

89 
ušt64_t
 
y
 = 
š‹¾—ved
 >> 1;

91 
x
 = (x | (x >> 
S
[0])è& 
B
[0];

92 
y
 = (y | (y >> 
S
[0])è& 
B
[0];

94 
x
 = (x | (x >> 
S
[1])è& 
B
[1];

95 
y
 = (y | (y >> 
S
[1])è& 
B
[1];

97 
x
 = (x | (x >> 
S
[2])è& 
B
[2];

98 
y
 = (y | (y >> 
S
[2])è& 
B
[2];

100 
x
 = (x | (x >> 
S
[3])è& 
B
[3];

101 
y
 = (y | (y >> 
S
[3])è& 
B
[3];

103 
x
 = (x | (x >> 
S
[4])è& 
B
[4];

104 
y
 = (y | (y >> 
S
[4])è& 
B
[4];

106 
x
 = (x | (x >> 
S
[5])è& 
B
[5];

107 
y
 = (y | (y >> 
S
[5])è& 
B
[5];

109  
x
 | (
y
 << 32);

110 
	}
}

112 
	$geohashG‘CoÜdRªge
(
GeoHashRªge
 *
lÚg_¿nge
, GeoHashRªg*
Ït_¿nge
) {

115 
lÚg_¿nge
->
max
 = 
GEO_LONG_MAX
;

116 
lÚg_¿nge
->
mš
 = 
GEO_LONG_MIN
;

117 
Ït_¿nge
->
max
 = 
GEO_LAT_MAX
;

118 
Ït_¿nge
->
mš
 = 
GEO_LAT_MIN
;

119 
	}
}

121 
	$geohashEncode
(
GeoHashRªge
 *
lÚg_¿nge
, GeoHashRªg*
Ït_¿nge
,

122 
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

123 
GeoHashB™s
 *
hash
) {

125 ià(
hash
 =ğ
NULL
 || 
¡•
 > 32 || step == 0 ||

126 
	`RANGEPISZERO
(
Ït_¿nge
è|| RANGEPISZERO(
lÚg_¿nge
))  0;

130 ià(
lÚg™ude
 > 180 ||†ongitude < -180 ||

131 
Ït™ude
 > 85.05112878 ||†atitude < -85.05112878)  0;

133 
hash
->
b™s
 = 0;

134 
hash
->
¡•
 = step;

136 ià(
Ït™ude
 < 
Ït_¿nge
->
mš
 ||†©™ud>†©_¿nge->
max
 ||

137 
lÚg™ude
 < 
lÚg_¿nge
->
mš
 ||†Úg™ud>†Úg_¿nge->
max
) {

141 
Ït_off£t
 =

142 (
Ït™ude
 - 
Ït_¿nge
->
mš
è/ (Ït_¿nge->
max
 -†at_range->min);

143 
lÚg_off£t
 =

144 (
lÚg™ude
 - 
lÚg_¿nge
->
mš
è/ (lÚg_¿nge->
max
 -†ong_range->min);

147 
Ït_off£t
 *ğ(1 << 
¡•
);

148 
lÚg_off£t
 *ğ(1 << 
¡•
);

149 
hash
->
b™s
 = 
	`š‹¾—ve64
(
Ït_off£t
, 
lÚg_off£t
);

151 
	}
}

153 
	$geohashEncodeTy³
(
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
, 
GeoHashB™s
 *
hash
) {

154 
GeoHashRªge
 
r
[2] = {{0}};

155 
	`geohashG‘CoÜdRªge
(&
r
[0], &r[1]);

156  
	`geohashEncode
(&
r
[0], &r[1], 
lÚg™ude
, 
Ït™ude
, 
¡•
, 
hash
);

157 
	}
}

159 
	$geohashEncodeWGS84
(
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

160 
GeoHashB™s
 *
hash
) {

161  
	`geohashEncodeTy³
(
lÚg™ude
, 
Ït™ude
, 
¡•
, 
hash
);

162 
	}
}

164 
	$geohashDecode
(cÚ¡ 
GeoHashRªge
 
lÚg_¿nge
, cÚ¡ GeoHashRªg
Ït_¿nge
,

165 cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
) {

166 ià(
	`HASHISZERO
(
hash
è|| 
NULL
 =ğ
¬—
 || 
	`RANGEISZERO
(
Ït_¿nge
) ||

167 
	`RANGEISZERO
(
lÚg_¿nge
)) {

171 
¬—
->
hash
 = hash;

172 
ušt8_t
 
¡•
 = 
hash
.step;

173 
ušt64_t
 
hash_£p
 = 
	`deš‹¾—ve64
(
hash
.
b™s
);

175 
Ït_sÿË
 = 
Ït_¿nge
.
max
 -†©_¿nge.
mš
;

176 
lÚg_sÿË
 = 
lÚg_¿nge
.
max
 -†Úg_¿nge.
mš
;

178 
ušt32_t
 
©o
 = 
hash_£p
;

179 
ušt32_t
 
Úo
 = 
hash_£p
 >> 32;

184 
¬—
->
Ït™ude
.
mš
 =

185 
Ït_¿nge
.
mš
 + (
©o
 * 1.0 / (1uÎ << 
¡•
)è* 
Ït_sÿË
;

186 
¬—
->
Ït™ude
.
max
 =

187 
Ït_¿nge
.
mš
 + ((
©o
 + 1è* 1.0 / (1uÎ << 
¡•
)è* 
Ït_sÿË
;

188 
¬—
->
lÚg™ude
.
mš
 =

189 
lÚg_¿nge
.
mš
 + (
Úo
 * 1.0 / (1uÎ << 
¡•
)è* 
lÚg_sÿË
;

190 
¬—
->
lÚg™ude
.
max
 =

191 
lÚg_¿nge
.
mš
 + ((
Úo
 + 1è* 1.0 / (1uÎ << 
¡•
)è* 
lÚg_sÿË
;

194 
	}
}

196 
	$geohashDecodeTy³
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
) {

197 
GeoHashRªge
 
r
[2] = {{0}};

198 
	`geohashG‘CoÜdRªge
(&
r
[0], &r[1]);

199  
	`geohashDecode
(
r
[0],„[1], 
hash
, 
¬—
);

200 
	}
}

202 
	$geohashDecodeWGS84
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
) {

203  
	`geohashDecodeTy³
(
hash
, 
¬—
);

204 
	}
}

206 
	$geohashDecodeA»aToLÚgL©
(cÚ¡ 
GeoHashA»a
 *
¬—
, *
xy
) {

207 ià(!
xy
)  0;

208 
xy
[0] = (
¬—
->
lÚg™ude
.
mš
 +‡»a->lÚg™ude.
max
) / 2;

209 
xy
[1] = (
¬—
->
Ït™ude
.
mš
 +‡»a->Ït™ude.
max
) / 2;

211 
	}
}

213 
	$geohashDecodeToLÚgL©Ty³
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
) {

214 
GeoHashA»a
 
¬—
 = {{0}};

215 ià(!
xy
 || !
	`geohashDecodeTy³
(
hash
, &
¬—
))

217  
	`geohashDecodeA»aToLÚgL©
(&
¬—
, 
xy
);

218 
	}
}

220 
	$geohashDecodeToLÚgL©WGS84
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
) {

221  
	`geohashDecodeToLÚgL©Ty³
(
hash
, 
xy
);

222 
	}
}

224 
	$geohash_move_x
(
GeoHashB™s
 *
hash
, 
št8_t
 
d
) {

225 ià(
d
 == 0)

228 
ušt64_t
 
x
 = 
hash
->
b™s
 & 0xaaaaaaaaaaaaaaaaULL;

229 
ušt64_t
 
y
 = 
hash
->
b™s
 & 0x5555555555555555ULL;

231 
ušt64_t
 
zz
 = 0x5555555555555555ULL >> (64 - 
hash
->
¡•
 * 2);

233 ià(
d
 > 0) {

234 
x
 = x + (
zz
 + 1);

236 
x
 = x | 
zz
;

237 
x
 = x - (
zz
 + 1);

240 
x
 &ğ(0x¯¯¯¯¯¯¯¯ULL >> (64 - 
hash
->
¡•
 * 2));

241 
hash
->
b™s
 = (
x
 | 
y
);

242 
	}
}

244 
	$geohash_move_y
(
GeoHashB™s
 *
hash
, 
št8_t
 
d
) {

245 ià(
d
 == 0)

248 
ušt64_t
 
x
 = 
hash
->
b™s
 & 0xaaaaaaaaaaaaaaaaULL;

249 
ušt64_t
 
y
 = 
hash
->
b™s
 & 0x5555555555555555ULL;

251 
ušt64_t
 
zz
 = 0x¯¯¯¯¯¯¯¯ULL >> (64 - 
hash
->
¡•
 * 2);

252 ià(
d
 > 0) {

253 
y
 = y + (
zz
 + 1);

255 
y
 = y | 
zz
;

256 
y
 = y - (
zz
 + 1);

258 
y
 &ğ(0x5555555555555555ULL >> (64 - 
hash
->
¡•
 * 2));

259 
hash
->
b™s
 = (
x
 | 
y
);

260 
	}
}

262 
	$geohashNeighbÜs
(cÚ¡ 
GeoHashB™s
 *
hash
, 
GeoHashNeighbÜs
 *
ÃighbÜs
) {

263 
ÃighbÜs
->
—¡
 = *
hash
;

264 
ÃighbÜs
->
we¡
 = *
hash
;

265 
ÃighbÜs
->
nÜth
 = *
hash
;

266 
ÃighbÜs
->
south
 = *
hash
;

267 
ÃighbÜs
->
south_—¡
 = *
hash
;

268 
ÃighbÜs
->
south_we¡
 = *
hash
;

269 
ÃighbÜs
->
nÜth_—¡
 = *
hash
;

270 
ÃighbÜs
->
nÜth_we¡
 = *
hash
;

272 
	`geohash_move_x
(&
ÃighbÜs
->
—¡
, 1);

273 
	`geohash_move_y
(&
ÃighbÜs
->
—¡
, 0);

275 
	`geohash_move_x
(&
ÃighbÜs
->
we¡
, -1);

276 
	`geohash_move_y
(&
ÃighbÜs
->
we¡
, 0);

278 
	`geohash_move_x
(&
ÃighbÜs
->
south
, 0);

279 
	`geohash_move_y
(&
ÃighbÜs
->
south
, -1);

281 
	`geohash_move_x
(&
ÃighbÜs
->
nÜth
, 0);

282 
	`geohash_move_y
(&
ÃighbÜs
->
nÜth
, 1);

284 
	`geohash_move_x
(&
ÃighbÜs
->
nÜth_we¡
, -1);

285 
	`geohash_move_y
(&
ÃighbÜs
->
nÜth_we¡
, 1);

287 
	`geohash_move_x
(&
ÃighbÜs
->
nÜth_—¡
, 1);

288 
	`geohash_move_y
(&
ÃighbÜs
->
nÜth_—¡
, 1);

290 
	`geohash_move_x
(&
ÃighbÜs
->
south_—¡
, 1);

291 
	`geohash_move_y
(&
ÃighbÜs
->
south_—¡
, -1);

293 
	`geohash_move_x
(&
ÃighbÜs
->
south_we¡
, -1);

294 
	`geohash_move_y
(&
ÃighbÜs
->
south_we¡
, -1);

295 
	}
}

	@geohash.h

32 #iâdeà
GEOHASH_H_


33 
	#GEOHASH_H_


	)

35 
	~<¡ddef.h
>

36 
	~<¡dšt.h
>

37 
	~<¡dšt.h
>

39 #ià
defšed
(
__ılu¥lus
)

43 
	#HASHISZERO
(
r
è(!Ô).
b™s
 && !Ô).
¡•
)

	)

44 
	#RANGEISZERO
(
r
è(!Ô).
max
 && !Ô).
mš
)

	)

45 
	#RANGEPISZERO
(
r
èÔ =ğ
NULL
 || 
	`RANGEISZERO
(*r))

	)

47 
	#GEO_STEP_MAX
 26

	)

50 
	#GEO_LAT_MIN
 -85.05112878

	)

51 
	#GEO_LAT_MAX
 85.05112878

	)

52 
	#GEO_LONG_MIN
 -180

	)

53 
	#GEO_LONG_MAX
 180

	)

56 
GEOHASH_NORTH
 = 0,

57 
GEOHASH_EAST
,

58 
GEOHASH_WEST
,

59 
GEOHASH_SOUTH
,

60 
GEOHASH_SOUTH_WEST
,

61 
GEOHASH_SOUTH_EAST
,

62 
GEOHASH_NORT_WEST
,

63 
GEOHASH_NORT_EAST


64 } 
	tGeoDœeùiÚ
;

67 
ušt64_t
 
b™s
;

68 
ušt8_t
 
¡•
;

69 } 
	tGeoHashB™s
;

72 
mš
;

73 
max
;

74 } 
	tGeoHashRªge
;

77 
GeoHashB™s
 
hash
;

78 
GeoHashRªge
 
lÚg™ude
;

79 
GeoHashRªge
 
Ït™ude
;

80 } 
	tGeoHashA»a
;

83 
GeoHashB™s
 
nÜth
;

84 
GeoHashB™s
 
—¡
;

85 
GeoHashB™s
 
we¡
;

86 
GeoHashB™s
 
south
;

87 
GeoHashB™s
 
nÜth_—¡
;

88 
GeoHashB™s
 
south_—¡
;

89 
GeoHashB™s
 
nÜth_we¡
;

90 
GeoHashB™s
 
south_we¡
;

91 } 
	tGeoHashNeighbÜs
;

97 
geohashG‘CoÜdRªge
(
GeoHashRªge
 *
lÚg_¿nge
, GeoHashRªg*
Ït_¿nge
);

98 
geohashEncode
(
GeoHashRªge
 *
lÚg_¿nge
, GeoHashRªg*
Ït_¿nge
,

99 
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

100 
GeoHashB™s
 *
hash
);

101 
geohashEncodeTy³
(
lÚg™ude
, 
Ït™ude
,

102 
ušt8_t
 
¡•
, 
GeoHashB™s
 *
hash
);

103 
geohashEncodeWGS84
(
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

104 
GeoHashB™s
 *
hash
);

105 
geohashDecode
(cÚ¡ 
GeoHashRªge
 
lÚg_¿nge
, cÚ¡ GeoHashRªg
Ït_¿nge
,

106 cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
);

107 
geohashDecodeTy³
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
);

108 
geohashDecodeWGS84
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
);

109 
geohashDecodeA»aToLÚgL©
(cÚ¡ 
GeoHashA»a
 *
¬—
, *
xy
);

110 
geohashDecodeToLÚgL©Ty³
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
);

111 
geohashDecodeToLÚgL©WGS84
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
);

112 
geohashDecodeToLÚgL©M”ÿtÜ
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
);

113 
geohashNeighbÜs
(cÚ¡ 
GeoHashB™s
 *
hash
, 
GeoHashNeighbÜs
 *
ÃighbÜs
);

115 #ià
defšed
(
__ılu¥lus
)

	@geohash_helper.c

37 
	~"fmaüos.h
"

38 
	~"geohash_h–³r.h
"

39 
	~<m©h.h
>

41 
	#D_R
 (
M_PI
 / 180.0)

	)

42 
	#R_MAJOR
 6378137.0

	)

43 
	#R_MINOR
 6356752.3142

	)

44 
	#RATIO
 (
R_MINOR
 / 
R_MAJOR
)

	)

45 
	#ECCENT
 (
	`sq¹
(1.0 - (
RATIO
 *RATIO)))

	)

46 
	#COM
 (0.5 * 
ECCENT
)

	)

49 cÚ¡ 
	gDEG_TO_RAD
 = 0.017453292519943295769236907684886;

51 cÚ¡ 
	gEARTH_RADIUS_IN_METERS
 = 6372797.560856;

53 cÚ¡ 
	gMERCATOR_MAX
 = 20037726.37;

54 cÚ¡ 
	gMERCATOR_MIN
 = -20037726.37;

56 
šlše
 
	$deg_¿d
(
ªg
è{ ‡ng * 
D_R
; 
	}
}

57 
šlše
 
	$¿d_deg
(
ªg
è{ ‡ng / 
D_R
; 
	}
}

61 
ušt8_t
 
	$geohashE¡im©eS‹psByRadius
(
¿nge_m‘”s
, 
Ït
) {

62 ià(
¿nge_m‘”s
 == 0)  26;

63 
¡•
 = 1;

64 
¿nge_m‘”s
 < 
MERCATOR_MAX
) {

65 
¿nge_m‘”s
 *= 2;

66 
¡•
++;

68 
¡•
 -= 2;

72 ià(
Ït
 > 67 ||†© < -67è
¡•
--;

73 ià(
Ït
 > 80 ||†© < -80è
¡•
--;

76 ià(
¡•
 < 1) step = 1;

77 ià(
¡•
 > 26) step = 26;

78  
¡•
;

79 
	}
}

81 
	$geohashBoundšgBox
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
,

82 *
bounds
) {

83 ià(!
bounds
)  0;

85 
lÚr
, 
ÏŒ
;

86 
lÚr
 = 
	`deg_¿d
(
lÚg™ude
);

87 
ÏŒ
 = 
	`deg_¿d
(
Ït™ude
);

89 ià(
¿dius_m‘”s
 > 
EARTH_RADIUS_IN_METERS
)

90 
¿dius_m‘”s
 = 
EARTH_RADIUS_IN_METERS
;

91 
di¡ªû
 = 
¿dius_m‘”s
 / 
EARTH_RADIUS_IN_METERS
;

92 
mš_Ït™ude
 = 
ÏŒ
 - 
di¡ªû
;

93 
max_Ït™ude
 = 
ÏŒ
 + 
di¡ªû
;

96 
mš_lÚg™ude
, 
max_lÚg™ude
;

97 
difã»nû_lÚg™ude
 = 
	`asš
(
	`sš
(
di¡ªû
è/ 
	`cos
(
ÏŒ
));

98 
mš_lÚg™ude
 = 
lÚr
 - 
difã»nû_lÚg™ude
;

99 
max_lÚg™ude
 = 
lÚr
 + 
difã»nû_lÚg™ude
;

101 
bounds
[0] = 
	`¿d_deg
(
mš_lÚg™ude
);

102 
bounds
[1] = 
	`¿d_deg
(
mš_Ït™ude
);

103 
bounds
[2] = 
	`¿d_deg
(
max_lÚg™ude
);

104 
bounds
[3] = 
	`¿d_deg
(
max_Ït™ude
);

106 
	}
}

108 
GeoHashRadius
 
	$geohashG‘A»asByRadius
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
) {

109 
GeoHashRªge
 
lÚg_¿nge
, 
Ït_¿nge
;

110 
GeoHashRadius
 
¿dius
 = {{0}};

111 
GeoHashB™s
 
hash
 = {0,0};

112 
GeoHashNeighbÜs
 
ÃighbÜs
 = {{0}};

113 
GeoHashA»a
 
¬—
 = {{0}};

114 
mš_lÚ
, 
max_lÚ
, 
mš_Ït
, 
max_Ït
;

115 
bounds
[4];

116 
¡•s
;

118 
	`geohashBoundšgBox
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
, 
bounds
);

119 
mš_lÚ
 = 
bounds
[0];

120 
mš_Ït
 = 
bounds
[1];

121 
max_lÚ
 = 
bounds
[2];

122 
max_Ït
 = 
bounds
[3];

124 
¡•s
 = 
	`geohashE¡im©eS‹psByRadius
(
¿dius_m‘”s
,
Ït™ude
);

126 
	`geohashG‘CoÜdRªge
(&
lÚg_¿nge
, &
Ït_¿nge
);

127 
	`geohashEncode
(&
lÚg_¿nge
, &
Ït_¿nge
, 
lÚg™ude
, 
Ït™ude
, 
¡•s
, &
hash
);

128 
	`geohashNeighbÜs
(&
hash
, &
ÃighbÜs
);

129 
	`geohashG‘CoÜdRªge
(&
lÚg_¿nge
, &
Ït_¿nge
);

130 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
hash
, &
¬—
);

132 ià(
¬—
.
Ït™ude
.
mš
 < 
mš_Ït
) {

133 
	`GZERO
(
ÃighbÜs
.
south
);

134 
	`GZERO
(
ÃighbÜs
.
south_we¡
);

135 
	`GZERO
(
ÃighbÜs
.
south_—¡
);

137 ià(
¬—
.
Ït™ude
.
max
 > 
max_Ït
) {

138 
	`GZERO
(
ÃighbÜs
.
nÜth
);

139 
	`GZERO
(
ÃighbÜs
.
nÜth_—¡
);

140 
	`GZERO
(
ÃighbÜs
.
nÜth_we¡
);

142 ià(
¬—
.
lÚg™ude
.
mš
 < 
mš_lÚ
) {

143 
	`GZERO
(
ÃighbÜs
.
we¡
);

144 
	`GZERO
(
ÃighbÜs
.
south_we¡
);

145 
	`GZERO
(
ÃighbÜs
.
nÜth_we¡
);

147 ià(
¬—
.
lÚg™ude
.
max
 > 
max_lÚ
) {

148 
	`GZERO
(
ÃighbÜs
.
—¡
);

149 
	`GZERO
(
ÃighbÜs
.
south_—¡
);

150 
	`GZERO
(
ÃighbÜs
.
nÜth_—¡
);

152 
¿dius
.
hash
 = hash;

153 
¿dius
.
ÃighbÜs
 =‚eighbors;

154 
¿dius
.
¬—
 =‡rea;

155  
¿dius
;

156 
	}
}

158 
GeoHashRadius
 
	$geohashG‘A»asByRadiusWGS84
(
lÚg™ude
, 
Ït™ude
,

159 
¿dius_m‘”s
) {

160  
	`geohashG‘A»asByRadius
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
);

161 
	}
}

163 
GeoHashFix52B™s
 
	$geohashAlign52B™s
(cÚ¡ 
GeoHashB™s
 
hash
) {

164 
ušt64_t
 
b™s
 = 
hash
.bits;

165 
b™s
 <<ğ(52 - 
hash
.
¡•
 * 2);

166  
b™s
;

167 
	}
}

170 
	$geohashG‘Di¡ªû
(
lÚ1d
, 
Ït1d
, 
lÚ2d
, 
Ït2d
) {

171 
Ït1r
, 
lÚ1r
, 
Ït2r
, 
lÚ2r
, 
u
, 
v
;

172 
Ït1r
 = 
	`deg_¿d
(
Ït1d
);

173 
lÚ1r
 = 
	`deg_¿d
(
lÚ1d
);

174 
Ït2r
 = 
	`deg_¿d
(
Ït2d
);

175 
lÚ2r
 = 
	`deg_¿d
(
lÚ2d
);

176 
u
 = 
	`sš
((
Ït2r
 - 
Ït1r
) / 2);

177 
v
 = 
	`sš
((
lÚ2r
 - 
lÚ1r
) / 2);

178  2.0 * 
EARTH_RADIUS_IN_METERS
 *

179 
	`asš
(
	`sq¹
(
u
 * u + 
	`cos
(
Ït1r
è* cos(
Ït2r
è* 
v
 * v));

180 
	}
}

182 
	$geohashG‘Di¡ªûIfInRadius
(
x1
, 
y1
,

183 
x2
, 
y2
, 
¿dius
,

184 *
di¡ªû
) {

185 *
di¡ªû
 = 
	`geohashG‘Di¡ªû
(
x1
, 
y1
, 
x2
, 
y2
);

186 ià(*
di¡ªû
 > 
¿dius
)  0;

188 
	}
}

190 
	$geohashG‘Di¡ªûIfInRadiusWGS84
(
x1
, 
y1
, 
x2
,

191 
y2
, 
¿dius
,

192 *
di¡ªû
) {

193  
	`geohashG‘Di¡ªûIfInRadius
(
x1
, 
y1
, 
x2
, 
y2
, 
¿dius
, 
di¡ªû
);

194 
	}
}

	@geohash_helper.h

32 #iâdeà
GEOHASH_HELPER_HPP_


33 
	#GEOHASH_HELPER_HPP_


	)

35 
	~"geohash.h
"

37 
	#GZERO
(
s
ès.
b™s
 = s.
¡•
 = 0;

	)

38 
	#GISZERO
(
s
è(!s.
b™s
 && !s.
¡•
)

	)

39 
	#GISNOTZERO
(
s
è(s.
b™s
 || s.
¡•
)

	)

41 
ušt64_t
 
	tGeoHashFix52B™s
;

42 
ušt64_t
 
	tGeoHashV¬B™s
;

45 
GeoHashB™s
 
	mhash
;

46 
GeoHashA»a
 
	m¬—
;

47 
GeoHashNeighbÜs
 
	mÃighbÜs
;

48 } 
	tGeoHashRadius
;

50 
GeoHashB™sCom·¿tÜ
(cÚ¡ 
GeoHashB™s
 *
a
, cÚ¡ GeoHashB™ *
b
);

51 
ušt8_t
 
geohashE¡im©eS‹psByRadius
(
¿nge_m‘”s
, 
Ït
);

52 
geohashBoundšgBox
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
,

53 *
bounds
);

54 
GeoHashRadius
 
geohashG‘A»asByRadius
(
lÚg™ude
,

55 
Ït™ude
, 
¿dius_m‘”s
);

56 
GeoHashRadius
 
geohashG‘A»asByRadiusWGS84
(
lÚg™ude
, 
Ït™ude
,

57 
¿dius_m‘”s
);

58 
GeoHashRadius
 
geohashG‘A»asByRadiusM”ÿtÜ
(
lÚg™ude
, 
Ït™ude
,

59 
¿dius_m‘”s
);

60 
GeoHashFix52B™s
 
geohashAlign52B™s
(cÚ¡ 
GeoHashB™s
 
hash
);

61 
geohashG‘Di¡ªû
(
lÚ1d
, 
Ït1d
,

62 
lÚ2d
, 
Ït2d
);

63 
geohashG‘Di¡ªûIfInRadius
(
x1
, 
y1
,

64 
x2
, 
y2
, 
¿dius
,

65 *
di¡ªû
);

66 
geohashG‘Di¡ªûIfInRadiusWGS84
(
x1
, 
y1
, 
x2
,

67 
y2
, 
¿dius
,

68 *
di¡ªû
);

	@help.h

3 #iâdeà
__REDIS_HELP_H


4 
	#__REDIS_HELP_H


	)

6 *
	gcommªdGroups
[] = {

23 
	scommªdH–p
 {

24 *
	mÇme
;

25 *
	m·¿ms
;

26 *
	msumm¬y
;

27 
	mgroup
;

28 *
	msšû
;

29 } 
	gcommªdH–p
[] = {

	@hyperloglog.c

32 
	~"£rv”.h
"

34 
	~<¡dšt.h
>

35 
	~<m©h.h
>

182 
	shÎhdr
 {

183 
	mmagic
[4];

184 
ušt8_t
 
	m’codšg
;

185 
ušt8_t
 
	mnÙu£d
[3];

186 
ušt8_t
 
	mÿrd
[8];

187 
ušt8_t
 
	m»gi¡”s
[];

191 
	#HLL_INVALIDATE_CACHE
(
hdr
è(hdr)->
ÿrd
[7] |ğ(1<<7)

	)

192 
	#HLL_VALID_CACHE
(
hdr
è(((hdr)->
ÿrd
[7] & (1<<7)è=ğ0)

	)

194 
	#HLL_P
 14

	)

195 
	#HLL_REGISTERS
 (1<<
HLL_P
è

	)

196 
	#HLL_P_MASK
 (
HLL_REGISTERS
-1è

	)

197 
	#HLL_BITS
 6

	)

198 
	#HLL_REGISTER_MAX
 ((1<<
HLL_BITS
)-1)

	)

199 
	#HLL_HDR_SIZE
 (
hÎhdr
)

	)

200 
	#HLL_DENSE_SIZE
 (
HLL_HDR_SIZE
+((
HLL_REGISTERS
*
HLL_BITS
+7)/8))

	)

201 
	#HLL_DENSE
 0

	)

202 
	#HLL_SPARSE
 1

	)

203 
	#HLL_RAW
 255

	)

204 
	#HLL_MAX_ENCODING
 1

	)

206 *
	gšv®id_hÎ_”r
 = "-INVALIDOBJ Corrupted HLL object detected\r\n";

337 
	#HLL_DENSE_GET_REGISTER
(
rg‘
,
p
,
»gnum
) do { \

338 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

339 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

340 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

341 
_fb8
 = 8 - 
_fb
; \

342 
b0
 = 
_p
[
_by‹
]; \

343 
b1
 = 
_p
[
_by‹
+1]; \

344 
rg‘
 = ((
b0
 >> 
_fb
è| (
b1
 << 
_fb8
)è& 
HLL_REGISTER_MAX
; \

345 } 0)

	)

349 
	#HLL_DENSE_SET_REGISTER
(
p
,
»gnum
,
v®
) do { \

350 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

351 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

352 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

353 
_fb8
 = 8 - 
_fb
; \

354 
_v
 = 
v®
; \

355 
_p
[
_by‹
] &ğ~(
HLL_REGISTER_MAX
 << 
_fb
); \

356 
_p
[
_by‹
] |ğ
_v
 << 
_fb
; \

357 
_p
[
_by‹
+1] &ğ~(
HLL_REGISTER_MAX
 >> 
_fb8
); \

358 
_p
[
_by‹
+1] |ğ
_v
 >> 
_fb8
; \

359 } 0)

	)

363 
	#HLL_SPARSE_XZERO_BIT
 0x40

	)

364 
	#HLL_SPARSE_VAL_BIT
 0x80

	)

365 
	#HLL_SPARSE_IS_ZERO
(
p
è(((*Õ)è& 0xc0è=ğ0è

	)

366 
	#HLL_SPARSE_IS_XZERO
(
p
è(((*Õ)è& 0xc0è=ğ
HLL_SPARSE_XZERO_BIT
)

	)

367 
	#HLL_SPARSE_IS_VAL
(
p
è((*Õ)è& 
HLL_SPARSE_VAL_BIT
)

	)

368 
	#HLL_SPARSE_ZERO_LEN
(
p
è(((*Õ)è& 0x3f)+1)

	)

369 
	#HLL_SPARSE_XZERO_LEN
(
p
è(((((*Õ)è& 0x3fè<< 8è| (*(Õ)+1)))+1)

	)

370 
	#HLL_SPARSE_VAL_VALUE
(
p
è((((*Õ)è>> 2è& 0x1f)+1)

	)

371 
	#HLL_SPARSE_VAL_LEN
(
p
è(((*Õ)è& 0x3)+1)

	)

372 
	#HLL_SPARSE_VAL_MAX_VALUE
 32

	)

373 
	#HLL_SPARSE_VAL_MAX_LEN
 4

	)

374 
	#HLL_SPARSE_ZERO_MAX_LEN
 64

	)

375 
	#HLL_SPARSE_XZERO_MAX_LEN
 16384

	)

376 
	#HLL_SPARSE_VAL_SET
(
p
,
v®
,
Ën
) do { \

377 *(
p
èğ(((
v®
)-1)<<2|((
Ën
)-1))|
HLL_SPARSE_VAL_BIT
; \

378 } 0)

	)

379 
	#HLL_SPARSE_ZERO_SET
(
p
,
Ën
) do { \

380 *(
p
èğ(
Ën
)-1; \

381 } 0)

	)

382 
	#HLL_SPARSE_XZERO_SET
(
p
,
Ën
) do { \

383 
_l
 = (
Ën
)-1; \

384 *(
p
èğ(
_l
>>8è| 
HLL_SPARSE_XZERO_BIT
; \

385 *((
p
)+1èğ(
_l
&0xff); \

386 } 0)

	)

393 
ušt64_t
 
	$MurmurHash64A
 (cÚ¡ * 
key
, 
Ën
, 
£ed
) {

394 cÚ¡ 
ušt64_t
 
m
 = 0xc6a4a7935bd1e995;

395 cÚ¡ 
r
 = 47;

396 
ušt64_t
 
h
 = 
£ed
 ^ (
Ën
 * 
m
);

397 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*)
key
;

398 cÚ¡ 
ušt8_t
 *
’d
 = 
d©a
 + (
Ën
-(len&7));

400 
d©a
 !ğ
’d
) {

401 
ušt64_t
 
k
;

403 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

404 
k
 = *((
ušt64_t
*)
d©a
);

406 
k
 = (
ušt64_t
è
d©a
[0];

407 
k
 |ğ(
ušt64_t
è
d©a
[1] << 8;

408 
k
 |ğ(
ušt64_t
è
d©a
[2] << 16;

409 
k
 |ğ(
ušt64_t
è
d©a
[3] << 24;

410 
k
 |ğ(
ušt64_t
è
d©a
[4] << 32;

411 
k
 |ğ(
ušt64_t
è
d©a
[5] << 40;

412 
k
 |ğ(
ušt64_t
è
d©a
[6] << 48;

413 
k
 |ğ(
ušt64_t
è
d©a
[7] << 56;

416 
k
 *ğ
m
;

417 
k
 ^ğk >> 
r
;

418 
k
 *ğ
m
;

419 
h
 ^ğ
k
;

420 
h
 *ğ
m
;

421 
d©a
 += 8;

424 
Ën
 & 7) {

425 7: 
h
 ^ğ(
ušt64_t
)
d©a
[6] << 48;

426 6: 
h
 ^ğ(
ušt64_t
)
d©a
[5] << 40;

427 5: 
h
 ^ğ(
ušt64_t
)
d©a
[4] << 32;

428 4: 
h
 ^ğ(
ušt64_t
)
d©a
[3] << 24;

429 3: 
h
 ^ğ(
ušt64_t
)
d©a
[2] << 16;

430 2: 
h
 ^ğ(
ušt64_t
)
d©a
[1] << 8;

431 1: 
h
 ^ğ(
ušt64_t
)
d©a
[0];

432 
h
 *ğ
m
;

435 
h
 ^ğh >> 
r
;

436 
h
 *ğ
m
;

437 
h
 ^ğh >> 
r
;

438  
h
;

439 
	}
}

444 
	$hÎP©L’
(*
–e
, 
size_t
 
–esize
, *
»gp
) {

445 
ušt64_t
 
hash
, 
b™
, 
šdex
;

446 
couÁ
;

459 
hash
 = 
	`MurmurHash64A
(
–e
,
–esize
,0xadc83b19ULL);

460 
šdex
 = 
hash
 & 
HLL_P_MASK
;

461 
hash
 |ğ((
ušt64_t
)1<<63);

462 
b™
 = 
HLL_REGISTERS
;

463 
couÁ
 = 1;

464 (
hash
 & 
b™
) == 0) {

465 
couÁ
++;

466 
b™
 <<= 1;

468 *
»gp
 = (è
šdex
;

469  
couÁ
;

470 
	}
}

485 
	$hÎD’£Add
(
ušt8_t
 *
»gi¡”s
, *
–e
, 
size_t
 
–esize
) {

486 
ušt8_t
 
ŞdcouÁ
, 
couÁ
;

487 
šdex
;

490 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

491 
	`HLL_DENSE_GET_REGISTER
(
ŞdcouÁ
,
»gi¡”s
,
šdex
);

492 ià(
couÁ
 > 
ŞdcouÁ
) {

493 
	`HLL_DENSE_SET_REGISTER
(
»gi¡”s
,
šdex
,
couÁ
);

498 
	}
}

504 
	$hÎD’£Sum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

505 
E
 = 0;

506 
j
, 
ez
 = 0;

511 ià(
HLL_REGISTERS
 =ğ16384 && 
HLL_BITS
 == 6) {

512 
ušt8_t
 *
r
 = 
»gi¡”s
;

513 
r0
, 
r1
, 
r2
, 
r3
, 
r4
, 
r5
, 
r6
, 
r7
, 
r8
, 
r9
,

514 
r10
, 
r11
, 
r12
, 
r13
, 
r14
, 
r15
;

515 
j
 = 0; j < 1024; j++) {

517 
r0
 = 
r
[0] & 63; iàÔ0 =ğ0è
ez
++;

518 
r1
 = (
r
[0] >> 6 |„[1] << 2è& 63; iàÔ1 =ğ0è
ez
++;

519 
r2
 = (
r
[1] >> 4 |„[2] << 4è& 63; iàÔ2 =ğ0è
ez
++;

520 
r3
 = (
r
[2] >> 2è& 63; iàÔ3 =ğ0è
ez
++;

521 
r4
 = 
r
[3] & 63; iàÔ4 =ğ0è
ez
++;

522 
r5
 = (
r
[3] >> 6 |„[4] << 2è& 63; iàÔ5 =ğ0è
ez
++;

523 
r6
 = (
r
[4] >> 4 |„[5] << 4è& 63; iàÔ6 =ğ0è
ez
++;

524 
r7
 = (
r
[5] >> 2è& 63; iàÔ7 =ğ0è
ez
++;

525 
r8
 = 
r
[6] & 63; iàÔ8 =ğ0è
ez
++;

526 
r9
 = (
r
[6] >> 6 |„[7] << 2è& 63; iàÔ9 =ğ0è
ez
++;

527 
r10
 = (
r
[7] >> 4 |„[8] << 4è& 63; iàÔ10 =ğ0è
ez
++;

528 
r11
 = (
r
[8] >> 2è& 63; iàÔ11 =ğ0è
ez
++;

529 
r12
 = 
r
[9] & 63; iàÔ12 =ğ0è
ez
++;

530 
r13
 = (
r
[9] >> 6 |„[10] << 2è& 63; iàÔ13 =ğ0è
ez
++;

531 
r14
 = (
r
[10] >> 4 |„[11] << 4è& 63; iàÔ14 =ğ0è
ez
++;

532 
r15
 = (
r
[11] >> 2è& 63; iàÔ15 =ğ0è
ez
++;

537 
E
 +ğ(
PE
[
r0
] + PE[
r1
]è+ (PE[
r2
] + PE[
r3
]è+ (PE[
r4
] + PE[
r5
]) +

538 (
PE
[
r6
] + PE[
r7
]è+ (PE[
r8
] + PE[
r9
]è+ (PE[
r10
] + PE[
r11
]) +

539 (
PE
[
r12
] + PE[
r13
]è+ (PE[
r14
] + PE[
r15
]);

540 
r
 += 12;

543 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

544 
»g
;

546 
	`HLL_DENSE_GET_REGISTER
(
»g
,
»gi¡”s
,
j
);

547 ià(
»g
 == 0) {

548 
ez
++;

551 
E
 +ğ
PE
[
»g
];

554 
E
 +ğ
ez
;

556 *
ezp
 = 
ez
;

557  
E
;

558 
	}
}

568 
	$hÎS·r£ToD’£
(
robj
 *
o
) {

569 
sds
 
¥¬£
 = 
o
->
±r
, 
d’£
;

570 
hÎhdr
 *
hdr
, *
Şdhdr
 = (hÎhdr*)
¥¬£
;

571 
idx
 = 0, 
ruÆ’
, 
»gv®
;

572 
ušt8_t
 *
p
 = (ušt8_t*)
¥¬£
, *
’d
 =…+
	`sd¦’
(sparse);

575 
hdr
 = (
hÎhdr
*è
¥¬£
;

576 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
è 
C_OK
;

581 
d’£
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

582 
hdr
 = (
hÎhdr
*è
d’£
;

583 *
hdr
 = *
Şdhdr
;

584 
hdr
->
’codšg
 = 
HLL_DENSE
;

588 
p
 +ğ
HLL_HDR_SIZE
;

589 
p
 < 
’d
) {

590 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

591 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

592 
idx
 +ğ
ruÆ’
;

593 
p
++;

594 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

595 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

596 
idx
 +ğ
ruÆ’
;

597 
p
 += 2;

599 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

600 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

601 
ruÆ’
--) {

602 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
idx
,
»gv®
);

603 
idx
++;

605 
p
++;

611 ià(
idx
 !ğ
HLL_REGISTERS
) {

612 
	`sdsä“
(
d’£
);

613  
C_ERR
;

617 
	`sdsä“
(
o
->
±r
);

618 
o
->
±r
 = 
d’£
;

619  
C_OK
;

620 
	}
}

638 
	$hÎS·r£Add
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

639 
hÎhdr
 *
hdr
;

640 
ušt8_t
 
ŞdcouÁ
, 
couÁ
, *
¥¬£
, *
’d
, *
p
, *
´ev
, *
Ãxt
;

641 
šdex
, 
fœ¡
, 
¥ª
;

642 
is_z”o
 = 0, 
is_xz”o
 = 0, 
is_v®
 = 0, 
ruÆ’
 = 0;

645 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

649 ià(
couÁ
 > 
HLL_SPARSE_VAL_MAX_VALUE
è
´omÙe
;

656 
o
->
±r
 = 
	`sdsMakeRoomFÜ
(o->ptr,3);

660 
¥¬£
 = 
p
 = ((
ušt8_t
*)
o
->
±r
è+ 
HLL_HDR_SIZE
;

661 
’d
 = 
p
 + 
	`sd¦’
(
o
->
±r
è- 
HLL_HDR_SIZE
;

663 
fœ¡
 = 0;

664 
´ev
 = 
NULL
;

665 
Ãxt
 = 
NULL
;

666 
¥ª
 = 0;

667 
p
 < 
’d
) {

668 
İËn
;

675 
İËn
 = 1;

676 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

677 
¥ª
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

678 } ià(
	`HLL_SPARSE_IS_VAL
(
p
)) {

679 
¥ª
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

681 
¥ª
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

682 
İËn
 = 2;

685 ià(
šdex
 <ğ
fœ¡
+
¥ª
-1) ;

686 
´ev
 = 
p
;

687 
p
 +ğ
İËn
;

688 
fœ¡
 +ğ
¥ª
;

690 ià(
¥ª
 == 0)  -1;

692 
Ãxt
 = 
	`HLL_SPARSE_IS_XZERO
(
p
) ?…+2 :…+1;

693 ià(
Ãxt
 >ğ
’d
èÃxˆğ
NULL
;

698 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

699 
is_z”o
 = 1;

700 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

701 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

702 
is_xz”o
 = 1;

703 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

705 
is_v®
 = 1;

706 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

730 ià(
is_v®
) {

731 
ŞdcouÁ
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

733 ià(
ŞdcouÁ
 >ğ
couÁ
)  0;

736 ià(
ruÆ’
 == 1) {

737 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

738 
upd©ed
;

744 ià(
is_z”o
 && 
ruÆ’
 == 1) {

745 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

746 
upd©ed
;

764 
ušt8_t
 
£q
[5], *
n
 = seq;

765 
Ï¡
 = 
fœ¡
+
¥ª
-1;

766 
Ën
;

768 ià(
is_z”o
 || 
is_xz”o
) {

770 ià(
šdex
 !ğ
fœ¡
) {

771 
Ën
 = 
šdex
-
fœ¡
;

772 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

773 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

774 
n
 += 2;

776 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

777 
n
++;

780 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

781 
n
++;

782 ià(
šdex
 !ğ
Ï¡
) {

783 
Ën
 = 
Ï¡
-
šdex
;

784 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

785 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

786 
n
 += 2;

788 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

789 
n
++;

794 
curv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

796 ià(
šdex
 !ğ
fœ¡
) {

797 
Ën
 = 
šdex
-
fœ¡
;

798 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

799 
n
++;

801 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

802 
n
++;

803 ià(
šdex
 !ğ
Ï¡
) {

804 
Ën
 = 
Ï¡
-
šdex
;

805 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

806 
n
++;

814 
£qËn
 = 
n
-
£q
;

815 
ŞdËn
 = 
is_xz”o
 ? 2 : 1;

816 
d–Ën
 = 
£qËn
-
ŞdËn
;

818 ià(
d–Ën
 > 0 &&

819 
	`sd¦’
(
o
->
±r
)+
d–Ën
 > 
£rv”
.
hÎ_¥¬£_max_by‹s
è
´omÙe
;

820 ià(
d–Ën
 && 
Ãxt
è
	`memmove
Òext+d–Ën,Ãxt,
’d
-next);

821 
	`sdsInüL’
(
o
->
±r
,
d–Ën
);

822 
	`memıy
(
p
,
£q
,
£qËn
);

823 
’d
 +ğ
d–Ën
;

825 
upd©ed
:

831 
p
 = 
´ev
 ?…»v : 
¥¬£
;

832 
sÿÆ’
 = 5;

833 
p
 < 
’d
 && 
sÿÆ’
--) {

834 ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

835 
p
 += 2;

837 } ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

838 
p
++;

843 ià(
p
+1 < 
’d
 && 
	`HLL_SPARSE_IS_VAL
(p+1)) {

844 
v1
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

845 
v2
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
+1);

846 ià(
v1
 =ğ
v2
) {

847 
Ën
 = 
	`HLL_SPARSE_VAL_LEN
(
p
)+HLL_SPARSE_VAL_LEN(p+1);

848 ià(
Ën
 <ğ
HLL_SPARSE_VAL_MAX_LEN
) {

849 
	`HLL_SPARSE_VAL_SET
(
p
+1,
v1
,
Ën
);

850 
	`memmove
(
p
,p+1,
’d
-p);

851 
	`sdsInüL’
(
o
->
±r
,-1);

852 
’d
--;

860 
p
++;

864 
hdr
 = 
o
->
±r
;

865 
	`HLL_INVALIDATE_CACHE
(
hdr
);

868 
´omÙe
:

869 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
)  -1;

870 
hdr
 = 
o
->
±r
;

879 
d’£_»tv®
 = 
	`hÎD’£Add
(
hdr
->
»gi¡”s
, 
–e
, 
–esize
);

880 
	`£rv”As£¹
(
d’£_»tv®
 == 1);

881  
d’£_»tv®
;

882 
	}
}

888 
	$hÎS·r£Sum
(
ušt8_t
 *
¥¬£
, 
¥¬£Ën
, *
PE
, *
ezp
, *
šv®id
) {

889 
E
 = 0;

890 
ez
 = 0, 
idx
 = 0, 
ruÆ’
, 
»gv®
;

891 
ušt8_t
 *
’d
 = 
¥¬£
+
¥¬£Ën
, *
p
 = sparse;

893 
p
 < 
’d
) {

894 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

895 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

896 
idx
 +ğ
ruÆ’
;

897 
ez
 +ğ
ruÆ’
;

899 
p
++;

900 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

901 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

902 
idx
 +ğ
ruÆ’
;

903 
ez
 +ğ
ruÆ’
;

905 
p
 += 2;

907 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

908 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

909 
idx
 +ğ
ruÆ’
;

910 
E
 +ğ
PE
[
»gv®
]*
ruÆ’
;

911 
p
++;

914 ià(
idx
 !ğ
HLL_REGISTERS
 && 
šv®id
) *invalid = 1;

915 
E
 +ğ
ez
;

916 *
ezp
 = 
ez
;

917  
E
;

918 
	}
}

928 
	$hÎRawSum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

929 
E
 = 0;

930 
j
, 
ez
 = 0;

931 
ušt64_t
 *
wÜd
 = (ušt64_t*è
»gi¡”s
;

932 
ušt8_t
 *
by‹s
;

934 
j
 = 0; j < 
HLL_REGISTERS
/8; j++) {

935 ià(*
wÜd
 == 0) {

936 
ez
 += 8;

938 
by‹s
 = (
ušt8_t
*è
wÜd
;

939 ià(
by‹s
[0]è
E
 +ğ
PE
[by‹s[0]]; 
ez
++;

940 ià(
by‹s
[1]è
E
 +ğ
PE
[by‹s[1]]; 
ez
++;

941 ià(
by‹s
[2]è
E
 +ğ
PE
[by‹s[2]]; 
ez
++;

942 ià(
by‹s
[3]è
E
 +ğ
PE
[by‹s[3]]; 
ez
++;

943 ià(
by‹s
[4]è
E
 +ğ
PE
[by‹s[4]]; 
ez
++;

944 ià(
by‹s
[5]è
E
 +ğ
PE
[by‹s[5]]; 
ez
++;

945 ià(
by‹s
[6]è
E
 +ğ
PE
[by‹s[6]]; 
ez
++;

946 ià(
by‹s
[7]è
E
 +ğ
PE
[by‹s[7]]; 
ez
++;

948 
wÜd
++;

950 
E
 +ğ
ez
;

952 *
ezp
 = 
ez
;

953  
E
;

954 
	}
}

967 
ušt64_t
 
	$hÎCouÁ
(
hÎhdr
 *
hdr
, *
šv®id
) {

968 
m
 = 
HLL_REGISTERS
;

969 
E
, 
®pha
 = 0.7213/(1+1.079/
m
);

970 
j
, 
ez
;

974 
š™Ÿlized
 = 0;

975 
PE
[64];

976 ià(!
š™Ÿlized
) {

977 
PE
[0] = 1;

978 
j
 = 1; j < 64; j++) {

980 
PE
[
j
] = 1.0/(1ULL << j);

982 
š™Ÿlized
 = 1;

986 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

987 
E
 = 
	`hÎD’£Sum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

988 } ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

989 
E
 = 
	`hÎS·r£Sum
(
hdr
->
»gi¡”s
,

990 
	`sd¦’
((
sds
)
hdr
)-
HLL_HDR_SIZE
,
PE
,&
ez
,
šv®id
);

991 } ià(
hdr
->
’codšg
 =ğ
HLL_RAW
) {

992 
E
 = 
	`hÎRawSum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

994 
	`£rv”Pªic
("Unknown HyperLogLogƒncoding in hllCount()");

998 
E
 = (1/E)*
®pha
*
m
*m;

1005 ià(
E
 < 
m
*2.5 && 
ez
 != 0) {

1006 
E
 = 
m
*
	`log
(m/
ez
);

1007 } ià(
m
 =ğ16384 && 
E
 < 72000) {

1012 
bŸs
 = 5.9119*1.0e-18*(
E
*E*E*E)

1013 -1.4253*1.0e-12*(
E
*E*E)+

1014 1.2940*1.0e-7*(
E
*E)

1015 -5.2921*1.0e-3*
E
+

1017 
E
 -ğE*(
bŸs
/100);

1023  (
ušt64_t
è
E
;

1024 
	}
}

1027 
	$hÎAdd
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

1028 
hÎhdr
 *
hdr
 = 
o
->
±r
;

1029 
hdr
->
’codšg
) {

1030 
HLL_DENSE
:  
	`hÎD’£Add
(
hdr
->
»gi¡”s
,
–e
,
–esize
);

1031 
HLL_SPARSE
:  
	`hÎS·r£Add
(
o
,
–e
,
–esize
);

1034 
	}
}

1044 
	$hÎM”ge
(
ušt8_t
 *
max
, 
robj
 *
hÎ
) {

1045 
hÎhdr
 *
hdr
 = 
hÎ
->
±r
;

1046 
i
;

1048 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

1049 
ušt8_t
 
v®
;

1051 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1052 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1053 ià(
v®
 > 
max
[
i
]) max[i] = val;

1056 
ušt8_t
 *
p
 = 
hÎ
->
±r
, *
’d
 =… + 
	`sd¦’
(hll->ptr);

1057 
ruÆ’
, 
»gv®
;

1059 
p
 +ğ
HLL_HDR_SIZE
;

1060 
i
 = 0;

1061 
p
 < 
’d
) {

1062 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1063 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1064 
i
 +ğ
ruÆ’
;

1065 
p
++;

1066 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1067 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1068 
i
 +ğ
ruÆ’
;

1069 
p
 += 2;

1071 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1072 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1073 
ruÆ’
--) {

1074 ià(
»gv®
 > 
max
[
i
]) max[i] =„egval;

1075 
i
++;

1077 
p
++;

1080 ià(
i
 !ğ
HLL_REGISTERS
è 
C_ERR
;

1082  
C_OK
;

1083 
	}
}

1089 
robj
 *
	$ü—‹HLLObjeù
() {

1090 
robj
 *
o
;

1091 
hÎhdr
 *
hdr
;

1092 
sds
 
s
;

1093 
ušt8_t
 *
p
;

1094 
¥¬£Ën
 = 
HLL_HDR_SIZE
 +

1095 (((
HLL_REGISTERS
+(
HLL_SPARSE_XZERO_MAX_LEN
-1)) /

1096 
HLL_SPARSE_XZERO_MAX_LEN
)*2);

1097 
aux
;

1101 
aux
 = 
HLL_REGISTERS
;

1102 
s
 = 
	`sd¢ewËn
(
NULL
,
¥¬£Ën
);

1103 
p
 = (
ušt8_t
*)
s
 + 
HLL_HDR_SIZE
;

1104 
aux
) {

1105 
xz”o
 = 
HLL_SPARSE_XZERO_MAX_LEN
;

1106 ià(
xz”o
 > 
aux
) xzero =‡ux;

1107 
	`HLL_SPARSE_XZERO_SET
(
p
,
xz”o
);

1108 
p
 += 2;

1109 
aux
 -ğ
xz”o
;

1111 
	`£rv”As£¹
((
p
-(
ušt8_t
*)
s
è=ğ
¥¬£Ën
);

1114 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

1115 
hdr
 = 
o
->
±r
;

1116 
	`memıy
(
hdr
->
magic
,"HYLL",4);

1117 
hdr
->
’codšg
 = 
HLL_SPARSE
;

1118  
o
;

1119 
	}
}

1124 
	$isHLLObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
) {

1125 
hÎhdr
 *
hdr
;

1128 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

1129  
C_ERR
;

1131 ià(
	`¡ršgObjeùL’
(
o
è< (*
hdr
)è
šv®id
;

1132 
hdr
 = 
o
->
±r
;

1135 ià(
hdr
->
magic
[0] != 'H' || hdr->magic[1] != 'Y' ||

1136 
hdr
->
magic
[2] !ğ'L' || hdr->magic[3] !ğ'L'è
šv®id
;

1138 ià(
hdr
->
’codšg
 > 
HLL_MAX_ENCODING
è
šv®id
;

1141 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
 &&

1142 
	`¡ršgObjeùL’
(
o
è!ğ
HLL_DENSE_SIZE
è
šv®id
;

1145  
C_OK
;

1147 
šv®id
:

1148 
	`addR•lySds
(
c
,

1149 
	`sd¢ew
("-WRONGTYPE Key is‚ot‡ valid "

1151  
C_ERR
;

1152 
	}
}

1155 
	$pçddCommªd
(
ş›Á
 *
c
) {

1156 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1157 
hÎhdr
 *
hdr
;

1158 
upd©ed
 = 0, 
j
;

1160 ià(
o
 =ğ
NULL
) {

1164 
o
 = 
	`ü—‹HLLObjeù
();

1165 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1166 
upd©ed
++;

1168 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1169 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1172 
j
 = 2; j < 
c
->
¬gc
; j++) {

1173 
»tv®
 = 
	`hÎAdd
(
o
, (*)
c
->
¬gv
[
j
]->
±r
,

1174 
	`sd¦’
(
c
->
¬gv
[
j
]->
±r
));

1175 
»tv®
) {

1177 
upd©ed
++;

1180 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1184 
hdr
 = 
o
->
±r
;

1185 ià(
upd©ed
) {

1186 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1187 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1188 
£rv”
.
dœty
++;

1189 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1191 
	`addR•ly
(
c
, 
upd©ed
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1192 
	}
}

1195 
	$pfcouÁCommªd
(
ş›Á
 *
c
) {

1196 
robj
 *
o
;

1197 
hÎhdr
 *
hdr
;

1198 
ušt64_t
 
ÿrd
;

1204 ià(
c
->
¬gc
 > 2) {

1205 
ušt8_t
 
max
[
HLL_HDR_SIZE
+
HLL_REGISTERS
], *
»gi¡”s
;

1206 
j
;

1209 
	`mem£t
(
max
,0,(max));

1210 
hdr
 = (
hÎhdr
*è
max
;

1211 
hdr
->
’codšg
 = 
HLL_RAW
;

1212 
»gi¡”s
 = 
max
 + 
HLL_HDR_SIZE
;

1213 
j
 = 1; j < 
c
->
¬gc
; j++) {

1215 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1216 ià(
o
 =ğ
NULL
) ;

1217 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1221 ià(
	`hÎM”ge
(
»gi¡”s
,
o
è=ğ
C_ERR
) {

1222 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1228 
	`addR•lyLÚgLÚg
(
c
,
	`hÎCouÁ
(
hdr
,
NULL
));

1236 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1237 ià(
o
 =ğ
NULL
) {

1240 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1242 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1243 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1246 
hdr
 = 
o
->
±r
;

1247 ià(
	`HLL_VALID_CACHE
(
hdr
)) {

1249 
ÿrd
 = (
ušt64_t
)
hdr
->card[0];

1250 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[1] << 8;

1251 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[2] << 16;

1252 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[3] << 24;

1253 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[4] << 32;

1254 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[5] << 40;

1255 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[6] << 48;

1256 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[7] << 56;

1258 
šv®id
 = 0;

1260 
ÿrd
 = 
	`hÎCouÁ
(
hdr
,&
šv®id
);

1261 ià(
šv®id
) {

1262 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1265 
hdr
->
ÿrd
[0] = card & 0xff;

1266 
hdr
->
ÿrd
[1] = (card >> 8) & 0xff;

1267 
hdr
->
ÿrd
[2] = (card >> 16) & 0xff;

1268 
hdr
->
ÿrd
[3] = (card >> 24) & 0xff;

1269 
hdr
->
ÿrd
[4] = (card >> 32) & 0xff;

1270 
hdr
->
ÿrd
[5] = (card >> 40) & 0xff;

1271 
hdr
->
ÿrd
[6] = (card >> 48) & 0xff;

1272 
hdr
->
ÿrd
[7] = (card >> 56) & 0xff;

1277 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1278 
£rv”
.
dœty
++;

1280 
	`addR•lyLÚgLÚg
(
c
,
ÿrd
);

1282 
	}
}

1285 
	$pfm”geCommªd
(
ş›Á
 *
c
) {

1286 
ušt8_t
 
max
[
HLL_REGISTERS
];

1287 
hÎhdr
 *
hdr
;

1288 
j
;

1293 
	`mem£t
(
max
,0,(max));

1294 
j
 = 1; j < 
c
->
¬gc
; j++) {

1296 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1297 ià(
o
 =ğ
NULL
) ;

1298 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1302 ià(
	`hÎM”ge
(
max
,
o
è=ğ
C_ERR
) {

1303 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1309 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1310 ià(
o
 =ğ
NULL
) {

1314 
o
 = 
	`ü—‹HLLObjeù
();

1315 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1320 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1324 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
) {

1325 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1331 
hdr
 = 
o
->
±r
;

1332 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1333 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
j
,
max
[j]);

1335 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1337 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1340 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1341 
£rv”
.
dœty
++;

1342 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1343 
	}
}

1350 
	#HLL_TEST_CYCLES
 1000

	)

1351 
	$pf£láe¡Commªd
(
ş›Á
 *
c
) {

1352 
j
, 
i
;

1353 
sds
 
b™couÁ”s
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

1354 
hÎhdr
 *
hdr
 = (hÎhdr*è
b™couÁ”s
, *
hdr2
;

1355 
robj
 *
o
 = 
NULL
;

1356 
ušt8_t
 
by‹couÁ”s
[
HLL_REGISTERS
];

1362 
j
 = 0; j < 
HLL_TEST_CYCLES
; j++) {

1365 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1366 
r
 = 
	`¿nd
(è& 
HLL_REGISTER_MAX
;

1368 
by‹couÁ”s
[
i
] = 
r
;

1369 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
i
,
r
);

1372 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1373 
v®
;

1375 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1376 ià(
v®
 !ğ
by‹couÁ”s
[
i
]) {

1377 
	`addR•lyE¼ÜFÜm©
(
c
,

1379 
i
, (è
by‹couÁ”s
[i], (è
v®
);

1380 
ş—nup
;

1395 
	`mem£t
(
hdr
->
»gi¡”s
,0,
HLL_DENSE_SIZE
-
HLL_HDR_SIZE
);

1396 
o
 = 
	`ü—‹HLLObjeù
();

1397 
»Ë¼
 = 1.04/
	`sq¹
(
HLL_REGISTERS
);

1398 
št64_t
 
checkpošt
 = 1;

1399 
ušt64_t
 
£ed
 = (ušt64_t)
	`¿nd
() | (uint64_t)rand() << 32;

1400 
ušt64_t
 
–e
;

1401 
j
 = 1; j <= 10000000; j++) {

1402 
–e
 = 
j
 ^ 
£ed
;

1403 
	`hÎD’£Add
(
hdr
->
»gi¡”s
,(*)&
–e
,(ele));

1404 
	`hÎAdd
(
o
,(*)&
–e
,(ele));

1408 ià(
j
 =ğ
checkpošt
 && j < 
£rv”
.
hÎ_¥¬£_max_by‹s
/2) {

1409 
hdr2
 = 
o
->
±r
;

1410 ià(
hdr2
->
’codšg
 !ğ
HLL_SPARSE
) {

1411 
	`addR•lyE¼Ü
(
c
, "TESTFAILED sparseƒncoding‚ot used");

1412 
ş—nup
;

1417 ià(
j
 =ğ
checkpošt
 && 
	`hÎCouÁ
(
hdr
,
NULL
è!ğhÎCouÁ(
o
->
±r
,NULL)) {

1418 
	`addR•lyE¼Ü
(
c
, "TESTFAILED dense/sparse disagree");

1419 
ş—nup
;

1423 ià(
j
 =ğ
checkpošt
) {

1424 
št64_t
 
ab£¼
 = 
checkpošt
 - (št64_t)
	`hÎCouÁ
(
hdr
,
NULL
);

1425 
ušt64_t
 
max”r
 = 
	`û
(
»Ë¼
*6*
checkpošt
);

1431 ià(
j
 =ğ10è
max”r
 = 1;

1433 ià(
ab£¼
 < 0)‡bserr = -abserr;

1434 ià(
ab£¼
 > (
št64_t
)
max”r
) {

1435 
	`addR•lyE¼ÜFÜm©
(
c
,

1437 (è
checkpošt
,

1438 (è
ab£¼
);

1439 
ş—nup
;

1441 
checkpošt
 *= 10;

1446 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1448 
ş—nup
:

1449 
	`sdsä“
(
b™couÁ”s
);

1450 ià(
o
è
	`deüRefCouÁ
(o);

1451 
	}
}

1455 
	$pfdebugCommªd
(
ş›Á
 *
c
) {

1456 *
cmd
 = 
c
->
¬gv
[1]->
±r
;

1457 
hÎhdr
 *
hdr
;

1458 
robj
 *
o
;

1459 
j
;

1461 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

1462 ià(
o
 =ğ
NULL
) {

1463 
	`addR•lyE¼Ü
(
c
,"The specified key does‚otƒxist");

1466 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1467 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[2],o);

1468 
hdr
 = 
o
->
±r
;

1471 ià(!
	`¡rÿ£cmp
(
cmd
,"getreg")) {

1472 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1474 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1475 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
) {

1476 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1479 
£rv”
.
dœty
++;

1482 
hdr
 = 
o
->
±r
;

1483 
	`addR•lyMuÉiBulkL’
(
c
,
HLL_REGISTERS
);

1484 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1485 
ušt8_t
 
v®
;

1487 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
j
);

1488 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1492 ià(!
	`¡rÿ£cmp
(
cmd
,"decode")) {

1493 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1495 
ušt8_t
 *
p
 = 
o
->
±r
, *
’d
 =…+
	`sd¦’
(o->ptr);

1496 
sds
 
decoded
 = 
	`sd£m±y
();

1498 ià(
hdr
->
’codšg
 !ğ
HLL_SPARSE
) {

1499 
	`addR•lyE¼Ü
(
c
,"HLLƒncoding is‚ot sparse");

1503 
p
 +ğ
HLL_HDR_SIZE
;

1504 
p
 < 
’d
) {

1505 
ruÆ’
, 
»gv®
;

1507 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1508 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1509 
p
++;

1510 
decoded
 = 
	`sdsÿrštf
(decoded,"z:%d ",
ruÆ’
);

1511 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1512 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1513 
p
 += 2;

1514 
decoded
 = 
	`sdsÿrštf
(decoded,"Z:%d ",
ruÆ’
);

1516 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1517 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1518 
p
++;

1519 
decoded
 = 
	`sdsÿrštf
(decoded,"v:%d,%d ",
»gv®
,
ruÆ’
);

1522 
decoded
 = 
	`sd¡rim
(decoded," ");

1523 
	`addR•lyBulkCBufãr
(
c
,
decoded
,
	`sd¦’
(decoded));

1524 
	`sdsä“
(
decoded
);

1527 ià(!
	`¡rÿ£cmp
(
cmd
,"encoding")) {

1528 *
’codšg¡r
[2] = {"dense","sparse"};

1529 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1531 
	`addR•lyStus
(
c
,
’codšg¡r
[
hdr
->
’codšg
]);

1534 ià(!
	`¡rÿ£cmp
(
cmd
,"todense")) {

1535 
cÚv
 = 0;

1536 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1538 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1539 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
) {

1540 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1543 
cÚv
 = 1;

1544 
£rv”
.
dœty
++;

1546 
	`addR•ly
(
c
,
cÚv
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1548 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀPFDEBUG subcommªd '%s'", 
cmd
);

1552 
¬™y”r
:

1553 
	`addR•lyE¼ÜFÜm©
(
c
,

1554 "WrÚg‚umb” oà¬gum’t fÜh'%s' subcommªd",
cmd
);

1555 
	}
}

	@intset.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡ršg.h
>

34 
	~"št£t.h
"

35 
	~"zm®loc.h
"

36 
	~"’dŸncÚv.h
"

40 
	#INTSET_ENC_INT16
 ((
št16_t
))

	)

41 
	#INTSET_ENC_INT32
 ((
št32_t
))

	)

42 
	#INTSET_ENC_INT64
 ((
št64_t
))

	)

45 
ušt8_t
 
	$_št£tV®ueEncodšg
(
št64_t
 
v
) {

46 ià(
v
 < 
INT32_MIN
 || v > 
INT32_MAX
)

47  
INTSET_ENC_INT64
;

48 ià(
v
 < 
INT16_MIN
 || v > 
INT16_MAX
)

49  
INTSET_ENC_INT32
;

51  
INTSET_ENC_INT16
;

52 
	}
}

55 
št64_t
 
	$_št£tG‘Encoded
(
št£t
 *
is
, 
pos
, 
ušt8_t
 
’c
) {

56 
št64_t
 
v64
;

57 
št32_t
 
v32
;

58 
št16_t
 
v16
;

60 ià(
’c
 =ğ
INTSET_ENC_INT64
) {

61 
	`memıy
(&
v64
,((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
,(v64));

62 
	`mem»v64ifbe
(&
v64
);

63  
v64
;

64 } ià(
’c
 =ğ
INTSET_ENC_INT32
) {

65 
	`memıy
(&
v32
,((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
,(v32));

66 
	`mem»v32ifbe
(&
v32
);

67  
v32
;

69 
	`memıy
(&
v16
,((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
,(v16));

70 
	`mem»v16ifbe
(&
v16
);

71  
v16
;

73 
	}
}

76 
št64_t
 
	$_št£tG‘
(
št£t
 *
is
, 
pos
) {

77  
	`_št£tG‘Encoded
(
is
,
pos
,
	`šŒev32ifbe
(is->
’codšg
));

78 
	}
}

81 
	$_št£tS‘
(
št£t
 *
is
, 
pos
, 
št64_t
 
v®ue
) {

82 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

84 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

85 ((
št64_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

86 
	`mem»v64ifbe
(((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
);

87 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

88 ((
št32_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

89 
	`mem»v32ifbe
(((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
);

91 ((
št16_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

92 
	`mem»v16ifbe
(((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
);

94 
	}
}

97 
št£t
 *
	$št£tNew
() {

98 
št£t
 *
is
 = 
	`zm®loc
((intset));

99 
is
->
’codšg
 = 
	`šŒev32ifbe
(
INTSET_ENC_INT16
);

100 
is
->
Ëngth
 = 0;

101  
is
;

102 
	}
}

105 
št£t
 *
	$št£tResize
(
št£t
 *
is
, 
ušt32_t
 
Ën
) {

106 
ušt32_t
 
size
 = 
Ën
*
	`šŒev32ifbe
(
is
->
’codšg
);

107 
is
 = 
	`z»®loc
(is,(
št£t
)+
size
);

108  
is
;

109 
	}
}

115 
ušt8_t
 
	$št£tS—rch
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt32_t
 *
pos
) {

116 
mš
 = 0, 
max
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-1, 
mid
 = -1;

117 
št64_t
 
cur
 = -1;

120 ià(
	`šŒev32ifbe
(
is
->
Ëngth
) == 0) {

121 ià(
pos
) *pos = 0;

126 ià(
v®ue
 > 
	`_št£tG‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
)-1)) {

127 ià(
pos
è*po ğ
	`šŒev32ifbe
(
is
->
Ëngth
);

129 } ià(
v®ue
 < 
	`_št£tG‘
(
is
,0)) {

130 ià(
pos
) *pos = 0;

135 
max
 >ğ
mš
) {

136 
mid
 = (()
mš
 + ()
max
) >> 1;

137 
cur
 = 
	`_št£tG‘
(
is
,
mid
);

138 ià(
v®ue
 > 
cur
) {

139 
mš
 = 
mid
+1;

140 } ià(
v®ue
 < 
cur
) {

141 
max
 = 
mid
-1;

147 ià(
v®ue
 =ğ
cur
) {

148 ià(
pos
è*po ğ
mid
;

151 ià(
pos
è*po ğ
mš
;

154 
	}
}

157 
št£t
 *
	$št£tUpg¿deAndAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

158 
ušt8_t
 
cu»nc
 = 
	`šŒev32ifbe
(
is
->
’codšg
);

159 
ušt8_t
 
Ãw’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

160 
Ëngth
 = 
	`šŒev32ifbe
(
is
->length);

161 
´•’d
 = 
v®ue
 < 0 ? 1 : 0;

164 
is
->
’codšg
 = 
	`šŒev32ifbe
(
Ãw’c
);

165 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

170 
Ëngth
--)

171 
	`_št£tS‘
(
is
,
Ëngth
+
´•’d
,
	`_št£tG‘Encoded
(is,Ëngth,
cu»nc
));

174 ià(
´•’d
)

175 
	`_št£tS‘
(
is
,0,
v®ue
);

177 
	`_št£tS‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
),
v®ue
);

178 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

179  
is
;

180 
	}
}

182 
	$št£tMoveTa
(
št£t
 *
is
, 
ušt32_t
 
äom
, ušt32_ˆ
to
) {

183 *
¤c
, *
d¡
;

184 
ušt32_t
 
by‹s
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-
äom
;

185 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

187 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

188 
¤c
 = (
št64_t
*)
is
->
cÚ‹Ás
+
äom
;

189 
d¡
 = (
št64_t
*)
is
->
cÚ‹Ás
+
to
;

190 
by‹s
 *ğ(
št64_t
);

191 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

192 
¤c
 = (
št32_t
*)
is
->
cÚ‹Ás
+
äom
;

193 
d¡
 = (
št32_t
*)
is
->
cÚ‹Ás
+
to
;

194 
by‹s
 *ğ(
št32_t
);

196 
¤c
 = (
št16_t
*)
is
->
cÚ‹Ás
+
äom
;

197 
d¡
 = (
št16_t
*)
is
->
cÚ‹Ás
+
to
;

198 
by‹s
 *ğ(
št16_t
);

200 
	`memmove
(
d¡
,
¤c
,
by‹s
);

201 
	}
}

204 
št£t
 *
	$št£tAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
) {

205 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

206 
ušt32_t
 
pos
;

207 ià(
sucûss
) *success = 1;

212 ià(
v®’c
 > 
	`šŒev32ifbe
(
is
->
’codšg
)) {

214  
	`št£tUpg¿deAndAdd
(
is
,
v®ue
);

219 ià(
	`št£tS—rch
(
is
,
v®ue
,&
pos
)) {

220 ià(
sucûss
) *success = 0;

221  
is
;

224 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

225 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)è
	`št£tMoveTa
(is,pos,pos+1);

228 
	`_št£tS‘
(
is
,
pos
,
v®ue
);

229 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

230  
is
;

231 
	}
}

234 
št£t
 *
	$št£tRemove
(
št£t
 *
is
, 
št64_t
 
v®ue
, *
sucûss
) {

235 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

236 
ušt32_t
 
pos
;

237 ià(
sucûss
) *success = 0;

239 ià(
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,&
pos
)) {

240 
ušt32_t
 
Ën
 = 
	`šŒev32ifbe
(
is
->
Ëngth
);

243 ià(
sucûss
) *success = 1;

246 ià(
pos
 < (
Ën
-1)è
	`št£tMoveTa
(
is
,pos+1,pos);

247 
is
 = 
	`št£tResize
(is,
Ën
-1);

248 
is
->
Ëngth
 = 
	`šŒev32ifbe
(
Ën
-1);

250  
is
;

251 
	}
}

254 
ušt8_t
 
	$št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

255 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

256  
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,
NULL
);

257 
	}
}

260 
št64_t
 
	$št£tRªdom
(
št£t
 *
is
) {

261  
	`_št£tG‘
(
is
,
	`¿nd
()%
	`šŒev32ifbe
(is->
Ëngth
));

262 
	}
}

266 
ušt8_t
 
	$št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
) {

267 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)) {

268 *
v®ue
 = 
	`_št£tG‘
(
is
,
pos
);

272 
	}
}

275 
ušt32_t
 
	$št£tL’
(cÚ¡ 
št£t
 *
is
) {

276  
	`šŒev32ifbe
(
is
->
Ëngth
);

277 
	}
}

280 
size_t
 
	$št£tBlobL’
(
št£t
 *
is
) {

281  (
št£t
)+
	`šŒev32ifbe
(
is
->
Ëngth
)*šŒev32ifbe(is->
’codšg
);

282 
	}
}

284 #ifdeà
REDIS_TEST


285 
	~<sys/time.h
>

286 
	~<time.h
>

289 
	$št£tR•r
(
št£t
 *
is
) {

290 
ušt32_t
 
i
 = 0; i < 
	`šŒev32ifbe
(
is
->
Ëngth
); i++) {

291 
	`´štf
("%Îd\n", (
ušt64_t
)
	`_št£tG‘
(
is
,
i
));

293 
	`´štf
("\n");

294 
	}
}

296 
	$”rÜ
(*
”r
) {

297 
	`´štf
("%s\n", 
”r
);

298 
	`ex™
(1);

299 
	}
}

302 
	$ok
() {

303 
	`´štf
("OK\n");

304 
	}
}

306 
	$u£c
() {

307 
timev®
 
tv
;

308 
	`g‘timeofday
(&
tv
,
NULL
);

309  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

310 
	}
}

312 
	#as£¹
(
_e
è((_e)?()0:(
	`_as£¹
(#_e,
__FILE__
,
__LINE__
),
	`ex™
(1)))

	)

313 
	$_as£¹
(*
e¡r
, *
fe
, 
lše
) {

314 
	`´štf
("\n\n=== ASSERTION FAILED ===\n");

315 
	`´štf
("==> %s:%d '%s' i nÙrue\n",
fe
,
lše
,
e¡r
);

316 
	}
}

318 
št£t
 *
	$ü—‹S‘
(
b™s
, 
size
) {

319 
ušt64_t
 
mask
 = (1<<
b™s
)-1;

320 
ušt64_t
 
v®ue
;

321 
št£t
 *
is
 = 
	`št£tNew
();

323 
i
 = 0; i < 
size
; i++) {

324 ià(
b™s
 > 32) {

325 
v®ue
 = (
	`¿nd
()*¿nd()è& 
mask
;

327 
v®ue
 = 
	`¿nd
(è& 
mask
;

329 
is
 = 
	`št£tAdd
(is,
v®ue
,
NULL
);

331  
is
;

332 
	}
}

334 
	$checkCÚsi¡’cy
(
št£t
 *
is
) {

335 
ušt32_t
 
i
 = 0; i < (
	`šŒev32ifbe
(
is
->
Ëngth
)-1); i++) {

336 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

338 ià(
’codšg
 =ğ
INTSET_ENC_INT16
) {

339 
št16_t
 *
i16
 = (št16_t*)
is
->
cÚ‹Ás
;

340 
	`as£¹
(
i16
[
i
] < i16[i+1]);

341 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

342 
št32_t
 *
i32
 = (št32_t*)
is
->
cÚ‹Ás
;

343 
	`as£¹
(
i32
[
i
] < i32[i+1]);

345 
št64_t
 *
i64
 = (št64_t*)
is
->
cÚ‹Ás
;

346 
	`as£¹
(
i64
[
i
] < i64[i+1]);

349 
	}
}

351 
	#UNUSED
(
x
è()(x)

	)

352 
	$št£tTe¡
(
¬gc
, **
¬gv
) {

353 
ušt8_t
 
sucûss
;

354 
i
;

355 
št£t
 *
is
;

356 
	`¤ªd
(
	`time
(
NULL
));

358 
	`UNUSED
(
¬gc
);

359 
	`UNUSED
(
¬gv
);

361 
	`´štf
("Valueƒncodings: "); {

362 
	`as£¹
(
	`_št£tV®ueEncodšg
(-32768è=ğ
INTSET_ENC_INT16
);

363 
	`as£¹
(
	`_št£tV®ueEncodšg
(+32767è=ğ
INTSET_ENC_INT16
);

364 
	`as£¹
(
	`_št£tV®ueEncodšg
(-32769è=ğ
INTSET_ENC_INT32
);

365 
	`as£¹
(
	`_št£tV®ueEncodšg
(+32768è=ğ
INTSET_ENC_INT32
);

366 
	`as£¹
(
	`_št£tV®ueEncodšg
(-2147483648è=ğ
INTSET_ENC_INT32
);

367 
	`as£¹
(
	`_št£tV®ueEncodšg
(+2147483647è=ğ
INTSET_ENC_INT32
);

368 
	`as£¹
(
	`_št£tV®ueEncodšg
(-2147483649è=ğ
INTSET_ENC_INT64
);

369 
	`as£¹
(
	`_št£tV®ueEncodšg
(+2147483648è=ğ
INTSET_ENC_INT64
);

370 
	`as£¹
(
	`_št£tV®ueEncodšg
(-9223372036854775808ull) ==

371 
INTSET_ENC_INT64
);

372 
	`as£¹
(
	`_št£tV®ueEncodšg
(+9223372036854775807ull) ==

373 
INTSET_ENC_INT64
);

374 
	`ok
();

377 
	`´štf
("Basic‡dding: "); {

378 
is
 = 
	`št£tNew
();

379 
is
 = 
	`št£tAdd
(is,5,&
sucûss
); 
	`as£¹
(success);

380 
is
 = 
	`št£tAdd
(is,6,&
sucûss
); 
	`as£¹
(success);

381 
is
 = 
	`št£tAdd
(is,4,&
sucûss
); 
	`as£¹
(success);

382 
is
 = 
	`št£tAdd
(is,4,&
sucûss
); 
	`as£¹
(!success);

383 
	`ok
();

386 
	`´štf
("Large‚umber of„andom‡dds: "); {

387 
ušt32_t
 
š£¹s
 = 0;

388 
is
 = 
	`št£tNew
();

389 
i
 = 0; i < 1024; i++) {

390 
is
 = 
	`št£tAdd
(is,
	`¿nd
()%0x800,&
sucûss
);

391 ià(
sucûss
è
š£¹s
++;

393 
	`as£¹
(
	`šŒev32ifbe
(
is
->
Ëngth
è=ğ
š£¹s
);

394 
	`checkCÚsi¡’cy
(
is
);

395 
	`ok
();

398 
	`´štf
("Upgrade from int16o int32: "); {

399 
is
 = 
	`št£tNew
();

400 
is
 = 
	`št£tAdd
(is,32,
NULL
);

401 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

402 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

403 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

404 
	`as£¹
(
	`št£tFšd
(
is
,32));

405 
	`as£¹
(
	`št£tFšd
(
is
,65535));

406 
	`checkCÚsi¡’cy
(
is
);

408 
is
 = 
	`št£tNew
();

409 
is
 = 
	`št£tAdd
(is,32,
NULL
);

410 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

411 
is
 = 
	`št£tAdd
(is,-65535,
NULL
);

412 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

413 
	`as£¹
(
	`št£tFšd
(
is
,32));

414 
	`as£¹
(
	`št£tFšd
(
is
,-65535));

415 
	`checkCÚsi¡’cy
(
is
);

416 
	`ok
();

419 
	`´štf
("Upgrade from int16o int64: "); {

420 
is
 = 
	`št£tNew
();

421 
is
 = 
	`št£tAdd
(is,32,
NULL
);

422 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

423 
is
 = 
	`št£tAdd
(is,4294967295,
NULL
);

424 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

425 
	`as£¹
(
	`št£tFšd
(
is
,32));

426 
	`as£¹
(
	`št£tFšd
(
is
,4294967295));

427 
	`checkCÚsi¡’cy
(
is
);

429 
is
 = 
	`št£tNew
();

430 
is
 = 
	`št£tAdd
(is,32,
NULL
);

431 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

432 
is
 = 
	`št£tAdd
(is,-4294967295,
NULL
);

433 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

434 
	`as£¹
(
	`št£tFšd
(
is
,32));

435 
	`as£¹
(
	`št£tFšd
(
is
,-4294967295));

436 
	`checkCÚsi¡’cy
(
is
);

437 
	`ok
();

440 
	`´štf
("Upgrade from int32o int64: "); {

441 
is
 = 
	`št£tNew
();

442 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

443 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

444 
is
 = 
	`št£tAdd
(is,4294967295,
NULL
);

445 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

446 
	`as£¹
(
	`št£tFšd
(
is
,65535));

447 
	`as£¹
(
	`št£tFšd
(
is
,4294967295));

448 
	`checkCÚsi¡’cy
(
is
);

450 
is
 = 
	`št£tNew
();

451 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

452 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

453 
is
 = 
	`št£tAdd
(is,-4294967295,
NULL
);

454 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

455 
	`as£¹
(
	`št£tFšd
(
is
,65535));

456 
	`as£¹
(
	`št£tFšd
(
is
,-4294967295));

457 
	`checkCÚsi¡’cy
(
is
);

458 
	`ok
();

461 
	`´štf
("Stress†ookups: "); {

462 
num
 = 100000, 
size
 = 10000;

463 
i
, 
b™s
 = 20;

464 
¡¬t
;

465 
is
 = 
	`ü—‹S‘
(
b™s
,
size
);

466 
	`checkCÚsi¡’cy
(
is
);

468 
¡¬t
 = 
	`u£c
();

469 
i
 = 0; i < 
num
; i++è
	`št£tS—rch
(
is
,
	`¿nd
(è% ((1<<
b™s
)-1),
NULL
);

470 
	`´štf
("%ld†ookups, %ldƒlement set, %lldusec\n",

471 
num
,
size
,
	`u£c
()-
¡¬t
);

474 
	`´štf
("Stress‡dd+delete: "); {

475 
i
, 
v1
, 
v2
;

476 
is
 = 
	`št£tNew
();

477 
i
 = 0; i < 0xffff; i++) {

478 
v1
 = 
	`¿nd
() % 0xfff;

479 
is
 = 
	`št£tAdd
(is,
v1
,
NULL
);

480 
	`as£¹
(
	`št£tFšd
(
is
,
v1
));

482 
v2
 = 
	`¿nd
() % 0xfff;

483 
is
 = 
	`št£tRemove
(is,
v2
,
NULL
);

484 
	`as£¹
(!
	`št£tFšd
(
is
,
v2
));

486 
	`checkCÚsi¡’cy
(
is
);

487 
	`ok
();

491 
	}
}

	@intset.h

31 #iâdeà
__INTSET_H


32 
	#__INTSET_H


	)

33 
	~<¡dšt.h
>

35 
	sšt£t
 {

36 
ušt32_t
 
	m’codšg
;

37 
ušt32_t
 
	mËngth
;

38 
št8_t
 
	mcÚ‹Ás
[];

39 } 
	tšt£t
;

41 
št£t
 *
št£tNew
();

42 
št£t
 *
št£tAdd
(št£ˆ*
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
);

43 
št£t
 *
št£tRemove
(št£ˆ*
is
, 
št64_t
 
v®ue
, *
sucûss
);

44 
ušt8_t
 
št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
);

45 
št64_t
 
št£tRªdom
(
št£t
 *
is
);

46 
ušt8_t
 
št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
);

47 
ušt32_t
 
št£tL’
(cÚ¡ 
št£t
 *
is
);

48 
size_t
 
št£tBlobL’
(
št£t
 *
is
);

50 #ifdeà
REDIS_TEST


51 
št£tTe¡
(
¬gc
, *
¬gv
[]);

	@latency.c

36 
	~"£rv”.h
"

39 
	$diùSŒšgKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

40 
	`UNUSED
(
´ivd©a
);

41  
	`¡rcmp
(
key1
,
key2
) == 0;

42 
	}
}

44 
	$diùSŒšgHash
(cÚ¡ *
key
) {

45  
	`diùG’HashFunùiÚ
(
key
, 
	`¡¾’
(key));

46 
	}
}

48 
diùVªÏF»e
(*
´ivd©a
, *
v®
);

50 
diùTy³
 
	gÏ‹ncyTimeS”›sDiùTy³
 = {

51 
diùSŒšgHash
,

52 
NULL
,

53 
NULL
,

54 
diùSŒšgKeyCom·»
,

55 
diùVªÏF»e
,

56 
diùVªÏF»e


61 #ifdeà
__lšux__


64 
	$THPIsEÇbËd
() {

65 
buf
[1024];

67 
FILE
 *
å
 = 
	`fİ’
("/sys/kernel/mm/transparent_hugepage/enabled","r");

68 ià(!
å
)  0;

69 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

70 
	`fşo£
(
å
);

73 
	`fşo£
(
å
);

74  (
	`¡r¡r
(
buf
,"[Ãv”]"è=ğ
NULL
) ? 1 : 0;

75 
	}
}

81 
	$THPG‘AnÚHugePagesSize
() {

82  
	`zm®loc_g‘_sm­_by‹s_by_f›ld
("AnonHugePages:");

83 
	}
}

90 
	$Ï‹ncyMÚ™ÜIn™
() {

91 
£rv”
.
Ï‹ncy_ev’ts
 = 
	`diùC»©e
(&
Ï‹ncyTimeS”›sDiùTy³
,
NULL
);

92 
	}
}

98 
	$Ï‹ncyAddSam¶e
(*
ev’t
, 
m¡ime_t
 
Ï‹ncy
) {

99 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
ev’t
);

100 
time_t
 
now
 = 
	`time
(
NULL
);

101 
´ev
;

104 ià(
ts
 =ğ
NULL
) {

105 
ts
 = 
	`zm®loc
((*ts));

106 
ts
->
idx
 = 0;

107 
ts
->
max
 = 0;

108 
	`mem£t
(
ts
->
§m¶es
,0,(ts->samples));

109 
	`diùAdd
(
£rv”
.
Ï‹ncy_ev’ts
,
	`z¡rdup
(
ev’t
),
ts
);

114 
´ev
 = (
ts
->
idx
 + 
LATENCY_TS_LEN
 - 1) % LATENCY_TS_LEN;

115 ià(
ts
->
§m¶es
[
´ev
].
time
 =ğ
now
) {

116 ià(
Ï‹ncy
 > 
ts
->
§m¶es
[
´ev
].latency)

117 
ts
->
§m¶es
[
´ev
].
Ï‹ncy
 =†atency;

121 
ts
->
§m¶es
[ts->
idx
].
time
 = 
	`time
(
NULL
);

122 
ts
->
§m¶es
[ts->
idx
].
Ï‹ncy
 =†atency;

123 ià(
Ï‹ncy
 > 
ts
->
max
)s->max =†atency;

125 
ts
->
idx
++;

126 ià(
ts
->
idx
 =ğ
LATENCY_TS_LEN
)s->idx = 0;

127 
	}
}

134 
	$Ï‹ncyRe£tEv’t
(*
ev’t_to_»£t
) {

135 
diùI‹¿tÜ
 *
di
;

136 
diùEÁry
 *
de
;

137 
»£ts
 = 0;

139 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

140 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

141 *
ev’t
 = 
	`diùG‘Key
(
de
);

143 ià(
ev’t_to_»£t
 =ğ
NULL
 || 
	`¡rÿ£cmp
(
ev’t
,event_to_reset) == 0) {

144 
	`diùD–‘e
(
£rv”
.
Ï‹ncy_ev’ts
, 
ev’t
);

145 
»£ts
++;

148 
	`diùR–—£I‹¿tÜ
(
di
);

149  
»£ts
;

150 
	}
}

159 
	$ª®yzeL©’cyFÜEv’t
(*
ev’t
, 
Ï‹ncySts
 *
ls
) {

160 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
ev’t
);

161 
j
;

162 
ušt64_t
 
sum
;

164 
ls
->
®l_time_high
 = 
ts
 ?s->
max
 : 0;

165 
ls
->
avg
 = 0;

166 
ls
->
mš
 = 0;

167 
ls
->
max
 = 0;

168 
ls
->
mad
 = 0;

169 
ls
->
§m¶es
 = 0;

170 
ls
->
³riod
 = 0;

171 ià(!
ts
) ;

174 
sum
 = 0;

175 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

176 ià(
ts
->
§m¶es
[
j
].
time
 == 0) ;

177 
ls
->
§m¶es
++;

178 ià(
ls
->
§m¶es
 == 1) {

179 
ls
->
mš
 =†s->
max
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

181 ià(
ls
->
mš
 > 
ts
->
§m¶es
[
j
].
Ï‹ncy
)

182 
ls
->
mš
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

183 ià(
ls
->
max
 < 
ts
->
§m¶es
[
j
].
Ï‹ncy
)

184 
ls
->
max
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

186 
sum
 +ğ
ts
->
§m¶es
[
j
].
Ï‹ncy
;

189 ià(
ls
->
³riod
 =ğ0 || 
ts
->
§m¶es
[
j
].
time
 <†s->period)

190 
ls
->
³riod
 = 
ts
->
§m¶es
[
j
].
time
;

196 ià(
ls
->
§m¶es
) {

197 
ls
->
avg
 = 
sum
 /†s->
§m¶es
;

198 
ls
->
³riod
 = 
	`time
(
NULL
) -†s->period;

199 ià(
ls
->
³riod
 == 0)†s->period = 1;

203 
sum
 = 0;

204 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

205 
št64_t
 
d–
;

207 ià(
ts
->
§m¶es
[
j
].
time
 == 0) ;

208 
d–
 = (
št64_t
)
ls
->
avg
 - 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

209 ià(
d–
 < 0) delta = -delta;

210 
sum
 +ğ
d–
;

212 ià(
ls
->
§m¶es
èls->
mad
 = 
sum
 /†s->samples;

213 
	}
}

216 
sds
 
	$ü—‹L©’cyR•Üt
() {

217 
sds
 
»pÜt
 = 
	`sd£m±y
();

218 
advi£_b‘‹r_vm
 = 0;

219 
advi£_¦owlog_’abËd
 = 0;

220 
advi£_¦owlog_tunšg
 = 0;

221 
advi£_¦owlog_š¥eù
 = 0;

222 
advi£_disk_cÚ‹ÁiÚ
 = 0;

223 
advi£_scheduËr
 = 0;

224 
advi£_d©a_wr™eback
 = 0;

225 
advi£_no_­³ndfsync
 = 0;

226 
advi£_loÿl_disk
 = 0;

227 
advi£_ssd
 = 0;

228 
advi£_wr™e_lßd_šfo
 = 0;

229 
advi£_hz
 = 0;

230 
advi£_Ïrge_objeùs
 = 0;

231 
advi£_mass_eviùiÚ
 = 0;

232 
advi£_»Ïx_fsync_pŞicy
 = 0;

233 
advi£_di§bË_thp
 = 0;

234 
adviûs
 = 0;

238 ià(
	`diùSize
(
£rv”
.
Ï‹ncy_ev’ts
) == 0 &&

239 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 == 0)

241 
»pÜt
 = 
	`sdsÿt
(report,"I'm sorry, Dave, I can't dohat. Latency monitoring is disabled inhis Redis instance. You may use \"CONFIG SET†atency-monitor-threshold <milliseconds>.\" in orderoƒnable it. If we weren't in‡ deep space mission I'd suggestoake‡†ook‡t http://redis.io/topics/latency-monitor.\n");

242  
»pÜt
;

247 
diùI‹¿tÜ
 *
di
;

248 
diùEÁry
 *
de
;

249 
ev’Šum
 = 0;

251 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

252 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

253 *
ev’t
 = 
	`diùG‘Key
(
de
);

254 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùG‘V®
(
de
);

255 
Ï‹ncySts
 
ls
;

257 ià(
ts
 =ğ
NULL
) ;

258 
ev’Šum
++;

259 ià(
ev’Šum
 == 1) {

260 
»pÜt
 = 
	`sdsÿt
(report,"Dave, I have observed†atency spikes inhis Redis instance. You don't mindalking‡bout it, do you Dave?\n\n");

262 
	`ª®yzeL©’cyFÜEv’t
(
ev’t
,&
ls
);

264 
»pÜt
 = 
	`sdsÿrštf
(report,

266 
ev’Šum
, 
ev’t
,

267 
ls
.
§m¶es
,

268 (è
ls
.
avg
,

269 (è
ls
.
mad
,

270 (è
ls
.
³riod
/ls.
§m¶es
,

271 (è
ts
->
max
);

274 ià(!
	`¡rÿ£cmp
(
ev’t
,"fork")) {

275 *
fÜk_qu®™y
;

276 ià(
£rv”
.
¡©_fÜk_¿‹
 < 10) {

277 
fÜk_qu®™y
 = "terrible";

278 
advi£_b‘‹r_vm
 = 1;

279 
adviûs
++;

280 } ià(
£rv”
.
¡©_fÜk_¿‹
 < 25) {

281 
fÜk_qu®™y
 = "poor";

282 
advi£_b‘‹r_vm
 = 1;

283 
adviûs
++;

284 } ià(
£rv”
.
¡©_fÜk_¿‹
 < 100) {

285 
fÜk_qu®™y
 = "good";

287 
fÜk_qu®™y
 = "excellent";

289 
»pÜt
 = 
	`sdsÿrštf
(report,

290 " FÜk„©i %.2àGB/£ø(%s).", 
£rv”
.
¡©_fÜk_¿‹
,

291 
fÜk_qu®™y
);

295 ià(!
	`¡rÿ£cmp
(
ev’t
,"command")) {

296 ià(
£rv”
.
¦owlog_log_¦ow”_thª
 == 0) {

297 
advi£_¦owlog_’abËd
 = 1;

298 
adviûs
++;

299 } ià(
£rv”
.
¦owlog_log_¦ow”_thª
/1000 >

300 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
)

302 
advi£_¦owlog_tunšg
 = 1;

303 
adviûs
++;

305 
advi£_¦owlog_š¥eù
 = 1;

306 
advi£_Ïrge_objeùs
 = 1;

307 
adviûs
 += 2;

311 ià(!
	`¡rÿ£cmp
(
ev’t
,"fast-command")) {

312 
advi£_scheduËr
 = 1;

313 
adviûs
++;

317 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-pending-fsync")) {

318 
advi£_loÿl_disk
 = 1;

319 
advi£_disk_cÚ‹ÁiÚ
 = 1;

320 
advi£_ssd
 = 1;

321 
advi£_d©a_wr™eback
 = 1;

322 
adviûs
 += 4;

325 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-active-child")) {

326 
advi£_no_­³ndfsync
 = 1;

327 
advi£_d©a_wr™eback
 = 1;

328 
advi£_ssd
 = 1;

329 
adviûs
 += 3;

332 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-alone")) {

333 
advi£_loÿl_disk
 = 1;

334 
advi£_d©a_wr™eback
 = 1;

335 
advi£_ssd
 = 1;

336 
adviûs
 += 3;

339 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-fsync-always")) {

340 
advi£_»Ïx_fsync_pŞicy
 = 1;

341 
adviûs
++;

344 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-fstat") ||

345 !
	`¡rÿ£cmp
(
ev’t
,"rdb-unlik-temp-file")) {

346 
advi£_disk_cÚ‹ÁiÚ
 = 1;

347 
advi£_loÿl_disk
 = 1;

348 
adviûs
 += 2;

351 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-rewrite-diff-write") ||

352 !
	`¡rÿ£cmp
(
ev’t
,"aof-rename")) {

353 
advi£_wr™e_lßd_šfo
 = 1;

354 
advi£_d©a_wr™eback
 = 1;

355 
advi£_ssd
 = 1;

356 
advi£_loÿl_disk
 = 1;

357 
adviûs
 += 4;

361 ià(!
	`¡rÿ£cmp
(
ev’t
,"expire-cycle")) {

362 
advi£_hz
 = 1;

363 
advi£_Ïrge_objeùs
 = 1;

364 
adviûs
 += 2;

368 ià(!
	`¡rÿ£cmp
(
ev’t
,"eviction-del")) {

369 
advi£_Ïrge_objeùs
 = 1;

370 
adviûs
++;

373 ià(!
	`¡rÿ£cmp
(
ev’t
,"eviction-cycle")) {

374 
advi£_mass_eviùiÚ
 = 1;

375 
adviûs
++;

378 
»pÜt
 = 
	`sdsÿ’
(report,"\n",1);

380 
	`diùR–—£I‹¿tÜ
(
di
);

383 ià(
	`THPG‘AnÚHugePagesSize
() > 0) {

384 
advi£_di§bË_thp
 = 1;

385 
adviûs
++;

388 ià(
ev’Šum
 =ğ0 && 
adviûs
 == 0) {

389 
»pÜt
 = 
	`sdsÿt
(report,"Dave,‚o†atency spike was observed duringhe†ifetime ofhis Redis instance,‚ot inhe slightest bit. I honestlyhink you oughto sit down calmly,ake‡ stress…ill,‡ndhinkhings over.\n");

390 } ià(
ev’Šum
 > 0 && 
adviûs
 == 0) {

391 
»pÜt
 = 
	`sdsÿt
(report,"\nWhilehere‡re†atencyƒvents†ogged, I'm‚ot‡bleo suggest‡nyƒasy fix. Please usehe Redis communityo get some help,…rovidinghis„eport in your help„equest.\n");

396 
»pÜt
 = 
	`sdsÿt
(report,"\nI have‡ few‡dvices for you:\n\n");

397 ià(
advi£_b‘‹r_vm
) {

398 
»pÜt
 = 
	`sdsÿt
(report,"- If you‡re using‡ virtual machine, consider upgrading it with‡ faster one using‡n hypervisiorhat…rovides†ess†atency during fork() calls. Xen is knowno have…oor fork()…erformance. Even inhe context ofhe same VM…rovider, certain kinds of instances canƒxecute fork fasterhan others.\n");

402 ià(
advi£_¦owlog_’abËd
) {

403 
»pÜt
 = 
	`sdsÿrštf
Ô•Üt,"- Th”¬Ï‹ncy issue w™h…Ù’tŸÎy slow commªd you‡» usšg. TryØ’abËhSlow Log Redi ã©u» usšghcommªd 'CONFIG SET slowlog-log-¦ow”-thª %Îu'. IàthSlow†og i di§bËd Redi i nÙ‡bËØlog slow commªd executiÚ fÜ you.\n", ()
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
*1000);

406 ià(
advi£_¦owlog_tunšg
) {

407 
»pÜt
 = 
	`sdsÿrštf
Ô•Üt,"- You¸cu¼’ˆSlow Log cÚfigu¿tiÚ oÆy†og ev’t th©‡» slow”hª you¸cÚfigu»d†©’cy mÚ™Üh»shŞd. PËa£ u£ 'CONFIG SET slowlog-log-¦ow”-thª %Îu'.\n", ()
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
*1000);

410 ià(
advi£_¦owlog_š¥eù
) {

411 
»pÜt
 = 
	`sdsÿt
(report,"- Check your Slow Logo understand what‡rehe commands you‡re„unning which‡reoo slowoƒxecute. Please check http://redis.io/commands/slowlog for more information.\n");

415 ià(
advi£_scheduËr
) {

416 
»pÜt
 = 
	`sdsÿt
(report,"- The system is slowoƒxecute Redis code…aths‚ot containing system calls. This usually meanshe system does‚ot…rovide Redis CPUimeo„un for†ong…eriods. You shouldryo:\n"

425 ià(
advi£_loÿl_disk
) {

426 
»pÜt
 = 
	`sdsÿt
(report,"- It is strongly‡dvisedo use†ocal disks for…ersistence,ƒspecially if you‡re using AOF. Remote disks…rovided by…latform-as-a-service…roviders‡re knowno be slow.\n");

429 ià(
advi£_ssd
) {

430 
»pÜt
 = 
	`sdsÿt
(report,"- SSD disks‡re‡bleo„educe fsync†atency,‡ndotalime‚eeded for snapshotting‡nd AOF†og„ewriting (resulting in smaller memory usage‡nd smaller final AOF„ewrite buffer flushes). Withƒxtremely high write†oad SSD disks can be‡ good option. However Redis should…erform„easonably with high†oad using‚ormal disks. Usehis‡dvice‡s‡†ast„esort.\n");

433 ià(
advi£_d©a_wr™eback
) {

434 
»pÜt
 = 
	`sdsÿt
(report,"- Mountingƒxt3/4 filesystems with data=writeback can…rovide‡…erformance boost comparedo data=ordered, howeverhis mode of operation…rovides†ess guarantees,‡nd sometimes it can happenhat‡fter‡ hard crashhe AOF file will have‡n half-written command‡theƒnd‡nd will„equireo be„epaired before Redis„estarts.\n");

437 ià(
advi£_disk_cÚ‹ÁiÚ
) {

438 
»pÜt
 = 
	`sdsÿt
(report,"- Tryo†owerhe disk contention. This is often caused by other disk intensive…rocesses„unning inhe same computer (including other Redis instances).\n");

441 ià(
advi£_no_­³ndfsync
) {

442 
»pÜt
 = 
	`sdsÿt
(report,"- Assuming fromhe…oint of view of data safetyhis is viable in yourƒnvironment, you couldryoƒnablehe 'no-appendfsync-on-rewrite' option, sohat fsync will‚ot be…erformed whilehere is‡ child„ewritinghe AOF file or…roducing‡n RDB file (the moment wherehere is high disk contention).\n");

445 ià(
advi£_»Ïx_fsync_pŞicy
 && 
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

446 
»pÜt
 = 
	`sdsÿt
(report,"- Your fsync…olicy is seto 'always'. It is very hardo get good…erformances with such‡ setup, if…ossibleryo„elaxhe fsync…olicyo 'onesec'.\n");

449 ià(
advi£_wr™e_lßd_šfo
) {

450 
»pÜt
 = 
	`sdsÿt
(report,"- Latency duringhe AOF‡tomic„ename operation or whenhe final difference is flushedohe AOF file‡theƒnd ofhe„ewrite, sometimes is caused by very high write†oad, causinghe AOF buffero get very†arge. If…ossibleryo send†ess commandso‡ccomplishhe same work, or use Lua scriptso group multiple operations into‡ single EVALSHA call.\n");

453 ià(
advi£_hz
 && 
£rv”
.
hz
 < 100) {

454 
»pÜt
 = 
	`sdsÿt
(report,"- In ordero makehe Redis keysƒxpiring…rocess more incremental,ryo sethe 'hz' configuration…arametero 100 using 'CONFIG SET hz 100'.\n");

457 ià(
advi£_Ïrge_objeùs
) {

458 
»pÜt
 = 
	`sdsÿt
(report,"- Deleting,ƒxpiring orƒvicting (because of maxmemory…olicy)†arge objects is‡ blocking operation. If you have very†arge objectshat‡re often deleted,ƒxpired, orƒvicted,ryo fragmenthose objects into multiple smaller objects.\n");

461 ià(
advi£_mass_eviùiÚ
) {

462 
»pÜt
 = 
	`sdsÿt
(report,"- Sudden changesohe 'maxmemory' setting via 'CONFIG SET', or‡llocation of†arge objects via sets or sorted sets intersections, STORE option of SORT, Redis Cluster†arge keys migrations (RESTORE command), may create sudden memory…ressure forcinghe servero blockryingoƒvict keys. \n");

465 ià(
advi£_di§bË_thp
) {

466 
»pÜt
 = 
	`sdsÿt
(report,"- I detected‡‚on zero‡mount of‡nonymous huge…ages used by your…rocess. This creates very serious†atencyƒvents in different conditions,ƒspecially when Redis is…ersisting on disk. To disable THP support usehe command 'echo‚ever > /sys/kernel/mm/transparent_hugepage/enabled', make sureo‡lso‡dd it into /etc/rc.local sohathe command will beƒxecuted‡gain‡fter‡„eboot. Notehatƒven if you have‡lready disabled THP, you still‚eedo„estarthe Redis…rocesso get„id ofhe huge…ages‡lready created.\n");

470  
»pÜt
;

471 
	}
}

477 
	$Ï‹ncyCommªdR•lyW™hSam¶es
(
ş›Á
 *
c
, 
Ï‹ncyTimeS”›s
 *
ts
) {

478 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

479 
§m¶es
 = 0, 
j
;

481 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

482 
i
 = (
ts
->
idx
 + 
j
è% 
LATENCY_TS_LEN
;

484 ià(
ts
->
§m¶es
[
i
].
time
 == 0) ;

485 
	`addR•lyMuÉiBulkL’
(
c
,2);

486 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
i
].
time
);

487 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
i
].
Ï‹ncy
);

488 
§m¶es
++;

490 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
§m¶es
);

491 
	}
}

495 
	$Ï‹ncyCommªdR•lyW™hL©e¡Ev’ts
(
ş›Á
 *
c
) {

496 
diùI‹¿tÜ
 *
di
;

497 
diùEÁry
 *
de
;

499 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
£rv”
.
Ï‹ncy_ev’ts
));

500 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

501 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

502 *
ev’t
 = 
	`diùG‘Key
(
de
);

503 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùG‘V®
(
de
);

504 
Ï¡
 = (
ts
->
idx
 + 
LATENCY_TS_LEN
 - 1) % LATENCY_TS_LEN;

506 
	`addR•lyMuÉiBulkL’
(
c
,4);

507 
	`addR•lyBulkCSŒšg
(
c
,
ev’t
);

508 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
Ï¡
].
time
);

509 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
Ï¡
].
Ï‹ncy
);

510 
	`addR•lyLÚgLÚg
(
c
,
ts
->
max
);

512 
	`diùR–—£I‹¿tÜ
(
di
);

513 
	}
}

515 
	#LATENCY_GRAPH_COLS
 80

	)

516 
sds
 
	$Ï‹ncyCommªdG’S·rk–še
(*
ev’t
, 
Ï‹ncyTimeS”›s
 *
ts
) {

517 
j
;

518 
£qu’û
 *
£q
 = 
	`ü—‹S·rklšeSequ’û
();

519 
sds
 
g¿ph
 = 
	`sd£m±y
();

520 
ušt32_t
 
mš
 = 0, 
max
 = 0;

522 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

523 
i
 = (
ts
->
idx
 + 
j
è% 
LATENCY_TS_LEN
;

524 
–­£d
;

525 
buf
[64];

527 ià(
ts
->
§m¶es
[
i
].
time
 == 0) ;

529 ià(
£q
->
Ëngth
 == 0) {

530 
mš
 = 
max
 = 
ts
->
§m¶es
[
i
].
Ï‹ncy
;

532 ià(
ts
->
§m¶es
[
i
].
Ï‹ncy
 > 
max
) max =s->samples[i].latency;

533 ià(
ts
->
§m¶es
[
i
].
Ï‹ncy
 < 
mš
) min =s->samples[i].latency;

537 
–­£d
 = 
	`time
(
NULL
è- 
ts
->
§m¶es
[
i
].
time
;

538 ià(
–­£d
 < 60)

539 
	`¢´štf
(
buf
,(buf),"%ds",
–­£d
);

540 ià(
–­£d
 < 3600)

541 
	`¢´štf
(
buf
,(buf),"%dm",
–­£d
/60);

542 ià(
–­£d
 < 3600*24)

543 
	`¢´štf
(
buf
,(buf),"%dh",
–­£d
/3600);

545 
	`¢´štf
(
buf
,(buf),"%dd",
–­£d
/(3600*24));

546 
	`¥¬klšeSequ’ûAddSam¶e
(
£q
,
ts
->
§m¶es
[
i
].
Ï‹ncy
,
buf
);

549 
g¿ph
 = 
	`sdsÿrštf
(graph,

550 "% - high %lu ms,†ow %lu m ×Îimhigh %lu ms)\n", 
ev’t
,

551 (è
max
, (è
mš
, (è
ts
->max);

552 
j
 = 0; j < 
LATENCY_GRAPH_COLS
; j++)

553 
g¿ph
 = 
	`sdsÿ’
(graph,"-",1);

554 
g¿ph
 = 
	`sdsÿ’
(graph,"\n",1);

555 
g¿ph
 = 
	`¥¬klšeR’d”
(g¿ph,
£q
,
LATENCY_GRAPH_COLS
,4,
SPARKLINE_FILL
);

556 
	`ä“S·rklšeSequ’û
(
£q
);

557  
g¿ph
;

558 
	}
}

567 
	$Ï‹ncyCommªd
(
ş›Á
 *
c
) {

568 
Ï‹ncyTimeS”›s
 *
ts
;

570 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"hi¡Üy"è&& c->
¬gc
 == 3) {

572 
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
c
->
¬gv
[2]->
±r
);

573 ià(
ts
 =ğ
NULL
) {

574 
	`addR•lyMuÉiBulkL’
(
c
,0);

576 
	`Ï‹ncyCommªdR•lyW™hSam¶es
(
c
,
ts
);

578 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g¿ph"è&& c->
¬gc
 == 3) {

580 
sds
 
g¿ph
;

581 
diùEÁry
 *
de
;

582 *
ev’t
;

584 
de
 = 
	`diùFšd
(
£rv”
.
Ï‹ncy_ev’ts
,
c
->
¬gv
[2]->
±r
);

585 ià(
de
 =ğ
NULL
è
nod©«¼
;

586 
ts
 = 
	`diùG‘V®
(
de
);

587 
ev’t
 = 
	`diùG‘Key
(
de
);

589 
g¿ph
 = 
	`Ï‹ncyCommªdG’S·rk–še
(
ev’t
,
ts
);

590 
	`addR•lyBulkCSŒšg
(
c
,
g¿ph
);

591 
	`sdsä“
(
g¿ph
);

592 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"Ï‹¡"è&& c->
¬gc
 == 2) {

594 
	`Ï‹ncyCommªdR•lyW™hL©e¡Ev’ts
(
c
);

595 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"doùÜ"è&& c->
¬gc
 == 2) {

597 
sds
 
»pÜt
 = 
	`ü—‹L©’cyR•Üt
();

599 
	`addR•lyBulkCBufãr
(
c
,
»pÜt
,
	`sd¦’
(report));

600 
	`sdsä“
(
»pÜt
);

601 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»£t"è&& c->
¬gc
 >= 2) {

603 ià(
c
->
¬gc
 == 2) {

604 
	`addR•lyLÚgLÚg
(
c
,
	`Ï‹ncyRe£tEv’t
(
NULL
));

606 
j
, 
»£ts
 = 0;

608 
j
 = 2; j < 
c
->
¬gc
; j++)

609 
»£ts
 +ğ
	`Ï‹ncyRe£tEv’t
(
c
->
¬gv
[
j
]->
±r
);

610 
	`addR•lyLÚgLÚg
(
c
,
»£ts
);

613 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

617 
nod©«¼
:

620 
	`addR•lyE¼ÜFÜm©
(
c
,

621 "NØ§m¶e avaabË fÜƒv’ˆ'%s'", (*è
c
->
¬gv
[2]->
±r
);

622 
	}
}

	@latency.h

34 #iâdeà
__LATENCY_H


35 
	#__LATENCY_H


	)

37 
	#LATENCY_TS_LEN
 160

	)

41 
	sÏ‹ncySam¶e
 {

42 
št32_t
 
	mtime
;

43 
ušt32_t
 
	mÏ‹ncy
;

47 
	sÏ‹ncyTimeS”›s
 {

48 
	midx
;

49 
ušt32_t
 
	mmax
;

50 
Ï‹ncySam¶e
 
	m§m¶es
[
LATENCY_TS_LEN
];

54 
	sÏ‹ncySts
 {

55 
ušt32_t
 
	m®l_time_high
;

56 
ušt32_t
 
	mavg
;

57 
ušt32_t
 
	mmš
;

58 
ušt32_t
 
	mmax
;

59 
ušt32_t
 
	mmad
;

60 
ušt32_t
 
	m§m¶es
;

61 
time_t
 
	m³riod
;

64 
Ï‹ncyMÚ™ÜIn™
();

65 
Ï‹ncyAddSam¶e
(*
ev’t
, 
m¡ime_t
 
Ï‹ncy
);

66 
THPIsEÇbËd
();

71 
	#Ï‹ncyS¹MÚ™Ü
(
v¬
èià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) { \

72 
v¬
 = 
	`m¡ime
(); \

74 
v¬
 = 0; \

75 }

	)

79 
	#Ï‹ncyEndMÚ™Ü
(
v¬
èià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) { \

80 
v¬
 = 
	`m¡ime
() - var; \

81 }

	)

84 
	#Ï‹ncyAddSam¶eIfN“ded
(
ev’t
,
v¬
) \

85 ià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 && \

86 (
v¬
è>ğ
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) \

87 
	`Ï‹ncyAddSam¶e
((
ev’t
),(
v¬
));

	)

90 
	#Ï‹ncyRemoveNe¡edEv’t
(
ev’t_v¬
,
Ã¡ed_v¬
) \

91 
ev’t_v¬
 +ğ
Ã¡ed_v¬
;

	)

	@lazyfree.c

1 
	~"£rv”.h
"

2 
	~"bio.h
"

3 
	~"©omicv¬.h
"

4 
	~"şu¡”.h
"

6 
size_t
 
	gÏzyä“_objeùs
 = 0;

7 
±h»ad_mu‹x_t
 
	gÏzyä“_objeùs_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

10 
size_t
 
	$Ïzyä“G‘P’dšgObjeùsCouÁ
() {

11  
Ïzyä“_objeùs
;

12 
	}
}

29 
size_t
 
	$Ïzyä“G‘F»eEffÜt
(
robj
 *
obj
) {

30 ià(
obj
->
ty³
 =ğ
OBJ_LIST
) {

31 
quickli¡
 *
ql
 = 
obj
->
±r
;

32  
ql
->
Ën
;

33 } ià(
obj
->
ty³
 =ğ
OBJ_SET
 && obj->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

34 
diù
 *
ht
 = 
obj
->
±r
;

35  
	`diùSize
(
ht
);

36 } ià(
obj
->
ty³
 =ğ
OBJ_ZSET
 && obj->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
){

37 
z£t
 *
zs
 = 
obj
->
±r
;

38  
zs
->
z¦
->
Ëngth
;

39 } ià(
obj
->
ty³
 =ğ
OBJ_HASH
 && obj->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

40 
diù
 *
ht
 = 
obj
->
±r
;

41  
	`diùSize
(
ht
);

45 
	}
}

51 
	#LAZYFREE_THRESHOLD
 64

	)

52 
	$dbAsyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

55 ià(
	`diùSize
(
db
->
expœes
è> 0è
	`diùD–‘e
(db->expœes,
key
->
±r
);

60 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

61 ià(
de
) {

62 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

63 
size_t
 
ä“_effÜt
 = 
	`Ïzyä“G‘F»eEffÜt
(
v®
);

67 ià(
ä“_effÜt
 > 
LAZYFREE_THRESHOLD
) {

68 
	`©omicInü
(
Ïzyä“_objeùs
,1,
Ïzyä“_objeùs_mu‹x
);

69 
	`bioC»©eBackgroundJob
(
BIO_LAZY_FREE
,
v®
,
NULL
,NULL);

70 
	`diùS‘V®
(
db
->
diù
,
de
,
NULL
);

76 ià(
	`diùD–‘e
(
db
->
diù
,
key
->
±r
è=ğ
DICT_OK
) {

77 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyD–
(
key
);

82 
	}
}

87 
	$em±yDbAsync
(
»disDb
 *
db
) {

88 
diù
 *
Şdht1
 = 
db
->diù, *
Şdht2
 = db->
expœes
;

89 
db
->
diù
 = 
	`diùC»©e
(&
dbDiùTy³
,
NULL
);

90 
db
->
expœes
 = 
	`diùC»©e
(&
key±rDiùTy³
,
NULL
);

91 
	`©omicInü
(
Ïzyä“_objeùs
,
	`diùSize
(
Şdht1
),

92 
Ïzyä“_objeùs_mu‹x
);

93 
	`bioC»©eBackgroundJob
(
BIO_LAZY_FREE
,
NULL
,
Şdht1
,
Şdht2
);

94 
	}
}

98 
	$¦ÙToKeyFlushAsync
() {

99 
zskli¡
 *
Şd¦
 = 
£rv”
.
şu¡”
->
¦Ùs_to_keys
;

100 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`z¦C»©e
();

101 
	`©omicInü
(
Ïzyä“_objeùs
,
Şd¦
->
Ëngth
,

102 
Ïzyä“_objeùs_mu‹x
);

103 
	`bioC»©eBackgroundJob
(
BIO_LAZY_FREE
,
NULL
,NULL,
Şd¦
);

104 
	}
}

108 
	$Ïzyä“F»eObjeùFromBioTh»ad
(
robj
 *
o
) {

109 
	`deüRefCouÁ
(
o
);

110 
	`©omicDeü
(
Ïzyä“_objeùs
,1,
Ïzyä“_objeùs_mu‹x
);

111 
	}
}

118 
	$Ïzyä“F»eD©aba£FromBioTh»ad
(
diù
 *
ht1
, diù *
ht2
) {

119 
size_t
 
numkeys
 = 
	`diùSize
(
ht1
);

120 
	`diùR–—£
(
ht1
);

121 
	`diùR–—£
(
ht2
);

122 
	`©omicDeü
(
Ïzyä“_objeùs
,
numkeys
,
Ïzyä“_objeùs_mu‹x
);

123 
	}
}

127 
	$Ïzyä“F»eSlÙsM­FromBioTh»ad
(
zskli¡
 *
¦
) {

128 
size_t
 
Ën
 = 
¦
->
Ëngth
;

129 
	`z¦F»e
(
¦
);

130 
	`©omicDeü
(
Ïzyä“_objeùs
,
Ën
,
Ïzyä“_objeùs_mu‹x
);

131 
	}
}

	@lzf.h

37 #iâdeà
LZF_H


38 
	#LZF_H


	)

49 
	#LZF_VERSION
 0x0105

	)

77 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

78 *
out_d©a
, 
out_Ën
);

96 
lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

97 *
out_d©a
, 
out_Ën
);

	@lzfP.h

37 #iâdeà
LZFP_h


38 
	#LZFP_h


	)

40 
	#STANDALONE
 1

	)

42 #iâdeà
STANDALONE


43 
	~"lzf.h
"

54 #iâdeà
HLOG


55 
	#HLOG
 16

	)

63 #iâdeà
VERY_FAST


64 
	#VERY_FAST
 1

	)

74 #iâdeà
ULTRA_FAST


75 
	#ULTRA_FAST
 0

	)

81 #iâdeà
STRICT_ALIGN


82 
	#STRICT_ALIGN
 !(
	`defšed
(
__i386
è|| defšed (
__amd64
))

	)

90 #iâdeà
INIT_HTAB


91 
	#INIT_HTAB
 0

	)

99 #iâdeà
AVOID_ERRNO


100 
	#AVOID_ERRNO
 0

	)

108 #iâdeà
LZF_STATE_ARG


109 
	#LZF_STATE_ARG
 0

	)

120 #iâdeà
CHECK_INPUT


121 
	#CHECK_INPUT
 1

	)

134 #ifdeà
__ılu¥lus


135 
	~<c¡ršg
>

136 
	~<şim™s
>

137 
usšg
 
Çme¥aû
 
	g¡d
;

139 
	~<¡ršg.h
>

140 
	~<lim™s.h
>

143 #iâdeà
LZF_USE_OFFSETS


144 #ià
defšed
 (
WIN32
)

145 
	#LZF_USE_OFFSETS
 
	`defšed
(
_M_X64
)

	)

147 #ià
__ılu¥lus
 > 199711L

148 
	~<c¡dšt
>

150 
	~<¡dšt.h
>

152 
	#LZF_USE_OFFSETS
 (
UINTPTR_MAX
 > 0xffffffffU)

	)

156 
	tu8
;

158 #ià
LZF_USE_OFFSETS


159 
	#LZF_HSLOT_BIAS
 ((cÚ¡ 
u8
 *)
š_d©a
)

	)

160 
	tLZF_HSLOT
;

162 
	#LZF_HSLOT_BIAS
 0

	)

163 cÚ¡ 
	tu8
 *
	tLZF_HSLOT
;

166 
LZF_HSLOT
 
	tLZF_STATE
[1 << (
HLOG
)];

168 #ià!
STRICT_ALIGN


170 #ià
USHRT_MAX
 == 65535

171 
	tu16
;

172 #–ià
UINT_MAX
 == 65535

173 
	tu16
;

175 #undeà
STRICT_ALIGN


176 
	#STRICT_ALIGN
 1

	)

180 #ià
ULTRA_FAST


181 #undeà
VERY_FAST


	@lzf_c.c

37 
	~"lzfP.h
"

39 
	#HSIZE
 (1 << (
HLOG
))

	)

47 #iâdeà
FRST


48 
	#FRST
(
p
è((Õ[0]è<< 8è|…[1])

	)

49 
	#NEXT
(
v
,
p
è(((vè<< 8è|…[2])

	)

50 #ià
ULTRA_FAST


51 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h ) & (
HSIZE
 - 1))

	)

52 #–ià
VERY_FAST


53 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

55 
	#IDX
(
h
è((((h ^ (h << 5)è>> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

69 
	#FRST
(
p
èÕ[0] << 5è^…[1]

	)

70 
	#NEXT
(
v
,
p
è((vè<< 5è^…[2]

	)

71 
	#IDX
(
h
è((hè& (
HSIZE
 - 1))

	)

74 
	#MAX_LIT
 (1 << 5)

	)

75 
	#MAX_OFF
 (1 << 13)

	)

76 
	#MAX_REF
 ((1 << 8è+ (1 << 3))

	)

78 #ià
__GNUC__
 >= 3

79 
	#ex³ù
(
ex´
,
v®ue
è
	`__butš_ex³ù
 (Óx´),(v®ue))

	)

80 
	#šlše
 
šlše


	)

82 
	#ex³ù
(
ex´
,
v®ue
èÓx´)

	)

83 
	#šlše
 

	)

86 
	#ex³ù_çl£
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 0)

	)

87 
	#ex³ù_Œue
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 1)

	)

99 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

100 *
out_d©a
, 
out_Ën


101 #ià
LZF_STATE_ARG


102 , 
LZF_STATE
 
hb


106 #ià!
LZF_STATE_ARG


107 
LZF_STATE
 
	ghb
;

109 cÚ¡ 
u8
 *
	g
 = (cÚ¡ u8 *)
š_d©a
;

110 
u8
 *
	gİ
 = (u8 *)
out_d©a
;

111 cÚ¡ 
u8
 *
	gš_’d
 = 

 + 
š_Ën
;

112 
u8
 *
	gout_’d
 = 
İ
 + 
out_Ën
;

113 cÚ¡ 
u8
 *
	g»f
;

122 #ià
defšed
 (
WIN32
è&& defšed (
_M_X64
)

123 
_št64
 
	goff
;

125 
	goff
;

127 
	ghv®
;

128 
	gl™
;

130 ià(!
	gš_Ën
 || !
	gout_Ën
)

133 #ià
INIT_HTAB


134 
mem£t
 (
hb
, 0,  (htab));

137 
	gl™
 = 0; 
	gİ
++;

139 
	ghv®
 = 
FRST
 (

);

140 
	g
 < 
	gš_’d
 - 2)

142 
LZF_HSLOT
 *
	gh¦Ù
;

144 
	ghv®
 = 
NEXT
 (
hv®
, 

);

145 
	gh¦Ù
 = 
hb
 + 
IDX
 (
hv®
);

146 
	g»f
 = *
h¦Ù
 + 
LZF_HSLOT_BIAS
; *
	gh¦Ù
 = 

 - LZF_HSLOT_BIAS;

149 #ià
INIT_HTAB


150 && 
	g»f
 < 
	g


152 && (
	goff
 = 

 - 
»f
 - 1è< 
MAX_OFF


153 && 
»f
 > (
u8
 *)
š_d©a


154 && 
»f
[2] =ğ

[2]

155 #ià
STRICT_ALIGN


156 && ((
»f
[1] << 8è|„ef[0]è=ğ((

[1] << 8) | ip[0])

158 && *(
u16
 *)
»f
 =ğ*(u16 *)



163 
Ën
 = 2;

164 
	gmaxËn
 = 
š_’d
 - 

 - 
Ën
;

165 
	gmaxËn
 = 
maxËn
 > 
MAX_REF
 ? MAX_REF : maxlen;

167 ià(
ex³ù_çl£
 (
İ
 + 3 + 1 >ğ
out_’d
))

168 ià(
İ
 - !
l™
 + 3 + 1 >ğ
out_’d
)

171 
	gİ
 [- 
l™
 - 1] =†it - 1;

172 
	gİ
 -ğ!
l™
;

176 ià(
ex³ù_Œue
 (
maxËn
 > 16))

178 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

179 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

180 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

181 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

183 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

184 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

185 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

186 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

188 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

189 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

190 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

191 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

193 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

194 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

195 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

196 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

200 
	gËn
++;

201 
	gËn
 < 
	gmaxËn
 && 
	g»f
[
Ën
] =ğ

[len]);

206 
	gËn
 -= 2;

207 
	g
++;

209 ià(
	gËn
 < 7)

211 *
	gİ
++ = (
off
 >> 8è+ (
Ën
 << 5);

215 *
	gİ
++ = (
off
 >> 8) + ( 7 << 5);

216 *
	gİ
++ = 
Ën
 - 7;

219 *
	gİ
++ = 
off
;

221 
	gl™
 = 0; 
	gİ
++;

223 
	g
 +ğ
Ën
 + 1;

225 ià(
ex³ù_çl£
 (

 >ğ
š_’d
 - 2))

228 #ià
ULTRA_FAST
 || 
VERY_FAST


229 --
	g
;

230 #ià
VERY_FAST
 && !
ULTRA_FAST


231 --
	g
;

233 
	ghv®
 = 
FRST
 (

);

235 
	ghv®
 = 
NEXT
 (
hv®
, 

);

236 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

237 
	g
++;

239 #ià
VERY_FAST
 && !
ULTRA_FAST


240 
	ghv®
 = 
NEXT
 (
hv®
, 

);

241 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

242 
	g
++;

245 
	g
 -ğ
Ën
 + 1;

249 
	ghv®
 = 
NEXT
 (
hv®
, 

);

250 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

251 
	g
++;

253 
	gËn
--);

259 ià(
ex³ù_çl£
 (
İ
 >ğ
out_’d
))

262 
	gl™
++; *
	gİ
++ = *

++;

264 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

266 
İ
 [- 
l™
 - 1] =†it - 1;

267 
	gl™
 = 0; 
	gİ
++;

272 ià(
	gİ
 + 3 > 
	gout_’d
)

275 
	g
 < 
	gš_’d
)

277 
	gl™
++; *
	gİ
++ = *

++;

279 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

281 
İ
 [- 
l™
 - 1] =†it - 1;

282 
	gl™
 = 0; 
	gİ
++;

286 
	gİ
 [- 
l™
 - 1] =†it - 1;

287 
	gİ
 -ğ!
l™
;

289  
	gİ
 - (
	gu8
 *)
	gout_d©a
;

	@lzf_d.c

37 
	~"lzfP.h
"

39 #ià
AVOID_ERRNO


40 
	#SET_ERRNO
(
n
)

	)

42 
	~<”ºo.h
>

43 
	#SET_ERRNO
(
n
è
”ºo
 = (n)

	)

46 #ià
USE_REP_MOVSB


47 #ià(
__i386
 || 
__amd64
è&& 
__GNUC__
 >= 3

48 
	#lzf_movsb
(
d¡
, 
¤c
, 
Ën
) \

49 
	`asm
 ("rep movsb" \

50 : "=D" (
d¡
), "=S" (
¤c
), "=c" (
Ën
) \

51 : "0" (
d¡
), "1" (
¤c
), "2" (
Ën
));

	)

56 
	$lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

57 *
out_d©a
, 
out_Ën
)

59 
u8
 cÚ¡ *

 = (cÚ¡ u8 *)
š_d©a
;

60 
u8
 *
İ
 = (u8 *)
out_d©a
;

61 
u8
 cÚ¡ *cÚ¡ 
š_’d
 = 

 + 
š_Ën
;

62 
u8
 *cÚ¡ 
out_’d
 = 
İ
 + 
out_Ën
;

66 
ù¾
 = *

++;

68 ià(
ù¾
 < (1 << 5))

70 
ù¾
++;

72 ià(
İ
 + 
ù¾
 > 
out_’d
)

74 
	`SET_ERRNO
 (
E2BIG
);

78 #ià
CHECK_INPUT


79 ià(

 + 
ù¾
 > 
š_’d
)

81 
	`SET_ERRNO
 (
EINVAL
);

86 #ifdeà
lzf_movsb


87 
	`lzf_movsb
 (
İ
, 

, 
ù¾
);

89 
ù¾
)

91 32: *
İ
++ = *

++; 31: *op++ = *ip++; 30: *op++ = *ip++; 29: *op++ = *ip++;

92 28: *
İ
++ = *

++; 27: *op++ = *ip++; 26: *op++ = *ip++; 25: *op++ = *ip++;

93 24: *
İ
++ = *

++; 23: *op++ = *ip++; 22: *op++ = *ip++; 21: *op++ = *ip++;

94 20: *
İ
++ = *

++; 19: *op++ = *ip++; 18: *op++ = *ip++; 17: *op++ = *ip++;

95 16: *
İ
++ = *

++; 15: *op++ = *ip++; 14: *op++ = *ip++; 13: *op++ = *ip++;

96 12: *
İ
++ = *

++; 11: *op++ = *ip++; 10: *op++ = *ip++; 9: *op++ = *ip++;

97 8: *
İ
++ = *

++; 7: *op++ = *ip++; 6: *op++ = *ip++; 5: *op++ = *ip++;

98 4: *
İ
++ = *

++; 3: *op++ = *ip++; 2: *op++ = *ip++; 1: *op++ = *ip++;

104 
Ën
 = 
ù¾
 >> 5;

106 
u8
 *
»f
 = 
İ
 - ((
ù¾
 & 0x1f) << 8) - 1;

108 #ià
CHECK_INPUT


109 ià(

 >ğ
š_’d
)

111 
	`SET_ERRNO
 (
EINVAL
);

115 ià(
Ën
 == 7)

117 
Ën
 +ğ*

++;

118 #ià
CHECK_INPUT


119 ià(

 >ğ
š_’d
)

121 
	`SET_ERRNO
 (
EINVAL
);

127 
»f
 -ğ*

++;

129 ià(
İ
 + 
Ën
 + 2 > 
out_’d
)

131 
	`SET_ERRNO
 (
E2BIG
);

135 ià(
»f
 < (
u8
 *)
out_d©a
)

137 
	`SET_ERRNO
 (
EINVAL
);

141 #ifdeà
lzf_movsb


142 
Ën
 += 2;

143 
	`lzf_movsb
 (
İ
, 
»f
, 
Ën
);

145 
Ën
)

148 
Ën
 += 2;

150 ià(
İ
 >ğ
»f
 + 
Ën
)

153 
	`memıy
 (
İ
, 
»f
, 
Ën
);

154 
İ
 +ğ
Ën
;

160 *
İ
++ = *
»f
++;

161 --
Ën
);

166 9: *
İ
++ = *
»f
++;

167 8: *
İ
++ = *
»f
++;

168 7: *
İ
++ = *
»f
++;

169 6: *
İ
++ = *
»f
++;

170 5: *
İ
++ = *
»f
++;

171 4: *
İ
++ = *
»f
++;

172 3: *
İ
++ = *
»f
++;

173 2: *
İ
++ = *
»f
++;

174 1: *
İ
++ = *
»f
++;

175 0: *
İ
++ = *
»f
++;

176 *
İ
++ = *
»f
++;

181 

 < 
š_’d
);

183  
İ
 - (
u8
 *)
out_d©a
;

184 
	}
}

	@memtest.c

29 
	~<¡dšt.h
>

30 
	~<¡dlib.h
>

31 
	~<¡dio.h
>

32 
	~<¡ršg.h
>

33 
	~<as£¹.h
>

34 
	~<lim™s.h
>

35 
	~<”ºo.h
>

36 
	~<‹rmios.h
>

37 
	~<sys/ioùl.h
>

38 #ià
defšed
(
__sun
)

39 
	~<¡rİts.h
>

41 
	~"cÚfig.h
"

43 #ià(
ULONG_MAX
 == 4294967295UL)

44 
	#MEMTEST_32BIT


	)

45 #–ià(
ULONG_MAX
 == 18446744073709551615ULL)

46 
	#MEMTEST_64BIT


	)

51 #ifdeà
MEMTEST_32BIT


52 
	#ULONG_ONEZERO
 0x¯¯¯¯UL

	)

53 
	#ULONG_ZEROONE
 0x55555555UL

	)

55 
	#ULONG_ONEZERO
 0x¯¯¯¯¯¯¯¯UL

	)

56 
	#ULONG_ZEROONE
 0x5555555555555555UL

	)

59 
wšsize
 
	gws
;

60 
size_t
 
	g´og»ss_´š‹d
;

61 
size_t
 
	g´og»ss_fuÎ
;

63 
	$mem‹¡_´og»ss_¡¬t
(*
t™Ë
, 
·ss
) {

64 
j
;

66 
	`´štf
("\x1b[H\x1b[2J");

68 
j
 = 0; j < 
ws
.
ws_cŞ
*(ws.
ws_row
-2); j++è
	`´štf
(".");

69 
	`´štf
("Please keepheest„unning several minutes…er GB of memory.\n");

70 
	`´štf
("Also check http://www.memtest86.com/‡nd http://pyropus.ca/software/memtester/");

71 
	`´štf
("\x1b[H\x1b[2K");

72 
	`´štf
("% [%d]\n", 
t™Ë
, 
·ss
);

73 
´og»ss_´š‹d
 = 0;

74 
´og»ss_fuÎ
 = 
ws
.
ws_cŞ
*(ws.
ws_row
-3);

75 
	`fæush
(
¡dout
);

76 
	}
}

78 
	$mem‹¡_´og»ss_’d
() {

79 
	`´štf
("\x1b[H\x1b[2J");

80 
	}
}

82 
	$mem‹¡_´og»ss_¡•
(
size_t
 
cu¼
, size_ˆ
size
, 
c
) {

83 
size_t
 
ch¬s
 = (()
cu¼
*
´og»ss_fuÎ
)/
size
, 
j
;

85 
j
 = 0; j < 
ch¬s
-
´og»ss_´š‹d
; j++è
	`´štf
("%c",
c
);

86 
´og»ss_´š‹d
 = 
ch¬s
;

87 
	`fæush
(
¡dout
);

88 
	}
}

93 
	$mem‹¡_add»ssšg
(*
l
, 
size_t
 
by‹s
, 
š‹¿ùive
) {

94 
wÜds
 = 
by‹s
/();

95 
j
, *
p
;

98 
p
 = 
l
;

99 
j
 = 0; j < 
wÜds
; j++) {

100 *
p
 = ()p;

101 
p
++;

102 ià((
j
 & 0xffffè=ğ0 && 
š‹¿ùive
)

103 
	`mem‹¡_´og»ss_¡•
(
j
,
wÜds
*2,'A');

106 
p
 = 
l
;

107 
j
 = 0; j < 
wÜds
; j++) {

108 ià(*
p
 != ()p) {

109 ià(
š‹¿ùive
) {

110 
	`´štf
("\n*** MEMORY ADDRESSING ERROR: %p contains %lu\n",

111 (*è
p
, *p);

112 
	`ex™
(1);

116 
p
++;

117 ià((
j
 & 0xffffè=ğ0 && 
š‹¿ùive
)

118 
	`mem‹¡_´og»ss_¡•
(
j
+
wÜds
,words*2,'A');

121 
	}
}

131 
	#xÜshiá64¡¬_Ãxt
() do { \

132 
r£ed
 ^=„seed >> 12; \

133 
r£ed
 ^=„seed << 25; \

134 
r£ed
 ^=„seed >> 27; \

135 
rout
 = 
r£ed
 * 
	`UINT64_C
(2685821657736338717); \

136 } 0)

	)

138 
	$mem‹¡_fl_¿ndom
(*
l
, 
size_t
 
by‹s
, 
š‹¿ùive
) {

139 
¡•
 = 4096/();

140 
wÜds
 = 
by‹s
/()/2;

141 
iwÜds
 = 
wÜds
/
¡•
;

142 
off
, 
w
, *
l1
, *
l2
;

143 
ušt64_t
 
r£ed
 = 
	`UINT64_C
(0xd13133de9afdb566);

144 
ušt64_t
 
rout
 = 0;

146 
	`as£¹
((
by‹s
 & 4095) == 0);

147 
off
 = 0; ofà< 
¡•
; off++) {

148 
l1
 = 
l
+
off
;

149 
l2
 = 
l1
+
wÜds
;

150 
w
 = 0; w < 
iwÜds
; w++) {

151 
	`xÜshiá64¡¬_Ãxt
();

152 *
l1
 = *
l2
 = (è
rout
;

153 
l1
 +ğ
¡•
;

154 
l2
 +ğ
¡•
;

155 ià((
w
 & 0xffffè=ğ0 && 
š‹¿ùive
)

156 
	`mem‹¡_´og»ss_¡•
(
w
+
iwÜds
*
off
,
wÜds
,'R');

159 
	}
}

163 
	$mem‹¡_fl_v®ue
(*
l
, 
size_t
 
by‹s
, 
v1
,

164 
v2
, 
sym
, 
š‹¿ùive
)

166 
¡•
 = 4096/();

167 
wÜds
 = 
by‹s
/()/2;

168 
iwÜds
 = 
wÜds
/
¡•
;

169 
off
, 
w
, *
l1
, *
l2
, 
v
;

171 
	`as£¹
((
by‹s
 & 4095) == 0);

172 
off
 = 0; ofà< 
¡•
; off++) {

173 
l1
 = 
l
+
off
;

174 
l2
 = 
l1
+
wÜds
;

175 
v
 = (
off
 & 1è? 
v2
 : 
v1
;

176 
w
 = 0; w < 
iwÜds
; w++) {

177 #ifdeà
MEMTEST_32BIT


178 *
l1
 = *
l2
 = ((è
v
) |

179 (((è
v
) << 16);

181 *
l1
 = *
l2
 = ((è
v
) |

182 (((è
v
) << 16) |

183 (((è
v
) << 32) |

184 (((è
v
) << 48);

186 
l1
 +ğ
¡•
;

187 
l2
 +ğ
¡•
;

188 ià((
w
 & 0xffffè=ğ0 && 
š‹¿ùive
)

189 
	`mem‹¡_´og»ss_¡•
(
w
+
iwÜds
*
off
,
wÜds
,
sym
);

192 
	}
}

194 
	$mem‹¡_com·»
(*
l
, 
size_t
 
by‹s
, 
š‹¿ùive
) {

195 
wÜds
 = 
by‹s
/()/2;

196 
w
, *
l1
, *
l2
;

198 
	`as£¹
((
by‹s
 & 4095) == 0);

199 
l1
 = 
l
;

200 
l2
 = 
l1
+
wÜds
;

201 
w
 = 0; w < 
wÜds
; w++) {

202 ià(*
l1
 !ğ*
l2
) {

203 ià(
š‹¿ùive
) {

204 
	`´štf
("\n*** MEMORY ERROR DETECTED: %p != %p (%lu vs %lu)\n",

205 (*)
l1
, (*)
l2
, *l1, *l2);

206 
	`ex™
(1);

210 
l1
 ++;

211 
l2
 ++;

212 ià((
w
 & 0xffffè=ğ0 && 
š‹¿ùive
)

213 
	`mem‹¡_´og»ss_¡•
(
w
,
wÜds
,'=');

216 
	}
}

218 
	$mem‹¡_com·»_times
(*
m
, 
size_t
 
by‹s
, 
·ss
, 
times
,

219 
š‹¿ùive
)

221 
j
;

222 
”rÜs
 = 0;

224 
j
 = 0; j < 
times
; j++) {

225 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Com·»",
·ss
);

226 
”rÜs
 +ğ
	`mem‹¡_com·»
(
m
,
by‹s
,
š‹¿ùive
);

227 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

229  
”rÜs
;

230 
	}
}

237 
	$mem‹¡_‹¡
(*
m
, 
size_t
 
by‹s
, 
·s£s
, 
š‹¿ùive
) {

238 
·ss
 = 0;

239 
”rÜs
 = 0;

241 
·ss
 !ğ
·s£s
) {

242 
·ss
++;

244 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Add»ssšge¡",
·ss
);

245 
”rÜs
 +ğ
	`mem‹¡_add»ssšg
(
m
,
by‹s
,
š‹¿ùive
);

246 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

248 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Rªdom fl",
·ss
);

249 
	`mem‹¡_fl_¿ndom
(
m
,
by‹s
,
š‹¿ùive
);

250 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

251 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4,
š‹¿ùive
);

253 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("SŞid fl",
·ss
);

254 
	`mem‹¡_fl_v®ue
(
m
,
by‹s
,0,()-1,'S',
š‹¿ùive
);

255 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

256 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4,
š‹¿ùive
);

258 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Check”bßrd fl",
·ss
);

259 
	`mem‹¡_fl_v®ue
(
m
,
by‹s
,
ULONG_ONEZERO
,
ULONG_ZEROONE
,'C',
š‹¿ùive
);

260 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

261 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4,
š‹¿ùive
);

263  
”rÜs
;

264 
	}
}

275 
	#MEMTEST_BACKUP_WORDS
 (1024*(1024/()))

	)

279 
	#MEMTEST_DECACHE_SIZE
 (1024*8)

	)

280 
	$mem‹¡_´e£rvšg_‹¡
(*
m
, 
size_t
 
by‹s
, 
·s£s
) {

281 
backup
[
MEMTEST_BACKUP_WORDS
];

282 *
p
 = 
m
;

283 *
’d
 = (*è(((*)
m
)+(
by‹s
-
MEMTEST_DECACHE_SIZE
));

284 
size_t
 
Ëá
 = 
by‹s
;

285 
”rÜs
 = 0;

287 ià(
by‹s
 & 4095)  0;

288 ià(
by‹s
 < 4096*2)  0;

290 
Ëá
) {

294 ià(
Ëá
 == 4096) {

295 
Ëá
 += 4096;

296 
p
 -= 4096/();

299 
·ss
 = 0;

300 
size_t
 
Ën
 = (
Ëá
 > (
backup
)) ? (backup) :†eft;

303 ià(
Ën
/4096 % 2)†en -= 4096;

305 
	`memıy
(
backup
,
p
,
Ën
);

306 
·ss
 !ğ
·s£s
) {

307 
·ss
++;

308 
”rÜs
 +ğ
	`mem‹¡_add»ssšg
(
p
,
Ën
,0);

309 
	`mem‹¡_fl_¿ndom
(
p
,
Ën
,0);

310 ià(
by‹s
 >ğ
MEMTEST_DECACHE_SIZE
) {

311 
	`mem‹¡_com·»_times
(
m
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

312 
	`mem‹¡_com·»_times
(
’d
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

314 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
p
,
Ën
,
·ss
,4,0);

315 
	`mem‹¡_fl_v®ue
(
p
,
Ën
,0,()-1,'S',0);

316 ià(
by‹s
 >ğ
MEMTEST_DECACHE_SIZE
) {

317 
	`mem‹¡_com·»_times
(
m
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

318 
	`mem‹¡_com·»_times
(
’d
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

320 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
p
,
Ën
,
·ss
,4,0);

321 
	`mem‹¡_fl_v®ue
(
p
,
Ën
,
ULONG_ONEZERO
,
ULONG_ZEROONE
,'C',0);

322 ià(
by‹s
 >ğ
MEMTEST_DECACHE_SIZE
) {

323 
	`mem‹¡_com·»_times
(
m
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

324 
	`mem‹¡_com·»_times
(
’d
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

326 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
p
,
Ën
,
·ss
,4,0);

328 
	`memıy
(
p
,
backup
,
Ën
);

329 
Ëá
 -ğ
Ën
;

330 
p
 +ğ
Ën
/();

332  
”rÜs
;

333 
	}
}

336 
	$mem‹¡_®loc_ªd_‹¡
(
size_t
 
megaby‹s
, 
·s£s
) {

337 
size_t
 
by‹s
 = 
megaby‹s
*1024*1024;

338 *
m
 = 
	`m®loc
(
by‹s
);

340 ià(
m
 =ğ
NULL
) {

341 
	`årštf
(
¡d”r
,"Unableo‡llocate %zu megabytes: %s",

342 
megaby‹s
, 
	`¡»¼Ü
(
”ºo
));

343 
	`ex™
(1);

345 
	`mem‹¡_‹¡
(
m
,
by‹s
,
·s£s
,1);

346 
	`ä“
(
m
);

347 
	}
}

349 
	$mem‹¡
(
size_t
 
megaby‹s
, 
·s£s
) {

350 ià(
	`ioùl
(1, 
TIOCGWINSZ
, &
ws
) == -1) {

351 
ws
.
ws_cŞ
 = 80;

352 
ws
.
ws_row
 = 20;

354 
	`mem‹¡_®loc_ªd_‹¡
(
megaby‹s
,
·s£s
);

355 
	`´štf
("\nYour memory…assedhisest.\n");

356 
	`´štf
("Please if you‡re still in doubt usehe followingwoools:\n");

357 
	`´štf
("1) memtest86: http://www.memtest86.com/\n");

358 
	`´štf
("2) memtester: http://pyropus.ca/software/memtester/\n");

359 
	`ex™
(0);

360 
	}
}

	@module.c

1 
	~"£rv”.h
"

2 
	~"şu¡”.h
"

3 
	~<dlfú.h
>

5 
	#REDISMODULE_CORE
 1

	)

6 
	~"»dismoduË.h
"

15 
	sRedisModuË
 {

16 *
	mhªdË
;

17 *
	mÇme
;

18 
	mv”
;

19 
	m­iv”
;

20 
li¡
 *
	mty³s
;

22 
RedisModuË
 
	tRedisModuË
;

24 
diù
 *
	gmoduËs
;

28 
	sAutoMemEÁry
 {

29 *
	m±r
;

30 
	mty³
;

34 
	#REDISMODULE_AM_KEY
 0

	)

35 
	#REDISMODULE_AM_STRING
 1

	)

36 
	#REDISMODULE_AM_REPLY
 2

	)

37 
	#REDISMODULE_AM_FREED
 3

	)

52 
	#REDISMODULE_POOL_ALLOC_MIN_SIZE
 (1024*8)

	)

53 
	#REDISMODULE_POOL_ALLOC_ALIGN
 ((*))

	)

55 
	sRedisModuËPoŞAÎocBlock
 {

56 
ušt32_t
 
	msize
;

57 
ušt32_t
 
	mu£d
;

58 
RedisModuËPoŞAÎocBlock
 *
	mÃxt
;

59 
	mmemÜy
[];

60 } 
	tRedisModuËPoŞAÎocBlock
;

69 
	sRedisModuËCtx
 {

70 *
	mg‘­ifunıŒ
;

71 
RedisModuË
 *
	mmoduË
;

72 
ş›Á
 *
	mş›Á
;

73 
AutoMemEÁry
 *
	mamqueue
;

74 
	mamqueue_Ën
;

75 
	mamqueue_u£d
;

76 
	mæags
;

77 **
	mpo¡pÚed_¬¿ys
;

78 
	mpo¡pÚed_¬¿ys_couÁ
;

81 *
	mkeys_pos
;

82 
	mkeys_couÁ
;

84 
RedisModuËPoŞAÎocBlock
 *
	m·_h—d
;

86 
RedisModuËCtx
 
	tRedisModuËCtx
;

88 
	#REDISMODULE_CTX_INIT
 {(*)()&
RM_G‘Api
, 
NULL
, NULL, NULL, 0, 0, 0, NULL, 0, NULL, 0, NULL}

	)

89 
	#REDISMODULE_CTX_MULTI_EMITTED
 (1<<0)

	)

90 
	#REDISMODULE_CTX_AUTO_MEMORY
 (1<<1)

	)

91 
	#REDISMODULE_CTX_KEYS_POS_REQUEST
 (1<<2)

	)

94 
	sRedisModuËKey
 {

95 
RedisModuËCtx
 *
	mùx
;

96 
»disDb
 *
	mdb
;

97 
robj
 *
	mkey
;

98 
robj
 *
	mv®ue
;

99 *
	m™”
;

100 
	mmode
;

103 
ušt32_t
 
	mzty³
;

104 
z¿nge¥ec
 
	mzrs
;

105 
zËx¿nge¥ec
 
	mzÌs
;

106 
ušt32_t
 
	mz¡¬t
;

107 
ušt32_t
 
	mz’d
;

108 *
	mzcu¼’t
;

109 
	mz”
;

112 
RedisModuËKey
 
	tRedisModuËKey
;

115 
	#REDISMODULE_ZSET_RANGE_NONE
 0

	)

116 
	#REDISMODULE_ZSET_RANGE_LEX
 1

	)

117 
	#REDISMODULE_ZSET_RANGE_SCORE
 2

	)

118 
	#REDISMODULE_ZSET_RANGE_POS
 3

	)

122 (*
	tRedisModuËCmdFunc
è(
	tRedisModuËCtx
 *
	tùx
, **
	t¬gv
, 
	t¬gc
);

125 
	sRedisModuËCommªdProxy
 {

126 
RedisModuË
 *
moduË
;

127 
RedisModuËCmdFunc
 
func
;

128 
»disCommªd
 *
»discmd
;

130 
RedisModuËCommªdProxy
 
	tRedisModuËCommªdProxy
;

132 
	#REDISMODULE_REPLYFLAG_NONE
 0

	)

133 
	#REDISMODULE_REPLYFLAG_TOPARSE
 (1<<0è

	)

134 
	#REDISMODULE_REPLYFLAG_NESTED
 (1<<1è

	)

140 
	sRedisModuËC®lR•ly
 {

141 
RedisModuËCtx
 *
ùx
;

142 
ty³
;

143 
æags
;

144 
size_t
 
Ën
;

145 *
´Ùo
;

146 
size_t
 
´ÙŞ’
;

148 cÚ¡ *
¡r
;

152 
Î
;

153 
RedisModuËC®lR•ly
 *
¬¿y
;

154 } 
v®
;

155 } 
	tRedisModuËC®lR•ly
;

161 
	`RM_F»eC®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
);

162 
	`RM_Clo£Key
(
RedisModuËKey
 *
key
);

163 
	`autoMemÜyCŞËù
(
RedisModuËCtx
 *
ùx
);

164 
robj
 **
	`moduËC»©eArgvFromU£rFÜm©
(cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, *
¬gı
, *
æags
, 
va_li¡
 
­
);

165 
	`moduËR•liÿ‹MuÉiIfN“ded
(
RedisModuËCtx
 *
ùx
);

166 
	`RM_Z£tRªgeStİ
(
RedisModuËKey
 *
kp
);

167 
	`z£tKeyRe£t
(
RedisModuËKey
 *
key
);

177 *
	$RM_AÎoc
(
size_t
 
by‹s
) {

178  
	`zm®loc
(
by‹s
);

179 
	}
}

185 *
	$RM_C®loc
(
size_t
 
nmemb
, size_ˆ
size
) {

186  
	`zÿÎoc
(
nmemb
*
size
);

187 
	}
}

190 * 
	$RM_R—Îoc
(*
±r
, 
size_t
 
by‹s
) {

191  
	`z»®loc
(
±r
,
by‹s
);

192 
	}
}

197 
	$RM_F»e
(*
±r
) {

198 
	`zä“
(
±r
);

199 
	}
}

202 *
	$RM_SŒdup
(cÚ¡ *
¡r
) {

203  
	`z¡rdup
(
¡r
);

204 
	}
}

211 
	$poŞAÎocR–—£
(
RedisModuËCtx
 *
ùx
) {

212 
RedisModuËPoŞAÎocBlock
 *
h—d
 = 
ùx
->
·_h—d
, *
Ãxt
;

214 
h—d
 !ğ
NULL
) {

215 
Ãxt
 = 
h—d
->next;

216 
	`zä“
(
h—d
);

217 
h—d
 = 
Ãxt
;

219 
ùx
->
·_h—d
 = 
NULL
;

220 
	}
}

234 *
	$RM_PoŞAÎoc
(
RedisModuËCtx
 *
ùx
, 
size_t
 
by‹s
) {

235 ià(
by‹s
 =ğ0è 
NULL
;

236 
RedisModuËPoŞAÎocBlock
 *
b
 = 
ùx
->
·_h—d
;

237 
size_t
 
Ëá
 = 
b
 ? b->
size
 - b->
u£d
 : 0;

240 ià(
Ëá
 >ğ
by‹s
) {

241 
size_t
 
®ignm’t
 = 
REDISMODULE_POOL_ALLOC_ALIGN
;

242 
by‹s
 < 
®ignm’t
 &&‡lignment/2 >= bytes)‡lignment /= 2;

243 ià(
b
->
u£d
 % 
®ignm’t
)

244 
b
->
u£d
 +ğ
®ignm’t
 - (b->used %‡lignment);

245 
Ëá
 = (
b
->
u£d
 > b->
size
) ? 0 : b->size - b->used;

249 ià(
Ëá
 < 
by‹s
) {

250 
size_t
 
blocksize
 = 
REDISMODULE_POOL_ALLOC_MIN_SIZE
;

251 ià(
blocksize
 < 
by‹s
) blocksize = bytes;

252 
b
 = 
	`zm®loc
((*bè+ 
blocksize
);

253 
b
->
size
 = 
blocksize
;

254 
b
->
u£d
 = 0;

255 
b
->
Ãxt
 = 
ùx
->
·_h—d
;

256 
ùx
->
·_h—d
 = 
b
;

259 *
»tv®
 = 
b
->
memÜy
 + b->
u£d
;

260 
b
->
u£d
 +ğ
by‹s
;

261  
»tv®
;

262 
	}
}

280 
	$moduËC»©eEm±yKey
(
RedisModuËKey
 *
key
, 
ty³
) {

281 
robj
 *
obj
;

284 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
v®ue
)

285  
REDISMODULE_ERR
;

287 
ty³
) {

288 
REDISMODULE_KEYTYPE_LIST
:

289 
obj
 = 
	`ü—‹Quickli¡Objeù
();

290 
	`quickli¡S‘O±iÚs
(
obj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

291 
£rv”
.
li¡_com´ess_d•th
);

293 
REDISMODULE_KEYTYPE_ZSET
:

294 
obj
 = 
	`ü—‹Z£tZli¡Objeù
();

296 
REDISMODULE_KEYTYPE_HASH
:

297 
obj
 = 
	`ü—‹HashObjeù
();

299 :  
REDISMODULE_ERR
;

301 
	`dbAdd
(
key
->
db
,key->key,
obj
);

302 
key
->
v®ue
 = 
obj
;

303  
REDISMODULE_OK
;

304 
	}
}

316 
	$moduËD–KeyIfEm±y
(
RedisModuËKey
 *
key
) {

317 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
v®ue
 =ğ
NULL
)  0;

318 
i£m±y
;

319 
robj
 *
o
 = 
key
->
v®ue
;

321 
o
->
ty³
) {

322 
OBJ_LIST
: 
i£m±y
 = 
	`li¡Ty³L’gth
(
o
) == 0; ;

323 
OBJ_SET
: 
i£m±y
 = 
	`£tTy³Size
(
o
) == 0; ;

324 
OBJ_ZSET
: 
i£m±y
 = 
	`z£tL’gth
(
o
) == 0; ;

325 
OBJ_HASH
 : 
i£m±y
 = 
	`hashTy³L’gth
(
o
) == 0; ;

326 : 
i£m±y
 = 0;

329 ià(
i£m±y
) {

330 
	`dbD–‘e
(
key
->
db
,key->key);

331 
key
->
v®ue
 = 
NULL
;

336 
	}
}

354 
	$RM_G‘Api
(cÚ¡ *
funúame
, **
rg‘PŒPŒ
) {

355 
diùEÁry
 *
he
 = 
	`diùFšd
(
£rv”
.
moduË­i
, 
funúame
);

356 ià(!
he
è 
REDISMODULE_ERR
;

357 *
rg‘PŒPŒ
 = 
	`diùG‘V®
(
he
);

358  
REDISMODULE_OK
;

359 
	}
}

362 
	$moduËF»eCÚ‹xt
(
RedisModuËCtx
 *
ùx
) {

363 
	`autoMemÜyCŞËù
(
ùx
);

364 
	`poŞAÎocR–—£
(
ùx
);

365 ià(
ùx
->
po¡pÚed_¬¿ys
) {

366 
	`zä“
(
ùx
->
po¡pÚed_¬¿ys
);

367 
ùx
->
po¡pÚed_¬¿ys_couÁ
 = 0;

368 
	`£rv”Log
(
LL_WARNING
,

373 
ùx
->
moduË
->
Çme
);

375 
	}
}

379 
	$RedisModuËCommªdDi¥©ch”
(
ş›Á
 *
c
) {

380 
RedisModuËCommªdProxy
 *
ı
 = (*)()
c
->
cmd
->
g‘keys_´oc
;

381 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

383 
ùx
.
moduË
 = 
ı
->module;

384 
ùx
.
ş›Á
 = 
c
;

385 
ı
->
	`func
(&
ùx
,(**)
c
->
¬gv
,c->
¬gc
);

386 
	`´ev’tCommªdPrİag©iÚ
(
c
);

390 ià(
ùx
.
æags
 & 
REDISMODULE_CTX_MULTI_EMITTED
) {

391 
robj
 *
´İ¬gv
[1];

392 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("EXEC",4);

393 
	`®soPrİag©e
(
£rv”
.
execCommªd
,
c
->
db
->
id
,
´İ¬gv
,1,

394 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

395 
	`deüRefCouÁ
(
´İ¬gv
[0]);

397 
	`moduËF»eCÚ‹xt
(&
ùx
);

398 
	}
}

409 *
	$moduËG‘CommªdKeysVŸAPI
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

410 
RedisModuËCommªdProxy
 *
ı
 = (*)()
cmd
->
g‘keys_´oc
;

411 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

413 
ùx
.
moduË
 = 
ı
->module;

414 
ùx
.
ş›Á
 = 
NULL
;

415 
ùx
.
æags
 |ğ
REDISMODULE_CTX_KEYS_POS_REQUEST
;

416 
ı
->
	`func
(&
ùx
,(**)
¬gv
,
¬gc
);

417 *
»s
 = 
ùx
.
keys_pos
;

418 ià(
numkeys
è*numkey ğ
ùx
.
keys_couÁ
;

419 
	`moduËF»eCÚ‹xt
(&
ùx
);

420  
»s
;

421 
	}
}

426 
	$RM_IsKeysPos™iÚReque¡
(
RedisModuËCtx
 *
ùx
) {

427  (
ùx
->
æags
 & 
REDISMODULE_CTX_KEYS_POS_REQUEST
) != 0;

428 
	}
}

444 
	$RM_KeyAtPos
(
RedisModuËCtx
 *
ùx
, 
pos
) {

445 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_KEYS_POS_REQUEST
)) ;

446 ià(
pos
 <= 0) ;

447 
ùx
->
keys_pos
 = 
	`z»®loc
(ùx->keys_pos,()*(ùx->
keys_couÁ
+1));

448 
ùx
->
keys_pos
[ùx->
keys_couÁ
++] = 
pos
;

449 
	}
}

455 
	$commªdFÏgsFromSŒšg
(*
s
) {

456 
couÁ
, 
j
;

457 
æags
 = 0;

458 
sds
 *
tok’s
 = 
	`sds¥l™Ën
(
s
,
	`¡¾’
(s)," ",1,&
couÁ
);

459 
j
 = 0; j < 
couÁ
; j++) {

460 *
t
 = 
tok’s
[
j
];

461 ià(!
	`¡rÿ£cmp
(
t
,"wr™e")è
æags
 |ğ
CMD_WRITE
;

462 ià(!
	`¡rÿ£cmp
(
t
,"»adÚly")è
æags
 |ğ
CMD_READONLY
;

463 ià(!
	`¡rÿ£cmp
(
t
,"admš")è
æags
 |ğ
CMD_ADMIN
;

464 ià(!
	`¡rÿ£cmp
(
t
,"d’y-oom")è
æags
 |ğ
CMD_DENYOOM
;

465 ià(!
	`¡rÿ£cmp
(
t
,"d’y-süt")è
æags
 |ğ
CMD_NOSCRIPT
;

466 ià(!
	`¡rÿ£cmp
(
t
,"®low-lßdšg")è
æags
 |ğ
CMD_LOADING
;

467 ià(!
	`¡rÿ£cmp
(
t
,"pubsub")è
æags
 |ğ
CMD_PUBSUB
;

468 ià(!
	`¡rÿ£cmp
(
t
,"¿ndom")è
æags
 |ğ
CMD_RANDOM
;

469 ià(!
	`¡rÿ£cmp
(
t
,"®low-¡®e")è
æags
 |ğ
CMD_STALE
;

470 ià(!
	`¡rÿ£cmp
(
t
,"no-mÚ™Ü")è
æags
 |ğ
CMD_SKIP_MONITOR
;

471 ià(!
	`¡rÿ£cmp
(
t
,"ç¡")è
æags
 |ğ
CMD_FAST
;

472 ià(!
	`¡rÿ£cmp
(
t
,"g‘keys-­i")è
æags
 |ğ
CMD_MODULE_GETKEYS
;

473 ià(!
	`¡rÿ£cmp
(
t
,"no-şu¡”")è
æags
 |ğ
CMD_MODULE_NO_CLUSTER
;

476 
	`sdsä“¥l™»s
(
tok’s
,
couÁ
);

477 ià(
j
 !ğ
couÁ
)  -1;

478  
æags
;

479 
	}
}

534 
	$RM_C»©eCommªd
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
RedisModuËCmdFunc
 
cmdfunc
, cÚ¡ *
¡ræags
, 
fœ¡key
, 
Ï¡key
, 
key¡•
) {

535 
æags
 = 
¡ræags
 ? 
	`commªdFÏgsFromSŒšg
((*)strflags) : 0;

536 ià(
æags
 =ğ-1è 
REDISMODULE_ERR
;

537 ià((
æags
 & 
CMD_MODULE_NO_CLUSTER
è&& 
£rv”
.
şu¡”_’abËd
)

538  
REDISMODULE_ERR
;

540 
»disCommªd
 *
»discmd
;

541 
RedisModuËCommªdProxy
 *
ı
;

542 
sds
 
cmdÇme
 = 
	`sd¢ew
(
Çme
);

545 ià(
	`lookupCommªd
((*)
Çme
è!ğ
NULL
) {

546 
	`sdsä“
(
cmdÇme
);

547  
REDISMODULE_ERR
;

557 
ı
 = 
	`zm®loc
((*cp));

558 
ı
->
moduË
 = 
ùx
->module;

559 
ı
->
func
 = 
cmdfunc
;

560 
ı
->
»discmd
 = 
	`zm®loc
((*rediscmd));

561 
ı
->
»discmd
->
Çme
 = 
cmdÇme
;

562 
ı
->
»discmd
->
´oc
 = 
RedisModuËCommªdDi¥©ch”
;

563 
ı
->
»discmd
->
¬™y
 = -1;

564 
ı
->
»discmd
->
æags
 = fÏg | 
CMD_MODULE
;

565 
ı
->
»discmd
->
g‘keys_´oc
 = (
»disG‘KeysProc
*)()cp;

566 
ı
->
»discmd
->
fœ¡key
 = firstkey;

567 
ı
->
»discmd
->
Ï¡key
 =†astkey;

568 
ı
->
»discmd
->
key¡•
 = keystep;

569 
ı
->
»discmd
->
miüo£cÚds
 = 0;

570 
ı
->
»discmd
->
ÿÎs
 = 0;

571 
	`diùAdd
(
£rv”
.
commªds
,
	`sdsdup
(
cmdÇme
),
ı
->
»discmd
);

572 
	`diùAdd
(
£rv”
.
Üig_commªds
,
	`sdsdup
(
cmdÇme
),
ı
->
»discmd
);

573  
REDISMODULE_OK
;

574 
	}
}

580 
	$RM_S‘ModuËA‰ribs
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
){

581 
RedisModuË
 *
moduË
;

583 ià(
ùx
->
moduË
 !ğ
NULL
) ;

584 
moduË
 = 
	`zm®loc
((*module));

585 
moduË
->
Çme
 = 
	`sd¢ew
((*)name);

586 
moduË
->
v”
 = ver;

587 
moduË
->
­iv”
 =‡piver;

588 
moduË
->
ty³s
 = 
	`li¡C»©e
();

589 
ùx
->
moduË
 = module;

590 
	}
}

600 
	$RM_AutoMemÜy
(
RedisModuËCtx
 *
ùx
) {

601 
ùx
->
æags
 |ğ
REDISMODULE_CTX_AUTO_MEMORY
;

602 
	}
}

605 
	$autoMemÜyAdd
(
RedisModuËCtx
 *
ùx
, 
ty³
, *
±r
) {

606 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_AUTO_MEMORY
)) ;

607 ià(
ùx
->
amqueue_u£d
 =ğùx->
amqueue_Ën
) {

608 
ùx
->
amqueue_Ën
 *= 2;

609 ià(
ùx
->
amqueue_Ën
 < 16) ctx->amqueue_len = 16;

610 
ùx
->
amqueue
 = 
	`z»®loc
(ùx->amqueue,(
AutoMemEÁry
)*ùx->
amqueue_Ën
);

612 
ùx
->
amqueue
[ùx->
amqueue_u£d
].
ty³
 =ype;

613 
ùx
->
amqueue
[ùx->
amqueue_u£d
].
±r
 =…tr;

614 
ùx
->
amqueue_u£d
++;

615 
	}
}

619 
	$autoMemÜyF»ed
(
RedisModuËCtx
 *
ùx
, 
ty³
, *
±r
) {

620 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_AUTO_MEMORY
)) ;

622 
couÁ
 = (
ùx
->
amqueue_u£d
+1)/2;

623 
j
 = 0; j < 
couÁ
; j++) {

624 
side
 = 0; side < 2; side++) {

627 
i
 = (
side
 =ğ0è? (
ùx
->
amqueue_u£d
 - 1 - 
j
) : j;

628 ià(
ùx
->
amqueue
[
i
].
ty³
 ==ype &&

629 
ùx
->
amqueue
[
i
].
±r
 ==…tr)

631 
ùx
->
amqueue
[
i
].
ty³
 = 
REDISMODULE_AM_FREED
;

635 ià(
i
 !ğ
ùx
->
amqueue_u£d
-1) {

636 
ùx
->
amqueue
[
i
] = ctx->amqueue[ùx->
amqueue_u£d
-1];

641 
ùx
->
amqueue_u£d
--;

646 
	}
}

649 
	$autoMemÜyCŞËù
(
RedisModuËCtx
 *
ùx
) {

650 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_AUTO_MEMORY
)) ;

654 
ùx
->
æags
 &ğ~
REDISMODULE_CTX_AUTO_MEMORY
;

655 
j
;

656 
j
 = 0; j < 
ùx
->
amqueue_u£d
; j++) {

657 *
±r
 = 
ùx
->
amqueue
[
j
].ptr;

658 
ùx
->
amqueue
[
j
].
ty³
) {

659 
REDISMODULE_AM_STRING
: 
	`deüRefCouÁ
(
±r
); ;

660 
REDISMODULE_AM_REPLY
: 
	`RM_F»eC®lR•ly
(
±r
); ;

661 
REDISMODULE_AM_KEY
: 
	`RM_Clo£Key
(
±r
); ;

664 
ùx
->
æags
 |ğ
REDISMODULE_CTX_AUTO_MEMORY
;

665 
	`zä“
(
ùx
->
amqueue
);

666 
ùx
->
amqueue
 = 
NULL
;

667 
ùx
->
amqueue_Ën
 = 0;

668 
ùx
->
amqueue_u£d
 = 0;

669 
	}
}

680 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšg
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
±r
, 
size_t
 
Ën
)

682 
RedisModuËSŒšg
 *
o
 = 
	`ü—‹SŒšgObjeù
(
±r
,
Ën
);

683 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_STRING
,
o
);

684  
o
;

685 
	}
}

692 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgFromLÚgLÚg
(
RedisModuËCtx
 *
ùx
, 
Î
) {

693 
buf
[
LONG_STR_SIZE
];

694 
size_t
 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
Î
);

695  
	`RM_C»©eSŒšg
(
ùx
,
buf
,
Ën
);

696 
	}
}

703 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgFromSŒšg
(
RedisModuËCtx
 *
ùx
, cÚ¡ 
RedisModuËSŒšg
 *
¡r
) {

704 
RedisModuËSŒšg
 *
o
 = 
	`dupSŒšgObjeù
(
¡r
);

705 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_STRING
,
o
);

706  
o
;

707 
	}
}

715 
	$RM_F»eSŒšg
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
) {

716 
	`deüRefCouÁ
(
¡r
);

717 
	`autoMemÜyF»ed
(
ùx
,
REDISMODULE_AM_STRING
,
¡r
);

718 
	}
}

723 cÚ¡ *
	$RM_SŒšgPŒL’
(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, 
size_t
 *
Ën
) {

724 ià(
Ën
è*ËÀğ
	`sd¦’
(
¡r
->
±r
);

725  
¡r
->
±r
;

726 
	}
}

732 
	$RM_SŒšgToLÚgLÚg
(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
Î
) {

733  
	`¡ršg2Î
(
¡r
->
±r
,
	`sd¦’
(¡r->±r),
Î
è? 
REDISMODULE_OK
 :

734 
REDISMODULE_ERR
;

735 
	}
}

740 
	$RM_SŒšgToDoubË
(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
d
) {

741 
»tv®
 = 
	`g‘DoubËFromObjeù
(
¡r
,
d
);

742  (
»tv®
 =ğ
C_OK
è? 
REDISMODULE_OK
 : 
REDISMODULE_ERR
;

743 
	}
}

762 
	$RM_WrÚgAr™y
(
RedisModuËCtx
 *
ùx
) {

763 
	`addR•lyE¼ÜFÜm©
(
ùx
->
ş›Á
,

765 (*)
ùx
->
ş›Á
->
¬gv
[0]->
±r
);

766  
REDISMODULE_OK
;

767 
	}
}

771 
	$RM_R•lyW™hLÚgLÚg
(
RedisModuËCtx
 *
ùx
, 
Î
) {

772 
	`addR•lyLÚgLÚg
(
ùx
->
ş›Á
,
Î
);

773  
REDISMODULE_OK
;

774 
	}
}

779 
	$»¶yW™hStus
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
msg
, *
´efix
) {

780 
sds
 
¡rmsg
 = 
	`sd¢ewËn
(
´efix
,1);

781 
¡rmsg
 = 
	`sdsÿt
(¡rmsg,
msg
);

782 
¡rmsg
 = 
	`sdsÿ’
(strmsg,"\r\n",2);

783 
	`addR•lySds
(
ùx
->
ş›Á
,
¡rmsg
);

784  
REDISMODULE_OK
;

785 
	}
}

801 
	$RM_R•lyW™hE¼Ü
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
”r
) {

802  
	`»¶yW™hStus
(
ùx
,
”r
,"-");

803 
	}
}

810 
	$RM_R•lyW™hSim¶eSŒšg
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
msg
) {

811  
	`»¶yW™hStus
(
ùx
,
msg
,"+");

812 
	}
}

825 
	$RM_R•lyW™hA¼ay
(
RedisModuËCtx
 *
ùx
, 
Ën
) {

826 ià(
Ën
 =ğ
REDISMODULE_POSTPONED_ARRAY_LEN
) {

827 
ùx
->
po¡pÚed_¬¿ys
 = 
	`z»®loc
(ctx->postponed_arrays,(*)*

828 (
ùx
->
po¡pÚed_¬¿ys_couÁ
+1));

829 
ùx
->
po¡pÚed_¬¿ys
[ùx->
po¡pÚed_¬¿ys_couÁ
] =

830 
	`addDeã¼edMuÉiBulkL’gth
(
ùx
->
ş›Á
);

831 
ùx
->
po¡pÚed_¬¿ys_couÁ
++;

833 
	`addR•lyMuÉiBulkL’
(
ùx
->
ş›Á
,
Ën
);

835  
REDISMODULE_OK
;

836 
	}
}

864 
	$RM_R•lyS‘A¼ayL’gth
(
RedisModuËCtx
 *
ùx
, 
Ën
) {

865 ià(
ùx
->
po¡pÚed_¬¿ys_couÁ
 == 0) {

866 
	`£rv”Log
(
LL_WARNING
,

870 "ÿÎ.", 
ùx
->
moduË
->
Çme
);

873 
ùx
->
po¡pÚed_¬¿ys_couÁ
--;

874 
	`£tDeã¼edMuÉiBulkL’gth
(
ùx
->
ş›Á
,

875 
ùx
->
po¡pÚed_¬¿ys
[ùx->
po¡pÚed_¬¿ys_couÁ
],

876 
Ën
);

877 ià(
ùx
->
po¡pÚed_¬¿ys_couÁ
 == 0) {

878 
	`zä“
(
ùx
->
po¡pÚed_¬¿ys
);

879 
ùx
->
po¡pÚed_¬¿ys
 = 
NULL
;

881 
	}
}

886 
	$RM_R•lyW™hSŒšgBufãr
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

887 
	`addR•lyBulkCBufãr
(
ùx
->
ş›Á
,(*)
buf
,
Ën
);

888  
REDISMODULE_OK
;

889 
	}
}

894 
	$RM_R•lyW™hSŒšg
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
) {

895 
	`addR•lyBulk
(
ùx
->
ş›Á
,
¡r
);

896  
REDISMODULE_OK
;

897 
	}
}

903 
	$RM_R•lyW™hNuÎ
(
RedisModuËCtx
 *
ùx
) {

904 
	`addR•ly
(
ùx
->
ş›Á
,
sh¬ed
.
nuÎbulk
);

905  
REDISMODULE_OK
;

906 
	}
}

914 
	$RM_R•lyW™hC®lR•ly
(
RedisModuËCtx
 *
ùx
, 
RedisModuËC®lR•ly
 *
»¶y
) {

915 
sds
 
´Ùo
 = 
	`sd¢ewËn
(
»¶y
->´Ùo,„•ly->
´ÙŞ’
);

916 
	`addR•lySds
(
ùx
->
ş›Á
,
´Ùo
);

917  
REDISMODULE_OK
;

918 
	}
}

926 
	$RM_R•lyW™hDoubË
(
RedisModuËCtx
 *
ùx
, 
d
) {

927 
	`addR•lyDoubË
(
ùx
->
ş›Á
,
d
);

928  
REDISMODULE_OK
;

929 
	}
}

938 
	$moduËR•liÿ‹MuÉiIfN“ded
(
RedisModuËCtx
 *
ùx
) {

939 ià(
ùx
->
æags
 & 
REDISMODULE_CTX_MULTI_EMITTED
) ;

940 
	`execCommªdPrİag©eMuÉi
(
ùx
->
ş›Á
);

941 
ùx
->
æags
 |ğ
REDISMODULE_CTX_MULTI_EMITTED
;

942 
	}
}

963 
	$RM_R•liÿ‹
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...) {

964 
»disCommªd
 *
cmd
;

965 
robj
 **
¬gv
 = 
NULL
;

966 
¬gc
 = 0, 
æags
 = 0, 
j
;

967 
va_li¡
 
­
;

969 
cmd
 = 
	`lookupCommªdByCSŒšg
((*)
cmdÇme
);

970 ià(!
cmd
è 
REDISMODULE_ERR
;

973 
	`va_¡¬t
(
­
, 
fmt
);

974 
¬gv
 = 
	`moduËC»©eArgvFromU£rFÜm©
(
cmdÇme
,
fmt
,&
¬gc
,&
æags
,
­
);

975 
	`va_’d
(
­
);

976 ià(
¬gv
 =ğ
NULL
è 
REDISMODULE_ERR
;

979 
	`moduËR•liÿ‹MuÉiIfN“ded
(
ùx
);

980 
	`®soPrİag©e
(
cmd
,
ùx
->
ş›Á
->
db
->
id
,
¬gv
,
¬gc
,

981 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

984 
j
 = 0; j < 
¬gc
; j++è
	`deüRefCouÁ
(
¬gv
[j]);

985 
	`zä“
(
¬gv
);

986  
REDISMODULE_OK
;

987 
	}
}

1000 
	$RM_R•liÿ‹V”b©im
(
RedisModuËCtx
 *
ùx
) {

1001 
	`®soPrİag©e
(
ùx
->
ş›Á
->
cmd
,ùx->ş›Á->
db
->
id
,

1002 
ùx
->
ş›Á
->
¬gv
,ùx->ş›Á->
¬gc
,

1003 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

1004  
REDISMODULE_OK
;

1005 
	}
}

1022 
	$RM_G‘Cl›ÁId
(
RedisModuËCtx
 *
ùx
) {

1023 ià(
ùx
->
ş›Á
 =ğ
NULL
)  0;

1024  
ùx
->
ş›Á
->
id
;

1025 
	}
}

1028 
	$RM_G‘S–eùedDb
(
RedisModuËCtx
 *
ùx
) {

1029  
ùx
->
ş›Á
->
db
->
id
;

1030 
	}
}

1042 
	$RM_S–eùDb
(
RedisModuËCtx
 *
ùx
, 
Ãwid
) {

1043 
»tv®
 = 
	`£ËùDb
(
ùx
->
ş›Á
,
Ãwid
);

1044  (
»tv®
 =ğ
C_OK
è? 
REDISMODULE_OK
 : 
REDISMODULE_ERR
;

1045 
	}
}

1061 *
	$RM_O³nKey
(
RedisModuËCtx
 *
ùx
, 
robj
 *
keyÇme
, 
mode
) {

1062 
RedisModuËKey
 *
kp
;

1063 
robj
 *
v®ue
;

1065 ià(
mode
 & 
REDISMODULE_WRITE
) {

1066 
v®ue
 = 
	`lookupKeyWr™e
(
ùx
->
ş›Á
->
db
,
keyÇme
);

1068 
v®ue
 = 
	`lookupKeyR—d
(
ùx
->
ş›Á
->
db
,
keyÇme
);

1069 ià(
v®ue
 =ğ
NULL
) {

1070  
NULL
;

1075 
kp
 = 
	`zm®loc
((*kp));

1076 
kp
->
ùx
 = ctx;

1077 
kp
->
db
 = 
ùx
->
ş›Á
->db;

1078 
kp
->
key
 = 
keyÇme
;

1079 
	`šüRefCouÁ
(
keyÇme
);

1080 
kp
->
v®ue
 = value;

1081 
kp
->
™”
 = 
NULL
;

1082 
kp
->
mode
 = mode;

1083 
	`z£tKeyRe£t
(
kp
);

1084 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_KEY
,
kp
);

1085  (*)
kp
;

1086 
	}
}

1089 
	$RM_Clo£Key
(
RedisModuËKey
 *
key
) {

1090 ià(
key
 =ğ
NULL
) ;

1091 ià(
key
->
mode
 & 
REDISMODULE_WRITE
è
	`sigÇlModif›dKey
(key->
db
,key->key);

1093 
	`RM_Z£tRªgeStİ
(
key
);

1094 
	`deüRefCouÁ
(
key
->key);

1095 
	`autoMemÜyF»ed
(
key
->
ùx
,
REDISMODULE_AM_KEY
,key);

1096 
	`zä“
(
key
);

1097 
	}
}

1101 
	$RM_KeyTy³
(
RedisModuËKey
 *
key
) {

1102 ià(
key
 =ğ
NULL
 || key->
v®ue
 =ğNULLè 
REDISMODULE_KEYTYPE_EMPTY
;

1105 
key
->
v®ue
->
ty³
) {

1106 
OBJ_STRING
:  
REDISMODULE_KEYTYPE_STRING
;

1107 
OBJ_LIST
:  
REDISMODULE_KEYTYPE_LIST
;

1108 
OBJ_SET
:  
REDISMODULE_KEYTYPE_SET
;

1109 
OBJ_ZSET
:  
REDISMODULE_KEYTYPE_ZSET
;

1110 
OBJ_HASH
:  
REDISMODULE_KEYTYPE_HASH
;

1111 
OBJ_MODULE
:  
REDISMODULE_KEYTYPE_MODULE
;

1114 
	}
}

1121 
size_t
 
	$RM_V®ueL’gth
(
RedisModuËKey
 *
key
) {

1122 ià(
key
 =ğ
NULL
 || key->
v®ue
 == NULL)  0;

1123 
key
->
v®ue
->
ty³
) {

1124 
OBJ_STRING
:  
	`¡ršgObjeùL’
(
key
->
v®ue
);

1125 
OBJ_LIST
:  
	`li¡Ty³L’gth
(
key
->
v®ue
);

1126 
OBJ_SET
:  
	`£tTy³Size
(
key
->
v®ue
);

1127 
OBJ_ZSET
:  
	`z£tL’gth
(
key
->
v®ue
);

1128 
OBJ_HASH
:  
	`hashTy³L’gth
(
key
->
v®ue
);

1131 
	}
}

1137 
	$RM_D–‘eKey
(
RedisModuËKey
 *
key
) {

1138 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1139 ià(
key
->
v®ue
) {

1140 
	`dbD–‘e
(
key
->
db
,key->key);

1141 
key
->
v®ue
 = 
NULL
;

1143  
REDISMODULE_OK
;

1144 
	}
}

1149 
m¡ime_t
 
	$RM_G‘Expœe
(
RedisModuËKey
 *
key
) {

1150 
m¡ime_t
 
expœe
 = 
	`g‘Expœe
(
key
->
db
,key->key);

1151 ià(
expœe
 =ğ-1 || 
key
->
v®ue
 =ğ
NULL
)  -1;

1152 
expœe
 -ğ
	`m¡ime
();

1153  
expœe
 >= 0 ?ƒxpire : 0;

1154 
	}
}

1165 
	$RM_S‘Expœe
(
RedisModuËKey
 *
key
, 
m¡ime_t
 
expœe
) {

1166 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
v®ue
 =ğ
NULL
)

1167  
REDISMODULE_ERR
;

1168 ià(
expœe
 !ğ
REDISMODULE_NO_EXPIRE
) {

1169 
expœe
 +ğ
	`m¡ime
();

1170 
	`£tExpœe
(
key
->
db
,key->key,
expœe
);

1172 
	`»moveExpœe
(
key
->
db
,key->key);

1174  
REDISMODULE_OK
;

1175 
	}
}

1185 
	$RM_SŒšgS‘
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
¡r
) {

1186 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
™”
è 
REDISMODULE_ERR
;

1187 
	`RM_D–‘eKey
(
key
);

1188 
	`£tKey
(
key
->
db
,key->key,
¡r
);

1189 
key
->
v®ue
 = 
¡r
;

1190  
REDISMODULE_OK
;

1191 
	}
}

1222 *
	$RM_SŒšgDMA
(
RedisModuËKey
 *
key
, 
size_t
 *
Ën
, 
mode
) {

1227 *
em±y¡ršg
 = "<dma-empty-string>";

1228 ià(
key
->
v®ue
 =ğ
NULL
) {

1229 *
Ën
 = 0;

1230  
em±y¡ršg
;

1233 ià(
key
->
v®ue
->
ty³
 !ğ
OBJ_STRING
è 
NULL
;

1237 ià((
mode
 & 
REDISMODULE_WRITE
è|| 
key
->
v®ue
->
’codšg
 !ğ
OBJ_ENCODING_RAW
)

1238 
key
->
v®ue
 = 
	`dbUnsh¬eSŒšgV®ue
(key->
db
, key->key, key->value);

1240 *
Ën
 = 
	`sd¦’
(
key
->
v®ue
->
±r
);

1241  
key
->
v®ue
->
±r
;

1242 
	}
}

1256 
	$RM_SŒšgTrunÿ‹
(
RedisModuËKey
 *
key
, 
size_t
 
ÃwËn
) {

1257 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1258 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_STRING
è 
REDISMODULE_ERR
;

1259 ià(
ÃwËn
 > 512*1024*1024è 
REDISMODULE_ERR
;

1263 ià(
key
->
v®ue
 =ğ
NULL
 && 
ÃwËn
 =ğ0è 
REDISMODULE_OK
;

1265 ià(
key
->
v®ue
 =ğ
NULL
) {

1267 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
ÃwËn
));

1268 
	`£tKey
(
key
->
db
,key->key,
o
);

1269 
key
->
v®ue
 = 
o
;

1270 
	`deüRefCouÁ
(
o
);

1273 
key
->
v®ue
 = 
	`dbUnsh¬eSŒšgV®ue
(key->
db
, key->key, key->value);

1274 
size_t
 
cu¾’
 = 
	`sd¦’
(
key
->
v®ue
->
±r
);

1275 ià(
ÃwËn
 > 
cu¾’
) {

1276 
key
->
v®ue
->
±r
 = 
	`sdsgrowz”o
(key->v®ue->±r,
ÃwËn
);

1277 } ià(
ÃwËn
 < 
cu¾’
) {

1278 
	`sd¤ªge
(
key
->
v®ue
->
±r
,0,
ÃwËn
-1);

1280 ià(
	`sd¦’
(
key
->
v®ue
->
±r
è< 
	`sd§va
(key->value->ptr))

1281 
key
->
v®ue
->
±r
 = 
	`sdsRemoveF»eS·û
(key->value->ptr);

1284  
REDISMODULE_OK
;

1285 
	}
}

1295 
	$RM_Li¡Push
(
RedisModuËKey
 *
key
, 
wh”e
, 
RedisModuËSŒšg
 *
–e
) {

1296 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1297 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_LIST
è 
REDISMODULE_ERR
;

1298 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_LIST
);

1299 
	`li¡Ty³Push
(
key
->
v®ue
, 
–e
,

1300 (
wh”e
 =ğ
REDISMODULE_LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
);

1301  
REDISMODULE_OK
;

1302 
	}
}

1311 
RedisModuËSŒšg
 *
	$RM_Li¡Pİ
(
RedisModuËKey
 *
key
, 
wh”e
) {

1312 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
) ||

1313 
key
->
v®ue
 =ğ
NULL
 ||

1314 
key
->
v®ue
->
ty³
 !ğ
OBJ_LIST
è 
NULL
;

1315 
robj
 *
–e
 = 
	`li¡Ty³Pİ
(
key
->
v®ue
,

1316 (
wh”e
 =ğ
REDISMODULE_LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
);

1317 
robj
 *
decoded
 = 
	`g‘DecodedObjeù
(
–e
);

1318 
	`deüRefCouÁ
(
–e
);

1319 
	`moduËD–KeyIfEm±y
(
key
);

1320 
	`autoMemÜyAdd
(
key
->
ùx
,
REDISMODULE_AM_STRING
,
decoded
);

1321  
decoded
;

1322 
	}
}

1330 
	$RM_Z£tAddFÏgsToCÜeFÏgs
(
æags
) {

1331 
»tæags
 = 0;

1332 ià(
æags
 & 
REDISMODULE_ZADD_XX
è
»tæags
 |ğ
ZADD_XX
;

1333 ià(
æags
 & 
REDISMODULE_ZADD_NX
è
»tæags
 |ğ
ZADD_NX
;

1334  
»tæags
;

1335 
	}
}

1338 
	$RM_Z£tAddFÏgsFromCÜeFÏgs
(
æags
) {

1339 
»tæags
 = 0;

1340 ià(
æags
 & 
ZADD_ADDED
è
»tæags
 |ğ
REDISMODULE_ZADD_ADDED
;

1341 ià(
æags
 & 
ZADD_UPDATED
è
»tæags
 |ğ
REDISMODULE_ZADD_UPDATED
;

1342 ià(
æags
 & 
ZADD_NOP
è
»tæags
 |ğ
REDISMODULE_ZADD_NOP
;

1343  
»tæags
;

1344 
	}
}

1374 
	$RM_Z£tAdd
(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
) {

1375 
æags
 = 0;

1376 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1377 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1378 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_ZSET
);

1379 ià(
æag¥Œ
è
æags
 = 
	`RM_Z£tAddFÏgsToCÜeFÏgs
(*flagsptr);

1380 ià(
	`z£tAdd
(
key
->
v®ue
,
scÜe
,
–e
->
±r
,&
æags
,
NULL
) == 0) {

1381 ià(
æag¥Œ
) *flagsptr = 0;

1382  
REDISMODULE_ERR
;

1384 ià(
æag¥Œ
è*æag¥Œ = 
	`RM_Z£tAddFÏgsFromCÜeFÏgs
(
æags
);

1385  
REDISMODULE_OK
;

1386 
	}
}

1401 
	$RM_Z£tInüby
(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
, *
ÃwscÜe
) {

1402 
æags
 = 0;

1403 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1404 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1405 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_ZSET
);

1406 ià(
æag¥Œ
è
æags
 = 
	`RM_Z£tAddFÏgsToCÜeFÏgs
(*flagsptr);

1407 
æags
 |ğ
ZADD_INCR
;

1408 ià(
	`z£tAdd
(
key
->
v®ue
,
scÜe
,
–e
->
±r
,&
æags
,
ÃwscÜe
) == 0) {

1409 ià(
æag¥Œ
) *flagsptr = 0;

1410  
REDISMODULE_ERR
;

1413 ià(
æag¥Œ
 && (*æag¥Œ & 
ZADD_NAN
)) {

1414 *
æag¥Œ
 = 0;

1415  
REDISMODULE_ERR
;

1417 ià(
æag¥Œ
è*æag¥Œ = 
	`RM_Z£tAddFÏgsFromCÜeFÏgs
(
æags
);

1418  
REDISMODULE_OK
;

1419 
	}
}

1439 
	$RM_Z£tRem
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
d–‘ed
) {

1440 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1441 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1442 ià(
key
->
v®ue
 !ğ
NULL
 && 
	`z£tD–
(key->v®ue,
–e
->
±r
)) {

1443 ià(
d–‘ed
) *deleted = 1;

1445 ià(
d–‘ed
) *deleted = 0;

1447  
REDISMODULE_OK
;

1448 
	}
}

1458 
	$RM_Z£tScÜe
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
scÜe
) {

1459 ià(
key
->
v®ue
 =ğ
NULL
è 
REDISMODULE_ERR
;

1460 ià(
key
->
v®ue
->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1461 ià(
	`z£tScÜe
(
key
->
v®ue
,
–e
->
±r
,
scÜe
è=ğ
C_ERR
è 
REDISMODULE_ERR
;

1462  
REDISMODULE_OK
;

1463 
	}
}

1469 
	$z£tKeyRe£t
(
RedisModuËKey
 *
key
) {

1470 
key
->
zty³
 = 
REDISMODULE_ZSET_RANGE_NONE
;

1471 
key
->
zcu¼’t
 = 
NULL
;

1472 
key
->
z”
 = 1;

1473 
	}
}

1476 
	$RM_Z£tRªgeStİ
(
RedisModuËKey
 *
key
) {

1478 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
)

1479 
	`z¦F»eLexRªge
(&
key
->
zÌs
);

1483 
	`z£tKeyRe£t
(
key
);

1484 
	}
}

1487 
	$RM_Z£tRªgeEndR—ched
(
RedisModuËKey
 *
key
) {

1488  
key
->
z”
;

1489 
	}
}

1497 
	$z£tIn™ScÜeRªge
(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
, 
fœ¡
) {

1498 ià(!
key
->
v®ue
 || key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1500 
	`RM_Z£tRªgeStİ
(
key
);

1501 
key
->
zty³
 = 
REDISMODULE_ZSET_RANGE_SCORE
;

1502 
key
->
z”
 = 0;

1506 
z¿nge¥ec
 *
zrs
 = &
key
->zrs;

1507 
zrs
->
mš
 = min;

1508 
zrs
->
max
 = max;

1509 
zrs
->
mšex
 = minex;

1510 
zrs
->
maxex
 = maxex;

1512 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1513 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`zzlFœ¡InRªge
(key->
v®ue
->
±r
,
zrs
) :

1514 
	`zzlLa¡InRªge
(
key
->
v®ue
->
±r
,
zrs
);

1515 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1516 
z£t
 *
zs
 = 
key
->
v®ue
->
±r
;

1517 
zskli¡
 *
z¦
 = 
zs
->zsl;

1518 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`z¦Fœ¡InRªge
(
z¦
,
zrs
) :

1519 
	`z¦La¡InRªge
(
z¦
,
zrs
);

1521 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1523 ià(
key
->
zcu¼’t
 =ğ
NULL
èkey->
z”
 = 1;

1524  
REDISMODULE_OK
;

1525 
	}
}

1542 
	$RM_Z£tFœ¡InScÜeRªge
(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
) {

1543  
	`z£tIn™ScÜeRªge
(
key
,
mš
,
max
,
mšex
,
maxex
,1);

1544 
	}
}

1548 
	$RM_Z£tLa¡InScÜeRªge
(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
) {

1549  
	`z£tIn™ScÜeRªge
(
key
,
mš
,
max
,
mšex
,
maxex
,0);

1550 
	}
}

1561 
	$z£tIn™LexRªge
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
, 
fœ¡
) {

1562 ià(!
key
->
v®ue
 || key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1564 
	`RM_Z£tRªgeStİ
(
key
);

1565 
key
->
z”
 = 0;

1569 
zËx¿nge¥ec
 *
zÌs
 = &
key
->zlrs;

1570 ià(
	`z¦P¬£LexRªge
(
mš
, 
max
, 
zÌs
è=ğ
C_ERR
è 
REDISMODULE_ERR
;

1574 
key
->
zty³
 = 
REDISMODULE_ZSET_RANGE_LEX
;

1576 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1577 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`zzlFœ¡InLexRªge
(key->
v®ue
->
±r
,
zÌs
) :

1578 
	`zzlLa¡InLexRªge
(
key
->
v®ue
->
±r
,
zÌs
);

1579 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1580 
z£t
 *
zs
 = 
key
->
v®ue
->
±r
;

1581 
zskli¡
 *
z¦
 = 
zs
->zsl;

1582 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`z¦Fœ¡InLexRªge
(
z¦
,
zÌs
) :

1583 
	`z¦La¡InLexRªge
(
z¦
,
zÌs
);

1585 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1587 ià(
key
->
zcu¼’t
 =ğ
NULL
èkey->
z”
 = 1;

1589  
REDISMODULE_OK
;

1590 
	}
}

1604 
	$RM_Z£tFœ¡InLexRªge
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
) {

1605  
	`z£tIn™LexRªge
(
key
,
mš
,
max
,1);

1606 
	}
}

1610 
	$RM_Z£tLa¡InLexRªge
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
) {

1611  
	`z£tIn™LexRªge
(
key
,
mš
,
max
,0);

1612 
	}
}

1617 
RedisModuËSŒšg
 *
	$RM_Z£tRªgeCu¼’tEËm’t
(
RedisModuËKey
 *
key
, *
scÜe
) {

1618 
RedisModuËSŒšg
 *
¡r
;

1620 ià(
key
->
zcu¼’t
 =ğ
NULL
)  NULL;

1621 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1622 *
•Œ
, *
¥Œ
;

1623 
•Œ
 = 
key
->
zcu¼’t
;

1624 
sds
 
–e
 = 
	`zli¡G‘Objeù
(
•Œ
);

1625 ià(
scÜe
) {

1626 
¥Œ
 = 
	`zli¡Next
(
key
->
v®ue
->
±r
,
•Œ
);

1627 *
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1629 
¡r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
–e
);

1630 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1631 
zskli¡Node
 *
Ê
 = 
key
->
zcu¼’t
;

1632 ià(
scÜe
è*scÜğ
Ê
->score;

1633 
¡r
 = 
	`ü—‹SŒšgObjeù
(
Ê
->
–e
,
	`sd¦’
(ln->ele));

1635 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1637 
	`autoMemÜyAdd
(
key
->
ùx
,
REDISMODULE_AM_STRING
,
¡r
);

1638  
¡r
;

1639 
	}
}

1644 
	$RM_Z£tRªgeNext
(
RedisModuËKey
 *
key
) {

1645 ià(!
key
->
zty³
 || !key->
zcu¼’t
)  0;

1647 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1648 *
zl
 = 
key
->
v®ue
->
±r
;

1649 *
•Œ
 = 
key
->
zcu¼’t
;

1650 *
Ãxt
;

1651 
Ãxt
 = 
	`zli¡Next
(
zl
,
•Œ
);

1652 ià(
Ãxt
èÃxˆğ
	`zli¡Next
(
zl
,next);

1653 ià(
Ãxt
 =ğ
NULL
) {

1654 
key
->
z”
 = 1;

1658 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
) {

1661 *
§ved_Ãxt
 = 
Ãxt
;

1662 
Ãxt
 = 
	`zli¡Next
(
zl
,next);

1663 
scÜe
 = 
	`zzlG‘ScÜe
(
Ãxt
);

1664 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
key
->
zrs
)) {

1665 
key
->
z”
 = 1;

1668 
Ãxt
 = 
§ved_Ãxt
;

1669 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

1670 ià(!
	`zzlLexV®ueL‹Max
(
Ãxt
,&
key
->
zÌs
)) {

1671 
key
->
z”
 = 1;

1675 
key
->
zcu¼’t
 = 
Ãxt
;

1678 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1679 
zskli¡Node
 *
Ê
 = 
key
->
zcu¼’t
, *
Ãxt
 =†n->
Ëv–
[0].
fÜw¬d
;

1680 ià(
Ãxt
 =ğ
NULL
) {

1681 
key
->
z”
 = 1;

1685 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
 &&

1686 !
	`z¦V®ueL‹Max
(
Ê
->
scÜe
,&
key
->
zrs
))

1688 
key
->
z”
 = 1;

1690 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

1691 ià(!
	`z¦LexV®ueL‹Max
(
Ê
->
–e
,&
key
->
zÌs
)) {

1692 
key
->
z”
 = 1;

1696 
key
->
zcu¼’t
 = 
Ãxt
;

1700 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1702 
	}
}

1707 
	$RM_Z£tRªgeP»v
(
RedisModuËKey
 *
key
) {

1708 ià(!
key
->
zty³
 || !key->
zcu¼’t
)  0;

1710 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1711 *
zl
 = 
key
->
v®ue
->
±r
;

1712 *
•Œ
 = 
key
->
zcu¼’t
;

1713 *
´ev
;

1714 
´ev
 = 
	`zli¡P»v
(
zl
,
•Œ
);

1715 ià(
´ev
è´ev = 
	`zli¡P»v
(
zl
,prev);

1716 ià(
´ev
 =ğ
NULL
) {

1717 
key
->
z”
 = 1;

1721 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
) {

1724 *
§ved_´ev
 = 
´ev
;

1725 
´ev
 = 
	`zli¡Next
(
zl
,prev);

1726 
scÜe
 = 
	`zzlG‘ScÜe
(
´ev
);

1727 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,&
key
->
zrs
)) {

1728 
key
->
z”
 = 1;

1731 
´ev
 = 
§ved_´ev
;

1732 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

1733 ià(!
	`zzlLexV®ueG‹Mš
(
´ev
,&
key
->
zÌs
)) {

1734 
key
->
z”
 = 1;

1738 
key
->
zcu¼’t
 = 
´ev
;

1741 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1742 
zskli¡Node
 *
Ê
 = 
key
->
zcu¼’t
, *
´ev
 =†n->
backw¬d
;

1743 ià(
´ev
 =ğ
NULL
) {

1744 
key
->
z”
 = 1;

1748 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
 &&

1749 !
	`z¦V®ueG‹Mš
(
Ê
->
scÜe
,&
key
->
zrs
))

1751 
key
->
z”
 = 1;

1753 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

1754 ià(!
	`z¦LexV®ueG‹Mš
(
´ev
->
–e
,&
key
->
zÌs
)) {

1755 
key
->
z”
 = 1;

1759 
key
->
zcu¼’t
 = 
´ev
;

1763 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1765 
	}
}

1821 
	$RM_HashS‘
(
RedisModuËKey
 *
key
, 
æags
, ...) {

1822 
va_li¡
 
­
;

1823 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
))  0;

1824 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_HASH
)  0;

1825 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_HASH
);

1827 
upd©ed
 = 0;

1828 
	`va_¡¬t
(
­
, 
æags
);

1830 
RedisModuËSŒšg
 *
f›ld
, *
v®ue
;

1832 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
) {

1833 *
cf›ld
 = 
	`va_¬g
(
­
,*);

1834 ià(
cf›ld
 =ğ
NULL
) ;

1835 
f›ld
 = 
	`ü—‹RawSŒšgObjeù
(
cf›ld
,
	`¡¾’
(cfield));

1837 
f›ld
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
*);

1838 ià(
f›ld
 =ğ
NULL
) ;

1840 
v®ue
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
*);

1843 ià(
æags
 & (
REDISMODULE_HASH_XX
|
REDISMODULE_HASH_NX
)) {

1844 
exi¡s
 = 
	`hashTy³Exi¡s
(
key
->
v®ue
, 
f›ld
->
±r
);

1845 ià(((
æags
 & 
REDISMODULE_HASH_XX
è&& !
exi¡s
) ||

1846 ((
æags
 & 
REDISMODULE_HASH_NX
è&& 
exi¡s
))

1848 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
è
	`deüRefCouÁ
(
f›ld
);

1854 ià(
v®ue
 =ğ
REDISMODULE_HASH_DELETE
) {

1855 
upd©ed
 +ğ
	`hashTy³D–‘e
(
key
->
v®ue
, 
f›ld
->
±r
);

1856 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
è
	`deüRefCouÁ
(
f›ld
);

1860 
low_æags
 = 
HASH_SET_COPY
;

1864 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
)

1865 
low_æags
 |ğ
HASH_SET_TAKE_FIELD
;

1866 
upd©ed
 +ğ
	`hashTy³S‘
(
key
->
v®ue
, 
f›ld
->
±r
, v®ue->±r, 
low_æags
);

1870 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
) {

1871 
f›ld
->
±r
 = 
NULL
;

1872 
	`deüRefCouÁ
(
f›ld
);

1875 
	`va_’d
(
­
);

1876 
	`moduËD–KeyIfEm±y
(
key
);

1877  
upd©ed
;

1878 
	}
}

1921 
	$RM_HashG‘
(
RedisModuËKey
 *
key
, 
æags
, ...) {

1922 
va_li¡
 
­
;

1923 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_HASH
è 
REDISMODULE_ERR
;

1925 
	`va_¡¬t
(
­
, 
æags
);

1927 
RedisModuËSŒšg
 *
f›ld
, **
v®u•Œ
;

1928 *
exi¡¥Œ
;

1930 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
) {

1931 *
cf›ld
 = 
	`va_¬g
(
­
,*);

1932 ià(
cf›ld
 =ğ
NULL
) ;

1933 
f›ld
 = 
	`ü—‹RawSŒšgObjeù
(
cf›ld
,
	`¡¾’
(cfield));

1935 
f›ld
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
*);

1936 ià(
f›ld
 =ğ
NULL
) ;

1940 ià(
æags
 & 
REDISMODULE_HASH_EXISTS
) {

1941 
exi¡¥Œ
 = 
	`va_¬g
(
­
,*);

1942 ià(
key
->
v®ue
)

1943 *
exi¡¥Œ
 = 
	`hashTy³Exi¡s
(
key
->
v®ue
,
f›ld
->
±r
);

1945 *
exi¡¥Œ
 = 0;

1947 
v®u•Œ
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
**);

1948 ià(
key
->
v®ue
) {

1949 *
v®u•Œ
 = 
	`hashTy³G‘V®ueObjeù
(
key
->
v®ue
,
f›ld
->
±r
);

1950 ià(*
v®u•Œ
) {

1951 
robj
 *
decoded
 = 
	`g‘DecodedObjeù
(*
v®u•Œ
);

1952 
	`deüRefCouÁ
(*
v®u•Œ
);

1953 *
v®u•Œ
 = 
decoded
;

1955 ià(*
v®u•Œ
)

1956 
	`autoMemÜyAdd
(
key
->
ùx
,
REDISMODULE_AM_STRING
,*
v®u•Œ
);

1958 *
v®u•Œ
 = 
NULL
;

1963 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
è
	`deüRefCouÁ
(
f›ld
);

1965 
	`va_’d
(
­
);

1966  
REDISMODULE_OK
;

1967 
	}
}

1977 
RedisModuËC®lR•ly
 *
	$moduËC»©eC®lR•lyFromPrÙo
(
RedisModuËCtx
 *
ùx
, 
sds
 
´Ùo
) {

1978 
RedisModuËC®lR•ly
 *
»¶y
 = 
	`zm®loc
((*reply));

1979 
»¶y
->
ùx
 = ctx;

1980 
»¶y
->
´Ùo
 =…roto;

1981 
»¶y
->
´ÙŞ’
 = 
	`sd¦’
(
´Ùo
);

1982 
»¶y
->
æags
 = 
REDISMODULE_REPLYFLAG_TOPARSE
;

1983 
´Ùo
[0]) {

1985 '+': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_STRING
; ;

1986 '-': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_ERROR
; ;

1987 ':': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_INTEGER
; ;

1988 '*': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_ARRAY
; ;

1989 : 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_UNKNOWN
; ;

1991 ià((
´Ùo
[0] == '*' ||…roto[0] == '$') &&…roto[1] == '-')

1992 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_NULL
;

1993  
»¶y
;

1994 
	}
}

1996 
moduËP¬£C®lR•ly_IÁ
(
RedisModuËC®lR•ly
 *
»¶y
);

1997 
moduËP¬£C®lR•ly_BulkSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
);

1998 
moduËP¬£C®lR•ly_Sim¶eSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
);

1999 
moduËP¬£C®lR•ly_A¼ay
(
RedisModuËC®lR•ly
 *
»¶y
);

2004 
	$moduËP¬£C®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
) {

2005 ià(!(
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_TOPARSE
)) ;

2006 
»¶y
->
æags
 &ğ~
REDISMODULE_REPLYFLAG_TOPARSE
;

2008 
»¶y
->
´Ùo
[0]) {

2009 ':': 
	`moduËP¬£C®lR•ly_IÁ
(
»¶y
); ;

2010 '$': 
	`moduËP¬£C®lR•ly_BulkSŒšg
(
»¶y
); ;

2012 '+': 
	`moduËP¬£C®lR•ly_Sim¶eSŒšg
(
»¶y
); ;

2013 '*': 
	`moduËP¬£C®lR•ly_A¼ay
(
»¶y
); ;

2015 
	}
}

2017 
	$moduËP¬£C®lR•ly_IÁ
(
RedisModuËC®lR•ly
 *
»¶y
) {

2018 *
´Ùo
 = 
»¶y
->proto;

2019 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2021 
	`¡ršg2Î
(
´Ùo
+1,
p
-´Ùo-1,&
»¶y
->
v®
.
Î
);

2022 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2;

2023 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_INTEGER
;

2024 
	}
}

2026 
	$moduËP¬£C®lR•ly_BulkSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
) {

2027 *
´Ùo
 = 
»¶y
->proto;

2028 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2029 
bulkËn
;

2031 
	`¡ršg2Î
(
´Ùo
+1,
p
-´Ùo-1,&
bulkËn
);

2032 ià(
bulkËn
 == -1) {

2033 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2;

2034 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_NULL
;

2036 
»¶y
->
v®
.
¡r
 = 
p
+2;

2037 
»¶y
->
Ën
 = 
bulkËn
;

2038 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2+
bulkËn
+2;

2039 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_STRING
;

2041 
	}
}

2043 
	$moduËP¬£C®lR•ly_Sim¶eSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
) {

2044 *
´Ùo
 = 
»¶y
->proto;

2045 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2047 
»¶y
->
v®
.
¡r
 = 
´Ùo
+1;

2048 
»¶y
->
Ën
 = 
p
-
´Ùo
-1;

2049 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2;

2050 
»¶y
->
ty³
 = 
´Ùo
[0] =ğ'+' ? 
REDISMODULE_REPLY_STRING
 :

2051 
REDISMODULE_REPLY_ERROR
;

2052 
	}
}

2054 
	$moduËP¬£C®lR•ly_A¼ay
(
RedisModuËC®lR•ly
 *
»¶y
) {

2055 *
´Ùo
 = 
»¶y
->proto;

2056 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2057 
¬¿yËn
, 
j
;

2059 
	`¡ršg2Î
(
´Ùo
+1,
p
-´Ùo-1,&
¬¿yËn
);

2060 
p
 += 2;

2062 ià(
¬¿yËn
 == -1) {

2063 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
;

2064 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_NULL
;

2068 
»¶y
->
v®
.
¬¿y
 = 
	`zm®loc
((
RedisModuËC®lR•ly
)*
¬¿yËn
);

2069 
»¶y
->
Ën
 = 
¬¿yËn
;

2070 
j
 = 0; j < 
¬¿yËn
; j++) {

2071 
RedisModuËC®lR•ly
 *
–e
 = 
»¶y
->
v®
.
¬¿y
+
j
;

2072 
–e
->
æags
 = 
REDISMODULE_REPLYFLAG_NESTED
 |

2073 
REDISMODULE_REPLYFLAG_TOPARSE
;

2074 
–e
->
´Ùo
 = 
p
;

2075 
–e
->
ùx
 = 
»¶y
->ctx;

2076 
	`moduËP¬£C®lR•ly
(
–e
);

2077 
p
 +ğ
–e
->
´ÙŞ’
;

2079 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
;

2080 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_ARRAY
;

2081 
	}
}

2085 
	$RM_F»eC®lR•ly_Rec
(
RedisModuËC®lR•ly
 *
»¶y
, 
ä“Ã¡ed
){

2089 ià(!
ä“Ã¡ed
 && 
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_NESTED
) ;

2091 ià(!(
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_TOPARSE
)) {

2092 ià(
»¶y
->
ty³
 =ğ
REDISMODULE_REPLY_ARRAY
) {

2093 
size_t
 
j
;

2094 
j
 = 0; j < 
»¶y
->
Ën
; j++)

2095 
	`RM_F»eC®lR•ly_Rec
(
»¶y
->
v®
.
¬¿y
+
j
,1);

2096 
	`zä“
(
»¶y
->
v®
.
¬¿y
);

2104 ià(!(
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_NESTED
)) {

2105 ià(
»¶y
->
´Ùo
è
	`sdsä“
(reply->proto);

2106 
	`zä“
(
»¶y
);

2108 
	}
}

2113 
	$RM_F»eC®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
) {

2114 
	`RM_F»eC®lR•ly_Rec
(
»¶y
,0);

2115 
	`autoMemÜyF»ed
(
»¶y
->
ùx
,
REDISMODULE_AM_REPLY
,reply);

2116 
	}
}

2119 
	$RM_C®lR•lyTy³
(
RedisModuËC®lR•ly
 *
»¶y
) {

2120  
»¶y
->
ty³
;

2121 
	}
}

2124 
size_t
 
	$RM_C®lR•lyL’gth
(
RedisModuËC®lR•ly
 *
»¶y
) {

2125 
	`moduËP¬£C®lR•ly
(
»¶y
);

2126 
»¶y
->
ty³
) {

2127 
REDISMODULE_REPLY_STRING
:

2128 
REDISMODULE_REPLY_ERROR
:

2129 
REDISMODULE_REPLY_ARRAY
:

2130  
»¶y
->
Ën
;

2134 
	}
}

2138 
RedisModuËC®lR•ly
 *
	$RM_C®lR•lyA¼ayEËm’t
(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 
idx
) {

2139 
	`moduËP¬£C®lR•ly
(
»¶y
);

2140 ià(
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_ARRAY
è 
NULL
;

2141 ià(
idx
 >ğ
»¶y
->
Ën
è 
NULL
;

2142  
»¶y
->
v®
.
¬¿y
+
idx
;

2143 
	}
}

2146 
	$RM_C®lR•lyIÁeg”
(
RedisModuËC®lR•ly
 *
»¶y
) {

2147 
	`moduËP¬£C®lR•ly
(
»¶y
);

2148 ià(
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_INTEGER
è 
LLONG_MIN
;

2149  
»¶y
->
v®
.
Î
;

2150 
	}
}

2153 cÚ¡ *
	$RM_C®lR•lySŒšgPŒ
(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
) {

2154 
	`moduËP¬£C®lR•ly
(
»¶y
);

2155 ià(
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_STRING
 &&

2156 
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_ERROR
è 
NULL
;

2157 ià(
Ën
è*ËÀğ
»¶y
->len;

2158  
»¶y
->
v®
.
¡r
;

2159 
	}
}

2163 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgFromC®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
) {

2164 
	`moduËP¬£C®lR•ly
(
»¶y
);

2165 
»¶y
->
ty³
) {

2166 
REDISMODULE_REPLY_STRING
:

2167 
REDISMODULE_REPLY_ERROR
:

2168  
	`RM_C»©eSŒšg
(
»¶y
->
ùx
,»¶y->
v®
.
¡r
,»¶y->
Ën
);

2169 
REDISMODULE_REPLY_INTEGER
: {

2170 
buf
[64];

2171 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
»¶y
->
v®
.
Î
);

2172  
	`RM_C»©eSŒšg
(
»¶y
->
ùx
,
buf
,
Ën
);

2174 :  
NULL
;

2176 
	}
}

2190 
	#REDISMODULE_ARGV_REPLICATE
 (1<<0)

	)

2192 
robj
 **
	$moduËC»©eArgvFromU£rFÜm©
(cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, *
¬gı
, *
æags
, 
va_li¡
 
­
) {

2193 
¬gc
 = 0, 
¬gv_size
, 
j
;

2194 
robj
 **
¬gv
 = 
NULL
;

2198 
¬gv_size
 = 
	`¡¾’
(
fmt
)+1;

2199 
¬gv
 = 
	`z»®loc
×rgv,(
robj
*)*
¬gv_size
);

2202 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
(
cmdÇme
,
	`¡¾’
(cmdname));

2203 
¬gc
++;

2206 cÚ¡ *
p
 = 
fmt
;

2207 *
p
) {

2208 ià(*
p
 == 'c') {

2209 *
c¡r
 = 
	`va_¬g
(
­
,*);

2210 
¬gv
[
¬gc
++] = 
	`ü—‹SŒšgObjeù
(
c¡r
,
	`¡¾’
(cstr));

2211 } ià(*
p
 == 's') {

2212 
robj
 *
obj
 = 
	`va_¬g
(
­
,*);

2213 
¬gv
[
¬gc
++] = 
obj
;

2214 
	`šüRefCouÁ
(
obj
);

2215 } ià(*
p
 == 'b') {

2216 *
buf
 = 
	`va_¬g
(
­
,*);

2217 
size_t
 
Ën
 = 
	`va_¬g
(
­
,size_t);

2218 
¬gv
[
¬gc
++] = 
	`ü—‹SŒšgObjeù
(
buf
,
Ën
);

2219 } ià(*
p
 == 'l') {

2220 
Î
 = 
	`va_¬g
(
­
,);

2221 
¬gv
[
¬gc
++] = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î
);

2222 } ià(*
p
 == 'v') {

2224 
robj
 **
v
 = 
	`va_¬g
(
­
, *);

2225 
size_t
 
vËn
 = 
	`va_¬g
(
­
, size_t);

2230 
¬gv_size
 +ğ
vËn
-1;

2231 
¬gv
 = 
	`z»®loc
×rgv,(
robj
*)*
¬gv_size
);

2233 
size_t
 
i
 = 0;

2234 
i
 = 0; i < 
vËn
; i++) {

2235 
	`šüRefCouÁ
(
v
[
i
]);

2236 
¬gv
[
¬gc
++] = 
v
[
i
];

2238 } ià(*
p
 == '!') {

2239 ià(
æags
è(*æagsè|ğ
REDISMODULE_ARGV_REPLICATE
;

2241 
fm‹¼
;

2243 
p
++;

2245 *
¬gı
 = 
¬gc
;

2246  
¬gv
;

2248 
fm‹¼
:

2249 
j
 = 0; j < 
¬gc
; j++)

2250 
	`deüRefCouÁ
(
¬gv
[
j
]);

2251 
	`zä“
(
¬gv
);

2252  
NULL
;

2253 
	}
}

2261 
RedisModuËC®lR•ly
 *
	$RM_C®l
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...) {

2262 
»disCommªd
 *
cmd
;

2263 
ş›Á
 *
c
 = 
NULL
;

2264 
robj
 **
¬gv
 = 
NULL
;

2265 
¬gc
 = 0, 
æags
 = 0;

2266 
va_li¡
 
­
;

2267 
RedisModuËC®lR•ly
 *
»¶y
 = 
NULL
;

2268 
»¶iÿ‹
 = 0;

2270 
cmd
 = 
	`lookupCommªdByCSŒšg
((*)
cmdÇme
);

2271 ià(!
cmd
) {

2272 
”ºo
 = 
EINVAL
;

2273  
NULL
;

2277 
	`va_¡¬t
(
­
, 
fmt
);

2278 
c
 = 
	`ü—‹Cl›Á
(-1);

2279 
¬gv
 = 
	`moduËC»©eArgvFromU£rFÜm©
(
cmdÇme
,
fmt
,&
¬gc
,&
æags
,
­
);

2280 
»¶iÿ‹
 = 
æags
 & 
REDISMODULE_ARGV_REPLICATE
;

2281 
	`va_’d
(
­
);

2284 
c
->
æags
 |ğ
CLIENT_MODULE
;

2285 
c
->
¬gv
 =‡rgv;

2286 
c
->
¬gc
 =‡rgc;

2287 
c
->
cmd
 = c->
Ï¡cmd
 = cmd;

2290 ià(
¬gv
 =ğ
NULL
è
ş—nup
;

2293 ià((
cmd
->
¬™y
 > 0 && cmd->¬™y !ğ
¬gc
) || (argc < -cmd->arity)) {

2294 
”ºo
 = 
EINVAL
;

2295 
ş—nup
;

2301 ià(
£rv”
.
şu¡”_’abËd
 && !(
ùx
->
ş›Á
->
æags
 & 
CLIENT_MASTER
)) {

2303 
c
->
æags
 &ğ~(
CLIENT_READONLY
|
CLIENT_ASKING
);

2304 
c
->
æags
 |ğ
ùx
->
ş›Á
->æag & (
CLIENT_READONLY
|
CLIENT_ASKING
);

2305 ià(
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,
NULL
,NULL) !=

2306 
£rv”
.
şu¡”
->
my£lf
)

2308 
”ºo
 = 
EPERM
;

2309 
ş—nup
;

2316 ià(
»¶iÿ‹
è
	`moduËR•liÿ‹MuÉiIfN“ded
(
ùx
);

2319 
ÿÎ_æags
 = 
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
;

2320 ià(
»¶iÿ‹
) {

2321 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_AOF
;

2322 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_REPL
;

2324 
	`ÿÎ
(
c
,
ÿÎ_æags
);

2329 
sds
 
´Ùo
 = 
	`sd¢ewËn
(
c
->
buf
,c->
buåos
);

2330 
c
->
buåos
 = 0;

2331 
	`li¡L’gth
(
c
->
»¶y
)) {

2332 
sds
 
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

2334 
´Ùo
 = 
	`sdsÿtsds
ÕrÙo,
o
);

2335 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

2337 
»¶y
 = 
	`moduËC»©eC®lR•lyFromPrÙo
(
ùx
,
´Ùo
);

2338 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_REPLY
,
»¶y
);

2340 
ş—nup
:

2341 
	`ä“Cl›Á
(
c
);

2342  
»¶y
;

2343 
	}
}

2347 cÚ¡ *
	$RM_C®lR•lyPrÙo
(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
) {

2348 ià(
»¶y
->
´Ùo
è*
Ën
 = 
	`sd¦’
(reply->proto);

2349  
»¶y
->
´Ùo
;

2350 
	}
}

2385 cÚ¡ *
	gModuËTy³NameCh¬S‘
 =

2390 
ušt64_t
 
	$moduËTy³EncodeId
(cÚ¡ *
Çme
, 
’cv”
) {

2393 cÚ¡ *
c£t
 = 
ModuËTy³NameCh¬S‘
;

2394 ià(
	`¡¾’
(
Çme
) != 9)  0;

2395 ià(
’cv”
 < 0 ||ƒncver > 1023)  0;

2397 
ušt64_t
 
id
 = 0;

2398 
j
 = 0; j < 9; j++) {

2399 *
p
 = 
	`¡rchr
(
c£t
,
Çme
[
j
]);

2400 ià(!
p
)  0;

2401 
pos
 = 
p
-
c£t
;

2402 
id
 = (id << 6è| 
pos
;

2404 
id
 = (id << 10è| 
’cv”
;

2405  
id
;

2406 
	}
}

2411 
moduËTy³
 *
	$moduËTy³LookupModuËByName
(cÚ¡ *
Çme
) {

2412 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
moduËs
);

2413 
diùEÁry
 *
de
;

2415 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2416 
RedisModuË
 *
moduË
 = 
	`diùG‘V®
(
de
);

2417 
li¡I‹r
 
li
;

2418 
li¡Node
 *
Ê
;

2420 
	`li¡Rewšd
(
moduË
->
ty³s
,&
li
);

2421 (
Ê
 = 
	`li¡Next
(&
li
))) {

2422 
moduËTy³
 *
mt
 = 
Ê
->
v®ue
;

2423 ià(
	`memcmp
(
Çme
,
mt
->name,(mt->name)) == 0) {

2424 
	`diùR–—£I‹¿tÜ
(
di
);

2425  
mt
;

2429 
	`diùR–—£I‹¿tÜ
(
di
);

2430  
NULL
;

2431 
	}
}

2436 
	#MODULE_LOOKUP_CACHE_SIZE
 3

	)

2438 
moduËTy³
 *
	$moduËTy³LookupModuËByID
(
ušt64_t
 
id
) {

2440 
ušt64_t
 
id
;

2441 
moduËTy³
 *
mt
;

2442 } 
ÿche
[
MODULE_LOOKUP_CACHE_SIZE
];

2445 
j
;

2446 
j
 = 0; j < 
MODULE_LOOKUP_CACHE_SIZE
; j++)

2447 ià(
ÿche
[
j
].
id
 =ğidè cache[j].
mt
;

2450 
moduËTy³
 *
mt
 = 
NULL
;

2451 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
moduËs
);

2452 
diùEÁry
 *
de
;

2454 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2455 
RedisModuË
 *
moduË
 = 
	`diùG‘V®
(
de
);

2456 
li¡I‹r
 
li
;

2457 
li¡Node
 *
Ê
;

2459 
	`li¡Rewšd
(
moduË
->
ty³s
,&
li
);

2460 (
Ê
 = 
	`li¡Next
(&
li
))) {

2461 
mt
 = 
Ê
->
v®ue
;

2464 ià(
mt
->
id
 >> 10 == id >> 10) ;

2467 
	`diùR–—£I‹¿tÜ
(
di
);

2470 ià(
mt
 && 
j
 < 
MODULE_LOOKUP_CACHE_SIZE
) {

2471 
ÿche
[
j
].
id
 = id;

2472 
ÿche
[
j
].
mt
 = mt;

2474  
mt
;

2475 
	}
}

2479 
	$moduËTy³NameByID
(*
Çme
, 
ušt64_t
 
moduËid
) {

2480 cÚ¡ *
c£t
 = 
ModuËTy³NameCh¬S‘
;

2482 
Çme
[0] = '\0';

2483 *
p
 = 
Çme
+8;

2484 
moduËid
 >>= 10;

2485 
j
 = 0; j < 9; j++) {

2486 *
p
-- = 
c£t
[
moduËid
 & 63];

2487 
moduËid
 >>= 6;

2489 
	}
}

2536 
moduËTy³
 *
	$RM_C»©eD©aTy³
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
’cv”
, 
moduËTy³LßdFunc
 
rdb_lßd
, 
moduËTy³SaveFunc
 
rdb_§ve
, 
moduËTy³Rewr™eFunc
 
aof_»wr™e
, 
moduËTy³Dige¡Func
 
dige¡
, 
moduËTy³F»eFunc
 
ä“
) {

2537 
ušt64_t
 
id
 = 
	`moduËTy³EncodeId
(
Çme
,
’cv”
);

2538 ià(
id
 =ğ0è 
NULL
;

2539 ià(
	`moduËTy³LookupModuËByName
(
Çme
è!ğ
NULL
)  NULL;

2541 
moduËTy³
 *
mt
 = 
	`zm®loc
((*mt));

2542 
mt
->
id
 = id;

2543 
mt
->
moduË
 = 
ùx
->module;

2544 
mt
->
rdb_lßd
 =„db_load;

2545 
mt
->
rdb_§ve
 =„db_save;

2546 
mt
->
aof_»wr™e
 =‡of_rewrite;

2547 
mt
->
dige¡
 = digest;

2548 
mt
->
ä“
 = free;

2549 
	`memıy
(
mt
->
Çme
,name,(mt->name));

2550 
	`li¡AddNodeTa
(
ùx
->
moduË
->
ty³s
,
mt
);

2551  
mt
;

2552 
	}
}

2558 
	$RM_ModuËTy³S‘V®ue
(
RedisModuËKey
 *
key
, 
moduËTy³
 *
mt
, *
v®ue
) {

2559 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
™”
è 
REDISMODULE_ERR
;

2560 
	`RM_D–‘eKey
(
key
);

2561 
robj
 *
o
 = 
	`ü—‹ModuËObjeù
(
mt
,
v®ue
);

2562 
	`£tKey
(
key
->
db
,key->key,
o
);

2563 
	`deüRefCouÁ
(
o
);

2564 
key
->
v®ue
 = 
o
;

2565  
REDISMODULE_OK
;

2566 
	}
}

2573 
moduËTy³
 *
	$RM_ModuËTy³G‘Ty³
(
RedisModuËKey
 *
key
) {

2574 ià(
key
 =ğ
NULL
 ||

2575 
key
->
v®ue
 =ğ
NULL
 ||

2576 
	`RM_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_MODULE
è 
NULL
;

2577 
moduËV®ue
 *
mv
 = 
key
->
v®ue
->
±r
;

2578  
mv
->
ty³
;

2579 
	}
}

2587 *
	$RM_ModuËTy³G‘V®ue
(
RedisModuËKey
 *
key
) {

2588 ià(
key
 =ğ
NULL
 ||

2589 
key
->
v®ue
 =ğ
NULL
 ||

2590 
	`RM_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_MODULE
è 
NULL
;

2591 
moduËV®ue
 *
mv
 = 
key
->
v®ue
->
±r
;

2592  
mv
->
v®ue
;

2593 
	}
}

2601 
	$moduËRDBLßdE¼Ü
(
RedisModuËIO
 *
io
) {

2602 
	`£rv”Log
(
LL_WARNING
,

2606 
io
->
ty³
->
moduË
->
Çme
,

2607 
io
->
ty³
->
Çme
,

2608 ()
io
->
by‹s
);

2609 
	`ex™
(1);

2610 
	}
}

2615 
	$RM_SaveUnsigÃd
(
RedisModuËIO
 *
io
, 
ušt64_t
 
v®ue
) {

2616 ià(
io
->
”rÜ
) ;

2617 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
v®ue
);

2618 ià(
»tv®
 == -1) {

2619 
io
->
”rÜ
 = 1;

2621 
io
->
by‹s
 +ğ
»tv®
;

2623 
	}
}

2628 
ušt64_t
 
	$RM_LßdUnsigÃd
(
RedisModuËIO
 *
io
) {

2629 
ušt64_t
 
v®ue
;

2630 
»tv®
 = 
	`rdbLßdL’ByRef
(
io
->
rio
, 
NULL
, &
v®ue
);

2631 ià(
»tv®
 == -1) {

2632 
	`moduËRDBLßdE¼Ü
(
io
);

2635  
v®ue
;

2636 
	}
}

2639 
	$RM_SaveSigÃd
(
RedisModuËIO
 *
io
, 
št64_t
 
v®ue
) {

2640 uniÚ {
ušt64_t
 
u
; 
št64_t
 
i
;} 
cÚv
;

2641 
cÚv
.
i
 = 
v®ue
;

2642 
	`RM_SaveUnsigÃd
(
io
,
cÚv
.
u
);

2643 
	}
}

2646 
št64_t
 
	$RM_LßdSigÃd
(
RedisModuËIO
 *
io
) {

2647 uniÚ {
ušt64_t
 
u
; 
št64_t
 
i
;} 
cÚv
;

2648 
cÚv
.
u
 = 
	`RM_LßdUnsigÃd
(
io
);

2649  
cÚv
.
i
;

2650 
	}
}

2658 
	$RM_SaveSŒšg
(
RedisModuËIO
 *
io
, 
RedisModuËSŒšg
 *
s
) {

2659 ià(
io
->
”rÜ
) ;

2660 
»tv®
 = 
	`rdbSaveSŒšgObjeù
(
io
->
rio
,
s
);

2661 ià(
»tv®
 == -1) {

2662 
io
->
”rÜ
 = 1;

2664 
io
->
by‹s
 +ğ
»tv®
;

2666 
	}
}

2670 
	$RM_SaveSŒšgBufãr
(
RedisModuËIO
 *
io
, cÚ¡ *
¡r
, 
size_t
 
Ën
) {

2671 ià(
io
->
”rÜ
) ;

2672 
»tv®
 = 
	`rdbSaveRawSŒšg
(
io
->
rio
,(*)
¡r
,
Ën
);

2673 ià(
»tv®
 == -1) {

2674 
io
->
”rÜ
 = 1;

2676 
io
->
by‹s
 +ğ
»tv®
;

2678 
	}
}

2681 *
	$moduËLßdSŒšg
(
RedisModuËIO
 *
io
, 
¶aš
, 
size_t
 *
ËÅŒ
) {

2682 *
s
 = 
	`rdbG’”icLßdSŒšgObjeù
(
io
->
rio
,

2683 
¶aš
 ? 
RDB_LOAD_PLAIN
 : 
RDB_LOAD_NONE
, 
ËÅŒ
);

2684 ià(
s
 =ğ
NULL
) {

2685 
	`moduËRDBLßdE¼Ü
(
io
);

2686  
NULL
;

2688  
s
;

2689 
	}
}

2700 
RedisModuËSŒšg
 *
	$RM_LßdSŒšg
(
RedisModuËIO
 *
io
) {

2701  
	`moduËLßdSŒšg
(
io
,0,
NULL
);

2702 
	}
}

2711 *
	$RM_LßdSŒšgBufãr
(
RedisModuËIO
 *
io
, 
size_t
 *
ËÅŒ
) {

2712  
	`moduËLßdSŒšg
(
io
,1,
ËÅŒ
);

2713 
	}
}

2718 
	$RM_SaveDoubË
(
RedisModuËIO
 *
io
, 
v®ue
) {

2719 ià(
io
->
”rÜ
) ;

2720 
»tv®
 = 
	`rdbSaveBš¬yDoubËV®ue
(
io
->
rio
, 
v®ue
);

2721 ià(
»tv®
 == -1) {

2722 
io
->
”rÜ
 = 1;

2724 
io
->
by‹s
 +ğ
»tv®
;

2726 
	}
}

2730 
	$RM_LßdDoubË
(
RedisModuËIO
 *
io
) {

2731 
v®ue
;

2732 
»tv®
 = 
	`rdbLßdBš¬yDoubËV®ue
(
io
->
rio
, &
v®ue
);

2733 ià(
»tv®
 == -1) {

2734 
	`moduËRDBLßdE¼Ü
(
io
);

2737  
v®ue
;

2738 
	}
}

2749 
	$RM_Em™AOF
(
RedisModuËIO
 *
io
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...) {

2750 ià(
io
->
”rÜ
) ;

2751 
»disCommªd
 *
cmd
;

2752 
robj
 **
¬gv
 = 
NULL
;

2753 
¬gc
 = 0, 
æags
 = 0, 
j
;

2754 
va_li¡
 
­
;

2756 
cmd
 = 
	`lookupCommªdByCSŒšg
((*)
cmdÇme
);

2757 ià(!
cmd
) {

2758 
	`£rv”Log
(
LL_WARNING
,

2761 
io
->
ty³
->
Çme
, 
cmdÇme
);

2762 
io
->
”rÜ
 = 1;

2763 
”ºo
 = 
EINVAL
;

2768 
	`va_¡¬t
(
­
, 
fmt
);

2769 
¬gv
 = 
	`moduËC»©eArgvFromU£rFÜm©
(
cmdÇme
,
fmt
,&
¬gc
,&
æags
,
­
);

2770 
	`va_’d
(
­
);

2771 ià(
¬gv
 =ğ
NULL
) {

2772 
	`£rv”Log
(
LL_WARNING
,

2775 
io
->
ty³
->
Çme
, 
fmt
);

2776 
io
->
”rÜ
 = 1;

2777 
”ºo
 = 
EINVAL
;

2782 ià(!
io
->
”rÜ
 && 
	`rioWr™eBulkCouÁ
(io->
rio
,'*',
¬gc
) == 0)

2783 
io
->
”rÜ
 = 1;

2786 
j
 = 0; j < 
¬gc
; j++) {

2787 ià(!
io
->
”rÜ
 && 
	`rioWr™eBulkObjeù
(io->
rio
,
¬gv
[
j
]) == 0)

2788 
io
->
”rÜ
 = 1;

2789 
	`deüRefCouÁ
(
¬gv
[
j
]);

2791 
	`zä“
(
¬gv
);

2793 
	}
}

2813 
	$RM_Log
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Ëv–¡r
, cÚ¡ *
fmt
, ...) {

2814 
va_li¡
 
­
;

2815 
msg
[
LOG_MAX_LEN
];

2816 
size_t
 
Çme_Ën
;

2817 
Ëv–
;

2819 ià(!
ùx
->
moduË
) ;

2821 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"debug")è
Ëv–
 = 
LL_DEBUG
;

2822 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"v”bo£")è
Ëv–
 = 
LL_VERBOSE
;

2823 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"nÙiû")è
Ëv–
 = 
LL_NOTICE
;

2824 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"w¬nšg")è
Ëv–
 = 
LL_WARNING
;

2825 
Ëv–
 = 
LL_VERBOSE
;

2827 
Çme_Ën
 = 
	`¢´štf
(
msg
, (msg),"<%s> ", 
ùx
->
moduË
->
Çme
);

2829 
	`va_¡¬t
(
­
, 
fmt
);

2830 
	`v¢´štf
(
msg
 + 
Çme_Ën
, (msgè-‚ame_Ën, 
fmt
, 
­
);

2831 
	`va_’d
(
­
);

2833 
	`£rv”LogRaw
(
Ëv–
,
msg
);

2834 
	}
}

2843 
	$diùCSŒšgKeyHash
(cÚ¡ *
key
) {

2844  
	`diùG’HashFunùiÚ
((*)
key
, 
	`¡¾’
((*)key));

2845 
	}
}

2847 
	$diùCSŒšgKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

2848 
	`DICT_NOTUSED
(
´ivd©a
);

2849  
	`¡rcmp
(
key1
,
key2
) == 0;

2850 
	}
}

2852 
diùTy³
 
	gmoduËAPIDiùTy³
 = {

2853 
diùCSŒšgKeyHash
,

2854 
NULL
,

2855 
NULL
,

2856 
diùCSŒšgKeyCom·»
,

2857 
NULL
,

2858 
NULL


2861 
	$moduËRegi¡”Api
(cÚ¡ *
funúame
, *
funıŒ
) {

2862  
	`diùAdd
(
£rv”
.
moduË­i
, (*)
funúame
, 
funıŒ
);

2863 
	}
}

2865 
	#REGISTER_API
(
Çme
) \

2866 
	`moduËRegi¡”Api
("RedisModuË_" #Çme, (*)()
RM_
 ## 
Çme
)

	)

2869 
	$moduËRegi¡”CÜeAPI
() {

2870 
£rv”
.
moduË­i
 = 
	`diùC»©e
(&
moduËAPIDiùTy³
,
NULL
);

2871 
	`REGISTER_API
(
AÎoc
);

2872 
	`REGISTER_API
(
C®loc
);

2873 
	`REGISTER_API
(
R—Îoc
);

2874 
	`REGISTER_API
(
F»e
);

2875 
	`REGISTER_API
(
SŒdup
);

2876 
	`REGISTER_API
(
C»©eCommªd
);

2877 
	`REGISTER_API
(
S‘ModuËA‰ribs
);

2878 
	`REGISTER_API
(
WrÚgAr™y
);

2879 
	`REGISTER_API
(
R•lyW™hLÚgLÚg
);

2880 
	`REGISTER_API
(
R•lyW™hE¼Ü
);

2881 
	`REGISTER_API
(
R•lyW™hSim¶eSŒšg
);

2882 
	`REGISTER_API
(
R•lyW™hA¼ay
);

2883 
	`REGISTER_API
(
R•lyS‘A¼ayL’gth
);

2884 
	`REGISTER_API
(
R•lyW™hSŒšg
);

2885 
	`REGISTER_API
(
R•lyW™hSŒšgBufãr
);

2886 
	`REGISTER_API
(
R•lyW™hNuÎ
);

2887 
	`REGISTER_API
(
R•lyW™hC®lR•ly
);

2888 
	`REGISTER_API
(
R•lyW™hDoubË
);

2889 
	`REGISTER_API
(
G‘S–eùedDb
);

2890 
	`REGISTER_API
(
S–eùDb
);

2891 
	`REGISTER_API
(
O³nKey
);

2892 
	`REGISTER_API
(
Clo£Key
);

2893 
	`REGISTER_API
(
KeyTy³
);

2894 
	`REGISTER_API
(
V®ueL’gth
);

2895 
	`REGISTER_API
(
Li¡Push
);

2896 
	`REGISTER_API
(
Li¡Pİ
);

2897 
	`REGISTER_API
(
SŒšgToLÚgLÚg
);

2898 
	`REGISTER_API
(
SŒšgToDoubË
);

2899 
	`REGISTER_API
(
C®l
);

2900 
	`REGISTER_API
(
C®lR•lyPrÙo
);

2901 
	`REGISTER_API
(
F»eC®lR•ly
);

2902 
	`REGISTER_API
(
C®lR•lyIÁeg”
);

2903 
	`REGISTER_API
(
C®lR•lyTy³
);

2904 
	`REGISTER_API
(
C®lR•lyL’gth
);

2905 
	`REGISTER_API
(
C®lR•lyA¼ayEËm’t
);

2906 
	`REGISTER_API
(
C®lR•lySŒšgPŒ
);

2907 
	`REGISTER_API
(
C»©eSŒšgFromC®lR•ly
);

2908 
	`REGISTER_API
(
C»©eSŒšg
);

2909 
	`REGISTER_API
(
C»©eSŒšgFromLÚgLÚg
);

2910 
	`REGISTER_API
(
C»©eSŒšgFromSŒšg
);

2911 
	`REGISTER_API
(
F»eSŒšg
);

2912 
	`REGISTER_API
(
SŒšgPŒL’
);

2913 
	`REGISTER_API
(
AutoMemÜy
);

2914 
	`REGISTER_API
(
R•liÿ‹
);

2915 
	`REGISTER_API
(
R•liÿ‹V”b©im
);

2916 
	`REGISTER_API
(
D–‘eKey
);

2917 
	`REGISTER_API
(
SŒšgS‘
);

2918 
	`REGISTER_API
(
SŒšgDMA
);

2919 
	`REGISTER_API
(
SŒšgTrunÿ‹
);

2920 
	`REGISTER_API
(
S‘Expœe
);

2921 
	`REGISTER_API
(
G‘Expœe
);

2922 
	`REGISTER_API
(
Z£tAdd
);

2923 
	`REGISTER_API
(
Z£tInüby
);

2924 
	`REGISTER_API
(
Z£tScÜe
);

2925 
	`REGISTER_API
(
Z£tRem
);

2926 
	`REGISTER_API
(
Z£tRªgeStİ
);

2927 
	`REGISTER_API
(
Z£tFœ¡InScÜeRªge
);

2928 
	`REGISTER_API
(
Z£tLa¡InScÜeRªge
);

2929 
	`REGISTER_API
(
Z£tFœ¡InLexRªge
);

2930 
	`REGISTER_API
(
Z£tLa¡InLexRªge
);

2931 
	`REGISTER_API
(
Z£tRªgeCu¼’tEËm’t
);

2932 
	`REGISTER_API
(
Z£tRªgeNext
);

2933 
	`REGISTER_API
(
Z£tRªgeP»v
);

2934 
	`REGISTER_API
(
Z£tRªgeEndR—ched
);

2935 
	`REGISTER_API
(
HashS‘
);

2936 
	`REGISTER_API
(
HashG‘
);

2937 
	`REGISTER_API
(
IsKeysPos™iÚReque¡
);

2938 
	`REGISTER_API
(
KeyAtPos
);

2939 
	`REGISTER_API
(
G‘Cl›ÁId
);

2940 
	`REGISTER_API
(
PoŞAÎoc
);

2941 
	`REGISTER_API
(
C»©eD©aTy³
);

2942 
	`REGISTER_API
(
ModuËTy³S‘V®ue
);

2943 
	`REGISTER_API
(
ModuËTy³G‘Ty³
);

2944 
	`REGISTER_API
(
ModuËTy³G‘V®ue
);

2945 
	`REGISTER_API
(
SaveUnsigÃd
);

2946 
	`REGISTER_API
(
LßdUnsigÃd
);

2947 
	`REGISTER_API
(
SaveSigÃd
);

2948 
	`REGISTER_API
(
LßdSigÃd
);

2949 
	`REGISTER_API
(
SaveSŒšg
);

2950 
	`REGISTER_API
(
SaveSŒšgBufãr
);

2951 
	`REGISTER_API
(
LßdSŒšg
);

2952 
	`REGISTER_API
(
LßdSŒšgBufãr
);

2953 
	`REGISTER_API
(
SaveDoubË
);

2954 
	`REGISTER_API
(
LßdDoubË
);

2955 
	`REGISTER_API
(
Em™AOF
);

2956 
	`REGISTER_API
(
Log
);

2957 
	}
}

2960 
	$moduËIn™ModuËsSy¡em
() {

2961 
£rv”
.
lßdmoduË_queue
 = 
	`li¡C»©e
();

2962 
moduËs
 = 
	`diùC»©e
(&
moduËsDiùTy³
,
NULL
);

2963 
	`moduËRegi¡”CÜeAPI
();

2964 
	}
}

2975 
	$moduËLßdFromQueue
() {

2976 
li¡I‹r
 
li
;

2977 
li¡Node
 *
Ê
;

2979 
	`li¡Rewšd
(
£rv”
.
lßdmoduË_queue
,&
li
);

2980 (
Ê
 = 
	`li¡Next
(&
li
))) {

2981 
moduËLßdQueueEÁry
 *
lßdmod
 = 
Ê
->
v®ue
;

2982 ià(
	`moduËLßd
(
lßdmod
->
·th
,(**îßdmod->
¬gv
,lßdmod->
¬gc
)

2983 =ğ
C_ERR
)

2985 
	`£rv”Log
(
LL_WARNING
,

2987 
lßdmod
->
·th
);

2988 
	`ex™
(1);

2991 
	}
}

2993 
	$moduËF»eModuËSŒuùu»
(
RedisModuË
 *
moduË
) {

2994 
	`li¡R–—£
(
moduË
->
ty³s
);

2995 
	`sdsä“
(
moduË
->
Çme
);

2996 
	`zä“
(
moduË
);

2997 
	}
}

3001 
	$moduËLßd
(cÚ¡ *
·th
, **
moduË_¬gv
, 
moduË_¬gc
) {

3002 (*
Úlßd
)(*, **, );

3003 *
hªdË
;

3004 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

3006 
hªdË
 = 
	`dlİ’
(
·th
,
RTLD_NOW
|
RTLD_LOCAL
);

3007 ià(
hªdË
 =ğ
NULL
) {

3008 
	`£rv”Log
(
LL_WARNING
, "ModuË % çedØlßd: %s", 
·th
, 
	`dË¼Ü
());

3009  
C_ERR
;

3011 
Úlßd
 = ((*)(*, **, ))(è
	`dlsym
(
hªdË
,"RedisModule_OnLoad");

3012 ià(
Úlßd
 =ğ
NULL
) {

3013 
	`£rv”Log
(
LL_WARNING
,

3015 "symbŞ. ModuË‚Ù†ßded.",
·th
);

3016  
C_ERR
;

3018 ià(
	`Úlßd
((*)&
ùx
,
moduË_¬gv
,
moduË_¬gc
è=ğ
REDISMODULE_ERR
) {

3019 ià(
ùx
.
moduË
è
	`moduËF»eModuËSŒuùu»
(ctx.module);

3020 
	`dlşo£
(
hªdË
);

3021 
	`£rv”Log
(
LL_WARNING
,

3022 "ModuË % š™Ÿliz©iÚ faed. ModuË‚Ù†ßded",
·th
);

3023  
C_ERR
;

3027 
	`diùAdd
(
moduËs
,
ùx
.
moduË
->
Çme
,ctx.module);

3028 
ùx
.
moduË
->
hªdË
 = handle;

3029 
	`£rv”Log
(
LL_NOTICE
,"ModuË '%s'†ßded from %s",
ùx
.
moduË
->
Çme
,
·th
);

3030 
	`moduËF»eCÚ‹xt
(&
ùx
);

3031  
C_OK
;

3032 
	}
}

3040 
	$moduËUÆßd
(
sds
 
Çme
) {

3041 
RedisModuË
 *
moduË
 = 
	`diùF‘chV®ue
(
moduËs
,
Çme
);

3043 ià(
moduË
 =ğ
NULL
) {

3044 
”ºo
 = 
ENOENT
;

3045  
REDISMODULE_ERR
;

3048 ià(
	`li¡L’gth
(
moduË
->
ty³s
)) {

3049 
”ºo
 = 
EBUSY
;

3050  
REDISMODULE_ERR
;

3054 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
commªds
);

3055 
diùEÁry
 *
de
;

3056 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3057 
»disCommªd
 *
cmd
 = 
	`diùG‘V®
(
de
);

3058 ià(
cmd
->
´oc
 =ğ
RedisModuËCommªdDi¥©ch”
) {

3059 
RedisModuËCommªdProxy
 *
ı
 =

3060 (*)()
cmd
->
g‘keys_´oc
;

3061 
sds
 
cmdÇme
 = 
ı
->
»discmd
->
Çme
;

3062 ià(
ı
->
moduË
 == module) {

3063 
	`diùD–‘e
(
£rv”
.
commªds
,
cmdÇme
);

3064 
	`diùD–‘e
(
£rv”
.
Üig_commªds
,
cmdÇme
);

3065 
	`sdsä“
(
cmdÇme
);

3066 
	`zä“
(
ı
->
»discmd
);

3067 
	`zä“
(
ı
);

3071 
	`diùR–—£I‹¿tÜ
(
di
);

3076 ià(
	`dlşo£
(
moduË
->
hªdË
) == -1) {

3077 *
”rÜ
 = 
	`dË¼Ü
();

3078 ià(
”rÜ
 =ğ
NULL
)ƒrror = "Unknownƒrror";

3079 
	`£rv”Log
(
LL_WARNING
,"Error whenryingo closehe %s module: %s",

3080 
moduË
->
Çme
, 
”rÜ
);

3084 
	`£rv”Log
(
LL_NOTICE
,"ModuË % uÆßded",
moduË
->
Çme
);

3085 
	`diùD–‘e
(
moduËs
,
moduË
->
Çme
);

3086 
	`moduËF»eModuËSŒuùu»
(
moduË
);

3088  
REDISMODULE_OK
;

3089 
	}
}

3094 
	$moduËCommªd
(
ş›Á
 *
c
) {

3095 *
subcmd
 = 
c
->
¬gv
[1]->
±r
;

3097 ià(!
	`¡rÿ£cmp
(
subcmd
,"lßd"è&& 
c
->
¬gc
 >= 3) {

3098 
robj
 **
¬gv
 = 
NULL
;

3099 
¬gc
 = 0;

3101 ià(
c
->
¬gc
 > 3) {

3102 
¬gc
 = 
c
->argc - 3;

3103 
¬gv
 = &
c
->argv[3];

3106 ià(
	`moduËLßd
(
c
->
¬gv
[2]->
±r
,(**ïrgv,
¬gc
è=ğ
C_OK
)

3107 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3109 
	`addR•lyE¼Ü
(
c
,

3111 } ià(!
	`¡rÿ£cmp
(
subcmd
,"uÆßd"è&& 
c
->
¬gc
 == 3) {

3112 ià(
	`moduËUÆßd
(
c
->
¬gv
[2]->
±r
è=ğ
C_OK
)

3113 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3115 *
”rmsg
;

3116 
”ºo
) {

3117 
ENOENT
:

3118 
”rmsg
 = "no such module withhat‚ame";

3120 
EBUSY
:

3121 
”rmsg
 = "the moduleƒxports one or more module-side dataypes, can't unload";

3124 
”rmsg
 = "operation‚ot…ossible.";

3127 
	`addR•lyE¼ÜFÜm©
(
c
,"E¼Ü uÆßdšg moduË: %s",
”rmsg
);

3129 } ià(!
	`¡rÿ£cmp
(
subcmd
,"li¡"è&& 
c
->
¬gc
 == 2) {

3130 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
moduËs
);

3131 
diùEÁry
 *
de
;

3133 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
moduËs
));

3134 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3135 
sds
 
Çme
 = 
	`diùG‘Key
(
de
);

3136 
RedisModuË
 *
moduË
 = 
	`diùG‘V®
(
de
);

3137 
	`addR•lyMuÉiBulkL’
(
c
,4);

3138 
	`addR•lyBulkCSŒšg
(
c
,"name");

3139 
	`addR•lyBulkCBufãr
(
c
,
Çme
,
	`sd¦’
(name));

3140 
	`addR•lyBulkCSŒšg
(
c
,"ver");

3141 
	`addR•lyLÚgLÚg
(
c
,
moduË
->
v”
);

3143 
	`diùR–—£I‹¿tÜ
(
di
);

3145 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

3147 
	}
}

	@modules/hellotype.c

38 
	~"../»dismoduË.h
"

39 
	~<¡dio.h
>

40 
	~<¡dlib.h
>

41 
	~<ùy³.h
>

42 
	~<¡ršg.h
>

43 
	~<¡dšt.h
>

45 
RedisModuËTy³
 *
	gH–loTy³
;

53 
	sH–loTy³Node
 {

54 
št64_t
 
	mv®ue
;

55 
H–loTy³Node
 *
	mÃxt
;

58 
	sH–loTy³Objeù
 {

59 
H–loTy³Node
 *
	mh—d
;

60 
size_t
 
	mËn
;

63 
H–loTy³Objeù
 *
	$ü—‹H–loTy³Objeù
() {

64 
H–loTy³Objeù
 *
o
;

65 
o
 = 
	`RedisModuË_AÎoc
((*o));

66 
o
->
h—d
 = 
NULL
;

67 
o
->
Ën
 = 0;

68  
o
;

69 
	}
}

71 
	$H–loTy³In£¹
(
H–loTy³Objeù
 *
o
, 
št64_t
 
–e
) {

72 
H–loTy³Node
 *
Ãxt
 = 
o
->
h—d
, *
Ãwnode
, *
´ev
 = 
NULL
;

74 
Ãxt
 &&‚ext->
v®ue
 < 
–e
) {

75 
´ev
 = 
Ãxt
;

76 
Ãxt
 =‚ext->next;

78 
Ãwnode
 = 
	`RedisModuË_AÎoc
((*newnode));

79 
Ãwnode
->
v®ue
 = 
–e
;

80 
Ãwnode
->
Ãxt
 =‚ext;

81 ià(
´ev
) {

82 
´ev
->
Ãxt
 = 
Ãwnode
;

84 
o
->
h—d
 = 
Ãwnode
;

86 
o
->
Ën
++;

87 
	}
}

89 
	$H–loTy³R–—£Objeù
(
H–loTy³Objeù
 *
o
) {

90 
H–loTy³Node
 *
cur
, *
Ãxt
;

91 
cur
 = 
o
->
h—d
;

92 
cur
) {

93 
Ãxt
 = 
cur
->next;

94 
	`RedisModuË_F»e
(
cur
);

95 
cur
 = 
Ãxt
;

97 
	`RedisModuË_F»e
(
o
);

98 
	}
}

103 
	$H–loTy³In£¹_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

104 
	`RedisModuË_AutoMemÜy
(
ùx
);

106 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

107 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

108 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

109 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

110 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
 &&

111 
	`RedisModuË_ModuËTy³G‘Ty³
(
key
è!ğ
H–loTy³
)

113  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

116 
v®ue
;

117 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
v®ue
è!ğ
REDISMODULE_OK
)) {

118  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid value: must be‡ signed 64 bit integer");

122 
H–loTy³Objeù
 *
hto
;

123 ià(
ty³
 =ğ
REDISMODULE_KEYTYPE_EMPTY
) {

124 
hto
 = 
	`ü—‹H–loTy³Objeù
();

125 
	`RedisModuË_ModuËTy³S‘V®ue
(
key
,
H–loTy³
,
hto
);

127 
hto
 = 
	`RedisModuË_ModuËTy³G‘V®ue
(
key
);

131 
	`H–loTy³In£¹
(
hto
,
v®ue
);

133 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
hto
->
Ën
);

134 
	`RedisModuË_R•liÿ‹V”b©im
(
ùx
);

135  
REDISMODULE_OK
;

136 
	}
}

139 
	$H–loTy³Rªge_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

140 
	`RedisModuË_AutoMemÜy
(
ùx
);

142 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

143 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

144 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

145 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

146 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
 &&

147 
	`RedisModuË_ModuËTy³G‘Ty³
(
key
è!ğ
H–loTy³
)

149  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

152 
fœ¡
, 
couÁ
;

153 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
fœ¡
è!ğ
REDISMODULE_OK
 ||

154 
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[3],&
couÁ
è!ğ
REDISMODULE_OK
 ||

155 
fœ¡
 < 0 || 
couÁ
 < 0)

157  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,

161 
H–loTy³Objeù
 *
hto
 = 
	`RedisModuË_ModuËTy³G‘V®ue
(
key
);

162 
H–loTy³Node
 *
node
 = 
hto
 ? hto->
h—d
 : 
NULL
;

163 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
REDISMODULE_POSTPONED_ARRAY_LEN
);

164 
¬¿yËn
 = 0;

165 
node
 && 
couÁ
--) {

166 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
node
->
v®ue
);

167 
¬¿yËn
++;

168 
node
 =‚ode->
Ãxt
;

170 
	`RedisModuË_R•lyS‘A¼ayL’gth
(
ùx
,
¬¿yËn
);

171  
REDISMODULE_OK
;

172 
	}
}

175 
	$H–loTy³L’_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

176 
	`RedisModuË_AutoMemÜy
(
ùx
);

178 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

179 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

180 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

181 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

182 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
 &&

183 
	`RedisModuË_ModuËTy³G‘Ty³
(
key
è!ğ
H–loTy³
)

185  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

188 
H–loTy³Objeù
 *
hto
 = 
	`RedisModuË_ModuËTy³G‘V®ue
(
key
);

189 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
hto
 ? hto->
Ën
 : 0);

190  
REDISMODULE_OK
;

191 
	}
}

196 *
	$H–loTy³RdbLßd
(
RedisModuËIO
 *
rdb
, 
’cv”
) {

197 ià(
’cv”
 != 0) {

199  
NULL
;

201 
ušt64_t
 
–em’ts
 = 
	`RedisModuË_LßdUnsigÃd
(
rdb
);

202 
H–loTy³Objeù
 *
hto
 = 
	`ü—‹H–loTy³Objeù
();

203 
–em’ts
--) {

204 
št64_t
 
–e
 = 
	`RedisModuË_LßdSigÃd
(
rdb
);

205 
	`H–loTy³In£¹
(
hto
,
–e
);

207  
hto
;

208 
	}
}

210 
	$H–loTy³RdbSave
(
RedisModuËIO
 *
rdb
, *
v®ue
) {

211 
H–loTy³Objeù
 *
hto
 = 
v®ue
;

212 
H–loTy³Node
 *
node
 = 
hto
->
h—d
;

213 
	`RedisModuË_SaveUnsigÃd
(
rdb
,
hto
->
Ën
);

214 
node
) {

215 
	`RedisModuË_SaveSigÃd
(
rdb
,
node
->
v®ue
);

216 
node
 =‚ode->
Ãxt
;

218 
	}
}

220 
	$H–loTy³AofRewr™e
(
RedisModuËIO
 *
aof
, 
RedisModuËSŒšg
 *
key
, *
v®ue
) {

221 
H–loTy³Objeù
 *
hto
 = 
v®ue
;

222 
H–loTy³Node
 *
node
 = 
hto
->
h—d
;

223 
node
) {

224 
	`RedisModuË_Em™AOF
(
aof
,"HELLOTYPE.INSERT","¦",
key
,
node
->
v®ue
);

225 
node
 =‚ode->
Ãxt
;

227 
	}
}

229 
	$H–loTy³Dige¡
(
RedisModuËDige¡
 *
dige¡
, *
v®ue
) {

231 
	}
}

233 
	$H–loTy³F»e
(*
v®ue
) {

234 
	`H–loTy³R–—£Objeù
(
v®ue
);

235 
	}
}

239 
	$RedisModuË_OnLßd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

240 ià(
	`RedisModuË_In™
(
ùx
,"h–lÙy³",1,
REDISMODULE_APIVER_1
)

241 =ğ
REDISMODULE_ERR
)  REDISMODULE_ERR;

243 
H–loTy³
 = 
	`RedisModuË_C»©eD©aTy³
(
ùx
,"h–lÙy³",0,
H–loTy³RdbLßd
,
H–loTy³RdbSave
,
H–loTy³AofRewr™e
,
H–loTy³Dige¡
,
H–loTy³F»e
);

244 ià(
H–loTy³
 =ğ
NULL
è 
REDISMODULE_ERR
;

246 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hellotype.insert",

247 
H–loTy³In£¹_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

248  
REDISMODULE_ERR
;

250 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hellotype.range",

251 
H–loTy³Rªge_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

252  
REDISMODULE_ERR
;

254 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hellotype.len",

255 
H–loTy³L’_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

256  
REDISMODULE_ERR
;

258  
REDISMODULE_OK
;

259 
	}
}

	@modules/helloworld.c

37 
	~"../»dismoduË.h
"

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<ùy³.h
>

41 
	~<¡ršg.h
>

48 
	$H–loSim¶e_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

49 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
	`RedisModuË_G‘S–eùedDb
(ctx));

50  
REDISMODULE_OK
;

51 
	}
}

59 
	$H–loPushN©ive_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

61 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

63 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

64 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

66 
	`RedisModuË_Li¡Push
(
key
,
REDISMODULE_LIST_TAIL
,
¬gv
[2]);

67 
size_t
 
ÃwËn
 = 
	`RedisModuË_V®ueL’gth
(
key
);

68 
	`RedisModuË_Clo£Key
(
key
);

69 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
ÃwËn
);

70  
REDISMODULE_OK
;

71 
	}
}

78 
	$H–loPushC®l_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

80 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

82 
RedisModuËC®lR•ly
 *
»¶y
;

84 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"RPUSH","ss",
¬gv
[1],argv[2]);

85 
Ën
 = 
	`RedisModuË_C®lR•lyIÁeg”
(
»¶y
);

86 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

87 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Ën
);

88  
REDISMODULE_OK
;

89 
	}
}

94 
	$H–loPushC®l2_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

96 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

98 
RedisModuËC®lR•ly
 *
»¶y
;

100 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"RPUSH","ss",
¬gv
[1],argv[2]);

101 
	`RedisModuË_R•lyW™hC®lR•ly
(
ùx
,
»¶y
);

102 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

103  
REDISMODULE_OK
;

104 
	}
}

109 
	$H–loLi¡SumL’_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

111 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

113 
RedisModuËC®lR•ly
 *
»¶y
;

115 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"LRANGE","¦l",
¬gv
[1],()0,()-1);

116 
size_t
 
¡¾’
 = 0;

117 
size_t
 
™ems
 = 
	`RedisModuË_C®lR•lyL’gth
(
»¶y
);

118 
size_t
 
j
;

119 
j
 = 0; j < 
™ems
; j++) {

120 
RedisModuËC®lR•ly
 *
–e
 = 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,
j
);

121 
¡¾’
 +ğ
	`RedisModuË_C®lR•lyL’gth
(
–e
);

123 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

124 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
¡¾’
);

125  
REDISMODULE_OK
;

126 
	}
}

132 
	$H–loLi¡S¶iû_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

133 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

135 
RedisModuËKey
 *
¤ckey
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

136 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

137 
RedisModuËKey
 *
d¡key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[2],

138 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

141 ià((
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

142 
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_EMPTY
) ||

143 (
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

144 
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_EMPTY
))

146 
	`RedisModuË_Clo£Key
(
¤ckey
);

147 
	`RedisModuË_Clo£Key
(
d¡key
);

148  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

151 
couÁ
;

152 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[3],&
couÁ
è!ğ
REDISMODULE_OK
) ||

153 (
couÁ
 < 0)) {

154 
	`RedisModuË_Clo£Key
(
¤ckey
);

155 
	`RedisModuË_Clo£Key
(
d¡key
);

156  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

159 
couÁ
-- > 0) {

160 
RedisModuËSŒšg
 *
–e
;

162 
–e
 = 
	`RedisModuË_Li¡Pİ
(
¤ckey
,
REDISMODULE_LIST_TAIL
);

163 ià(
–e
 =ğ
NULL
) ;

164 
	`RedisModuË_Li¡Push
(
d¡key
,
REDISMODULE_LIST_HEAD
,
–e
);

165 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

168 
size_t
 
Ën
 = 
	`RedisModuË_V®ueL’gth
(
¤ckey
);

169 
	`RedisModuË_Clo£Key
(
¤ckey
);

170 
	`RedisModuË_Clo£Key
(
d¡key
);

171 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Ën
);

172  
REDISMODULE_OK
;

173 
	}
}

177 
	$H–loLi¡S¶iûAuto_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

178 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

180 
	`RedisModuË_AutoMemÜy
(
ùx
);

182 
RedisModuËKey
 *
¤ckey
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

183 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

184 
RedisModuËKey
 *
d¡key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[2],

185 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

188 ià((
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

189 
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_EMPTY
) ||

190 (
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

191 
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_EMPTY
))

193  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

196 
couÁ
;

197 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[3],&
couÁ
è!ğ
REDISMODULE_OK
) ||

198 (
couÁ
 < 0))

200  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

203 
couÁ
-- > 0) {

204 
RedisModuËSŒšg
 *
–e
;

206 
–e
 = 
	`RedisModuË_Li¡Pİ
(
¤ckey
,
REDISMODULE_LIST_TAIL
);

207 ià(
–e
 =ğ
NULL
) ;

208 
	`RedisModuË_Li¡Push
(
d¡key
,
REDISMODULE_LIST_HEAD
,
–e
);

211 
size_t
 
Ën
 = 
	`RedisModuË_V®ueL’gth
(
¤ckey
);

212 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Ën
);

213  
REDISMODULE_OK
;

214 
	}
}

219 
	$H–loRªdA¼ay_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

220 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

221 
couÁ
;

222 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[1],&
couÁ
è!ğ
REDISMODULE_OK
 ||

223 
couÁ
 < 0)

224  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

229 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
couÁ
);

230 
couÁ
--è
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
	`¿nd
());

231  
REDISMODULE_OK
;

232 
	}
}

238 
	$H–loR•l1_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

240 
RedisModuËC®lR•ly
 *
»¶y
;

241 
	`RedisModuË_AutoMemÜy
(
ùx
);

253 
	`RedisModuË_R•liÿ‹
(
ùx
,"ECHO","c","foo");

257 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"INCR","c!","foo");

258 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"INCR","c!","bar");

260 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,0);

262  
REDISMODULE_OK
;

263 
	}
}

275 
	$H–loR•l2_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

276 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

278 
	`RedisModuË_AutoMemÜy
(
ùx
);

279 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

280 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

282 ià(
	`RedisModuË_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_LIST
)

283  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

285 
size_t
 
li¡Ën
 = 
	`RedisModuË_V®ueL’gth
(
key
);

286 
sum
 = 0;

289 
li¡Ën
--) {

290 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Li¡Pİ
(
key
,
REDISMODULE_LIST_TAIL
);

291 
v®
;

292 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
–e
,&
v®
è!ğ
REDISMODULE_OK
) val = 0;

293 
v®
++;

294 
sum
 +ğ
v®
;

295 
RedisModuËSŒšg
 *
Ãw–e
 = 
	`RedisModuË_C»©eSŒšgFromLÚgLÚg
(
ùx
,
v®
);

296 
	`RedisModuË_Li¡Push
(
key
,
REDISMODULE_LIST_HEAD
,
Ãw–e
);

298 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
sum
);

299 
	`RedisModuË_R•liÿ‹V”b©im
(
ùx
);

300  
REDISMODULE_OK
;

301 
	}
}

311 
	$H–loToggËCa£_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

312 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

314 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

315 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

317 
keyty³
 = 
	`RedisModuË_KeyTy³
(
key
);

318 ià(
keyty³
 !ğ
REDISMODULE_KEYTYPE_STRING
 &&

319 
keyty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
)

321 
	`RedisModuË_Clo£Key
(
key
);

322  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

325 ià(
keyty³
 =ğ
REDISMODULE_KEYTYPE_STRING
) {

326 
size_t
 
Ën
, 
j
;

327 *
s
 = 
	`RedisModuË_SŒšgDMA
(
key
,&
Ën
,
REDISMODULE_WRITE
);

328 
j
 = 0; j < 
Ën
; j++) {

329 ià(
	`isuµ”
(
s
[
j
])) {

330 
s
[
j
] = 
	`tŞow”
(s[j]);

332 
s
[
j
] = 
	`touµ”
(s[j]);

337 
	`RedisModuË_Clo£Key
(
key
);

338 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"OK");

339 
	`RedisModuË_R•liÿ‹V”b©im
(
ùx
);

340  
REDISMODULE_OK
;

341 
	}
}

347 
	$H–loMÜeExpœe_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

348 
	`RedisModuË_AutoMemÜy
(
ùx
);

349 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

351 
m¡ime_t
 
addms
, 
expœe
;

353 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
addms
è!ğ
REDISMODULE_OK
)

354  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalidƒxpireime");

356 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

357 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

358 
expœe
 = 
	`RedisModuË_G‘Expœe
(
key
);

359 ià(
expœe
 !ğ
REDISMODULE_NO_EXPIRE
) {

360 
expœe
 +ğ
addms
;

361 
	`RedisModuË_S‘Expœe
(
key
,
expœe
);

363  
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"OK");

364 
	}
}

372 
	$H–loZsumRªge_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

373 
scÜe_¡¬t
, 
scÜe_’d
;

374 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

376 ià(
	`RedisModuË_SŒšgToDoubË
(
¬gv
[2],&
scÜe_¡¬t
è!ğ
REDISMODULE_OK
 ||

377 
	`RedisModuË_SŒšgToDoubË
(
¬gv
[3],&
scÜe_’d
è!ğ
REDISMODULE_OK
)

379  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid„ange");

382 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

383 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

384 ià(
	`RedisModuË_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_ZSET
) {

385  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

388 
scÜesum_a
 = 0;

389 
scÜesum_b
 = 0;

391 
	`RedisModuË_Z£tFœ¡InScÜeRªge
(
key
,
scÜe_¡¬t
,
scÜe_’d
,0,0);

392 !
	`RedisModuË_Z£tRªgeEndR—ched
(
key
)) {

393 
scÜe
;

394 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Z£tRªgeCu¼’tEËm’t
(
key
,&
scÜe
);

395 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

396 
scÜesum_a
 +ğ
scÜe
;

397 
	`RedisModuË_Z£tRªgeNext
(
key
);

399 
	`RedisModuË_Z£tRªgeStİ
(
key
);

401 
	`RedisModuË_Z£tLa¡InScÜeRªge
(
key
,
scÜe_¡¬t
,
scÜe_’d
,0,0);

402 !
	`RedisModuË_Z£tRªgeEndR—ched
(
key
)) {

403 
scÜe
;

404 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Z£tRªgeCu¼’tEËm’t
(
key
,&
scÜe
);

405 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

406 
scÜesum_b
 +ğ
scÜe
;

407 
	`RedisModuË_Z£tRªgeP»v
(
key
);

410 
	`RedisModuË_Z£tRªgeStİ
(
key
);

412 
	`RedisModuË_Clo£Key
(
key
);

414 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,2);

415 
	`RedisModuË_R•lyW™hDoubË
(
ùx
,
scÜesum_a
);

416 
	`RedisModuË_R•lyW™hDoubË
(
ùx
,
scÜesum_b
);

417  
REDISMODULE_OK
;

418 
	}
}

427 
	$H–loLexRªge_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

428 
	`RedisModuË_AutoMemÜy
(
ùx
);

430 ià(
¬gc
 !ğ6è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

432 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

433 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

434 ià(
	`RedisModuË_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_ZSET
) {

435  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

438 ià(
	`RedisModuË_Z£tFœ¡InLexRªge
(
key
,
¬gv
[2],¬gv[3]è!ğ
REDISMODULE_OK
) {

439  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"invalid„ange");

442 
¬¿yËn
 = 0;

443 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
REDISMODULE_POSTPONED_ARRAY_LEN
);

444 !
	`RedisModuË_Z£tRªgeEndR—ched
(
key
)) {

445 
scÜe
;

446 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Z£tRªgeCu¼’tEËm’t
(
key
,&
scÜe
);

447 
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
–e
);

448 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

449 
	`RedisModuË_Z£tRªgeNext
(
key
);

450 
¬¿yËn
++;

452 
	`RedisModuË_Z£tRªgeStİ
(
key
);

453 
	`RedisModuË_R•lyS‘A¼ayL’gth
(
ùx
,
¬¿yËn
);

454 
	`RedisModuË_Clo£Key
(
key
);

455  
REDISMODULE_OK
;

456 
	}
}

465 
	$H–loHCİy_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

466 
	`RedisModuË_AutoMemÜy
(
ùx
);

468 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

469 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

470 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

471 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

472 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_HASH
 &&

473 
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
)

475  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

479 
RedisModuËSŒšg
 *
Şdv®
;

480 
	`RedisModuË_HashG‘
(
key
,
REDISMODULE_HASH_NONE
,
¬gv
[2],&
Şdv®
,
NULL
);

481 ià(
Şdv®
) {

482 
	`RedisModuË_HashS‘
(
key
,
REDISMODULE_HASH_NONE
,
¬gv
[3],
Şdv®
,
NULL
);

484 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Şdv®
 !ğ
NULL
);

485  
REDISMODULE_OK
;

486 
	}
}

506 
	$H–loLeáPad_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

507 
	`RedisModuË_AutoMemÜy
(
ùx
);

508 
·dËn
;

510 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

512 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
·dËn
è!ğ
REDISMODULE_OK
) ||

513 (
·dËn
< 0)) {

514  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid…adding†ength");

516 
size_t
 
¡¾’
, 
chËn
;

517 cÚ¡ *
¡r
 = 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[1], &
¡¾’
);

518 cÚ¡ *
ch
 = 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[3], &
chËn
);

522 ià(
¡¾’
 >ğ
·dËn
)

523  
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
¬gv
[1]);

526 ià(
chËn
 != 1)

527  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,

531 
·dËn
 -ğ
¡¾’
;

532 *
buf
 = 
	`RedisModuË_PoŞAÎoc
(
ùx
,
·dËn
+
¡¾’
);

533 
size_t
 
j
 = 0; j < 
·dËn
; j++è
buf
[j] = *
ch
;

534 
	`memıy
(
buf
+
·dËn
,
¡r
,
¡¾’
);

536 
	`RedisModuË_R•lyW™hSŒšgBufãr
(
ùx
,
buf
,
·dËn
+
¡¾’
);

537  
REDISMODULE_OK
;

538 
	}
}

542 
	$RedisModuË_OnLßd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

543 ià(
	`RedisModuË_In™
(
ùx
,"h–lowÜld",1,
REDISMODULE_APIVER_1
)

544 =ğ
REDISMODULE_ERR
)  REDISMODULE_ERR;

547 
j
 = 0; j < 
¬gc
; j++) {

548 cÚ¡ *
s
 = 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[
j
],
NULL
);

549 
	`´štf
("ModuË†ßded w™h ARGV[%d] = %s\n", 
j
, 
s
);

552 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.simple",

553 
H–loSim¶e_RedisCommªd
,"»adÚly",0,0,0è=ğ
REDISMODULE_ERR
)

554  
REDISMODULE_ERR
;

556 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.push.native",

557 
H–loPushN©ive_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

558  
REDISMODULE_ERR
;

560 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.push.call",

561 
H–loPushC®l_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

562  
REDISMODULE_ERR
;

564 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.push.call2",

565 
H–loPushC®l2_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

566  
REDISMODULE_ERR
;

568 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.list.sum.len",

569 
H–loLi¡SumL’_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

570  
REDISMODULE_ERR
;

572 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.list.splice",

573 
H–loLi¡S¶iû_RedisCommªd
,"wr™d’y-oom",1,2,1è=ğ
REDISMODULE_ERR
)

574  
REDISMODULE_ERR
;

576 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.list.splice.auto",

577 
H–loLi¡S¶iûAuto_RedisCommªd
,

578 "wr™d’y-oom",1,2,1è=ğ
REDISMODULE_ERR
)

579  
REDISMODULE_ERR
;

581 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.rand.array",

582 
H–loRªdA¼ay_RedisCommªd
,"»adÚly",0,0,0è=ğ
REDISMODULE_ERR
)

583  
REDISMODULE_ERR
;

585 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.repl1",

586 
H–loR•l1_RedisCommªd
,"wr™e",0,0,0è=ğ
REDISMODULE_ERR
)

587  
REDISMODULE_ERR
;

589 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.repl2",

590 
H–loR•l2_RedisCommªd
,"wr™e",1,1,1è=ğ
REDISMODULE_ERR
)

591  
REDISMODULE_ERR
;

593 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.toggle.case",

594 
H–loToggËCa£_RedisCommªd
,"wr™e",1,1,1è=ğ
REDISMODULE_ERR
)

595  
REDISMODULE_ERR
;

597 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.more.expire",

598 
H–loMÜeExpœe_RedisCommªd
,"wr™e",1,1,1è=ğ
REDISMODULE_ERR
)

599  
REDISMODULE_ERR
;

601 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.zsumrange",

602 
H–loZsumRªge_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

603  
REDISMODULE_ERR
;

605 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.lexrange",

606 
H–loLexRªge_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

607  
REDISMODULE_ERR
;

609 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.hcopy",

610 
H–loHCİy_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

611  
REDISMODULE_ERR
;

613 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.leftpad",

614 
H–loLeáPad_RedisCommªd
,"",1,1,1è=ğ
REDISMODULE_ERR
)

615  
REDISMODULE_ERR
;

617  
REDISMODULE_OK
;

618 
	}
}

	@multi.c

30 
	~"£rv”.h
"

35 
	$š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

36 
c
->
m¡©e
.
commªds
 = 
NULL
;

37 
c
->
m¡©e
.
couÁ
 = 0;

38 
	}
}

41 
	$ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

42 
j
;

44 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

45 
i
;

46 
muÉiCmd
 *
mc
 = 
c
->
m¡©e
.
commªds
+
j
;

48 
i
 = 0; i < 
mc
->
¬gc
; i++)

49 
	`deüRefCouÁ
(
mc
->
¬gv
[
i
]);

50 
	`zä“
(
mc
->
¬gv
);

52 
	`zä“
(
c
->
m¡©e
.
commªds
);

53 
	}
}

56 
	$queueMuÉiCommªd
(
ş›Á
 *
c
) {

57 
muÉiCmd
 *
mc
;

58 
j
;

60 
c
->
m¡©e
.
commªds
 = 
	`z»®loc
(c->mstate.commands,

61 (
muÉiCmd
)*(
c
->
m¡©e
.
couÁ
+1));

62 
mc
 = 
c
->
m¡©e
.
commªds
+c->m¡©e.
couÁ
;

63 
mc
->
cmd
 = 
c
->cmd;

64 
mc
->
¬gc
 = 
c
->argc;

65 
mc
->
¬gv
 = 
	`zm®loc
((
robj
*)*
c
->
¬gc
);

66 
	`memıy
(
mc
->
¬gv
,
c
->¬gv,(
robj
*)*c->
¬gc
);

67 
j
 = 0; j < 
c
->
¬gc
; j++)

68 
	`šüRefCouÁ
(
mc
->
¬gv
[
j
]);

69 
c
->
m¡©e
.
couÁ
++;

70 
	}
}

72 
	$disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
) {

73 
	`ä“Cl›ÁMuÉiS‹
(
c
);

74 
	`š™Cl›ÁMuÉiS‹
(
c
);

75 
c
->
æags
 &ğ~(
CLIENT_MULTI
|
CLIENT_DIRTY_CAS
|
CLIENT_DIRTY_EXEC
);

76 
	`unw©chAÎKeys
(
c
);

77 
	}
}

81 
	$æagT¿n§ùiÚ
(
ş›Á
 *
c
) {

82 ià(
c
->
æags
 & 
CLIENT_MULTI
)

83 
c
->
æags
 |ğ
CLIENT_DIRTY_EXEC
;

84 
	}
}

86 
	$muÉiCommªd
(
ş›Á
 *
c
) {

87 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

88 
	`addR•lyE¼Ü
(
c
,"MULTI calls can‚ot be‚ested");

91 
c
->
æags
 |ğ
CLIENT_MULTI
;

92 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

93 
	}
}

95 
	$disÿrdCommªd
(
ş›Á
 *
c
) {

96 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)) {

97 
	`addR•lyE¼Ü
(
c
,"DISCARD without MULTI");

100 
	`disÿrdT¿n§ùiÚ
(
c
);

101 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

102 
	}
}

106 
	$execCommªdPrİag©eMuÉi
(
ş›Á
 *
c
) {

107 
robj
 *
muÉi¡ršg
 = 
	`ü—‹SŒšgObjeù
("MULTI",5);

109 
	`´İag©e
(
£rv”
.
muÉiCommªd
,
c
->
db
->
id
,&
muÉi¡ršg
,1,

110 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

111 
	`deüRefCouÁ
(
muÉi¡ršg
);

112 
	}
}

114 
	$execCommªd
(
ş›Á
 *
c
) {

115 
j
;

116 
robj
 **
Üig_¬gv
;

117 
Üig_¬gc
;

118 
»disCommªd
 *
Üig_cmd
;

119 
mu¡_´İag©e
 = 0;

121 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)) {

122 
	`addR•lyE¼Ü
(
c
,"EXEC without MULTI");

132 ià(
c
->
æags
 & (
CLIENT_DIRTY_CAS
|
CLIENT_DIRTY_EXEC
)) {

133 
	`addR•ly
(
c
, c->
æags
 & 
CLIENT_DIRTY_EXEC
 ? 
sh¬ed
.
exeÿbÜ‹¼
 :

134 
sh¬ed
.
nuÎmuÉibulk
);

135 
	`disÿrdT¿n§ùiÚ
(
c
);

136 
hªdË_mÚ™Ü
;

140 
	`unw©chAÎKeys
(
c
);

141 
Üig_¬gv
 = 
c
->
¬gv
;

142 
Üig_¬gc
 = 
c
->
¬gc
;

143 
Üig_cmd
 = 
c
->
cmd
;

144 
	`addR•lyMuÉiBulkL’
(
c
,c->
m¡©e
.
couÁ
);

145 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

146 
c
->
¬gc
 = c->
m¡©e
.
commªds
[
j
].argc;

147 
c
->
¬gv
 = c->
m¡©e
.
commªds
[
j
].argv;

148 
c
->
cmd
 = c->
m¡©e
.
commªds
[
j
].cmd;

154 ià(!
mu¡_´İag©e
 && !(
c
->
cmd
->
æags
 & 
CMD_READONLY
)) {

155 
	`execCommªdPrİag©eMuÉi
(
c
);

156 
mu¡_´İag©e
 = 1;

159 
	`ÿÎ
(
c
,
CMD_CALL_FULL
);

162 
c
->
m¡©e
.
commªds
[
j
].
¬gc
 = c->argc;

163 
c
->
m¡©e
.
commªds
[
j
].
¬gv
 = c->argv;

164 
c
->
m¡©e
.
commªds
[
j
].
cmd
 = c->cmd;

166 
c
->
¬gv
 = 
Üig_¬gv
;

167 
c
->
¬gc
 = 
Üig_¬gc
;

168 
c
->
cmd
 = 
Üig_cmd
;

169 
	`disÿrdT¿n§ùiÚ
(
c
);

172 ià(
mu¡_´İag©e
è
£rv”
.
dœty
++;

174 
hªdË_mÚ™Ü
:

180 ià(
	`li¡L’gth
(
£rv”
.
mÚ™Üs
è&& !£rv”.
lßdšg
)

181 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

182 
	}
}

196 
	sw©chedKey
 {

197 
robj
 *
	mkey
;

198 
»disDb
 *
	mdb
;

199 } 
	tw©chedKey
;

202 
	$w©chFÜKey
(
ş›Á
 *
c
, 
robj
 *
key
) {

203 
li¡
 *
ş›Ás
 = 
NULL
;

204 
li¡I‹r
 
li
;

205 
li¡Node
 *
Ê
;

206 
w©chedKey
 *
wk
;

209 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li
);

210 (
Ê
 = 
	`li¡Next
(&
li
))) {

211 
wk
 = 
	`li¡NodeV®ue
(
Ê
);

212 ià(
wk
->
db
 =ğ
c
->db && 
	`equ®SŒšgObjeùs
(
key
,wk->key))

216 
ş›Ás
 = 
	`diùF‘chV®ue
(
c
->
db
->
w©ched_keys
,
key
);

217 ià(!
ş›Ás
) {

218 
ş›Ás
 = 
	`li¡C»©e
();

219 
	`diùAdd
(
c
->
db
->
w©ched_keys
,
key
,
ş›Ás
);

220 
	`šüRefCouÁ
(
key
);

222 
	`li¡AddNodeTa
(
ş›Ás
,
c
);

224 
wk
 = 
	`zm®loc
((*wk));

225 
wk
->
key
 = key;

226 
wk
->
db
 = 
c
->db;

227 
	`šüRefCouÁ
(
key
);

228 
	`li¡AddNodeTa
(
c
->
w©ched_keys
,
wk
);

229 
	}
}

233 
	$unw©chAÎKeys
(
ş›Á
 *
c
) {

234 
li¡I‹r
 
li
;

235 
li¡Node
 *
Ê
;

237 ià(
	`li¡L’gth
(
c
->
w©ched_keys
) == 0) ;

238 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li
);

239 (
Ê
 = 
	`li¡Next
(&
li
))) {

240 
li¡
 *
ş›Ás
;

241 
w©chedKey
 *
wk
;

245 
wk
 = 
	`li¡NodeV®ue
(
Ê
);

246 
ş›Ás
 = 
	`diùF‘chV®ue
(
wk
->
db
->
w©ched_keys
, wk->
key
);

247 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
ş›Ás
 != NULL);

248 
	`li¡D–Node
(
ş›Ás
,
	`li¡S—rchKey
(ş›Ás,
c
));

250 ià(
	`li¡L’gth
(
ş›Ás
) == 0)

251 
	`diùD–‘e
(
wk
->
db
->
w©ched_keys
, wk->
key
);

253 
	`li¡D–Node
(
c
->
w©ched_keys
,
Ê
);

254 
	`deüRefCouÁ
(
wk
->
key
);

255 
	`zä“
(
wk
);

257 
	}
}

261 
	$touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
) {

262 
li¡
 *
ş›Ás
;

263 
li¡I‹r
 
li
;

264 
li¡Node
 *
Ê
;

266 ià(
	`diùSize
(
db
->
w©ched_keys
) == 0) ;

267 
ş›Ás
 = 
	`diùF‘chV®ue
(
db
->
w©ched_keys
, 
key
);

268 ià(!
ş›Ás
) ;

272 
	`li¡Rewšd
(
ş›Ás
,&
li
);

273 (
Ê
 = 
	`li¡Next
(&
li
))) {

274 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

276 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

278 
	}
}

284 
	$touchW©chedKeysOnFlush
(
dbid
) {

285 
li¡I‹r
 
li1
, 
li2
;

286 
li¡Node
 *
Ê
;

289 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li1
);

290 (
Ê
 = 
	`li¡Next
(&
li1
))) {

291 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

292 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li2
);

293 (
Ê
 = 
	`li¡Next
(&
li2
))) {

294 
w©chedKey
 *
wk
 = 
	`li¡NodeV®ue
(
Ê
);

299 ià(
dbid
 =ğ-1 || 
wk
->
db
->
id
 == dbid) {

300 ià(
	`diùFšd
(
wk
->
db
->
diù
, wk->
key
->
±r
è!ğ
NULL
)

301 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

305 
	}
}

307 
	$w©chCommªd
(
ş›Á
 *
c
) {

308 
j
;

310 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

311 
	`addR•lyE¼Ü
(
c
,"WATCH inside MULTI is‚ot‡llowed");

314 
j
 = 1; j < 
c
->
¬gc
; j++)

315 
	`w©chFÜKey
(
c
,c->
¬gv
[
j
]);

316 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

317 
	}
}

319 
	$unw©chCommªd
(
ş›Á
 *
c
) {

320 
	`unw©chAÎKeys
(
c
);

321 
c
->
æags
 &ğ(~
CLIENT_DIRTY_CAS
);

322 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

323 
	}
}

	@networking.c

30 
	~"£rv”.h
"

31 
	~<sys/uio.h
>

32 
	~<m©h.h
>

34 
£tPrÙocŞE¼Ü
(
ş›Á
 *
c
, 
pos
);

39 
size_t
 
	$sdsZm®locSize
(
sds
 
s
) {

40 *
sh
 = 
	`sdsAÎocPŒ
(
s
);

41  
	`zm®loc_size
(
sh
);

42 
	}
}

46 
size_t
 
	$g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
) {

47 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

48 
o
->
’codšg
) {

49 
OBJ_ENCODING_RAW
:  
	`sdsZm®locSize
(
o
->
±r
);

50 
OBJ_ENCODING_EMBSTR
:  
	`zm®loc_size
(
o
)-(
robj
);

53 
	}
}

56 *
	$dupCl›ÁR•lyV®ue
(*
o
) {

57  
	`sdsdup
(
o
);

58 
	}
}

60 
	$ä“Cl›ÁR•lyV®ue
(*
o
) {

61 
	`sdsä“
(
o
);

62 
	}
}

64 
	$li¡M©chObjeùs
(*
a
, *
b
) {

65  
	`equ®SŒšgObjeùs
(
a
,
b
);

66 
	}
}

68 
ş›Á
 *
	$ü—‹Cl›Á
(
fd
) {

69 
ş›Á
 *
c
 = 
	`zm®loc
((client));

75 ià(
fd
 != -1) {

76 
	`ª‘NÚBlock
(
NULL
,
fd
);

77 
	`ª‘EÇbËTıNoD–ay
(
NULL
,
fd
);

78 ià(
£rv”
.
tık“·live
)

79 
	`ª‘K“pAlive
(
NULL
,
fd
,
£rv”
.
tık“·live
);

80 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
,

81 
»adQu”yFromCl›Á
, 
c
è=ğ
AE_ERR
)

83 
	`şo£
(
fd
);

84 
	`zä“
(
c
);

85  
NULL
;

89 
	`£ËùDb
(
c
,0);

90 
c
->
id
 = 
£rv”
.
Ãxt_ş›Á_id
++;

91 
c
->
fd
 = fd;

92 
c
->
Çme
 = 
NULL
;

93 
c
->
buåos
 = 0;

94 
c
->
qu”ybuf
 = 
	`sd£m±y
();

95 
c
->
qu”ybuf_³ak
 = 0;

96 
c
->
»qty³
 = 0;

97 
c
->
¬gc
 = 0;

98 
c
->
¬gv
 = 
NULL
;

99 
c
->
cmd
 = c->
Ï¡cmd
 = 
NULL
;

100 
c
->
muÉibulkËn
 = 0;

101 
c
->
bulkËn
 = -1;

102 
c
->
£ÁËn
 = 0;

103 
c
->
æags
 = 0;

104 
c
->
ùime
 = c->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

105 
c
->
auth’tiÿ‹d
 = 0;

106 
c
->
»¶¡©e
 = 
REPL_STATE_NONE
;

107 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

108 
c
->
»¶off
 = 0;

109 
c
->
»¶_ack_off
 = 0;

110 
c
->
»¶_ack_time
 = 0;

111 
c
->
¦ave_li¡’šg_pÜt
 = 0;

112 
c
->
¦ave_ÿ·
 = 
SLAVE_CAPA_NONE
;

113 
c
->
»¶y
 = 
	`li¡C»©e
();

114 
c
->
»¶y_by‹s
 = 0;

115 
c
->
obuf_soá_lim™_»ached_time
 = 0;

116 
	`li¡S‘F»eM‘hod
(
c
->
»¶y
,
ä“Cl›ÁR•lyV®ue
);

117 
	`li¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

118 
c
->
bty³
 = 
BLOCKED_NONE
;

119 
c
->
bpİ
.
timeout
 = 0;

120 
c
->
bpİ
.
keys
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

121 
c
->
bpİ
.
rg‘
 = 
NULL
;

122 
c
->
bpİ
.
num»¶iÿs
 = 0;

123 
c
->
bpİ
.
»¶off£t
 = 0;

124 
c
->
woff
 = 0;

125 
c
->
w©ched_keys
 = 
	`li¡C»©e
();

126 
c
->
pubsub_chªÃls
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

127 
c
->
pubsub_·‰”ns
 = 
	`li¡C»©e
();

128 
c
->
³”id
 = 
NULL
;

129 
	`li¡S‘F»eM‘hod
(
c
->
pubsub_·‰”ns
,
deüRefCouÁVoid
);

130 
	`li¡S‘M©chM‘hod
(
c
->
pubsub_·‰”ns
,
li¡M©chObjeùs
);

131 ià(
fd
 !ğ-1è
	`li¡AddNodeTa
(
£rv”
.
ş›Ás
,
c
);

132 
	`š™Cl›ÁMuÉiS‹
(
c
);

133  
c
;

134 
	}
}

158 
	$´•¬eCl›ÁToWr™e
(
ş›Á
 *
c
) {

161 ià(
c
->
æags
 & (
CLIENT_LUA
|
CLIENT_MODULE
)è 
C_OK
;

164 ià(
c
->
æags
 & (
CLIENT_REPLY_OFF
|
CLIENT_REPLY_SKIP
)è 
C_ERR
;

168 ià((
c
->
æags
 & 
CLIENT_MASTER
) &&

169 !(
c
->
æags
 & 
CLIENT_MASTER_FORCE_REPLY
)è 
C_ERR
;

171 ià(
c
->
fd
 <ğ0è 
C_ERR
;

177 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

178 !(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) &&

179 (
c
->
»¶¡©e
 =ğ
REPL_STATE_NONE
 ||

180 (
c
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 && !c->
»¶_put_Úlše_Ú_ack
)))

188 
c
->
æags
 |ğ
CLIENT_PENDING_WRITE
;

189 
	`li¡AddNodeH—d
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
c
);

193  
C_OK
;

194 
	}
}

200 
	$_addR•lyToBufãr
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

201 
size_t
 
avaabË
 = (
c
->
buf
)-c->
buåos
;

203 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è 
C_OK
;

207 ià(
	`li¡L’gth
(
c
->
»¶y
è> 0è 
C_ERR
;

210 ià(
Ën
 > 
avaabË
è 
C_ERR
;

212 
	`memıy
(
c
->
buf
+c->
buåos
,
s
,
Ën
);

213 
c
->
buåos
+=
Ën
;

214  
C_OK
;

215 
	}
}

217 
	$_addR•lyObjeùToLi¡
(
ş›Á
 *
c
, 
robj
 *
o
) {

218 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

220 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

221 
sds
 
s
 = 
	`sdsdup
(
o
->
±r
);

222 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

223 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

225 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
c
->
»¶y
);

226 
sds
 

 = 
	`li¡NodeV®ue
(
Ê
);

230 ià(

 && 
	`sd¦’
Ña)+sd¦’(
o
->
±r
è<ğ
PROTO_REPLY_CHUNK_BYTES
) {

231 

 = 
	`sdsÿtsds
Ña,
o
->
±r
);

232 
	`li¡NodeV®ue
(
Ê
èğ

;

233 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
o
->
±r
);

235 
sds
 
s
 = 
	`sdsdup
(
o
->
±r
);

236 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

237 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

240 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

241 
	}
}

245 
	$_addR•lySdsToLi¡
(
ş›Á
 *
c
, 
sds
 
s
) {

246 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

247 
	`sdsä“
(
s
);

251 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

252 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

253 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

255 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
c
->
»¶y
);

256 
sds
 

 = 
	`li¡NodeV®ue
(
Ê
);

260 ià(

 && 
	`sd¦’
Ña)+sd¦’(
s
è<ğ
PROTO_REPLY_CHUNK_BYTES
) {

261 

 = 
	`sdsÿtsds
Ña,
s
);

262 
	`li¡NodeV®ue
(
Ê
èğ

;

263 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

264 
	`sdsä“
(
s
);

266 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

267 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

270 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

271 
	}
}

273 
	$_addR•lySŒšgToLi¡
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

274 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

276 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

277 
sds
 
node
 = 
	`sd¢ewËn
(
s
,
Ën
);

278 
	`li¡AddNodeTa
(
c
->
»¶y
,
node
);

279 
c
->
»¶y_by‹s
 +ğ
Ën
;

281 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
c
->
»¶y
);

282 
sds
 

 = 
	`li¡NodeV®ue
(
Ê
);

286 ià(

 && 
	`sd¦’
Ña)+
Ën
 <ğ
PROTO_REPLY_CHUNK_BYTES
) {

287 

 = 
	`sdsÿ’
Ña,
s
,
Ën
);

288 
	`li¡NodeV®ue
(
Ê
èğ

;

289 
c
->
»¶y_by‹s
 +ğ
Ën
;

291 
sds
 
node
 = 
	`sd¢ewËn
(
s
,
Ën
);

292 
	`li¡AddNodeTa
(
c
->
»¶y
,
node
);

293 
c
->
»¶y_by‹s
 +ğ
Ën
;

296 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

297 
	}
}

304 
	$addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
) {

305 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
) ;

314 ià(
	`sdsEncodedObjeù
(
obj
)) {

315 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
C_OK
)

316 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

317 } ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

321 ià(
	`li¡L’gth
(
c
->
»¶y
è=ğ0 && ((c->
buf
è- c->
buåos
) >= 32) {

322 
buf
[32];

323 
Ën
;

325 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
obj
->
±r
);

326 ià(
	`_addR•lyToBufãr
(
c
,
buf
,
Ën
è=ğ
C_OK
)

331 
obj
 = 
	`g‘DecodedObjeù
(obj);

332 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
C_OK
)

333 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

334 
	`deüRefCouÁ
(
obj
);

336 
	`£rv”Pªic
("Wrong obj->encoding in‡ddReply()");

338 
	}
}

340 
	$addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
) {

341 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
) {

343 
	`sdsä“
(
s
);

346 ià(
	`_addR•lyToBufãr
(
c
,
s
,
	`sd¦’
(s)è=ğ
C_OK
) {

347 
	`sdsä“
(
s
);

350 
	`_addR•lySdsToLi¡
(
c
,
s
);

352 
	}
}

354 
	$addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

355 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
) ;

356 ià(
	`_addR•lyToBufãr
(
c
,
s
,
Ën
è!ğ
C_OK
)

357 
	`_addR•lySŒšgToLi¡
(
c
,
s
,
Ën
);

358 
	}
}

360 
	$addR•lyE¼ÜL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

361 
	`addR•lySŒšg
(
c
,"-ERR ",5);

362 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

363 
	`addR•lySŒšg
(
c
,"\r\n",2);

364 
	}
}

366 
	$addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
) {

367 
	`addR•lyE¼ÜL’gth
(
c
,
”r
,
	`¡¾’
(err));

368 
	}
}

370 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

371 
size_t
 
l
, 
j
;

372 
va_li¡
 
­
;

373 
	`va_¡¬t
(
­
,
fmt
);

374 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

375 
	`va_’d
(
­
);

378 
l
 = 
	`sd¦’
(
s
);

379 
j
 = 0; j < 
l
; j++) {

380 ià(
s
[
j
] == '\r' || s[j] == '\n') s[j] = ' ';

382 
	`addR•lyE¼ÜL’gth
(
c
,
s
,
	`sd¦’
(s));

383 
	`sdsä“
(
s
);

384 
	}
}

386 
	$addR•lyStusL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

387 
	`addR•lySŒšg
(
c
,"+",1);

388 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

389 
	`addR•lySŒšg
(
c
,"\r\n",2);

390 
	}
}

392 
	$addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
) {

393 
	`addR•lyStusL’gth
(
c
,
¡©us
,
	`¡¾’
(status));

394 
	}
}

396 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

397 
va_li¡
 
­
;

398 
	`va_¡¬t
(
­
,
fmt
);

399 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

400 
	`va_’d
(
­
);

401 
	`addR•lyStusL’gth
(
c
,
s
,
	`sd¦’
(s));

402 
	`sdsä“
(
s
);

403 
	}
}

407 *
	$addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
) {

411 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
è 
NULL
;

412 
	`li¡AddNodeTa
(
c
->
»¶y
,
NULL
);

413  
	`li¡La¡
(
c
->
»¶y
);

414 
	}
}

417 
	$£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
) {

418 
li¡Node
 *
Ê
 = (li¡Node*)
node
;

419 
sds
 
Ën
, 
Ãxt
;

423 ià(
node
 =ğ
NULL
) ;

425 
Ën
 = 
	`sdsÿrštf
(
	`sd¢ewËn
("*",1),"%ld\r\n",
Ëngth
);

426 
	`li¡NodeV®ue
(
Ê
èğ
Ën
;

427 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
Ën
);

428 ià(
Ê
->
Ãxt
 !ğ
NULL
) {

429 
Ãxt
 = 
	`li¡NodeV®ue
(
Ê
->next);

432 ià(
Ãxt
 !ğ
NULL
) {

433 
Ën
 = 
	`sdsÿtsds
Ö’,
Ãxt
);

434 
	`li¡D–Node
(
c
->
»¶y
,
Ê
->
Ãxt
);

435 
	`li¡NodeV®ue
(
Ê
èğ
Ën
;

440 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

441 
	}
}

444 
	$addR•lyDoubË
(
ş›Á
 *
c
, 
d
) {

445 
dbuf
[128], 
sbuf
[128];

446 
dËn
, 
¦’
;

447 ià(
	`isšf
(
d
)) {

450 
	`addR•lyBulkCSŒšg
(
c
, 
d
 > 0 ? "inf" : "-inf");

452 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

453 
¦’
 = 
	`¢´štf
(
sbuf
,(sbuf),"$%d\r\n%s\r\n",
dËn
,
dbuf
);

454 
	`addR•lySŒšg
(
c
,
sbuf
,
¦’
);

456 
	}
}

461 
	$addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
) {

462 
robj
 *
o
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
d
,1);

463 
	`addR•lyBulk
(
c
,
o
);

464 
	`deüRefCouÁ
(
o
);

465 
	}
}

469 
	$addR•lyLÚgLÚgW™hP»fix
(
ş›Á
 *
c
, 
Î
, 
´efix
) {

470 
buf
[128];

471 
Ën
;

476 ià(
´efix
 =ğ'*' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

477 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Î
]);

479 } ià(
´efix
 =ğ'$' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

480 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Î
]);

484 
buf
[0] = 
´efix
;

485 
Ën
 = 
	`Î2¡ršg
(
buf
+1,(buf)-1,
Î
);

486 
buf
[
Ën
+1] = '\r';

487 
buf
[
Ën
+2] = '\n';

488 
	`addR•lySŒšg
(
c
,
buf
,
Ën
+3);

489 
	}
}

491 
	$addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

492 ià(
Î
 == 0)

493 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

494 ià(
Î
 == 1)

495 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

497 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Î
,':');

498 
	}
}

500 
	$addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
) {

501 ià(
Ëngth
 < 
OBJ_SHARED_BULKHDR_LEN
)

502 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Ëngth
]);

504 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ëngth
,'*');

505 
	}
}

508 
	$addR•lyBulkL’
(
ş›Á
 *
c
, 
robj
 *
obj
) {

509 
size_t
 
Ën
;

511 ià(
	`sdsEncodedObjeù
(
obj
)) {

512 
Ën
 = 
	`sd¦’
(
obj
->
±r
);

514 
n
 = ()
obj
->
±r
;

517 
Ën
 = 1;

518 ià(
n
 < 0) {

519 
Ën
++;

520 
n
 = -n;

522 (
n
 =‚/10) != 0) {

523 
Ën
++;

527 ià(
Ën
 < 
OBJ_SHARED_BULKHDR_LEN
)

528 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Ën
]);

530 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

531 
	}
}

534 
	$addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
) {

535 
	`addR•lyBulkL’
(
c
,
obj
);

536 
	`addR•ly
(
c
,
obj
);

537 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

538 
	}
}

541 
	$addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
) {

542 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

543 
	`addR•lySŒšg
(
c
,
p
,
Ën
);

544 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

545 
	}
}

548 
	$addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
) {

549 
	`addR•lySds
(
c
,
	`sdsÿtfmt
(
	`sd£m±y
(),"$%u\r\n",

550 ()
	`sd¦’
(
s
)));

551 
	`addR•lySds
(
c
,
s
);

552 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

553 
	}
}

556 
	$addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
) {

557 ià(
s
 =ğ
NULL
) {

558 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

560 
	`addR•lyBulkCBufãr
(
c
,
s
,
	`¡¾’
(s));

562 
	}
}

565 
	$addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

566 
buf
[64];

567 
Ën
;

569 
Ën
 = 
	`Î2¡ršg
(
buf
,64,
Î
);

570 
	`addR•lyBulkCBufãr
(
c
,
buf
,
Ën
);

571 
	}
}

576 
	$cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
) {

577 
	`li¡R–—£
(
d¡
->
»¶y
);

578 
d¡
->
»¶y
 = 
	`li¡Dup
(
¤c
->reply);

579 
	`memıy
(
d¡
->
buf
,
¤c
->buf,¤c->
buåos
);

580 
d¡
->
buåos
 = 
¤c
->bufpos;

581 
d¡
->
»¶y_by‹s
 = 
¤c
->reply_bytes;

582 
	}
}

586 
	$ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
) {

587  
c
->
buåos
 || 
	`li¡L’gth
(c->
»¶y
);

588 
	}
}

590 
	#MAX_ACCEPTS_PER_CALL
 1000

	)

591 
	$acû±CommÚHªdËr
(
fd
, 
æags
, *

) {

592 
ş›Á
 *
c
;

593 ià((
c
 = 
	`ü—‹Cl›Á
(
fd
)è=ğ
NULL
) {

594 
	`£rv”Log
(
LL_WARNING
,

596 
	`¡»¼Ü
(
”ºo
),
fd
);

597 
	`şo£
(
fd
);

604 ià(
	`li¡L’gth
(
£rv”
.
ş›Ás
è> s”v”.
maxş›Ás
) {

605 *
”r
 = "-ERR max‚umber of clients„eached\r\n";

608 ià(
	`wr™e
(
c
->
fd
,
”r
,
	`¡¾’
(err)) == -1) {

611 
£rv”
.
¡©_»jeùed_cÚn
++;

612 
	`ä“Cl›Á
(
c
);

620 ià(
£rv”
.
´Ùeùed_mode
 &&

621 
£rv”
.
bšdaddr_couÁ
 == 0 &&

622 
£rv”
.
»quœ•ass
 =ğ
NULL
 &&

623 !(
æags
 & 
CLIENT_UNIX_SOCKET
) &&

624 

 !ğ
NULL
)

626 ià(
	`¡rcmp
(

,"127.0.0.1") && strcmp(ip,"::1")) {

627 *
”r
 =

648 ià(
	`wr™e
(
c
->
fd
,
”r
,
	`¡¾’
(err)) == -1) {

651 
£rv”
.
¡©_»jeùed_cÚn
++;

652 
	`ä“Cl›Á
(
c
);

657 
£rv”
.
¡©_numcÚÃùiÚs
++;

658 
c
->
æags
 |= flags;

659 
	}
}

661 
	$acû±TıHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

662 
ıÜt
, 
cfd
, 
max
 = 
MAX_ACCEPTS_PER_CALL
;

663 
c
[
NET_IP_STR_LEN
];

664 
	`UNUSED
(
–
);

665 
	`UNUSED
(
mask
);

666 
	`UNUSED
(
´ivd©a
);

668 
max
--) {

669 
cfd
 = 
	`ª‘TıAcû±
(
£rv”
.
Ã‹¼
, 
fd
, 
c
, (c), &
ıÜt
);

670 ià(
cfd
 =ğ
ANET_ERR
) {

671 ià(
”ºo
 !ğ
EWOULDBLOCK
)

672 
	`£rv”Log
(
LL_WARNING
,

673 "Acû±šg cl›Á cÚÃùiÚ: %s", 
£rv”
.
Ã‹¼
);

676 
	`£rv”Log
(
LL_VERBOSE
,"Acû±ed %s:%d", 
c
, 
ıÜt
);

677 
	`acû±CommÚHªdËr
(
cfd
,0,
c
);

679 
	}
}

681 
	$acû±UnixHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

682 
cfd
, 
max
 = 
MAX_ACCEPTS_PER_CALL
;

683 
	`UNUSED
(
–
);

684 
	`UNUSED
(
mask
);

685 
	`UNUSED
(
´ivd©a
);

687 
max
--) {

688 
cfd
 = 
	`ª‘UnixAcû±
(
£rv”
.
Ã‹¼
, 
fd
);

689 ià(
cfd
 =ğ
ANET_ERR
) {

690 ià(
”ºo
 !ğ
EWOULDBLOCK
)

691 
	`£rv”Log
(
LL_WARNING
,

692 "Acû±šg cl›Á cÚÃùiÚ: %s", 
£rv”
.
Ã‹¼
);

695 
	`£rv”Log
(
LL_VERBOSE
,"Acû±ed cÚÃùiÚØ%s", 
£rv”
.
unixsock‘
);

696 
	`acû±CommÚHªdËr
(
cfd
,
CLIENT_UNIX_SOCKET
,
NULL
);

698 
	}
}

700 
	$ä“Cl›ÁArgv
(
ş›Á
 *
c
) {

701 
j
;

702 
j
 = 0; j < 
c
->
¬gc
; j++)

703 
	`deüRefCouÁ
(
c
->
¬gv
[
j
]);

704 
c
->
¬gc
 = 0;

705 
c
->
cmd
 = 
NULL
;

706 
	}
}

711 
	$discÚÃùSÏves
() {

712 
	`li¡L’gth
(
£rv”
.
¦aves
)) {

713 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
¦aves
);

714 
	`ä“Cl›Á
((
ş›Á
*)
Ê
->
v®ue
);

716 
	}
}

721 
	$uÆškCl›Á
(
ş›Á
 *
c
) {

722 
li¡Node
 *
Ê
;

725 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
c
è£rv”.cu¼’t_ş›Á = 
NULL
;

730 ià(
c
->
fd
 != -1) {

732 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás
,
c
);

733 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

734 
	`li¡D–Node
(
£rv”
.
ş›Ás
,
Ê
);

737 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_READABLE
);

738 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_WRITABLE
);

739 
	`şo£
(
c
->
fd
);

740 
c
->
fd
 = -1;

744 ià(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) {

745 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
c
);

746 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

747 
	`li¡D–Node
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
Ê
);

748 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

753 ià(
c
->
æags
 & 
CLIENT_UNBLOCKED
) {

754 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
unblocked_ş›Ás
,
c
);

755 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

756 
	`li¡D–Node
(
£rv”
.
unblocked_ş›Ás
,
Ê
);

757 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

759 
	}
}

761 
	$ä“Cl›Á
(
ş›Á
 *
c
) {

762 
li¡Node
 *
Ê
;

769 ià(
£rv”
.
ma¡”
 && 
c
->
æags
 & 
CLIENT_MASTER
) {

770 
	`£rv”Log
(
LL_WARNING
,"Connection with master†ost.");

771 ià(!(
c
->
æags
 & (
CLIENT_CLOSE_AFTER_REPLY
|

772 
CLIENT_CLOSE_ASAP
|

773 
CLIENT_BLOCKED
|

774 
CLIENT_UNBLOCKED
)))

776 
	`»¶iÿtiÚCacheMa¡”
(
c
);

782 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
)) {

783 
	`£rv”Log
(
LL_WARNING
,"Connection with slave %s†ost.",

784 
	`»¶iÿtiÚG‘SÏveName
(
c
));

788 
	`sdsä“
(
c
->
qu”ybuf
);

789 
c
->
qu”ybuf
 = 
NULL
;

792 ià(
c
->
æags
 & 
CLIENT_BLOCKED
è
	`unblockCl›Á
(c);

793 
	`diùR–—£
(
c
->
bpİ
.
keys
);

796 
	`unw©chAÎKeys
(
c
);

797 
	`li¡R–—£
(
c
->
w©ched_keys
);

800 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,0);

801 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,0);

802 
	`diùR–—£
(
c
->
pubsub_chªÃls
);

803 
	`li¡R–—£
(
c
->
pubsub_·‰”ns
);

806 
	`li¡R–—£
(
c
->
»¶y
);

807 
	`ä“Cl›ÁArgv
(
c
);

812 
	`uÆškCl›Á
(
c
);

816 ià(
c
->
æags
 & 
CLIENT_SLAVE
) {

817 ià(
c
->
»¶¡©e
 =ğ
SLAVE_STATE_SEND_BULK
) {

818 ià(
c
->
»¶dbfd
 !ğ-1è
	`şo£
(c->repldbfd);

819 ià(
c
->
»¶´—mbË
è
	`sdsä“
(c->replpreamble);

821 
li¡
 *
l
 = (
c
->
æags
 & 
CLIENT_MONITOR
è? 
£rv”
.
mÚ™Üs
 : s”v”.
¦aves
;

822 
Ê
 = 
	`li¡S—rchKey
(
l
,
c
);

823 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

824 
	`li¡D–Node
(
l
,
Ê
);

828 ià(
c
->
æags
 & 
CLIENT_SLAVE
 && 
	`li¡L’gth
(
£rv”
.
¦aves
) == 0)

829 
£rv”
.
»¶_no_¦aves_sšû
 = s”v”.
unixtime
;

830 
	`»äeshGoodSÏvesCouÁ
();

835 ià(
c
->
æags
 & 
CLIENT_MASTER
è
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

839 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
) {

840 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_to_şo£
,
c
);

841 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

842 
	`li¡D–Node
(
£rv”
.
ş›Ás_to_şo£
,
Ê
);

847 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

848 
	`zä“
(
c
->
¬gv
);

849 
	`ä“Cl›ÁMuÉiS‹
(
c
);

850 
	`sdsä“
(
c
->
³”id
);

851 
	`zä“
(
c
);

852 
	}
}

858 
	$ä“Cl›ÁAsync
(
ş›Á
 *
c
) {

859 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
 || c->æag & 
CLIENT_LUA
) ;

860 
c
->
æags
 |ğ
CLIENT_CLOSE_ASAP
;

861 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás_to_şo£
,
c
);

862 
	}
}

864 
	$ä“Cl›ÁsInAsyncF»eQueue
() {

865 
	`li¡L’gth
(
£rv”
.
ş›Ás_to_şo£
)) {

866 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
ş›Ás_to_şo£
);

867 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

869 
c
->
æags
 &ğ~
CLIENT_CLOSE_ASAP
;

870 
	`ä“Cl›Á
(
c
);

871 
	`li¡D–Node
(
£rv”
.
ş›Ás_to_şo£
,
Ê
);

873 
	}
}

877 
	$wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
) {

878 
ssize_t
 
nwr™‹n
 = 0, 
tÙwr™‹n
 = 0;

879 
size_t
 
objËn
;

880 
sds
 
o
;

882 
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

883 ià(
c
->
buåos
 > 0) {

884 
nwr™‹n
 = 
	`wr™e
(
fd
,
c
->
buf
+c->
£ÁËn
,c->
buåos
-c->sentlen);

885 ià(
nwr™‹n
 <= 0) ;

886 
c
->
£ÁËn
 +ğ
nwr™‹n
;

887 
tÙwr™‹n
 +ğ
nwr™‹n
;

891 ià(()
c
->
£ÁËn
 =ğc->
buåos
) {

892 
c
->
buåos
 = 0;

893 
c
->
£ÁËn
 = 0;

896 
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

897 
objËn
 = 
	`sd¦’
(
o
);

899 ià(
objËn
 == 0) {

900 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

904 
nwr™‹n
 = 
	`wr™e
(
fd
, 
o
 + 
c
->
£ÁËn
, 
objËn
 - c->sentlen);

905 ià(
nwr™‹n
 <= 0) ;

906 
c
->
£ÁËn
 +ğ
nwr™‹n
;

907 
tÙwr™‹n
 +ğ
nwr™‹n
;

910 ià(
c
->
£ÁËn
 =ğ
objËn
) {

911 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

912 
c
->
£ÁËn
 = 0;

913 
c
->
»¶y_by‹s
 -ğ
objËn
;

924 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
tÙwr™‹n
;

925 ià(
tÙwr™‹n
 > 
NET_MAX_WRITES_PER_EVENT
 &&

926 (
£rv”
.
maxmemÜy
 == 0 ||

927 
	`zm®loc_u£d_memÜy
(è< 
£rv”
.
maxmemÜy
)) ;

929 ià(
nwr™‹n
 == -1) {

930 ià(
”ºo
 =ğ
EAGAIN
) {

931 
nwr™‹n
 = 0;

933 
	`£rv”Log
(
LL_VERBOSE
,

934 "E¼Ü wr™šgØş›Á: %s", 
	`¡»¼Ü
(
”ºo
));

935 
	`ä“Cl›Á
(
c
);

936  
C_ERR
;

939 ià(
tÙwr™‹n
 > 0) {

944 ià(!(
c
->
æags
 & 
CLIENT_MASTER
)èc->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

946 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

947 
c
->
£ÁËn
 = 0;

948 ià(
hªdËr_š¡®Ëd
è
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_WRITABLE
);

951 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

952 
	`ä“Cl›Á
(
c
);

953  
C_ERR
;

956  
C_OK
;

957 
	}
}

960 
	$£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

961 
	`UNUSED
(
–
);

962 
	`UNUSED
(
mask
);

963 
	`wr™eToCl›Á
(
fd
,
´ivd©a
,1);

964 
	}
}

970 
	$hªdËCl›ÁsW™hP’dšgWr™es
() {

971 
li¡I‹r
 
li
;

972 
li¡Node
 *
Ê
;

973 
´oûs£d
 = 
	`li¡L’gth
(
£rv”
.
ş›Ás_³ndšg_wr™e
);

975 
	`li¡Rewšd
(
£rv”
.
ş›Ás_³ndšg_wr™e
,&
li
);

976 (
Ê
 = 
	`li¡Next
(&
li
))) {

977 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

978 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

979 
	`li¡D–Node
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
Ê
);

982 ià(
	`wr™eToCl›Á
(
c
->
fd
,c,0è=ğ
C_ERR
) ;

986 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

987 
	`«C»©eFeEv’t
(
£rv”
.
–
, 
c
->
fd
, 
AE_WRITABLE
,

988 
£ndR•lyToCl›Á
, 
c
è=ğ
AE_ERR
)

990 
	`ä“Cl›ÁAsync
(
c
);

993  
´oûs£d
;

994 
	}
}

997 
	$»£tCl›Á
(
ş›Á
 *
c
) {

998 
»disCommªdProc
 *
´evcmd
 = 
c
->
cmd
 ? c->cmd->
´oc
 : 
NULL
;

1000 
	`ä“Cl›ÁArgv
(
c
);

1001 
c
->
»qty³
 = 0;

1002 
c
->
muÉibulkËn
 = 0;

1003 
c
->
bulkËn
 = -1;

1007 ià(!(
c
->
æags
 & 
CLIENT_MULTI
è&& 
´evcmd
 !ğ
askšgCommªd
)

1008 
c
->
æags
 &ğ~
CLIENT_ASKING
;

1013 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP
;

1014 ià(
c
->
æags
 & 
CLIENT_REPLY_SKIP_NEXT
) {

1015 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP
;

1016 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP_NEXT
;

1018 
	}
}

1020 
	$´oûssIÆšeBufãr
(
ş›Á
 *
c
) {

1021 *
Ãwlše
;

1022 
¬gc
, 
j
;

1023 
sds
 *
¬gv
, 
aux
;

1024 
size_t
 
qu”yËn
;

1027 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\n');

1030 ià(
Ãwlše
 =ğ
NULL
) {

1031 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1032 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big inline„equest");

1033 
	`£tPrÙocŞE¼Ü
(
c
,0);

1035  
C_ERR
;

1039 ià(
Ãwlše
 &&‚ewlš!ğ
c
->
qu”ybuf
 && *(newline-1) == '\r')

1040 
Ãwlše
--;

1043 
qu”yËn
 = 
Ãwlše
-(
c
->
qu”ybuf
);

1044 
aux
 = 
	`sd¢ewËn
(
c
->
qu”ybuf
,
qu”yËn
);

1045 
¬gv
 = 
	`sds¥l™¬gs
(
aux
,&
¬gc
);

1046 
	`sdsä“
(
aux
);

1047 ià(
¬gv
 =ğ
NULL
) {

1048 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: unbalanced quotes in„equest");

1049 
	`£tPrÙocŞE¼Ü
(
c
,0);

1050  
C_ERR
;

1056 ià(
qu”yËn
 =ğ0 && 
c
->
æags
 & 
CLIENT_SLAVE
)

1057 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

1060 
	`sd¤ªge
(
c
->
qu”ybuf
,
qu”yËn
+2,-1);

1063 ià(
¬gc
) {

1064 ià(
c
->
¬gv
è
	`zä“
(c->argv);

1065 
c
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

1069 
c
->
¬gc
 = 0, 
j
 = 0; j <‡rgc; j++) {

1070 ià(
	`sd¦’
(
¬gv
[
j
])) {

1071 
c
->
¬gv
[c->
¬gc
] = 
	`ü—‹Objeù
(
OBJ_STRING
,¬gv[
j
]);

1072 
c
->
¬gc
++;

1074 
	`sdsä“
(
¬gv
[
j
]);

1077 
	`zä“
(
¬gv
);

1078  
C_OK
;

1079 
	}
}

1083 
	$£tPrÙocŞE¼Ü
(
ş›Á
 *
c
, 
pos
) {

1084 ià(
£rv”
.
v”bos™y
 <ğ
LL_VERBOSE
) {

1085 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1086 
	`£rv”Log
(
LL_VERBOSE
,

1087 "PrÙocŞƒ¼Ü from cl›Á: %s", 
ş›Á
);

1088 
	`sdsä“
(
ş›Á
);

1090 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1091 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1092 
	}
}

1094 
	$´oûssMuÉibulkBufãr
(
ş›Á
 *
c
) {

1095 *
Ãwlše
 = 
NULL
;

1096 
pos
 = 0, 
ok
;

1097 
Î
;

1099 ià(
c
->
muÉibulkËn
 == 0) {

1101 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
¬gc
 == 0);

1104 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\r');

1105 ià(
Ãwlše
 =ğ
NULL
) {

1106 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1107 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big mbulk count string");

1108 
	`£tPrÙocŞE¼Ü
(
c
,0);

1110  
C_ERR
;

1114 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1115  
C_ERR
;

1119 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
qu”ybuf
[0] == '*');

1120 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+1,
Ãwlše
-(c->qu”ybuf+1),&
Î
);

1121 ià(!
ok
 || 
Î
 > 1024*1024) {

1122 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid multibulk†ength");

1123 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1124  
C_ERR
;

1127 
pos
 = (
Ãwlše
-
c
->
qu”ybuf
)+2;

1128 ià(
Î
 <= 0) {

1129 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1130  
C_OK
;

1133 
c
->
muÉibulkËn
 = 
Î
;

1136 ià(
c
->
¬gv
è
	`zä“
(c->argv);

1137 
c
->
¬gv
 = 
	`zm®loc
((
robj
*)*c->
muÉibulkËn
);

1140 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
muÉibulkËn
 > 0);

1141 
c
->
muÉibulkËn
) {

1143 ià(
c
->
bulkËn
 == -1) {

1144 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
+
pos
,'\r');

1145 ià(
Ãwlše
 =ğ
NULL
) {

1146 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1147 
	`addR•lyE¼Ü
(
c
,

1149 
	`£tPrÙocŞE¼Ü
(
c
,0);

1150  
C_ERR
;

1156 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1159 ià(
c
->
qu”ybuf
[
pos
] != '$') {

1160 
	`addR•lyE¼ÜFÜm©
(
c
,

1162 
c
->
qu”ybuf
[
pos
]);

1163 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1164  
C_ERR
;

1167 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+
pos
+1,
Ãwlše
-(c->qu”ybuf+pos+1),&
Î
);

1168 ià(!
ok
 || 
Î
 < 0 ||†l > 512*1024*1024) {

1169 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid bulk†ength");

1170 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1171  
C_ERR
;

1174 
pos
 +ğ
Ãwlše
-(
c
->
qu”ybuf
+pos)+2;

1175 ià(
Î
 >ğ
PROTO_MBULK_BIG_ARG
) {

1176 
size_t
 
qbËn
;

1182 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1183 
pos
 = 0;

1184 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1187 ià(
qbËn
 < (
size_t
)
Î
+2)

1188 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf,
Î
+2-
qbËn
);

1190 
c
->
bulkËn
 = 
Î
;

1194 ià(
	`sd¦’
(
c
->
qu”ybuf
)-
pos
 < ()(c->
bulkËn
+2)) {

1201 ià(
pos
 == 0 &&

1202 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
 &&

1203 (sigÃdè
	`sd¦’
(
c
->
qu”ybuf
è=ğc->
bulkËn
+2)

1205 
c
->
¬gv
[c->
¬gc
++] = 
	`ü—‹Objeù
(
OBJ_STRING
,c->
qu”ybuf
);

1206 
	`sdsInüL’
(
c
->
qu”ybuf
,-2);

1209 
c
->
qu”ybuf
 = 
	`sd¢ewËn
(
NULL
,c->
bulkËn
+2);

1210 
	`sdsş—r
(
c
->
qu”ybuf
);

1211 
pos
 = 0;

1213 
c
->
¬gv
[c->
¬gc
++] =

1214 
	`ü—‹SŒšgObjeù
(
c
->
qu”ybuf
+
pos
,c->
bulkËn
);

1215 
pos
 +ğ
c
->
bulkËn
+2;

1217 
c
->
bulkËn
 = -1;

1218 
c
->
muÉibulkËn
--;

1223 ià(
pos
è
	`sd¤ªge
(
c
->
qu”ybuf
,pos,-1);

1226 ià(
c
->
muÉibulkËn
 =ğ0è 
C_OK
;

1229  
C_ERR
;

1230 
	}
}

1232 
	$´oûssIÅutBufãr
(
ş›Á
 *
c
) {

1233 
£rv”
.
cu¼’t_ş›Á
 = 
c
;

1235 
	`sd¦’
(
c
->
qu”ybuf
)) {

1237 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
è&& 
	`ş›ÁsA»Pau£d
()) ;

1240 ià(
c
->
æags
 & 
CLIENT_BLOCKED
) ;

1245 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

1248 ià(!
c
->
»qty³
) {

1249 ià(
c
->
qu”ybuf
[0] == '*') {

1250 
c
->
»qty³
 = 
PROTO_REQ_MULTIBULK
;

1252 
c
->
»qty³
 = 
PROTO_REQ_INLINE
;

1256 ià(
c
->
»qty³
 =ğ
PROTO_REQ_INLINE
) {

1257 ià(
	`´oûssIÆšeBufãr
(
c
è!ğ
C_OK
) ;

1258 } ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
) {

1259 ià(
	`´oûssMuÉibulkBufãr
(
c
è!ğ
C_OK
) ;

1261 
	`£rv”Pªic
("Unknown„equestype");

1265 ià(
c
->
¬gc
 == 0) {

1266 
	`»£tCl›Á
(
c
);

1269 ià(
	`´oûssCommªd
(
c
è=ğ
C_OK
)

1270 
	`»£tCl›Á
(
c
);

1273 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
NULL
) ;

1276 
£rv”
.
cu¼’t_ş›Á
 = 
NULL
;

1277 
	}
}

1279 
	$»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1280 
ş›Á
 *
c
 = (ş›Á*è
´ivd©a
;

1281 
Ä—d
, 
»adËn
;

1282 
size_t
 
qbËn
;

1283 
	`UNUSED
(
–
);

1284 
	`UNUSED
(
mask
);

1286 
»adËn
 = 
PROTO_IOBUF_LEN
;

1293 ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
 && c->
muÉibulkËn
 && c->
bulkËn
 != -1

1294 && 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
)

1296 
»maššg
 = ()(
c
->
bulkËn
+2)-
	`sd¦’
(c->
qu”ybuf
);

1298 ià(
»maššg
 < 
»adËn
)„eadlen =„emaining;

1301 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1302 ià(
c
->
qu”ybuf_³ak
 < 
qbËn
) c->querybuf_peak = qblen;

1303 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf, 
»adËn
);

1304 
Ä—d
 = 
	`»ad
(
fd
, 
c
->
qu”ybuf
+
qbËn
, 
»adËn
);

1305 ià(
Ä—d
 == -1) {

1306 ià(
”ºo
 =ğ
EAGAIN
) {

1309 
	`£rv”Log
(
LL_VERBOSE
, "R—dšg from cl›Á: %s",
	`¡»¼Ü
(
”ºo
));

1310 
	`ä“Cl›Á
(
c
);

1313 } ià(
Ä—d
 == 0) {

1314 
	`£rv”Log
(
LL_VERBOSE
, "Client closed connection");

1315 
	`ä“Cl›Á
(
c
);

1319 
	`sdsInüL’
(
c
->
qu”ybuf
,
Ä—d
);

1320 
c
->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

1321 ià(
c
->
æags
 & 
CLIENT_MASTER
èc->
»¶off
 +ğ
Ä—d
;

1322 
£rv”
.
¡©_Ãt_šput_by‹s
 +ğ
Ä—d
;

1323 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
£rv”
.
ş›Á_max_qu”ybuf_Ën
) {

1324 
sds
 
ci
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
), 
by‹s
 = sdsempty();

1326 
by‹s
 = 
	`sdsÿŒ•r
(by‹s,
c
->
qu”ybuf
,64);

1327 
	`£rv”Log
(
LL_WARNING
,"Closšg cl›Áh©„—ched max qu”y bufã¸Ëngth: % (qbuàš™ŸÈby‹s: %s)", 
ci
, 
by‹s
);

1328 
	`sdsä“
(
ci
);

1329 
	`sdsä“
(
by‹s
);

1330 
	`ä“Cl›Á
(
c
);

1333 
	`´oûssIÅutBufãr
(
c
);

1334 
	}
}

1336 
	$g‘Cl›ÁsMaxBufãrs
(*
lÚge¡_ouut_li¡
,

1337 *
bigge¡_šput_bufãr
) {

1338 
ş›Á
 *
c
;

1339 
li¡Node
 *
Ê
;

1340 
li¡I‹r
 
li
;

1341 
lŞ
 = 0, 
bib
 = 0;

1343 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1344 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1345 
c
 = 
	`li¡NodeV®ue
(
Ê
);

1347 ià(
	`li¡L’gth
(
c
->
»¶y
è> 
lŞ
)†ol =†istLength(c->reply);

1348 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
bib
) bib = sdslen(c->querybuf);

1350 *
lÚge¡_ouut_li¡
 = 
lŞ
;

1351 *
bigge¡_šput_bufãr
 = 
bib
;

1352 
	}
}

1365 
	$g’Cl›ÁP“rId
(
ş›Á
 *ş›Á, *
³”id
,

1366 
size_t
 
³”id_Ën
) {

1367 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

1369 
	`¢´štf
(
³”id
,
³”id_Ën
,"%s:0",
£rv”
.
unixsock‘
);

1372 
	`ª‘FÜm©P“r
(
ş›Á
->
fd
,
³”id
,
³”id_Ën
);

1374 
	}
}

1380 *
	$g‘Cl›ÁP“rId
(
ş›Á
 *
c
) {

1381 
³”id
[
NET_PEER_ID_LEN
];

1383 ià(
c
->
³”id
 =ğ
NULL
) {

1384 
	`g’Cl›ÁP“rId
(
c
,
³”id
,(peerid));

1385 
c
->
³”id
 = 
	`sd¢ew
(peerid);

1387  
c
->
³”id
;

1388 
	}
}

1392 
sds
 
	$ÿtCl›ÁInfoSŒšg
(
sds
 
s
, 
ş›Á
 *client) {

1393 
æags
[16], 
ev’ts
[3], *
p
;

1394 
emask
;

1396 
p
 = 
æags
;

1397 ià(
ş›Á
->
æags
 & 
CLIENT_SLAVE
) {

1398 ià(
ş›Á
->
æags
 & 
CLIENT_MONITOR
)

1399 *
p
++ = 'O';

1401 *
p
++ = 'S';

1403 ià(
ş›Á
->
æags
 & 
CLIENT_MASTER
è*
p
++ = 'M';

1404 ià(
ş›Á
->
æags
 & 
CLIENT_MULTI
è*
p
++ = 'x';

1405 ià(
ş›Á
->
æags
 & 
CLIENT_BLOCKED
è*
p
++ = 'b';

1406 ià(
ş›Á
->
æags
 & 
CLIENT_DIRTY_CAS
è*
p
++ = 'd';

1407 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è*
p
++ = 'c';

1408 ià(
ş›Á
->
æags
 & 
CLIENT_UNBLOCKED
è*
p
++ = 'u';

1409 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_ASAP
è*
p
++ = 'A';

1410 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
è*
p
++ = 'U';

1411 ià(
ş›Á
->
æags
 & 
CLIENT_READONLY
è*
p
++ = 'r';

1412 ià(
p
 =ğ
æags
) *p++ = 'N';

1413 *
p
++ = '\0';

1415 
emask
 = 
ş›Á
->
fd
 =ğ-1 ? 0 : 
	`«G‘FeEv’ts
(
£rv”
.
–
,client->fd);

1416 
p
 = 
ev’ts
;

1417 ià(
emask
 & 
AE_READABLE
è*
p
++ = 'r';

1418 ià(
emask
 & 
AE_WRITABLE
è*
p
++ = 'w';

1419 *
p
 = '\0';

1420  
	`sdsÿtfmt
(
s
,

1422 (è
ş›Á
->
id
,

1423 
	`g‘Cl›ÁP“rId
(
ş›Á
),

1424 
ş›Á
->
fd
,

1425 
ş›Á
->
Çme
 ? (*)ş›Á->Çme->
±r
 : "",

1426 ()(
£rv”
.
unixtime
 - 
ş›Á
->
ùime
),

1427 ()(
£rv”
.
unixtime
 - 
ş›Á
->
Ï¡š‹¿ùiÚ
),

1428 
æags
,

1429 
ş›Á
->
db
->
id
,

1430 (è
	`diùSize
(
ş›Á
->
pubsub_chªÃls
),

1431 (è
	`li¡L’gth
(
ş›Á
->
pubsub_·‰”ns
),

1432 (
ş›Á
->
æags
 & 
CLIENT_MULTI
è? cl›Á->
m¡©e
.
couÁ
 : -1,

1433 (è
	`sd¦’
(
ş›Á
->
qu”ybuf
),

1434 (è
	`sd§va
(
ş›Á
->
qu”ybuf
),

1435 (è
ş›Á
->
buåos
,

1436 (è
	`li¡L’gth
(
ş›Á
->
»¶y
),

1437 (è
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
),

1438 
ev’ts
,

1439 
ş›Á
->
Ï¡cmd
 ? cl›Á->Ï¡cmd->
Çme
 : "NULL");

1440 
	}
}

1442 
sds
 
	$g‘AÎCl›ÁsInfoSŒšg
() {

1443 
li¡Node
 *
Ê
;

1444 
li¡I‹r
 
li
;

1445 
ş›Á
 *client;

1446 
sds
 
o
 = 
	`sd¢ewËn
(
NULL
,200*
	`li¡L’gth
(
£rv”
.
ş›Ás
));

1447 
	`sdsş—r
(
o
);

1448 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1449 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1450 
ş›Á
 = 
	`li¡NodeV®ue
(
Ê
);

1451 
o
 = 
	`ÿtCl›ÁInfoSŒšg
(o,
ş›Á
);

1452 
o
 = 
	`sdsÿ’
(o,"\n",1);

1454  
o
;

1455 
	}
}

1457 
	$ş›ÁCommªd
(
ş›Á
 *
c
) {

1458 
li¡Node
 *
Ê
;

1459 
li¡I‹r
 
li
;

1460 
ş›Á
 *client;

1462 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"li¡"è&& c->
¬gc
 == 2) {

1464 
sds
 
o
 = 
	`g‘AÎCl›ÁsInfoSŒšg
();

1465 
	`addR•lyBulkCBufãr
(
c
,
o
,
	`sd¦’
(o));

1466 
	`sdsä“
(
o
);

1467 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»¶y"è&& c->
¬gc
 == 3) {

1469 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"on")) {

1470 
c
->
æags
 &ğ~(
CLIENT_REPLY_SKIP
|
CLIENT_REPLY_OFF
);

1471 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1472 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"off")) {

1473 
c
->
æags
 |ğ
CLIENT_REPLY_OFF
;

1474 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"skip")) {

1475 ià(!(
c
->
æags
 & 
CLIENT_REPLY_OFF
))

1476 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP_NEXT
;

1478 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1481 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"kill")) {

1484 *
addr
 = 
NULL
;

1485 
ty³
 = -1;

1486 
ušt64_t
 
id
 = 0;

1487 
skme
 = 1;

1488 
kËd
 = 0, 
şo£_this_ş›Á
 = 0;

1490 ià(
c
->
¬gc
 == 3) {

1492 
addr
 = 
c
->
¬gv
[2]->
±r
;

1493 
skme
 = 0;

1494 } ià(
c
->
¬gc
 > 3) {

1495 
i
 = 2;

1498 
i
 < 
c
->
¬gc
) {

1499 
mÜ—rgs
 = 
c
->
¬gc
 > 
i
+1;

1501 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"id"è&& 
mÜ—rgs
) {

1502 
tmp
;

1504 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
i
+1],&
tmp
,
NULL
)

1505 !ğ
C_OK
) ;

1506 
id
 = 
tmp
;

1507 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"ty³"è&& 
mÜ—rgs
) {

1508 
ty³
 = 
	`g‘Cl›ÁTy³ByName
(
c
->
¬gv
[
i
+1]->
±r
);

1509 ià(
ty³
 == -1) {

1510 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown clientype '%s'",

1511 (*è
c
->
¬gv
[
i
+1]->
±r
);

1514 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"addr"è&& 
mÜ—rgs
) {

1515 
addr
 = 
c
->
¬gv
[
i
+1]->
±r
;

1516 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"skme"è&& 
mÜ—rgs
) {

1517 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"yes")) {

1518 
skme
 = 1;

1519 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"no")) {

1520 
skme
 = 0;

1522 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1526 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1529 
i
 += 2;

1532 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1537 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1538 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1539 
ş›Á
 = 
	`li¡NodeV®ue
(
Ê
);

1540 ià(
addr
 && 
	`¡rcmp
(
	`g‘Cl›ÁP“rId
(
ş›Á
),addr) != 0) ;

1541 ià(
ty³
 !ğ-1 && 
	`g‘Cl›ÁTy³
(
ş›Á
) !=ype) ;

1542 ià(
id
 !ğ0 && 
ş›Á
->id != id) ;

1543 ià(
c
 =ğ
ş›Á
 && 
skme
) ;

1546 ià(
c
 =ğ
ş›Á
) {

1547 
şo£_this_ş›Á
 = 1;

1549 
	`ä“Cl›Á
(
ş›Á
);

1551 
kËd
++;

1555 ià(
c
->
¬gc
 == 3) {

1556 ià(
kËd
 == 0)

1557 
	`addR•lyE¼Ü
(
c
,"No such client");

1559 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1561 
	`addR•lyLÚgLÚg
(
c
,
kËd
);

1566 ià(
şo£_this_ş›Á
è
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1567 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£Šame"è&& c->
¬gc
 == 3) {

1568 
j
, 
Ën
 = 
	`sd¦’
(
c
->
¬gv
[2]->
±r
);

1569 *
p
 = 
c
->
¬gv
[2]->
±r
;

1573 ià(
Ën
 == 0) {

1574 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

1575 
c
->
Çme
 = 
NULL
;

1576 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1583 
j
 = 0; j < 
Ën
; j++) {

1584 ià(
p
[
j
] < '!' ||…[j] > '~') {

1585 
	`addR•lyE¼Ü
(
c
,

1591 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

1592 
c
->
Çme
 = c->
¬gv
[2];

1593 
	`šüRefCouÁ
(
c
->
Çme
);

1594 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1595 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘Çme"è&& c->
¬gc
 == 2) {

1596 ià(
c
->
Çme
)

1597 
	`addR•lyBulk
(
c
,c->
Çme
);

1599 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1600 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"·u£"è&& c->
¬gc
 == 3) {

1601 
du¿tiÚ
;

1603 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
du¿tiÚ
,
UNIT_MILLISECONDS
)

1604 !ğ
C_OK
) ;

1605 
	`·u£Cl›Ás
(
du¿tiÚ
);

1606 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1608 
	`addR•lyE¼Ü
(
c
, "Syntaxƒrror,ry CLIENT (LIST | KILL | GETNAME | SETNAME | PAUSE | REPLY)");

1610 
	}
}

1615 
	$»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...) {

1616 
va_li¡
 
­
;

1617 
j
;

1618 
robj
 **
¬gv
;

1620 
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

1621 
	`va_¡¬t
(
­
,
¬gc
);

1622 
j
 = 0; j < 
¬gc
; j++) {

1623 
robj
 *
a
;

1625 
a
 = 
	`va_¬g
(
­
, 
robj
*);

1626 
¬gv
[
j
] = 
a
;

1627 
	`šüRefCouÁ
(
a
);

1632 
j
 = 0; j < 
c
->
¬gc
; j++è
	`deüRefCouÁ
(c->
¬gv
[j]);

1633 
	`zä“
(
c
->
¬gv
);

1635 
c
->
¬gv
 =‡rgv;

1636 
c
->
¬gc
 =‡rgc;

1637 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1638 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1639 
	`va_’d
(
­
);

1640 
	}
}

1643 
	$»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
) {

1644 
	`ä“Cl›ÁArgv
(
c
);

1645 
	`zä“
(
c
->
¬gv
);

1646 
c
->
¬gv
 =‡rgv;

1647 
c
->
¬gc
 =‡rgc;

1648 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1649 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1650 
	}
}

1663 
	$»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
) {

1664 
robj
 *
Şdv®
;

1666 ià(
i
 >ğ
c
->
¬gc
) {

1667 
c
->
¬gv
 = 
	`z»®loc
(c->¬gv,(
robj
*)*(
i
+1));

1668 
c
->
¬gc
 = 
i
+1;

1669 
c
->
¬gv
[
i
] = 
NULL
;

1671 
Şdv®
 = 
c
->
¬gv
[
i
];

1672 
c
->
¬gv
[
i
] = 
Ãwv®
;

1673 
	`šüRefCouÁ
(
Ãwv®
);

1674 ià(
Şdv®
è
	`deüRefCouÁ
(oldval);

1677 ià(
i
 == 0) {

1678 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1679 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1681 
	}
}

1696 
	$g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
) {

1697 
li¡_™em_size
 = (
li¡Node
)+5;

1701  
c
->
»¶y_by‹s
 + (
li¡_™em_size
*
	`li¡L’gth
(c->
»¶y
));

1702 
	}
}

1713 
	$g‘Cl›ÁTy³
(
ş›Á
 *
c
) {

1714 ià(
c
->
æags
 & 
CLIENT_MASTER
è 
CLIENT_TYPE_MASTER
;

1715 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
))

1716  
CLIENT_TYPE_SLAVE
;

1717 ià(
c
->
æags
 & 
CLIENT_PUBSUB
è 
CLIENT_TYPE_PUBSUB
;

1718  
CLIENT_TYPE_NORMAL
;

1719 
	}
}

1721 
	$g‘Cl›ÁTy³ByName
(*
Çme
) {

1722 ià(!
	`¡rÿ£cmp
(
Çme
,"nÜm®")è 
CLIENT_TYPE_NORMAL
;

1723 ià(!
	`¡rÿ£cmp
(
Çme
,"¦ave")è 
CLIENT_TYPE_SLAVE
;

1724 ià(!
	`¡rÿ£cmp
(
Çme
,"pubsub")è 
CLIENT_TYPE_PUBSUB
;

1725 ià(!
	`¡rÿ£cmp
(
Çme
,"ma¡”")è 
CLIENT_TYPE_MASTER
;

1727 
	}
}

1729 *
	$g‘Cl›ÁTy³Name
(
şass
) {

1730 
şass
) {

1731 
CLIENT_TYPE_NORMAL
:  "normal";

1732 
CLIENT_TYPE_SLAVE
:  "slave";

1733 
CLIENT_TYPE_PUBSUB
:  "pubsub";

1734 
CLIENT_TYPE_MASTER
:  "master";

1735 :  
NULL
;

1737 
	}
}

1745 
	$checkCl›ÁOuutBufãrLim™s
(
ş›Á
 *
c
) {

1746 
soá
 = 0, 
h¬d
 = 0, 
şass
;

1747 
u£d_mem
 = 
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

1749 
şass
 = 
	`g‘Cl›ÁTy³
(
c
);

1752 ià(
şass
 =ğ
CLIENT_TYPE_MASTER
èşas ğ
CLIENT_TYPE_NORMAL
;

1754 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 &&

1755 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
)

1756 
h¬d
 = 1;

1757 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 &&

1758 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
)

1759 
soá
 = 1;

1763 ià(
soá
) {

1764 ià(
c
->
obuf_soá_lim™_»ached_time
 == 0) {

1765 
c
->
obuf_soá_lim™_»ached_time
 = 
£rv”
.
unixtime
;

1766 
soá
 = 0;

1768 
time_t
 
–­£d
 = 
£rv”
.
unixtime
 - 
c
->
obuf_soá_lim™_»ached_time
;

1770 ià(
–­£d
 <=

1771 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
) {

1772 
soá
 = 0;

1778 
c
->
obuf_soá_lim™_»ached_time
 = 0;

1780  
soá
 || 
h¬d
;

1781 
	}
}

1790 
	$asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
) {

1791 
	`£rv”As£¹
(
c
->
»¶y_by‹s
 < 
SIZE_MAX
-(1024*64));

1792 ià(
c
->
»¶y_by‹s
 =ğ0 || c->
æags
 & 
CLIENT_CLOSE_ASAP
) ;

1793 ià(
	`checkCl›ÁOuutBufãrLim™s
(
c
)) {

1794 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1796 
	`ä“Cl›ÁAsync
(
c
);

1797 
	`£rv”Log
(
LL_WARNING
,"Cl›Á % scheduËdØbşo£d ASAP fÜ ov”comšg oàouuˆbufã¸lim™s.", 
ş›Á
);

1798 
	`sdsä“
(
ş›Á
);

1800 
	}
}

1806 
	$æushSÏvesOuutBufãrs
() {

1807 
li¡I‹r
 
li
;

1808 
li¡Node
 *
Ê
;

1810 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1811 (
Ê
 = 
	`li¡Next
(&
li
))) {

1812 
ş›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

1813 
ev’ts
;

1821 
ev’ts
 = 
	`«G‘FeEv’ts
(
£rv”
.
–
,
¦ave
->
fd
);

1822 ià(
ev’ts
 & 
AE_WRITABLE
 &&

1823 
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

1824 
	`ş›ÁHasP’dšgR•l›s
(
¦ave
))

1826 
	`wr™eToCl›Á
(
¦ave
->
fd
,slave,0);

1829 
	}
}

1848 
	$·u£Cl›Ás
(
m¡ime_t
 
’d
) {

1849 ià(!
£rv”
.
ş›Ás_·u£d
 || 
’d
 > s”v”.
ş›Ás_·u£_’d_time
)

1850 
£rv”
.
ş›Ás_·u£_’d_time
 = 
’d
;

1851 
£rv”
.
ş›Ás_·u£d
 = 1;

1852 
	}
}

1856 
	$ş›ÁsA»Pau£d
() {

1857 ià(
£rv”
.
ş›Ás_·u£d
 &&

1858 
£rv”
.
ş›Ás_·u£_’d_time
 < s”v”.
m¡ime
)

1860 
li¡Node
 *
Ê
;

1861 
li¡I‹r
 
li
;

1862 
ş›Á
 *
c
;

1864 
£rv”
.
ş›Ás_·u£d
 = 0;

1868 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1869 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1870 
c
 = 
	`li¡NodeV®ue
(
Ê
);

1874 ià(
c
->
æags
 & (
CLIENT_SLAVE
|
CLIENT_BLOCKED
)) ;

1875 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

1876 
	`li¡AddNodeTa
(
£rv”
.
unblocked_ş›Ás
,
c
);

1879  
£rv”
.
ş›Ás_·u£d
;

1880 
	}
}

1894 
	$´oûssEv’tsWheBlocked
() {

1895 
™”©iÚs
 = 4;

1896 
couÁ
 = 0;

1897 
™”©iÚs
--) {

1898 
ev’ts
 = 0;

1899 
ev’ts
 +ğ
	`«ProûssEv’ts
(
£rv”
.
–
, 
AE_FILE_EVENTS
|
AE_DONT_WAIT
);

1900 
ev’ts
 +ğ
	`hªdËCl›ÁsW™hP’dšgWr™es
();

1901 ià(!
ev’ts
) ;

1902 
couÁ
 +ğ
ev’ts
;

1904  
couÁ
;

1905 
	}
}

	@notify.c

30 
	~"£rv”.h
"

40 
	$key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
) {

41 *
p
 = 
şas£s
;

42 
c
, 
æags
 = 0;

44 (
c
 = *
p
++) != '\0') {

45 
c
) {

46 'A': 
æags
 |ğ
NOTIFY_ALL
; ;

47 'g': 
æags
 |ğ
NOTIFY_GENERIC
; ;

48 '$': 
æags
 |ğ
NOTIFY_STRING
; ;

49 'l': 
æags
 |ğ
NOTIFY_LIST
; ;

50 's': 
æags
 |ğ
NOTIFY_SET
; ;

51 'h': 
æags
 |ğ
NOTIFY_HASH
; ;

52 'z': 
æags
 |ğ
NOTIFY_ZSET
; ;

53 'x': 
æags
 |ğ
NOTIFY_EXPIRED
; ;

54 'e': 
æags
 |ğ
NOTIFY_EVICTED
; ;

55 'K': 
æags
 |ğ
NOTIFY_KEYSPACE
; ;

56 'E': 
æags
 |ğ
NOTIFY_KEYEVENT
; ;

60  
æags
;

61 
	}
}

67 
sds
 
	$key¥aûEv’tsFÏgsToSŒšg
(
æags
) {

68 
sds
 
»s
;

70 
»s
 = 
	`sd£m±y
();

71 ià((
æags
 & 
NOTIFY_ALL
) == NOTIFY_ALL) {

72 
»s
 = 
	`sdsÿ’
(res,"A",1);

74 ià(
æags
 & 
NOTIFY_GENERIC
è
»s
 = 
	`sdsÿ’
(res,"g",1);

75 ià(
æags
 & 
NOTIFY_STRING
è
»s
 = 
	`sdsÿ’
(res,"$",1);

76 ià(
æags
 & 
NOTIFY_LIST
è
»s
 = 
	`sdsÿ’
(res,"l",1);

77 ià(
æags
 & 
NOTIFY_SET
è
»s
 = 
	`sdsÿ’
(res,"s",1);

78 ià(
æags
 & 
NOTIFY_HASH
è
»s
 = 
	`sdsÿ’
(res,"h",1);

79 ià(
æags
 & 
NOTIFY_ZSET
è
»s
 = 
	`sdsÿ’
(res,"z",1);

80 ià(
æags
 & 
NOTIFY_EXPIRED
è
»s
 = 
	`sdsÿ’
(res,"x",1);

81 ià(
æags
 & 
NOTIFY_EVICTED
è
»s
 = 
	`sdsÿ’
(res,"e",1);

83 ià(
æags
 & 
NOTIFY_KEYSPACE
è
»s
 = 
	`sdsÿ’
(res,"K",1);

84 ià(
æags
 & 
NOTIFY_KEYEVENT
è
»s
 = 
	`sdsÿ’
(res,"E",1);

85  
»s
;

86 
	}
}

95 
	$nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
) {

96 
sds
 
chª
;

97 
robj
 *
chªobj
, *
ev’tobj
;

98 
Ën
 = -1;

99 
buf
[24];

102 ià(!(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
ty³
)) ;

104 
ev’tobj
 = 
	`ü—‹SŒšgObjeù
(
ev’t
,
	`¡¾’
(event));

107 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYSPACE
) {

108 
chª
 = 
	`sd¢ewËn
("__keyspace@",11);

109 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
dbid
);

110 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

111 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

112 
chª
 = 
	`sdsÿtsds
(chª, 
key
->
±r
);

113 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

114 
	`pubsubPublishMes§ge
(
chªobj
, 
ev’tobj
);

115 
	`deüRefCouÁ
(
chªobj
);

119 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYEVENT
) {

120 
chª
 = 
	`sd¢ewËn
("__keyevent@",11);

121 ià(
Ën
 =ğ-1èËÀğ
	`Î2¡ršg
(
buf
,(buf),
dbid
);

122 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

123 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

124 
chª
 = 
	`sdsÿtsds
(chª, 
ev’tobj
->
±r
);

125 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

126 
	`pubsubPublishMes§ge
(
chªobj
, 
key
);

127 
	`deüRefCouÁ
(
chªobj
);

129 
	`deüRefCouÁ
(
ev’tobj
);

130 
	}
}

	@object.c

31 
	~"£rv”.h
"

32 
	~<m©h.h
>

33 
	~<ùy³.h
>

35 #ifdeà
__CYGWIN__


36 
	#¡¹Şd
(
a
,
b
è(()
	`¡¹od
(×),(b)))

	)

39 
robj
 *
	$ü—‹Objeù
(
ty³
, *
±r
) {

40 
robj
 *
o
 = 
	`zm®loc
((*o));

41 
o
->
ty³
 =ype;

42 
o
->
’codšg
 = 
OBJ_ENCODING_RAW
;

43 
o
->
±r
 =…tr;

44 
o
->
»fcouÁ
 = 1;

48 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

49 
o
->
Ìu
 = (
	`LFUG‘TimeInMšu‹s
()<<8è| 
LFU_INIT_VAL
;

51 
o
->
Ìu
 = 
	`LRU_CLOCK
();

53  
o
;

54 
	}
}

67 
robj
 *
	$makeObjeùSh¬ed
(
robj
 *
o
) {

68 
	`£rv”As£¹
(
o
->
»fcouÁ
 == 1);

69 
o
->
»fcouÁ
 = 
OBJ_SHARED_REFCOUNT
;

70  
o
;

71 
	}
}

75 
robj
 *
	$ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

76  
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
±r
,
Ën
));

77 
	}
}

82 
robj
 *
	$ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

83 
robj
 *
o
 = 
	`zm®loc
(Ôobj)+(
sdshdr8
)+
Ën
+1);

84 
sdshdr8
 *
sh
 = (*)(
o
+1);

86 
o
->
ty³
 = 
OBJ_STRING
;

87 
o
->
’codšg
 = 
OBJ_ENCODING_EMBSTR
;

88 
o
->
±r
 = 
sh
+1;

89 
o
->
»fcouÁ
 = 1;

90 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

91 
o
->
Ìu
 = (
	`LFUG‘TimeInMšu‹s
()<<8è| 
LFU_INIT_VAL
;

93 
o
->
Ìu
 = 
	`LRU_CLOCK
();

96 
sh
->
Ën
 =†en;

97 
sh
->
®loc
 = 
Ën
;

98 
sh
->
æags
 = 
SDS_TYPE_8
;

99 ià(
±r
) {

100 
	`memıy
(
sh
->
buf
,
±r
,
Ën
);

101 
sh
->
buf
[
Ën
] = '\0';

103 
	`mem£t
(
sh
->
buf
,0,
Ën
+1);

105  
o
;

106 
	}
}

114 
	#OBJ_ENCODING_EMBSTR_SIZE_LIMIT
 44

	)

115 
robj
 *
	$ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

116 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
)

117  
	`ü—‹EmbeddedSŒšgObjeù
(
±r
,
Ën
);

119  
	`ü—‹RawSŒšgObjeù
(
±r
,
Ën
);

120 
	}
}

122 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
) {

123 
robj
 *
o
;

124 ià(
v®ue
 >ğ0 && v®u< 
OBJ_SHARED_INTEGERS
) {

125 
	`šüRefCouÁ
(
sh¬ed
.
š‹g”s
[
v®ue
]);

126 
o
 = 
sh¬ed
.
š‹g”s
[
v®ue
];

128 ià(
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
) {

129 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

130 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

131 
o
->
±r
 = (*)(()
v®ue
);

133 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
v®ue
));

136  
o
;

137 
	}
}

145 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
) {

146 
buf
[256];

147 
Ën
 = 
	`ld2¡ršg
(
buf
,(buf),
v®ue
,
humªä›ndly
);

148  
	`ü—‹SŒšgObjeù
(
buf
,
Ën
);

149 
	}
}

159 
robj
 *
	$dupSŒšgObjeù
(cÚ¡ 
robj
 *
o
) {

160 
robj
 *
d
;

162 
	`£rv”As£¹
(
o
->
ty³
 =ğ
OBJ_STRING
);

164 
o
->
’codšg
) {

165 
OBJ_ENCODING_RAW
:

166  
	`ü—‹RawSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

167 
OBJ_ENCODING_EMBSTR
:

168  
	`ü—‹EmbeddedSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

169 
OBJ_ENCODING_INT
:

170 
d
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

171 
d
->
’codšg
 = 
OBJ_ENCODING_INT
;

172 
d
->
±r
 = 
o
->ptr;

173  
d
;

175 
	`£rv”Pªic
("Wrongƒncoding.");

178 
	}
}

180 
robj
 *
	$ü—‹Quickli¡Objeù
() {

181 
quickli¡
 *
l
 = 
	`quickli¡C»©e
();

182 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
l
);

183 
o
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

184  
o
;

185 
	}
}

187 
robj
 *
	$ü—‹Zli¡Objeù
() {

188 *
zl
 = 
	`zli¡New
();

189 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
zl
);

190 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

191  
o
;

192 
	}
}

194 
robj
 *
	$ü—‹S‘Objeù
() {

195 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

196 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
d
);

197 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

198  
o
;

199 
	}
}

201 
robj
 *
	$ü—‹IÁ£tObjeù
() {

202 
št£t
 *
is
 = 
	`št£tNew
();

203 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
is
);

204 
o
->
’codšg
 = 
OBJ_ENCODING_INTSET
;

205  
o
;

206 
	}
}

208 
robj
 *
	$ü—‹HashObjeù
() {

209 *
zl
 = 
	`zli¡New
();

210 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_HASH
, 
zl
);

211 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

212  
o
;

213 
	}
}

215 
robj
 *
	$ü—‹Z£tObjeù
() {

216 
z£t
 *
zs
 = 
	`zm®loc
((*zs));

217 
robj
 *
o
;

219 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

220 
zs
->
z¦
 = 
	`z¦C»©e
();

221 
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zs
);

222 
o
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

223  
o
;

224 
	}
}

226 
robj
 *
	$ü—‹Z£tZli¡Objeù
() {

227 *
zl
 = 
	`zli¡New
();

228 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zl
);

229 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

230  
o
;

231 
	}
}

233 
robj
 *
	$ü—‹ModuËObjeù
(
moduËTy³
 *
mt
, *
v®ue
) {

234 
moduËV®ue
 *
mv
 = 
	`zm®loc
((*mv));

235 
mv
->
ty³
 = 
mt
;

236 
mv
->
v®ue
 = value;

237  
	`ü—‹Objeù
(
OBJ_MODULE
,
mv
);

238 
	}
}

240 
	$ä“SŒšgObjeù
(
robj
 *
o
) {

241 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
) {

242 
	`sdsä“
(
o
->
±r
);

244 
	}
}

246 
	$ä“Li¡Objeù
(
robj
 *
o
) {

247 
o
->
’codšg
) {

248 
OBJ_ENCODING_QUICKLIST
:

249 
	`quickli¡R–—£
(
o
->
±r
);

252 
	`£rv”Pªic
("Unknown†istƒncodingype");

254 
	}
}

256 
	$ä“S‘Objeù
(
robj
 *
o
) {

257 
o
->
’codšg
) {

258 
OBJ_ENCODING_HT
:

259 
	`diùR–—£
((
diù
*è
o
->
±r
);

261 
OBJ_ENCODING_INTSET
:

262 
	`zä“
(
o
->
±r
);

265 
	`£rv”Pªic
("Unknown setƒncodingype");

267 
	}
}

269 
	$ä“Z£tObjeù
(
robj
 *
o
) {

270 
z£t
 *
zs
;

271 
o
->
’codšg
) {

272 
OBJ_ENCODING_SKIPLIST
:

273 
zs
 = 
o
->
±r
;

274 
	`diùR–—£
(
zs
->
diù
);

275 
	`z¦F»e
(
zs
->
z¦
);

276 
	`zä“
(
zs
);

278 
OBJ_ENCODING_ZIPLIST
:

279 
	`zä“
(
o
->
±r
);

282 
	`£rv”Pªic
("Unknown sorted setƒncoding");

284 
	}
}

286 
	$ä“HashObjeù
(
robj
 *
o
) {

287 
o
->
’codšg
) {

288 
OBJ_ENCODING_HT
:

289 
	`diùR–—£
((
diù
*è
o
->
±r
);

291 
OBJ_ENCODING_ZIPLIST
:

292 
	`zä“
(
o
->
±r
);

295 
	`£rv”Pªic
("Unknown hashƒncodingype");

298 
	}
}

300 
	$ä“ModuËObjeù
(
robj
 *
o
) {

301 
moduËV®ue
 *
mv
 = 
o
->
±r
;

302 
mv
->
ty³
->
	`ä“
(mv->
v®ue
);

303 
	`zä“
(
mv
);

304 
	}
}

306 
	$šüRefCouÁ
(
robj
 *
o
) {

307 ià(
o
->
»fcouÁ
 !ğ
OBJ_SHARED_REFCOUNT
) o->refcount++;

308 
	}
}

310 
	$deüRefCouÁ
(
robj
 *
o
) {

311 ià(
o
->
»fcouÁ
 == 1) {

312 
o
->
ty³
) {

313 
OBJ_STRING
: 
	`ä“SŒšgObjeù
(
o
); ;

314 
OBJ_LIST
: 
	`ä“Li¡Objeù
(
o
); ;

315 
OBJ_SET
: 
	`ä“S‘Objeù
(
o
); ;

316 
OBJ_ZSET
: 
	`ä“Z£tObjeù
(
o
); ;

317 
OBJ_HASH
: 
	`ä“HashObjeù
(
o
); ;

318 
OBJ_MODULE
: 
	`ä“ModuËObjeù
(
o
); ;

319 : 
	`£rv”Pªic
("Unknown objectype"); ;

321 
	`zä“
(
o
);

323 ià(
o
->
»fcouÁ
 <ğ0è
	`£rv”Pªic
("decrRefCount‡gainst„efcount <= 0");

324 ià(
o
->
»fcouÁ
 !ğ
OBJ_SHARED_REFCOUNT
) o->refcount--;

326 
	}
}

331 
	$deüRefCouÁVoid
(*
o
) {

332 
	`deüRefCouÁ
(
o
);

333 
	}
}

347 
robj
 *
	$»£tRefCouÁ
(
robj
 *
obj
) {

348 
obj
->
»fcouÁ
 = 0;

349  
obj
;

350 
	}
}

352 
	$checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
) {

353 ià(
o
->
ty³
 !=ype) {

354 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

358 
	}
}

360 
	$isSdsR•»£ÁabËAsLÚgLÚg
(
sds
 
s
, *
Îv®
) {

361  
	`¡ršg2Î
(
s
,
	`sd¦’
(s),
Îv®
è? 
C_OK
 : 
C_ERR
;

362 
	}
}

364 
	$isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
Îv®
) {

365 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

366 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

367 ià(
Îv®
è*Îv® = (è
o
->
±r
;

368  
C_OK
;

370  
	`isSdsR•»£ÁabËAsLÚgLÚg
(
o
->
±r
,
Îv®
);

372 
	}
}

375 
robj
 *
	$ŒyObjeùEncodšg
(
robj
 *
o
) {

376 
v®ue
;

377 
sds
 
s
 = 
o
->
±r
;

378 
size_t
 
Ën
;

384 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

389 ià(!
	`sdsEncodedObjeù
(
o
))  o;

394 ià(
o
->
»fcouÁ
 > 1)  o;

399 
Ën
 = 
	`sd¦’
(
s
);

400 ià(
Ën
 <ğ20 && 
	`¡ršg2l
(
s
,Ën,&
v®ue
)) {

405 ià((
£rv”
.
maxmemÜy
 == 0 ||

406 !(
£rv”
.
maxmemÜy
 & 
MAXMEMORY_FLAG_NO_SHARED_INTEGERS
)) &&

407 
v®ue
 >= 0 &&

408 
v®ue
 < 
OBJ_SHARED_INTEGERS
)

410 
	`deüRefCouÁ
(
o
);

411 
	`šüRefCouÁ
(
sh¬ed
.
š‹g”s
[
v®ue
]);

412  
sh¬ed
.
š‹g”s
[
v®ue
];

414 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
è
	`sdsä“
(o->
±r
);

415 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

416 
o
->
±r
 = (*è
v®ue
;

417  
o
;

425 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
) {

426 
robj
 *
emb
;

428 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
)  o;

429 
emb
 = 
	`ü—‹EmbeddedSŒšgObjeù
(
s
,
	`sd¦’
(s));

430 
	`deüRefCouÁ
(
o
);

431  
emb
;

443 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

444 
	`sd§va
(
s
è> 
Ën
/10)

446 
o
->
±r
 = 
	`sdsRemoveF»eS·û
(o->ptr);

450  
o
;

451 
	}
}

455 
robj
 *
	$g‘DecodedObjeù
(
robj
 *
o
) {

456 
robj
 *
dec
;

458 ià(
	`sdsEncodedObjeù
(
o
)) {

459 
	`šüRefCouÁ
(
o
);

460  
o
;

462 ià(
o
->
ty³
 =ğ
OBJ_STRING
 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

463 
buf
[32];

465 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

466 
dec
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

467  
dec
;

469 
	`£rv”Pªic
("Unknownƒncodingype");

471 
	}
}

481 
	#REDIS_COMPARE_BINARY
 (1<<0)

	)

482 
	#REDIS_COMPARE_COLL
 (1<<1)

	)

484 
	$com·»SŒšgObjeùsW™hFÏgs
(
robj
 *
a
,„obj *
b
, 
æags
) {

485 
	`£rv”As£¹W™hInfo
(
NULL
,
a
,a->
ty³
 =ğ
OBJ_STRING
 && 
b
->type == OBJ_STRING);

486 
buç
[128], 
bufb
[128], *
a¡r
, *
b¡r
;

487 
size_t
 
®’
, 
bËn
, 
mšËn
;

489 ià(
a
 =ğ
b
)  0;

490 ià(
	`sdsEncodedObjeù
(
a
)) {

491 
a¡r
 = 
a
->
±r
;

492 
®’
 = 
	`sd¦’
(
a¡r
);

494 
®’
 = 
	`Î2¡ršg
(
buç
,(buç),(è
a
->
±r
);

495 
a¡r
 = 
buç
;

497 ià(
	`sdsEncodedObjeù
(
b
)) {

498 
b¡r
 = 
b
->
±r
;

499 
bËn
 = 
	`sd¦’
(
b¡r
);

501 
bËn
 = 
	`Î2¡ršg
(
bufb
,(bufb),(è
b
->
±r
);

502 
b¡r
 = 
bufb
;

504 ià(
æags
 & 
REDIS_COMPARE_COLL
) {

505  
	`¡rcŞl
(
a¡r
,
b¡r
);

507 
cmp
;

509 
mšËn
 = (
®’
 < 
bËn
) ?‡len : blen;

510 
cmp
 = 
	`memcmp
(
a¡r
,
b¡r
,
mšËn
);

511 ià(
cmp
 =ğ0è 
®’
-
bËn
;

512  
cmp
;

514 
	}
}

517 
	$com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

518  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_BINARY
);

519 
	}
}

522 
	$cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

523  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_COLL
);

524 
	}
}

530 
	$equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

531 ià(
a
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

532 
b
->
’codšg
 =ğ
OBJ_ENCODING_INT
){

535  
a
->
±r
 =ğ
b
->ptr;

537  
	`com·»SŒšgObjeùs
(
a
,
b
) == 0;

539 
	}
}

541 
size_t
 
	$¡ršgObjeùL’
(
robj
 *
o
) {

542 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

543 ià(
	`sdsEncodedObjeù
(
o
)) {

544  
	`sd¦’
(
o
->
±r
);

546  
	`sdig™s10
(()
o
->
±r
);

548 
	}
}

550 
	$g‘DoubËFromObjeù
(cÚ¡ 
robj
 *
o
, *
rg‘
) {

551 
v®ue
;

552 *
•Œ
;

554 ià(
o
 =ğ
NULL
) {

555 
v®ue
 = 0;

557 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

558 ià(
	`sdsEncodedObjeù
(
o
)) {

559 
”ºo
 = 0;

560 
v®ue
 = 
	`¡¹od
(
o
->
±r
, &
•Œ
);

561 ià(
	`is¥aû
(((cÚ¡ *)
o
->
±r
)[0]) ||

562 
•Œ
[0] != '\0' ||

563 (
”ºo
 =ğ
ERANGE
 &&

564 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

565 
”ºo
 =ğ
EINVAL
 ||

566 
	`i¢ª
(
v®ue
))

567  
C_ERR
;

568 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

569 
v®ue
 = ()
o
->
±r
;

571 
	`£rv”Pªic
("Unknown stringƒncoding");

574 *
rg‘
 = 
v®ue
;

575  
C_OK
;

576 
	}
}

578 
	$g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

579 
v®ue
;

580 ià(
	`g‘DoubËFromObjeù
(
o
, &
v®ue
è!ğ
C_OK
) {

581 ià(
msg
 !ğ
NULL
) {

582 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

584 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

586  
C_ERR
;

588 *
rg‘
 = 
v®ue
;

589  
C_OK
;

590 
	}
}

592 
	$g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

593 
v®ue
;

594 *
•Œ
;

596 ià(
o
 =ğ
NULL
) {

597 
v®ue
 = 0;

599 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

600 ià(
	`sdsEncodedObjeù
(
o
)) {

601 
”ºo
 = 0;

602 
v®ue
 = 
	`¡¹Şd
(
o
->
±r
, &
•Œ
);

603 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] != '\0' ||

604 
”ºo
 =ğ
ERANGE
 || 
	`i¢ª
(
v®ue
))

605  
C_ERR
;

606 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

607 
v®ue
 = ()
o
->
±r
;

609 
	`£rv”Pªic
("Unknown stringƒncoding");

612 *
rg‘
 = 
v®ue
;

613  
C_OK
;

614 
	}
}

616 
	$g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

617 
v®ue
;

618 ià(
	`g‘LÚgDoubËFromObjeù
(
o
, &
v®ue
è!ğ
C_OK
) {

619 ià(
msg
 !ğ
NULL
) {

620 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

622 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

624  
C_ERR
;

626 *
rg‘
 = 
v®ue
;

627  
C_OK
;

628 
	}
}

630 
	$g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
) {

631 
v®ue
;

633 ià(
o
 =ğ
NULL
) {

634 
v®ue
 = 0;

636 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

637 ià(
	`sdsEncodedObjeù
(
o
)) {

638 ià(
	`¡ršg2Î
(
o
->
±r
,
	`sd¦’
(o->±r),&
v®ue
è=ğ0è 
C_ERR
;

639 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

640 
v®ue
 = ()
o
->
±r
;

642 
	`£rv”Pªic
("Unknown stringƒncoding");

645 ià(
rg‘
è*rg‘ = 
v®ue
;

646  
C_OK
;

647 
	}
}

649 
	$g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

650 
v®ue
;

651 ià(
	`g‘LÚgLÚgFromObjeù
(
o
, &
v®ue
è!ğ
C_OK
) {

652 ià(
msg
 !ğ
NULL
) {

653 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

655 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡n integer or out of„ange");

657  
C_ERR
;

659 *
rg‘
 = 
v®ue
;

660  
C_OK
;

661 
	}
}

663 
	$g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

664 
v®ue
;

666 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
o
, &
v®ue
, 
msg
è!ğ
C_OK
è 
C_ERR
;

667 ià(
v®ue
 < 
LONG_MIN
 || v®u> 
LONG_MAX
) {

668 ià(
msg
 !ğ
NULL
) {

669 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

671 
	`addR•lyE¼Ü
(
c
,"value is out of„ange");

673  
C_ERR
;

675 *
rg‘
 = 
v®ue
;

676  
C_OK
;

677 
	}
}

679 *
	$¡rEncodšg
(
’codšg
) {

680 
’codšg
) {

681 
OBJ_ENCODING_RAW
:  "raw";

682 
OBJ_ENCODING_INT
:  "int";

683 
OBJ_ENCODING_HT
:  "hashtable";

684 
OBJ_ENCODING_QUICKLIST
:  "quicklist";

685 
OBJ_ENCODING_ZIPLIST
:  "ziplist";

686 
OBJ_ENCODING_INTSET
:  "intset";

687 
OBJ_ENCODING_SKIPLIST
:  "skiplist";

688 
OBJ_ENCODING_EMBSTR
:  "embstr";

691 
	}
}

695 
robj
 *
	$objeùCommªdLookup
(
ş›Á
 *
c
, 
robj
 *
key
) {

696 
diùEÁry
 *
de
;

698 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,
key
->
±r
)è=ğ
NULL
)  NULL;

699  (
robj
*è
	`diùG‘V®
(
de
);

700 
	}
}

702 
robj
 *
	$objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

703 
robj
 *
o
 = 
	`objeùCommªdLookup
(
c
,
key
);

705 ià(!
o
è
	`addR•ly
(
c
, 
»¶y
);

706  
o
;

707 
	}
}

711 
	$objeùCommªd
(
ş›Á
 *
c
) {

712 
robj
 *
o
;

714 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»fcouÁ"è&& c->
¬gc
 == 3) {

715 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

716 =ğ
NULL
) ;

717 
	`addR•lyLÚgLÚg
(
c
,
o
->
»fcouÁ
);

718 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"’codšg"è&& c->
¬gc
 == 3) {

719 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

720 =ğ
NULL
) ;

721 
	`addR•lyBulkCSŒšg
(
c
,
	`¡rEncodšg
(
o
->
’codšg
));

722 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"idËtime"è&& c->
¬gc
 == 3) {

723 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

724 =ğ
NULL
) ;

725 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

726 
	`addR•lyE¼Ü
(
c
,"An LFU maxmemory…olicy is selected, idleime‚otracked. Please‚otehat when switching between…olicies‡t„untime LRU‡nd LFU data willake someimeo‡djust.");

729 
	`addR•lyLÚgLÚg
(
c
,
	`e¡im©eObjeùIdËTime
(
o
)/1000);

730 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"äeq"è&& c->
¬gc
 == 3) {

731 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

732 =ğ
NULL
) ;

733 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LRU
) {

734 
	`addR•lyE¼Ü
(
c
,"An LRU maxmemory…olicy is selected,‡ccess frequency‚otracked. Please‚otehat when switching between…olicies‡t„untime LRU‡nd LFU data willake someimeo‡djust.");

737 
	`addR•lyLÚgLÚg
(
c
,
o
->
Ìu
&255);

739 
	`addR•lyE¼Ü
(
c
,"Syntaxƒrror. Try OBJECT (refcount|encoding|idletime|freq)");

741 
	}
}

	@pqsort.c

40 
	~<sys/ty³s.h
>

42 
	~<”ºo.h
>

43 
	~<¡dlib.h
>

45 
šlše
 *
med3
 (*, *, *,

47 
šlše
 
	`sw­func
 (*, *, 
size_t
, );

49 
	#mš
(
a
, 
b
è×è< (bè?‡ : 
	)
b

54 
	#sw­code
(
TYPE
, 
·rmi
, 
·rmj
, 
n
) { \

55 
size_t
 
i
 = (
n
è/  (
TYPE
); \

56 
TYPE
 *
pi
 = (TYPE *)(*)(
·rmi
); \

57 
TYPE
 *
pj
 = (TYPE *)(*)(
·rmj
); \

59 
TYPE
 
t
 = *
pi
; \

60 *
pi
++ = *
pj
; \

61 *
pj
++ = 
t
; \

62 } --
i
 > 0); \

63 
	}

	)
}

65 
	#SWAPINIT
(
a
, 
es
è
sw­ty³
 = ((*)a - (*)0) % () || \

66 
es
 % (è? 2 :ƒ =ğ()? 0 : 1;

	)

68 
šlše
 

69 
	$sw­func
(*
a
, *
b
, 
size_t
 
n
, 
sw­ty³
)

72 ià(
sw­ty³
 <= 1)

73 
	`sw­code
(, 
a
, 
b
, 
n
)

75 
	`sw­code
(, 
a
, 
b
, 
n
)

76 
	}
}

78 
	#sw­
(
a
, 
b
) \

79 ià(
sw­ty³
 == 0) { \

80 
t
 = *(*)(*)(
a
); \

81 *(*)(*)(
a
èğ*(*)(*)(
b
); \

82 *(*)(*)(
b
èğ
t
; \

84 
	`sw­func
(
a
, 
b
, 
es
, 
sw­ty³
)

	)

86 
	#vecsw­
(
a
, 
b
, 
n
èià(Òè> 0è
	`sw­func
(×), (b), (
size_t
)Ò), 
sw­ty³
)

	)

88 
šlše
 *

89 
med3
(*
a
, *
b
, *
c
,

90 (*
cmp
) (const *, const *))

93  
	`cmp
(
a
, 
b
) < 0 ?

94 (
	`cmp
(
b
, 
c
è< 0 ? b : (cmp(
a
, c) < 0 ? c :‡ ))

95 :(
	`cmp
(
b
, 
c
è> 0 ? b : (cmp(
a
, c) < 0 ?‡ : c ));

96 
	}
}

99 
_pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

100 (*
cmp
è(cÚ¡ *, cÚ¡ *), *
Ìªge
, *
¼ªge
)

102 *
·
, *
pb
, *
pc
, *
pd
, *
¶
, *
pm
, *
²
;

103 
size_t
 
d
, 
r
;

104 
sw­ty³
, 
cmp_»suÉ
;

106 
loİ
: 
	`SWAPINIT
(
a
, 
es
);

107 ià(
n
 < 7) {

108 
pm
 = (*è
a
 + 
es
;…m < (*è¨+ 
n
 *ƒs;…m +=ƒs)

109 
¶
 = 
pm
;…È> (*è
a
 && 
	`cmp
ÕÈ- 
es
,…l) > 0;

110 
¶
 -ğ
es
)

111 
	`sw­
(
¶
,…È- 
es
);

114 
pm
 = (*è
a
 + (
n
 / 2è* 
es
;

115 ià(
n
 > 7) {

116 
¶
 = (*è
a
;

117 
²
 = (*è
a
 + (
n
 - 1è* 
es
;

118 ià(
n
 > 40) {

119 
d
 = (
n
 / 8è* 
es
;

120 
¶
 = 
	`med3
Õl,…È+ 
d
,…È+ 2 * d, 
cmp
);

121 
pm
 = 
	`med3
Õm - 
d
,…m,…m + d, 
cmp
);

122 
²
 = 
	`med3
ÕÀ- 2 * 
d
,…À- d,…n, 
cmp
);

124 
pm
 = 
	`med3
(
¶
,…m, 
²
, 
cmp
);

126 
	`sw­
(
a
, 
pm
);

127 
·
 = 
pb
 = (*è
a
 + 
es
;

129 
pc
 = 
pd
 = (*è
a
 + (
n
 - 1è* 
es
;

131 
pb
 <ğ
pc
 && (
cmp_»suÉ
 = 
	`cmp
Õb, 
a
)) <= 0) {

132 ià(
cmp_»suÉ
 == 0) {

133 
	`sw­
(
·
, 
pb
);

134 
·
 +ğ
es
;

136 
pb
 +ğ
es
;

138 
pb
 <ğ
pc
 && (
cmp_»suÉ
 = 
	`cmp
Õc, 
a
)) >= 0) {

139 ià(
cmp_»suÉ
 == 0) {

140 
	`sw­
(
pc
, 
pd
);

141 
pd
 -ğ
es
;

143 
pc
 -ğ
es
;

145 ià(
pb
 > 
pc
)

147 
	`sw­
(
pb
, 
pc
);

148 
pb
 +ğ
es
;

149 
pc
 -ğ
es
;

152 
²
 = (*è
a
 + 
n
 * 
es
;

153 
r
 = 
	`mš
(
·
 - (*è
a
, 
pb
 -…a);

154 
	`vecsw­
(
a
, 
pb
 - 
r
,„);

155 
r
 = 
	`mš
((
size_t
)(
pd
 - 
pc
), 
²
 -…d - 
es
);

156 
	`vecsw­
(
pb
, 
²
 - 
r
,„);

157 ià((
r
 = 
pb
 - 
·
è> 
es
) {

158 *
_l
 = 
a
, *
_r
 = ((*ï)+
r
-1;

159 ià(!((
Ìªge
 < 
_l
 && 
¼ªge
 < _l) ||

160 (
Ìªge
 > 
_r
 && 
¼ªge
 > _r)))

161 
	`_pqsÜt
(
a
, 
r
 / 
es
,ƒs, 
cmp
, 
Ìªge
, 
¼ªge
);

163 ià((
r
 = 
pd
 - 
pc
è> 
es
) {

164 *
_l
, *
_r
;

167 
a
 = 
²
 - 
r
;

168 
n
 = 
r
 / 
es
;

170 
_l
 = 
a
;

171 
_r
 = ((*)
a
)+
r
-1;

172 ià(!((
Ìªge
 < 
_l
 && 
¼ªge
 < _l) ||

173 (
Ìªge
 > 
_r
 && 
¼ªge
 > _r)))

174 
loİ
;

177 
	}
}

180 
pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

181 (*
cmp
è(cÚ¡ *, cÚ¡ *), 
size_t
 
Ìªge
, size_ˆ
¼ªge
)

183 
	`_pqsÜt
(
a
,
n
,
es
,
cmp
,((*ï)+(
Ìªge
*es),

184 ((*)
a
)+((
¼ªge
+1)*
es
)-1);

185 
	}
}

	@pqsort.h

33 #iâdeà
__PQSORT_H


34 
	#__PQSORT_H


	)

37 
pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

38 (*
cmp
è(cÚ¡ *, cÚ¡ *), 
size_t
 
Ìªge
, size_ˆ
¼ªge
);

	@pubsub.c

30 
	~"£rv”.h
"

36 
	$ä“PubsubP©‹º
(*
p
) {

37 
pubsubP©‹º
 *
·t
 = 
p
;

39 
	`deüRefCouÁ
(
·t
->
·‰”n
);

40 
	`zä“
(
·t
);

41 
	}
}

43 
	$li¡M©chPubsubP©‹º
(*
a
, *
b
) {

44 
pubsubP©‹º
 *
·
 = 
a
, *
pb
 = 
b
;

46  (
·
->
ş›Á
 =ğ
pb
->client) &&

47 (
	`equ®SŒšgObjeùs
(
·
->
·‰”n
,
pb
->pattern));

48 
	}
}

51 
	$ş›ÁSubsütiÚsCouÁ
(
ş›Á
 *
c
) {

52  
	`diùSize
(
c
->
pubsub_chªÃls
)+

53 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
);

54 
	}
}

58 
	$pubsubSubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
) {

59 
diùEÁry
 *
de
;

60 
li¡
 *
ş›Ás
 = 
NULL
;

61 
»tv®
 = 0;

64 ià(
	`diùAdd
(
c
->
pubsub_chªÃls
,
chªÃl
,
NULL
è=ğ
DICT_OK
) {

65 
»tv®
 = 1;

66 
	`šüRefCouÁ
(
chªÃl
);

68 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

69 ià(
de
 =ğ
NULL
) {

70 
ş›Ás
 = 
	`li¡C»©e
();

71 
	`diùAdd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
,
ş›Ás
);

72 
	`šüRefCouÁ
(
chªÃl
);

74 
ş›Ás
 = 
	`diùG‘V®
(
de
);

76 
	`li¡AddNodeTa
(
ş›Ás
,
c
);

79 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

80 
	`addR•ly
(
c
,
sh¬ed
.
subsüibebulk
);

81 
	`addR•lyBulk
(
c
,
chªÃl
);

82 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

83  
»tv®
;

84 
	}
}

88 
	$pubsubUnsubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
, 
nÙify
) {

89 
diùEÁry
 *
de
;

90 
li¡
 *
ş›Ás
;

91 
li¡Node
 *
Ê
;

92 
»tv®
 = 0;

95 
	`šüRefCouÁ
(
chªÃl
);

97 ià(
	`diùD–‘e
(
c
->
pubsub_chªÃls
,
chªÃl
è=ğ
DICT_OK
) {

98 
»tv®
 = 1;

100 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

101 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
de
 != NULL);

102 
ş›Ás
 = 
	`diùG‘V®
(
de
);

103 
Ê
 = 
	`li¡S—rchKey
(
ş›Ás
,
c
);

104 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
Ê
 != NULL);

105 
	`li¡D–Node
(
ş›Ás
,
Ê
);

106 ià(
	`li¡L’gth
(
ş›Ás
) == 0) {

110 
	`diùD–‘e
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

114 ià(
nÙify
) {

115 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

116 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

117 
	`addR•lyBulk
(
c
,
chªÃl
);

118 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

119 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

122 
	`deüRefCouÁ
(
chªÃl
);

123  
»tv®
;

124 
	}
}

127 
	$pubsubSubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
) {

128 
»tv®
 = 0;

130 ià(
	`li¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
è=ğ
NULL
) {

131 
»tv®
 = 1;

132 
pubsubP©‹º
 *
·t
;

133 
	`li¡AddNodeTa
(
c
->
pubsub_·‰”ns
,
·‰”n
);

134 
	`šüRefCouÁ
(
·‰”n
);

135 
·t
 = 
	`zm®loc
((*pat));

136 
·t
->
·‰”n
 = 
	`g‘DecodedObjeù
(pattern);

137 
·t
->
ş›Á
 = 
c
;

138 
	`li¡AddNodeTa
(
£rv”
.
pubsub_·‰”ns
,
·t
);

141 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

142 
	`addR•ly
(
c
,
sh¬ed
.
psubsüibebulk
);

143 
	`addR•lyBulk
(
c
,
·‰”n
);

144 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

145  
»tv®
;

146 
	}
}

150 
	$pubsubUnsubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
, 
nÙify
) {

151 
li¡Node
 *
Ê
;

152 
pubsubP©‹º
 
·t
;

153 
»tv®
 = 0;

155 
	`šüRefCouÁ
(
·‰”n
);

156 ià((
Ê
 = 
	`li¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
)è!ğ
NULL
) {

157 
»tv®
 = 1;

158 
	`li¡D–Node
(
c
->
pubsub_·‰”ns
,
Ê
);

159 
·t
.
ş›Á
 = 
c
;

160 
·t
.
·‰”n
 =…attern;

161 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
pubsub_·‰”ns
,&
·t
);

162 
	`li¡D–Node
(
£rv”
.
pubsub_·‰”ns
,
Ê
);

165 ià(
nÙify
) {

166 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

167 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

168 
	`addR•lyBulk
(
c
,
·‰”n
);

169 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

170 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

172 
	`deüRefCouÁ
(
·‰”n
);

173  
»tv®
;

174 
	}
}

178 
	$pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
) {

179 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
pubsub_chªÃls
);

180 
diùEÁry
 *
de
;

181 
couÁ
 = 0;

183 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

184 
robj
 *
chªÃl
 = 
	`diùG‘Key
(
de
);

186 
couÁ
 +ğ
	`pubsubUnsubsüibeChªÃl
(
c
,
chªÃl
,
nÙify
);

189 ià(
nÙify
 && 
couÁ
 == 0) {

190 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

191 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

192 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

193 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

194 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

196 
	`diùR–—£I‹¿tÜ
(
di
);

197  
couÁ
;

198 
	}
}

202 
	$pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
) {

203 
li¡Node
 *
Ê
;

204 
li¡I‹r
 
li
;

205 
couÁ
 = 0;

207 
	`li¡Rewšd
(
c
->
pubsub_·‰”ns
,&
li
);

208 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

209 
robj
 *
·‰”n
 = 
Ê
->
v®ue
;

211 
couÁ
 +ğ
	`pubsubUnsubsüibeP©‹º
(
c
,
·‰”n
,
nÙify
);

213 ià(
nÙify
 && 
couÁ
 == 0) {

215 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

216 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

217 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

218 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

219 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

221  
couÁ
;

222 
	}
}

225 
	$pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

226 
»ûiv”s
 = 0;

227 
diùEÁry
 *
de
;

228 
li¡Node
 *
Ê
;

229 
li¡I‹r
 
li
;

232 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

233 ià(
de
) {

234 
li¡
 *li¡ = 
	`diùG‘V®
(
de
);

235 
li¡Node
 *
Ê
;

236 
li¡I‹r
 
li
;

238 
	`li¡Rewšd
(
li¡
,&
li
);

239 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

240 
ş›Á
 *
c
 = 
Ê
->
v®ue
;

242 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

243 
	`addR•ly
(
c
,
sh¬ed
.
mes§gebulk
);

244 
	`addR•lyBulk
(
c
,
chªÃl
);

245 
	`addR•lyBulk
(
c
,
mes§ge
);

246 
»ûiv”s
++;

250 ià(
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
)) {

251 
	`li¡Rewšd
(
£rv”
.
pubsub_·‰”ns
,&
li
);

252 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

253 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

254 
pubsubP©‹º
 *
·t
 = 
Ê
->
v®ue
;

256 ià(
	`¡ršgm©chËn
((*)
·t
->
·‰”n
->
±r
,

257 
	`sd¦’
(
·t
->
·‰”n
->
±r
),

258 (*)
chªÃl
->
±r
,

259 
	`sd¦’
(
chªÃl
->
±r
),0)) {

260 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
mbulkhdr
[4]);

261 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
pmes§gebulk
);

262 
	`addR•lyBulk
(
·t
->
ş›Á
,·t->
·‰”n
);

263 
	`addR•lyBulk
(
·t
->
ş›Á
,
chªÃl
);

264 
	`addR•lyBulk
(
·t
->
ş›Á
,
mes§ge
);

265 
»ûiv”s
++;

268 
	`deüRefCouÁ
(
chªÃl
);

270  
»ûiv”s
;

271 
	}
}

277 
	$subsüibeCommªd
(
ş›Á
 *
c
) {

278 
j
;

280 
j
 = 1; j < 
c
->
¬gc
; j++)

281 
	`pubsubSubsüibeChªÃl
(
c
,c->
¬gv
[
j
]);

282 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

283 
	}
}

285 
	$unsubsüibeCommªd
(
ş›Á
 *
c
) {

286 ià(
c
->
¬gc
 == 1) {

287 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,1);

289 
j
;

291 
j
 = 1; j < 
c
->
¬gc
; j++)

292 
	`pubsubUnsubsüibeChªÃl
(
c
,c->
¬gv
[
j
],1);

294 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

295 
	}
}

297 
	$psubsüibeCommªd
(
ş›Á
 *
c
) {

298 
j
;

300 
j
 = 1; j < 
c
->
¬gc
; j++)

301 
	`pubsubSubsüibeP©‹º
(
c
,c->
¬gv
[
j
]);

302 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

303 
	}
}

305 
	$punsubsüibeCommªd
(
ş›Á
 *
c
) {

306 ià(
c
->
¬gc
 == 1) {

307 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,1);

309 
j
;

311 
j
 = 1; j < 
c
->
¬gc
; j++)

312 
	`pubsubUnsubsüibeP©‹º
(
c
,c->
¬gv
[
j
],1);

314 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

315 
	}
}

317 
	$publishCommªd
(
ş›Á
 *
c
) {

318 
»ûiv”s
 = 
	`pubsubPublishMes§ge
(
c
->
¬gv
[1],c->argv[2]);

319 ià(
£rv”
.
şu¡”_’abËd
)

320 
	`şu¡”Prİag©ePublish
(
c
->
¬gv
[1],c->argv[2]);

322 
	`fÜûCommªdPrİag©iÚ
(
c
,
PROPAGATE_REPL
);

323 
	`addR•lyLÚgLÚg
(
c
,
»ûiv”s
);

324 
	}
}

327 
	$pubsubCommªd
(
ş›Á
 *
c
) {

328 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"channels") &&

329 (
c
->
¬gc
 == 2 || c->argc ==3))

332 
sds
 
·t
 = (
c
->
¬gc
 =ğ2è? 
NULL
 : c->
¬gv
[2]->
±r
;

333 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
pubsub_chªÃls
);

334 
diùEÁry
 *
de
;

335 
mbËn
 = 0;

336 *
»¶yËn
;

338 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

339 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

340 
robj
 *
cobj
 = 
	`diùG‘Key
(
de
);

341 
sds
 
chªÃl
 = 
cobj
->
±r
;

343 ià(!
·t
 || 
	`¡ršgm©chËn
Õ©, 
	`sd¦’
(pat),

344 
chªÃl
, 
	`sd¦’
(channel),0))

346 
	`addR•lyBulk
(
c
,
cobj
);

347 
mbËn
++;

350 
	`diùR–—£I‹¿tÜ
(
di
);

351 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
mbËn
);

352 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"numsub"è&& c->
¬gc
 >= 2) {

354 
j
;

356 
	`addR•lyMuÉiBulkL’
(
c
,(c->
¬gc
-2)*2);

357 
j
 = 2; j < 
c
->
¬gc
; j++) {

358 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
£rv”
.
pubsub_chªÃls
,
c
->
¬gv
[
j
]);

360 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

361 
	`addR•lyLÚgLÚg
(
c
,
l
 ? 
	`li¡L’gth
(l) : 0);

363 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"num·t"è&& c->
¬gc
 == 2) {

365 
	`addR•lyLÚgLÚg
(
c
,
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
));

367 
	`addR•lyE¼ÜFÜm©
(
c
,

369 (*)
c
->
¬gv
[1]->
±r
);

371 
	}
}

	@quicklist.c

31 
	~<¡ršg.h
>

32 
	~"quickli¡.h
"

33 
	~"zm®loc.h
"

34 
	~"zli¡.h
"

35 
	~"ut.h
"

36 
	~"lzf.h
"

38 #ià
defšed
(
REDIS_TEST
è|| defšed(
REDIS_TEST_VERBOSE
)

39 
	~<¡dio.h
>

42 #iâdeà
REDIS_STATIC


43 
	#REDIS_STATIC
 

	)

47 cÚ¡ 
size_t
 
	gİtimiz©iÚ_Ëv–
[] = {4096, 8192, 16384, 32768, 65536};

51 
	#SIZE_SAFETY_LIMIT
 8192

	)

54 
	#MIN_COMPRESS_BYTES
 48

	)

59 
	#MIN_COMPRESS_IMPROVE
 8

	)

62 #iâdeà
REDIS_TEST_VERBOSE


63 
	#D
(...)

	)

65 
	#D
(...) \

67 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

68 
	`´štf
(
__VA_ARGS__
); \

69 
	`´štf
("\n"); \

70 } 0);

	)

74 
	#š™EÁry
(
e
) \

76 (
e
)->
zi
 = (e)->
v®ue
 = 
NULL
; \

77 (
e
)->
lÚgv®
 = -123456789; \

78 (
e
)->
quickli¡
 = 
NULL
; \

79 (
e
)->
node
 = 
NULL
; \

80 (
e
)->
off£t
 = 123456789; \

81 (
e
)->
sz
 = 0; \

82 } 0)

	)

84 #ià
__GNUC__
 >= 3

85 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

86 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

88 
	#lik–y
(
x
è(x)

	)

89 
	#uÆik–y
(
x
è(x)

	)

94 
quickli¡
 *
	$quickli¡C»©e
() {

95 
quickli¡
 *quicklist;

97 
quickli¡
 = 
	`zm®loc
((*quicklist));

98 
quickli¡
->
h—d
 = quickli¡->

 = 
NULL
;

99 
quickli¡
->
Ën
 = 0;

100 
quickli¡
->
couÁ
 = 0;

101 
quickli¡
->
com´ess
 = 0;

102 
quickli¡
->
fl
 = -2;

103  
quickli¡
;

104 
	}
}

106 
	#COMPRESS_MAX
 (1 << 16)

	)

107 
	$quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
com´ess
) {

108 ià(
com´ess
 > 
COMPRESS_MAX
) {

109 
com´ess
 = 
COMPRESS_MAX
;

110 } ià(
com´ess
 < 0) {

111 
com´ess
 = 0;

113 
quickli¡
->
com´ess
 = compress;

114 
	}
}

116 
	#FILL_MAX
 (1 << 15)

	)

117 
	$quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
) {

118 ià(
fl
 > 
FILL_MAX
) {

119 
fl
 = 
FILL_MAX
;

120 } ià(
fl
 < -5) {

121 
fl
 = -5;

123 
quickli¡
->
fl
 = fill;

124 
	}
}

126 
	$quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
) {

127 
	`quickli¡S‘Fl
(
quickli¡
, 
fl
);

128 
	`quickli¡S‘Com´essD•th
(
quickli¡
, 
d•th
);

129 
	}
}

132 
quickli¡
 *
	$quickli¡New
(
fl
, 
com´ess
) {

133 
quickli¡
 *quickli¡ = 
	`quickli¡C»©e
();

134 
	`quickli¡S‘O±iÚs
(
quickli¡
, 
fl
, 
com´ess
);

135  
quickli¡
;

136 
	}
}

138 
REDIS_STATIC
 
quickli¡Node
 *
	$quickli¡C»©eNode
() {

139 
quickli¡Node
 *
node
;

140 
node
 = 
	`zm®loc
((*node));

141 
node
->
zl
 = 
NULL
;

142 
node
->
couÁ
 = 0;

143 
node
->
sz
 = 0;

144 
node
->
Ãxt
 =‚ode->
´ev
 = 
NULL
;

145 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

146 
node
->
cÚš”
 = 
QUICKLIST_NODE_CONTAINER_ZIPLIST
;

147 
node
->
»com´ess
 = 0;

148  
node
;

149 
	}
}

152 
	$quickli¡CouÁ
(cÚ¡ 
quickli¡
 *
ql
è{  ql->
couÁ
; 
	}
}

155 
	$quickli¡R–—£
(
quickli¡
 *quicklist) {

156 
Ën
;

157 
quickli¡Node
 *
cu¼’t
, *
Ãxt
;

159 
cu¼’t
 = 
quickli¡
->
h—d
;

160 
Ën
 = 
quickli¡
->len;

161 
Ën
--) {

162 
Ãxt
 = 
cu¼’t
->next;

164 
	`zä“
(
cu¼’t
->
zl
);

165 
quickli¡
->
couÁ
 -ğ
cu¼’t
->count;

167 
	`zä“
(
cu¼’t
);

169 
quickli¡
->
Ën
--;

170 
cu¼’t
 = 
Ãxt
;

172 
	`zä“
(
quickli¡
);

173 
	}
}

178 
REDIS_STATIC
 
	$__quickli¡Com´essNode
(
quickli¡Node
 *
node
) {

179 #ifdeà
REDIS_TEST


180 
node
->
©‹m±ed_com´ess
 = 1;

184 ià(
node
->
sz
 < 
MIN_COMPRESS_BYTES
)

187 
quickli¡LZF
 *
lzf
 = 
	`zm®loc
((*lzfè+ 
node
->
sz
);

190 ià(((
lzf
->
sz
 = 
	`lzf_com´ess
(
node
->
zl
,‚ode->sz,†zf->
com´es£d
,

191 
node
->
sz
)) == 0) ||

192 
lzf
->
sz
 + 
MIN_COMPRESS_IMPROVE
 >ğ
node
->sz) {

194 
	`zä“
(
lzf
);

197 
lzf
 = 
	`z»®loc
Özf, (*lzfè+†zf->
sz
);

198 
	`zä“
(
node
->
zl
);

199 
node
->
zl
 = (*)
lzf
;

200 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_LZF
;

201 
node
->
»com´ess
 = 0;

203 
	}
}

206 
	#quickli¡Com´essNode
(
_node
) \

208 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) { \

209 
	`__quickli¡Com´essNode
((
_node
)); \

211 } 0)

	)

215 
REDIS_STATIC
 
	$__quickli¡Decom´essNode
(
quickli¡Node
 *
node
) {

216 #ifdeà
REDIS_TEST


217 
node
->
©‹m±ed_com´ess
 = 0;

220 *
decom´es£d
 = 
	`zm®loc
(
node
->
sz
);

221 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

222 ià(
	`lzf_decom´ess
(
lzf
->
com´es£d
,†zf->
sz
, 
decom´es£d
, 
node
->sz) == 0) {

224 
	`zä“
(
decom´es£d
);

227 
	`zä“
(
lzf
);

228 
node
->
zl
 = 
decom´es£d
;

229 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

231 
	}
}

234 
	#quickli¡Decom´essNode
(
_node
) \

236 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

237 
	`__quickli¡Decom´essNode
((
_node
)); \

239 } 0)

	)

242 
	#quickli¡Decom´essNodeFÜU£
(
_node
) \

244 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

245 
	`__quickli¡Decom´essNode
((
_node
)); \

246 (
_node
)->
»com´ess
 = 1; \

248 } 0)

	)

253 
size_t
 
	$quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
) {

254 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

255 *
d©a
 = 
lzf
->
com´es£d
;

256  
lzf
->
sz
;

257 
	}
}

259 
	#quickli¡AÎowsCom´essiÚ
(
_ql
è((_ql)->
com´ess
 !ğ0)

	)

265 
REDIS_STATIC
 
	$__quickli¡Com´ess
(cÚ¡ 
quickli¡
 *quicklist,

266 
quickli¡Node
 *
node
) {

269 ià(!
	`quickli¡AÎowsCom´essiÚ
(
quickli¡
) ||

270 
quickli¡
->
Ën
 < ()(quickli¡->
com´ess
 * 2))

275 ià(
quickli¡
->
com´ess
 == 1) {

276 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
t
 = quickli¡->

;

277 
	`quickli¡Decom´essNode
(
h
);

278 
	`quickli¡Decom´essNode
(
t
);

279 ià(
h
 !ğ
node
 && 
t
 !=‚ode)

280 
	`quickli¡Com´essNode
(
node
);

282 } ià(
quickli¡
->
com´ess
 == 2) {

283 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
hn
 = h->
Ãxt
, *
hÂ
 = hn->next;

284 
quickli¡Node
 *
t
 = 
quickli¡
->

, *

 =->
´ev
, *
p
 =p->prev;

285 
	`quickli¡Decom´essNode
(
h
);

286 
	`quickli¡Decom´essNode
(
hn
);

287 
	`quickli¡Decom´essNode
(
t
);

288 
	`quickli¡Decom´essNode
(

);

289 ià(
h
 !ğ
node
 && 
hn
 !ğnod&& 
t
 !ğnod&& 

 !=‚ode) {

290 
	`quickli¡Com´essNode
(
node
);

292 ià(
hÂ
 !ğ
t
) {

293 
	`quickli¡Com´essNode
(
hÂ
);

295 ià(
p
 !ğ
h
) {

296 
	`quickli¡Com´essNode
(
p
);

305 
quickli¡Node
 *
fÜw¬d
 = 
quickli¡
->
h—d
;

306 
quickli¡Node
 *
»v”£
 = 
quickli¡
->

;

307 
d•th
 = 0;

308 
š_d•th
 = 0;

309 
d•th
++ < 
quickli¡
->
com´ess
) {

310 
	`quickli¡Decom´essNode
(
fÜw¬d
);

311 
	`quickli¡Decom´essNode
(
»v”£
);

313 ià(
fÜw¬d
 =ğ
node
 || 
»v”£
 ==‚ode)

314 
š_d•th
 = 1;

316 ià(
fÜw¬d
 =ğ
»v”£
)

319 
fÜw¬d
 = fÜw¬d->
Ãxt
;

320 
»v”£
 =„ev”£->
´ev
;

323 ià(!
š_d•th
)

324 
	`quickli¡Com´essNode
(
node
);

326 ià(
d•th
 > 2) {

328 
	`quickli¡Com´essNode
(
fÜw¬d
);

329 
	`quickli¡Com´essNode
(
»v”£
);

331 
	}
}

333 
	#quickli¡Com´ess
(
_ql
, 
_node
) \

335 ià((
_node
)->
»com´ess
) \

336 
	`quickli¡Com´essNode
((
_node
)); \

338 
	`__quickli¡Com´ess
((
_ql
), (
_node
)); \

339 } 0)

	)

342 
	#quickli¡Recom´essOÆy
(
_ql
, 
_node
) \

344 ià((
_node
)->
»com´ess
) \

345 
	`quickli¡Com´essNode
((
_node
)); \

346 } 0)

	)

352 
REDIS_STATIC
 
	$__quickli¡In£¹Node
(
quickli¡
 *quicklist,

353 
quickli¡Node
 *
Şd_node
,

354 
quickli¡Node
 *
Ãw_node
, 
aá”
) {

355 ià(
aá”
) {

356 
Ãw_node
->
´ev
 = 
Şd_node
;

357 ià(
Şd_node
) {

358 
Ãw_node
->
Ãxt
 = 
Şd_node
->next;

359 ià(
Şd_node
->
Ãxt
)

360 
Şd_node
->
Ãxt
->
´ev
 = 
Ãw_node
;

361 
Şd_node
->
Ãxt
 = 
Ãw_node
;

363 ià(
quickli¡
->

 =ğ
Şd_node
)

364 
quickli¡
->

 = 
Ãw_node
;

366 
Ãw_node
->
Ãxt
 = 
Şd_node
;

367 ià(
Şd_node
) {

368 
Ãw_node
->
´ev
 = 
Şd_node
->prev;

369 ià(
Şd_node
->
´ev
)

370 
Şd_node
->
´ev
->
Ãxt
 = 
Ãw_node
;

371 
Şd_node
->
´ev
 = 
Ãw_node
;

373 ià(
quickli¡
->
h—d
 =ğ
Şd_node
)

374 
quickli¡
->
h—d
 = 
Ãw_node
;

377 ià(
quickli¡
->
Ën
 == 0) {

378 
quickli¡
->
h—d
 = quickli¡->

 = 
Ãw_node
;

381 ià(
Şd_node
)

382 
	`quickli¡Com´ess
(
quickli¡
, 
Şd_node
);

384 
quickli¡
->
Ën
++;

385 
	}
}

388 
REDIS_STATIC
 
	$_quickli¡In£¹NodeBefÜe
(
quickli¡
 *quicklist,

389 
quickli¡Node
 *
Şd_node
,

390 
quickli¡Node
 *
Ãw_node
) {

391 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 0);

392 
	}
}

394 
REDIS_STATIC
 
	$_quickli¡In£¹NodeAá”
(
quickli¡
 *quicklist,

395 
quickli¡Node
 *
Şd_node
,

396 
quickli¡Node
 *
Ãw_node
) {

397 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 1);

398 
	}
}

400 
REDIS_STATIC
 

401 
	$_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(cÚ¡ 
size_t
 
sz
,

402 cÚ¡ 
fl
) {

403 ià(
fl
 >= 0)

406 
size_t
 
off£t
 = (-
fl
) - 1;

407 ià(
off£t
 < ((
İtimiz©iÚ_Ëv–
) / (*optimization_level))) {

408 ià(
sz
 <ğ
İtimiz©iÚ_Ëv–
[
off£t
]) {

416 
	}
}

418 
	#sizeM“tsSaãtyLim™
(
sz
è((szè<ğ
SIZE_SAFETY_LIMIT
)

	)

420 
REDIS_STATIC
 
	$_quickli¡NodeAÎowIn£¹
(cÚ¡ 
quickli¡Node
 *
node
,

421 cÚ¡ 
fl
, cÚ¡ 
size_t
 
sz
) {

422 ià(
	`uÆik–y
(!
node
))

425 
zli¡_ov”h—d
;

427 ià(
sz
 < 254)

428 
zli¡_ov”h—d
 = 1;

430 
zli¡_ov”h—d
 = 5;

433 ià(
sz
 < 64)

434 
zli¡_ov”h—d
 += 1;

435 ià(
	`lik–y
(
sz
 < 16384))

436 
zli¡_ov”h—d
 += 2;

438 
zli¡_ov”h—d
 += 5;

441 
Ãw_sz
 = 
node
->
sz
 + sz + 
zli¡_ov”h—d
;

442 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
Ãw_sz
, 
fl
)))

444 ià(!
	`sizeM“tsSaãtyLim™
(
Ãw_sz
))

446 ià(()
node
->
couÁ
 < 
fl
)

450 
	}
}

452 
REDIS_STATIC
 
	$_quickli¡NodeAÎowM”ge
(cÚ¡ 
quickli¡Node
 *
a
,

453 cÚ¡ 
quickli¡Node
 *
b
,

454 cÚ¡ 
fl
) {

455 ià(!
a
 || !
b
)

460 
m”ge_sz
 = 
a
->
sz
 + 
b
->sz - 11;

461 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
m”ge_sz
, 
fl
)))

463 ià(!
	`sizeM“tsSaãtyLim™
(
m”ge_sz
))

465 ià(()(
a
->
couÁ
 + 
b
->couÁè<ğ
fl
)

469 
	}
}

471 
	#quickli¡NodeUpd©eSz
(
node
) \

473 (
node
)->
sz
 = 
	`zli¡BlobL’
(Òode)->
zl
); \

474 } 0)

	)

480 
	$quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

481 
quickli¡Node
 *
Üig_h—d
 = 
quickli¡
->
h—d
;

482 ià(
	`lik–y
(

483 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->
h—d
, quickli¡->
fl
, 
sz
))) {

484 
quickli¡
->
h—d
->
zl
 =

485 
	`zli¡Push
(
quickli¡
->
h—d
->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

486 
	`quickli¡NodeUpd©eSz
(
quickli¡
->
h—d
);

488 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

489 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

491 
	`quickli¡NodeUpd©eSz
(
node
);

492 
	`_quickli¡In£¹NodeBefÜe
(
quickli¡
, quickli¡->
h—d
, 
node
);

494 
quickli¡
->
couÁ
++;

495 
quickli¡
->
h—d
->
couÁ
++;

496  (
Üig_h—d
 !ğ
quickli¡
->
h—d
);

497 
	}
}

503 
	$quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

504 
quickli¡Node
 *
Üig_
 = 
quickli¡
->

;

505 ià(
	`lik–y
(

506 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->

, quickli¡->
fl
, 
sz
))) {

507 
quickli¡
->

->
zl
 =

508 
	`zli¡Push
(
quickli¡
->

->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

509 
	`quickli¡NodeUpd©eSz
(
quickli¡
->

);

511 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

512 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

514 
	`quickli¡NodeUpd©eSz
(
node
);

515 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

517 
quickli¡
->
couÁ
++;

518 
quickli¡
->

->
couÁ
++;

519  (
Üig_
 !ğ
quickli¡
->

);

520 
	}
}

525 
	$quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
) {

526 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

528 
node
->
zl
 = zl;

529 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

530 
node
->
sz
 = 
	`zli¡BlobL’
(
zl
);

532 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

533 
quickli¡
->
couÁ
 +ğ
node
->count;

534 
	}
}

542 
quickli¡
 *
	$quickli¡Aµ’dV®uesFromZli¡
(
quickli¡
 *quicklist,

543 *
zl
) {

544 *
v®ue
;

545 
sz
;

546 
lÚgv®
;

547 
lÚg¡r
[32] = {0};

549 *
p
 = 
	`zli¡Index
(
zl
, 0);

550 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
)) {

551 ià(!
v®ue
) {

553 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

554 
v®ue
 = (*)
lÚg¡r
;

556 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

557 
p
 = 
	`zli¡Next
(
zl
,…);

559 
	`zä“
(
zl
);

560  
quickli¡
;

561 
	}
}

566 
quickli¡
 *
	$quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

567 *
zl
) {

568  
	`quickli¡Aµ’dV®uesFromZli¡
(
	`quickli¡New
(
fl
, 
com´ess
), 
zl
);

569 
	}
}

571 
	#quickli¡D–‘eIfEm±y
(
ql
, 
n
) \

573 ià((
n
)->
couÁ
 == 0) { \

574 
	`__quickli¡D–Node
((
ql
), (
n
)); \

575 (
n
èğ
NULL
; \

577 } 0)

	)

579 
REDIS_STATIC
 
	$__quickli¡D–Node
(
quickli¡
 *quicklist,

580 
quickli¡Node
 *
node
) {

581 ià(
node
->
Ãxt
)

582 
node
->
Ãxt
->
´ev
 =‚ode->prev;

583 ià(
node
->
´ev
)

584 
node
->
´ev
->
Ãxt
 =‚ode->next;

586 ià(
node
 =ğ
quickli¡
->

) {

587 
quickli¡
->

 = 
node
->
´ev
;

590 ià(
node
 =ğ
quickli¡
->
h—d
) {

591 
quickli¡
->
h—d
 = 
node
->
Ãxt
;

596 
	`__quickli¡Com´ess
(
quickli¡
, 
NULL
);

598 
quickli¡
->
couÁ
 -ğ
node
->count;

600 
	`zä“
(
node
->
zl
);

601 
	`zä“
(
node
);

602 
quickli¡
->
Ën
--;

603 
	}
}

613 
REDIS_STATIC
 
	$quickli¡D–Index
(
quickli¡
 *quickli¡, 
quickli¡Node
 *
node
,

614 **
p
) {

615 
gÚe
 = 0;

617 
node
->
zl
 = 
	`zli¡D–‘e
Òode->zl, 
p
);

618 
node
->
couÁ
--;

619 ià(
node
->
couÁ
 == 0) {

620 
gÚe
 = 1;

621 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

623 
	`quickli¡NodeUpd©eSz
(
node
);

625 
quickli¡
->
couÁ
--;

627  
gÚe
 ? 1 : 0;

628 
	}
}

634 
	$quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

635 
quickli¡Node
 *
´ev
 = 
’Œy
->
node
->prev;

636 
quickli¡Node
 *
Ãxt
 = 
’Œy
->
node
->next;

637 
d–‘ed_node
 = 
	`quickli¡D–Index
((
quickli¡
 *)
’Œy
->quicklist,

638 
’Œy
->
node
, &’Œy->
zi
);

641 
™”
->
zi
 = 
NULL
;

644 ià(
d–‘ed_node
) {

645 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

646 
™”
->
cu¼’t
 = 
Ãxt
;

647 
™”
->
off£t
 = 0;

648 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

649 
™”
->
cu¼’t
 = 
´ev
;

650 
™”
->
off£t
 = -1;

661 
	}
}

667 
	$quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

668 
sz
) {

669 
quickli¡EÁry
 
’Œy
;

670 ià(
	`lik–y
(
	`quickli¡Index
(
quickli¡
, 
šdex
, &
’Œy
))) {

672 
’Œy
.
node
->
zl
 = 
	`zli¡D–‘e
ÓÁry.node->zl, &’Œy.
zi
);

673 
’Œy
.
node
->
zl
 = 
	`zli¡In£¹
ÓÁry.node->zl,ƒÁry.
zi
, 
d©a
, 
sz
);

674 
	`quickli¡NodeUpd©eSz
(
’Œy
.
node
);

675 
	`quickli¡Com´ess
(
quickli¡
, 
’Œy
.
node
);

680 
	}
}

695 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡Zli¡M”ge
(
quickli¡
 *quicklist,

696 
quickli¡Node
 *
a
,

697 
quickli¡Node
 *
b
) {

698 
	`D
("Reque¡ed m”g×,bè(%u, %u)", 
a
->
couÁ
, 
b
->count);

700 
	`quickli¡Decom´essNode
(
a
);

701 
	`quickli¡Decom´essNode
(
b
);

702 ià((
	`zli¡M”ge
(&
a
->
zl
, &
b
->zl))) {

704 
quickli¡Node
 *
k“p
 = 
NULL
, *
nok“p
 = NULL;

705 ià(!
a
->
zl
) {

706 
nok“p
 = 
a
;

707 
k“p
 = 
b
;

708 } ià(!
b
->
zl
) {

709 
nok“p
 = 
b
;

710 
k“p
 = 
a
;

712 
k“p
->
couÁ
 = 
	`zli¡L’
(k“p->
zl
);

713 
	`quickli¡NodeUpd©eSz
(
k“p
);

715 
nok“p
->
couÁ
 = 0;

716 
	`__quickli¡D–Node
(
quickli¡
, 
nok“p
);

717 
	`quickli¡Com´ess
(
quickli¡
, 
k“p
);

718  
k“p
;

721  
NULL
;

723 
	}
}

733 
REDIS_STATIC
 
	$_quickli¡M”geNodes
(
quickli¡
 *quicklist,

734 
quickli¡Node
 *
ûÁ”
) {

735 
fl
 = 
quickli¡
->fill;

736 
quickli¡Node
 *
´ev
, *
´ev_´ev
, *
Ãxt
, *
Ãxt_Ãxt
, *
rg‘
;

737 
´ev
 = 
´ev_´ev
 = 
Ãxt
 = 
Ãxt_Ãxt
 = 
rg‘
 = 
NULL
;

739 ià(
ûÁ”
->
´ev
) {

740 
´ev
 = 
ûÁ”
->prev;

741 ià(
ûÁ”
->
´ev
->prev)

742 
´ev_´ev
 = 
ûÁ”
->
´ev
->prev;

745 ià(
ûÁ”
->
Ãxt
) {

746 
Ãxt
 = 
ûÁ”
->next;

747 ià(
ûÁ”
->
Ãxt
->next)

748 
Ãxt_Ãxt
 = 
ûÁ”
->
Ãxt
->next;

752 ià(
	`_quickli¡NodeAÎowM”ge
(
´ev
, 
´ev_´ev
, 
fl
)) {

753 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
´ev_´ev
, 
´ev
);

754 
´ev_´ev
 = 
´ev
 = 
NULL
;

758 ià(
	`_quickli¡NodeAÎowM”ge
(
Ãxt
, 
Ãxt_Ãxt
, 
fl
)) {

759 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
Ãxt
, 
Ãxt_Ãxt
);

760 
Ãxt
 = 
Ãxt_Ãxt
 = 
NULL
;

764 ià(
	`_quickli¡NodeAÎowM”ge
(
ûÁ”
, c’‹r->
´ev
, 
fl
)) {

765 
rg‘
 = 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
ûÁ”
->
´ev
, center);

766 
ûÁ”
 = 
NULL
;

769 
rg‘
 = 
ûÁ”
;

773 ià(
	`_quickli¡NodeAÎowM”ge
(
rg‘
,¬g‘->
Ãxt
, 
fl
)) {

774 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
rg‘
,¬g‘->
Ãxt
);

776 
	}
}

797 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡S¶™Node
(
quickli¡Node
 *
node
, 
off£t
,

798 
aá”
) {

799 
size_t
 
zl_sz
 = 
node
->
sz
;

801 
quickli¡Node
 *
Ãw_node
 = 
	`quickli¡C»©eNode
();

802 
Ãw_node
->
zl
 = 
	`zm®loc
(
zl_sz
);

805 
	`memıy
(
Ãw_node
->
zl
, 
node
->zl, 
zl_sz
);

808 
Üig_¡¬t
 = 
aá”
 ? 
off£t
 + 1 : 0;

809 
Üig_ex‹Á
 = 
aá”
 ? -1 : 
off£t
;

810 
Ãw_¡¬t
 = 
aá”
 ? 0 : 
off£t
;

811 
Ãw_ex‹Á
 = 
aá”
 ? 
off£t
 + 1 : -1;

813 
	`D
("Aá” %d (%d);„ªges: [%d, %d], [%d, %d]", 
aá”
, 
off£t
, 
Üig_¡¬t
,

814 
Üig_ex‹Á
, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

816 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
Üig_¡¬t
, 
Üig_ex‹Á
);

817 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

818 
	`quickli¡NodeUpd©eSz
(
node
);

820 
Ãw_node
->
zl
 = 
	`zli¡D–‘eRªge
Òew_node->zl, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

821 
Ãw_node
->
couÁ
 = 
	`zli¡L’
Òew_node->
zl
);

822 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

824 
	`D
("Aá” s¶™†’gths: orig (%d),‚ew (%d)", 
node
->
couÁ
, 
Ãw_node
->count);

825  
Ãw_node
;

826 
	}
}

832 
REDIS_STATIC
 
	$_quickli¡In£¹
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

833 *
v®ue
, cÚ¡ 
size_t
 
sz
, 
aá”
) {

834 
fuÎ
 = 0, 
©_
 = 0, 
©_h—d
 = 0, 
fuÎ_Ãxt
 = 0, 
fuÎ_´ev
 = 0;

835 
fl
 = 
quickli¡
->fill;

836 
quickli¡Node
 *
node
 = 
’Œy
->node;

837 
quickli¡Node
 *
Ãw_node
 = 
NULL
;

839 ià(!
node
) {

841 
	`D
("No‚ode given!");

842 
Ãw_node
 = 
	`quickli¡C»©eNode
();

843 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

844 
	`__quickli¡In£¹Node
(
quickli¡
, 
NULL
, 
Ãw_node
, 
aá”
);

845 
Ãw_node
->
couÁ
++;

846 
quickli¡
->
couÁ
++;

851 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
, 
fl
, 
sz
)) {

852 
	`D
("Current‚ode is full with count %d with„equested fill %lu",

853 
node
->
couÁ
, 
fl
);

854 
fuÎ
 = 1;

857 ià(
aá”
 && (
’Œy
->
off£t
 =ğ
node
->
couÁ
)) {

858 
	`D
("At Tail of current ziplist");

859 
©_
 = 1;

860 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
Ãxt
, 
fl
, 
sz
)) {

861 
	`D
("Next‚ode is fulloo.");

862 
fuÎ_Ãxt
 = 1;

866 ià(!
aá”
 && (
’Œy
->
off£t
 == 0)) {

867 
	`D
("At Head");

868 
©_h—d
 = 1;

869 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
´ev
, 
fl
, 
sz
)) {

870 
	`D
("Prev‚ode is fulloo.");

871 
fuÎ_´ev
 = 1;

876 ià(!
fuÎ
 && 
aá”
) {

877 
	`D
("Not full, inserting‡fter current…osition.");

878 
	`quickli¡Decom´essNodeFÜU£
(
node
);

879 *
Ãxt
 = 
	`zli¡Next
(
node
->
zl
, 
’Œy
->
zi
);

880 ià(
Ãxt
 =ğ
NULL
) {

881 
node
->
zl
 = 
	`zli¡Push
Òode->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

883 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
Ãxt
, 
v®ue
, 
sz
);

885 
node
->
couÁ
++;

886 
	`quickli¡NodeUpd©eSz
(
node
);

887 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

888 } ià(!
fuÎ
 && !
aá”
) {

889 
	`D
("Not full, inserting before current…osition.");

890 
	`quickli¡Decom´essNodeFÜU£
(
node
);

891 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
’Œy
->
zi
, 
v®ue
, 
sz
);

892 
node
->
couÁ
++;

893 
	`quickli¡NodeUpd©eSz
(
node
);

894 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

895 } ià(
fuÎ
 && 
©_
 && 
node
->
Ãxt
 && !
fuÎ_Ãxt
 && 
aá”
) {

898 
	`D
("Full‡ndail, but‚ext isn't full; inserting‚ext‚ode head");

899 
Ãw_node
 = 
node
->
Ãxt
;

900 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

901 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

902 
Ãw_node
->
couÁ
++;

903 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

904 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

905 } ià(
fuÎ
 && 
©_h—d
 && 
node
->
´ev
 && !
fuÎ_´ev
 && !
aá”
) {

908 
	`D
("Full‡nd head, but…rev isn't full, inserting…rev‚odeail");

909 
Ãw_node
 = 
node
->
´ev
;

910 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

911 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

912 
Ãw_node
->
couÁ
++;

913 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

914 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

915 } ià(
fuÎ
 && ((
©_
 && 
node
->
Ãxt
 && 
fuÎ_Ãxt
 && 
aá”
) ||

916 (
©_h—d
 && 
node
->
´ev
 && 
fuÎ_´ev
 && !
aá”
))) {

919 
	`D
("\tprovisioning‚ew‚ode...");

920 
Ãw_node
 = 
	`quickli¡C»©eNode
();

921 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

922 
Ãw_node
->
couÁ
++;

923 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

924 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

925 } ià(
fuÎ
) {

928 
	`D
("\tsplitting‚ode...");

929 
	`quickli¡Decom´essNodeFÜU£
(
node
);

930 
Ãw_node
 = 
	`_quickli¡S¶™Node
(
node
, 
’Œy
->
off£t
, 
aá”
);

931 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
,

932 
aá”
 ? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
);

933 
Ãw_node
->
couÁ
++;

934 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

935 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

936 
	`_quickli¡M”geNodes
(
quickli¡
, 
node
);

939 
quickli¡
->
couÁ
++;

940 
	}
}

942 
	$quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

943 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

944 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 0);

945 
	}
}

947 
	$quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

948 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

949 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 1);

950 
	}
}

958 
	$quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
,

959 cÚ¡ 
couÁ
) {

960 ià(
couÁ
 <= 0)

963 
ex‹Á
 = 
couÁ
;

965 ià(
¡¬t
 >ğ0 && 
ex‹Á
 > (
quickli¡
->
couÁ
 - start)) {

967 
ex‹Á
 = 
quickli¡
->
couÁ
 - 
¡¬t
;

968 } ià(
¡¬t
 < 0 && 
ex‹Á
 > ()(-start)) {

970 
ex‹Á
 = -
¡¬t
;

973 
quickli¡EÁry
 
’Œy
;

974 ià(!
	`quickli¡Index
(
quickli¡
, 
¡¬t
, &
’Œy
))

977 
	`D
("Quickli¡ d–‘»que¡ fÜ s¹ %ld, couÁ %ld,ƒx‹Á: %ld", 
¡¬t
,

978 
couÁ
, 
ex‹Á
);

979 
quickli¡Node
 *
node
 = 
’Œy
.node;

982 
ex‹Á
) {

983 
quickli¡Node
 *
Ãxt
 = 
node
->next;

985 
d–
;

986 
d–‘e_’tœe_node
 = 0;

987 ià(
’Œy
.
off£t
 =ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

990 
d–‘e_’tœe_node
 = 1;

991 
d–
 = 
node
->
couÁ
;

992 } ià(
’Œy
.
off£t
 >ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

995 
d–
 = 
node
->
couÁ
 - 
’Œy
.
off£t
;

996 } ià(
’Œy
.
off£t
 < 0) {

1002 
d–
 = -
’Œy
.
off£t
;

1007 ià(
d–
 > 
ex‹Á
)

1008 
d–
 = 
ex‹Á
;

1012 
d–
 = 
ex‹Á
;

1015 
	`D
("[%ld]:‡skingo del: %ld because offset: %d; (ENTIRE NODE: %d), "

1017 
ex‹Á
, 
d–
, 
’Œy
.
off£t
, 
d–‘e_’tœe_node
, 
node
->
couÁ
);

1019 ià(
d–‘e_’tœe_node
) {

1020 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

1022 
	`quickli¡Decom´essNodeFÜU£
(
node
);

1023 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
’Œy
.
off£t
, 
d–
);

1024 
	`quickli¡NodeUpd©eSz
(
node
);

1025 
node
->
couÁ
 -ğ
d–
;

1026 
quickli¡
->
couÁ
 -ğ
d–
;

1027 
	`quickli¡D–‘eIfEm±y
(
quickli¡
, 
node
);

1028 ià(
node
)

1029 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

1032 
ex‹Á
 -ğ
d–
;

1034 
node
 = 
Ãxt
;

1036 
’Œy
.
off£t
 = 0;

1039 
	}
}

1042 
	$quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
) {

1043  
	`zli¡Com·»
(
p1
, 
p2
, 
p2_Ën
);

1044 
	}
}

1048 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
) {

1049 
quickli¡I‹r
 *
™”
;

1051 
™”
 = 
	`zm®loc
((*iter));

1053 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1054 
™”
->
cu¼’t
 = 
quickli¡
->
h—d
;

1055 
™”
->
off£t
 = 0;

1056 } ià(
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1057 
™”
->
cu¼’t
 = 
quickli¡
->

;

1058 
™”
->
off£t
 = -1;

1061 
™”
->
dœeùiÚ
 = direction;

1062 
™”
->
quickli¡
 = quicklist;

1064 
™”
->
zi
 = 
NULL
;

1066  
™”
;

1067 
	}
}

1071 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

1072 cÚ¡ 
dœeùiÚ
,

1073 cÚ¡ 
idx
) {

1074 
quickli¡EÁry
 
’Œy
;

1076 ià(
	`quickli¡Index
(
quickli¡
, 
idx
, &
’Œy
)) {

1077 
quickli¡I‹r
 *
ba£
 = 
	`quickli¡G‘I‹¿tÜ
(
quickli¡
, 
dœeùiÚ
);

1078 
ba£
->
zi
 = 
NULL
;

1079 
ba£
->
cu¼’t
 = 
’Œy
.
node
;

1080 
ba£
->
off£t
 = 
’Œy
.offset;

1081  
ba£
;

1083  
NULL
;

1085 
	}
}

1089 
	$quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
) {

1090 ià(
™”
->
cu¼’t
)

1091 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1093 
	`zä“
(
™”
);

1094 
	}
}

1117 
	$quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

1118 
	`š™EÁry
(
’Œy
);

1120 ià(!
™”
) {

1121 
	`D
("Returning because‚o iter!");

1125 
’Œy
->
quickli¡
 = 
™”
->quicklist;

1126 
’Œy
->
node
 = 
™”
->
cu¼’t
;

1128 ià(!
™”
->
cu¼’t
) {

1129 
	`D
("Returning because current‚ode is NULL")

1133 *(*
ÃxtFn
)(*, *èğ
NULL
;

1134 
off£t_upd©e
 = 0;

1136 ià(!
™”
->
zi
) {

1138 
	`quickli¡Decom´essNodeFÜU£
(
™”
->
cu¼’t
);

1139 
™”
->
zi
 = 
	`zli¡Index
(™”->
cu¼’t
->
zl
, i‹r->
off£t
);

1142 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1143 
ÃxtFn
 = 
zli¡Next
;

1144 
off£t_upd©e
 = 1;

1145 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1146 
ÃxtFn
 = 
zli¡P»v
;

1147 
off£t_upd©e
 = -1;

1149 
™”
->
zi
 = 
	`ÃxtFn
(™”->
cu¼’t
->
zl
, iter->zi);

1150 
™”
->
off£t
 +ğ
off£t_upd©e
;

1153 
’Œy
->
zi
 = 
™”
->zi;

1154 
’Œy
->
off£t
 = 
™”
->offset;

1156 ià(
™”
->
zi
) {

1158 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1163 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1164 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1166 
	`D
("Jumpingo start of‚ext‚ode");

1167 
™”
->
cu¼’t
 = i‹r->cu¼’t->
Ãxt
;

1168 
™”
->
off£t
 = 0;

1169 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1171 
	`D
("Jumpingoƒnd of…revious‚ode");

1172 
™”
->
cu¼’t
 = i‹r->cu¼’t->
´ev
;

1173 
™”
->
off£t
 = -1;

1175 
™”
->
zi
 = 
NULL
;

1176  
	`quickli¡Next
(
™”
, 
’Œy
);

1178 
	}
}

1186 
quickli¡
 *
	$quickli¡Dup
(
quickli¡
 *
Üig
) {

1187 
quickli¡
 *
cİy
;

1189 
cİy
 = 
	`quickli¡New
(
Üig
->
fl
, orig->
com´ess
);

1191 
quickli¡Node
 *
cu¼’t
 = 
Üig
->
h—d
; current;

1192 
cu¼’t
 = cu¼’t->
Ãxt
) {

1193 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

1195 ià(
node
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) {

1196 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

1197 
size_t
 
lzf_sz
 = (*
lzf
è+†zf->
sz
;

1198 
node
->
zl
 = 
	`zm®loc
(
lzf_sz
);

1199 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, 
lzf_sz
);

1200 } ià(
node
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) {

1201 
node
->
zl
 = 
	`zm®loc
(
cu¼’t
->
sz
);

1202 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, cu¼’t->
sz
);

1205 
node
->
couÁ
 = 
cu¼’t
->count;

1206 
cİy
->
couÁ
 +ğ
node
->count;

1207 
node
->
sz
 = 
cu¼’t
->sz;

1208 
node
->
’codšg
 = 
cu¼’t
->encoding;

1210 
	`_quickli¡In£¹NodeAá”
(
cİy
, cİy->

, 
node
);

1214  
cİy
;

1215 
	}
}

1225 
	$quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
idx
,

1226 
quickli¡EÁry
 *
’Œy
) {

1227 
quickli¡Node
 *
n
;

1228 
accum
 = 0;

1229 
šdex
;

1230 
fÜw¬d
 = 
idx
 < 0 ? 0 : 1;

1232 
	`š™EÁry
(
’Œy
);

1233 
’Œy
->
quickli¡
 = quicklist;

1235 ià(!
fÜw¬d
) {

1236 
šdex
 = (-
idx
) - 1;

1237 
n
 = 
quickli¡
->

;

1239 
šdex
 = 
idx
;

1240 
n
 = 
quickli¡
->
h—d
;

1243 ià(
šdex
 >ğ
quickli¡
->
couÁ
)

1246 
	`lik–y
(
n
)) {

1247 ià((
accum
 + 
n
->
couÁ
è> 
šdex
) {

1250 
	`D
("Skpšg ov” (%pè%u‡ˆaccum %Îd", (*)
n
,‚->
couÁ
,

1251 
accum
);

1252 
accum
 +ğ
n
->
couÁ
;

1253 
n
 = 
fÜw¬d
 ?‚->
Ãxt
 :‚->
´ev
;

1257 ià(!
n
)

1260 
	`D
("Found‚ode: %°©‡ccum %Îu, idx %Îu, sub+ %Îu, sub- %Îu", (*)
n
,

1261 
accum
, 
šdex
, index -‡ccum, (-index) - 1 +‡ccum);

1263 
’Œy
->
node
 = 
n
;

1264 ià(
fÜw¬d
) {

1266 
’Œy
->
off£t
 = 
šdex
 - 
accum
;

1270 
’Œy
->
off£t
 = (-
šdex
è- 1 + 
accum
;

1273 
	`quickli¡Decom´essNodeFÜU£
(
’Œy
->
node
);

1274 
’Œy
->
zi
 = 
	`zli¡Index
ÓÁry->
node
->
zl
,ƒÁry->
off£t
);

1275 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1279 
	}
}

1282 
	$quickli¡RÙ©e
(
quickli¡
 *quicklist) {

1283 ià(
quickli¡
->
couÁ
 <= 1)

1287 *
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1288 *
v®ue
;

1289 
lÚgv®
;

1290 
sz
;

1291 
lÚg¡r
[32] = {0};

1292 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
);

1295 ià(!
v®ue
) {

1297 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

1298 
v®ue
 = (*)
lÚg¡r
;

1302 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1307 ià(
quickli¡
->
Ën
 == 1) {

1308 
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1312 
	`quickli¡D–Index
(
quickli¡
, quickli¡->

, &
p
);

1313 
	}
}

1324 
quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1325 *
sz
, *
sv®
,

1326 *(*
§v”
)(*
d©a
, 
sz
)) {

1327 *
	gp
;

1328 *
	gv¡r
;

1329 
	gvËn
;

1330 
	gvlÚg
;

1331 
	gpos
 = (
wh”e
 =ğ
QUICKLIST_HEAD
) ? 0 : -1;

1333 ià(
	gquickli¡
->
	gcouÁ
 == 0)

1336 ià(
	gd©a
)

1337 *
	gd©a
 = 
NULL
;

1338 ià(
	gsz
)

1339 *
	gsz
 = 0;

1340 ià(
	gsv®
)

1341 *
	gsv®
 = -123456789;

1343 
quickli¡Node
 *
	gnode
;

1344 ià(
	gwh”e
 =ğ
QUICKLIST_HEAD
 && 
quickli¡
->
h—d
) {

1345 
node
 = 
quickli¡
->
h—d
;

1346 } ià(
	gwh”e
 =ğ
QUICKLIST_TAIL
 && 
quickli¡
->

) {

1347 
node
 = 
quickli¡
->

;

1352 
	gp
 = 
zli¡Index
(
node
->
zl
, 
pos
);

1353 ià(
zli¡G‘
(
p
, &
v¡r
, &
vËn
, &
vlÚg
)) {

1354 ià(
	gv¡r
) {

1355 ià(
	gd©a
)

1356 *
	gd©a
 = 
§v”
(
v¡r
, 
vËn
);

1357 ià(
	gsz
)

1358 *
	gsz
 = 
vËn
;

1360 ià(
	gd©a
)

1361 *
	gd©a
 = 
NULL
;

1362 ià(
	gsv®
)

1363 *
	gsv®
 = 
vlÚg
;

1365 
quickli¡D–Index
(
quickli¡
, 
node
, &
p
);

1372 
REDIS_STATIC
 *
	$_quickli¡Sav”
(*
d©a
, 
sz
) {

1373 *
v¡r
;

1374 ià(
d©a
) {

1375 
v¡r
 = 
	`zm®loc
(
sz
);

1376 
	`memıy
(
v¡r
, 
d©a
, 
sz
);

1377  
v¡r
;

1379  
NULL
;

1380 
	}
}

1385 
	$quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1386 *
sz
, *
¦Úg
) {

1387 *
v¡r
;

1388 
vËn
;

1389 
vlÚg
;

1390 ià(
quickli¡
->
couÁ
 == 0)

1392 
»t
 = 
	`quickli¡PİCu¡om
(
quickli¡
, 
wh”e
, &
v¡r
, &
vËn
, &
vlÚg
,

1393 
_quickli¡Sav”
);

1394 ià(
d©a
)

1395 *
d©a
 = 
v¡r
;

1396 ià(
¦Úg
)

1397 *
¦Úg
 = 
vlÚg
;

1398 ià(
sz
)

1399 *
sz
 = 
vËn
;

1400  
»t
;

1401 
	}
}

1404 
	$quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

1405 
wh”e
) {

1406 ià(
wh”e
 =ğ
QUICKLIST_HEAD
) {

1407 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1408 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
) {

1409 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

1411 
	}
}

1414 #ifdeà
REDIS_TEST


1415 
	~<¡dšt.h
>

1416 
	~<sys/time.h
>

1418 
	#as£¹
(
_e
) \

1420 ià(!(
_e
)) { \

1421 
	`´štf
("\n\n=== ASSERTION FAILED ===\n"); \

1422 
	`´štf
("==> %s:%d '%s' i nÙrue\n", 
__FILE__
, 
__LINE__
, #_e); \

1423 
”r
++; \

1425 } 0)

	)

1427 
	#y–l
(
¡r
, ...è
	`´štf
("ERROR! " sŒ "\n\n", 
__VA_ARGS__
)

	)

1429 
	#OK
 
	`´štf
("\tOK\n")

	)

1431 
	#ERROR
 \

1433 
	`´štf
("\tERROR!\n"); \

1434 
”r
++; \

1435 } 0)

	)

1437 
	#ERR
(
x
, ...) \

1439 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

1440 
	`´štf
("ERROR! " 
x
 "\n", 
__VA_ARGS__
); \

1441 
”r
++; \

1442 } 0)

	)

1444 
	#TEST
(
Çme
è
	`´štf
("‹¡ â€” %s\n",‚ame);

	)

1445 
	#TEST_DESC
(
Çme
, ...è
	`´štf
("‹¡ â€” "‚am"\n", 
__VA_ARGS__
);

	)

1447 
	#QL_TEST_VERBOSE
 0

	)

1449 
	#UNUSED
(
x
è()(x)

	)

1450 
	$ql_šfo
(
quickli¡
 *
ql
) {

1451 #ià
QL_TEST_VERBOSE


1452 
	`´štf
("CÚš”†’gth: %lu\n", 
ql
->
Ën
);

1453 
	`´štf
("CÚš” size: %lu\n", 
ql
->
couÁ
);

1454 ià(
ql
->
h—d
)

1455 
	`´štf
("\t(zsizh—d: %d)\n", 
	`zli¡L’
(
ql
->
h—d
->
zl
));

1456 ià(
ql
->

)

1457 
	`´štf
("\t(zsiz: %d)\n", 
	`zli¡L’
(
ql
->

->
zl
));

1458 
	`´štf
("\n");

1460 
	`UNUSED
(
ql
);

1462 
	}
}

1465 
	$u¡ime
() {

1466 
timev®
 
tv
;

1467 
u¡
;

1469 
	`g‘timeofday
(&
tv
, 
NULL
);

1470 
u¡
 = (()
tv
.
tv_£c
) * 1000000;

1471 
u¡
 +ğ
tv
.
tv_u£c
;

1472  
u¡
;

1473 
	}
}

1476 
	$m¡ime
(è{  
	`u¡ime
(è/ 1000; 
	}
}

1482 
	$_™½ršŒ
(
quickli¡
 *
ql
, 
´št
, 
fÜw¬d
) {

1483 
quickli¡I‹r
 *
™”
 =

1484 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
fÜw¬d
 ? 
AL_START_HEAD
 : 
AL_START_TAIL
);

1485 
quickli¡EÁry
 
’Œy
;

1486 
i
 = 0;

1487 
p
 = 0;

1488 
quickli¡Node
 *
´ev
 = 
NULL
;

1489 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1490 ià(
’Œy
.
node
 !ğ
´ev
) {

1492 
p
++;

1493 
´ev
 = 
’Œy
.
node
;

1495 ià(
´št
) {

1496 
	`´štf
("[%3d (%2d)]: [%.*s] (%Îd)\n", 
i
, 
p
, 
’Œy
.
sz
,

1497 (*)
’Œy
.
v®ue
,ƒÁry.
lÚgv®
);

1499 
i
++;

1501 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1502  
i
;

1503 
	}
}

1504 
	$™½ršŒ
(
quickli¡
 *
ql
, 
´št
) {

1505  
	`_™½ršŒ
(
ql
, 
´št
, 1);

1506 
	}
}

1508 
	$™½ršŒ_»v
(
quickli¡
 *
ql
, 
´št
) {

1509  
	`_™½ršŒ
(
ql
, 
´št
, 0);

1510 
	}
}

1512 
	#ql_v”ify
(
a
, 
b
, 
c
, 
d
, 
e
) \

1514 
”r
 +ğ
	`_ql_v”ify
((
a
), (
b
), (
c
), (
d
), (
e
)); \

1515 } 0)

	)

1518 
	$_ql_v”ify
(
quickli¡
 *
ql
, 
ušt32_t
 
Ën
, ušt32_ˆ
couÁ
,

1519 
ušt32_t
 
h—d_couÁ
, ušt32_ˆ
_couÁ
) {

1520 
”rÜs
 = 0;

1522 
	`ql_šfo
(
ql
);

1523 ià(
Ën
 !ğ
ql
->len) {

1524 
	`y–l
("quickli¡†’gth wrÚg:ƒx³ùed %d, gÙ %u", 
Ën
, 
ql
->len);

1525 
”rÜs
++;

1528 ià(
couÁ
 !ğ
ql
->count) {

1529 
	`y–l
("quickli¡ couÁ wrÚg:ƒx³ùed %d, gÙ %lu", 
couÁ
, 
ql
->count);

1530 
”rÜs
++;

1533 
loİr
 = 
	`™½ršŒ
(
ql
, 0);

1534 ià(
loİr
 !ğ()
ql
->
couÁ
) {

1535 
	`y–l
("quicklist cached count‚ot match‡ctual count:ƒxpected %lu, got "

1537 
ql
->
couÁ
, 
loİr
);

1538 
”rÜs
++;

1541 
¾oİr
 = 
	`™½ršŒ_»v
(
ql
, 0);

1542 ià(
loİr
 !ğ
¾oİr
) {

1543 
	`y–l
("quicklist has different forward counthan„everse count! "

1545 
loİr
, 
¾oİr
);

1546 
”rÜs
++;

1549 ià(
ql
->
Ën
 =ğ0 && !
”rÜs
) {

1550 
OK
;

1551  
”rÜs
;

1554 ià(
ql
->
h—d
 && 
h—d_couÁ
 !ğql->h—d->
couÁ
 &&

1555 
h—d_couÁ
 !ğ
	`zli¡L’
(
ql
->
h—d
->
zl
)) {

1556 
	`y–l
("quicklist head count wrong:ƒxpected %d, "

1558 
h—d_couÁ
, 
ql
->
h—d
->
couÁ
, 
	`zli¡L’
(ql->h—d->
zl
));

1559 
”rÜs
++;

1562 ià(
ql
->

 && 
_couÁ
 !ğql->->
couÁ
 &&

1563 
_couÁ
 !ğ
	`zli¡L’
(
ql
->

->
zl
)) {

1564 
	`y–l
("quicklistail count wrong:ƒxpected %d, "

1566 
_couÁ
, 
ql
->

->
couÁ
, 
	`zli¡L’
(ql->->
zl
));

1567 
”rÜs
++;

1570 ià(
	`quickli¡AÎowsCom´essiÚ
(
ql
)) {

1571 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

1572 
low_¿w
 = 
ql
->
com´ess
;

1573 
high_¿w
 = 
ql
->
Ën
 - ql->
com´ess
;

1575 
©
 = 0;‡ˆ< 
ql
->
Ën
;‡t++, 
node
 =‚ode->
Ãxt
) {

1576 ià(
node
 && (
©
 < 
low_¿w
 ||‡ˆ>ğ
high_¿w
)) {

1577 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_RAW
) {

1578 
	`y–l
("Incorrect compression:‚ode %d is "

1581 
©
, 
ql
->
com´ess
, 
low_¿w
, 
high_¿w
, ql->
Ën
, 
node
->
sz
,

1582 
node
->
»com´ess
);

1583 
”rÜs
++;

1586 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_LZF
 &&

1587 !
node
->
©‹m±ed_com´ess
) {

1588 
	`y–l
("Incorrect‚on-compression:‚ode %d is NOT "

1591 
©
, 
ql
->
com´ess
, 
low_¿w
, 
high_¿w
, ql->
Ën
, 
node
->
sz
,

1592 
node
->
»com´ess
,‚ode->
©‹m±ed_com´ess
);

1593 
”rÜs
++;

1599 ià(!
”rÜs
)

1600 
OK
;

1601  
”rÜs
;

1602 
	}
}

1605 *
	$g’¡r
(*
´efix
, 
i
) {

1606 
»suÉ
[64] = {0};

1607 
	`¢´štf
(
»suÉ
, ÔesuÉ), "%s%d", 
´efix
, 
i
);

1608  
»suÉ
;

1609 
	}
}

1612 
	$quickli¡Te¡
(
¬gc
, *
¬gv
[]) {

1613 
	`UNUSED
(
¬gc
);

1614 
	`UNUSED
(
¬gv
);

1616 
”r
 = 0;

1617 
İtimize_¡¬t
 =

1618 -()((
İtimiz©iÚ_Ëv–
) / (*optimization_level));

1620 
	`´štf
("S¹šg o±imiz©iÚ off£ˆ©: %d\n", 
İtimize_¡¬t
);

1622 
İtiÚs
[] = {0, 1, 2, 3, 4, 5, 6, 10};

1623 
size_t
 
İtiÚ_couÁ
 = (
İtiÚs
) / (*options);

1624 
ruÁime
[
İtiÚ_couÁ
];

1626 
_i
 = 0; _˜< ()
İtiÚ_couÁ
; _i++) {

1627 
	`´štf
("Te¡šg O±iÚ %d\n", 
İtiÚs
[
_i
]);

1628 
¡¬t
 = 
	`m¡ime
();

1630 
	`TEST
("create†ist") {

1631 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1632 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1633 
	`quickli¡R–—£
(
ql
);

1636 
	`TEST
("addoail ofƒmpty†ist") {

1637 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1638 
	`quickli¡PushTa
(
ql
, "hello", 6);

1640 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1641 
	`quickli¡R–—£
(
ql
);

1644 
	`TEST
("addo head ofƒmpty†ist") {

1645 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1646 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1648 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1649 
	`quickli¡R–—£
(
ql
);

1652 
f
 = 
İtimize_¡¬t
; f < 32; f++) {

1653 
	`TEST_DESC
("addØ 5x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1654 
İtiÚs
[
_i
]) {

1655 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1656 
i
 = 0; i < 5; i++)

1657 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1658 ià(
ql
->
couÁ
 != 5)

1659 
ERROR
;

1660 ià(
f
 == 32)

1661 
	`ql_v”ify
(
ql
, 1, 5, 5, 5);

1662 
	`quickli¡R–—£
(
ql
);

1666 
f
 = 
İtimize_¡¬t
; f < 32; f++) {

1667 
	`TEST_DESC
("addØh—d 5x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1668 
İtiÚs
[
_i
]) {

1669 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1670 
i
 = 0; i < 5; i++)

1671 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1672 ià(
ql
->
couÁ
 != 5)

1673 
ERROR
;

1674 ià(
f
 == 32)

1675 
	`ql_v”ify
(
ql
, 1, 5, 5, 5);

1676 
	`quickli¡R–—£
(
ql
);

1680 
f
 = 
İtimize_¡¬t
; f < 512; f++) {

1681 
	`TEST_DESC
("addØ 500x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1682 
İtiÚs
[
_i
]) {

1683 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1684 
i
 = 0; i < 500; i++)

1685 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
), 64);

1686 ià(
ql
->
couÁ
 != 500)

1687 
ERROR
;

1688 ià(
f
 == 32)

1689 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

1690 
	`quickli¡R–—£
(
ql
);

1694 
f
 = 
İtimize_¡¬t
; f < 512; f++) {

1695 
	`TEST_DESC
("addØh—d 500x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1696 
İtiÚs
[
_i
]) {

1697 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1698 
i
 = 0; i < 500; i++)

1699 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1700 ià(
ql
->
couÁ
 != 500)

1701 
ERROR
;

1702 ià(
f
 == 32)

1703 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

1704 
	`quickli¡R–—£
(
ql
);

1708 
	`TEST
("rotateƒmpty") {

1709 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1710 
	`quickli¡RÙ©e
(
ql
);

1711 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1712 
	`quickli¡R–—£
(
ql
);

1715 
f
 = 
İtimize_¡¬t
; f < 32; f++) {

1716 
	`TEST
("rotate one val once") {

1717 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1718 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1719 
	`quickli¡RÙ©e
(
ql
);

1722 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1723 
	`quickli¡R–—£
(
ql
);

1727 
f
 = 
İtimize_¡¬t
; f < 3; f++) {

1728 
	`TEST_DESC
("rÙ©500 v® 5000ime © fÈ%d‡ˆcom´es %d", 
f
,

1729 
İtiÚs
[
_i
]) {

1730 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1731 
	`quickli¡PushH—d
(
ql
, "900", 3);

1732 
	`quickli¡PushH—d
(
ql
, "7000", 4);

1733 
	`quickli¡PushH—d
(
ql
, "-1200", 5);

1734 
	`quickli¡PushH—d
(
ql
, "42", 2);

1735 
i
 = 0; i < 500; i++)

1736 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 64);

1737 
	`ql_šfo
(
ql
);

1738 
i
 = 0; i < 5000; i++) {

1739 
	`ql_šfo
(
ql
);

1740 
	`quickli¡RÙ©e
(
ql
);

1742 ià(
f
 == 1)

1743 
	`ql_v”ify
(
ql
, 504, 504, 1, 1);

1744 ià(
f
 == 2)

1745 
	`ql_v”ify
(
ql
, 252, 504, 2, 2);

1746 ià(
f
 == 32)

1747 
	`ql_v”ify
(
ql
, 16, 504, 32, 24);

1748 
	`quickli¡R–—£
(
ql
);

1752 
	`TEST
("popƒmpty") {

1753 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1754 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, 
NULL
, NULL, NULL);

1755 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1756 
	`quickli¡R–—£
(
ql
);

1759 
	`TEST
("pop 1 string from 1") {

1760 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1761 *
pİuÏ‹
 = 
	`g’¡r
("hello", 331);

1762 
	`quickli¡PushH—d
(
ql
, 
pİuÏ‹
, 32);

1763 *
d©a
;

1764 
sz
;

1765 
lv
;

1766 
	`ql_šfo
(
ql
);

1767 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1768 
	`as£¹
(
d©a
 !ğ
NULL
);

1769 
	`as£¹
(
sz
 == 32);

1770 ià(
	`¡rcmp
(
pİuÏ‹
, (*)
d©a
))

1771 
	`ERR
("Pİ'd v®u(%.*sèdidn'ˆequ® origš® v®u(%s)", 
sz
,

1772 
d©a
, 
pİuÏ‹
);

1773 
	`zä“
(
d©a
);

1774 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1775 
	`quickli¡R–—£
(
ql
);

1778 
	`TEST
("pop head 1‚umber from 1") {

1779 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1780 
	`quickli¡PushH—d
(
ql
, "55513", 5);

1781 *
d©a
;

1782 
sz
;

1783 
lv
;

1784 
	`ql_šfo
(
ql
);

1785 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1786 
	`as£¹
(
d©a
 =ğ
NULL
);

1787 
	`as£¹
(
lv
 == 55513);

1788 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1789 
	`quickli¡R–—£
(
ql
);

1792 
	`TEST
("pop head 500 from 500") {

1793 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1794 
i
 = 0; i < 500; i++)

1795 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1796 
	`ql_šfo
(
ql
);

1797 
i
 = 0; i < 500; i++) {

1798 *
d©a
;

1799 
sz
;

1800 
lv
;

1801 
»t
 = 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1802 
	`as£¹
(
»t
 == 1);

1803 
	`as£¹
(
d©a
 !ğ
NULL
);

1804 
	`as£¹
(
sz
 == 32);

1805 ià(
	`¡rcmp
(
	`g’¡r
("h–lo", 499 - 
i
), (*)
d©a
))

1806 
	`ERR
("Pop'd value (%.*s) didn'tƒqual original value (%s)",

1807 
sz
, 
d©a
, 
	`g’¡r
("h–lo", 499 - 
i
));

1808 
	`zä“
(
d©a
);

1810 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1811 
	`quickli¡R–—£
(
ql
);

1814 
	`TEST
("pop head 5000 from 500") {

1815 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1816 
i
 = 0; i < 500; i++)

1817 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1818 
i
 = 0; i < 5000; i++) {

1819 *
d©a
;

1820 
sz
;

1821 
lv
;

1822 
»t
 = 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1823 ià(
i
 < 500) {

1824 
	`as£¹
(
»t
 == 1);

1825 
	`as£¹
(
d©a
 !ğ
NULL
);

1826 
	`as£¹
(
sz
 == 32);

1827 ià(
	`¡rcmp
(
	`g’¡r
("h–lo", 499 - 
i
), (*)
d©a
))

1828 
	`ERR
("Pop'd value (%.*s) didn'tƒqual original value "

1830 
sz
, 
d©a
, 
	`g’¡r
("h–lo", 499 - 
i
));

1831 
	`zä“
(
d©a
);

1833 
	`as£¹
(
»t
 == 0);

1836 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1837 
	`quickli¡R–—£
(
ql
);

1840 
	`TEST
("iterate forward over 500†ist") {

1841 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1842 
	`quickli¡S‘Fl
(
ql
, 32);

1843 
i
 = 0; i < 500; i++)

1844 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1845 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

1846 
quickli¡EÁry
 
’Œy
;

1847 
i
 = 499, 
couÁ
 = 0;

1848 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1849 *
h
 = 
	`g’¡r
("h–lo", 
i
);

1850 ià(
	`¡rcmp
((*)
’Œy
.
v®ue
, 
h
))

1851 
	`ERR
("value [%s] didn't match [%s]‡t…osition %d",

1852 
’Œy
.
v®ue
, 
h
, 
i
);

1853 
i
--;

1854 
couÁ
++;

1856 ià(
couÁ
 != 500)

1857 
	`ERR
("Didn'ˆ™”©ov”ƒxaùly 500ƒËm’t (%d)", 
i
);

1858 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

1859 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1860 
	`quickli¡R–—£
(
ql
);

1863 
	`TEST
("iterate„everse over 500†ist") {

1864 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1865 
	`quickli¡S‘Fl
(
ql
, 32);

1866 
i
 = 0; i < 500; i++)

1867 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1868 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

1869 
quickli¡EÁry
 
’Œy
;

1870 
i
 = 0;

1871 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1872 *
h
 = 
	`g’¡r
("h–lo", 
i
);

1873 ià(
	`¡rcmp
((*)
’Œy
.
v®ue
, 
h
))

1874 
	`ERR
("value [%s] didn't match [%s]‡t…osition %d",

1875 
’Œy
.
v®ue
, 
h
, 
i
);

1876 
i
++;

1878 ià(
i
 != 500)

1879 
	`ERR
("Didn'ˆ™”©ov”ƒxaùly 500ƒËm’t (%d)", 
i
);

1880 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

1881 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1882 
	`quickli¡R–—£
(
ql
);

1885 
	`TEST
("insert before with 0ƒlements") {

1886 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1887 
quickli¡EÁry
 
’Œy
;

1888 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1889 
	`quickli¡In£¹BefÜe
(
ql
, &
’Œy
, "abc", 4);

1890 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1891 
	`quickli¡R–—£
(
ql
);

1894 
	`TEST
("insert‡fter with 0ƒlements") {

1895 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1896 
quickli¡EÁry
 
’Œy
;

1897 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1898 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, "abc", 4);

1899 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1900 
	`quickli¡R–—£
(
ql
);

1903 
	`TEST
("insert‡fter 1ƒlement") {

1904 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1905 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1906 
quickli¡EÁry
 
’Œy
;

1907 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1908 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, "abc", 4);

1909 
	`ql_v”ify
(
ql
, 1, 2, 2, 2);

1910 
	`quickli¡R–—£
(
ql
);

1913 
	`TEST
("insert before 1ƒlement") {

1914 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1915 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1916 
quickli¡EÁry
 
’Œy
;

1917 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1918 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, "abc", 4);

1919 
	`ql_v”ify
(
ql
, 1, 2, 2, 2);

1920 
	`quickli¡R–—£
(
ql
);

1923 
f
 = 
İtimize_¡¬t
; f < 12; f++) {

1924 
	`TEST_DESC
("insert once inƒlements while iterating‡t fill %d‡t "

1926 
f
, 
İtiÚs
[
_i
]) {

1927 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1928 
	`quickli¡PushTa
(
ql
, "abc", 3);

1929 
	`quickli¡S‘Fl
(
ql
, 1);

1930 
	`quickli¡PushTa
(
ql
, "def", 3);

1931 
	`quickli¡S‘Fl
(
ql
, 
f
);

1932 
	`quickli¡PushTa
(
ql
, "bob", 3);

1933 
	`quickli¡PushTa
(
ql
, "foo", 3);

1934 
	`quickli¡PushTa
(
ql
, "zoo", 3);

1936 
	`™½ršŒ
(
ql
, 0);

1938 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

1939 
quickli¡EÁry
 
’Œy
;

1940 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1941 ià(!
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bob", 3)) {

1943 
	`quickli¡In£¹BefÜe
(
ql
, &
’Œy
, "bar", 3);

1947 
	`™½ršŒ
(
ql
, 0);

1950 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1951 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "abc", 3))

1952 
	`ERR
("V®u0 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1953 
’Œy
.
v®ue
);

1954 
	`quickli¡Index
(
ql
, 1, &
’Œy
);

1955 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "def", 3))

1956 
	`ERR
("V®u1 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1957 
’Œy
.
v®ue
);

1958 
	`quickli¡Index
(
ql
, 2, &
’Œy
);

1959 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bar", 3))

1960 
	`ERR
("V®u2 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1961 
’Œy
.
v®ue
);

1962 
	`quickli¡Index
(
ql
, 3, &
’Œy
);

1963 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bob", 3))

1964 
	`ERR
("V®u3 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1965 
’Œy
.
v®ue
);

1966 
	`quickli¡Index
(
ql
, 4, &
’Œy
);

1967 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "foo", 3))

1968 
	`ERR
("V®u4 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1969 
’Œy
.
v®ue
);

1970 
	`quickli¡Index
(
ql
, 5, &
’Œy
);

1971 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "zoo", 3))

1972 
	`ERR
("V®u5 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1973 
’Œy
.
v®ue
);

1974 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1975 
	`quickli¡R–—£
(
ql
);

1979 
f
 = 
İtimize_¡¬t
; f < 1024; f++) {

1980 
	`TEST_DESC
(

1983 
f
, 
İtiÚs
[
_i
]) {

1984 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1985 
i
 = 0; i < 500; i++)

1986 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1987 
i
 = 0; i < 250; i++) {

1988 
quickli¡EÁry
 
’Œy
;

1989 
	`quickli¡Index
(
ql
, 250, &
’Œy
);

1990 
	`quickli¡In£¹BefÜe
(
ql
, &
’Œy
, 
	`g’¡r
("abc", 
i
), 32);

1992 ià(
f
 == 32)

1993 
	`ql_v”ify
(
ql
, 25, 750, 32, 20);

1994 
	`quickli¡R–—£
(
ql
);

1998 
f
 = 
İtimize_¡¬t
; f < 1024; f++) {

1999 
	`TEST_DESC
("insert [after] 250‚ew in middle of 500ƒlements‡t "

2001 
f
, 
İtiÚs
[
_i
]) {

2002 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2003 
i
 = 0; i < 500; i++)

2004 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2005 
i
 = 0; i < 250; i++) {

2006 
quickli¡EÁry
 
’Œy
;

2007 
	`quickli¡Index
(
ql
, 250, &
’Œy
);

2008 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, 
	`g’¡r
("abc", 
i
), 32);

2011 ià(
ql
->
couÁ
 != 750)

2012 
	`ERR
("Li¡ siznÙ 750, buˆ¿th” %ld", 
ql
->
couÁ
);

2014 ià(
f
 == 32)

2015 
	`ql_v”ify
(
ql
, 26, 750, 20, 32);

2016 
	`quickli¡R–—£
(
ql
);

2020 
	`TEST
("duplicateƒmpty†ist") {

2021 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2022 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2023 
quickli¡
 *
cİy
 = 
	`quickli¡Dup
(
ql
);

2024 
	`ql_v”ify
(
cİy
, 0, 0, 0, 0);

2025 
	`quickli¡R–—£
(
ql
);

2026 
	`quickli¡R–—£
(
cİy
);

2029 
	`TEST
("duplicate†ist of 1ƒlement") {

2030 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2031 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("hello", 3), 32);

2032 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

2033 
quickli¡
 *
cİy
 = 
	`quickli¡Dup
(
ql
);

2034 
	`ql_v”ify
(
cİy
, 1, 1, 1, 1);

2035 
	`quickli¡R–—£
(
ql
);

2036 
	`quickli¡R–—£
(
cİy
);

2039 
	`TEST
("duplicate†ist of 500") {

2040 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2041 
	`quickli¡S‘Fl
(
ql
, 32);

2042 
i
 = 0; i < 500; i++)

2043 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2044 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

2046 
quickli¡
 *
cİy
 = 
	`quickli¡Dup
(
ql
);

2047 
	`ql_v”ify
(
cİy
, 16, 500, 20, 32);

2048 
	`quickli¡R–—£
(
ql
);

2049 
	`quickli¡R–—£
(
cİy
);

2052 
f
 = 
İtimize_¡¬t
; f < 512; f++) {

2053 
	`TEST_DESC
("šdex 1,200 from 500†i¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2054 
İtiÚs
[
_i
]) {

2055 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2056 
i
 = 0; i < 500; i++)

2057 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2058 
quickli¡EÁry
 
’Œy
;

2059 
	`quickli¡Index
(
ql
, 1, &
’Œy
);

2060 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello2"))

2061 
OK
;

2063 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2064 
	`quickli¡Index
(
ql
, 200, &
’Œy
);

2065 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello201"))

2066 
OK
;

2068 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2069 
	`quickli¡R–—£
(
ql
);

2072 
	`TEST_DESC
("šdex -1,-2 from 500†i¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2073 
İtiÚs
[
_i
]) {

2074 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2075 
i
 = 0; i < 500; i++)

2076 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2077 
quickli¡EÁry
 
’Œy
;

2078 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2079 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello500"))

2080 
OK
;

2082 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2083 
	`quickli¡Index
(
ql
, -2, &
’Œy
);

2084 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello499"))

2085 
OK
;

2087 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2088 
	`quickli¡R–—£
(
ql
);

2091 
	`TEST_DESC
("šdex -100 from 500†i¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2092 
İtiÚs
[
_i
]) {

2093 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2094 
i
 = 0; i < 500; i++)

2095 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2096 
quickli¡EÁry
 
’Œy
;

2097 
	`quickli¡Index
(
ql
, -100, &
’Œy
);

2098 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello401"))

2099 
OK
;

2101 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2102 
	`quickli¡R–—£
(
ql
);

2105 
	`TEST_DESC
("indexoo big +1 from 50†ist‡t fill %d‡t compress %d",

2106 
f
, 
İtiÚs
[
_i
]) {

2107 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2108 
i
 = 0; i < 50; i++)

2109 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2110 
quickli¡EÁry
 
’Œy
;

2111 ià(
	`quickli¡Index
(
ql
, 50, &
’Œy
))

2112 
	`ERR
("Index found‡ˆ50 w™h 50†i¡: %.*s", 
’Œy
.
sz
,

2113 
’Œy
.
v®ue
);

2115 
OK
;

2116 
	`quickli¡R–—£
(
ql
);

2120 
	`TEST
("delete„angeƒmpty†ist") {

2121 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2122 
	`quickli¡D–Rªge
(
ql
, 5, 20);

2123 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2124 
	`quickli¡R–—£
(
ql
);

2127 
	`TEST
("delete„ange ofƒntire‚ode in†ist of one‚ode") {

2128 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2129 
i
 = 0; i < 32; i++)

2130 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2131 
	`ql_v”ify
(
ql
, 1, 32, 32, 32);

2132 
	`quickli¡D–Rªge
(
ql
, 0, 32);

2133 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2134 
	`quickli¡R–—£
(
ql
);

2137 
	`TEST
("delete„ange ofƒntire‚ode with overflow counts") {

2138 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2139 
i
 = 0; i < 32; i++)

2140 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2141 
	`ql_v”ify
(
ql
, 1, 32, 32, 32);

2142 
	`quickli¡D–Rªge
(
ql
, 0, 128);

2143 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2144 
	`quickli¡R–—£
(
ql
);

2147 
	`TEST
("delete middle 100 of 500†ist") {

2148 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2149 
	`quickli¡S‘Fl
(
ql
, 32);

2150 
i
 = 0; i < 500; i++)

2151 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2152 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

2153 
	`quickli¡D–Rªge
(
ql
, 200, 100);

2154 
	`ql_v”ify
(
ql
, 14, 400, 32, 20);

2155 
	`quickli¡R–—£
(
ql
);

2158 
	`TEST
("delete‚egative 1 from 500†ist") {

2159 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2160 
	`quickli¡S‘Fl
(
ql
, 32);

2161 
i
 = 0; i < 500; i++)

2162 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2163 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

2164 
	`quickli¡D–Rªge
(
ql
, -1, 1);

2165 
	`ql_v”ify
(
ql
, 16, 499, 32, 19);

2166 
	`quickli¡R–—£
(
ql
);

2169 
	`TEST
("delete‚egative 1 from 500†ist with overflow counts") {

2170 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2171 
	`quickli¡S‘Fl
(
ql
, 32);

2172 
i
 = 0; i < 500; i++)

2173 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2174 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

2175 
	`quickli¡D–Rªge
(
ql
, -1, 128);

2176 
	`ql_v”ify
(
ql
, 16, 499, 32, 19);

2177 
	`quickli¡R–—£
(
ql
);

2180 
	`TEST
("delete‚egative 100 from 500†ist") {

2181 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2182 
	`quickli¡S‘Fl
(
ql
, 32);

2183 
i
 = 0; i < 500; i++)

2184 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2185 
	`quickli¡D–Rªge
(
ql
, -100, 100);

2186 
	`ql_v”ify
(
ql
, 13, 400, 32, 16);

2187 
	`quickli¡R–—£
(
ql
);

2190 
	`TEST
("delete -10 count 5 from 50†ist") {

2191 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2192 
	`quickli¡S‘Fl
(
ql
, 32);

2193 
i
 = 0; i < 50; i++)

2194 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2195 
	`ql_v”ify
(
ql
, 2, 50, 32, 18);

2196 
	`quickli¡D–Rªge
(
ql
, -10, 5);

2197 
	`ql_v”ify
(
ql
, 2, 45, 32, 13);

2198 
	`quickli¡R–—£
(
ql
);

2201 
	`TEST
("numbers only†ist„ead") {

2202 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2203 
	`quickli¡PushTa
(
ql
, "1111", 4);

2204 
	`quickli¡PushTa
(
ql
, "2222", 4);

2205 
	`quickli¡PushTa
(
ql
, "3333", 4);

2206 
	`quickli¡PushTa
(
ql
, "4444", 4);

2207 
	`ql_v”ify
(
ql
, 1, 4, 4, 4);

2208 
quickli¡EÁry
 
’Œy
;

2209 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

2210 ià(
’Œy
.
lÚgv®
 != 1111)

2211 
	`ERR
("NÙ 1111, %Îd", 
’Œy
.
lÚgv®
);

2212 
	`quickli¡Index
(
ql
, 1, &
’Œy
);

2213 ià(
’Œy
.
lÚgv®
 != 2222)

2214 
	`ERR
("NÙ 2222, %Îd", 
’Œy
.
lÚgv®
);

2215 
	`quickli¡Index
(
ql
, 2, &
’Œy
);

2216 ià(
’Œy
.
lÚgv®
 != 3333)

2217 
	`ERR
("NÙ 3333, %Îd", 
’Œy
.
lÚgv®
);

2218 
	`quickli¡Index
(
ql
, 3, &
’Œy
);

2219 ià(
’Œy
.
lÚgv®
 != 4444)

2220 
	`ERR
("NÙ 4444, %Îd", 
’Œy
.
lÚgv®
);

2221 ià(
	`quickli¡Index
(
ql
, 4, &
’Œy
))

2222 
	`ERR
("Index…a¡ƒËm’ts: %Îd", 
’Œy
.
lÚgv®
);

2223 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2224 ià(
’Œy
.
lÚgv®
 != 4444)

2225 
	`ERR
("NÙ 4444 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2226 
	`quickli¡Index
(
ql
, -2, &
’Œy
);

2227 ià(
’Œy
.
lÚgv®
 != 3333)

2228 
	`ERR
("NÙ 3333 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2229 
	`quickli¡Index
(
ql
, -3, &
’Œy
);

2230 ià(
’Œy
.
lÚgv®
 != 2222)

2231 
	`ERR
("NÙ 2222 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2232 
	`quickli¡Index
(
ql
, -4, &
’Œy
);

2233 ià(
’Œy
.
lÚgv®
 != 1111)

2234 
	`ERR
("NÙ 1111 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2235 ià(
	`quickli¡Index
(
ql
, -5, &
’Œy
))

2236 
	`ERR
("Index…a¡ƒËm’t Ôev”£), %Îd", 
’Œy
.
lÚgv®
);

2237 
	`quickli¡R–—£
(
ql
);

2240 
	`TEST
("numbers†arger†ist„ead") {

2241 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2242 
	`quickli¡S‘Fl
(
ql
, 32);

2243 
num
[32];

2244 
nums
[5000];

2245 
i
 = 0; i < 5000; i++) {

2246 
nums
[
i
] = -5157318210846258176 + i;

2247 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2248 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2250 
	`quickli¡PushTa
(
ql
, "xxxxxxxxxxxxxxxxxxxx", 20);

2251 
quickli¡EÁry
 
’Œy
;

2252 
i
 = 0; i < 5000; i++) {

2253 
	`quickli¡Index
(
ql
, 
i
, &
’Œy
);

2254 ià(
’Œy
.
lÚgv®
 !ğ
nums
[
i
])

2255 
	`ERR
("[%d] NÙ†Úgv® %Îd buˆ¿th” %Îd", 
i
, 
nums
[i],

2256 
’Œy
.
lÚgv®
);

2257 
’Œy
.
lÚgv®
 = 0xdeadbeef;

2259 
	`quickli¡Index
(
ql
, 5000, &
’Œy
);

2260 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "xxxxxxxxxxxxxxxxxxxx", 20))

2261 
	`ERR
("SŒšg v®‚Ù m©ch: %s", 
’Œy
.
v®ue
);

2262 
	`ql_v”ify
(
ql
, 157, 5001, 32, 9);

2263 
	`quickli¡R–—£
(
ql
);

2266 
	`TEST
("numbers†arger†ist„ead B") {

2267 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2268 
	`quickli¡PushTa
(
ql
, "99", 2);

2269 
	`quickli¡PushTa
(
ql
, "98", 2);

2270 
	`quickli¡PushTa
(
ql
, "xxxxxxxxxxxxxxxxxxxx", 20);

2271 
	`quickli¡PushTa
(
ql
, "96", 2);

2272 
	`quickli¡PushTa
(
ql
, "95", 2);

2273 
	`quickli¡R•ÏûAtIndex
(
ql
, 1, "foo", 3);

2274 
	`quickli¡R•ÏûAtIndex
(
ql
, -1, "bar", 3);

2275 
	`quickli¡R–—£
(
ql
);

2276 
OK
;

2279 
f
 = 
İtimize_¡¬t
; f < 16; f++) {

2280 
	`TEST_DESC
("Ìeme¡‡ˆfÈ%d‡ˆcom´es %d", 
f
, 
İtiÚs
[
_i
]) {

2281 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2282 *
wÜds
[] = {"abc", "foo", "bar", "foobar", "foobared",

2284 *
»suÉ
[] = {"abc", "foo", "foobar", "foobared",

2286 *
»suÉB
[] = {"abc", "foo", "foobar",

2288 
i
 = 0; i < 9; i++)

2289 
	`quickli¡PushTa
(
ql
, 
wÜds
[
i
], 
	`¡¾’
(words[i]));

2292 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

2293 
quickli¡EÁry
 
’Œy
;

2294 
i
 = 0;

2295 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2296 ià(
	`quickli¡Com·»
(
’Œy
.
zi
, (*)"bar", 3)) {

2297 
	`quickli¡D–EÁry
(
™”
, &
’Œy
);

2299 
i
++;

2301 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2304 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

2305 
i
 = 0;

2306 
ok
 = 1;

2307 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2310 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, 
»suÉ
[
i
],ƒÁry.
sz
)) {

2311 
	`ERR
("No match‡t…osition %d, got %.*s instead of %s",

2312 
i
, 
’Œy
.
sz
,ƒÁry.
v®ue
, 
»suÉ
[i]);

2313 
ok
 = 0;

2315 
i
++;

2317 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2319 
	`quickli¡PushTa
(
ql
, "foo", 3);

2322 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

2323 
i
 = 0;

2324 
d–
 = 2;

2325 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2326 ià(
	`quickli¡Com·»
(
’Œy
.
zi
, (*)"foo", 3)) {

2327 
	`quickli¡D–EÁry
(
™”
, &
’Œy
);

2328 
d–
--;

2330 ià(!
d–
)

2332 
i
++;

2334 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2340 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

2341 
i
 = 0;

2342 
size_t
 
»sB
 = (
»suÉB
) / (*resultB);

2343 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2346 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, 
»suÉB
[
»sB
 - 1 - 
i
],

2347 
’Œy
.
sz
)) {

2348 
	`ERR
("No match‡t…osition %d, got %.*s instead of %s",

2349 
i
, 
’Œy
.
sz
,ƒÁry.
v®ue
, 
»suÉB
[
»sB
 - 1 - i]);

2350 
ok
 = 0;

2352 
i
++;

2355 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2357 ià(
ok
)

2358 
OK
;

2359 
	`quickli¡R–—£
(
ql
);

2363 
f
 = 
İtimize_¡¬t
; f < 16; f++) {

2364 
	`TEST_DESC
("™”©»v”£ + d–‘© fÈ%d‡ˆcom´es %d", 
f
,

2365 
İtiÚs
[
_i
]) {

2366 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2367 
	`quickli¡PushTa
(
ql
, "abc", 3);

2368 
	`quickli¡PushTa
(
ql
, "def", 3);

2369 
	`quickli¡PushTa
(
ql
, "hij", 3);

2370 
	`quickli¡PushTa
(
ql
, "jkl", 3);

2371 
	`quickli¡PushTa
(
ql
, "oop", 3);

2373 
quickli¡EÁry
 
’Œy
;

2374 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

2375 
i
 = 0;

2376 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2377 ià(
	`quickli¡Com·»
(
’Œy
.
zi
, (*)"hij", 3)) {

2378 
	`quickli¡D–EÁry
(
™”
, &
’Œy
);

2380 
i
++;

2382 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2384 ià(
i
 != 5)

2385 
	`ERR
("Didn'ˆ™”©5imes, i‹¿‹d %dimes.", 
i
);

2388 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

2389 
i
 = 0;

2390 *
v®s
[] = {"abc", "def", "jkl", "oop"};

2391 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2392 ià(!
	`quickli¡Com·»
(
’Œy
.
zi
, (*)
v®s
[
i
],

2394 
	`ERR
("V®u© %d didn'ˆm©ch %s\n", 
i
, 
v®s
[i]);

2396 
i
++;

2398 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2399 
	`quickli¡R–—£
(
ql
);

2403 
f
 = 
İtimize_¡¬t
; f < 800; f++) {

2404 
	`TEST_DESC
("™”©Ü‡ˆšdexe¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2405 
İtiÚs
[
_i
]) {

2406 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2407 
num
[32];

2408 
nums
[5000];

2409 
i
 = 0; i < 760; i++) {

2410 
nums
[
i
] = -5157318210846258176 + i;

2411 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2412 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2415 
quickli¡EÁry
 
’Œy
;

2416 
quickli¡I‹r
 *
™”
 =

2417 
	`quickli¡G‘I‹¿tÜAtIdx
(
ql
, 
AL_START_HEAD
, 437);

2418 
i
 = 437;

2419 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2420 ià(
’Œy
.
lÚgv®
 !ğ
nums
[
i
])

2421 
	`ERR
("Ex³ùed %Îd, buˆgÙ %Îd", 
’Œy
.
lÚgv®
,

2422 
nums
[
i
]);

2423 
i
++;

2425 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2426 
	`quickli¡R–—£
(
ql
);

2430 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2431 
	`TEST_DESC
("Érime¡ A‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2432 
İtiÚs
[
_i
]) {

2433 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2434 
num
[32];

2435 
nums
[5000];

2436 
i
 = 0; i < 32; i++) {

2437 
nums
[
i
] = -5157318210846258176 + i;

2438 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2439 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2441 ià(
f
 == 32)

2442 
	`ql_v”ify
(
ql
, 1, 32, 32, 32);

2444 
	`quickli¡D–Rªge
(
ql
, 0, 25);

2445 
	`quickli¡D–Rªge
(
ql
, 0, 0);

2446 
quickli¡EÁry
 
’Œy
;

2447 
i
 = 0; i < 7; i++) {

2448 
	`quickli¡Index
(
ql
, 
i
, &
’Œy
);

2449 ià(
’Œy
.
lÚgv®
 !ğ
nums
[25 + 
i
])

2450 
	`ERR
("Deleted invalid„ange! Expected %lld but got "

2452 
’Œy
.
lÚgv®
, 
nums
[25 + 
i
]);

2454 ià(
f
 == 32)

2455 
	`ql_v”ify
(
ql
, 1, 7, 7, 7);

2456 
	`quickli¡R–—£
(
ql
);

2460 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2461 
	`TEST_DESC
("Érime¡ B‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2462 
İtiÚs
[
_i
]) {

2465 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
QUICKLIST_NOCOMPRESS
);

2466 
num
[32];

2467 
nums
[5000];

2468 
i
 = 0; i < 33; i++) {

2469 
nums
[
i
] = i;

2470 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2471 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2473 ià(
f
 == 32)

2474 
	`ql_v”ify
(
ql
, 2, 33, 32, 1);

2476 
	`quickli¡D–Rªge
(
ql
, 0, 5);

2477 
	`quickli¡D–Rªge
(
ql
, -16, 16);

2478 ià(
f
 == 32)

2479 
	`ql_v”ify
(
ql
, 1, 12, 12, 12);

2480 
quickli¡EÁry
 
’Œy
;

2481 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

2482 ià(
’Œy
.
lÚgv®
 != 5)

2483 
	`ERR
("A:†Úgv®‚Ù 5, buˆ%Îd", 
’Œy
.
lÚgv®
);

2485 
OK
;

2486 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2487 ià(
’Œy
.
lÚgv®
 != 16)

2488 
	`ERR
("B! gÙ in¡—d: %Îd", 
’Œy
.
lÚgv®
);

2490 
OK
;

2491 
	`quickli¡PushTa
(
ql
, "bobobob", 7);

2492 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2493 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bobobob", 7))

2494 
	`ERR
("Tail doesn't match bobobob, it's %.*s instead",

2495 
’Œy
.
sz
,ƒÁry.
v®ue
);

2496 
i
 = 0; i < 12; i++) {

2497 
	`quickli¡Index
(
ql
, 
i
, &
’Œy
);

2498 ià(
’Œy
.
lÚgv®
 !ğ
nums
[5 + 
i
])

2499 
	`ERR
("Deleted invalid„ange! Expected %lld but got "

2501 
’Œy
.
lÚgv®
, 
nums
[5 + 
i
]);

2503 
	`quickli¡R–—£
(
ql
);

2507 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2508 
	`TEST_DESC
("Érime¡ C‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2509 
İtiÚs
[
_i
]) {

2510 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2511 
num
[32];

2512 
nums
[5000];

2513 
i
 = 0; i < 33; i++) {

2514 
nums
[
i
] = -5157318210846258176 + i;

2515 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2516 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2518 ià(
f
 == 32)

2519 
	`ql_v”ify
(
ql
, 2, 33, 32, 1);

2521 
	`quickli¡D–Rªge
(
ql
, 0, 3);

2522 
	`quickli¡D–Rªge
(
ql
, -29,

2524 ià(
f
 == 32)

2525 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

2526 
quickli¡EÁry
 
’Œy
;

2527 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

2528 ià(
’Œy
.
lÚgv®
 != -5157318210846258173)

2529 
ERROR
;

2531 
OK
;

2532 
	`quickli¡R–—£
(
ql
);

2536 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2537 
	`TEST_DESC
("Érime¡ D‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2538 
İtiÚs
[
_i
]) {

2539 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2540 
num
[32];

2541 
nums
[5000];

2542 
i
 = 0; i < 33; i++) {

2543 
nums
[
i
] = -5157318210846258176 + i;

2544 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2545 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2547 ià(
f
 == 32)

2548 
	`ql_v”ify
(
ql
, 2, 33, 32, 1);

2549 
	`quickli¡D–Rªge
(
ql
, -12, 3);

2550 ià(
ql
->
couÁ
 != 30)

2551 
	`ERR
("Didn't deleteƒxactlyhreeƒlements! Count is: %lu",

2552 
ql
->
couÁ
);

2553 
	`quickli¡R–—£
(
ql
);

2557 
f
 = 
İtimize_¡¬t
; f < 72; f++) {

2558 
	`TEST_DESC
("create quicklist from ziplist‡t fill %d‡t compress %d",

2559 
f
, 
İtiÚs
[
_i
]) {

2560 *
zl
 = 
	`zli¡New
();

2561 
nums
[64];

2562 
num
[64];

2563 
i
 = 0; i < 33; i++) {

2564 
nums
[
i
] = -5157318210846258176 + i;

2565 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2566 
zl
 =

2567 
	`zli¡Push
(
zl
, (*)
num
, 
sz
, 
ZIPLIST_TAIL
);

2569 
i
 = 0; i < 33; i++) {

2570 
zl
 = 
	`zli¡Push
(zl, (*)
	`g’¡r
("h–lo", 
i
),

2571 32, 
ZIPLIST_TAIL
);

2573 
quickli¡
 *
ql
 = 
	`quickli¡C»©eFromZli¡
(
f
, 
İtiÚs
[
_i
], 
zl
);

2574 ià(
f
 == 1)

2575 
	`ql_v”ify
(
ql
, 66, 66, 1, 1);

2576 ià(
f
 == 32)

2577 
	`ql_v”ify
(
ql
, 3, 66, 32, 2);

2578 ià(
f
 == 66)

2579 
	`ql_v”ify
(
ql
, 1, 66, 66, 66);

2580 
	`quickli¡R–—£
(
ql
);

2584 
¡İ
 = 
	`m¡ime
();

2585 
ruÁime
[
_i
] = 
¡İ
 - 
¡¬t
;

2589 
li¡_sizes
[] = {250, 251, 500, 999, 1000};

2590 
¡¬t
 = 
	`m¡ime
();

2591 
li¡
 = 0;†i¡ < ()((
li¡_sizes
) / (*list_sizes));

2592 
li¡
++) {

2593 
f
 = 
İtimize_¡¬t
; f < 128; f++) {

2594 
d•th
 = 1; depth < 40; depth++) {

2596 
	`TEST_DESC
("verify specific compression of interior‚odes with "

2599 
li¡_sizes
[
li¡
], 
f
, 
d•th
) {

2600 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
d•th
);

2601 
i
 = 0; i < 
li¡_sizes
[
li¡
]; i++) {

2602 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lØTAIL", 
i
 + 1), 64);

2603 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lØHEAD", 
i
 + 1), 64);

2606 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

2607 
low_¿w
 = 
ql
->
com´ess
;

2608 
high_¿w
 = 
ql
->
Ën
 - ql->
com´ess
;

2610 
©
 = 0;‡ˆ< 
ql
->
Ën
;

2611 
©
++, 
node
 =‚ode->
Ãxt
) {

2612 ià(
©
 < 
low_¿w
 ||‡ˆ>ğ
high_¿w
) {

2613 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_RAW
) {

2614 
	`ERR
("Incorrect compression:‚ode %d is "

2617 
©
, 
d•th
, 
low_¿w
, 
high_¿w
, 
ql
->
Ën
,

2618 
node
->
sz
);

2621 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_LZF
) {

2622 
	`ERR
("Incorrect‚on-compression:‚ode %d is NOT "

2625 
©
, 
d•th
, 
low_¿w
, 
high_¿w
, 
ql
->
Ën
,

2626 
node
->
sz
,‚ode->
©‹m±ed_com´ess
);

2630 
	`quickli¡R–—£
(
ql
);

2635 
¡İ
 = 
	`m¡ime
();

2637 
	`´štf
("\n");

2638 
size_t
 
i
 = 0; i < 
İtiÚ_couÁ
; i++)

2639 
	`´štf
("Te¡ Loİ %02d: %0.2à£cÚds.\n", 
İtiÚs
[
i
],

2640 ()
ruÁime
[
i
] / 1000);

2641 
	`´štf
("Com´essiÚs: %0.2à£cÚds.\n", ()(
¡İ
 - 
¡¬t
) / 1000);

2642 
	`´štf
("\n");

2644 ià(!
”r
)

2645 
	`´štf
("ALL TESTS PASSED!\n");

2647 
	`ERR
("SÜry,‚Ù‡Îe¡ ·s£d! IÀçù, %de¡ çed.", 
”r
);

2649  
”r
;

2650 
	}
}

	@quicklist.h

31 #iâdeà
__QUICKLIST_H__


32 
	#__QUICKLIST_H__


	)

44 
	squickli¡Node
 {

45 
quickli¡Node
 *
	m´ev
;

46 
quickli¡Node
 *
	mÃxt
;

47 *
	mzl
;

48 
	msz
;

49 
	mcouÁ
 : 16;

50 
	m’codšg
 : 2;

51 
	mcÚš”
 : 2;

52 
	m»com´ess
 : 1;

53 
	m©‹m±ed_com´ess
 : 1;

54 
	mexŒa
 : 10;

55 } 
	tquickli¡Node
;

62 
	squickli¡LZF
 {

63 
	msz
;

64 
	mcom´es£d
[];

65 } 
	tquickli¡LZF
;

73 
	squickli¡
 {

74 
quickli¡Node
 *
	mh—d
;

75 
quickli¡Node
 *
	m
;

76 
	mcouÁ
;

77 
	mËn
;

78 
	mfl
 : 16;

79 
	mcom´ess
 : 16;

80 } 
	tquickli¡
;

82 
	squickli¡I‹r
 {

83 cÚ¡ 
quickli¡
 *
	mquickli¡
;

84 
quickli¡Node
 *
	mcu¼’t
;

85 *
	mzi
;

86 
	moff£t
;

87 
	mdœeùiÚ
;

88 } 
	tquickli¡I‹r
;

90 
	squickli¡EÁry
 {

91 cÚ¡ 
quickli¡
 *
	mquickli¡
;

92 
quickli¡Node
 *
	mnode
;

93 *
	mzi
;

94 *
	mv®ue
;

95 
	mlÚgv®
;

96 
	msz
;

97 
	moff£t
;

98 } 
	tquickli¡EÁry
;

100 
	#QUICKLIST_HEAD
 0

	)

101 
	#QUICKLIST_TAIL
 -1

	)

104 
	#QUICKLIST_NODE_ENCODING_RAW
 1

	)

105 
	#QUICKLIST_NODE_ENCODING_LZF
 2

	)

108 
	#QUICKLIST_NOCOMPRESS
 0

	)

111 
	#QUICKLIST_NODE_CONTAINER_NONE
 1

	)

112 
	#QUICKLIST_NODE_CONTAINER_ZIPLIST
 2

	)

114 
	#quickli¡NodeIsCom´es£d
(
node
) \

115 ((
node
)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
)

	)

118 
quickli¡
 *
quickli¡C»©e
();

119 
quickli¡
 *
quickli¡New
(
fl
, 
com´ess
);

120 
quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
d•th
);

121 
quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
);

122 
quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
);

123 
quickli¡R–—£
(
quickli¡
 *quicklist);

124 
quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

125 
quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

126 
quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

127 
wh”e
);

128 
quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
);

129 
quickli¡
 *
quickli¡Aµ’dV®uesFromZli¡
(quicklist *quicklist,

130 *
zl
);

131 
quickli¡
 *
quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

132 *
zl
);

133 
quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

134 *
v®ue
, cÚ¡ 
size_t
 
sz
);

135 
quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

136 *
v®ue
, cÚ¡ 
size_t
 
sz
);

137 
quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
);

138 
quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

139 
sz
);

140 
quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
, cÚ¡ 
¡İ
);

141 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
);

142 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

143 
dœeùiÚ
, cÚ¡ 
idx
);

144 
quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
node
);

145 
quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
);

146 
quickli¡
 *
quickli¡Dup
(quickli¡ *
Üig
);

147 
quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
šdex
,

148 
quickli¡EÁry
 *
’Œy
);

149 
quickli¡Rewšd
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

150 
quickli¡RewšdTa
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

151 
quickli¡RÙ©e
(
quickli¡
 *quicklist);

152 
quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

153 *
sz
, *
sv®
,

154 *(*
§v”
)(*
d©a
, 
sz
));

155 
quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

156 *
sz
, *
¦Úg
);

157 
quickli¡CouÁ
(cÚ¡ 
quickli¡
 *
ql
);

158 
quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
);

159 
size_t
 
quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
);

161 #ifdeà
REDIS_TEST


162 
quickli¡Te¡
(
¬gc
, *
¬gv
[]);

166 
	#AL_START_HEAD
 0

	)

167 
	#AL_START_TAIL
 1

	)

	@rand.c

44 
	~<¡dšt.h
>

46 
	#N
 16

	)

47 
	#MASK
 ((1 << (
N
 - 1)è+ (1 << (N - 1)è- 1)

	)

48 
	#LOW
(
x
è(()(xè& 
MASK
)

	)

49 
	#HIGH
(
x
è
	`LOW
((xè>> 
N
)

	)

50 
	#MUL
(
x
, 
y
, 
z
è{ 
št32_t
 
l
 = ()(x) * ()(y); \

51 (
z
)[0] = 
	`LOW
(
l
); (z)[1] = 
	`HIGH
Ö); }

	)

52 
	#CARRY
(
x
, 
y
è((
št32_t
)(xè+ ()(yè> 
MASK
)

	)

53 
	#ADDEQU
(
x
, 
y
, 
z
è(z = 
	`CARRY
(x, (y)), x = 
	`LOW
(x + (y)))

	)

54 
	#X0
 0x330E

	)

55 
	#X1
 0xABCD

	)

56 
	#X2
 0x1234

	)

57 
	#A0
 0xE66D

	)

58 
	#A1
 0xDEEC

	)

59 
	#A2
 0x5

	)

60 
	#C
 0xB

	)

61 
	#SET3
(
x
, 
x0
, 
x1
, 
x2
è((x)[0] = (x0), (x)[1] = (x1), (x)[2] = (x2))

	)

62 
	#SETLOW
(
x
, 
y
, 
n
è
	`SET3
(x, 
	`LOW
((y)[n]), LOW((y)[Ò)+1]), LOW((y)[Ò)+2]))

	)

63 
	#SEED
(
x0
, 
x1
, 
x2
è(
	`SET3
(
x
, x0, x1, x2), SET3(
a
, 
A0
, 
A1
, 
A2
), 
c
 = 
C
)

	)

64 
	#REST
(
v
è
i
 = 0; i < 3; i++è{ 
xsubi
[i] = 
x
[i]; x[i] = 
‹mp
[i]; } \

65  (
v
);

	)

66 
	#HI_BIT
 (1L << (2 * 
N
 - 1))

	)

68 
ušt32_t
 
	gx
[3] = { 
X0
, 
X1
, 
X2
 }, 
	ga
[3] = { 
A0
, 
A1
, 
A2
 }, 
	gc
 = 
C
;

69 
Ãxt
();

71 
št32_t
 
	$»disL¿nd48
() {

72 
	`Ãxt
();

73  (((
št32_t
)
x
[2] << (
N
 - 1)) + (x[1] >> 1));

74 
	}
}

76 
	$»disS¿nd48
(
št32_t
 
£edv®
) {

77 
	`SEED
(
X0
, 
	`LOW
(
£edv®
), 
	`HIGH
(seedval));

78 
	}
}

80 
	$Ãxt
() {

81 
ušt32_t
 
p
[2], 
q
[2], 
r
[2], 
ÿ¼y0
, 
ÿ¼y1
;

83 
	`MUL
(
a
[0], 
x
[0], 
p
);

84 
	`ADDEQU
(
p
[0], 
c
, 
ÿ¼y0
);

85 
	`ADDEQU
(
p
[1], 
ÿ¼y0
, 
ÿ¼y1
);

86 
	`MUL
(
a
[0], 
x
[1], 
q
);

87 
	`ADDEQU
(
p
[1], 
q
[0], 
ÿ¼y0
);

88 
	`MUL
(
a
[1], 
x
[0], 
r
);

89 
x
[2] = 
	`LOW
(
ÿ¼y0
 + 
ÿ¼y1
 + 
	`CARRY
(
p
[1], 
r
[0]è+ 
q
[1] +„[1] +

90 
a
[0] * 
x
[2] +‡[1] * x[1] +‡[2] * x[0]);

91 
x
[1] = 
	`LOW
(
p
[1] + 
r
[0]);

92 
x
[0] = 
	`LOW
(
p
[0]);

93 
	}
}

	@rand.h

30 #iâdeà
REDIS_RANDOM_H


31 
	#REDIS_RANDOM_H


	)

33 
št32_t
 
»disL¿nd48
();

34 
»disS¿nd48
(
št32_t
 
£edv®
);

36 
	#REDIS_LRAND48_MAX
 
INT32_MAX


	)

	@rdb.c

30 
	~"£rv”.h
"

31 
	~"lzf.h
"

32 
	~"zm­.h
"

33 
	~"’dŸncÚv.h
"

35 
	~<m©h.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/time.h
>

38 
	~<sys/»sourû.h
>

39 
	~<sys/wa™.h
>

40 
	~<¬·/š‘.h
>

41 
	~<sys/¡©.h
>

42 
	~<sys/·¿m.h
>

44 
	#rdbEx™R•ÜtCÜru±RDB
(...è
	`rdbCheckTh’Ex™
(
__LINE__
,
__VA_ARGS__
)

	)

46 
rdbCheckMode
;

47 
rdbCheckE¼Ü
(cÚ¡ *
fmt
, ...);

48 
rdbCheckS‘E¼Ü
(cÚ¡ *
fmt
, ...);

50 
	$rdbCheckTh’Ex™
(
lš’um
, *
»asÚ
, ...) {

51 
va_li¡
 
­
;

52 
msg
[1024];

53 
Ën
;

55 
Ën
 = 
	`¢´štf
(
msg
,(msg),

56 "IÁ”ÇÈ”rÜ iÀRDB„—dšg funùiÚ‡ˆrdb.c:%d -> ", 
lš’um
);

57 
	`va_¡¬t
(
­
,
»asÚ
);

58 
	`v¢´štf
(
msg
+
Ën
,(msg)-Ën,
»asÚ
,
­
);

59 
	`va_’d
(
­
);

61 ià(!
rdbCheckMode
) {

62 
	`£rv”Log
(
LL_WARNING
, "%s", 
msg
);

63 *
¬gv
[2] = {"",
£rv”
.
rdb_f’ame
};

64 
	`»dis_check_rdb_maš
(2,
¬gv
);

66 
	`rdbCheckE¼Ü
("%s",
msg
);

68 
	`ex™
(1);

69 
	}
}

71 
	$rdbWr™eRaw
(
rio
 *
rdb
, *
p
, 
size_t
 
Ën
) {

72 ià(
rdb
 && 
	`rioWr™e
Ôdb,
p
,
Ën
) == 0)

74  
Ën
;

75 
	}
}

77 
	$rdbSaveTy³
(
rio
 *
rdb
, 
ty³
) {

78  
	`rdbWr™eRaw
(
rdb
,&
ty³
,1);

79 
	}
}

84 
	$rdbLßdTy³
(
rio
 *
rdb
) {

85 
ty³
;

86 ià(
	`rioR—d
(
rdb
,&
ty³
,1) == 0)  -1;

87  
ty³
;

88 
	}
}

90 
time_t
 
	$rdbLßdTime
(
rio
 *
rdb
) {

91 
št32_t
 
t32
;

92 ià(
	`rioR—d
(
rdb
,&
t32
,4) == 0)  -1;

93  (
time_t
)
t32
;

94 
	}
}

96 
	$rdbSaveMli£cÚdTime
(
rio
 *
rdb
, 
t
) {

97 
št64_t
 
t64
 = (št64_tè
t
;

98  
	`rdbWr™eRaw
(
rdb
,&
t64
,8);

99 
	}
}

101 
	$rdbLßdMli£cÚdTime
(
rio
 *
rdb
) {

102 
št64_t
 
t64
;

103 ià(
	`rioR—d
(
rdb
,&
t64
,8) == 0)  -1;

104  ()
t64
;

105 
	}
}

110 
	$rdbSaveL’
(
rio
 *
rdb
, 
ušt64_t
 
Ën
) {

111 
buf
[2];

112 
size_t
 
nwr™‹n
;

114 ià(
Ën
 < (1<<6)) {

116 
buf
[0] = (
Ën
&0xFF)|(
RDB_6BITLEN
<<6);

117 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

118 
nwr™‹n
 = 1;

119 } ià(
Ën
 < (1<<14)) {

121 
buf
[0] = ((
Ën
>>8)&0xFF)|(
RDB_14BITLEN
<<6);

122 
buf
[1] = 
Ën
&0xFF;

123 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,2) == -1)  -1;

124 
nwr™‹n
 = 2;

125 } ià(
Ën
 <ğ
UINT32_MAX
) {

127 
buf
[0] = 
RDB_32BITLEN
;

128 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

129 
ušt32_t
 
Ën32
 = 
	`htÚl
(
Ën
);

130 ià(
	`rdbWr™eRaw
(
rdb
,&
Ën32
,4) == -1)  -1;

131 
nwr™‹n
 = 1+4;

134 
buf
[0] = 
RDB_64BITLEN
;

135 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

136 
Ën
 = 
	`htÚu64
(len);

137 ià(
	`rdbWr™eRaw
(
rdb
,&
Ën
,8) == -1)  -1;

138 
nwr™‹n
 = 1+8;

140  
nwr™‹n
;

141 
	}
}

153 
	$rdbLßdL’ByRef
(
rio
 *
rdb
, *
i£ncoded
, 
ušt64_t
 *
ËÅŒ
) {

154 
buf
[2];

155 
ty³
;

157 ià(
i£ncoded
) *isencoded = 0;

158 ià(
	`rioR—d
(
rdb
,
buf
,1) == 0)  -1;

159 
ty³
 = (
buf
[0]&0xC0)>>6;

160 ià(
ty³
 =ğ
RDB_ENCVAL
) {

162 ià(
i£ncoded
) *isencoded = 1;

163 *
ËÅŒ
 = 
buf
[0]&0x3F;

164 } ià(
ty³
 =ğ
RDB_6BITLEN
) {

166 *
ËÅŒ
 = 
buf
[0]&0x3F;

167 } ià(
ty³
 =ğ
RDB_14BITLEN
) {

169 ià(
	`rioR—d
(
rdb
,
buf
+1,1) == 0)  -1;

170 *
ËÅŒ
 = ((
buf
[0]&0x3F)<<8)|buf[1];

171 } ià(
buf
[0] =ğ
RDB_32BITLEN
) {

173 
ušt32_t
 
Ën
;

174 ià(
	`rioR—d
(
rdb
,&
Ën
,4) == 0)  -1;

175 *
ËÅŒ
 = 
	`Áohl
(
Ën
);

176 } ià(
buf
[0] =ğ
RDB_64BITLEN
) {

178 
ušt64_t
 
Ën
;

179 ià(
	`rioR—d
(
rdb
,&
Ën
,8) == 0)  -1;

180 *
ËÅŒ
 = 
	`Áohu64
(
Ën
);

182 
	`rdbEx™R•ÜtCÜru±RDB
(

183 "UnknowÀËngthƒncodšg %d iÀrdbLßdL’()",
ty³
);

187 
	}
}

193 
ušt64_t
 
	$rdbLßdL’
(
rio
 *
rdb
, *
i£ncoded
) {

194 
ušt64_t
 
Ën
;

196 ià(
	`rdbLßdL’ByRef
(
rdb
,
i£ncoded
,&
Ën
è=ğ-1è 
RDB_LENERR
;

197  
Ën
;

198 
	}
}

204 
	$rdbEncodeIÁeg”
(
v®ue
, *
’c
) {

205 ià(
v®ue
 >= -(1<<7) && value <= (1<<7)-1) {

206 
’c
[0] = (
RDB_ENCVAL
<<6)|
RDB_ENC_INT8
;

207 
’c
[1] = 
v®ue
&0xFF;

209 } ià(
v®ue
 >= -(1<<15) && value <= (1<<15)-1) {

210 
’c
[0] = (
RDB_ENCVAL
<<6)|
RDB_ENC_INT16
;

211 
’c
[1] = 
v®ue
&0xFF;

212 
’c
[2] = (
v®ue
>>8)&0xFF;

214 } ià(
v®ue
 >= -(()1<<31) && value <= (()1<<31)-1) {

215 
’c
[0] = (
RDB_ENCVAL
<<6)|
RDB_ENC_INT32
;

216 
’c
[1] = 
v®ue
&0xFF;

217 
’c
[2] = (
v®ue
>>8)&0xFF;

218 
’c
[3] = (
v®ue
>>16)&0xFF;

219 
’c
[4] = (
v®ue
>>24)&0xFF;

224 
	}
}

229 *
	$rdbLßdIÁeg”Objeù
(
rio
 *
rdb
, 
’ùy³
, 
æags
, 
size_t
 *
ËÅŒ
) {

230 
¶aš
 = 
æags
 & 
RDB_LOAD_PLAIN
;

231 
sds
 = 
æags
 & 
RDB_LOAD_SDS
;

232 
’code
 = 
æags
 & 
RDB_LOAD_ENC
;

233 
’c
[4];

234 
v®
;

236 ià(
’ùy³
 =ğ
RDB_ENC_INT8
) {

237 ià(
	`rioR—d
(
rdb
,
’c
,1è=ğ0è 
NULL
;

238 
v®
 = (sigÃd )
’c
[0];

239 } ià(
’ùy³
 =ğ
RDB_ENC_INT16
) {

240 
ušt16_t
 
v
;

241 ià(
	`rioR—d
(
rdb
,
’c
,2è=ğ0è 
NULL
;

242 
v
 = 
’c
[0]|(enc[1]<<8);

243 
v®
 = (
št16_t
)
v
;

244 } ià(
’ùy³
 =ğ
RDB_ENC_INT32
) {

245 
ušt32_t
 
v
;

246 ià(
	`rioR—d
(
rdb
,
’c
,4è=ğ0è 
NULL
;

247 
v
 = 
’c
[0]|(enc[1]<<8)|(enc[2]<<16)|(enc[3]<<24);

248 
v®
 = (
št32_t
)
v
;

250 
v®
 = 0;

251 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDB iÁeg”ƒncodšgy³ %d",
’ùy³
);

253 ià(
¶aš
 || 
sds
) {

254 
buf
[
LONG_STR_SIZE
], *
p
;

255 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
v®
);

256 ià(
ËÅŒ
è*ËÅŒ = 
Ën
;

257 
p
 = 
¶aš
 ? 
	`zm®loc
(
Ën
è: 
	`sd¢ewËn
(
NULL
,len);

258 
	`memıy
(
p
,
buf
,
Ën
);

259  
p
;

260 } ià(
’code
) {

261  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®
);

263  
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
v®
));

265 
	}
}

270 
	$rdbTryIÁeg”Encodšg
(*
s
, 
size_t
 
Ën
, *
’c
) {

271 
v®ue
;

272 *
’d±r
, 
buf
[32];

275 
v®ue
 = 
	`¡¹Şl
(
s
, &
’d±r
, 10);

276 ià(
’d±r
[0] != '\0')  0;

277 
	`Î2¡ršg
(
buf
,32,
v®ue
);

281 ià(
	`¡¾’
(
buf
è!ğ
Ën
 || 
	`memcmp
(buf,
s
,len))  0;

283  
	`rdbEncodeIÁeg”
(
v®ue
,
’c
);

284 
	}
}

286 
ssize_t
 
	$rdbSaveLzfBlob
(
rio
 *
rdb
, *
d©a
, 
size_t
 
com´ess_Ën
,

287 
size_t
 
Üigš®_Ën
) {

288 
by‹
;

289 
ssize_t
 
n
, 
nwr™‹n
 = 0;

292 
by‹
 = (
RDB_ENCVAL
<<6)|
RDB_ENC_LZF
;

293 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,&
by‹
,1)è=ğ-1è
wr™“¼
;

294 
nwr™‹n
 +ğ
n
;

296 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
com´ess_Ën
)è=ğ-1è
wr™“¼
;

297 
nwr™‹n
 +ğ
n
;

299 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
Üigš®_Ën
)è=ğ-1è
wr™“¼
;

300 
nwr™‹n
 +ğ
n
;

302 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,
d©a
,
com´ess_Ën
)è=ğ-1è
wr™“¼
;

303 
nwr™‹n
 +ğ
n
;

305  
nwr™‹n
;

307 
wr™“¼
:

309 
	}
}

311 
ssize_t
 
	$rdbSaveLzfSŒšgObjeù
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
) {

312 
size_t
 
com´Ën
, 
ou’
;

313 *
out
;

316 ià(
Ën
 <= 4)  0;

317 
ou’
 = 
Ën
-4;

318 ià((
out
 = 
	`zm®loc
(
ou’
+1)è=ğ
NULL
)  0;

319 
com´Ën
 = 
	`lzf_com´ess
(
s
, 
Ën
, 
out
, 
ou’
);

320 ià(
com´Ën
 == 0) {

321 
	`zä“
(
out
);

324 
ssize_t
 
nwr™‹n
 = 
	`rdbSaveLzfBlob
(
rdb
, 
out
, 
com´Ën
, 
Ën
);

325 
	`zä“
(
out
);

326  
nwr™‹n
;

327 
	}
}

332 *
	$rdbLßdLzfSŒšgObjeù
(
rio
 *
rdb
, 
æags
, 
size_t
 *
ËÅŒ
) {

333 
¶aš
 = 
æags
 & 
RDB_LOAD_PLAIN
;

334 
sds
 = 
æags
 & 
RDB_LOAD_SDS
;

335 
ušt64_t
 
Ën
, 
ş’
;

336 *
c
 = 
NULL
;

337 *
v®
 = 
NULL
;

339 ià((
ş’
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

340 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

341 ià((
c
 = 
	`zm®loc
(
ş’
)è=ğ
NULL
è
”r
;

344 ià(
¶aš
) {

345 
v®
 = 
	`zm®loc
(
Ën
);

346 ià(
ËÅŒ
è*ËÅŒ = 
Ën
;

348 
v®
 = 
	`sd¢ewËn
(
NULL
,
Ën
);

352 ià(
	`rioR—d
(
rdb
,
c
,
ş’
è=ğ0è
”r
;

353 ià(
	`lzf_decom´ess
(
c
,
ş’
,
v®
,
Ën
) == 0) {

354 ià(
rdbCheckMode
è
	`rdbCheckS‘E¼Ü
("Invalid LZF compressed string");

355 
”r
;

357 
	`zä“
(
c
);

359 ià(
¶aš
 || 
sds
) {

360  
v®
;

362  
	`ü—‹Objeù
(
OBJ_STRING
,
v®
);

364 
”r
:

365 
	`zä“
(
c
);

366 ià(
¶aš
)

367 
	`zä“
(
v®
);

369 
	`sdsä“
(
v®
);

370  
NULL
;

371 
	}
}

375 
ssize_t
 
	$rdbSaveRawSŒšg
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
) {

376 
’ş’
;

377 
ssize_t
 
n
, 
nwr™‹n
 = 0;

380 ià(
Ën
 <= 11) {

381 
buf
[5];

382 ià((
’ş’
 = 
	`rdbTryIÁeg”Encodšg
((*)
s
,
Ën
,
buf
)) > 0) {

383 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
) == -1)  -1;

384  
’ş’
;

390 ià(
£rv”
.
rdb_com´essiÚ
 && 
Ën
 > 20) {

391 
n
 = 
	`rdbSaveLzfSŒšgObjeù
(
rdb
,
s
,
Ën
);

392 ià(
n
 == -1)  -1;

393 ià(
n
 > 0) ‚;

398 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
Ën
)) == -1)  -1;

399 
nwr™‹n
 +ğ
n
;

400 ià(
Ën
 > 0) {

401 ià(
	`rdbWr™eRaw
(
rdb
,
s
,
Ën
) == -1)  -1;

402 
nwr™‹n
 +ğ
Ën
;

404  
nwr™‹n
;

405 
	}
}

408 
ssize_t
 
	$rdbSaveLÚgLÚgAsSŒšgObjeù
(
rio
 *
rdb
, 
v®ue
) {

409 
buf
[32];

410 
ssize_t
 
n
, 
nwr™‹n
 = 0;

411 
’ş’
 = 
	`rdbEncodeIÁeg”
(
v®ue
,
buf
);

412 ià(
’ş’
 > 0) {

413  
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
);

416 
’ş’
 = 
	`Î2¡ršg
((*)
buf
,32,
v®ue
);

417 
	`£rv”As£¹
(
’ş’
 < 32);

418 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
’ş’
)) == -1)  -1;

419 
nwr™‹n
 +ğ
n
;

420 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
)) == -1)  -1;

421 
nwr™‹n
 +ğ
n
;

423  
nwr™‹n
;

424 
	}
}

427 
	$rdbSaveSŒšgObjeù
(
rio
 *
rdb
, 
robj
 *
obj
) {

430 ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

431  
	`rdbSaveLÚgLÚgAsSŒšgObjeù
(
rdb
,()
obj
->
±r
);

433 
	`£rv”As£¹W™hInfo
(
NULL
,
obj
,
	`sdsEncodedObjeù
(obj));

434  
	`rdbSaveRawSŒšg
(
rdb
,
obj
->
±r
,
	`sd¦’
(obj->ptr));

436 
	}
}

451 *
	$rdbG’”icLßdSŒšgObjeù
(
rio
 *
rdb
, 
æags
, 
size_t
 *
ËÅŒ
) {

452 
’code
 = 
æags
 & 
RDB_LOAD_ENC
;

453 
¶aš
 = 
æags
 & 
RDB_LOAD_PLAIN
;

454 
sds
 = 
æags
 & 
RDB_LOAD_SDS
;

455 
i£ncoded
;

456 
ušt64_t
 
Ën
;

458 
Ën
 = 
	`rdbLßdL’
(
rdb
,&
i£ncoded
);

459 ià(
i£ncoded
) {

460 
Ën
) {

461 
RDB_ENC_INT8
:

462 
RDB_ENC_INT16
:

463 
RDB_ENC_INT32
:

464  
	`rdbLßdIÁeg”Objeù
(
rdb
,
Ën
,
æags
,
ËÅŒ
);

465 
RDB_ENC_LZF
:

466  
	`rdbLßdLzfSŒšgObjeù
(
rdb
,
æags
,
ËÅŒ
);

468 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDB sŒšgƒncodšgy³ %d",
Ën
);

472 ià(
Ën
 =ğ
RDB_LENERR
è 
NULL
;

473 ià(
¶aš
 || 
sds
) {

474 *
buf
 = 
¶aš
 ? 
	`zm®loc
(
Ën
è: 
	`sd¢ewËn
(
NULL
,len);

475 ià(
ËÅŒ
è*ËÅŒ = 
Ën
;

476 ià(
Ën
 && 
	`rioR—d
(
rdb
,
buf
,len) == 0) {

477 ià(
¶aš
)

478 
	`zä“
(
buf
);

480 
	`sdsä“
(
buf
);

481  
NULL
;

483  
buf
;

485 
robj
 *
o
 = 
’code
 ? 
	`ü—‹SŒšgObjeù
(
NULL
,
Ën
) :

486 
	`ü—‹RawSŒšgObjeù
(
NULL
,
Ën
);

487 ià(
Ën
 && 
	`rioR—d
(
rdb
,
o
->
±r
,len) == 0) {

488 
	`deüRefCouÁ
(
o
);

489  
NULL
;

491  
o
;

493 
	}
}

495 
robj
 *
	$rdbLßdSŒšgObjeù
(
rio
 *
rdb
) {

496  
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_NONE
,
NULL
);

497 
	}
}

499 
robj
 *
	$rdbLßdEncodedSŒšgObjeù
(
rio
 *
rdb
) {

500  
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_ENC
,
NULL
);

501 
	}
}

511 
	$rdbSaveDoubËV®ue
(
rio
 *
rdb
, 
v®
) {

512 
buf
[128];

513 
Ën
;

515 ià(
	`i¢ª
(
v®
)) {

516 
buf
[0] = 253;

517 
Ën
 = 1;

518 } ià(!
	`isfš™e
(
v®
)) {

519 
Ën
 = 1;

520 
buf
[0] = (
v®
 < 0) ? 255 : 254;

522 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

532 
mš
 = -4503599627370495;

533 
max
 = 4503599627370496;

534 ià(
v®
 > 
mš
 && v® < 
max
 && val == (()(()val)))

535 
	`Î2¡ršg
((*)
buf
+1,(buf)-1,()
v®
);

538 
	`¢´štf
((*)
buf
+1,(buf)-1,"%.17g",
v®
);

539 
buf
[0] = 
	`¡¾’
((*)buf+1);

540 
Ën
 = 
buf
[0]+1;

542  
	`rdbWr™eRaw
(
rdb
,
buf
,
Ën
);

543 
	}
}

546 
	$rdbLßdDoubËV®ue
(
rio
 *
rdb
, *
v®
) {

547 
buf
[256];

548 
Ën
;

550 ià(
	`rioR—d
(
rdb
,&
Ën
,1) == 0)  -1;

551 
Ën
) {

552 255: *
v®
 = 
R_NegInf
;  0;

553 254: *
v®
 = 
R_PosInf
;  0;

554 253: *
v®
 = 
R_Nª
;  0;

556 ià(
	`rioR—d
(
rdb
,
buf
,
Ën
) == 0)  -1;

557 
buf
[
Ën
] = '\0';

558 
	`ssÿnf
(
buf
, "%lg", 
v®
);

561 
	}
}

568 
	$rdbSaveBš¬yDoubËV®ue
(
rio
 *
rdb
, 
v®
) {

569 
	`mem»v64ifbe
(&
v®
);

570  
	`rdbWr™eRaw
(
rdb
,&
v®
,8);

571 
	}
}

575 
	$rdbLßdBš¬yDoubËV®ue
(
rio
 *
rdb
, *
v®
) {

576 ià(
	`rioR—d
(
rdb
,
v®
,8) == 0)  -1;

577 
	`mem»v64ifbe
(
v®
);

579 
	}
}

582 
	$rdbSaveObjeùTy³
(
rio
 *
rdb
, 
robj
 *
o
) {

583 
o
->
ty³
) {

584 
OBJ_STRING
:

585  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_STRING
);

586 
OBJ_LIST
:

587 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
)

588  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_LIST_QUICKLIST
);

590 
	`£rv”Pªic
("Unknown†istƒncoding");

591 
OBJ_SET
:

592 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

593  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_SET_INTSET
);

594 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

595  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_SET
);

597 
	`£rv”Pªic
("Unknown setƒncoding");

598 
OBJ_ZSET
:

599 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
)

600  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_ZSET_ZIPLIST
);

601 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
)

602  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_ZSET_2
);

604 
	`£rv”Pªic
("Unknown sorted setƒncoding");

605 
OBJ_HASH
:

606 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
)

607  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_HASH_ZIPLIST
);

608 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

609  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_HASH
);

611 
	`£rv”Pªic
("Unknown hashƒncoding");

612 
OBJ_MODULE
:

613  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_MODULE
);

615 
	`£rv”Pªic
("Unknown objectype");

618 
	}
}

622 
	$rdbLßdObjeùTy³
(
rio
 *
rdb
) {

623 
ty³
;

624 ià((
ty³
 = 
	`rdbLßdTy³
(
rdb
)) == -1)  -1;

625 ià(!
	`rdbIsObjeùTy³
(
ty³
))  -1;

626  
ty³
;

627 
	}
}

630 
ssize_t
 
	$rdbSaveObjeù
(
rio
 *
rdb
, 
robj
 *
o
) {

631 
ssize_t
 
n
 = 0, 
nwr™‹n
 = 0;

633 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

635 ià((
n
 = 
	`rdbSaveSŒšgObjeù
(
rdb
,
o
)) == -1)  -1;

636 
nwr™‹n
 +ğ
n
;

637 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

639 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

640 
quickli¡
 *
ql
 = 
o
->
±r
;

641 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

643 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
ql
->
Ën
)) == -1)  -1;

644 
nwr™‹n
 +ğ
n
;

647 ià(
	`quickli¡NodeIsCom´es£d
(
node
)) {

648 *
d©a
;

649 
size_t
 
com´ess_Ën
 = 
	`quickli¡G‘Lzf
(
node
, &
d©a
);

650 ià((
n
 = 
	`rdbSaveLzfBlob
(
rdb
,
d©a
,
com´ess_Ën
,
node
->
sz
)) == -1)  -1;

651 
nwr™‹n
 +ğ
n
;

653 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
node
->
zl
,node->
sz
)) == -1)  -1;

654 
nwr™‹n
 +ğ
n
;

656 } (
node
 =‚ode->
Ãxt
));

658 
	`£rv”Pªic
("Unknown†istƒncoding");

660 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

662 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

663 
diù
 *
£t
 = 
o
->
±r
;

664 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
£t
);

665 
diùEÁry
 *
de
;

667 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`diùSize
(
£t
))) == -1)  -1;

668 
nwr™‹n
 +ğ
n
;

670 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

671 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

672 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,(*)
–e
,
	`sd¦’
(ele)))

674 
nwr™‹n
 +ğ
n
;

676 
	`diùR–—£I‹¿tÜ
(
di
);

677 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

678 
size_t
 
l
 = 
	`št£tBlobL’
((
št£t
*)
o
->
±r
);

680 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

681 
nwr™‹n
 +ğ
n
;

683 
	`£rv”Pªic
("Unknown setƒncoding");

685 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

687 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

688 
size_t
 
l
 = 
	`zli¡BlobL’
((*)
o
->
±r
);

690 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

691 
nwr™‹n
 +ğ
n
;

692 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

693 
z£t
 *
zs
 = 
o
->
±r
;

694 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
zs
->
diù
);

695 
diùEÁry
 *
de
;

697 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`diùSize
(
zs
->
diù
))) == -1)  -1;

698 
nwr™‹n
 +ğ
n
;

700 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

701 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

702 *
scÜe
 = 
	`diùG‘V®
(
de
);

704 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,(*)
–e
,
	`sd¦’
(ele)))

706 
nwr™‹n
 +ğ
n
;

707 ià((
n
 = 
	`rdbSaveBš¬yDoubËV®ue
(
rdb
,*
scÜe
)) == -1)  -1;

708 
nwr™‹n
 +ğ
n
;

710 
	`diùR–—£I‹¿tÜ
(
di
);

712 
	`£rv”Pªic
("Unknown sorted setƒncoding");

714 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

716 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

717 
size_t
 
l
 = 
	`zli¡BlobL’
((*)
o
->
±r
);

719 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

720 
nwr™‹n
 +ğ
n
;

722 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

723 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
o
->
±r
);

724 
diùEÁry
 *
de
;

726 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`diùSize
((
diù
*)
o
->
±r
))) == -1)  -1;

727 
nwr™‹n
 +ğ
n
;

729 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

730 
sds
 
f›ld
 = 
	`diùG‘Key
(
de
);

731 
sds
 
v®ue
 = 
	`diùG‘V®
(
de
);

733 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,(*)
f›ld
,

734 
	`sd¦’
(
f›ld
))) == -1)  -1;

735 
nwr™‹n
 +ğ
n
;

736 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,(*)
v®ue
,

737 
	`sd¦’
(
v®ue
))) == -1)  -1;

738 
nwr™‹n
 +ğ
n
;

740 
	`diùR–—£I‹¿tÜ
(
di
);

742 
	`£rv”Pªic
("Unknown hashƒncoding");

745 } ià(
o
->
ty³
 =ğ
OBJ_MODULE
) {

747 
RedisModuËIO
 
io
;

748 
moduËV®ue
 *
mv
 = 
o
->
±r
;

749 
moduËTy³
 *
mt
 = 
mv
->
ty³
;

750 
	`moduËIn™IOCÚ‹xt
(
io
,
mt
,
rdb
);

754 
»tv®
 = 
	`rdbSaveL’
(
rdb
,
mt
->
id
);

755 ià(
»tv®
 == -1)  -1;

756 
io
.
by‹s
 +ğ
»tv®
;

759 
mt
->
	`rdb_§ve
(&
io
,
mv
->
v®ue
);

760  
io
.
”rÜ
 ? -1 : (
ssize_t
)io.
by‹s
;

762 
	`£rv”Pªic
("Unknown objectype");

764  
nwr™‹n
;

765 
	}
}

771 
size_t
 
	$rdbSavedObjeùL’
(
robj
 *
o
) {

772 
ssize_t
 
Ën
 = 
	`rdbSaveObjeù
(
NULL
,
o
);

773 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,
Ën
 != -1);

774  
Ën
;

775 
	}
}

781 
	$rdbSaveKeyV®uePaœ
(
rio
 *
rdb
, 
robj
 *
key
,„obj *
v®
,

782 
expœ‘ime
, 
now
)

785 ià(
expœ‘ime
 != -1) {

787 ià(
expœ‘ime
 < 
now
)  0;

788 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_EXPIRETIME_MS
) == -1)  -1;

789 ià(
	`rdbSaveMli£cÚdTime
(
rdb
,
expœ‘ime
) == -1)  -1;

793 ià(
	`rdbSaveObjeùTy³
(
rdb
,
v®
) == -1)  -1;

794 ià(
	`rdbSaveSŒšgObjeù
(
rdb
,
key
) == -1)  -1;

795 ià(
	`rdbSaveObjeù
(
rdb
,
v®
) == -1)  -1;

797 
	}
}

800 
	$rdbSaveAuxF›ld
(
rio
 *
rdb
, *
key
, 
size_t
 
keyËn
, *
v®
, size_ˆ
v®Ën
) {

801 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_AUX
) == -1)  -1;

802 ià(
	`rdbSaveRawSŒšg
(
rdb
,
key
,
keyËn
) == -1)  -1;

803 ià(
	`rdbSaveRawSŒšg
(
rdb
,
v®
,
v®Ën
) == -1)  -1;

805 
	}
}

809 
	$rdbSaveAuxF›ldSŒSŒ
(
rio
 *
rdb
, *
key
, *
v®
) {

810  
	`rdbSaveAuxF›ld
(
rdb
,
key
,
	`¡¾’
(key),
v®
,strlen(val));

811 
	}
}

814 
	$rdbSaveAuxF›ldSŒIÁ
(
rio
 *
rdb
, *
key
, 
v®
) {

815 
buf
[
LONG_STR_SIZE
];

816 
vËn
 = 
	`Î2¡ršg
(
buf
,(buf),
v®
);

817  
	`rdbSaveAuxF›ld
(
rdb
,
key
,
	`¡¾’
(key),
buf
,
vËn
);

818 
	}
}

821 
	$rdbSaveInfoAuxF›lds
(
rio
 *
rdb
) {

822 
»dis_b™s
 = ((*) == 8) ? 64 : 32;

825 ià(
	`rdbSaveAuxF›ldSŒSŒ
(
rdb
,"»dis-v”",
REDIS_VERSION
) == -1)  -1;

826 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"»dis-b™s",
»dis_b™s
) == -1)  -1;

827 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"ùime",
	`time
(
NULL
)) == -1)  -1;

828 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"u£d-mem",
	`zm®loc_u£d_memÜy
()) == -1)  -1;

830 
	}
}

840 
	$rdbSaveRio
(
rio
 *
rdb
, *
”rÜ
) {

841 
diùI‹¿tÜ
 *
di
 = 
NULL
;

842 
diùEÁry
 *
de
;

843 
magic
[10];

844 
j
;

845 
now
 = 
	`m¡ime
();

846 
ušt64_t
 
cksum
;

848 ià(
£rv”
.
rdb_checksum
)

849 
rdb
->
upd©e_cksum
 = 
rioG’”icUpd©eChecksum
;

850 
	`¢´štf
(
magic
,(magic),"REDIS%04d",
RDB_VERSION
);

851 ià(
	`rdbWr™eRaw
(
rdb
,
magic
,9è=ğ-1è
w”r
;

852 ià(
	`rdbSaveInfoAuxF›lds
(
rdb
è=ğ-1è
w”r
;

854 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

855 
»disDb
 *
db
 = 
£rv”
.db+
j
;

856 
diù
 *
d
 = 
db
->dict;

857 ià(
	`diùSize
(
d
) == 0) ;

858 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
d
);

859 ià(!
di
è 
C_ERR
;

862 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_SELECTDB
è=ğ-1è
w”r
;

863 ià(
	`rdbSaveL’
(
rdb
,
j
è=ğ-1è
w”r
;

869 
ušt32_t
 
db_size
, 
expœes_size
;

870 
db_size
 = (
	`diùSize
(
db
->
diù
è<ğ
UINT32_MAX
) ?

871 
	`diùSize
(
db
->
diù
) :

872 
UINT32_MAX
;

873 
expœes_size
 = (
	`diùSize
(
db
->
expœes
è<ğ
UINT32_MAX
) ?

874 
	`diùSize
(
db
->
expœes
) :

875 
UINT32_MAX
;

876 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_RESIZEDB
è=ğ-1è
w”r
;

877 ià(
	`rdbSaveL’
(
rdb
,
db_size
è=ğ-1è
w”r
;

878 ià(
	`rdbSaveL’
(
rdb
,
expœes_size
è=ğ-1è
w”r
;

881 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

882 
sds
 
key¡r
 = 
	`diùG‘Key
(
de
);

883 
robj
 
key
, *
o
 = 
	`diùG‘V®
(
de
);

884 
expœe
;

886 
	`š™SticSŒšgObjeù
(
key
,
key¡r
);

887 
expœe
 = 
	`g‘Expœe
(
db
,&
key
);

888 ià(
	`rdbSaveKeyV®uePaœ
(
rdb
,&
key
,
o
,
expœe
,
now
è=ğ-1è
w”r
;

890 
	`diùR–—£I‹¿tÜ
(
di
);

892 
di
 = 
NULL
;

895 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_EOF
è=ğ-1è
w”r
;

899 
cksum
 = 
rdb
->cksum;

900 
	`mem»v64ifbe
(&
cksum
);

901 ià(
	`rioWr™e
(
rdb
,&
cksum
,8è=ğ0è
w”r
;

902  
C_OK
;

904 
w”r
:

905 ià(
”rÜ
è*”rÜ = 
”ºo
;

906 ià(
di
è
	`diùR–—£I‹¿tÜ
(di);

907  
C_ERR
;

908 
	}
}

918 
	$rdbSaveRioW™hEOFM¬k
(
rio
 *
rdb
, *
”rÜ
) {

919 
eofm¬k
[
RDB_EOF_MARK_SIZE
];

921 
	`g‘RªdomHexCh¬s
(
eofm¬k
,
RDB_EOF_MARK_SIZE
);

922 ià(
”rÜ
) *error = 0;

923 ià(
	`rioWr™e
(
rdb
,"$EOF:",5è=ğ0è
w”r
;

924 ià(
	`rioWr™e
(
rdb
,
eofm¬k
,
RDB_EOF_MARK_SIZE
è=ğ0è
w”r
;

925 ià(
	`rioWr™e
(
rdb
,"\r\n",2è=ğ0è
w”r
;

926 ià(
	`rdbSaveRio
(
rdb
,
”rÜ
è=ğ
C_ERR
è
w”r
;

927 ià(
	`rioWr™e
(
rdb
,
eofm¬k
,
RDB_EOF_MARK_SIZE
è=ğ0è
w”r
;

928  
C_OK
;

930 
w”r
:

932 ià(
”rÜ
 && *”rÜ =ğ0è*”rÜ = 
”ºo
;

933  
C_ERR
;

934 
	}
}

937 
	$rdbSave
(*
f’ame
) {

938 
tmpfe
[256];

939 
cwd
[
MAXPATHLEN
];

940 
FILE
 *
å
;

941 
rio
 
rdb
;

942 
”rÜ
 = 0;

944 
	`¢´štf
(
tmpfe
,256,"‹mp-%d.rdb", (è
	`g‘pid
());

945 
å
 = 
	`fİ’
(
tmpfe
,"w");

946 ià(!
å
) {

947 *
cwdp
 = 
	`g‘cwd
(
cwd
,
MAXPATHLEN
);

948 
	`£rv”Log
(
LL_WARNING
,

951 
f’ame
,

952 
cwdp
 ? cwdp : "unknown",

953 
	`¡»¼Ü
(
”ºo
));

954  
C_ERR
;

957 
	`rioIn™W™hFe
(&
rdb
,
å
);

958 ià(
	`rdbSaveRio
(&
rdb
,&
”rÜ
è=ğ
C_ERR
) {

959 
”ºo
 = 
”rÜ
;

960 
w”r
;

964 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

965 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

966 ià(
	`fşo£
(
å
è=ğ
EOF
è
w”r
;

970 ià(
	`»Çme
(
tmpfe
,
f’ame
) == -1) {

971 *
cwdp
 = 
	`g‘cwd
(
cwd
,
MAXPATHLEN
);

972 
	`£rv”Log
(
LL_WARNING
,

975 
tmpfe
,

976 
f’ame
,

977 
cwdp
 ? cwdp : "unknown",

978 
	`¡»¼Ü
(
”ºo
));

979 
	`uÆšk
(
tmpfe
);

980  
C_ERR
;

983 
	`£rv”Log
(
LL_NOTICE
,"DB saved on disk");

984 
£rv”
.
dœty
 = 0;

985 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

986 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_OK
;

987  
C_OK
;

989 
w”r
:

990 
	`£rv”Log
(
LL_WARNING
,"Wr™”rÜ savšg DB oÀdisk: %s", 
	`¡»¼Ü
(
”ºo
));

991 
	`fşo£
(
å
);

992 
	`uÆšk
(
tmpfe
);

993  
C_ERR
;

994 
	}
}

996 
	$rdbSaveBackground
(*
f’ame
) {

997 
pid_t
 
chdpid
;

998 
¡¬t
;

1000 ià(
£rv”
.
rdb_chd_pid
 !ğ-1è 
C_ERR
;

1002 
£rv”
.
dœty_befÜe_bg§ve
 = s”v”.
dœty
;

1003 
£rv”
.
Ï¡bg§ve_Œy
 = 
	`time
(
NULL
);

1005 
¡¬t
 = 
	`u¡ime
();

1006 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1007 
»tv®
;

1010 
	`şo£Li¡’šgSock‘s
(0);

1011 
	`»disS‘ProcT™Ë
("redis-rdb-bgsave");

1012 
»tv®
 = 
	`rdbSave
(
f’ame
);

1013 ià(
»tv®
 =ğ
C_OK
) {

1014 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
();

1016 ià(
´iv©e_dœty
) {

1017 
	`£rv”Log
(
LL_NOTICE
,

1019 
´iv©e_dœty
/(1024*1024));

1022 
	`ex™FromChd
((
»tv®
 =ğ
C_OK
) ? 0 : 1);

1025 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1026 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1027 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1028 ià(
chdpid
 == -1) {

1029 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_ERR
;

1030 
	`£rv”Log
(
LL_WARNING
,"Can't save in background: fork: %s",

1031 
	`¡»¼Ü
(
”ºo
));

1032  
C_ERR
;

1034 
	`£rv”Log
(
LL_NOTICE
,"Background savšg s¹ed by…id %d",
chdpid
);

1035 
£rv”
.
rdb_§ve_time_¡¬t
 = 
	`time
(
NULL
);

1036 
£rv”
.
rdb_chd_pid
 = 
chdpid
;

1037 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_DISK
;

1038 
	`upd©eDiùResizePŞicy
();

1039  
C_OK
;

1041  
C_OK
;

1042 
	}
}

1044 
	$rdbRemoveTempFe
(
pid_t
 
chdpid
) {

1045 
tmpfe
[256];

1047 
	`¢´štf
(
tmpfe
,Ñmpfe),"‹mp-%d.rdb", (è
chdpid
);

1048 
	`uÆšk
(
tmpfe
);

1049 
	}
}

1053 
robj
 *
	$rdbLßdObjeù
(
rdbty³
, 
rio
 *
rdb
) {

1054 
robj
 *
o
 = 
NULL
, *
–e
, *
dec
;

1055 
size_t
 
Ën
;

1056 
i
;

1058 ià(
rdbty³
 =ğ
RDB_TYPE_STRING
) {

1060 ià((
o
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
)è=ğ
NULL
)  NULL;

1061 
o
 = 
	`ŒyObjeùEncodšg
(o);

1062 } ià(
rdbty³
 =ğ
RDB_TYPE_LIST
) {

1064 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1066 
o
 = 
	`ü—‹Quickli¡Objeù
();

1067 
	`quickli¡S‘O±iÚs
(
o
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

1068 
£rv”
.
li¡_com´ess_d•th
);

1071 
Ën
--) {

1072 ià((
–e
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
)è=ğ
NULL
)  NULL;

1073 
dec
 = 
	`g‘DecodedObjeù
(
–e
);

1074 
size_t
 
Ën
 = 
	`sd¦’
(
dec
->
±r
);

1075 
	`quickli¡PushTa
(
o
->
±r
, 
dec
->±r, 
Ën
);

1076 
	`deüRefCouÁ
(
dec
);

1077 
	`deüRefCouÁ
(
–e
);

1079 } ià(
rdbty³
 =ğ
RDB_TYPE_SET
) {

1081 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1084 ià(
Ën
 > 
£rv”
.
£t_max_št£t_’Œ›s
) {

1085 
o
 = 
	`ü—‹S‘Objeù
();

1088 ià(
Ën
 > 
DICT_HT_INITIAL_SIZE
)

1089 
	`diùEx·nd
(
o
->
±r
,
Ën
);

1091 
o
 = 
	`ü—‹IÁ£tObjeù
();

1095 
i
 = 0; i < 
Ën
; i++) {

1096 
Îv®
;

1097 
sds
 
sd£Ë
;

1099 ià((
sd£Ë
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1100 =ğ
NULL
)  NULL;

1102 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1104 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
sd£Ë
,&
Îv®
è=ğ
C_OK
) {

1105 
o
->
±r
 = 
	`št£tAdd
(o->±r,
Îv®
,
NULL
);

1107 
	`£tTy³CÚv”t
(
o
,
OBJ_ENCODING_HT
);

1108 
	`diùEx·nd
(
o
->
±r
,
Ën
);

1114 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1115 
	`diùAdd
((
diù
*)
o
->
±r
,
sd£Ë
,
NULL
);

1117 
	`sdsä“
(
sd£Ë
);

1120 } ià(
rdbty³
 =ğ
RDB_TYPE_ZSET_2
 ||„dbty³ =ğ
RDB_TYPE_ZSET
) {

1122 
size_t
 
z£’
;

1123 
size_t
 
max––’
 = 0;

1124 
z£t
 *
zs
;

1126 ià((
z£’
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1127 
o
 = 
	`ü—‹Z£tObjeù
();

1128 
zs
 = 
o
->
±r
;

1131 
z£’
--) {

1132 
sds
 
sd£Ë
;

1133 
scÜe
;

1134 
zskli¡Node
 *
znode
;

1136 ià((
sd£Ë
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1137 =ğ
NULL
)  NULL;

1139 ià(
rdbty³
 =ğ
RDB_TYPE_ZSET_2
) {

1140 ià(
	`rdbLßdBš¬yDoubËV®ue
(
rdb
,&
scÜe
è=ğ-1è 
NULL
;

1142 ià(
	`rdbLßdDoubËV®ue
(
rdb
,&
scÜe
è=ğ-1è 
NULL
;

1146 ià(
	`sd¦’
(
sd£Ë
è> 
max––’
) maxelelen = sdslen(sdsele);

1148 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
sd£Ë
);

1149 
	`diùAdd
(
zs
->
diù
,
sd£Ë
,&
znode
->
scÜe
);

1153 ià(
	`z£tL’gth
(
o
è<ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

1154 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

1155 
	`z£tCÚv”t
(
o
,
OBJ_ENCODING_ZIPLIST
);

1156 } ià(
rdbty³
 =ğ
RDB_TYPE_HASH
) {

1157 
size_t
 
Ën
;

1158 
»t
;

1159 
sds
 
f›ld
, 
v®ue
;

1161 
Ën
 = 
	`rdbLßdL’
(
rdb
, 
NULL
);

1162 ià(
Ën
 =ğ
RDB_LENERR
è 
NULL
;

1164 
o
 = 
	`ü—‹HashObjeù
();

1167 ià(
Ën
 > 
£rv”
.
hash_max_zli¡_’Œ›s
)

1168 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1171 
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
 && 
Ën
 > 0) {

1172 
Ën
--;

1174 ià((
f›ld
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1175 =ğ
NULL
)  NULL;

1176 ià((
v®ue
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1177 =ğ
NULL
)  NULL;

1180 
o
->
±r
 = 
	`zli¡Push
(o->±r, (*)
f›ld
,

1181 
	`sd¦’
(
f›ld
), 
ZIPLIST_TAIL
);

1182 
o
->
±r
 = 
	`zli¡Push
(o->±r, (*)
v®ue
,

1183 
	`sd¦’
(
v®ue
), 
ZIPLIST_TAIL
);

1186 ià(
	`sd¦’
(
f›ld
è> 
£rv”
.
hash_max_zli¡_v®ue
 ||

1187 
	`sd¦’
(
v®ue
è> 
£rv”
.
hash_max_zli¡_v®ue
)

1189 
	`sdsä“
(
f›ld
);

1190 
	`sdsä“
(
v®ue
);

1191 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1194 
	`sdsä“
(
f›ld
);

1195 
	`sdsä“
(
v®ue
);

1199 
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
 && 
Ën
 > 0) {

1200 
Ën
--;

1202 ià((
f›ld
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1203 =ğ
NULL
)  NULL;

1204 ià((
v®ue
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1205 =ğ
NULL
)  NULL;

1208 
»t
 = 
	`diùAdd
((
diù
*)
o
->
±r
, 
f›ld
, 
v®ue
);

1209 ià(
»t
 =ğ
DICT_ERR
) {

1210 
	`rdbEx™R•ÜtCÜru±RDB
("Duplicate keys detected");

1215 
	`£rv”As£¹
(
Ën
 == 0);

1216 } ià(
rdbty³
 =ğ
RDB_TYPE_LIST_QUICKLIST
) {

1217 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1218 
o
 = 
	`ü—‹Quickli¡Objeù
();

1219 
	`quickli¡S‘O±iÚs
(
o
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

1220 
£rv”
.
li¡_com´ess_d•th
);

1222 
Ën
--) {

1223 *
zl
 =

1224 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_PLAIN
,
NULL
);

1225 ià(
zl
 =ğ
NULL
)  NULL;

1226 
	`quickli¡Aµ’dZli¡
(
o
->
±r
, 
zl
);

1228 } ià(
rdbty³
 =ğ
RDB_TYPE_HASH_ZIPMAP
 ||

1229 
rdbty³
 =ğ
RDB_TYPE_LIST_ZIPLIST
 ||

1230 
rdbty³
 =ğ
RDB_TYPE_SET_INTSET
 ||

1231 
rdbty³
 =ğ
RDB_TYPE_ZSET_ZIPLIST
 ||

1232 
rdbty³
 =ğ
RDB_TYPE_HASH_ZIPLIST
)

1234 *
’coded
 =

1235 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_PLAIN
,
NULL
);

1236 ià(
’coded
 =ğ
NULL
)  NULL;

1237 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
’coded
);

1245 
rdbty³
) {

1246 
RDB_TYPE_HASH_ZIPMAP
:

1250 *
zl
 = 
	`zli¡New
();

1251 *
zi
 = 
	`zm­Rewšd
(
o
->
±r
);

1252 *
f¡r
, *
v¡r
;

1253 
æ’
, 
vËn
;

1254 
maxËn
 = 0;

1256 (
zi
 = 
	`zm­Next
(zi, &
f¡r
, &
æ’
, &
v¡r
, &
vËn
)è!ğ
NULL
) {

1257 ià(
æ’
 > 
maxËn
) maxlen = flen;

1258 ià(
vËn
 > 
maxËn
) maxlen = vlen;

1259 
zl
 = 
	`zli¡Push
(zl, 
f¡r
, 
æ’
, 
ZIPLIST_TAIL
);

1260 
zl
 = 
	`zli¡Push
(zl, 
v¡r
, 
vËn
, 
ZIPLIST_TAIL
);

1263 
	`zä“
(
o
->
±r
);

1264 
o
->
±r
 = 
zl
;

1265 
o
->
ty³
 = 
OBJ_HASH
;

1266 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1268 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
 ||

1269 
maxËn
 > 
£rv”
.
hash_max_zli¡_v®ue
)

1271 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1275 
RDB_TYPE_LIST_ZIPLIST
:

1276 
o
->
ty³
 = 
OBJ_LIST
;

1277 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1278 
	`li¡Ty³CÚv”t
(
o
,
OBJ_ENCODING_QUICKLIST
);

1280 
RDB_TYPE_SET_INTSET
:

1281 
o
->
ty³
 = 
OBJ_SET
;

1282 
o
->
’codšg
 = 
OBJ_ENCODING_INTSET
;

1283 ià(
	`št£tL’
(
o
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

1284 
	`£tTy³CÚv”t
(
o
,
OBJ_ENCODING_HT
);

1286 
RDB_TYPE_ZSET_ZIPLIST
:

1287 
o
->
ty³
 = 
OBJ_ZSET
;

1288 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1289 ià(
	`z£tL’gth
(
o
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1290 
	`z£tCÚv”t
(
o
,
OBJ_ENCODING_SKIPLIST
);

1292 
RDB_TYPE_HASH_ZIPLIST
:

1293 
o
->
ty³
 = 
OBJ_HASH
;

1294 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1295 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

1296 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1299 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDBƒncodšgy³ %d",
rdbty³
);

1302 } ià(
rdbty³
 =ğ
RDB_TYPE_MODULE
) {

1303 
ušt64_t
 
moduËid
 = 
	`rdbLßdL’
(
rdb
,
NULL
);

1304 
moduËTy³
 *
mt
 = 
	`moduËTy³LookupModuËByID
(
moduËid
);

1305 
Çme
[10];

1307 ià(
mt
 =ğ
NULL
) {

1308 
	`moduËTy³NameByID
(
Çme
,
moduËid
);

1309 
	`£rv”Log
(
LL_WARNING
,"ThRDB fcÚš moduË d©¨I cª'ˆlßd:‚Øm©chšg moduË '%s'", 
Çme
);

1310 
	`ex™
(1);

1312 
RedisModuËIO
 
io
;

1313 
	`moduËIn™IOCÚ‹xt
(
io
,
mt
,
rdb
);

1316 *
±r
 = 
mt
->
	`rdb_lßd
(&
io
,
moduËid
&1023);

1317 ià(
±r
 =ğ
NULL
) {

1318 
	`moduËTy³NameByID
(
Çme
,
moduËid
);

1319 
	`£rv”Log
(
LL_WARNING
,"ThRDB fcÚš moduË d©¨fÜhmoduËy³ '%s',h©h»¥ÚsibË moduË i nÙ‡bËØlßd. Check fÜ moduË log‡bovfÜ‡dd™iÚ® clues.", 
Çme
);

1320 
	`ex™
(1);

1322 
o
 = 
	`ü—‹ModuËObjeù
(
mt
,
±r
);

1324 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDBƒncodšgy³ %d",
rdbty³
);

1326  
o
;

1327 
	}
}

1331 
	$¡¬tLßdšg
(
FILE
 *
å
) {

1332 
¡©
 
sb
;

1335 
£rv”
.
lßdšg
 = 1;

1336 
£rv”
.
lßdšg_¡¬t_time
 = 
	`time
(
NULL
);

1337 
£rv”
.
lßdšg_lßded_by‹s
 = 0;

1338 ià(
	`f¡©
(
	`f’o
(
å
), &
sb
) == -1) {

1339 
£rv”
.
lßdšg_tÙ®_by‹s
 = 0;

1341 
£rv”
.
lßdšg_tÙ®_by‹s
 = 
sb
.
¡_size
;

1343 
	}
}

1346 
	$lßdšgProg»ss
(
off_t
 
pos
) {

1347 
£rv”
.
lßdšg_lßded_by‹s
 = 
pos
;

1348 ià(
£rv”
.
¡©_³ak_memÜy
 < 
	`zm®loc_u£d_memÜy
())

1349 
£rv”
.
¡©_³ak_memÜy
 = 
	`zm®loc_u£d_memÜy
();

1350 
	}
}

1353 
	$¡İLßdšg
() {

1354 
£rv”
.
lßdšg
 = 0;

1355 
	}
}

1359 
	$rdbLßdProg»ssC®lback
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

1360 ià(
£rv”
.
rdb_checksum
)

1361 
	`rioG’”icUpd©eChecksum
(
r
, 
buf
, 
Ën
);

1362 ià(
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 &&

1363 (
r
->
´oûs£d_by‹s
 + 
Ën
)/
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 >„->processed_bytes/server.loading_process_events_interval_bytes)

1368 
	`upd©eCachedTime
();

1369 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
)

1370 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

1371 
	`lßdšgProg»ss
(
r
->
´oûs£d_by‹s
);

1372 
	`´oûssEv’tsWheBlocked
();

1374 
	}
}

1376 
	$rdbLßd
(*
f’ame
) {

1377 
ušt64_t
 
dbid
;

1378 
ty³
, 
rdbv”
;

1379 
»disDb
 *
db
 = 
£rv”
.db+0;

1380 
buf
[1024];

1381 
expœ‘ime
, 
now
 = 
	`m¡ime
();

1382 
FILE
 *
å
;

1383 
rio
 
rdb
;

1385 ià((
å
 = 
	`fİ’
(
f’ame
,"r")è=ğ
NULL
è 
C_ERR
;

1387 
	`rioIn™W™hFe
(&
rdb
,
å
);

1388 
rdb
.
upd©e_cksum
 = 
rdbLßdProg»ssC®lback
;

1389 
rdb
.
max_´oûssšg_chunk
 = 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

1390 ià(
	`rioR—d
(&
rdb
,
buf
,9è=ğ0è
eoã¼
;

1391 
buf
[9] = '\0';

1392 ià(
	`memcmp
(
buf
,"REDIS",5) != 0) {

1393 
	`fşo£
(
å
);

1394 
	`£rv”Log
(
LL_WARNING
,"Wrong signatureryingo†oad DB from file");

1395 
”ºo
 = 
EINVAL
;

1396  
C_ERR
;

1398 
rdbv”
 = 
	`©oi
(
buf
+5);

1399 ià(
rdbv”
 < 1 ||„dbv” > 
RDB_VERSION
) {

1400 
	`fşo£
(
å
);

1401 
	`£rv”Log
(
LL_WARNING
,"Cª'ˆhªdË RDB fÜm© v”siÚ %d",
rdbv”
);

1402 
”ºo
 = 
EINVAL
;

1403  
C_ERR
;

1406 
	`¡¬tLßdšg
(
å
);

1408 
robj
 *
key
, *
v®
;

1409 
expœ‘ime
 = -1;

1412 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

1415 ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME
) {

1419 ià((
expœ‘ime
 = 
	`rdbLßdTime
(&
rdb
)è=ğ-1è
eoã¼
;

1421 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

1424 
expœ‘ime
 *= 1000;

1425 } ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME_MS
) {

1428 ià((
expœ‘ime
 = 
	`rdbLßdMli£cÚdTime
(&
rdb
)è=ğ-1è
eoã¼
;

1430 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

1431 } ià(
ty³
 =ğ
RDB_OPCODE_EOF
) {

1434 } ià(
ty³
 =ğ
RDB_OPCODE_SELECTDB
) {

1436 ià((
dbid
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

1437 
eoã¼
;

1438 ià(
dbid
 >ğ()
£rv”
.
dbnum
) {

1439 
	`£rv”Log
(
LL_WARNING
,

1442 "d©aba£s. Ex™šg\n", 
£rv”
.
dbnum
);

1443 
	`ex™
(1);

1445 
db
 = 
£rv”
.db+
dbid
;

1447 } ià(
ty³
 =ğ
RDB_OPCODE_RESIZEDB
) {

1450 
ušt64_t
 
db_size
, 
expœes_size
;

1451 ià((
db_size
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

1452 
eoã¼
;

1453 ià((
expœes_size
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

1454 
eoã¼
;

1455 
	`diùEx·nd
(
db
->
diù
,
db_size
);

1456 
	`diùEx·nd
(
db
->
expœes
,
expœes_size
);

1458 } ià(
ty³
 =ğ
RDB_OPCODE_AUX
) {

1464 
robj
 *
auxkey
, *
auxv®
;

1465 ià((
auxkey
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

1466 ià((
auxv®
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

1468 ià(((*)
auxkey
->
±r
)[0] == '%') {

1472 
	`£rv”Log
(
LL_NOTICE
,"RDB '%s': %s",

1473 (*)
auxkey
->
±r
,

1474 (*)
auxv®
->
±r
);

1478 
	`£rv”Log
(
LL_DEBUG
,"Unrecognized RDB AUX field: '%s'",

1479 (*)
auxkey
->
±r
);

1482 
	`deüRefCouÁ
(
auxkey
);

1483 
	`deüRefCouÁ
(
auxv®
);

1488 ià((
key
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

1490 ià((
v®
 = 
	`rdbLßdObjeù
(
ty³
,&
rdb
)è=ğ
NULL
è
eoã¼
;

1496 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && 
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
) {

1497 
	`deüRefCouÁ
(
key
);

1498 
	`deüRefCouÁ
(
v®
);

1502 
	`dbAdd
(
db
,
key
,
v®
);

1505 ià(
expœ‘ime
 !ğ-1è
	`£tExpœe
(
db
,
key
,expiretime);

1507 
	`deüRefCouÁ
(
key
);

1510 ià(
rdbv”
 >ğ5 && 
£rv”
.
rdb_checksum
) {

1511 
ušt64_t
 
cksum
, 
ex³ùed
 = 
rdb
.cksum;

1513 ià(
	`rioR—d
(&
rdb
,&
cksum
,8è=ğ0è
eoã¼
;

1514 
	`mem»v64ifbe
(&
cksum
);

1515 ià(
cksum
 == 0) {

1516 
	`£rv”Log
(
LL_WARNING
,"RDB file was saved with checksum disabled:‚o check…erformed.");

1517 } ià(
cksum
 !ğ
ex³ùed
) {

1518 
	`£rv”Log
(
LL_WARNING
,"Wrong RDB checksum. Aborting‚ow.");

1519 
	`rdbEx™R•ÜtCÜru±RDB
("RDB CRCƒrror");

1523 
	`fşo£
(
å
);

1524 
	`¡İLßdšg
();

1525  
C_OK
;

1527 
eoã¼
:

1528 
	`£rv”Log
(
LL_WARNING
,"Short„ead or OOM†oading DB. Unrecoverableƒrror,‡borting‚ow.");

1529 
	`rdbEx™R•ÜtCÜru±RDB
("Unexpected EOF„eading RDB file");

1530  
C_ERR
;

1531 
	}
}

1535 
	$backgroundSaveDÚeHªdËrDisk
(
ex™code
, 
bysigÇl
) {

1536 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1537 
	`£rv”Log
(
LL_NOTICE
,

1539 
£rv”
.
dœty
 = s”v”.dœty - s”v”.
dœty_befÜe_bg§ve
;

1540 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

1541 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_OK
;

1542 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1543 
	`£rv”Log
(
LL_WARNING
, "Background savingƒrror");

1544 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_ERR
;

1546 
m¡ime_t
 
Ï‹ncy
;

1548 
	`£rv”Log
(
LL_WARNING
,

1549 "Background savšg”mš©ed by sigÇÈ%d", 
bysigÇl
);

1550 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1551 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

1552 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1553 
	`Ï‹ncyAddSam¶eIfN“ded
("rdb-uÆšk-‹mp-fe",
Ï‹ncy
);

1556 ià(
bysigÇl
 !ğ
SIGUSR1
)

1557 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_ERR
;

1559 
£rv”
.
rdb_chd_pid
 = -1;

1560 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_NONE
;

1561 
£rv”
.
rdb_§ve_time_Ï¡
 = 
	`time
(
NULL
)-£rv”.
rdb_§ve_time_¡¬t
;

1562 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1565 
	`upd©eSÏvesWa™šgBg§ve
((!
bysigÇl
 && 
ex™code
 =ğ0è? 
C_OK
 : 
C_ERR
, 
RDB_CHILD_TYPE_DISK
);

1566 
	}
}

1571 
	$backgroundSaveDÚeHªdËrSock‘
(
ex™code
, 
bysigÇl
) {

1572 
ušt64_t
 *
ok_¦aves
;

1574 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1575 
	`£rv”Log
(
LL_NOTICE
,

1577 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1578 
	`£rv”Log
(
LL_WARNING
, "Backgroundransferƒrror");

1580 
	`£rv”Log
(
LL_WARNING
,

1581 "Background¿nsã¸‹rmš©ed by sigÇÈ%d", 
bysigÇl
);

1583 
£rv”
.
rdb_chd_pid
 = -1;

1584 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_NONE
;

1585 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1594 
ok_¦aves
 = 
	`zm®loc
((
ušt64_t
));

1595 
ok_¦aves
[0] = 0;

1596 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1597 
»adËn
 = (
ušt64_t
);

1599 ià(
	`»ad
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
, 
ok_¦aves
, 
»adËn
) ==

1600 
»adËn
)

1602 
»adËn
 = 
ok_¦aves
[0]*(
ušt64_t
)*2;

1606 
ok_¦aves
 = 
	`z»®loc
(ok_¦aves,(
ušt64_t
)+
»adËn
);

1607 ià(
»adËn
 &&

1608 
	`»ad
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
, 
ok_¦aves
+1,

1609 
»adËn
) !=„eadlen)

1611 
ok_¦aves
[0] = 0;

1616 
	`şo£
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
);

1617 
	`şo£
(
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
);

1621 
li¡Node
 *
Ê
;

1622 
li¡I‹r
 
li
;

1624 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1625 (
Ê
 = 
	`li¡Next
(&
li
))) {

1626 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1628 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
) {

1629 
ušt64_t
 
j
;

1630 
”rÜcode
 = 0;

1635 
j
 = 0; j < 
ok_¦aves
[0]; j++) {

1636 ià(
¦ave
->
id
 =ğ
ok_¦aves
[2*
j
+1]) {

1637 
”rÜcode
 = 
ok_¦aves
[2*
j
+2];

1641 ià(
j
 =ğ
ok_¦aves
[0] || 
”rÜcode
 != 0) {

1642 
	`£rv”Log
(
LL_WARNING
,

1644 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
),

1645 (
”rÜcode
 == 0) ? "RDBransfer child‡borted"

1646 : 
	`¡»¼Ü
(
”rÜcode
));

1647 
	`ä“Cl›Á
(
¦ave
);

1649 
	`£rv”Log
(
LL_WARNING
,

1651 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

1653 
	`ª‘NÚBlock
(
NULL
,
¦ave
->
fd
);

1654 
	`ª‘S’dTimeout
(
NULL
,
¦ave
->
fd
,0);

1658 
	`zä“
(
ok_¦aves
);

1660 
	`upd©eSÏvesWa™šgBg§ve
((!
bysigÇl
 && 
ex™code
 =ğ0è? 
C_OK
 : 
C_ERR
, 
RDB_CHILD_TYPE_SOCKET
);

1661 
	}
}

1664 
	$backgroundSaveDÚeHªdËr
(
ex™code
, 
bysigÇl
) {

1665 
£rv”
.
rdb_chd_ty³
) {

1666 
RDB_CHILD_TYPE_DISK
:

1667 
	`backgroundSaveDÚeHªdËrDisk
(
ex™code
,
bysigÇl
);

1669 
RDB_CHILD_TYPE_SOCKET
:

1670 
	`backgroundSaveDÚeHªdËrSock‘
(
ex™code
,
bysigÇl
);

1673 
	`£rv”Pªic
("Unknown RDB childype.");

1676 
	}
}

1680 
	$rdbSaveToSÏvesSock‘s
() {

1681 *
fds
;

1682 
ušt64_t
 *
ş›Áids
;

1683 
numfds
;

1684 
li¡Node
 *
Ê
;

1685 
li¡I‹r
 
li
;

1686 
pid_t
 
chdpid
;

1687 
¡¬t
;

1688 
pefds
[2];

1690 ià(
£rv”
.
rdb_chd_pid
 !ğ-1è 
C_ERR
;

1695 ià(
	`pe
(
pefds
è=ğ-1è 
C_ERR
;

1696 
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
 = 
pefds
[0];

1697 
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
 = 
pefds
[1];

1701 
fds
 = 
	`zm®loc
(()*
	`li¡L’gth
(
£rv”
.
¦aves
));

1705 
ş›Áids
 = 
	`zm®loc
((
ušt64_t
)*
	`li¡L’gth
(
£rv”
.
¦aves
));

1706 
numfds
 = 0;

1708 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1709 (
Ê
 = 
	`li¡Next
(&
li
))) {

1710 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1712 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

1713 
ş›Áids
[
numfds
] = 
¦ave
->
id
;

1714 
fds
[
numfds
++] = 
¦ave
->
fd
;

1715 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
¦ave
,
	`g‘PsyncIn™ŸlOff£t
());

1719 
	`ª‘Block
(
NULL
,
¦ave
->
fd
);

1720 
	`ª‘S’dTimeout
(
NULL
,
¦ave
->
fd
,
£rv”
.
»¶_timeout
*1000);

1725 
¡¬t
 = 
	`u¡ime
();

1726 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1728 
»tv®
;

1729 
rio
 
¦ave_sock‘s
;

1731 
	`rioIn™W™hFd£t
(&
¦ave_sock‘s
,
fds
,
numfds
);

1732 
	`zä“
(
fds
);

1734 
	`şo£Li¡’šgSock‘s
(0);

1735 
	`»disS‘ProcT™Ë
("redis-rdb-to-slaves");

1737 
»tv®
 = 
	`rdbSaveRioW™hEOFM¬k
(&
¦ave_sock‘s
,
NULL
);

1738 ià(
»tv®
 =ğ
C_OK
 && 
	`rioFlush
(&
¦ave_sock‘s
) == 0)

1739 
»tv®
 = 
C_ERR
;

1741 ià(
»tv®
 =ğ
C_OK
) {

1742 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
();

1744 ià(
´iv©e_dœty
) {

1745 
	`£rv”Log
(
LL_NOTICE
,

1747 
´iv©e_dœty
/(1024*1024));

1765 *
msg
 = 
	`zm®loc
((
ušt64_t
)*(1+2*
numfds
));

1766 
ušt64_t
 *
Ën
 = 
msg
;

1767 
ušt64_t
 *
ids
 = 
Ën
+1;

1768 
j
, 
msgËn
;

1770 *
Ën
 = 
numfds
;

1771 
j
 = 0; j < 
numfds
; j++) {

1772 *
ids
++ = 
ş›Áids
[
j
];

1773 *
ids
++ = 
¦ave_sock‘s
.
io
.
fd£t
.
¡©e
[
j
];

1780 
msgËn
 = (
ušt64_t
)*(1+2*
numfds
);

1781 ià(*
Ën
 == 0 ||

1782 
	`wr™e
(
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
,
msg
,
msgËn
)

1783 !ğ
msgËn
)

1785 
»tv®
 = 
C_ERR
;

1787 
	`zä“
(
msg
);

1789 
	`zä“
(
ş›Áids
);

1790 
	`rioF»eFd£t
(&
¦ave_sock‘s
);

1791 
	`ex™FromChd
((
»tv®
 =ğ
C_OK
) ? 0 : 1);

1794 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1795 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1796 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1797 ià(
chdpid
 == -1) {

1798 
	`£rv”Log
(
LL_WARNING
,"Can't save in background: fork: %s",

1799 
	`¡»¼Ü
(
”ºo
));

1804 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1805 (
Ê
 = 
	`li¡Next
(&
li
))) {

1806 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1807 
j
;

1809 
j
 = 0; j < 
numfds
; j++) {

1810 ià(
¦ave
->
id
 =ğ
ş›Áids
[
j
]) {

1811 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_START
;

1816 
	`şo£
(
pefds
[0]);

1817 
	`şo£
(
pefds
[1]);

1819 
	`£rv”Log
(
LL_NOTICE
,"Background RDBransfer started by…id %d",

1820 
chdpid
);

1821 
£rv”
.
rdb_§ve_time_¡¬t
 = 
	`time
(
NULL
);

1822 
£rv”
.
rdb_chd_pid
 = 
chdpid
;

1823 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_SOCKET
;

1824 
	`upd©eDiùResizePŞicy
();

1826 
	`zä“
(
ş›Áids
);

1827 
	`zä“
(
fds
);

1828  (
chdpid
 =ğ-1è? 
C_ERR
 : 
C_OK
;

1830  
C_OK
;

1831 
	}
}

1833 
	$§veCommªd
(
ş›Á
 *
c
) {

1834 ià(
£rv”
.
rdb_chd_pid
 != -1) {

1835 
	`addR•lyE¼Ü
(
c
,"Background save‡lready in…rogress");

1838 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
è=ğ
C_OK
) {

1839 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1841 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

1843 
	}
}

1845 
	$bg§veCommªd
(
ş›Á
 *
c
) {

1846 ià(
£rv”
.
rdb_chd_pid
 != -1) {

1847 
	`addR•lyE¼Ü
(
c
,"Background save‡lready in…rogress");

1848 } ià(
£rv”
.
aof_chd_pid
 != -1) {

1849 
	`addR•lyE¼Ü
(
c
,"Can't BGSAVE while AOF†og„ewriting is in…rogress");

1850 } ià(
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
è=ğ
C_OK
) {

1851 
	`addR•lyStus
(
c
,"Background saving started");

1853 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

1855 
	}
}

	@rdb.h

30 #iâdeà
__RDB_H


31 
	#__RDB_H


	)

33 
	~<¡dio.h
>

34 
	~"rio.h
"

37 
	~"£rv”.h
"

41 
	#RDB_VERSION
 8

	)

57 
	#RDB_6BITLEN
 0

	)

58 
	#RDB_14BITLEN
 1

	)

59 
	#RDB_32BITLEN
 0x80

	)

60 
	#RDB_64BITLEN
 0x81

	)

61 
	#RDB_ENCVAL
 3

	)

62 
	#RDB_LENERR
 
UINT64_MAX


	)

67 
	#RDB_ENC_INT8
 0

	)

68 
	#RDB_ENC_INT16
 1

	)

69 
	#RDB_ENC_INT32
 2

	)

70 
	#RDB_ENC_LZF
 3

	)

74 
	#RDB_TYPE_STRING
 0

	)

75 
	#RDB_TYPE_LIST
 1

	)

76 
	#RDB_TYPE_SET
 2

	)

77 
	#RDB_TYPE_ZSET
 3

	)

78 
	#RDB_TYPE_HASH
 4

	)

79 
	#RDB_TYPE_ZSET_2
 5

	)

80 
	#RDB_TYPE_MODULE
 6

	)

84 
	#RDB_TYPE_HASH_ZIPMAP
 9

	)

85 
	#RDB_TYPE_LIST_ZIPLIST
 10

	)

86 
	#RDB_TYPE_SET_INTSET
 11

	)

87 
	#RDB_TYPE_ZSET_ZIPLIST
 12

	)

88 
	#RDB_TYPE_HASH_ZIPLIST
 13

	)

89 
	#RDB_TYPE_LIST_QUICKLIST
 14

	)

93 
	#rdbIsObjeùTy³
(
t
è(Ñ >ğ0 && <ğ6è|| (ˆ>ğ9 && <ğ14))

	)

96 
	#RDB_OPCODE_AUX
 250

	)

97 
	#RDB_OPCODE_RESIZEDB
 251

	)

98 
	#RDB_OPCODE_EXPIRETIME_MS
 252

	)

99 
	#RDB_OPCODE_EXPIRETIME
 253

	)

100 
	#RDB_OPCODE_SELECTDB
 254

	)

101 
	#RDB_OPCODE_EOF
 255

	)

104 
	#RDB_LOAD_NONE
 0

	)

105 
	#RDB_LOAD_ENC
 (1<<0)

	)

106 
	#RDB_LOAD_PLAIN
 (1<<1)

	)

107 
	#RDB_LOAD_SDS
 (1<<2)

	)

109 
rdbSaveTy³
(
rio
 *
rdb
, 
ty³
);

110 
rdbLßdTy³
(
rio
 *
rdb
);

111 
rdbSaveTime
(
rio
 *
rdb
, 
time_t
 
t
);

112 
time_t
 
rdbLßdTime
(
rio
 *
rdb
);

113 
rdbSaveL’
(
rio
 *
rdb
, 
ušt64_t
 
Ën
);

114 
ušt64_t
 
rdbLßdL’
(
rio
 *
rdb
, *
i£ncoded
);

115 
rdbLßdL’ByRef
(
rio
 *
rdb
, *
i£ncoded
, 
ušt64_t
 *
ËÅŒ
);

116 
rdbSaveObjeùTy³
(
rio
 *
rdb
, 
robj
 *
o
);

117 
rdbLßdObjeùTy³
(
rio
 *
rdb
);

118 
rdbLßd
(*
f’ame
);

119 
rdbSaveBackground
(*
f’ame
);

120 
rdbSaveToSÏvesSock‘s
();

121 
rdbRemoveTempFe
(
pid_t
 
chdpid
);

122 
rdbSave
(*
f’ame
);

123 
ssize_t
 
rdbSaveObjeù
(
rio
 *
rdb
, 
robj
 *
o
);

124 
size_t
 
rdbSavedObjeùL’
(
robj
 *
o
);

125 
robj
 *
rdbLßdObjeù
(
ty³
, 
rio
 *
rdb
);

126 
backgroundSaveDÚeHªdËr
(
ex™code
, 
bysigÇl
);

127 
rdbSaveKeyV®uePaœ
(
rio
 *
rdb
, 
robj
 *
key
,„obj *
v®
, 
expœ‘ime
, 
now
);

128 
robj
 *
rdbLßdSŒšgObjeù
(
rio
 *
rdb
);

129 
rdbSaveSŒšgObjeù
(
rio
 *
rdb
, 
robj
 *
obj
);

130 
ssize_t
 
rdbSaveRawSŒšg
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
);

131 *
rdbG’”icLßdSŒšgObjeù
(
rio
 *
rdb
, 
æags
, 
size_t
 *
ËÅŒ
);

132 
rdbSaveBš¬yDoubËV®ue
(
rio
 *
rdb
, 
v®
);

133 
rdbLßdBš¬yDoubËV®ue
(
rio
 *
rdb
, *
v®
);

	@redis-benchmark.c

31 
	~"fmaüos.h
"

33 
	~<¡dio.h
>

34 
	~<¡ršg.h
>

35 
	~<¡dlib.h
>

36 
	~<uni¡d.h
>

37 
	~<”ºo.h
>

38 
	~<time.h
>

39 
	~<sys/time.h
>

40 
	~<sigÇl.h
>

41 
	~<as£¹.h
>

43 
	~<sds.h
>

44 
	~"«.h
"

45 
	~"hœedis.h
"

46 
	~"adli¡.h
"

47 
	~"zm®loc.h
"

49 
	#UNUSED
(
V
è((èV)

	)

50 
	#RANDPTR_INITIAL_SIZE
 8

	)

52 
	scÚfig
 {

53 
«Ev’tLoİ
 *
	m–
;

54 cÚ¡ *
	mho¡
;

55 
	mho¡pÜt
;

56 cÚ¡ *
	mho¡sock‘
;

57 
	mnumş›Ás
;

58 
	mliveş›Ás
;

59 
	m»que¡s
;

60 
	m»que¡s_issued
;

61 
	m»que¡s_fšished
;

62 
	mkeysize
;

63 
	md©asize
;

64 
	m¿ndomkeys
;

65 
	m¿ndomkeys_key¥aûËn
;

66 
	mk“·live
;

67 
	mp–še
;

68 
	mshow”rÜs
;

69 
	m¡¬t
;

70 
	mtÙÏ‹ncy
;

71 *
	mÏ‹ncy
;

72 cÚ¡ *
	mt™Ë
;

73 
li¡
 *
	mş›Ás
;

74 
	mqu›t
;

75 
	mcsv
;

76 
	mloİ
;

77 
	midËmode
;

78 
	mdbnum
;

79 
sds
 
	mdbnum¡r
;

80 *
	m‹¡s
;

81 *
	mauth
;

82 } 
	gcÚfig
;

84 
	s_ş›Á
 {

85 
»disCÚ‹xt
 *
	mcÚ‹xt
;

86 
sds
 
	mobuf
;

87 **
	m¿nd±r
;

88 
size_t
 
	m¿ndËn
;

89 
size_t
 
	m¿ndä“
;

90 
size_t
 
	mwr™‹n
;

91 
	m¡¬t
;

92 
	mÏ‹ncy
;

93 
	m³ndšg
;

94 
	m´efix_³ndšg
;

97 
	m´efixËn
;

98 } *
	tş›Á
;

101 
wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

102 
ü—‹MissšgCl›Ás
(
ş›Á
 
c
);

105 
	$u¡ime
() {

106 
timev®
 
tv
;

107 
u¡
;

109 
	`g‘timeofday
(&
tv
, 
NULL
);

110 
u¡
 = (()
tv
.
tv_£c
)*1000000;

111 
u¡
 +ğ
tv
.
tv_u£c
;

112  
u¡
;

113 
	}
}

115 
	$m¡ime
() {

116 
timev®
 
tv
;

117 
m¡
;

119 
	`g‘timeofday
(&
tv
, 
NULL
);

120 
m¡
 = (()
tv
.
tv_£c
)*1000;

121 
m¡
 +ğ
tv
.
tv_u£c
/1000;

122  
m¡
;

123 
	}
}

125 
	$ä“Cl›Á
(
ş›Á
 
c
) {

126 
li¡Node
 *
Ê
;

127 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

128 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
);

129 
	`»disF»e
(
c
->
cÚ‹xt
);

130 
	`sdsä“
(
c
->
obuf
);

131 
	`zä“
(
c
->
¿nd±r
);

132 
	`zä“
(
c
);

133 
cÚfig
.
liveş›Ás
--;

134 
Ê
 = 
	`li¡S—rchKey
(
cÚfig
.
ş›Ás
,
c
);

135 
	`as£¹
(
Ê
 !ğ
NULL
);

136 
	`li¡D–Node
(
cÚfig
.
ş›Ás
,
Ê
);

137 
	}
}

139 
	$ä“AÎCl›Ás
() {

140 
li¡Node
 *
Ê
 = 
cÚfig
.
ş›Ás
->
h—d
, *
Ãxt
;

142 
Ê
) {

143 
Ãxt
 = 
Ê
->next;

144 
	`ä“Cl›Á
(
Ê
->
v®ue
);

145 
Ê
 = 
Ãxt
;

147 
	}
}

149 
	$»£tCl›Á
(
ş›Á
 
c
) {

150 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

151 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
);

152 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

153 
c
->
wr™‹n
 = 0;

154 
c
->
³ndšg
 = 
cÚfig
.
p–še
;

155 
	}
}

157 
	$¿ndomizeCl›ÁKey
(
ş›Á
 
c
) {

158 
size_t
 
i
;

160 
i
 = 0; i < 
c
->
¿ndËn
; i++) {

161 *
p
 = 
c
->
¿nd±r
[
i
]+11;

162 
size_t
 
r
 = 
	`¿ndom
(è% 
cÚfig
.
¿ndomkeys_key¥aûËn
;

163 
size_t
 
j
;

165 
j
 = 0; j < 12; j++) {

166 *
p
 = '0'+
r
%10;

167 
r
/=10;

168 
p
--;

171 
	}
}

173 
	$ş›ÁDÚe
(
ş›Á
 
c
) {

174 ià(
cÚfig
.
»que¡s_fšished
 =ğcÚfig.
»que¡s
) {

175 
	`ä“Cl›Á
(
c
);

176 
	`«Stİ
(
cÚfig
.
–
);

179 ià(
cÚfig
.
k“·live
) {

180 
	`»£tCl›Á
(
c
);

182 
cÚfig
.
liveş›Ás
--;

183 
	`ü—‹MissšgCl›Ás
(
c
);

184 
cÚfig
.
liveş›Ás
++;

185 
	`ä“Cl›Á
(
c
);

187 
	}
}

189 
	$»adHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

190 
ş›Á
 
c
 = 
´ivd©a
;

191 *
»¶y
 = 
NULL
;

192 
	`UNUSED
(
–
);

193 
	`UNUSED
(
fd
);

194 
	`UNUSED
(
mask
);

199 ià(
c
->
Ï‹ncy
 < 0èc->Ï‹ncy = 
	`u¡ime
()-(c->
¡¬t
);

201 ià(
	`»disBufãrR—d
(
c
->
cÚ‹xt
è!ğ
REDIS_OK
) {

202 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
cÚ‹xt
->
”r¡r
);

203 
	`ex™
(1);

205 
c
->
³ndšg
) {

206 ià(
	`»disG‘R•ly
(
c
->
cÚ‹xt
,&
»¶y
è!ğ
REDIS_OK
) {

207 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
cÚ‹xt
->
”r¡r
);

208 
	`ex™
(1);

210 ià(
»¶y
 !ğ
NULL
) {

211 ià(
»¶y
 =ğ(*)
REDIS_REPLY_ERROR
) {

212 
	`årštf
(
¡d”r
,"Unexpectedƒrror„eply,ƒxiting...\n");

213 
	`ex™
(1);

216 ià(
cÚfig
.
show”rÜs
) {

217 
time_t
 
Ï¡”r_time
 = 0;

218 
time_t
 
now
 = 
	`time
(
NULL
);

219 
»disR•ly
 *
r
 = 
»¶y
;

220 ià(
r
->
ty³
 =ğ
REDIS_REPLY_ERROR
 && 
Ï¡”r_time
 !ğ
now
) {

221 
Ï¡”r_time
 = 
now
;

222 
	`´štf
("E¼Ü from s”v”: %s\n", 
r
->
¡r
);

226 
	`ä“R•lyObjeù
(
»¶y
);

228 ià(
c
->
´efix_³ndšg
 > 0) {

229 
c
->
´efix_³ndšg
--;

230 
c
->
³ndšg
--;

232 ià(
c
->
´efixËn
 > 0) {

233 
size_t
 
j
;

234 
	`sd¤ªge
(
c
->
obuf
, c->
´efixËn
, -1);

237 
j
 = 0; j < 
c
->
¿ndËn
; j++)

238 
c
->
¿nd±r
[
j
] -ğc->
´efixËn
;

239 
c
->
´efixËn
 = 0;

244 ià(
cÚfig
.
»que¡s_fšished
 < cÚfig.
»que¡s
)

245 
cÚfig
.
Ï‹ncy
[cÚfig.
»que¡s_fšished
++] = 
c
->latency;

246 
c
->
³ndšg
--;

247 ià(
c
->
³ndšg
 == 0) {

248 
	`ş›ÁDÚe
(
c
);

256 
	}
}

258 
	$wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

259 
ş›Á
 
c
 = 
´ivd©a
;

260 
	`UNUSED
(
–
);

261 
	`UNUSED
(
fd
);

262 
	`UNUSED
(
mask
);

265 ià(
c
->
wr™‹n
 == 0) {

267 ià(
cÚfig
.
»que¡s_issued
++ >ğcÚfig.
»que¡s
) {

268 
	`ä“Cl›Á
(
c
);

273 ià(
cÚfig
.
¿ndomkeys
è
	`¿ndomizeCl›ÁKey
(
c
);

274 
c
->
¡¬t
 = 
	`u¡ime
();

275 
c
->
Ï‹ncy
 = -1;

278 ià(
	`sd¦’
(
c
->
obuf
è> c->
wr™‹n
) {

279 *
±r
 = 
c
->
obuf
+c->
wr™‹n
;

280 
ssize_t
 
nwr™‹n
 = 
	`wr™e
(
c
->
cÚ‹xt
->
fd
,
±r
,
	`sd¦’
(c->
obuf
)-c->
wr™‹n
);

281 ià(
nwr™‹n
 == -1) {

282 ià(
”ºo
 !ğ
EPIPE
)

283 
	`årštf
(
¡d”r
, "Wr™šgØsock‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

284 
	`ä“Cl›Á
(
c
);

287 
c
->
wr™‹n
 +ğ
nwr™‹n
;

288 ià(
	`sd¦’
(
c
->
obuf
è=ğc->
wr™‹n
) {

289 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

290 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
,
»adHªdËr
,c);

293 
	}
}

316 
ş›Á
 
	$ü—‹Cl›Á
(*
cmd
, 
size_t
 
Ën
, 
ş›Á
 
äom
) {

317 
j
;

318 
ş›Á
 
c
 = 
	`zm®loc
((
_ş›Á
));

320 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

321 
c
->
cÚ‹xt
 = 
	`»disCÚÃùNÚBlock
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

323 
c
->
cÚ‹xt
 = 
	`»disCÚÃùUnixNÚBlock
(
cÚfig
.
ho¡sock‘
);

325 ià(
c
->
cÚ‹xt
->
”r
) {

326 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

327 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

328 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
c
->
cÚ‹xt
->
”r¡r
);

330 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
c
->
cÚ‹xt
->
”r¡r
);

331 
	`ex™
(1);

334 
c
->
cÚ‹xt
->
»ad”
->
maxbuf
 = 0;

339 
c
->
obuf
 = 
	`sd£m±y
();

343 
c
->
´efix_³ndšg
 = 0;

344 ià(
cÚfig
.
auth
) {

345 *
buf
 = 
NULL
;

346 
Ën
 = 
	`»disFÜm©Commªd
(&
buf
, "AUTH %s", 
cÚfig
.
auth
);

347 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf, 
buf
, 
Ën
);

348 
	`ä“
(
buf
);

349 
c
->
´efix_³ndšg
++;

356 ià(
cÚfig
.
dbnum
 != 0) {

357 
c
->
obuf
 = 
	`sdsÿrštf
(c->obuf,"*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n",

358 ()
	`sd¦’
(
cÚfig
.
dbnum¡r
),config.dbnumstr);

359 
c
->
´efix_³ndšg
++;

361 
c
->
´efixËn
 = 
	`sd¦’
(c->
obuf
);

363 ià(
äom
) {

364 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,

365 
äom
->
obuf
+äom->
´efixËn
,

366 
	`sd¦’
(
äom
->
obuf
)-äom->
´efixËn
);

368 
j
 = 0; j < 
cÚfig
.
p–še
; j++)

369 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,
cmd
,
Ën
);

372 
c
->
wr™‹n
 = 0;

373 
c
->
³ndšg
 = 
cÚfig
.
p–še
+c->
´efix_³ndšg
;

374 
c
->
¿nd±r
 = 
NULL
;

375 
c
->
¿ndËn
 = 0;

378 ià(
cÚfig
.
¿ndomkeys
) {

379 ià(
äom
) {

380 
c
->
¿ndËn
 = 
äom
->randlen;

381 
c
->
¿ndä“
 = 0;

382 
c
->
¿nd±r
 = 
	`zm®loc
((*)*c->
¿ndËn
);

384 
j
 = 0; j < ()
c
->
¿ndËn
; j++) {

385 
c
->
¿nd±r
[
j
] = c->
obuf
 + (
äom
->randptr[j]-from->obuf);

387 
c
->
¿nd±r
[
j
] +ğc->
´efixËn
 - 
äom
->prefixlen;

390 *
p
 = 
c
->
obuf
;

392 
c
->
¿ndËn
 = 0;

393 
c
->
¿ndä“
 = 
RANDPTR_INITIAL_SIZE
;

394 
c
->
¿nd±r
 = 
	`zm®loc
((*)*c->
¿ndä“
);

395 (
p
 = 
	`¡r¡r
Õ,"__¿nd_št__")è!ğ
NULL
) {

396 ià(
c
->
¿ndä“
 == 0) {

397 
c
->
¿nd±r
 = 
	`z»®loc
(c->¿nd±r,(*)*c->
¿ndËn
*2);

398 
c
->
¿ndä“
 +ğc->
¿ndËn
;

400 
c
->
¿nd±r
[c->
¿ndËn
++] = 
p
;

401 
c
->
¿ndä“
--;

402 
p
 += 12;

406 ià(
cÚfig
.
idËmode
 == 0)

407 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

408 
	`li¡AddNodeTa
(
cÚfig
.
ş›Ás
,
c
);

409 
cÚfig
.
liveş›Ás
++;

410  
c
;

411 
	}
}

413 
	$ü—‹MissšgCl›Ás
(
ş›Á
 
c
) {

414 
n
 = 0;

416 
cÚfig
.
liveş›Ás
 < cÚfig.
numş›Ás
) {

417 
	`ü—‹Cl›Á
(
NULL
,0,
c
);

420 ià(++
n
 > 64) {

421 
	`u¦“p
(50000);

422 
n
 = 0;

425 
	}
}

427 
	$com·»L©’cy
(cÚ¡ *
a
, cÚ¡ *
b
) {

428  (*(*)
a
)-(*(*)
b
);

429 
	}
}

431 
	$showL©’cyR•Üt
() {

432 
i
, 
cu¾©
 = 0;

433 
³rc
, 
»q³r£c
;

435 
»q³r£c
 = ()
cÚfig
.
»que¡s_fšished
/(()cÚfig.
tÙÏ‹ncy
/1000);

436 ià(!
cÚfig
.
qu›t
 && !cÚfig.
csv
) {

437 
	`´štf
("=====ğ% ======\n", 
cÚfig
.
t™Ë
);

438 
	`´štf
(" %d„eque¡ com¶‘ed iÀ%.2à£cÚds\n", 
cÚfig
.
»que¡s_fšished
,

439 ()
cÚfig
.
tÙÏ‹ncy
/1000);

440 
	`´štf
(" %d…¬®ËÈş›Ás\n", 
cÚfig
.
numş›Ás
);

441 
	`´štf
(" %d by‹ ·ylßd\n", 
cÚfig
.
d©asize
);

442 
	`´štf
(" k“°®ive: %d\n", 
cÚfig
.
k“·live
);

443 
	`´štf
("\n");

445 
	`qsÜt
(
cÚfig
.
Ï‹ncy
,cÚfig.
»que¡s
,(),
com·»L©’cy
);

446 
i
 = 0; i < 
cÚfig
.
»que¡s
; i++) {

447 ià(
cÚfig
.
Ï‹ncy
[
i
]/1000 !ğ
cu¾©
 || i =ğ(cÚfig.
»que¡s
-1)) {

448 
cu¾©
 = 
cÚfig
.
Ï‹ncy
[
i
]/1000;

449 
³rc
 = (()(
i
+1)*100)/
cÚfig
.
»que¡s
;

450 
	`´štf
("%.2f%% <ğ%d mli£cÚds\n", 
³rc
, 
cu¾©
);

453 
	`´štf
("%.2à»que¡ ³¸£cÚd\n\n", 
»q³r£c
);

454 } ià(
cÚfig
.
csv
) {

455 
	`´štf
("\"%s\",\"%.2f\"\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

457 
	`´štf
("%s: %.2à»que¡ ³¸£cÚd\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

459 
	}
}

461 
	$b’chm¬k
(*
t™Ë
, *
cmd
, 
Ën
) {

462 
ş›Á
 
c
;

464 
cÚfig
.
t™Ë
 =itle;

465 
cÚfig
.
»que¡s_issued
 = 0;

466 
cÚfig
.
»que¡s_fšished
 = 0;

468 
c
 = 
	`ü—‹Cl›Á
(
cmd
,
Ën
,
NULL
);

469 
	`ü—‹MissšgCl›Ás
(
c
);

471 
cÚfig
.
¡¬t
 = 
	`m¡ime
();

472 
	`«Maš
(
cÚfig
.
–
);

473 
cÚfig
.
tÙÏ‹ncy
 = 
	`m¡ime
()-cÚfig.
¡¬t
;

475 
	`showL©’cyR•Üt
();

476 
	`ä“AÎCl›Ás
();

477 
	}
}

480 
	$·r£O±iÚs
(
¬gc
, cÚ¡ **
¬gv
) {

481 
i
;

482 
Ï¡¬g
;

483 
ex™_¡©us
 = 1;

485 
i
 = 1; i < 
¬gc
; i++) {

486 
Ï¡¬g
 = (
i
 =ğ(
¬gc
-1));

488 ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

489 ià(
Ï¡¬g
è
šv®id
;

490 
cÚfig
.
numş›Ás
 = 
	`©oi
(
¬gv
[++
i
]);

491 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n")) {

492 ià(
Ï¡¬g
è
šv®id
;

493 
cÚfig
.
»que¡s
 = 
	`©oi
(
¬gv
[++
i
]);

494 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-k")) {

495 ià(
Ï¡¬g
è
šv®id
;

496 
cÚfig
.
k“·live
 = 
	`©oi
(
¬gv
[++
i
]);

497 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h")) {

498 ià(
Ï¡¬g
è
šv®id
;

499 
cÚfig
.
ho¡
 = 
	`¡rdup
(
¬gv
[++
i
]);

500 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p")) {

501 ià(
Ï¡¬g
è
šv®id
;

502 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

503 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s")) {

504 ià(
Ï¡¬g
è
šv®id
;

505 
cÚfig
.
ho¡sock‘
 = 
	`¡rdup
(
¬gv
[++
i
]);

506 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a") ) {

507 ià(
Ï¡¬g
è
šv®id
;

508 
cÚfig
.
auth
 = 
	`¡rdup
(
¬gv
[++
i
]);

509 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d")) {

510 ià(
Ï¡¬g
è
šv®id
;

511 
cÚfig
.
d©asize
 = 
	`©oi
(
¬gv
[++
i
]);

512 ià(
cÚfig
.
d©asize
 < 1) config.datasize=1;

513 ià(
cÚfig
.
d©asize
 > 1024*1024*1024) config.datasize = 1024*1024*1024;

514 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-P")) {

515 ià(
Ï¡¬g
è
šv®id
;

516 
cÚfig
.
p–še
 = 
	`©oi
(
¬gv
[++
i
]);

517 ià(
cÚfig
.
p–še
 <= 0) config.pipeline=1;

518 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r")) {

519 ià(
Ï¡¬g
è
šv®id
;

520 
cÚfig
.
¿ndomkeys
 = 1;

521 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 
	`©oi
(
¬gv
[++
i
]);

522 ià(
cÚfig
.
¿ndomkeys_key¥aûËn
 < 0)

523 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

524 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-q")) {

525 
cÚfig
.
qu›t
 = 1;

526 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

527 
cÚfig
.
csv
 = 1;

528 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-l")) {

529 
cÚfig
.
loİ
 = 1;

530 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-I")) {

531 
cÚfig
.
idËmode
 = 1;

532 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-e")) {

533 
cÚfig
.
show”rÜs
 = 1;

534 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-t")) {

535 ià(
Ï¡¬g
è
šv®id
;

541 
cÚfig
.
‹¡s
 = 
	`sd¢ew
(",");

542 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(cÚfig.‹¡s,(*)
¬gv
[++
i
]);

543 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(config.tests,",");

544 
	`sd¡Şow”
(
cÚfig
.
‹¡s
);

545 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--dbnum")) {

546 ià(
Ï¡¬g
è
šv®id
;

547 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

548 
cÚfig
.
dbnum¡r
 = 
	`sdsäomlÚglÚg
(cÚfig.
dbnum
);

549 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

550 
ex™_¡©us
 = 0;

551 
u§ge
;

556 ià(
¬gv
[
i
][0] =ğ'-'è
šv®id
;

557  
i
;

561  
i
;

563 
šv®id
:

564 
	`´štf
("Inv®id o±iÚ \"%s\" o¸İtiÚ‡rgum’ˆmissšg\n\n",
¬gv
[
i
]);

566 
u§ge
:

567 
	`´štf
(

609 
	`ex™
(
ex™_¡©us
);

610 
	}
}

612 
	$showThroughput
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

613 
	`UNUSED
(
ev’tLoİ
);

614 
	`UNUSED
(
id
);

615 
	`UNUSED
(
ş›ÁD©a
);

617 ià(
cÚfig
.
liveş›Ás
 == 0) {

618 
	`årštf
(
¡d”r
,"All clients disconnected...‡borting.\n");

619 
	`ex™
(1);

621 ià(
cÚfig
.
csv
)  250;

622 ià(
cÚfig
.
idËmode
 == 1) {

623 
	`´štf
("ş›Ás: %d\r", 
cÚfig
.
liveş›Ás
);

624 
	`fæush
(
¡dout
);

627 
dt
 = ()(
	`m¡ime
()-
cÚfig
.
¡¬t
)/1000.0;

628 
½s
 = ()
cÚfig
.
»que¡s_fšished
/
dt
;

629 
	`´štf
("%s: %.2f\r", 
cÚfig
.
t™Ë
, 
½s
);

630 
	`fæush
(
¡dout
);

632 
	}
}

636 
	$‹¡_is_£Ëùed
(*
Çme
) {

637 
buf
[256];

638 
l
 = 
	`¡¾’
(
Çme
);

640 ià(
cÚfig
.
‹¡s
 =ğ
NULL
)  1;

641 
buf
[0] = ',';

642 
	`memıy
(
buf
+1,
Çme
,
l
);

643 
buf
[
l
+1] = ',';

644 
buf
[
l
+2] = '\0';

645  
	`¡r¡r
(
cÚfig
.
‹¡s
,
buf
è!ğ
NULL
;

646 
	}
}

648 
	$maš
(
¬gc
, cÚ¡ **
¬gv
) {

649 
i
;

650 *
d©a
, *
cmd
;

651 
Ën
;

653 
ş›Á
 
c
;

655 
	`¤ªdom
(
	`time
(
NULL
));

656 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

657 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

659 
cÚfig
.
numş›Ás
 = 50;

660 
cÚfig
.
»que¡s
 = 100000;

661 
cÚfig
.
liveş›Ás
 = 0;

662 
cÚfig
.
–
 = 
	`«C»©eEv’tLoİ
(1024*10);

663 
	`«C»©eTimeEv’t
(
cÚfig
.
–
,1,
showThroughput
,
NULL
,NULL);

664 
cÚfig
.
k“·live
 = 1;

665 
cÚfig
.
d©asize
 = 3;

666 
cÚfig
.
p–še
 = 1;

667 
cÚfig
.
show”rÜs
 = 0;

668 
cÚfig
.
¿ndomkeys
 = 0;

669 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

670 
cÚfig
.
qu›t
 = 0;

671 
cÚfig
.
csv
 = 0;

672 
cÚfig
.
loİ
 = 0;

673 
cÚfig
.
idËmode
 = 0;

674 
cÚfig
.
Ï‹ncy
 = 
NULL
;

675 
cÚfig
.
ş›Ás
 = 
	`li¡C»©e
();

676 
cÚfig
.
ho¡
 = "127.0.0.1";

677 
cÚfig
.
ho¡pÜt
 = 6379;

678 
cÚfig
.
ho¡sock‘
 = 
NULL
;

679 
cÚfig
.
‹¡s
 = 
NULL
;

680 
cÚfig
.
dbnum
 = 0;

681 
cÚfig
.
auth
 = 
NULL
;

683 
i
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

684 
¬gc
 -ğ
i
;

685 
¬gv
 +ğ
i
;

687 
cÚfig
.
Ï‹ncy
 = 
	`zm®loc
(()*cÚfig.
»que¡s
);

689 ià(
cÚfig
.
k“·live
 == 0) {

690 
	`´štf
("WARNING: keepalive disabled, you…robably‚eed 'echo 1 > /proc/sys/net/ipv4/tcp_tw_reuse' for Linux‡nd 'sudo sysctl -w‚et.inet.tcp.msl=1000' for Mac OS X in ordero use‡†ot of clients/requests\n");

693 ià(
cÚfig
.
idËmode
) {

694 
	`´štf
("C»©šg %d idË cÚÃùiÚ ªd wa™šg fÜev” (CŒl+C wh’ dÚe)\n", 
cÚfig
.
numş›Ás
);

695 
c
 = 
	`ü—‹Cl›Á
("",0,
NULL
);

696 
	`ü—‹MissšgCl›Ás
(
c
);

697 
	`«Maš
(
cÚfig
.
–
);

702 ià(
¬gc
) {

703 
sds
 
t™Ë
 = 
	`sd¢ew
(
¬gv
[0]);

704 
i
 = 1; i < 
¬gc
; i++) {

705 
t™Ë
 = 
	`sdsÿ’
(title, " ", 1);

706 
t™Ë
 = 
	`sdsÿ’
Ñ™Ë, (*)
¬gv
[
i
], 
	`¡¾’
(argv[i]));

710 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

711 
	`b’chm¬k
(
t™Ë
,
cmd
,
Ën
);

712 
	`ä“
(
cmd
);

713 } 
cÚfig
.
loİ
);

719 
d©a
 = 
	`zm®loc
(
cÚfig
.
d©asize
+1);

721 
	`mem£t
(
d©a
,'x',
cÚfig
.
d©asize
);

722 
d©a
[
cÚfig
.
d©asize
] = '\0';

724 ià(
	`‹¡_is_£Ëùed
("ping_inline") ||est_is_selected("ping"))

725 
	`b’chm¬k
("PING_INLINE","PING\r\n",6);

727 ià(
	`‹¡_is_£Ëùed
("ping_mbulk") ||est_is_selected("ping")) {

728 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"PING");

729 
	`b’chm¬k
("PING_BULK",
cmd
,
Ën
);

730 
	`ä“
(
cmd
);

733 ià(
	`‹¡_is_£Ëùed
("set")) {

734 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET key:__¿nd_št__ %s",
d©a
);

735 
	`b’chm¬k
("SET",
cmd
,
Ën
);

736 
	`ä“
(
cmd
);

739 ià(
	`‹¡_is_£Ëùed
("get")) {

740 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"GET key:__rand_int__");

741 
	`b’chm¬k
("GET",
cmd
,
Ën
);

742 
	`ä“
(
cmd
);

745 ià(
	`‹¡_is_£Ëùed
("incr")) {

746 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"INCR counter:__rand_int__");

747 
	`b’chm¬k
("INCR",
cmd
,
Ën
);

748 
	`ä“
(
cmd
);

751 ià(
	`‹¡_is_£Ëùed
("lpush")) {

752 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

753 
	`b’chm¬k
("LPUSH",
cmd
,
Ën
);

754 
	`ä“
(
cmd
);

757 ià(
	`‹¡_is_£Ëùed
("rpush")) {

758 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPUSH myli¡ %s",
d©a
);

759 
	`b’chm¬k
("RPUSH",
cmd
,
Ën
);

760 
	`ä“
(
cmd
);

763 ià(
	`‹¡_is_£Ëùed
("lpop")) {

764 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPOP mylist");

765 
	`b’chm¬k
("LPOP",
cmd
,
Ën
);

766 
	`ä“
(
cmd
);

769 ià(
	`‹¡_is_£Ëùed
("rpop")) {

770 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPOP mylist");

771 
	`b’chm¬k
("RPOP",
cmd
,
Ën
);

772 
	`ä“
(
cmd
);

775 ià(
	`‹¡_is_£Ëùed
("sadd")) {

776 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,

778 
	`b’chm¬k
("SADD",
cmd
,
Ën
);

779 
	`ä“
(
cmd
);

782 ià(
	`‹¡_is_£Ëùed
("spop")) {

783 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SPOP myset");

784 
	`b’chm¬k
("SPOP",
cmd
,
Ën
);

785 
	`ä“
(
cmd
);

788 ià(
	`‹¡_is_£Ëùed
("lrange") ||

789 
	`‹¡_is_£Ëùed
("lrange_100") ||

790 
	`‹¡_is_£Ëùed
("lrange_300") ||

791 
	`‹¡_is_£Ëùed
("lrange_500") ||

792 
	`‹¡_is_£Ëùed
("lrange_600"))

794 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

795 
	`b’chm¬k
("LPUSH (ÃededØb’chm¬k LRANGE)",
cmd
,
Ën
);

796 
	`ä“
(
cmd
);

799 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_100")) {

800 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 99");

801 
	`b’chm¬k
("LRANGE_100 (fœ¡ 100ƒËm’ts)",
cmd
,
Ën
);

802 
	`ä“
(
cmd
);

805 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_300")) {

806 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 299");

807 
	`b’chm¬k
("LRANGE_300 (fœ¡ 300ƒËm’ts)",
cmd
,
Ën
);

808 
	`ä“
(
cmd
);

811 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_500")) {

812 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 449");

813 
	`b’chm¬k
("LRANGE_500 (fœ¡ 450ƒËm’ts)",
cmd
,
Ën
);

814 
	`ä“
(
cmd
);

817 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_600")) {

818 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 599");

819 
	`b’chm¬k
("LRANGE_600 (fœ¡ 600ƒËm’ts)",
cmd
,
Ën
);

820 
	`ä“
(
cmd
);

823 ià(
	`‹¡_is_£Ëùed
("mset")) {

824 cÚ¡ *
¬gv
[21];

825 
¬gv
[0] = "MSET";

826 
i
 = 1; i < 21; i += 2) {

827 
¬gv
[
i
] = "key:__rand_int__";

828 
¬gv
[
i
+1] = 
d©a
;

830 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,21,
¬gv
,
NULL
);

831 
	`b’chm¬k
("MSET (10 keys)",
cmd
,
Ën
);

832 
	`ä“
(
cmd
);

835 ià(!
cÚfig
.
csv
è
	`´štf
("\n");

836 } 
cÚfig
.
loİ
);

839 
	}
}

	@redis-check-aof.c

31 
	~"fmaüos.h
"

32 
	~<¡dlib.h
>

33 
	~<¡dio.h
>

34 
	~<¡ršg.h
>

35 
	~<uni¡d.h
>

36 
	~<sys/¡©.h
>

37 
	~"cÚfig.h
"

39 
	#ERROR
(...) { \

40 
__buf
[1024]; \

41 
	`¥rštf
(
__buf
, 
__VA_ARGS__
); \

42 
	`¥rštf
(
”rÜ
, "0x%16Îx: %s", ()
•os
, 
__buf
); \

43 }

	)

45 
	g”rÜ
[1024];

46 
off_t
 
	g•os
;

48 
	$cÚsumeNewlše
(*
buf
) {

49 ià(
	`¡ºcmp
(
buf
,"\r\n",2) != 0) {

50 
	`ERROR
("Ex³ùed \\r\\n, gÙ: %02x%02x",
buf
[0],buf[1]);

54 
	}
}

56 
	$»adLÚg
(
FILE
 *
å
, 
´efix
, *
rg‘
) {

57 
buf
[128], *
•Œ
;

58 
•os
 = 
	`á–lo
(
å
);

59 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

62 ià(
buf
[0] !ğ
´efix
) {

63 
	`ERROR
("Ex³ùed…»fix '%c', gÙ: '%c'",
buf
[0],
´efix
);

66 *
rg‘
 = 
	`¡¹Ş
(
buf
+1,&
•Œ
,10);

67  
	`cÚsumeNewlše
(
•Œ
);

68 
	}
}

70 
	$»adBy‹s
(
FILE
 *
å
, *
rg‘
, 
Ëngth
) {

71 
»®
;

72 
•os
 = 
	`á–lo
(
å
);

73 
»®
 = 
	`ä—d
(
rg‘
,1,
Ëngth
,
å
);

74 ià(
»®
 !ğ
Ëngth
) {

75 
	`ERROR
("Ex³ùedØ»ad %ld by‹s, gÙ %ld by‹s",
Ëngth
,
»®
);

79 
	}
}

81 
	$»adSŒšg
(
FILE
 *
å
, ** 
rg‘
) {

82 
Ën
;

83 *
rg‘
 = 
NULL
;

84 ià(!
	`»adLÚg
(
å
,'$',&
Ën
)) {

89 
Ën
 += 2;

90 *
rg‘
 = (*)
	`m®loc
(
Ën
);

91 ià(!
	`»adBy‹s
(
å
,*
rg‘
,
Ën
)) {

94 ià(!
	`cÚsumeNewlše
(*
rg‘
+
Ën
-2)) {

97 (*
rg‘
)[
Ën
-2] = '\0';

99 
	}
}

101 
	$»adArgc
(
FILE
 *
å
, *
rg‘
) {

102  
	`»adLÚg
(
å
,'*',
rg‘
);

103 
	}
}

105 
off_t
 
	$´oûss
(
FILE
 *
å
) {

106 
¬gc
;

107 
off_t
 
pos
 = 0;

108 
i
, 
muÉi
 = 0;

109 *
¡r
;

112 ià(!
muÉi
è
pos
 = 
	`á–lo
(
å
);

113 ià(!
	`»adArgc
(
å
, &
¬gc
)) ;

115 
i
 = 0; i < 
¬gc
; i++) {

116 ià(!
	`»adSŒšg
(
å
,&
¡r
)) ;

117 ià(
i
 == 0) {

118 ià(
	`¡rÿ£cmp
(
¡r
, "multi") == 0) {

119 ià(
muÉi
++) {

120 
	`ERROR
("Unexpected MULTI");

123 } ià(
	`¡rÿ£cmp
(
¡r
, "exec") == 0) {

124 ià(--
muÉi
) {

125 
	`ERROR
("Unexpected EXEC");

130 
	`ä“
(
¡r
);

134 ià(
i
 < 
¬gc
) {

135 ià(
¡r
è
	`ä“
(str);

140 ià(
	`ãof
(
å
è&& 
muÉi
 && 
	`¡¾’
(
”rÜ
) == 0) {

141 
	`ERROR
("Reached EOF before„eading EXEC for MULTI");

143 ià(
	`¡¾’
(
”rÜ
) > 0) {

144 
	`´štf
("%s\n", 
”rÜ
);

146  
pos
;

147 
	}
}

149 
	$maš
(
¬gc
, **
¬gv
) {

150 *
f’ame
;

151 
fix
 = 0;

153 ià(
¬gc
 < 2) {

154 
	`´štf
("U§ge: % [--fix] <fe.aof>\n", 
¬gv
[0]);

155 
	`ex™
(1);

156 } ià(
¬gc
 == 2) {

157 
f’ame
 = 
¬gv
[1];

158 } ià(
¬gc
 == 3) {

159 ià(
	`¡rcmp
(
¬gv
[1],"--fix") != 0) {

160 
	`´štf
("Inv®id‡rgum’t: %s\n", 
¬gv
[1]);

161 
	`ex™
(1);

163 
f’ame
 = 
¬gv
[2];

164 
fix
 = 1;

166 
	`´štf
("Invalid‡rguments\n");

167 
	`ex™
(1);

170 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r+");

171 ià(
å
 =ğ
NULL
) {

172 
	`´štf
("CªnÙ o³Àfe: %s\n", 
f’ame
);

173 
	`ex™
(1);

176 
»dis_¡©
 
sb
;

177 ià(
	`»dis_f¡©
(
	`f’o
(
å
),&
sb
) == -1) {

178 
	`´štf
("CªnÙ sˆfe: %s\n", 
f’ame
);

179 
	`ex™
(1);

182 
off_t
 
size
 = 
sb
.
¡_size
;

183 ià(
size
 == 0) {

184 
	`´štf
("Em±y fe: %s\n", 
f’ame
);

185 
	`ex™
(1);

188 
off_t
 
pos
 = 
	`´oûss
(
å
);

189 
off_t
 
diff
 = 
size
-
pos
;

190 
	`´štf
("AOF‡nalyzed: size=%lld, ok_up_to=%lld, diff=%lld\n",

191 (è
size
, (è
pos
, (è
diff
);

192 ià(
diff
 > 0) {

193 ià(
fix
) {

194 
buf
[2];

195 
	`´štf
("Thi wÈshrškhAOF from %Îd by‹s, w™h %Îd by‹s,Ø%Îd by‹s\n",()
size
,()
diff
,()
pos
);

196 
	`´štf
("Continue? [y/N]: ");

197 ià(
	`fg‘s
(
buf
,(buf),
¡dš
è=ğ
NULL
 ||

198 
	`¡ºÿ£cmp
(
buf
,"y",1) != 0) {

199 
	`´štf
("Aborting...\n");

200 
	`ex™
(1);

202 ià(
	`árunÿ‹
(
	`f’o
(
å
), 
pos
) == -1) {

203 
	`´štf
("Failedoruncate AOF\n");

204 
	`ex™
(1);

206 
	`´štf
("Successfullyruncated AOF\n");

209 
	`´štf
("AOF is‚ot valid\n");

210 
	`ex™
(1);

213 
	`´štf
("AOF is valid\n");

216 
	`fşo£
(
å
);

218 
	}
}

	@redis-check-rdb.c

30 
	~"£rv”.h
"

31 
	~"rdb.h
"

33 
	~<¡d¬g.h
>

35 
ü—‹Sh¬edObjeùs
();

36 
rdbLßdProg»ssC®lback
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

37 
rdbLßdMli£cÚdTime
(
rio
 *
rdb
);

38 
	grdbCheckMode
 = 0;

41 
rio
 *
	mrio
;

42 
robj
 *
	mkey
;

43 
	mkey_ty³
;

44 
	mkeys
;

45 
	mexpœes
;

46 
	m®»ady_expœed
;

47 
	mdošg
;

48 
	m”rÜ_£t
;

49 
	m”rÜ
[1024];

50 } 
	grdb¡©e
;

54 
	#RDB_CHECK_DOING_START
 0

	)

55 
	#RDB_CHECK_DOING_READ_TYPE
 1

	)

56 
	#RDB_CHECK_DOING_READ_EXPIRE
 2

	)

57 
	#RDB_CHECK_DOING_READ_KEY
 3

	)

58 
	#RDB_CHECK_DOING_READ_OBJECT_VALUE
 4

	)

59 
	#RDB_CHECK_DOING_CHECK_SUM
 5

	)

60 
	#RDB_CHECK_DOING_READ_LEN
 6

	)

61 
	#RDB_CHECK_DOING_READ_AUX
 7

	)

63 *
	grdb_check_došg_¡ršg
[] = {

74 *
	grdb_ty³_¡ršg
[] = {

92 
	$rdbShowG’”icInfo
() {

93 
	`´štf
("[šfo] %lu key »ad\n", 
rdb¡©e
.
keys
);

94 
	`´štf
("[šfo] %luƒxpœes\n", 
rdb¡©e
.
expœes
);

95 
	`´štf
("[šfo] %lu‡Ì—dyƒxpœed\n", 
rdb¡©e
.
®»ady_expœed
);

96 
	}
}

100 
	$rdbCheckE¼Ü
(cÚ¡ *
fmt
, ...) {

101 
msg
[1024];

102 
va_li¡
 
­
;

104 
	`va_¡¬t
(
­
, 
fmt
);

105 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

106 
	`va_’d
(
­
);

108 
	`´štf
("--- RDB ERROR DETECTED ---\n");

109 
	`´štf
("[offset %llu] %s\n",

110 (è(
rdb¡©e
.
rio
 ?

111 
rdb¡©e
.
rio
->
´oûs£d_by‹s
 : 0), 
msg
);

112 
	`´štf
("[additional info] While doing: %s\n",

113 
rdb_check_došg_¡ršg
[
rdb¡©e
.
došg
]);

114 ià(
rdb¡©e
.
key
)

115 
	`´štf
("[additional info] Reading key '%s'\n",

116 (*)
rdb¡©e
.
key
->
±r
);

117 ià(
rdb¡©e
.
key_ty³
 != -1)

118 
	`´štf
("[additional info] Readingype %d (%s)\n",

119 
rdb¡©e
.
key_ty³
,

120 (()
rdb¡©e
.
key_ty³
 <

121 (
rdb_ty³_¡ršg
)/(*)) ?

122 
rdb_ty³_¡ršg
[
rdb¡©e
.
key_ty³
] : "unknown");

123 
	`rdbShowG’”icInfo
();

124 
	}
}

127 
	$rdbCheckInfo
(cÚ¡ *
fmt
, ...) {

128 
msg
[1024];

129 
va_li¡
 
­
;

131 
	`va_¡¬t
(
­
, 
fmt
);

132 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

133 
	`va_’d
(
­
);

135 
	`´štf
("[offset %llu] %s\n",

136 (è(
rdb¡©e
.
rio
 ?

137 
rdb¡©e
.
rio
->
´oûs£d_by‹s
 : 0), 
msg
);

138 
	}
}

142 
	$rdbCheckS‘E¼Ü
(cÚ¡ *
fmt
, ...) {

143 
va_li¡
 
­
;

145 
	`va_¡¬t
(
­
, 
fmt
);

146 
	`v¢´štf
(
rdb¡©e
.
”rÜ
, Ôdb¡©e.”rÜ), 
fmt
, 
­
);

147 
	`va_’d
(
­
);

148 
rdb¡©e
.
”rÜ_£t
 = 1;

149 
	}
}

154 
	$rdbCheckHªdËC¿sh
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

155 
	`UNUSED
(
sig
);

156 
	`UNUSED
(
šfo
);

157 
	`UNUSED
(
£ü‘
);

159 
	`rdbCheckE¼Ü
("Server crash checkinghe specified RDB file!");

160 
	`ex™
(1);

161 
	}
}

163 
	$rdbCheckS‘upSigÇls
() {

164 
sigaùiÚ
 
aù
;

166 
	`sigem±y£t
(&
aù
.
§_mask
);

167 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_RESETHAND
 | 
SA_SIGINFO
;

168 
aù
.
§_sigaùiÚ
 = 
rdbCheckHªdËC¿sh
;

169 
	`sigaùiÚ
(
SIGSEGV
, &
aù
, 
NULL
);

170 
	`sigaùiÚ
(
SIGBUS
, &
aù
, 
NULL
);

171 
	`sigaùiÚ
(
SIGFPE
, &
aù
, 
NULL
);

172 
	`sigaùiÚ
(
SIGILL
, &
aù
, 
NULL
);

173 
	}
}

177 
	$»dis_check_rdb
(*
rdbf’ame
) {

178 
ušt64_t
 
dbid
;

179 
ty³
, 
rdbv”
;

180 
buf
[1024];

181 
expœ‘ime
, 
now
 = 
	`m¡ime
();

182 
FILE
 *
å
;

183 
rio
 
rdb
;

185 ià((
å
 = 
	`fİ’
(
rdbf’ame
,"r")è=ğ
NULL
)  1;

187 
	`rioIn™W™hFe
(&
rdb
,
å
);

188 
rdb¡©e
.
rio
 = &
rdb
;

189 
rdb
.
upd©e_cksum
 = 
rdbLßdProg»ssC®lback
;

190 ià(
	`rioR—d
(&
rdb
,
buf
,9è=ğ0è
eoã¼
;

191 
buf
[9] = '\0';

192 ià(
	`memcmp
(
buf
,"REDIS",5) != 0) {

193 
	`rdbCheckE¼Ü
("Wrong signatureryingo†oad DB from file");

196 
rdbv”
 = 
	`©oi
(
buf
+5);

197 ià(
rdbv”
 < 1 ||„dbv” > 
RDB_VERSION
) {

198 
	`rdbCheckE¼Ü
("Cª'ˆhªdË RDB fÜm© v”siÚ %d",
rdbv”
);

202 
	`¡¬tLßdšg
(
å
);

204 
robj
 *
key
, *
v®
;

205 
expœ‘ime
 = -1;

208 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_TYPE
;

209 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

212 ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME
) {

213 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_EXPIRE
;

217 ià((
expœ‘ime
 = 
	`rdbLßdTime
(&
rdb
)è=ğ-1è
eoã¼
;

219 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_TYPE
;

220 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

223 
expœ‘ime
 *= 1000;

224 } ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME_MS
) {

227 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_EXPIRE
;

228 ià((
expœ‘ime
 = 
	`rdbLßdMli£cÚdTime
(&
rdb
)è=ğ-1è
eoã¼
;

230 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_TYPE
;

231 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

232 } ià(
ty³
 =ğ
RDB_OPCODE_EOF
) {

235 } ià(
ty³
 =ğ
RDB_OPCODE_SELECTDB
) {

237 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_LEN
;

238 ià((
dbid
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

239 
eoã¼
;

240 
	`rdbCheckInfo
("S–eùšg DB ID %d", 
dbid
);

242 } ià(
ty³
 =ğ
RDB_OPCODE_RESIZEDB
) {

245 
ušt64_t
 
db_size
, 
expœes_size
;

246 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_LEN
;

247 ià((
db_size
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

248 
eoã¼
;

249 ià((
expœes_size
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

250 
eoã¼
;

252 } ià(
ty³
 =ğ
RDB_OPCODE_AUX
) {

258 
robj
 *
auxkey
, *
auxv®
;

259 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_AUX
;

260 ià((
auxkey
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

261 ià((
auxv®
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

263 
	`rdbCheckInfo
("AUX FIELD %s = '%s'",

264 (*)
auxkey
->
±r
, (*)
auxv®
->ptr);

265 
	`deüRefCouÁ
(
auxkey
);

266 
	`deüRefCouÁ
(
auxv®
);

269 ià(!
	`rdbIsObjeùTy³
(
ty³
)) {

270 
	`rdbCheckE¼Ü
("Inv®id objeùy³: %d", 
ty³
);

273 
rdb¡©e
.
key_ty³
 = 
ty³
;

277 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_KEY
;

278 ià((
key
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

279 
rdb¡©e
.
key
 = key;

280 
rdb¡©e
.
keys
++;

282 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_OBJECT_VALUE
;

283 ià((
v®
 = 
	`rdbLßdObjeù
(
ty³
,&
rdb
)è=ğ
NULL
è
eoã¼
;

289 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && 
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
)

290 
rdb¡©e
.
®»ady_expœed
++;

291 ià(
expœ‘ime
 !ğ-1è
rdb¡©e
.
expœes
++;

292 
rdb¡©e
.
key
 = 
NULL
;

293 
	`deüRefCouÁ
(
key
);

294 
	`deüRefCouÁ
(
v®
);

295 
rdb¡©e
.
key_ty³
 = -1;

298 ià(
rdbv”
 >ğ5 && 
£rv”
.
rdb_checksum
) {

299 
ušt64_t
 
cksum
, 
ex³ùed
 = 
rdb
.cksum;

301 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_CHECK_SUM
;

302 ià(
	`rioR—d
(&
rdb
,&
cksum
,8è=ğ0è
eoã¼
;

303 
	`mem»v64ifbe
(&
cksum
);

304 ià(
cksum
 == 0) {

305 
	`rdbCheckInfo
("RDB file was saved with checksum disabled:‚o check…erformed.");

306 } ià(
cksum
 !ğ
ex³ùed
) {

307 
	`rdbCheckE¼Ü
("RDB CRCƒrror");

309 
	`rdbCheckInfo
("Checksum OK");

313 
	`fşo£
(
å
);

316 
eoã¼
:

317 ià(
rdb¡©e
.
”rÜ_£t
) {

318 
	`rdbCheckE¼Ü
(
rdb¡©e
.
”rÜ
);

320 
	`rdbCheckE¼Ü
("Unexpected EOF„eading RDB file");

323 
	}
}

330 
	$»dis_check_rdb_maš
(
¬gc
, **
¬gv
) {

331 ià(
¬gc
 != 2) {

332 
	`årštf
(
¡d”r
, "U§ge: % <rdb-fe-Çme>\n", 
¬gv
[0]);

333 
	`ex™
(1);

338 ià(
sh¬ed
.
š‹g”s
[0] =ğ
NULL
)

339 
	`ü—‹Sh¬edObjeùs
();

340 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 = 0;

341 
rdbCheckMode
 = 1;

342 
	`rdbCheckInfo
("Checkšg RDB f%s", 
¬gv
[1]);

343 
	`rdbCheckS‘upSigÇls
();

344 
»tv®
 = 
	`»dis_check_rdb
(
¬gv
[1]);

345 ià(
»tv®
 == 0) {

346 
	`rdbCheckInfo
("\\o/ RDB†ooks OK! \\o/");

347 
	`rdbShowG’”icInfo
();

349 
	`ex™
(
»tv®
);

350 
	}
}

	@redis-cli.c

31 
	~"fmaüos.h
"

32 
	~"v”siÚ.h
"

34 
	~<¡dio.h
>

35 
	~<¡ršg.h
>

36 
	~<¡dlib.h
>

37 
	~<sigÇl.h
>

38 
	~<uni¡d.h
>

39 
	~<time.h
>

40 
	~<ùy³.h
>

41 
	~<”ºo.h
>

42 
	~<sys/¡©.h
>

43 
	~<sys/time.h
>

44 
	~<as£¹.h
>

45 
	~<fú.h
>

46 
	~<lim™s.h
>

47 
	~<m©h.h
>

49 
	~<hœedis.h
>

50 
	~<sds.h
>

51 
	~"zm®loc.h
"

52 
	~"lš’oi£.h
"

53 
	~"h–p.h
"

54 
	~"ª‘.h
"

55 
	~"«.h
"

57 
	#UNUSED
(
V
è((èV)

	)

59 
	#OUTPUT_STANDARD
 0

	)

60 
	#OUTPUT_RAW
 1

	)

61 
	#OUTPUT_CSV
 2

	)

62 
	#REDIS_CLI_KEEPALIVE_INTERVAL
 15

	)

63 
	#REDIS_CLI_DEFAULT_PIPE_TIMEOUT
 30

	)

64 
	#REDIS_CLI_HISTFILE_ENV
 "REDISCLI_HISTFILE"

	)

65 
	#REDIS_CLI_HISTFILE_DEFAULT
 ".»disşi_hi¡Üy"

	)

66 
	#REDIS_CLI_RCFILE_ENV
 "REDISCLI_RCFILE"

	)

67 
	#REDIS_CLI_RCFILE_DEFAULT
 ".»disşœc"

	)

70 
	g¥eùrum_·Ë‰e_cŞÜ_size
 = 19;

71 
	g¥eùrum_·Ë‰e_cŞÜ
[] = {0,233,234,235,237,239,241,243,245,247,144,143,142,184,226,214,208,202,196};

73 
	g¥eùrum_·Ë‰e_mÚo_size
 = 13;

74 
	g¥eùrum_·Ë‰e_mÚo
[] = {0,233,234,235,237,239,241,243,245,247,249,251,253};

77 *
	g¥eùrum_·Ë‰e
;

78 
	g¥eùrum_·Ë‰e_size
;

80 
»disCÚ‹xt
 *
	gcÚ‹xt
;

81 
	scÚfig
 {

82 *
	mho¡
;

83 
	mho¡pÜt
;

84 *
	mho¡sock‘
;

85 
	m»³©
;

86 
	mš‹rv®
;

87 
	mdbnum
;

88 
	mš‹¿ùive
;

89 
	mshutdown
;

90 
	mmÚ™Ü_mode
;

91 
	mpubsub_mode
;

92 
	mÏ‹ncy_mode
;

93 
	mÏ‹ncy_di¡_mode
;

94 
	mÏ‹ncy_hi¡Üy
;

95 
	mÌu_‹¡_mode
;

96 
	mÌu_‹¡_§m¶e_size
;

97 
	mşu¡”_mode
;

98 
	mşu¡”_»issue_commªd
;

99 
	m¦ave_mode
;

100 
	mpe_mode
;

101 
	mpe_timeout
;

102 
	mg‘rdb_mode
;

103 
	m¡©_mode
;

104 
	msÿn_mode
;

105 
	mšŒšsic_Ï‹ncy_mode
;

106 
	mšŒšsic_Ï‹ncy_du¿tiÚ
;

107 *
	m·‰”n
;

108 *
	mrdb_f’ame
;

109 
	mbigkeys
;

110 
	m¡dš¬g
;

111 *
	mauth
;

112 
	mouut
;

113 
sds
 
	mmb_d–im
;

114 
	m´om±
[128];

115 *
	mev®
;

116 
	mev®_ldb
;

117 
	mev®_ldb_sync
;

118 
	mev®_ldb_’d
;

119 
	m’abË_ldb_Ú_ev®
;

120 
	mÏ¡_cmd_ty³
;

121 } 
	gcÚfig
;

124 
	s´ef
 {

125 
	mhšts
;

126 } 
	g´ef
;

128 vŞ©
sig_©omic_t
 
	gfÜû_ÿnûl_loİ
 = 0;

129 
u§ge
();

130 
¦aveMode
();

131 *
»disG™SHA1
();

132 *
»disG™Dœty
();

133 
şiCÚÃù
(
fÜû
);

139 
	$u¡ime
() {

140 
timev®
 
tv
;

141 
u¡
;

143 
	`g‘timeofday
(&
tv
, 
NULL
);

144 
u¡
 = (()
tv
.
tv_£c
)*1000000;

145 
u¡
 +ğ
tv
.
tv_u£c
;

146  
u¡
;

147 
	}
}

149 
	$m¡ime
() {

150  
	`u¡ime
()/1000;

151 
	}
}

153 
	$şiReäeshProm±
() {

154 
Ën
;

156 ià(
cÚfig
.
ev®_ldb
) ;

157 ià(
cÚfig
.
ho¡sock‘
 !ğ
NULL
)

158 
Ën
 = 
	`¢´štf
(
cÚfig
.
´om±
,(config.prompt),"redis %s",

159 
cÚfig
.
ho¡sock‘
);

161 
Ën
 = 
	`ª‘FÜm©Addr
(
cÚfig
.
´om±
, (config.prompt),

162 
cÚfig
.
ho¡
, cÚfig.
ho¡pÜt
);

164 ià(
cÚfig
.
dbnum
 != 0)

165 
Ën
 +ğ
	`¢´štf
(
cÚfig
.
´om±
+len,(config.prompt)-len,"[%d]",

166 
cÚfig
.
dbnum
);

167 
	`¢´štf
(
cÚfig
.
´om±
+
Ën
,(config.prompt)-len,"> ");

168 
	}
}

178 
sds
 
	$g‘DÙfeP©h
(*
’vov”ride
, *
dÙf’ame
) {

179 *
·th
 = 
NULL
;

180 
sds
 
dÙP©h
 = 
NULL
;

183 
·th
 = 
	`g‘’v
(
’vov”ride
);

184 ià(
·th
 !ğ
NULL
 && *path != '\0') {

185 ià(!
	`¡rcmp
("/dev/nuÎ", 
·th
)) {

186  
NULL
;

190 
dÙP©h
 = 
	`sd¢ew
(
·th
);

192 *
home
 = 
	`g‘’v
("HOME");

193 ià(
home
 !ğ
NULL
 && *home != '\0') {

195 
dÙP©h
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s/%s", 
home
, 
dÙf’ame
);

198  
dÙP©h
;

199 
	}
}

205 
	#CLI_HELP_COMMAND
 1

	)

206 
	#CLI_HELP_GROUP
 2

	)

209 
	mty³
;

210 
	m¬gc
;

211 
sds
 *
	m¬gv
;

212 
sds
 
	mfuÎ
;

215 
commªdH–p
 *
	mÜg
;

216 } 
	th–pEÁry
;

218 
h–pEÁry
 *
	gh–pEÁr›s
;

219 
	gh–pEÁr›sL’
;

221 
sds
 
	$şiV”siÚ
() {

222 
sds
 
v”siÚ
;

223 
v”siÚ
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s", 
REDIS_VERSION
);

226 ià(
	`¡¹Şl
(
	`»disG™SHA1
(),
NULL
,16)) {

227 
v”siÚ
 = 
	`sdsÿrštf
(v”siÚ, " (g™:%s", 
	`»disG™SHA1
());

228 ià(
	`¡¹Şl
(
	`»disG™Dœty
(),
NULL
,10))

229 
v”siÚ
 = 
	`sdsÿrštf
(version, "-dirty");

230 
v”siÚ
 = 
	`sdsÿt
(version, ")");

232  
v”siÚ
;

233 
	}
}

235 
	$şiIn™H–p
() {

236 
commªd¦’
 = (
commªdH–p
)/(commandHelp);

237 
group¦’
 = (
commªdGroups
)/(*);

238 
i
, 
Ën
, 
pos
 = 0;

239 
h–pEÁry
 
tmp
;

241 
h–pEÁr›sL’
 = 
Ën
 = 
commªd¦’
+
group¦’
;

242 
h–pEÁr›s
 = 
	`zm®loc
((
h–pEÁry
)*
Ën
);

244 
i
 = 0; i < 
group¦’
; i++) {

245 
tmp
.
¬gc
 = 1;

246 
tmp
.
¬gv
 = 
	`zm®loc
((
sds
));

247 
tmp
.
¬gv
[0] = 
	`sdsÿrštf
(
	`sd£m±y
(),"@%s",
commªdGroups
[
i
]);

248 
tmp
.
fuÎ
 =mp.
¬gv
[0];

249 
tmp
.
ty³
 = 
CLI_HELP_GROUP
;

250 
tmp
.
Üg
 = 
NULL
;

251 
h–pEÁr›s
[
pos
++] = 
tmp
;

254 
i
 = 0; i < 
commªd¦’
; i++) {

255 
tmp
.
¬gv
 = 
	`sds¥l™¬gs
(
commªdH–p
[
i
].
Çme
,&tmp.
¬gc
);

256 
tmp
.
fuÎ
 = 
	`sd¢ew
(
commªdH–p
[
i
].
Çme
);

257 
tmp
.
ty³
 = 
CLI_HELP_COMMAND
;

258 
tmp
.
Üg
 = &
commªdH–p
[
i
];

259 
h–pEÁr›s
[
pos
++] = 
tmp
;

261 
	}
}

268 
	$şiIÁeg¿‹H–p
() {

269 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
) ;

271 
»disR•ly
 *
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "COMMAND");

272 if(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ARRAY
) ;

276 
size_t
 
j
 = 0; j < 
»¶y
->
–em’ts
; j++) {

277 
»disR•ly
 *
’Œy
 = 
»¶y
->
–em’t
[
j
];

278 *
cmdÇme
 = 
’Œy
->
–em’t
[0]->
¡r
;

279 
i
;

281 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

282 
h–pEÁry
 *
he
 = 
h–pEÁr›s
+
i
;

283 ià(!
	`¡rÿ£cmp
(
he
->
¬gv
[0],
cmdÇme
))

286 ià(
i
 !ğ
h–pEÁr›sL’
) ;

288 
h–pEÁr›sL’
++;

289 
h–pEÁr›s
 = 
	`z»®loc
(h–pEÁr›s,(
h–pEÁry
)*
h–pEÁr›sL’
);

290 
h–pEÁry
 *
Ãw
 = 
h–pEÁr›s
+(
h–pEÁr›sL’
-1);

292 
Ãw
->
¬gc
 = 1;

293 
Ãw
->
¬gv
 = 
	`zm®loc
((
sds
));

294 
Ãw
->
¬gv
[0] = 
	`sd¢ew
(
cmdÇme
);

295 
Ãw
->
fuÎ
 =‚ew->
¬gv
[0];

296 
Ãw
->
ty³
 = 
CLI_HELP_COMMAND
;

297 
	`sd¡ouµ”
(
Ãw
->
¬gv
[0]);

299 
commªdH–p
 *
ch
 = 
	`zm®loc
((*ch));

300 
ch
->
Çme
 = 
Ãw
->
¬gv
[0];

301 
ch
->
·¿ms
 = 
	`sd£m±y
();

302 
¬gs
 = 
	`Îabs
(
’Œy
->
–em’t
[1]->
š‹g”
);

303 ià(
’Œy
->
–em’t
[3]->
š‹g”
 == 1) {

304 
ch
->
·¿ms
 = 
	`sdsÿt
(ch->params,"key ");

305 
¬gs
--;

307 
¬gs
--è
ch
->
·¿ms
 = 
	`sdsÿt
(ch->params,"arg ");

308 ià(
’Œy
->
–em’t
[1]->
š‹g”
 < 0)

309 
ch
->
·¿ms
 = 
	`sdsÿt
(ch->params,"...options...");

310 
ch
->
summ¬y
 = "Help‚ot‡vailable";

311 
ch
->
group
 = 0;

312 
ch
->
sšû
 = "not known";

313 
Ãw
->
Üg
 = 
ch
;

315 
	`ä“R•lyObjeù
(
»¶y
);

316 
	}
}

319 
	$şiOuutCommªdH–p
(
commªdH–p
 *
h–p
, 
group
) {

320 
	`´štf
("\r\À \x1b[1m%s\x1b[0m \x1b[90m%s\x1b[0m\r\n", 
h–p
->
Çme
, h–p->
·¿ms
);

321 
	`´štf
(" \x1b[33msumm¬y:\x1b[0m %s\r\n", 
h–p
->
summ¬y
);

322 
	`´štf
(" \x1b[33msšû:\x1b[0m %s\r\n", 
h–p
->
sšû
);

323 ià(
group
) {

324 
	`´štf
(" \x1b[33mgroup:\x1b[0m %s\r\n", 
commªdGroups
[
h–p
->
group
]);

326 
	}
}

329 
	$şiOuutG’”icH–p
() {

330 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

331 
	`´štf
(

343 
v”siÚ


345 
	`sdsä“
(
v”siÚ
);

346 
	}
}

349 
	$şiOuutH–p
(
¬gc
, **
¬gv
) {

350 
i
, 
j
, 
Ën
;

351 
group
 = -1;

352 
h–pEÁry
 *
’Œy
;

353 
commªdH–p
 *
h–p
;

355 ià(
¬gc
 == 0) {

356 
	`şiOuutG’”icH–p
();

358 } ià(
¬gc
 > 0 && 
¬gv
[0][0] == '@') {

359 
Ën
 = (
commªdGroups
)/(*);

360 
i
 = 0; i < 
Ën
; i++) {

361 ià(
	`¡rÿ£cmp
(
¬gv
[0]+1,
commªdGroups
[
i
]) == 0) {

362 
group
 = 
i
;

368 
	`as£¹
(
¬gc
 > 0);

369 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

370 
’Œy
 = &
h–pEÁr›s
[
i
];

371 ià(
’Œy
->
ty³
 !ğ
CLI_HELP_COMMAND
) ;

373 
h–p
 = 
’Œy
->
Üg
;

374 ià(
group
 == -1) {

376 ià(
¬gc
 =ğ
’Œy
->argc) {

377 
j
 = 0; j < 
¬gc
; j++) {

378 ià(
	`¡rÿ£cmp
(
¬gv
[
j
],
’Œy
->argv[j]) != 0) ;

380 ià(
j
 =ğ
¬gc
) {

381 
	`şiOuutCommªdH–p
(
h–p
,1);

385 ià(
group
 =ğ
h–p
->group) {

386 
	`şiOuutCommªdH–p
(
h–p
,0);

390 
	`´štf
("\r\n");

391 
	}
}

394 
	$com¶‘iÚC®lback
(cÚ¡ *
buf
, 
lš’oi£Com¶‘iÚs
 *
lc
) {

395 
size_t
 
¡¬os
 = 0;

396 
mask
;

397 
i
;

398 
size_t
 
m©chËn
;

399 
sds
 
tmp
;

401 ià(
	`¡ºÿ£cmp
(
buf
,"help ",5) == 0) {

402 
¡¬os
 = 5;

403 
	`is¥aû
(
buf
[
¡¬os
])) startpos++;

404 
mask
 = 
CLI_HELP_COMMAND
 | 
CLI_HELP_GROUP
;

406 
mask
 = 
CLI_HELP_COMMAND
;

409 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

410 ià(!(
h–pEÁr›s
[
i
].
ty³
 & 
mask
)) ;

412 
m©chËn
 = 
	`¡¾’
(
buf
+
¡¬os
);

413 ià(
	`¡ºÿ£cmp
(
buf
+
¡¬os
,
h–pEÁr›s
[
i
].
fuÎ
,
m©chËn
) == 0) {

414 
tmp
 = 
	`sd¢ewËn
(
buf
,
¡¬os
);

415 
tmp
 = 
	`sdsÿt
Ñmp,
h–pEÁr›s
[
i
].
fuÎ
);

416 
	`lš’oi£AddCom¶‘iÚ
(
lc
,
tmp
);

417 
	`sdsä“
(
tmp
);

420 
	}
}

423 *
	$hštsC®lback
(cÚ¡ *
buf
, *
cŞÜ
, *
bŞd
) {

424 ià(!
´ef
.
hšts
è 
NULL
;

426 
i
, 
¬gc
, 
buæ’
 = 
	`¡¾’
(
buf
);

427 
sds
 *
¬gv
 = 
	`sds¥l™¬gs
(
buf
,&
¬gc
);

428 
’d¥aû
 = 
buæ’
 && 
	`is¥aû
(
buf
[buflen-1]);

431 ià(
¬gc
 == 0) {

432 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

433  
NULL
;

436 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

437 ià(!(
h–pEÁr›s
[
i
].
ty³
 & 
CLI_HELP_COMMAND
)) ;

439 ià(
	`¡rÿ£cmp
(
¬gv
[0],
h–pEÁr›s
[
i
].
fuÎ
) == 0)

441 *
cŞÜ
 = 90;

442 *
bŞd
 = 0;

443 
sds
 
hšt
 = 
	`sd¢ew
(
h–pEÁr›s
[
i
].
Üg
->
·¿ms
);

447 
tÜemove
 = 
¬gc
-1;

448 
tÜemove
 > 0 && 
	`sd¦’
(
hšt
)) {

449 ià(
hšt
[0] == '[') ;

450 ià(
hšt
[0] =ğ' 'è
tÜemove
--;

451 
	`sd¤ªge
(
hšt
,1,-1);

455 ià(!
’d¥aû
) {

456 
sds
 
Ãwhšt
 = 
	`sd¢ewËn
(" ",1);

457 
Ãwhšt
 = 
	`sdsÿtsds
Òewhšt,
hšt
);

458 
	`sdsä“
(
hšt
);

459 
hšt
 = 
Ãwhšt
;

462 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

463  
hšt
;

466 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

467  
NULL
;

468 
	}
}

470 
	$ä“HštsC®lback
(*
±r
) {

471 
	`sdsä“
(
±r
);

472 
	}
}

479 
	$şiAuth
() {

480 
»disR•ly
 *
»¶y
;

481 ià(
cÚfig
.
auth
 =ğ
NULL
è 
REDIS_OK
;

483 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"AUTH %s",
cÚfig
.
auth
);

484 ià(
»¶y
 !ğ
NULL
) {

485 
	`ä“R•lyObjeù
(
»¶y
);

486  
REDIS_OK
;

488  
REDIS_ERR
;

489 
	}
}

492 
	$şiS–eù
() {

493 
»disR•ly
 *
»¶y
;

494 ià(
cÚfig
.
dbnum
 =ğ0è 
REDIS_OK
;

496 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SELECT %d",
cÚfig
.
dbnum
);

497 ià(
»¶y
 !ğ
NULL
) {

498 
»suÉ
 = 
REDIS_OK
;

499 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
è
»suÉ
 = 
REDIS_ERR
;

500 
	`ä“R•lyObjeù
(
»¶y
);

501  
»suÉ
;

503  
REDIS_ERR
;

504 
	}
}

508 
	$şiCÚÃù
(
fÜû
) {

509 ià(
cÚ‹xt
 =ğ
NULL
 || 
fÜû
) {

510 ià(
cÚ‹xt
 !ğ
NULL
) {

511 
	`»disF»e
(
cÚ‹xt
);

514 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

515 
cÚ‹xt
 = 
	`»disCÚÃù
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

517 
cÚ‹xt
 = 
	`»disCÚÃùUnix
(
cÚfig
.
ho¡sock‘
);

520 ià(
cÚ‹xt
->
”r
) {

521 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

522 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

523 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
cÚ‹xt
->
”r¡r
);

525 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
cÚ‹xt
->
”r¡r
);

526 
	`»disF»e
(
cÚ‹xt
);

527 
cÚ‹xt
 = 
NULL
;

528  
REDIS_ERR
;

535 
	`ª‘K“pAlive
(
NULL
, 
cÚ‹xt
->
fd
, 
REDIS_CLI_KEEPALIVE_INTERVAL
);

538 ià(
	`şiAuth
(è!ğ
REDIS_OK
)

539  
REDIS_ERR
;

540 ià(
	`şiS–eù
(è!ğ
REDIS_OK
)

541  
REDIS_ERR
;

543  
REDIS_OK
;

544 
	}
}

546 
	$şiPrštCÚ‹xtE¼Ü
() {

547 ià(
cÚ‹xt
 =ğ
NULL
) ;

548 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
cÚ‹xt
->
”r¡r
);

549 
	}
}

551 
sds
 
	$şiFÜm©R•lyTTY
(
»disR•ly
 *
r
, *
´efix
) {

552 
sds
 
out
 = 
	`sd£m±y
();

553 
r
->
ty³
) {

554 
REDIS_REPLY_ERROR
:

555 
out
 = 
	`sdsÿrštf
(out,"Ó¼Üè%s\n", 
r
->
¡r
);

557 
REDIS_REPLY_STATUS
:

558 
out
 = 
	`sdsÿt
(out,
r
->
¡r
);

559 
out
 = 
	`sdsÿt
(out,"\n");

561 
REDIS_REPLY_INTEGER
:

562 
out
 = 
	`sdsÿrštf
(out,"(š‹g”è%Îd\n",
r
->
š‹g”
);

564 
REDIS_REPLY_STRING
:

567 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

568 
out
 = 
	`sdsÿt
(out,"\n");

570 
REDIS_REPLY_NIL
:

571 
out
 = 
	`sdsÿt
(out,"(nil)\n");

573 
REDIS_REPLY_ARRAY
:

574 ià(
r
->
–em’ts
 == 0) {

575 
out
 = 
	`sdsÿt
(out,"(empty†ist or set)\n");

577 
i
, 
idxËn
 = 0;

578 
_´efixËn
[16];

579 
_´efixfmt
[16];

580 
sds
 
_´efix
;

581 
sds
 
tmp
;

584 
i
 = 
r
->
–em’ts
;

586 
idxËn
++;

587 
i
 /= 10;

588 } 
i
);

591 
	`mem£t
(
_´efixËn
,' ',
idxËn
+2);

592 
_´efixËn
[
idxËn
+2] = '\0';

593 
_´efix
 = 
	`sdsÿt
(
	`sd¢ew
(
´efix
),
_´efixËn
);

596 
	`¢´štf
(
_´efixfmt
,(_´efixfmt),"%%s%%%udè",
idxËn
);

598 
i
 = 0; i < 
r
->
–em’ts
; i++) {

601 
out
 = 
	`sdsÿrštf
(out,
_´efixfmt
,
i
 =ğ0 ? "" : 
´efix
,i+1);

604 
tmp
 = 
	`şiFÜm©R•lyTTY
(
r
->
–em’t
[
i
],
_´efix
);

605 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

606 
	`sdsä“
(
tmp
);

608 
	`sdsä“
(
_´efix
);

612 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

613 
	`ex™
(1);

615  
out
;

616 
	}
}

618 
	$isCŞÜT”m
() {

619 *
t
 = 
	`g‘’v
("TERM");

620  
t
 !ğ
NULL
 && 
	`¡r¡r
(t,"xterm") != NULL;

621 
	}
}

625 
sds
 
	$sdsÿtcŞÜ
(
sds
 
o
, *
s
, 
size_t
 
Ën
, *
cŞÜ
) {

626 ià(!
	`isCŞÜT”m
()è 
	`sdsÿ’
(
o
,
s
,
Ën
);

628 
bŞd
 = 
	`¡r¡r
(
cŞÜ
,"bŞd"è!ğ
NULL
;

629 
ccode
 = 37;

630 ià(
	`¡r¡r
(
cŞÜ
,"»d")è
ccode
 = 31;

631 ià(
	`¡r¡r
(
cŞÜ
,"»d")è
ccode
 = 31;

632 ià(
	`¡r¡r
(
cŞÜ
,"g»’")è
ccode
 = 32;

633 ià(
	`¡r¡r
(
cŞÜ
,"y–low")è
ccode
 = 33;

634 ià(
	`¡r¡r
(
cŞÜ
,"blue")è
ccode
 = 34;

635 ià(
	`¡r¡r
(
cŞÜ
,"mag’")è
ccode
 = 35;

636 ià(
	`¡r¡r
(
cŞÜ
,"cyª")è
ccode
 = 36;

637 ià(
	`¡r¡r
(
cŞÜ
,"wh™e")è
ccode
 = 37;

639 
o
 = 
	`sdsÿtfmt
(o,"\033[%i;%i;49m",
bŞd
,
ccode
);

640 
o
 = 
	`sdsÿ’
(o,
s
,
Ën
);

641 
o
 = 
	`sdsÿt
(o,"\033[0m");

642  
o
;

643 
	}
}

647 
sds
 
	$sdsC©CŞÜizedLdbR•ly
(
sds
 
o
, *
s
, 
size_t
 
Ën
) {

648 *
cŞÜ
 = "white";

650 ià(
	`¡r¡r
(
s
,"<debug>")è
cŞÜ
 = "bold";

651 ià(
	`¡r¡r
(
s
,"<»dis>")è
cŞÜ
 = "green";

652 ià(
	`¡r¡r
(
s
,"<»¶y>")è
cŞÜ
 = "cyan";

653 ià(
	`¡r¡r
(
s
,"<”rÜ>")è
cŞÜ
 = "red";

654 ià(
	`¡r¡r
(
s
,"<hšt>")è
cŞÜ
 = "bold";

655 ià(
	`¡r¡r
(
s
,"<v®ue>"è|| sŒ¡r(s,"<»tv®>")è
cŞÜ
 = "magenta";

656 ià(
Ën
 > 4 && 
	`isdig™
(
s
[3])) {

657 ià(
s
[1] =ğ'>'è
cŞÜ
 = "yellow";

658 ià(
s
[2] =ğ'#'è
cŞÜ
 = "bold";

660  
	`sdsÿtcŞÜ
(
o
,
s
,
Ën
,
cŞÜ
);

661 
	}
}

663 
sds
 
	$şiFÜm©R•lyRaw
(
»disR•ly
 *
r
) {

664 
sds
 
out
 = 
	`sd£m±y
(), 
tmp
;

665 
size_t
 
i
;

667 
r
->
ty³
) {

668 
REDIS_REPLY_NIL
:

671 
REDIS_REPLY_ERROR
:

672 
out
 = 
	`sdsÿ’
(out,
r
->
¡r
,r->
Ën
);

673 
out
 = 
	`sdsÿ’
(out,"\n",1);

675 
REDIS_REPLY_STATUS
:

676 
REDIS_REPLY_STRING
:

677 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STATUS
 && 
cÚfig
.
ev®_ldb
) {

683 ià(
	`¡r¡r
(
r
->
¡r
,"<endsession>") ==„->str) {

684 
cÚfig
.
’abË_ldb_Ú_ev®
 = 0;

685 
cÚfig
.
ev®_ldb
 = 0;

686 
cÚfig
.
ev®_ldb_’d
 = 1;

687 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

688 
	`şiReäeshProm±
();

690 
out
 = 
	`sdsC©CŞÜizedLdbR•ly
(out,
r
->
¡r
,r->
Ën
);

693 
out
 = 
	`sdsÿ’
(out,
r
->
¡r
,r->
Ën
);

696 
REDIS_REPLY_INTEGER
:

697 
out
 = 
	`sdsÿrštf
(out,"%Îd",
r
->
š‹g”
);

699 
REDIS_REPLY_ARRAY
:

700 
i
 = 0; i < 
r
->
–em’ts
; i++) {

701 ià(
i
 > 0è
out
 = 
	`sdsÿt
(out,
cÚfig
.
mb_d–im
);

702 
tmp
 = 
	`şiFÜm©R•lyRaw
(
r
->
–em’t
[
i
]);

703 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

704 
	`sdsä“
(
tmp
);

708 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

709 
	`ex™
(1);

711  
out
;

712 
	}
}

714 
sds
 
	$şiFÜm©R•lyCSV
(
»disR•ly
 *
r
) {

715 
i
;

717 
sds
 
out
 = 
	`sd£m±y
();

718 
r
->
ty³
) {

719 
REDIS_REPLY_ERROR
:

720 
out
 = 
	`sdsÿt
(out,"ERROR,");

721 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,
	`¡¾’
(r->str));

723 
REDIS_REPLY_STATUS
:

724 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

726 
REDIS_REPLY_INTEGER
:

727 
out
 = 
	`sdsÿrštf
(out,"%Îd",
r
->
š‹g”
);

729 
REDIS_REPLY_STRING
:

730 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

732 
REDIS_REPLY_NIL
:

733 
out
 = 
	`sdsÿt
(out,"NIL");

735 
REDIS_REPLY_ARRAY
:

736 
i
 = 0; i < 
r
->
–em’ts
; i++) {

737 
sds
 
tmp
 = 
	`şiFÜm©R•lyCSV
(
r
->
–em’t
[
i
]);

738 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

739 ià(
i
 !ğ
r
->
–em’ts
-1è
out
 = 
	`sdsÿt
(out,",");

740 
	`sdsä“
(
tmp
);

744 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

745 
	`ex™
(1);

747  
out
;

748 
	}
}

750 
	$şiR—dR•ly
(
ouut_¿w_¡ršgs
) {

751 *
_»¶y
;

752 
»disR•ly
 *
»¶y
;

753 
sds
 
out
 = 
NULL
;

754 
ouut
 = 1;

756 ià(
	`»disG‘R•ly
(
cÚ‹xt
,&
_»¶y
è!ğ
REDIS_OK
) {

757 ià(
cÚfig
.
shutdown
) {

758 
	`»disF»e
(
cÚ‹xt
);

759 
cÚ‹xt
 = 
NULL
;

760  
REDIS_OK
;

762 ià(
cÚfig
.
š‹¿ùive
) {

764 ià(
cÚ‹xt
->
”r
 =ğ
REDIS_ERR_IO
 &&

765 (
”ºo
 =ğ
ECONNRESET
 ||ƒ¼nØ=ğ
EPIPE
))

766  
REDIS_ERR
;

767 ià(
cÚ‹xt
->
”r
 =ğ
REDIS_ERR_EOF
)

768  
REDIS_ERR
;

770 
	`şiPrštCÚ‹xtE¼Ü
();

771 
	`ex™
(1);

772  
REDIS_ERR
;

775 
»¶y
 = (
»disR•ly
*)
_»¶y
;

777 
cÚfig
.
Ï¡_cmd_ty³
 = 
»¶y
->
ty³
;

781 ià(
cÚfig
.
şu¡”_mode
 && 
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
 &&

782 (!
	`¡ºcmp
(
»¶y
->
¡r
,"MOVED",5è|| !
	`¡rcmp
(reply->str,"ASK")))

784 *
p
 = 
»¶y
->
¡r
, *
s
;

785 
¦Ù
;

787 
ouut
 = 0;

793 
s
 = 
	`¡rchr
(
p
,' ');

794 
p
 = 
	`¡rchr
(
s
+1,' ');

795 *
p
 = '\0';

796 
¦Ù
 = 
	`©oi
(
s
+1);

797 
s
 = 
	`¡¼chr
(
p
+1,':');

798 *
s
 = '\0';

799 
	`sdsä“
(
cÚfig
.
ho¡
);

800 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
p
+1);

801 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
s
+1);

802 ià(
cÚfig
.
š‹¿ùive
)

803 
	`´štf
("-> Redirectedo slot [%d]†ocated‡t %s:%d\n",

804 
¦Ù
, 
cÚfig
.
ho¡
, cÚfig.
ho¡pÜt
);

805 
cÚfig
.
şu¡”_»issue_commªd
 = 1;

806 
	`şiReäeshProm±
();

809 ià(
ouut
) {

810 ià(
ouut_¿w_¡ršgs
) {

811 
out
 = 
	`şiFÜm©R•lyRaw
(
»¶y
);

813 ià(
cÚfig
.
ouut
 =ğ
OUTPUT_RAW
) {

814 
out
 = 
	`şiFÜm©R•lyRaw
(
»¶y
);

815 
out
 = 
	`sdsÿt
(out,"\n");

816 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_STANDARD
) {

817 
out
 = 
	`şiFÜm©R•lyTTY
(
»¶y
,"");

818 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_CSV
) {

819 
out
 = 
	`şiFÜm©R•lyCSV
(
»¶y
);

820 
out
 = 
	`sdsÿt
(out,"\n");

823 
	`fwr™e
(
out
,
	`sd¦’
(out),1,
¡dout
);

824 
	`sdsä“
(
out
);

826 
	`ä“R•lyObjeù
(
»¶y
);

827  
REDIS_OK
;

828 
	}
}

830 
	$şiS’dCommªd
(
¬gc
, **
¬gv
, 
»³©
) {

831 *
commªd
 = 
¬gv
[0];

832 
size_t
 *
¬gvËn
;

833 
j
, 
ouut_¿w
;

835 ià(!
cÚfig
.
ev®_ldb
 &&

836 (!
	`¡rÿ£cmp
(
commªd
,"help") || !strcasecmp(command,"?"))) {

837 
	`şiOuutH–p
(--
¬gc
, ++
¬gv
);

838  
REDIS_OK
;

841 ià(
cÚ‹xt
 =ğ
NULL
è 
REDIS_ERR
;

843 
ouut_¿w
 = 0;

844 ià(!
	`¡rÿ£cmp
(
commªd
,"info") ||

845 (
¬gc
 >ğ2 && !
	`¡rÿ£cmp
(
commªd
,"debug") &&

846 ((!
	`¡rÿ£cmp
(
¬gv
[1],"jemalloc") && !strcasecmp(argv[2],"info")) ||

847 !
	`¡rÿ£cmp
(
¬gv
[1],"htstats"))) ||

848 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"cluster") &&

849 (!
	`¡rÿ£cmp
(
¬gv
[1],"nodes") ||

850 !
	`¡rÿ£cmp
(
¬gv
[1],"info"))) ||

851 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"client") &&

852 !
	`¡rÿ£cmp
(
¬gv
[1],"list")) ||

853 (
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
commªd
,"latency") &&

854 !
	`¡rÿ£cmp
(
¬gv
[1],"graph")) ||

855 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"latency") &&

856 !
	`¡rÿ£cmp
(
¬gv
[1],"doctor")))

858 
ouut_¿w
 = 1;

861 ià(!
	`¡rÿ£cmp
(
commªd
,"shutdown")è
cÚfig
.
shutdown
 = 1;

862 ià(!
	`¡rÿ£cmp
(
commªd
,"mÚ™Ü")è
cÚfig
.
mÚ™Ü_mode
 = 1;

863 ià(!
	`¡rÿ£cmp
(
commªd
,"subscribe") ||

864 !
	`¡rÿ£cmp
(
commªd
,"psubsüibe")è
cÚfig
.
pubsub_mode
 = 1;

865 ià(!
	`¡rÿ£cmp
(
commªd
,"sync") ||

866 !
	`¡rÿ£cmp
(
commªd
,"psync")è
cÚfig
.
¦ave_mode
 = 1;

870 ià(
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
¬gv
[0],"script") &&

871 !
	`¡rÿ£cmp
(
¬gv
[1],"debug"))

873 ià(!
	`¡rÿ£cmp
(
¬gv
[2],"yes") || !strcasecmp(argv[2],"sync")) {

874 
cÚfig
.
’abË_ldb_Ú_ev®
 = 1;

876 
cÚfig
.
’abË_ldb_Ú_ev®
 = 0;

881 ià(!
	`¡rÿ£cmp
(
commªd
,"ev®"è&& 
cÚfig
.
’abË_ldb_Ú_ev®
) {

882 
cÚfig
.
ev®_ldb
 = 1;

883 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

887 
¬gvËn
 = 
	`zm®loc
(
¬gc
*(
size_t
));

888 
j
 = 0; j < 
¬gc
; j++)

889 
¬gvËn
[
j
] = 
	`sd¦’
(
¬gv
[j]);

891 
»³©
--) {

892 
	`»disAµ’dCommªdArgv
(
cÚ‹xt
,
¬gc
,(cÚ¡ **)
¬gv
,
¬gvËn
);

893 
cÚfig
.
mÚ™Ü_mode
) {

894 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
è
	`ex™
(1);

895 
	`fæush
(
¡dout
);

898 ià(
cÚfig
.
pubsub_mode
) {

899 ià(
cÚfig
.
ouut
 !ğ
OUTPUT_RAW
)

900 
	`´štf
("Reading messages... (press Ctrl-Co quit)\n");

902 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
è
	`ex™
(1);

906 ià(
cÚfig
.
¦ave_mode
) {

907 
	`´štf
("Entering slave output mode... (press Ctrl-Co quit)\n");

908 
	`¦aveMode
();

909 
cÚfig
.
¦ave_mode
 = 0;

910 
	`zä“
(
¬gvËn
);

911  
REDIS_ERR
;

914 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
) {

915 
	`zä“
(
¬gvËn
);

916  
REDIS_ERR
;

919 ià(!
	`¡rÿ£cmp
(
commªd
,"£Ëù"è&& 
¬gc
 =ğ2 && 
cÚfig
.
Ï¡_cmd_ty³
 !ğ
REDIS_REPLY_ERROR
) {

920 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[1]);

921 
	`şiReäeshProm±
();

922 } ià(!
	`¡rÿ£cmp
(
commªd
,"auth"è&& 
¬gc
 == 2) {

923 
	`şiS–eù
();

926 ià(
cÚfig
.
š‹rv®
è
	`u¦“p
(config.interval);

927 
	`fæush
(
¡dout
);

930 
	`zä“
(
¬gvËn
);

931  
REDIS_OK
;

932 
	}
}

935 
»disR•ly
 *
	$»cÚÃùšgRedisCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fmt
, ...) {

936 
»disR•ly
 *
»¶y
 = 
NULL
;

937 
Œ›s
 = 0;

938 
va_li¡
 
­
;

940 
	`as£¹
(!
c
->
”r
);

941 
»¶y
 =ğ
NULL
) {

942 
c
->
”r
 & (
REDIS_ERR_IO
 | 
REDIS_ERR_EOF
)) {

943 
	`´štf
("\r\x1b[0K");

944 
	`´štf
("RecÚÃùšg... %d\r", ++
Œ›s
);

945 
	`fæush
(
¡dout
);

947 
	`»disF»e
(
c
);

948 
c
 = 
	`»disCÚÃù
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

949 
	`u¦“p
(1000000);

952 
	`va_¡¬t
(
­
,
fmt
);

953 
»¶y
 = 
	`»disvCommªd
(
c
,
fmt
,
­
);

954 
	`va_’d
(
­
);

956 ià(
c
->
”r
 && !(c->”¸& (
REDIS_ERR_IO
 | 
REDIS_ERR_EOF
))) {

957 
	`årštf
(
¡d”r
, "E¼Ü: %s\n", 
c
->
”r¡r
);

958 
	`ex™
(1);

959 } ià(
Œ›s
 > 0) {

960 
	`´štf
("\r\x1b[0K");

964 
cÚ‹xt
 = 
c
;

965  
»¶y
;

966 
	}
}

972 
	$·r£O±iÚs
(
¬gc
, **
¬gv
) {

973 
i
;

975 
i
 = 1; i < 
¬gc
; i++) {

976 
Ï¡¬g
 = 
i
==
¬gc
-1;

978 ià(!
	`¡rcmp
(
¬gv
[
i
],"-h"è&& !
Ï¡¬g
) {

979 
	`sdsä“
(
cÚfig
.
ho¡
);

980 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
¬gv
[++
i
]);

981 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h"è&& 
Ï¡¬g
) {

982 
	`u§ge
();

983 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

984 
	`u§ge
();

985 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-x")) {

986 
cÚfig
.
¡dš¬g
 = 1;

987 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p"è&& !
Ï¡¬g
) {

988 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

989 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s"è&& !
Ï¡¬g
) {

990 
cÚfig
.
ho¡sock‘
 = 
¬gv
[++
i
];

991 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r"è&& !
Ï¡¬g
) {

992 
cÚfig
.
»³©
 = 
	`¡¹Şl
(
¬gv
[++
i
],
NULL
,10);

993 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-i"è&& !
Ï¡¬g
) {

994 
£cÚds
 = 
	`©of
(
¬gv
[++
i
]);

995 
cÚfig
.
š‹rv®
 = 
£cÚds
*1000000;

996 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n"è&& !
Ï¡¬g
) {

997 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

998 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a"è&& !
Ï¡¬g
) {

999 
cÚfig
.
auth
 = 
¬gv
[++
i
];

1000 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--raw")) {

1001 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1002 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--no-raw")) {

1003 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

1004 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

1005 
cÚfig
.
ouut
 = 
OUTPUT_CSV
;

1006 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency")) {

1007 
cÚfig
.
Ï‹ncy_mode
 = 1;

1008 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency-dist")) {

1009 
cÚfig
.
Ï‹ncy_di¡_mode
 = 1;

1010 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--mono")) {

1011 
¥eùrum_·Ë‰e
 = 
¥eùrum_·Ë‰e_mÚo
;

1012 
¥eùrum_·Ë‰e_size
 = 
¥eùrum_·Ë‰e_mÚo_size
;

1013 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency-history")) {

1014 
cÚfig
.
Ï‹ncy_mode
 = 1;

1015 
cÚfig
.
Ï‹ncy_hi¡Üy
 = 1;

1016 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--Ìu-‹¡"è&& !
Ï¡¬g
) {

1017 
cÚfig
.
Ìu_‹¡_mode
 = 1;

1018 
cÚfig
.
Ìu_‹¡_§m¶e_size
 = 
	`¡¹Şl
(
¬gv
[++
i
],
NULL
,10);

1019 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--slave")) {

1020 
cÚfig
.
¦ave_mode
 = 1;

1021 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--stat")) {

1022 
cÚfig
.
¡©_mode
 = 1;

1023 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--scan")) {

1024 
cÚfig
.
sÿn_mode
 = 1;

1025 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--·‰”n"è&& !
Ï¡¬g
) {

1026 
cÚfig
.
·‰”n
 = 
¬gv
[++
i
];

1027 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--šŒšsic-Ï‹ncy"è&& !
Ï¡¬g
) {

1028 
cÚfig
.
šŒšsic_Ï‹ncy_mode
 = 1;

1029 
cÚfig
.
šŒšsic_Ï‹ncy_du¿tiÚ
 = 
	`©oi
(
¬gv
[++
i
]);

1030 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--rdb"è&& !
Ï¡¬g
) {

1031 
cÚfig
.
g‘rdb_mode
 = 1;

1032 
cÚfig
.
rdb_f’ame
 = 
¬gv
[++
i
];

1033 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--pipe")) {

1034 
cÚfig
.
pe_mode
 = 1;

1035 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--pe-timeout"è&& !
Ï¡¬g
) {

1036 
cÚfig
.
pe_timeout
 = 
	`©oi
(
¬gv
[++
i
]);

1037 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--bigkeys")) {

1038 
cÚfig
.
bigkeys
 = 1;

1039 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--ev®"è&& !
Ï¡¬g
) {

1040 
cÚfig
.
ev®
 = 
¬gv
[++
i
];

1041 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--ldb")) {

1042 
cÚfig
.
ev®_ldb
 = 1;

1043 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1044 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--ldb-sync-mode")) {

1045 
cÚfig
.
ev®_ldb
 = 1;

1046 
cÚfig
.
ev®_ldb_sync
 = 1;

1047 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1048 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

1049 
cÚfig
.
şu¡”_mode
 = 1;

1050 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d"è&& !
Ï¡¬g
) {

1051 
	`sdsä“
(
cÚfig
.
mb_d–im
);

1052 
cÚfig
.
mb_d–im
 = 
	`sd¢ew
(
¬gv
[++
i
]);

1053 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-v") || !strcmp(argv[i], "--version")) {

1054 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

1055 
	`´štf
("»dis-ş˜%s\n", 
v”siÚ
);

1056 
	`sdsä“
(
v”siÚ
);

1057 
	`ex™
(0);

1059 ià(
¬gv
[
i
][0] == '-') {

1060 
	`årštf
(
¡d”r
,

1062 
¬gv
[
i
]);

1063 
	`ex™
(1);

1072 ià(
cÚfig
.
ev®_ldb
 && cÚfig.
ev®
 =ğ
NULL
) {

1073 
	`årštf
(
¡d”r
,"Options --ldb‡nd --ldb-sync-mode„equire --eval.\n");

1074 
	`årštf
(
¡d”r
,"Try % --h–°fÜ mÜšfÜm©iÚ.\n", 
¬gv
[0]);

1075 
	`ex™
(1);

1077  
i
;

1078 
	}
}

1080 
sds
 
	$»adArgFromStdš
() {

1081 
buf
[1024];

1082 
sds
 
¬g
 = 
	`sd£m±y
();

1085 
Ä—d
 = 
	`»ad
(
	`f’o
(
¡dš
),
buf
,1024);

1087 ià(
Ä—d
 == 0) ;

1088 ià(
Ä—d
 == -1) {

1089 
	`³¼Ü
("Reading from standard input");

1090 
	`ex™
(1);

1092 
¬g
 = 
	`sdsÿ’
×rg,
buf
,
Ä—d
);

1094  
¬g
;

1095 
	}
}

1097 
	$u§ge
() {

1098 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

1099 
	`årštf
(
¡d”r
,

1158 
v”siÚ
, 
REDIS_CLI_DEFAULT_PIPE_TIMEOUT
);

1159 
	`sdsä“
(
v”siÚ
);

1160 
	`ex™
(1);

1161 
	}
}

1164 **
	$cÚv”tToSds
(
couÁ
, ** 
¬gs
) {

1165 
j
;

1166 **
sds
 = 
	`zm®loc
((*)*
couÁ
);

1168 
j
 = 0; j < 
couÁ
; j++)

1169 
sds
[
j
] = 
	`sd¢ew
(
¬gs
[j]);

1171  
sds
;

1172 
	}
}

1174 
	$issueCommªdR•—t
(
¬gc
, **
¬gv
, 
»³©
) {

1176 
cÚfig
.
şu¡”_»issue_commªd
 = 0;

1177 ià(
	`şiS’dCommªd
(
¬gc
,
¬gv
,
»³©
è!ğ
REDIS_OK
) {

1178 
	`şiCÚÃù
(1);

1182 ià(
	`şiS’dCommªd
(
¬gc
,
¬gv
,
»³©
è!ğ
REDIS_OK
) {

1183 
	`şiPrštCÚ‹xtE¼Ü
();

1184  
REDIS_ERR
;

1188 ià(
cÚfig
.
şu¡”_mode
 && cÚfig.
şu¡”_»issue_commªd
) {

1189 
	`şiCÚÃù
(1);

1194  
REDIS_OK
;

1195 
	}
}

1197 
	$issueCommªd
(
¬gc
, **
¬gv
) {

1198  
	`issueCommªdR•—t
(
¬gc
, 
¬gv
, 
cÚfig
.
»³©
);

1199 
	}
}

1207 
sds
 *
	$şiS¶™Args
(*
lše
, *
¬gc
) {

1208 ià(
cÚfig
.
ev®_ldb
 && (
	`¡r¡r
(
lše
,"eval ") ==†ine ||

1209 
	`¡r¡r
(
lše
,"e ") ==†ine))

1211 
sds
 *
¬gv
 = 
	`sds_m®loc
((sds)*2);

1212 *
¬gc
 = 2;

1213 
Ën
 = 
	`¡¾’
(
lše
);

1214 
–’
 = 
lše
[1] == ' ' ? 2 : 5;

1215 
¬gv
[0] = 
	`sd¢ewËn
(
lše
,
–’
-1);

1216 
¬gv
[1] = 
	`sd¢ewËn
(
lše
+
–’
,
Ën
-elen);

1217  
¬gv
;

1219  
	`sds¥l™¬gs
(
lše
,
¬gc
);

1221 
	}
}

1226 
	$şiS‘P»ã»nûs
(**
¬gv
, 
¬gc
, 
š‹¿ùive
) {

1227 ià(!
	`¡rÿ£cmp
(
¬gv
[0],":£t"è&& 
¬gc
 >= 2) {

1228 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"hšts")è
´ef
.
hšts
 = 1;

1229 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"nohšts")è
´ef
.
hšts
 = 0;

1231 
	`´štf
("%sunknown„edis-cli…reference '%s'\n",

1232 
š‹¿ùive
 ? "" : ".redisclirc: ",

1233 
¬gv
[1]);

1236 
	`´štf
("%sunknown„edis-cli internal command '%s'\n",

1237 
š‹¿ùive
 ? "" : ".redisclirc: ",

1238 
¬gv
[0]);

1240 
	}
}

1243 
	$şiLßdP»ã»nûs
() {

1244 
sds
 
rcfe
 = 
	`g‘DÙfeP©h
(
REDIS_CLI_RCFILE_ENV
,
REDIS_CLI_RCFILE_DEFAULT
);

1245 ià(
rcfe
 =ğ
NULL
) ;

1246 
FILE
 *
å
 = 
	`fİ’
(
rcfe
,"r");

1247 
buf
[1024];

1249 ià(
å
) {

1250 
	`fg‘s
(
buf
,(buf),
å
è!ğ
NULL
) {

1251 
sds
 *
¬gv
;

1252 
¬gc
;

1254 
¬gv
 = 
	`sds¥l™¬gs
(
buf
,&
¬gc
);

1255 ià(
¬gc
 > 0è
	`şiS‘P»ã»nûs
(
¬gv
,argc,0);

1256 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1259 
	`sdsä“
(
rcfe
);

1260 
	}
}

1262 
	$»¶
() {

1263 
sds
 
hi¡Üyfe
 = 
NULL
;

1264 
hi¡Üy
 = 0;

1265 *
lše
;

1266 
¬gc
;

1267 
sds
 *
¬gv
;

1269 
cÚfig
.
š‹¿ùive
 = 1;

1270 
	`lš’oi£S‘MuÉiLše
(1);

1271 
	`lš’oi£S‘Com¶‘iÚC®lback
(
com¶‘iÚC®lback
);

1272 
	`lš’oi£S‘HštsC®lback
(
hštsC®lback
);

1273 
	`lš’oi£S‘F»eHštsC®lback
(
ä“HštsC®lback
);

1276 ià(
	`i§‰y
(
	`f’o
(
¡dš
))) {

1277 
hi¡Üyfe
 = 
	`g‘DÙfeP©h
(
REDIS_CLI_HISTFILE_ENV
,
REDIS_CLI_HISTFILE_DEFAULT
);

1278 ià(
hi¡Üyfe
 !ğ
NULL
) {

1279 
hi¡Üy
 = 1;

1280 
	`lš’oi£Hi¡ÜyLßd
(
hi¡Üyfe
);

1282 
	`şiLßdP»ã»nûs
();

1285 
	`şiReäeshProm±
();

1286 (
lše
 = 
	`lš’oi£
(
cÚ‹xt
 ? 
cÚfig
.
´om±
 : "nÙ cÚÃùed> ")è!ğ
NULL
) {

1287 ià(
lše
[0] != '\0') {

1288 
¬gv
 = 
	`şiS¶™Args
(
lše
,&
¬gc
);

1289 ià(
hi¡Üy
è
	`lš’oi£Hi¡ÜyAdd
(
lše
);

1290 ià(
hi¡Üyfe
è
	`lš’oi£Hi¡ÜySave
(historyfile);

1292 ià(
¬gv
 =ğ
NULL
) {

1293 
	`´štf
("Invalid‡rgument(s)\n");

1294 
	`lš’oi£F»e
(
lše
);

1296 } ià(
¬gc
 > 0) {

1297 ià(
	`¡rÿ£cmp
(
¬gv
[0],"quit") == 0 ||

1298 
	`¡rÿ£cmp
(
¬gv
[0],"exit") == 0)

1300 
	`ex™
(0);

1301 } ià(
¬gv
[0][0] == ':') {

1302 
	`şiS‘P»ã»nûs
(
¬gv
,
¬gc
,1);

1304 } ià(
	`¡rÿ£cmp
(
¬gv
[0],"restart") == 0) {

1305 ià(
cÚfig
.
ev®
) {

1306 
cÚfig
.
ev®_ldb
 = 1;

1307 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1310 
	`´štf
("Use 'restart' only in Lua debugging mode.");

1312 } ià(
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
¬gv
[0],"connect")) {

1313 
	`sdsä“
(
cÚfig
.
ho¡
);

1314 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
¬gv
[1]);

1315 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[2]);

1316 
	`şiReäeshProm±
();

1317 
	`şiCÚÃù
(1);

1318 } ià(
¬gc
 =ğ1 && !
	`¡rÿ£cmp
(
¬gv
[0],"clear")) {

1319 
	`lš’oi£CË¬Sü“n
();

1321 
¡¬t_time
 = 
	`m¡ime
(), 
–­£d
;

1322 
»³©
, 
sk¬gs
 = 0;

1324 
»³©
 = 
	`©oi
(
¬gv
[0]);

1325 ià(
¬gc
 > 1 && 
»³©
) {

1326 
sk¬gs
 = 1;

1328 
»³©
 = 1;

1331 
	`issueCommªdR•—t
(
¬gc
-
sk¬gs
, 
¬gv
+sk¬gs, 
»³©
);

1335 ià(
cÚfig
.
ev®_ldb_’d
) {

1336 
cÚfig
.
ev®_ldb_’d
 = 0;

1337 
	`şiR—dR•ly
(0);

1338 
	`´štf
("\n(Lua debugging sessionƒnded%s)\n\n",

1339 
cÚfig
.
ev®_ldb_sync
 ? "" :

1343 
–­£d
 = 
	`m¡ime
()-
¡¬t_time
;

1344 ià(
–­£d
 >= 500) {

1345 
	`´štf
("(%.2fs)\n",()
–­£d
/1000);

1350 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1353 
	`lš’oi£F»e
(
lše
);

1355 
	`ex™
(0);

1356 
	}
}

1358 
	$nÚš‹¿ùive
(
¬gc
, **
¬gv
) {

1359 
»tv®
 = 0;

1360 ià(
cÚfig
.
¡dš¬g
) {

1361 
¬gv
 = 
	`z»®loc
×rgv, (
¬gc
+1)*(*));

1362 
¬gv
[
¬gc
] = 
	`»adArgFromStdš
();

1363 
»tv®
 = 
	`issueCommªd
(
¬gc
+1, 
¬gv
);

1365 
»tv®
 = 
	`issueCommªd
(
¬gc
, 
¬gv
);

1367  
»tv®
;

1368 
	}
}

1374 
	$ev®Mode
(
¬gc
, **
¬gv
) {

1375 
sds
 
süt
 = 
NULL
;

1376 
FILE
 *
å
;

1377 
buf
[1024];

1378 
size_t
 
Ä—d
;

1379 **
¬gv2
;

1380 
j
, 
gÙ_comma
, 
keys
;

1381 
»tv®
 = 
REDIS_OK
;

1384 ià(
cÚfig
.
ev®_ldb
) {

1385 
	`´štf
(

1393 
	`sdsä“
(
süt
);

1394 
süt
 = 
	`sd£m±y
();

1395 
gÙ_comma
 = 0;

1396 
keys
 = 0;

1399 
å
 = 
	`fİ’
(
cÚfig
.
ev®
,"r");

1400 ià(!
å
) {

1401 
	`årštf
(
¡d”r
,

1402 "Cª'ˆİ’ f'%s': %s\n", 
cÚfig
.
ev®
, 
	`¡»¼Ü
(
”ºo
));

1403 
	`ex™
(1);

1405 (
Ä—d
 = 
	`ä—d
(
buf
,1,(buf),
å
)) != 0) {

1406 
süt
 = 
	`sdsÿ’
(süt,
buf
,
Ä—d
);

1408 
	`fşo£
(
å
);

1411 ià(
cÚfig
.
ev®_ldb
) {

1412 
»disR•ly
 *
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,

1413 
cÚfig
.
ev®_ldb_sync
 ?

1415 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1419 
¬gv2
 = 
	`zm®loc
((
sds
)*(
¬gc
+3));

1420 
¬gv2
[0] = 
	`sd¢ew
("EVAL");

1421 
¬gv2
[1] = 
süt
;

1422 
j
 = 0; j < 
¬gc
; j++) {

1423 ià(!
gÙ_comma
 && 
¬gv
[
j
][0] == ',' &&‡rgv[j][1] == 0) {

1424 
gÙ_comma
 = 1;

1427 
¬gv2
[
j
+3-
gÙ_comma
] = 
	`sd¢ew
(
¬gv
[j]);

1428 ià(!
gÙ_comma
è
keys
++;

1430 
¬gv2
[2] = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",
keys
);

1433 
ev®_ldb
 = 
cÚfig
.eval_ldb;

1434 
»tv®
 = 
	`issueCommªd
(
¬gc
+3-
gÙ_comma
, 
¬gv2
);

1435 ià(
ev®_ldb
) {

1436 ià(!
cÚfig
.
ev®_ldb
) {

1440 
	`´štf
("Eval debugging session can't start:\n");

1441 
	`şiR—dR•ly
(0);

1444 
	`¡ºıy
(
cÚfig
.
´om±
,"lua debugger> ",(config.prompt));

1445 
	`»¶
();

1447 
	`şiCÚÃù
(1);

1448 
	`´štf
("\n");

1454  
»tv®
;

1455 
	}
}

1461 
	#LATENCY_SAMPLE_RATE
 10

	)

1462 
	#LATENCY_HISTORY_DEFAULT_INTERVAL
 15000

	)

1463 
	$Ï‹ncyMode
() {

1464 
»disR•ly
 *
»¶y
;

1465 
¡¬t
, 
Ï‹ncy
, 
mš
 = 0, 
max
 = 0, 
tÙ
 = 0, 
couÁ
 = 0;

1466 
hi¡Üy_š‹rv®
 =

1467 
cÚfig
.
š‹rv®
 ? config.interval/1000 :

1468 
LATENCY_HISTORY_DEFAULT_INTERVAL
;

1469 
avg
;

1470 
hi¡Üy_¡¬t
 = 
	`m¡ime
();

1472 ià(!
cÚ‹xt
è
	`ex™
(1);

1474 
¡¬t
 = 
	`m¡ime
();

1475 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"PING");

1476 ià(
»¶y
 =ğ
NULL
) {

1477 
	`årštf
(
¡d”r
,"\nI/Oƒrror\n");

1478 
	`ex™
(1);

1480 
Ï‹ncy
 = 
	`m¡ime
()-
¡¬t
;

1481 
	`ä“R•lyObjeù
(
»¶y
);

1482 
couÁ
++;

1483 ià(
couÁ
 == 1) {

1484 
mš
 = 
max
 = 
tÙ
 = 
Ï‹ncy
;

1485 
avg
 = (è
Ï‹ncy
;

1487 ià(
Ï‹ncy
 < 
mš
) min =†atency;

1488 ià(
Ï‹ncy
 > 
max
) max =†atency;

1489 
tÙ
 +ğ
Ï‹ncy
;

1490 
avg
 = (è
tÙ
/
couÁ
;

1492 
	`´štf
("\x1b[0G\x1b[2Kmin: %lld, max: %lld,‡vg: %.2f (%lld samples)",

1493 
mš
, 
max
, 
avg
, 
couÁ
);

1494 
	`fæush
(
¡dout
);

1495 ià(
cÚfig
.
Ï‹ncy_hi¡Üy
 && 
	`m¡ime
()-
hi¡Üy_¡¬t
 > 
hi¡Üy_š‹rv®
)

1497 
	`´štf
(" -- %.2à£cÚd ¿nge\n", ()(
	`m¡ime
()-
hi¡Üy_¡¬t
)/1000);

1498 
hi¡Üy_¡¬t
 = 
	`m¡ime
();

1499 
mš
 = 
max
 = 
tÙ
 = 
couÁ
 = 0;

1501 
	`u¦“p
(
LATENCY_SAMPLE_RATE
 * 1000);

1503 
	}
}

1509 
	#LATENCY_DIST_DEFAULT_INTERVAL
 1000

	)

1512 
	sdi¡§m¶es
 {

1513 
	mmax
;

1514 
	mcouÁ
;

1515 
	mch¬aù”
;

1529 
	$showL©’cyDi¡Sam¶es
(
di¡§m¶es
 *
§m¶es
, 
tÙ
) {

1530 
j
;

1537 
	`´štf
("\033[38;5;0m");

1538 
j
 = 0; ; j++) {

1539 
cŞÜidx
 =

1540 
	`û
((è
§m¶es
[
j
].
couÁ
 / 
tÙ
 * (
¥eùrum_·Ë‰e_size
-1));

1541 
cŞÜ
 = 
¥eùrum_·Ë‰e
[
cŞÜidx
];

1542 
	`´štf
("\033[48;5;%dm%c", ()
cŞÜ
, 
§m¶es
[
j
].
ch¬aù”
);

1543 
§m¶es
[
j
].
couÁ
 = 0;

1544 ià(
§m¶es
[
j
].
max
 == 0) ;

1546 
	`´štf
("\033[0m\n");

1547 
	`fæush
(
¡dout
);

1548 
	}
}

1552 
	$showL©’cyDi¡Leg’d
() {

1553 
j
;

1555 
	`´štf
("---------------------------------------------\n");

1556 
	`´štf
(". - * # .01 .125 .25 .5 milliseconds\n");

1557 
	`´štf
("1,2,3,...,9 from 1o 9 milliseconds\n");

1558 
	`´štf
("A,B,C,D,E 10,20,30,40,50 milliseconds\n");

1559 
	`´štf
("F,G,H,I,J .1,.2,.3,.4,.5 seconds\n");

1560 
	`´štf
("K,L,M,N,O,P,Q,? 1,2,4,8,16,30,60,>60 seconds\n");

1561 
	`´štf
("From 0o 100%%: ");

1562 
j
 = 0; j < 
¥eùrum_·Ë‰e_size
; j++) {

1563 
	`´štf
("\033[48;5;%dm ", 
¥eùrum_·Ë‰e
[
j
]);

1565 
	`´štf
("\033[0m\n");

1566 
	`´štf
("---------------------------------------------\n");

1567 
	}
}

1569 
	$Ï‹ncyDi¡Mode
() {

1570 
»disR•ly
 *
»¶y
;

1571 
¡¬t
, 
Ï‹ncy
, 
couÁ
 = 0;

1572 
hi¡Üy_š‹rv®
 =

1573 
cÚfig
.
š‹rv®
 ? config.interval/1000 :

1574 
LATENCY_DIST_DEFAULT_INTERVAL
;

1575 
hi¡Üy_¡¬t
 = 
	`u¡ime
();

1576 
j
, 
ouuts
 = 0;

1578 
di¡§m¶es
 
§m¶es
[] = {

1615 ià(!
cÚ‹xt
è
	`ex™
(1);

1617 
¡¬t
 = 
	`u¡ime
();

1618 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"PING");

1619 ià(
»¶y
 =ğ
NULL
) {

1620 
	`årštf
(
¡d”r
,"\nI/Oƒrror\n");

1621 
	`ex™
(1);

1623 
Ï‹ncy
 = 
	`u¡ime
()-
¡¬t
;

1624 
	`ä“R•lyObjeù
(
»¶y
);

1625 
couÁ
++;

1628 
j
 = 0; ; j++) {

1629 ià(
§m¶es
[
j
].
max
 =ğ0 || 
Ï‹ncy
 <= samples[j].max) {

1630 
§m¶es
[
j
].
couÁ
++;

1636 ià(
couÁ
 && (
	`u¡ime
()-
hi¡Üy_¡¬t
)/1000 > 
hi¡Üy_š‹rv®
) {

1637 ià((
ouuts
++ % 20) == 0)

1638 
	`showL©’cyDi¡Leg’d
();

1639 
	`showL©’cyDi¡Sam¶es
(
§m¶es
,
couÁ
);

1640 
hi¡Üy_¡¬t
 = 
	`u¡ime
();

1641 
couÁ
 = 0;

1643 
	`u¦“p
(
LATENCY_SAMPLE_RATE
 * 1000);

1645 
	}
}

1653 
	$£ndSync
(
fd
) {

1658 
buf
[4096], *
p
;

1659 
ssize_t
 
Ä—d
;

1662 ià(
	`wr™e
(
fd
,"SYNC\r\n",6) != 6) {

1663 
	`årštf
(
¡d”r
,"Error writingo master\n");

1664 
	`ex™
(1);

1668 
p
 = 
buf
;

1670 
Ä—d
 = 
	`»ad
(
fd
,
p
,1);

1671 ià(
Ä—d
 <= 0) {

1672 
	`årštf
(
¡d”r
,"Error„eading bulk†ength while SYNCing\n");

1673 
	`ex™
(1);

1675 ià(*
p
 =ğ'\n' &&… !ğ
buf
) ;

1676 ià(*
p
 != '\n')…++;

1678 *
p
 = '\0';

1679 ià(
buf
[0] == '-') {

1680 
	`´štf
("SYNC w™h ma¡” faed: %s\n", 
buf
);

1681 
	`ex™
(1);

1683  
	`¡¹ouÎ
(
buf
+1,
NULL
,10);

1684 
	}
}

1686 
	$¦aveMode
() {

1687 
fd
 = 
cÚ‹xt
->fd;

1688 
·ylßd
 = 
	`£ndSync
(
fd
);

1689 
buf
[1024];

1690 
Üigš®_ouut
 = 
cÚfig
.
ouut
;

1692 
	`årštf
(
¡d”r
,"SYNC with master, discarding %llu "

1693 "by‹ oàbulk¿nsãr...\n", 
·ylßd
);

1696 
·ylßd
) {

1697 
ssize_t
 
Ä—d
;

1699 
Ä—d
 = 
	`»ad
(
fd
,
buf
,(
·ylßd
 > (buf)) ? (buf) :…ayload);

1700 ià(
Ä—d
 <= 0) {

1701 
	`årštf
(
¡d”r
,"Error„eading RDB…ayload while SYNCing\n");

1702 
	`ex™
(1);

1704 
·ylßd
 -ğ
Ä—d
;

1706 
	`årštf
(
¡d”r
,"SYNC done. Logging commands from master.\n");

1709 
cÚfig
.
ouut
 = 
OUTPUT_CSV
;

1710 
	`şiR—dR•ly
(0è=ğ
REDIS_OK
);

1711 
cÚfig
.
ouut
 = 
Üigš®_ouut
;

1712 
	}
}

1720 
	$g‘RDB
() {

1721 
s
 = 
cÚ‹xt
->
fd
;

1722 
fd
;

1723 
·ylßd
 = 
	`£ndSync
(
s
);

1724 
buf
[4096];

1726 
	`årštf
(
¡d”r
,"SYNC sento master, writing %llu byteso '%s'\n",

1727 
·ylßd
, 
cÚfig
.
rdb_f’ame
);

1730 ià(!
	`¡rcmp
(
cÚfig
.
rdb_f’ame
,"-")) {

1731 
fd
 = 
STDOUT_FILENO
;

1733 
fd
 = 
	`İ’
(
cÚfig
.
rdb_f’ame
, 
O_CREAT
|
O_WRONLY
, 0644);

1734 ià(
fd
 == -1) {

1735 
	`årštf
(
¡d”r
, "E¼Ü o³nšg '%s': %s\n", 
cÚfig
.
rdb_f’ame
,

1736 
	`¡»¼Ü
(
”ºo
));

1737 
	`ex™
(1);

1741 
·ylßd
) {

1742 
ssize_t
 
Ä—d
, 
nwr™‹n
;

1744 
Ä—d
 = 
	`»ad
(
s
,
buf
,(
·ylßd
 > (buf)) ? (buf) :…ayload);

1745 ià(
Ä—d
 <= 0) {

1746 
	`årštf
(
¡d”r
,"I/O Error„eading RDB…ayload from socket\n");

1747 
	`ex™
(1);

1749 
nwr™‹n
 = 
	`wr™e
(
fd
, 
buf
, 
Ä—d
);

1750 ià(
nwr™‹n
 !ğ
Ä—d
) {

1751 
	`årštf
(
¡d”r
,"Error writing datao file: %s\n",

1752 
	`¡»¼Ü
(
”ºo
));

1753 
	`ex™
(1);

1755 
·ylßd
 -ğ
Ä—d
;

1757 
	`şo£
(
s
);

1758 
	`fsync
(
fd
);

1759 
	`årštf
(
¡d”r
,"Transfer finished with success.\n");

1760 
	`ex™
(0);

1761 
	}
}

1767 
	#PIPEMODE_WRITE_LOOP_MAX_BYTES
 (128*1024)

	)

1768 
	$peMode
() {

1769 
fd
 = 
cÚ‹xt
->fd;

1770 
”rÜs
 = 0, 
»¶›s
 = 0, 
obuf_Ën
 = 0, 
obuf_pos
 = 0;

1771 
ibuf
[1024*16], 
obuf
[1024*16];

1772 
ª‘”r
[
ANET_ERR_LEN
];

1773 
»disR—d”
 *
»ad”
 = 
	`»disR—d”C»©e
();

1774 
»disR•ly
 *
»¶y
;

1775 
eof
 = 0;

1776 
dÚe
 = 0;

1777 
magic
[20];

1778 
time_t
 
Ï¡_»ad_time
 = 
	`time
(
NULL
);

1780 
	`¤ªd
(
	`time
(
NULL
));

1783 ià(
	`ª‘NÚBlock
(
ª‘”r
,
fd
è=ğ
ANET_ERR
) {

1784 
	`årštf
(
¡d”r
, "Can't sethe socket in‚on blocking mode: %s\n",

1785 
ª‘”r
);

1786 
	`ex™
(1);

1791 !
dÚe
) {

1792 
mask
 = 
AE_READABLE
;

1794 ià(!
eof
 || 
obuf_Ën
 !ğ0è
mask
 |ğ
AE_WRITABLE
;

1795 
mask
 = 
	`«Wa™
(
fd
,mask,1000);

1798 ià(
mask
 & 
AE_READABLE
) {

1799 
ssize_t
 
Ä—d
;

1803 
Ä—d
 = 
	`»ad
(
fd
,
ibuf
,(ibuf));

1804 ià(
Ä—d
 =ğ-1 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
) {

1805 
	`årštf
(
¡d”r
, "Error„eading fromhe server: %s\n",

1806 
	`¡»¼Ü
(
”ºo
));

1807 
	`ex™
(1);

1809 ià(
Ä—d
 > 0) {

1810 
	`»disR—d”F“d
(
»ad”
,
ibuf
,
Ä—d
);

1811 
Ï¡_»ad_time
 = 
	`time
(
NULL
);

1813 } 
Ä—d
 > 0);

1817 ià(
	`»disR—d”G‘R•ly
(
»ad”
,(**)&
»¶y
è=ğ
REDIS_ERR
) {

1818 
	`årštf
(
¡d”r
, "Error„eading„eplies from server\n");

1819 
	`ex™
(1);

1821 ià(
»¶y
) {

1822 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1823 
	`årštf
(
¡d”r
,"%s\n", 
»¶y
->
¡r
);

1824 
”rÜs
++;

1825 } ià(
eof
 && 
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

1826 
»¶y
->
Ën
 == 20) {

1830 ià(
	`memcmp
(
»¶y
->
¡r
,
magic
,20) == 0) {

1831 
	`´štf
("Last„eply„eceived from server.\n");

1832 
dÚe
 = 1;

1833 
»¶›s
--;

1836 
»¶›s
++;

1837 
	`ä“R•lyObjeù
(
»¶y
);

1839 } 
»¶y
);

1843 ià(
mask
 & 
AE_WRITABLE
) {

1844 
ssize_t
 
loİ_nwr™‹n
 = 0;

1848 ià(
obuf_Ën
 != 0) {

1849 
ssize_t
 
nwr™‹n
 = 
	`wr™e
(
fd
,
obuf
+
obuf_pos
,
obuf_Ën
);

1851 ià(
nwr™‹n
 == -1) {

1852 ià(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
) {

1853 
	`årštf
(
¡d”r
, "Error writingohe server: %s\n",

1854 
	`¡»¼Ü
(
”ºo
));

1855 
	`ex™
(1);

1857 
nwr™‹n
 = 0;

1860 
obuf_Ën
 -ğ
nwr™‹n
;

1861 
obuf_pos
 +ğ
nwr™‹n
;

1862 
loİ_nwr™‹n
 +ğ
nwr™‹n
;

1863 ià(
obuf_Ën
 != 0) ;

1866 ià(
obuf_Ën
 =ğ0 && !
eof
) {

1867 
ssize_t
 
Ä—d
 = 
	`»ad
(
STDIN_FILENO
,
obuf
,(obuf));

1869 ià(
Ä—d
 == 0) {

1874 
echo
[] =

1876 
j
;

1878 
eof
 = 1;

1882 
j
 = 0; j < 20; j++)

1883 
magic
[
j
] = 
	`¿nd
() & 0xff;

1884 
	`memıy
(
echo
+21,
magic
,20);

1885 
	`memıy
(
obuf
,
echo
,(echo)-1);

1886 
obuf_Ën
 = (
echo
)-1;

1887 
obuf_pos
 = 0;

1888 
	`´štf
("All dataransferred. Waiting forhe†ast„eply...\n");

1889 } ià(
Ä—d
 == -1) {

1890 
	`årštf
(
¡d”r
, "Error„eading from stdin: %s\n",

1891 
	`¡»¼Ü
(
”ºo
));

1892 
	`ex™
(1);

1894 
obuf_Ën
 = 
Ä—d
;

1895 
obuf_pos
 = 0;

1898 ià((
obuf_Ën
 =ğ0 && 
eof
) ||

1899 
loİ_nwr™‹n
 > 
PIPEMODE_WRITE_LOOP_MAX_BYTES
) ;

1906 ià(
eof
 && 
cÚfig
.
pe_timeout
 > 0 &&

1907 
	`time
(
NULL
)-
Ï¡_»ad_time
 > 
cÚfig
.
pe_timeout
)

1909 
	`årštf
(
¡d”r
,"No„eplies for %d seconds:ƒxiting.\n",

1910 
cÚfig
.
pe_timeout
);

1911 
”rÜs
++;

1915 
	`»disR—d”F»e
(
»ad”
);

1916 
	`´štf
("”rÜs: %Îd,„•l›s: %Îd\n", 
”rÜs
, 
»¶›s
);

1917 ià(
”rÜs
)

1918 
	`ex™
(1);

1920 
	`ex™
(0);

1921 
	}
}

1927 
	#TYPE_STRING
 0

	)

1928 
	#TYPE_LIST
 1

	)

1929 
	#TYPE_SET
 2

	)

1930 
	#TYPE_HASH
 3

	)

1931 
	#TYPE_ZSET
 4

	)

1932 
	#TYPE_NONE
 5

	)

1934 
»disR•ly
 *
	$£ndSÿn
(*
™
) {

1935 
»disR•ly
 *
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "SCAN %Îu", *
™
);

1938 if(
»¶y
 =ğ
NULL
) {

1939 
	`årštf
(
¡d”r
, "\nI/Oƒrror\n");

1940 
	`ex™
(1);

1941 } if(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1942 
	`årštf
(
¡d”r
, "SCANƒ¼Ü: %s\n", 
»¶y
->
¡r
);

1943 
	`ex™
(1);

1944 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

1945 
	`årštf
(
¡d”r
, "Non ARRAY„esponse from SCAN!\n");

1946 
	`ex™
(1);

1947 } if(
»¶y
->
–em’ts
 != 2) {

1948 
	`årštf
(
¡d”r
, "Invalidƒlement count from SCAN!\n");

1949 
	`ex™
(1);

1953 
	`as£¹
(
»¶y
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_STRING
);

1954 
	`as£¹
(
»¶y
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

1957 *
™
 = 
	`¡¹ouÎ
(
»¶y
->
–em’t
[0]->
¡r
, 
NULL
, 10);

1959  
»¶y
;

1960 
	}
}

1962 
	$g‘DbSize
() {

1963 
»disR•ly
 *
»¶y
;

1964 
size
;

1966 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "DBSIZE");

1968 if(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

1969 
	`årštf
(
¡d”r
, "Couldn't determine DBSIZE!\n");

1970 
	`ex™
(1);

1974 
size
 = 
»¶y
->
š‹g”
;

1975 
	`ä“R•lyObjeù
(
»¶y
);

1977  
size
;

1978 
	}
}

1980 
	$toIÁTy³
(*
key
, *
ty³
) {

1981 if(!
	`¡rcmp
(
ty³
, "string")) {

1982  
TYPE_STRING
;

1983 } if(!
	`¡rcmp
(
ty³
, "list")) {

1984  
TYPE_LIST
;

1985 } if(!
	`¡rcmp
(
ty³
, "set")) {

1986  
TYPE_SET
;

1987 } if(!
	`¡rcmp
(
ty³
, "hash")) {

1988  
TYPE_HASH
;

1989 } if(!
	`¡rcmp
(
ty³
, "zset")) {

1990  
TYPE_ZSET
;

1991 } if(!
	`¡rcmp
(
ty³
, "none")) {

1992  
TYPE_NONE
;

1994 
	`årštf
(
¡d”r
, "UnknowÀty³ '%s' fÜ key '%s'\n", 
ty³
, 
key
);

1995 
	`ex™
(1);

1997 
	}
}

1999 
	$g‘KeyTy³s
(
»disR•ly
 *
keys
, *
ty³s
) {

2000 
»disR•ly
 *
»¶y
;

2001 
i
;

2004 
i
=0;i<
keys
->
–em’ts
;i++) {

2005 
	`»disAµ’dCommªd
(
cÚ‹xt
, "TYPE %s", 
keys
->
–em’t
[
i
]->
¡r
);

2009 
i
=0;i<
keys
->
–em’ts
;i++) {

2010 if(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
)!=
REDIS_OK
) {

2011 
	`årštf
(
¡d”r
, "Error gettingype for key '%s' (%d: %s)\n",

2012 
keys
->
–em’t
[
i
]->
¡r
, 
cÚ‹xt
->
”r
, cÚ‹xt->
”r¡r
);

2013 
	`ex™
(1);

2014 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STATUS
) {

2015 
	`årštf
(
¡d”r
, "Invalid„eplyype (%d) for TYPE on key '%s'!\n",

2016 
»¶y
->
ty³
, 
keys
->
–em’t
[
i
]->
¡r
);

2017 
	`ex™
(1);

2020 
ty³s
[
i
] = 
	`toIÁTy³
(
keys
->
–em’t
[i]->
¡r
, 
»¶y
->str);

2021 
	`ä“R•lyObjeù
(
»¶y
);

2023 
	}
}

2025 
	$g‘KeySizes
(
»disR•ly
 *
keys
, *
ty³s
,

2026 *
sizes
)

2028 
»disR•ly
 *
»¶y
;

2029 *
sizecmds
[] = {"STRLEN","LLEN","SCARD","HLEN","ZCARD"};

2030 
i
;

2033 
i
=0;i<
keys
->
–em’ts
;i++) {

2035 if(
ty³s
[
i
]==
TYPE_NONE
)

2038 
	`»disAµ’dCommªd
(
cÚ‹xt
, "% %s", 
sizecmds
[
ty³s
[
i
]],

2039 
keys
->
–em’t
[
i
]->
¡r
);

2043 
i
=0;i<
keys
->
–em’ts
;i++) {

2045 if(
ty³s
[
i
] =ğ
TYPE_NONE
) {

2046 
sizes
[
i
] = 0;

2051 if(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
)!=
REDIS_OK
) {

2052 
	`årštf
(
¡d”r
, "Error getting size for key '%s' (%d: %s)\n",

2053 
keys
->
–em’t
[
i
]->
¡r
, 
cÚ‹xt
->
”r
, cÚ‹xt->
”r¡r
);

2054 
	`ex™
(1);

2055 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

2058 
	`årštf
(
¡d”r
,

2060 
sizecmds
[
ty³s
[
i
]], 
keys
->
–em’t
[i]->
¡r
);

2061 
sizes
[
i
] = 0;

2063 
sizes
[
i
] = 
»¶y
->
š‹g”
;

2066 
	`ä“R•lyObjeù
(
»¶y
);

2068 
	}
}

2070 
	$fšdBigKeys
() {

2071 
bigge¡
[5] = {0}, 
couÁs
[5] = {0}, 
tÙ®size
[5] = {0};

2072 
§m¶ed
 = 0, 
tÙ®_keys
, 
tÙËn
=0, *
sizes
=
NULL
, 
™
=0;

2073 
sds
 
maxkeys
[5] = {0};

2074 *
ty³Çme
[] = {"string","list","set","hash","zset"};

2075 *
ty³un™
[] = {"bytes","items","members","fields","members"};

2076 
»disR•ly
 *
»¶y
, *
keys
;

2077 
¬rsize
=0, 
i
;

2078 
ty³
, *
ty³s
=
NULL
;

2079 
pù
;

2082 
tÙ®_keys
 = 
	`g‘DbSize
();

2085 
	`´štf
("\n# Scanningheƒntire keyspaceo find biggest keys‡s well‡s\n");

2086 
	`´štf
("#‡verage sizes…er keyype. You can use -i 0.1o sleep 0.1 sec\n");

2087 
	`´štf
("#…er 100 SCAN commands (not usually‚eeded).\n\n");

2090 
i
=0;i<
TYPE_NONE
; i++) {

2091 
maxkeys
[
i
] = 
	`sd£m±y
();

2092 if(!
maxkeys
[
i
]) {

2093 
	`årštf
(
¡d”r
, "Failedo‡llocate memory for†argest key‚ames!\n");

2094 
	`ex™
(1);

2101 
pù
 = 100 * ()
§m¶ed
/
tÙ®_keys
;

2104 
»¶y
 = 
	`£ndSÿn
(&
™
);

2105 
keys
 = 
»¶y
->
–em’t
[1];

2108 if(
keys
->
–em’ts
 > 
¬rsize
) {

2109 
ty³s
 = 
	`z»®loc
Ñy³s, ()*
keys
->
–em’ts
);

2110 
sizes
 = 
	`z»®loc
(sizes, ()*
keys
->
–em’ts
);

2112 if(!
ty³s
 || !
sizes
) {

2113 
	`årštf
(
¡d”r
, "Failedo‡llocate storage for keys!\n");

2114 
	`ex™
(1);

2117 
¬rsize
 = 
keys
->
–em’ts
;

2121 
	`g‘KeyTy³s
(
keys
, 
ty³s
);

2122 
	`g‘KeySizes
(
keys
, 
ty³s
, 
sizes
);

2125 
i
=0;i<
keys
->
–em’ts
;i++) {

2126 if((
ty³
 = 
ty³s
[
i
]è=ğ
TYPE_NONE
)

2129 
tÙ®size
[
ty³
] +ğ
sizes
[
i
];

2130 
couÁs
[
ty³
]++;

2131 
tÙËn
 +ğ
keys
->
–em’t
[
i
]->
Ën
;

2132 
§m¶ed
++;

2134 if(
bigge¡
[
ty³
]<
sizes
[
i
]) {

2135 
	`´štf
(

2137 
pù
, 
ty³Çme
[
ty³
], 
keys
->
–em’t
[
i
]->
¡r
, 
sizes
[i],

2138 
ty³un™
[
ty³
]);

2141 
maxkeys
[
ty³
] = 
	`sdsıy
(maxkeys[ty³], 
keys
->
–em’t
[
i
]->
¡r
);

2142 if(!
maxkeys
[
ty³
]) {

2143 
	`årštf
(
¡d”r
, "Failedo‡llocate memory for key!\n");

2144 
	`ex™
(1);

2148 
bigge¡
[
ty³
] = 
sizes
[
i
];

2152 if(
§m¶ed
 % 1000000 == 0) {

2153 
	`´štf
("[%05.2f%%] Sam¶ed %Îu key sØçr\n", 
pù
, 
§m¶ed
);

2158 if(
§m¶ed
 && (§m¶ed %100è=ğ0 && 
cÚfig
.
š‹rv®
) {

2159 
	`u¦“p
(
cÚfig
.
š‹rv®
);

2162 
	`ä“R•lyObjeù
(
»¶y
);

2163 } 
™
 != 0);

2165 if(
ty³s
è
	`zä“
(types);

2166 if(
sizes
è
	`zä“
(sizes);

2169 
	`´štf
("\n-------- summary -------\n\n");

2171 
	`´štf
("Sam¶ed %Îu key šhkey¥aû!\n", 
§m¶ed
);

2172 
	`´štf
("Total key†ength in bytes is %llu (avg†en %.2f)\n\n",

2173 
tÙËn
,ÙËÀ? (éÙËn/
§m¶ed
 : 0);

2176 
i
=0;i<
TYPE_NONE
;i++) {

2177 if(
	`sd¦’
(
maxkeys
[
i
])>0) {

2178 
	`´štf
("Bigge¡ %6 found '%s' ha %Îu %s\n", 
ty³Çme
[
i
], 
maxkeys
[i],

2179 
bigge¡
[
i
], 
ty³un™
[i]);

2183 
	`´štf
("\n");

2185 
i
=0;i<
TYPE_NONE
;i++) {

2186 
	`´štf
("%llu %ss with %llu %s (%05.2f%% of keys,‡vg size %.2f)\n",

2187 
couÁs
[
i
], 
ty³Çme
[i], 
tÙ®size
[i], 
ty³un™
[i],

2188 
§m¶ed
 ? 100 * ()
couÁs
[
i
]/sampled : 0,

2189 
couÁs
[
i
] ? ()
tÙ®size
[i]/counts[i] : 0);

2193 
i
=0;i<
TYPE_NONE
;i++) {

2194 
	`sdsä“
(
maxkeys
[
i
]);

2198 
	`ex™
(0);

2199 
	}
}

2208 *
	$g‘InfoF›ld
(*
šfo
, *
f›ld
) {

2209 *
p
 = 
	`¡r¡r
(
šfo
,
f›ld
);

2210 *
n1
, *
n2
;

2211 *
»suÉ
;

2213 ià(!
p
è 
NULL
;

2214 
p
 +ğ
	`¡¾’
(
f›ld
)+1;

2215 
n1
 = 
	`¡rchr
(
p
,'\r');

2216 
n2
 = 
	`¡rchr
(
p
,',');

2217 ià(
n2
 &&‚2 < 
n1
)‚1 =‚2;

2218 
»suÉ
 = 
	`zm®loc
(()*(
n1
-
p
)+1);

2219 
	`memıy
(
»suÉ
,
p
,(
n1
-p));

2220 
»suÉ
[
n1
-
p
] = '\0';

2221  
»suÉ
;

2222 
	}
}

2226 
	$g‘LÚgInfoF›ld
(*
šfo
, *
f›ld
) {

2227 *
v®ue
 = 
	`g‘InfoF›ld
(
šfo
,
f›ld
);

2228 
l
;

2230 ià(!
v®ue
è 
LONG_MIN
;

2231 
l
 = 
	`¡¹Ş
(
v®ue
,
NULL
,10);

2232 
	`zä“
(
v®ue
);

2233  
l
;

2234 
	}
}

2238 
	$by‹sToHumª
(*
s
, 
n
) {

2239 
d
;

2241 ià(
n
 < 0) {

2242 *
s
 = '-';

2243 
s
++;

2244 
n
 = -n;

2246 ià(
n
 < 1024) {

2248 
	`¥rštf
(
s
,"%ÎdB",
n
);

2250 } ià(
n
 < (1024*1024)) {

2251 
d
 = ()
n
/(1024);

2252 
	`¥rštf
(
s
,"%.2fK",
d
);

2253 } ià(
n
 < (1024LL*1024*1024)) {

2254 
d
 = ()
n
/(1024*1024);

2255 
	`¥rštf
(
s
,"%.2fM",
d
);

2256 } ià(
n
 < (1024LL*1024*1024*1024)) {

2257 
d
 = ()
n
/(1024LL*1024*1024);

2258 
	`¥rštf
(
s
,"%.2fG",
d
);

2260 
	}
}

2262 
	$¡©Mode
() {

2263 
»disR•ly
 *
»¶y
;

2264 
aux
, 
»que¡s
 = 0;

2265 
i
 = 0;

2268 
buf
[64];

2269 
j
;

2271 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"INFO");

2272 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2273 
	`´štf
("ERROR: %s\n", 
»¶y
->
¡r
);

2274 
	`ex™
(1);

2277 ià((
i
++ % 20) == 0) {

2278 
	`´štf
(

2284 
aux
 = 0;

2285 
j
 = 0; j < 20; j++) {

2286 
k
;

2288 
	`¥rštf
(
buf
,"db%d:keys",
j
);

2289 
k
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,
buf
);

2290 ià(
k
 =ğ
LONG_MIN
) ;

2291 
aux
 +ğ
k
;

2293 
	`¥rštf
(
buf
,"%ld",
aux
);

2294 
	`´štf
("%-11s",
buf
);

2297 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"used_memory");

2298 
	`by‹sToHumª
(
buf
,
aux
);

2299 
	`´štf
("%-8s",
buf
);

2302 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"connected_clients");

2303 
	`¥rštf
(
buf
,"%ld",
aux
);

2304 
	`´štf
(" %-8s",
buf
);

2307 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"blocked_clients");

2308 
	`¥rštf
(
buf
,"%ld",
aux
);

2309 
	`´štf
("%-8s",
buf
);

2312 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"total_commands_processed");

2313 
	`¥rštf
(
buf
,"%ld (+%ld)",
aux
,
»que¡s
 == 0 ? 0 :‡ux-requests);

2314 
	`´štf
("%-19s",
buf
);

2315 
»que¡s
 = 
aux
;

2318 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"total_connections_received");

2319 
	`¥rštf
(
buf
,"%ld",
aux
);

2320 
	`´štf
(" %-12s",
buf
);

2323 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"bgsave_in_progress");

2324 
aux
 |ğ
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"aof_rewrite_in_progress") << 1;

2325 
aux
 |ğ
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"loading") << 2;

2326 
aux
) {

2329 
	`´štf
("SAVE");

2332 
	`´štf
("AOF");

2335 
	`´štf
("SAVE+AOF");

2338 
	`´štf
("LOAD");

2342 
	`´štf
("\n");

2343 
	`ä“R•lyObjeù
(
»¶y
);

2344 
	`u¦“p
(
cÚfig
.
š‹rv®
);

2346 
	}
}

2352 
	$sÿnMode
() {

2353 
»disR•ly
 *
»¶y
;

2354 
cur
 = 0;

2357 ià(
cÚfig
.
·‰”n
)

2358 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SCAN %llu MATCH %s",

2359 
cur
,
cÚfig
.
·‰”n
);

2361 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SCAN %Îu",
cur
);

2362 ià(
»¶y
 =ğ
NULL
) {

2363 
	`´štf
("I/Oƒrror\n");

2364 
	`ex™
(1);

2365 } ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2366 
	`´štf
("ERROR: %s\n", 
»¶y
->
¡r
);

2367 
	`ex™
(1);

2369 
j
;

2371 
cur
 = 
	`¡¹ouÎ
(
»¶y
->
–em’t
[0]->
¡r
,
NULL
,10);

2372 
j
 = 0; j < 
»¶y
->
–em’t
[1]->
–em’ts
; j++)

2373 
	`´štf
("%s\n", 
»¶y
->
–em’t
[1]->–em’t[
j
]->
¡r
);

2375 
	`ä“R•lyObjeù
(
»¶y
);

2376 } 
cur
 != 0);

2378 
	`ex™
(0);

2379 
	}
}

2391 
	$pow”LawRªd
(
mš
, 
max
, 
®pha
) {

2392 
¶
, 
r
;

2394 
max
 += 1;

2395 
r
 = (()
	`¿nd
()è/ 
RAND_MAX
;

2396 
¶
 = 
	`pow
(

2397 ((
	`pow
(
max
,
®pha
+1è-…ow(
mš
,®pha+1))*
r
 +…ow(min,alpha+1)),

2398 (1.0/(
®pha
+1)));

2399  (
max
-1-()
¶
)+
mš
;

2400 
	}
}

2404 
	$LRUTe¡G’Key
(*
buf
, 
size_t
 
buæ’
) {

2405 
	`¢´štf
(
buf
, 
buæ’
, "lru:%lld",

2406 
	`pow”LawRªd
(1, 
cÚfig
.
Ìu_‹¡_§m¶e_size
, 6.2));

2407 
	}
}

2409 
	#LRU_CYCLE_PERIOD
 1000

	)

2410 
	#LRU_CYCLE_PIPELINE_SIZE
 250

	)

2411 
	$LRUTe¡Mode
() {

2412 
»disR•ly
 *
»¶y
;

2413 
key
[128];

2414 
¡¬t_cyşe
;

2415 
j
;

2417 
	`¤ªd
(
	`time
(
NULL
)^
	`g‘pid
());

2422 
¡¬t_cyşe
 = 
	`m¡ime
();

2423 
h™s
 = 0, 
mis£s
 = 0;

2424 
	`m¡ime
(è- 
¡¬t_cyşe
 < 1000) {

2426 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2427 
v®
[6];

2428 
v®
[5] = '\0';

2429 
i
 = 0; i < 5; i++è
v®
[i] = 'A'+
	`¿nd
()%('z'-'A');

2430 
	`LRUTe¡G’Key
(
key
,(key));

2431 
	`»disAµ’dCommªd
(
cÚ‹xt
, "SET % %s",
key
,
v®
);

2433 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++)

2434 
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
);

2437 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2438 
	`LRUTe¡G’Key
(
key
,(key));

2439 
	`»disAµ’dCommªd
(
cÚ‹xt
, "GET %s",
key
);

2441 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2442 ià(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
è=ğ
REDIS_OK
) {

2443 
»¶y
->
ty³
) {

2444 
REDIS_REPLY_ERROR
:

2445 
	`´štf
("%s\n", 
»¶y
->
¡r
);

2447 
REDIS_REPLY_NIL
:

2448 
mis£s
++;

2451 
h™s
++;

2457 ià(
cÚ‹xt
->
”r
) {

2458 
	`årštf
(
¡d”r
,"I/Oƒrror during LRUest\n");

2459 
	`ex™
(1);

2463 
	`´štf
(

2465 
h™s
+
mis£s
,

2466 
h™s
, ()h™s/(h™s+
mis£s
)*100,

2467 
mis£s
, ()mis£s/(
h™s
+misses)*100);

2469 
	`ex™
(0);

2470 
	}
}

2483 
	$compu‹_som‘hšg_ç¡
() {

2484 
s
[256], 
i
, 
j
, 
t
;

2485 
couÁ
 = 1000, 
k
;

2486 
ouut
 = 0;

2488 
k
 = 0; k < 256; k++è
s
[k] = k;

2490 
i
 = 0;

2491 
j
 = 0;

2492 
couÁ
--) {

2493 
i
++;

2494 
j
 = j + 
s
[
i
];

2495 
t
 = 
s
[
i
];

2496 
s
[
i
] = s[
j
];

2497 
s
[
j
] = 
t
;

2498 
ouut
 +ğ
s
[(s[
i
]+s[
j
])&255];

2500  
ouut
;

2501 
	}
}

2503 
	$šŒšsicL©’cyModeStİ
(
s
) {

2504 
	`UNUSED
(
s
);

2505 
fÜû_ÿnûl_loİ
 = 1;

2506 
	}
}

2508 
	$šŒšsicL©’cyMode
() {

2509 
‹¡_’d
, 
run_time
, 
max_Ï‹ncy
 = 0, 
runs
 = 0;

2511 
run_time
 = 
cÚfig
.
šŒšsic_Ï‹ncy_du¿tiÚ
*1000000;

2512 
‹¡_’d
 = 
	`u¡ime
(è+ 
run_time
;

2513 
	`sigÇl
(
SIGINT
, 
šŒšsicL©’cyModeStİ
);

2516 
¡¬t
, 
’d
, 
Ï‹ncy
;

2518 
¡¬t
 = 
	`u¡ime
();

2519 
	`compu‹_som‘hšg_ç¡
();

2520 
’d
 = 
	`u¡ime
();

2521 
Ï‹ncy
 = 
’d
-
¡¬t
;

2522 
runs
++;

2523 ià(
Ï‹ncy
 <= 0) ;

2526 ià(
Ï‹ncy
 > 
max_Ï‹ncy
) {

2527 
max_Ï‹ncy
 = 
Ï‹ncy
;

2528 
	`´štf
("Max†©’cy sØçr: %Îd miüo£cÚds.\n", 
max_Ï‹ncy
);

2531 
avg_us
 = ()
run_time
/
runs
;

2532 
avg_ns
 = 
avg_us
 * 1e3;

2533 ià(
fÜû_ÿnûl_loİ
 || 
’d
 > 
‹¡_’d
) {

2534 
	`´štf
("\n%lldotal„uns "

2537 
runs
, 
avg_us
, 
avg_ns
);

2538 
	`´štf
("Worst„unook %.0fx†ongerhanhe‡verage†atency.\n",

2539 
max_Ï‹ncy
 / 
avg_us
);

2540 
	`ex™
(0);

2543 
	}
}

2549 
	$maš
(
¬gc
, **
¬gv
) {

2550 
fœ¡¬g
;

2552 
cÚfig
.
ho¡
 = 
	`sd¢ew
("127.0.0.1");

2553 
cÚfig
.
ho¡pÜt
 = 6379;

2554 
cÚfig
.
ho¡sock‘
 = 
NULL
;

2555 
cÚfig
.
»³©
 = 1;

2556 
cÚfig
.
š‹rv®
 = 0;

2557 
cÚfig
.
dbnum
 = 0;

2558 
cÚfig
.
š‹¿ùive
 = 0;

2559 
cÚfig
.
shutdown
 = 0;

2560 
cÚfig
.
mÚ™Ü_mode
 = 0;

2561 
cÚfig
.
pubsub_mode
 = 0;

2562 
cÚfig
.
Ï‹ncy_mode
 = 0;

2563 
cÚfig
.
Ï‹ncy_di¡_mode
 = 0;

2564 
cÚfig
.
Ï‹ncy_hi¡Üy
 = 0;

2565 
cÚfig
.
Ìu_‹¡_mode
 = 0;

2566 
cÚfig
.
Ìu_‹¡_§m¶e_size
 = 0;

2567 
cÚfig
.
şu¡”_mode
 = 0;

2568 
cÚfig
.
¦ave_mode
 = 0;

2569 
cÚfig
.
g‘rdb_mode
 = 0;

2570 
cÚfig
.
¡©_mode
 = 0;

2571 
cÚfig
.
sÿn_mode
 = 0;

2572 
cÚfig
.
šŒšsic_Ï‹ncy_mode
 = 0;

2573 
cÚfig
.
·‰”n
 = 
NULL
;

2574 
cÚfig
.
rdb_f’ame
 = 
NULL
;

2575 
cÚfig
.
pe_mode
 = 0;

2576 
cÚfig
.
pe_timeout
 = 
REDIS_CLI_DEFAULT_PIPE_TIMEOUT
;

2577 
cÚfig
.
bigkeys
 = 0;

2578 
cÚfig
.
¡dš¬g
 = 0;

2579 
cÚfig
.
auth
 = 
NULL
;

2580 
cÚfig
.
ev®
 = 
NULL
;

2581 
cÚfig
.
ev®_ldb
 = 0;

2582 
cÚfig
.
ev®_ldb_’d
 = 0;

2583 
cÚfig
.
ev®_ldb_sync
 = 0;

2584 
cÚfig
.
’abË_ldb_Ú_ev®
 = 0;

2585 
cÚfig
.
Ï¡_cmd_ty³
 = -1;

2587 
´ef
.
hšts
 = 1;

2589 
¥eùrum_·Ë‰e
 = 
¥eùrum_·Ë‰e_cŞÜ
;

2590 
¥eùrum_·Ë‰e_size
 = 
¥eùrum_·Ë‰e_cŞÜ_size
;

2592 ià(!
	`i§‰y
(
	`f’o
(
¡dout
)è&& (
	`g‘’v
("FAKETTY"è=ğ
NULL
))

2593 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

2595 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

2596 
cÚfig
.
mb_d–im
 = 
	`sd¢ew
("\n");

2598 
fœ¡¬g
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

2599 
¬gc
 -ğ
fœ¡¬g
;

2600 
¬gv
 +ğ
fœ¡¬g
;

2604 
	`şiIn™H–p
();

2605 
	`şiIÁeg¿‹H–p
();

2608 ià(
cÚfig
.
Ï‹ncy_mode
) {

2609 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2610 
	`Ï‹ncyMode
();

2614 ià(
cÚfig
.
Ï‹ncy_di¡_mode
) {

2615 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2616 
	`Ï‹ncyDi¡Mode
();

2620 ià(
cÚfig
.
¦ave_mode
) {

2621 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2622 
	`¦aveMode
();

2626 ià(
cÚfig
.
g‘rdb_mode
) {

2627 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2628 
	`g‘RDB
();

2632 ià(
cÚfig
.
pe_mode
) {

2633 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2634 
	`peMode
();

2638 ià(
cÚfig
.
bigkeys
) {

2639 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2640 
	`fšdBigKeys
();

2644 ià(
cÚfig
.
¡©_mode
) {

2645 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2646 ià(
cÚfig
.
š‹rv®
 == 0) config.interval = 1000000;

2647 
	`¡©Mode
();

2651 ià(
cÚfig
.
sÿn_mode
) {

2652 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2653 
	`sÿnMode
();

2657 ià(
cÚfig
.
Ìu_‹¡_mode
) {

2658 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2659 
	`LRUTe¡Mode
();

2663 ià(
cÚfig
.
šŒšsic_Ï‹ncy_mode
è
	`šŒšsicL©’cyMode
();

2666 ià(
¬gc
 =ğ0 && !
cÚfig
.
ev®
) {

2668 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

2672 
	`şiCÚÃù
(0);

2673 
	`»¶
();

2677 ià(
	`şiCÚÃù
(0è!ğ
REDIS_OK
è
	`ex™
(1);

2678 ià(
cÚfig
.
ev®
) {

2679  
	`ev®Mode
(
¬gc
,
¬gv
);

2681  
	`nÚš‹¿ùive
(
¬gc
,
	`cÚv”tToSds
×rgc,
¬gv
));

2683 
	}
}

	@redisassert.h

38 #iâdeà
__REDIS_ASSERT_H__


39 
	#__REDIS_ASSERT_H__


	)

41 
	~<uni¡d.h
>

43 
	#as£¹
(
_e
è((_e)?()0 : (
	`_£rv”As£¹
(#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

45 
_£rv”As£¹
(*
e¡r
, *
fe
, 
lše
);

	@redismodule.h

1 #iâdeà
REDISMODULE_H


2 
	#REDISMODULE_H


	)

4 
	~<sys/ty³s.h
>

5 
	~<¡dšt.h
>

6 
	~<¡dio.h
>

11 
	#REDISMODULE_OK
 0

	)

12 
	#REDISMODULE_ERR
 1

	)

15 
	#REDISMODULE_APIVER_1
 1

	)

18 
	#REDISMODULE_READ
 (1<<0)

	)

19 
	#REDISMODULE_WRITE
 (1<<1)

	)

21 
	#REDISMODULE_LIST_HEAD
 0

	)

22 
	#REDISMODULE_LIST_TAIL
 1

	)

25 
	#REDISMODULE_KEYTYPE_EMPTY
 0

	)

26 
	#REDISMODULE_KEYTYPE_STRING
 1

	)

27 
	#REDISMODULE_KEYTYPE_LIST
 2

	)

28 
	#REDISMODULE_KEYTYPE_HASH
 3

	)

29 
	#REDISMODULE_KEYTYPE_SET
 4

	)

30 
	#REDISMODULE_KEYTYPE_ZSET
 5

	)

31 
	#REDISMODULE_KEYTYPE_MODULE
 6

	)

34 
	#REDISMODULE_REPLY_UNKNOWN
 -1

	)

35 
	#REDISMODULE_REPLY_STRING
 0

	)

36 
	#REDISMODULE_REPLY_ERROR
 1

	)

37 
	#REDISMODULE_REPLY_INTEGER
 2

	)

38 
	#REDISMODULE_REPLY_ARRAY
 3

	)

39 
	#REDISMODULE_REPLY_NULL
 4

	)

42 
	#REDISMODULE_POSTPONED_ARRAY_LEN
 -1

	)

45 
	#REDISMODULE_NO_EXPIRE
 -1

	)

48 
	#REDISMODULE_ZADD_XX
 (1<<0)

	)

49 
	#REDISMODULE_ZADD_NX
 (1<<1)

	)

50 
	#REDISMODULE_ZADD_ADDED
 (1<<2)

	)

51 
	#REDISMODULE_ZADD_UPDATED
 (1<<3)

	)

52 
	#REDISMODULE_ZADD_NOP
 (1<<4)

	)

55 
	#REDISMODULE_HASH_NONE
 0

	)

56 
	#REDISMODULE_HASH_NX
 (1<<0)

	)

57 
	#REDISMODULE_HASH_XX
 (1<<1)

	)

58 
	#REDISMODULE_HASH_CFIELDS
 (1<<2)

	)

59 
	#REDISMODULE_HASH_EXISTS
 (1<<3)

	)

63 
	#REDISMODULE_HASH_DELETE
 ((
RedisModuËSŒšg
*)()1)

	)

66 
	#REDISMODULE_ERRORMSG_WRONGTYPE
 "WRONGTYPE O³¿tiÚ‡gaš¡‡ key hŞdšghwrÚg kšd oàv®ue"

	)

68 
	#REDISMODULE_POSITIVE_INFINITE
 (1.0/0.0)

	)

69 
	#REDISMODULE_NEGATIVE_INFINITE
 (-1.0/0.0)

	)

73 #iâdeà
REDISMODULE_CORE


75 
	tm¡ime_t
;

78 
RedisModuËCtx
 
	tRedisModuËCtx
;

79 
RedisModuËKey
 
	tRedisModuËKey
;

80 
RedisModuËSŒšg
 
	tRedisModuËSŒšg
;

81 
RedisModuËC®lR•ly
 
	tRedisModuËC®lR•ly
;

82 
RedisModuËIO
 
	tRedisModuËIO
;

83 
RedisModuËTy³
 
	tRedisModuËTy³
;

84 
RedisModuËDige¡
 
	tRedisModuËDige¡
;

86 (*
	tRedisModuËCmdFunc
è(
	tRedisModuËCtx
 *
	tùx
, 
	tRedisModuËSŒšg
 **
	t¬gv
, 
	t¬gc
);

88 *(*
	tRedisModuËTy³LßdFunc
)(
	tRedisModuËIO
 *
	trdb
, 
	t’cv”
);

89 (*
	tRedisModuËTy³SaveFunc
)(
	tRedisModuËIO
 *
	trdb
, *
	tv®ue
);

90 (*
	tRedisModuËTy³Rewr™eFunc
)(
	tRedisModuËIO
 *
	taof
, 
	tRedisModuËSŒšg
 *
	tkey
, *
	tv®ue
);

91 (*
	tRedisModuËTy³Dige¡Func
)(
	tRedisModuËDige¡
 *
	tdige¡
, *
	tv®ue
);

92 (*
	tRedisModuËTy³F»eFunc
)(*
	tv®ue
);

94 
	#REDISMODULE_GET_API
(
Çme
) \

95 
	`RedisModuË_G‘Api
("RedisModuË_" #Çme, ((**)&
RedisModuË_
 ## 
Çme
))

	)

97 
	#REDISMODULE_API_FUNC
(
x
è(*x)

	)

100 *
	$REDISMODULE_API_FUNC
(
RedisModuË_AÎoc
)(
size_t
 
by‹s
);

101 *
	$REDISMODULE_API_FUNC
(
RedisModuË_R—Îoc
)(*
±r
, 
size_t
 
by‹s
);

102 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»e
)(*
±r
);

103 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®loc
)(
size_t
 
nmemb
, size_ˆ
size
);

104 *
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒdup
)(cÚ¡ *
¡r
);

105 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Api
)(const *, *);

106 
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eCommªd
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
RedisModuËCmdFunc
 
cmdfunc
, cÚ¡ *
¡ræags
, 
fœ¡key
, 
Ï¡key
, 
key¡•
);

107 
	$REDISMODULE_API_FUNC
(
RedisModuË_S‘ModuËA‰ribs
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
);

108 
	$REDISMODULE_API_FUNC
(
RedisModuË_WrÚgAr™y
)(
RedisModuËCtx
 *
ùx
);

109 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hLÚgLÚg
)(
RedisModuËCtx
 *
ùx
, 
Î
);

110 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘S–eùedDb
)(
RedisModuËCtx
 *
ùx
);

111 
	$REDISMODULE_API_FUNC
(
RedisModuË_S–eùDb
)(
RedisModuËCtx
 *
ùx
, 
Ãwid
);

112 *
	$REDISMODULE_API_FUNC
(
RedisModuË_O³nKey
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
keyÇme
, 
mode
);

113 
	$REDISMODULE_API_FUNC
(
RedisModuË_Clo£Key
)(
RedisModuËKey
 *
kp
);

114 
	$REDISMODULE_API_FUNC
(
RedisModuË_KeyTy³
)(
RedisModuËKey
 *
kp
);

115 
size_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_V®ueL’gth
)(
RedisModuËKey
 *
kp
);

116 
	$REDISMODULE_API_FUNC
(
RedisModuË_Li¡Push
)(
RedisModuËKey
 *
kp
, 
wh”e
, 
RedisModuËSŒšg
 *
–e
);

117 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_Li¡Pİ
)(
RedisModuËKey
 *
key
, 
wh”e
);

118 
RedisModuËC®lR•ly
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®l
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...);

119 cÚ¡ *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyPrÙo
)(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
);

120 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»eC®lR•ly
)(
RedisModuËC®lR•ly
 *
»¶y
);

121 
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyTy³
)(
RedisModuËC®lR•ly
 *
»¶y
);

122 
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyIÁeg”
)(
RedisModuËC®lR•ly
 *
»¶y
);

123 
size_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyL’gth
)(
RedisModuËC®lR•ly
 *
»¶y
);

124 
RedisModuËC®lR•ly
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyA¼ayEËm’t
)(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 
idx
);

125 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšg
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
±r
, 
size_t
 
Ën
);

126 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgFromLÚgLÚg
)(
RedisModuËCtx
 *
ùx
, 
Î
);

127 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgFromSŒšg
)(
RedisModuËCtx
 *
ùx
, cÚ¡ 
RedisModuËSŒšg
 *
¡r
);

128 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»eSŒšg
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
);

129 cÚ¡ *
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgPŒL’
)(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, 
size_t
 *
Ën
);

130 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hE¼Ü
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
”r
);

131 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hSim¶eSŒšg
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
msg
);

132 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hA¼ay
)(
RedisModuËCtx
 *
ùx
, 
Ën
);

133 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyS‘A¼ayL’gth
)(
RedisModuËCtx
 *
ùx
, 
Ën
);

134 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hSŒšgBufãr
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
);

135 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hSŒšg
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
);

136 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hNuÎ
)(
RedisModuËCtx
 *
ùx
);

137 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hDoubË
)(
RedisModuËCtx
 *
ùx
, 
d
);

138 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hC®lR•ly
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËC®lR•ly
 *
»¶y
);

139 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgToLÚgLÚg
)(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
Î
);

140 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgToDoubË
)(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
d
);

141 
	$REDISMODULE_API_FUNC
(
RedisModuË_AutoMemÜy
)(
RedisModuËCtx
 *
ùx
);

142 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•liÿ‹
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...);

143 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•liÿ‹V”b©im
)(
RedisModuËCtx
 *
ùx
);

144 cÚ¡ *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lySŒšgPŒ
)(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
);

145 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgFromC®lR•ly
)(
RedisModuËC®lR•ly
 *
»¶y
);

146 
	$REDISMODULE_API_FUNC
(
RedisModuË_D–‘eKey
)(
RedisModuËKey
 *
key
);

147 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgS‘
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
¡r
);

148 *
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgDMA
)(
RedisModuËKey
 *
key
, 
size_t
 *
Ën
, 
mode
);

149 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgTrunÿ‹
)(
RedisModuËKey
 *
key
, 
size_t
 
ÃwËn
);

150 
m¡ime_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Expœe
)(
RedisModuËKey
 *
key
);

151 
	$REDISMODULE_API_FUNC
(
RedisModuË_S‘Expœe
)(
RedisModuËKey
 *
key
, 
m¡ime_t
 
expœe
);

152 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tAdd
)(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
);

153 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tInüby
)(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
, *
ÃwscÜe
);

154 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tScÜe
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
scÜe
);

155 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRem
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
d–‘ed
);

156 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeStİ
)(
RedisModuËKey
 *
key
);

157 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tFœ¡InScÜeRªge
)(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
);

158 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tLa¡InScÜeRªge
)(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
);

159 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tFœ¡InLexRªge
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
);

160 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tLa¡InLexRªge
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
);

161 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeCu¼’tEËm’t
)(
RedisModuËKey
 *
key
, *
scÜe
);

162 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeNext
)(
RedisModuËKey
 *
key
);

163 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeP»v
)(
RedisModuËKey
 *
key
);

164 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeEndR—ched
)(
RedisModuËKey
 *
key
);

165 
	$REDISMODULE_API_FUNC
(
RedisModuË_HashS‘
)(
RedisModuËKey
 *
key
, 
æags
, ...);

166 
	$REDISMODULE_API_FUNC
(
RedisModuË_HashG‘
)(
RedisModuËKey
 *
key
, 
æags
, ...);

167 
	$REDISMODULE_API_FUNC
(
RedisModuË_IsKeysPos™iÚReque¡
)(
RedisModuËCtx
 *
ùx
);

168 
	$REDISMODULE_API_FUNC
(
RedisModuË_KeyAtPos
)(
RedisModuËCtx
 *
ùx
, 
pos
);

169 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Cl›ÁId
)(
RedisModuËCtx
 *
ùx
);

170 *
	$REDISMODULE_API_FUNC
(
RedisModuË_PoŞAÎoc
)(
RedisModuËCtx
 *
ùx
, 
size_t
 
by‹s
);

171 
RedisModuËTy³
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eD©aTy³
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
’cv”
, 
RedisModuËTy³LßdFunc
 
rdb_lßd
, 
RedisModuËTy³SaveFunc
 
rdb_§ve
, 
RedisModuËTy³Rewr™eFunc
 
aof_»wr™e
, 
RedisModuËTy³Dige¡Func
 
dige¡
, 
RedisModuËTy³F»eFunc
 
ä“
);

172 
	$REDISMODULE_API_FUNC
(
RedisModuË_ModuËTy³S‘V®ue
)(
RedisModuËKey
 *
key
, 
RedisModuËTy³
 *
mt
, *
v®ue
);

173 
RedisModuËTy³
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_ModuËTy³G‘Ty³
)(
RedisModuËKey
 *
key
);

174 *
	$REDISMODULE_API_FUNC
(
RedisModuË_ModuËTy³G‘V®ue
)(
RedisModuËKey
 *
key
);

175 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveUnsigÃd
)(
RedisModuËIO
 *
io
, 
ušt64_t
 
v®ue
);

176 
ušt64_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdUnsigÃd
)(
RedisModuËIO
 *
io
);

177 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveSigÃd
)(
RedisModuËIO
 *
io
, 
št64_t
 
v®ue
);

178 
št64_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdSigÃd
)(
RedisModuËIO
 *
io
);

179 
	$REDISMODULE_API_FUNC
(
RedisModuË_Em™AOF
)(
RedisModuËIO
 *
io
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...);

180 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveSŒšg
)(
RedisModuËIO
 *
io
, 
RedisModuËSŒšg
 *
s
);

181 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveSŒšgBufãr
)(
RedisModuËIO
 *
io
, cÚ¡ *
¡r
, 
size_t
 
Ën
);

182 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdSŒšg
)(
RedisModuËIO
 *
io
);

183 *
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdSŒšgBufãr
)(
RedisModuËIO
 *
io
, 
size_t
 *
ËÅŒ
);

184 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveDoubË
)(
RedisModuËIO
 *
io
, 
v®ue
);

185 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdDoubË
)(
RedisModuËIO
 *
io
);

186 
	$REDISMODULE_API_FUNC
(
RedisModuË_Log
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Ëv–
, cÚ¡ *
fmt
, ...);

189 
	$RedisModuË_In™
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
è
	`__©Œibu‹__
((
unu£d
));

190 
	$RedisModuË_In™
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
) {

191 *
g‘­ifunıŒ
 = ((**)
ùx
)[0];

192 
RedisModuË_G‘Api
 = ((*)(cÚ¡ *, *)è()
g‘­ifunıŒ
;

193 
	`REDISMODULE_GET_API
(
AÎoc
);

194 
	`REDISMODULE_GET_API
(
C®loc
);

195 
	`REDISMODULE_GET_API
(
F»e
);

196 
	`REDISMODULE_GET_API
(
R—Îoc
);

197 
	`REDISMODULE_GET_API
(
SŒdup
);

198 
	`REDISMODULE_GET_API
(
C»©eCommªd
);

199 
	`REDISMODULE_GET_API
(
S‘ModuËA‰ribs
);

200 
	`REDISMODULE_GET_API
(
WrÚgAr™y
);

201 
	`REDISMODULE_GET_API
(
R•lyW™hLÚgLÚg
);

202 
	`REDISMODULE_GET_API
(
R•lyW™hE¼Ü
);

203 
	`REDISMODULE_GET_API
(
R•lyW™hSim¶eSŒšg
);

204 
	`REDISMODULE_GET_API
(
R•lyW™hA¼ay
);

205 
	`REDISMODULE_GET_API
(
R•lyS‘A¼ayL’gth
);

206 
	`REDISMODULE_GET_API
(
R•lyW™hSŒšgBufãr
);

207 
	`REDISMODULE_GET_API
(
R•lyW™hSŒšg
);

208 
	`REDISMODULE_GET_API
(
R•lyW™hNuÎ
);

209 
	`REDISMODULE_GET_API
(
R•lyW™hC®lR•ly
);

210 
	`REDISMODULE_GET_API
(
R•lyW™hDoubË
);

211 
	`REDISMODULE_GET_API
(
R•lyS‘A¼ayL’gth
);

212 
	`REDISMODULE_GET_API
(
G‘S–eùedDb
);

213 
	`REDISMODULE_GET_API
(
S–eùDb
);

214 
	`REDISMODULE_GET_API
(
O³nKey
);

215 
	`REDISMODULE_GET_API
(
Clo£Key
);

216 
	`REDISMODULE_GET_API
(
KeyTy³
);

217 
	`REDISMODULE_GET_API
(
V®ueL’gth
);

218 
	`REDISMODULE_GET_API
(
Li¡Push
);

219 
	`REDISMODULE_GET_API
(
Li¡Pİ
);

220 
	`REDISMODULE_GET_API
(
SŒšgToLÚgLÚg
);

221 
	`REDISMODULE_GET_API
(
SŒšgToDoubË
);

222 
	`REDISMODULE_GET_API
(
C®l
);

223 
	`REDISMODULE_GET_API
(
C®lR•lyPrÙo
);

224 
	`REDISMODULE_GET_API
(
F»eC®lR•ly
);

225 
	`REDISMODULE_GET_API
(
C®lR•lyIÁeg”
);

226 
	`REDISMODULE_GET_API
(
C®lR•lyTy³
);

227 
	`REDISMODULE_GET_API
(
C®lR•lyL’gth
);

228 
	`REDISMODULE_GET_API
(
C®lR•lyA¼ayEËm’t
);

229 
	`REDISMODULE_GET_API
(
C®lR•lySŒšgPŒ
);

230 
	`REDISMODULE_GET_API
(
C»©eSŒšgFromC®lR•ly
);

231 
	`REDISMODULE_GET_API
(
C»©eSŒšg
);

232 
	`REDISMODULE_GET_API
(
C»©eSŒšgFromLÚgLÚg
);

233 
	`REDISMODULE_GET_API
(
C»©eSŒšgFromSŒšg
);

234 
	`REDISMODULE_GET_API
(
F»eSŒšg
);

235 
	`REDISMODULE_GET_API
(
SŒšgPŒL’
);

236 
	`REDISMODULE_GET_API
(
AutoMemÜy
);

237 
	`REDISMODULE_GET_API
(
R•liÿ‹
);

238 
	`REDISMODULE_GET_API
(
R•liÿ‹V”b©im
);

239 
	`REDISMODULE_GET_API
(
D–‘eKey
);

240 
	`REDISMODULE_GET_API
(
SŒšgS‘
);

241 
	`REDISMODULE_GET_API
(
SŒšgDMA
);

242 
	`REDISMODULE_GET_API
(
SŒšgTrunÿ‹
);

243 
	`REDISMODULE_GET_API
(
G‘Expœe
);

244 
	`REDISMODULE_GET_API
(
S‘Expœe
);

245 
	`REDISMODULE_GET_API
(
Z£tAdd
);

246 
	`REDISMODULE_GET_API
(
Z£tInüby
);

247 
	`REDISMODULE_GET_API
(
Z£tScÜe
);

248 
	`REDISMODULE_GET_API
(
Z£tRem
);

249 
	`REDISMODULE_GET_API
(
Z£tRªgeStİ
);

250 
	`REDISMODULE_GET_API
(
Z£tFœ¡InScÜeRªge
);

251 
	`REDISMODULE_GET_API
(
Z£tLa¡InScÜeRªge
);

252 
	`REDISMODULE_GET_API
(
Z£tFœ¡InLexRªge
);

253 
	`REDISMODULE_GET_API
(
Z£tLa¡InLexRªge
);

254 
	`REDISMODULE_GET_API
(
Z£tRªgeCu¼’tEËm’t
);

255 
	`REDISMODULE_GET_API
(
Z£tRªgeNext
);

256 
	`REDISMODULE_GET_API
(
Z£tRªgeP»v
);

257 
	`REDISMODULE_GET_API
(
Z£tRªgeEndR—ched
);

258 
	`REDISMODULE_GET_API
(
HashS‘
);

259 
	`REDISMODULE_GET_API
(
HashG‘
);

260 
	`REDISMODULE_GET_API
(
IsKeysPos™iÚReque¡
);

261 
	`REDISMODULE_GET_API
(
KeyAtPos
);

262 
	`REDISMODULE_GET_API
(
G‘Cl›ÁId
);

263 
	`REDISMODULE_GET_API
(
PoŞAÎoc
);

264 
	`REDISMODULE_GET_API
(
C»©eD©aTy³
);

265 
	`REDISMODULE_GET_API
(
ModuËTy³S‘V®ue
);

266 
	`REDISMODULE_GET_API
(
ModuËTy³G‘Ty³
);

267 
	`REDISMODULE_GET_API
(
ModuËTy³G‘V®ue
);

268 
	`REDISMODULE_GET_API
(
SaveUnsigÃd
);

269 
	`REDISMODULE_GET_API
(
LßdUnsigÃd
);

270 
	`REDISMODULE_GET_API
(
SaveSigÃd
);

271 
	`REDISMODULE_GET_API
(
LßdSigÃd
);

272 
	`REDISMODULE_GET_API
(
SaveSŒšg
);

273 
	`REDISMODULE_GET_API
(
SaveSŒšgBufãr
);

274 
	`REDISMODULE_GET_API
(
LßdSŒšg
);

275 
	`REDISMODULE_GET_API
(
LßdSŒšgBufãr
);

276 
	`REDISMODULE_GET_API
(
SaveDoubË
);

277 
	`REDISMODULE_GET_API
(
LßdDoubË
);

278 
	`REDISMODULE_GET_API
(
Em™AOF
);

279 
	`REDISMODULE_GET_API
(
Log
);

281 
	`RedisModuË_S‘ModuËA‰ribs
(
ùx
,
Çme
,
v”
,
­iv”
);

282  
REDISMODULE_OK
;

283 
	}
}

289 
	#RedisModuËSŒšg
 
robj


	)

	@release.c

34 
	~<¡ršg.h
>

36 
	~"»Ëa£.h
"

37 
	~"v”siÚ.h
"

38 
	~"üc64.h
"

40 *
	$»disG™SHA1
() {

41  
REDIS_GIT_SHA1
;

42 
	}
}

44 *
	$»disG™Dœty
() {

45  
REDIS_GIT_DIRTY
;

46 
	}
}

48 
ušt64_t
 
	$»disBudId
() {

49 *
budid
 = 
REDIS_VERSION
 
REDIS_BUILD_ID
 
REDIS_GIT_DIRTY
 
REDIS_GIT_SHA1
;

51  
	`üc64
(0,(*)
budid
,
	`¡¾’
(buildid));

52 
	}
}

	@replication.c

32 
	~"£rv”.h
"

34 
	~<sys/time.h
>

35 
	~<uni¡d.h
>

36 
	~<fú.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/¡©.h
>

40 
»¶iÿtiÚDisÿrdCachedMa¡”
();

41 
»¶iÿtiÚResu¼eùCachedMa¡”
(
Ãwfd
);

42 
»¶iÿtiÚS’dAck
();

43 
putSÏveOÆše
(
ş›Á
 *
¦ave
);

44 
ÿnûlR•liÿtiÚHªdshake
();

52 *
	$»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
) {

53 
buf
[
NET_PEER_ID_LEN
];

54 

[
NET_IP_STR_LEN
];

56 

[0] = '\0';

57 
buf
[0] = '\0';

58 ià(
	`ª‘P“rToSŒšg
(
c
->
fd
,

,(),
NULL
) != -1) {

59 ià(
c
->
¦ave_li¡’šg_pÜt
)

60 
	`ª‘FÜm©Addr
(
buf
,(buf),

,
c
->
¦ave_li¡’šg_pÜt
);

62 
	`¢´štf
(
buf
,(buf),"%s:<unknown-¦ave-pÜt>",

);

64 
	`¢´štf
(
buf
,(buf),"client id #%llu",

65 (è
c
->
id
);

67  
buf
;

68 
	}
}

72 
	$ü—‹R•liÿtiÚBacklog
() {

73 
	`£rv”As£¹
(
£rv”
.
»¶_backlog
 =ğ
NULL
);

74 
£rv”
.
»¶_backlog
 = 
	`zm®loc
(£rv”.
»¶_backlog_size
);

75 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

76 
£rv”
.
»¶_backlog_idx
 = 0;

81 
£rv”
.
ma¡”_»¶_off£t
++;

86 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
+1;

87 
	}
}

95 
	$»sizeR•liÿtiÚBacklog
(
Ãwsize
) {

96 ià(
Ãwsize
 < 
CONFIG_REPL_BACKLOG_MIN_SIZE
)

97 
Ãwsize
 = 
CONFIG_REPL_BACKLOG_MIN_SIZE
;

98 ià(
£rv”
.
»¶_backlog_size
 =ğ
Ãwsize
) ;

100 
£rv”
.
»¶_backlog_size
 = 
Ãwsize
;

101 ià(
£rv”
.
»¶_backlog
 !ğ
NULL
) {

107 
	`zä“
(
£rv”
.
»¶_backlog
);

108 
£rv”
.
»¶_backlog
 = 
	`zm®loc
(£rv”.
»¶_backlog_size
);

109 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

110 
£rv”
.
»¶_backlog_idx
 = 0;

112 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
+1;

114 
	}
}

116 
	$ä“R•liÿtiÚBacklog
() {

117 
	`£rv”As£¹
(
	`li¡L’gth
(
£rv”
.
¦aves
) == 0);

118 
	`zä“
(
£rv”
.
»¶_backlog
);

119 
£rv”
.
»¶_backlog
 = 
NULL
;

120 
	}
}

126 
	$ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
) {

127 *
p
 = 
±r
;

129 
£rv”
.
ma¡”_»¶_off£t
 +ğ
Ën
;

133 
Ën
) {

134 
size_t
 
thi¦’
 = 
£rv”
.
»¶_backlog_size
 - s”v”.
»¶_backlog_idx
;

135 ià(
thi¦’
 > 
Ën
)hislen =†en;

136 
	`memıy
(
£rv”
.
»¶_backlog
+£rv”.
»¶_backlog_idx
,
p
,
thi¦’
);

137 
£rv”
.
»¶_backlog_idx
 +ğ
thi¦’
;

138 ià(
£rv”
.
»¶_backlog_idx
 =ğ£rv”.
»¶_backlog_size
)

139 
£rv”
.
»¶_backlog_idx
 = 0;

140 
Ën
 -ğ
thi¦’
;

141 
p
 +ğ
thi¦’
;

142 
£rv”
.
»¶_backlog_hi¡Ën
 +ğ
thi¦’
;

144 ià(
£rv”
.
»¶_backlog_hi¡Ën
 > s”v”.
»¶_backlog_size
)

145 
£rv”
.
»¶_backlog_hi¡Ën
 = s”v”.
»¶_backlog_size
;

147 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
 -

148 
£rv”
.
»¶_backlog_hi¡Ën
 + 1;

149 
	}
}

153 
	$ãedR•liÿtiÚBacklogW™hObjeù
(
robj
 *
o
) {

154 
Î¡r
[
LONG_STR_SIZE
];

155 *
p
;

156 
size_t
 
Ën
;

158 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

159 
Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),()
o
->
±r
);

160 
p
 = 
Î¡r
;

162 
Ën
 = 
	`sd¦’
(
o
->
±r
);

163 
p
 = 
o
->
±r
;

165 
	`ãedR•liÿtiÚBacklog
(
p
,
Ën
);

166 
	}
}

168 
	$»¶iÿtiÚF“dSÏves
(
li¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

169 
li¡Node
 *
Ê
;

170 
li¡I‹r
 
li
;

171 
j
, 
Ën
;

172 
Î¡r
[
LONG_STR_SIZE
];

176 ià(
£rv”
.
»¶_backlog
 =ğ
NULL
 && 
	`li¡L’gth
(
¦aves
) == 0) ;

179 
	`£rv”As£¹
(!(
	`li¡L’gth
(
¦aves
è!ğ0 && 
£rv”
.
»¶_backlog
 =ğ
NULL
));

182 ià(
£rv”
.
¦ave£ldb
 !ğ
diùid
) {

183 
robj
 *
£Ëùcmd
;

186 ià(
diùid
 >ğ0 && diùid < 
PROTO_SHARED_SELECT_CMDS
) {

187 
£Ëùcmd
 = 
sh¬ed
.
£Ëù
[
diùid
];

189 
diùid_Ën
;

191 
diùid_Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),
diùid
);

192 
£Ëùcmd
 = 
	`ü—‹Objeù
(
OBJ_STRING
,

193 
	`sdsÿrštf
(
	`sd£m±y
(),

195 
diùid_Ën
, 
Î¡r
));

199 ià(
£rv”
.
»¶_backlog
è
	`ãedR•liÿtiÚBacklogW™hObjeù
(
£Ëùcmd
);

202 
	`li¡Rewšd
(
¦aves
,&
li
);

203 (
Ê
 = 
	`li¡Next
(&
li
))) {

204 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

205 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

206 
	`addR•ly
(
¦ave
,
£Ëùcmd
);

209 ià(
diùid
 < 0 || diùid >ğ
PROTO_SHARED_SELECT_CMDS
)

210 
	`deüRefCouÁ
(
£Ëùcmd
);

212 
£rv”
.
¦ave£ldb
 = 
diùid
;

215 ià(
£rv”
.
»¶_backlog
) {

216 
aux
[
LONG_STR_SIZE
+3];

219 
aux
[0] = '*';

220 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
¬gc
);

221 
aux
[
Ën
+1] = '\r';

222 
aux
[
Ën
+2] = '\n';

223 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

225 
j
 = 0; j < 
¬gc
; j++) {

226 
objËn
 = 
	`¡ršgObjeùL’
(
¬gv
[
j
]);

231 
aux
[0] = '$';

232 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
objËn
);

233 
aux
[
Ën
+1] = '\r';

234 
aux
[
Ën
+2] = '\n';

235 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

236 
	`ãedR•liÿtiÚBacklogW™hObjeù
(
¬gv
[
j
]);

237 
	`ãedR•liÿtiÚBacklog
(
aux
+
Ën
+1,2);

242 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

243 (
Ê
 = 
	`li¡Next
(&
li
))) {

244 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

247 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

254 
	`addR•lyMuÉiBulkL’
(
¦ave
,
¬gc
);

258 
j
 = 0; j < 
¬gc
; j++)

259 
	`addR•lyBulk
(
¦ave
,
¬gv
[
j
]);

261 
	}
}

263 
	$»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
li¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

264 
li¡Node
 *
Ê
;

265 
li¡I‹r
 
li
;

266 
j
;

267 
sds
 
cmd»´
 = 
	`sd¢ew
("+");

268 
robj
 *
cmdobj
;

269 
timev®
 
tv
;

271 
	`g‘timeofday
(&
tv
,
NULL
);

272 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"%ld.%06ld ",()
tv
.
tv_£c
,(év.
tv_u£c
);

273 ià(
c
->
æags
 & 
CLIENT_LUA
) {

274 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d†ua] ",
diùid
);

275 } ià(
c
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

276 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d unix:%s] ",
diùid
,
£rv”
.
unixsock‘
);

278 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d %s] ",
diùid
,
	`g‘Cl›ÁP“rId
(
c
));

281 
j
 = 0; j < 
¬gc
; j++) {

282 ià(
¬gv
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

283 
cmd»´
 = 
	`sdsÿrštf
(cmd»´, "\"%ld\"", ()
¬gv
[
j
]->
±r
);

285 
cmd»´
 = 
	`sdsÿŒ•r
(cmd»´,(*)
¬gv
[
j
]->
±r
,

286 
	`sd¦’
(
¬gv
[
j
]->
±r
));

288 ià(
j
 !ğ
¬gc
-1)

289 
cmd»´
 = 
	`sdsÿ’
(cmdrepr," ",1);

291 
cmd»´
 = 
	`sdsÿ’
(cmdrepr,"\r\n",2);

292 
cmdobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
cmd»´
);

294 
	`li¡Rewšd
(
mÚ™Üs
,&
li
);

295 (
Ê
 = 
	`li¡Next
(&
li
))) {

296 
ş›Á
 *
mÚ™Ü
 = 
Ê
->
v®ue
;

297 
	`addR•ly
(
mÚ™Ü
,
cmdobj
);

299 
	`deüRefCouÁ
(
cmdobj
);

300 
	}
}

304 
	$addR•lyR•liÿtiÚBacklog
(
ş›Á
 *
c
, 
off£t
) {

305 
j
, 
sk
, 
Ën
;

307 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] SÏv»que¡ off£t: %Îd", 
off£t
);

309 ià(
£rv”
.
»¶_backlog_hi¡Ën
 == 0) {

310 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Backlog history†en is zero");

314 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Backlog size: %lld",

315 
£rv”
.
»¶_backlog_size
);

316 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] First byte: %lld",

317 
£rv”
.
»¶_backlog_off
);

318 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] History†en: %lld",

319 
£rv”
.
»¶_backlog_hi¡Ën
);

320 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Current index: %lld",

321 
£rv”
.
»¶_backlog_idx
);

324 
sk
 = 
off£t
 - 
£rv”
.
»¶_backlog_off
;

325 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Skpšg: %Îd", 
sk
);

329 
j
 = (
£rv”
.
»¶_backlog_idx
 +

330 (
£rv”
.
»¶_backlog_size
-£rv”.
»¶_backlog_hi¡Ën
)) %

331 
£rv”
.
»¶_backlog_size
;

332 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Index oàfœ¡ by‹: %Îd", 
j
);

335 
j
 = (j + 
sk
è% 
£rv”
.
»¶_backlog_size
;

339 
Ën
 = 
£rv”
.
»¶_backlog_hi¡Ën
 - 
sk
;

340 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] R•lyÙ®†’gth: %Îd", 
Ën
);

341 
Ën
) {

342 
thi¦’
 =

343 ((
£rv”
.
»¶_backlog_size
 - 
j
è< 
Ën
) ?

344 (
£rv”
.
»¶_backlog_size
 - 
j
è: 
Ën
;

346 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC]‡ddR•ly(èËngth: %Îd", 
thi¦’
);

347 
	`addR•lySds
(
c
,
	`sd¢ewËn
(
£rv”
.
»¶_backlog
 + 
j
, 
thi¦’
));

348 
Ën
 -ğ
thi¦’
;

349 
j
 = 0;

351  
£rv”
.
»¶_backlog_hi¡Ën
 - 
sk
;

352 
	}
}

358 
	$g‘PsyncIn™ŸlOff£t
() {

359 
psync_off£t
 = 
£rv”
.
ma¡”_»¶_off£t
;

362 ià(
£rv”
.
»¶_backlog
 =ğ
NULL
è
psync_off£t
++;

363  
psync_off£t
;

364 
	}
}

382 
	$»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
ş›Á
 *
¦ave
, 
off£t
) {

383 
buf
[128];

384 
buæ’
;

386 
¦ave
->
psync_š™Ÿl_off£t
 = 
off£t
;

387 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_END
;

391 
£rv”
.
¦ave£ldb
 = -1;

395 ià(!(
¦ave
->
æags
 & 
CLIENT_PRE_PSYNC
)) {

396 
buæ’
 = 
	`¢´štf
(
buf
,(buf),"+FULLRESYNC %s %lld\r\n",

397 
£rv”
.
runid
,
off£t
);

398 ià(
	`wr™e
(
¦ave
->
fd
,
buf
,
buæ’
) != buflen) {

399 
	`ä“Cl›ÁAsync
(
¦ave
);

400  
C_ERR
;

403  
C_OK
;

404 
	}
}

411 
	$ma¡”TryP¬tŸlResynchrÚiz©iÚ
(
ş›Á
 *
c
) {

412 
psync_off£t
, 
psync_Ën
;

413 *
ma¡”_runid
 = 
c
->
¬gv
[1]->
±r
;

414 
buf
[128];

415 
buæ’
;

420 ià(
	`¡rÿ£cmp
(
ma¡”_runid
, 
£rv”
.
runid
)) {

422 ià(
ma¡”_runid
[0] != '?') {

423 
	`£rv”Log
(
LL_NOTICE
,"Partial„esynchronization‚ot‡ccepted: "

425 
ma¡”_runid
, 
£rv”
.
runid
);

427 
	`£rv”Log
(
LL_NOTICE
,"Full„esync„equested by slave %s",

428 
	`»¶iÿtiÚG‘SÏveName
(
c
));

430 
Ãed_fuÎ_»sync
;

434 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
psync_off£t
,
NULL
) !=

435 
C_OK
è
Ãed_fuÎ_»sync
;

436 ià(!
£rv”
.
»¶_backlog
 ||

437 
psync_off£t
 < 
£rv”
.
»¶_backlog_off
 ||

438 
psync_off£t
 > (
£rv”
.
»¶_backlog_off
 + s”v”.
»¶_backlog_hi¡Ën
))

440 
	`£rv”Log
(
LL_NOTICE
,

441 "UÇbËØ·¹ŸÈ»synøw™h sÏv% fÜ†ack oàbacklog (SÏv»que¡ was: %Îd).", 
	`»¶iÿtiÚG‘SÏveName
(
c
), 
psync_off£t
);

442 ià(
psync_off£t
 > 
£rv”
.
ma¡”_»¶_off£t
) {

443 
	`£rv”Log
(
LL_WARNING
,

444 "W¬nšg: sÏv% Œ›dØPSYNC w™h‡Àoff£ˆth© i g»©”hªhma¡”„•liÿtiÚ off£t.", 
	`»¶iÿtiÚG‘SÏveName
(
c
));

446 
Ãed_fuÎ_»sync
;

453 
c
->
æags
 |ğ
CLIENT_SLAVE
;

454 
c
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

455 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

456 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

457 
	`li¡AddNodeTa
(
£rv”
.
¦aves
,
c
);

461 
buæ’
 = 
	`¢´štf
(
buf
,(buf),"+CONTINUE\r\n");

462 ià(
	`wr™e
(
c
->
fd
,
buf
,
buæ’
) != buflen) {

463 
	`ä“Cl›ÁAsync
(
c
);

464  
C_OK
;

466 
psync_Ën
 = 
	`addR•lyR•liÿtiÚBacklog
(
c
,
psync_off£t
);

467 
	`£rv”Log
(
LL_NOTICE
,

469 
	`»¶iÿtiÚG‘SÏveName
(
c
),

470 
psync_Ën
, 
psync_off£t
);

475 
	`»äeshGoodSÏvesCouÁ
();

476  
C_OK
;

478 
Ãed_fuÎ_»sync
:

483  
C_ERR
;

484 
	}
}

504 
	$¡¬tBg§veFÜR•liÿtiÚ
(
mšÿ·
) {

505 
»tv®
;

506 
sock‘_rg‘
 = 
£rv”
.
»¶_diskËss_sync
 && (
mšÿ·
 & 
SLAVE_CAPA_EOF
);

507 
li¡I‹r
 
li
;

508 
li¡Node
 *
Ê
;

510 
	`£rv”Log
(
LL_NOTICE
,"Starting BGSAVE for SYNC witharget: %s",

511 
sock‘_rg‘
 ? "slaves sockets" : "disk");

513 ià(
sock‘_rg‘
)

514 
»tv®
 = 
	`rdbSaveToSÏvesSock‘s
();

516 
»tv®
 = 
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
);

521 ià(
»tv®
 =ğ
C_ERR
) {

522 
	`£rv”Log
(
LL_WARNING
,"BGSAVE for„eplication failed");

523 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

524 (
Ê
 = 
	`li¡Next
(&
li
))) {

525 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

527 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

528 
¦ave
->
æags
 &ğ~
CLIENT_SLAVE
;

529 
	`li¡D–Node
(
£rv”
.
¦aves
,
Ê
);

530 
	`addR•lyE¼Ü
(
¦ave
,

532 
¦ave
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

535  
»tv®
;

540 ià(!
sock‘_rg‘
) {

541 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

542 (
Ê
 = 
	`li¡Next
(&
li
))) {

543 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

545 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

546 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
¦ave
,

547 
	`g‘PsyncIn™ŸlOff£t
());

554 ià(
»tv®
 =ğ
C_OK
è
	`»¶iÿtiÚSütCacheFlush
();

555  
»tv®
;

556 
	}
}

559 
	$syncCommªd
(
ş›Á
 *
c
) {

561 ià(
c
->
æags
 & 
CLIENT_SLAVE
) ;

565 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
) {

566 
	`addR•lyE¼Ü
(
c
,"Can't SYNC while‚ot connected with my master");

574 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

575 
	`addR•lyE¼Ü
(
c
,"SYNC‡nd PSYNC‡re invalid with…ending output");

579 
	`£rv”Log
(
LL_NOTICE
,"Slave %s‡sks for synchronization",

580 
	`»¶iÿtiÚG‘SÏveName
(
c
));

591 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"psync")) {

592 ià(
	`ma¡”TryP¬tŸlResynchrÚiz©iÚ
(
c
è=ğ
C_OK
) {

593 
£rv”
.
¡©_sync_·¹Ÿl_ok
++;

596 *
ma¡”_runid
 = 
c
->
¬gv
[1]->
±r
;

602 ià(
ma¡”_runid
[0] !ğ'?'è
£rv”
.
¡©_sync_·¹Ÿl_”r
++;

608 
c
->
æags
 |ğ
CLIENT_PRE_PSYNC
;

612 
£rv”
.
¡©_sync_fuÎ
++;

616 
c
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_START
;

617 ià(
£rv”
.
»¶_di§bË_tı_nod–ay
)

618 
	`ª‘Di§bËTıNoD–ay
(
NULL
, 
c
->
fd
);

619 
c
->
»¶dbfd
 = -1;

620 
c
->
æags
 |ğ
CLIENT_SLAVE
;

621 
	`li¡AddNodeTa
(
£rv”
.
¦aves
,
c
);

624 ià(
£rv”
.
rdb_chd_pid
 != -1 &&

625 
£rv”
.
rdb_chd_ty³
 =ğ
RDB_CHILD_TYPE_DISK
)

630 
ş›Á
 *
¦ave
;

631 
li¡Node
 *
Ê
;

632 
li¡I‹r
 
li
;

634 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

635 (
Ê
 = 
	`li¡Next
(&
li
))) {

636 
¦ave
 = 
Ê
->
v®ue
;

637 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
) ;

641 ià(
Ê
 && ((
c
->
¦ave_ÿ·
 & 
¦ave
->slave_capa) == slave->slave_capa)) {

644 
	`cİyCl›ÁOuutBufãr
(
c
,
¦ave
);

645 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
c
,
¦ave
->
psync_š™Ÿl_off£t
);

646 
	`£rv”Log
(
LL_NOTICE
,"Waiting forƒnd of BGSAVE for SYNC");

650 
	`£rv”Log
(
LL_NOTICE
,"Waiting for‚ext BGSAVE for SYNC");

654 } ià(
£rv”
.
rdb_chd_pid
 != -1 &&

655 
£rv”
.
rdb_chd_ty³
 =ğ
RDB_CHILD_TYPE_SOCKET
)

660 
	`£rv”Log
(
LL_NOTICE
,"Waiting for‚ext BGSAVE for SYNC");

664 ià(
£rv”
.
»¶_diskËss_sync
 && (
c
->
¦ave_ÿ·
 & 
SLAVE_CAPA_EOF
)) {

668 ià(
£rv”
.
»¶_diskËss_sync_d–ay
)

669 
	`£rv”Log
(
LL_NOTICE
,"Delay‚ext BGSAVE for SYNC");

674 ià(
	`¡¬tBg§veFÜR•liÿtiÚ
(
c
->
¦ave_ÿ·
è!ğ
C_OK
) ;

678 ià(
	`li¡L’gth
(
£rv”
.
¦aves
è=ğ1 && s”v”.
»¶_backlog
 =ğ
NULL
)

679 
	`ü—‹R•liÿtiÚBacklog
();

681 
	}
}

695 
	$»¶cÚfCommªd
(
ş›Á
 *
c
) {

696 
j
;

698 ià((
c
->
¬gc
 % 2) == 0) {

701 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

706 
j
 = 1; j < 
c
->
¬gc
; j+=2) {

707 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"listening-port")) {

708 
pÜt
;

710 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+1],

711 &
pÜt
,
NULL
è!ğ
C_OK
))

713 
c
->
¦ave_li¡’šg_pÜt
 = 
pÜt
;

714 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"capa")) {

716 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
+1]->
±r
,"eof"))

717 
c
->
¦ave_ÿ·
 |ğ
SLAVE_CAPA_EOF
;

718 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"ack")) {

722 
off£t
;

724 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
)) ;

725 ià((
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[
j
+1], &
off£t
è!ğ
C_OK
))

727 ià(
off£t
 > 
c
->
»¶_ack_off
)

728 
c
->
»¶_ack_off
 = 
off£t
;

729 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

733 ià(
c
->
»¶_put_Úlše_Ú_ack
 && c->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
)

734 
	`putSÏveOÆše
(
c
);

737 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"getack")) {

740 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
ma¡”
è
	`»¶iÿtiÚS’dAck
();

743 
	`addR•lyE¼ÜFÜm©
(
c
,"Unrecognized REPLCONF option: %s",

744 (*)
c
->
¬gv
[
j
]->
±r
);

748 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

749 
	}
}

763 
	$putSÏveOÆše
(
ş›Á
 *
¦ave
) {

764 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

765 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 0;

766 
¦ave
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

767 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
¦ave
->
fd
, 
AE_WRITABLE
,

768 
£ndR•lyToCl›Á
, 
¦ave
è=ğ
AE_ERR
) {

769 
	`£rv”Log
(
LL_WARNING
,"UÇbËØ»gi¡” wr™abËƒv’ˆfÜ sÏvbulk¿nsãr: %s", 
	`¡»¼Ü
(
”ºo
));

770 
	`ä“Cl›Á
(
¦ave
);

773 
	`»äeshGoodSÏvesCouÁ
();

774 
	`£rv”Log
(
LL_NOTICE
,"Synchronization with slave %s succeeded",

775 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

776 
	}
}

778 
	$£ndBulkToSÏve
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

779 
ş›Á
 *
¦ave
 = 
´ivd©a
;

780 
	`UNUSED
(
–
);

781 
	`UNUSED
(
mask
);

782 
buf
[
PROTO_IOBUF_LEN
];

783 
ssize_t
 
nwr™‹n
, 
buæ’
;

788 ià(
¦ave
->
»¶´—mbË
) {

789 
nwr™‹n
 = 
	`wr™e
(
fd
,
¦ave
->
»¶´—mbË
,
	`sd¦’
(slave->replpreamble));

790 ià(
nwr™‹n
 == -1) {

791 
	`£rv”Log
(
LL_VERBOSE
,"Writeƒrror sending RDB…reambleo slave: %s",

792 
	`¡»¼Ü
(
”ºo
));

793 
	`ä“Cl›Á
(
¦ave
);

796 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
nwr™‹n
;

797 
	`sd¤ªge
(
¦ave
->
»¶´—mbË
,
nwr™‹n
,-1);

798 ià(
	`sd¦’
(
¦ave
->
»¶´—mbË
) == 0) {

799 
	`sdsä“
(
¦ave
->
»¶´—mbË
);

800 
¦ave
->
»¶´—mbË
 = 
NULL
;

808 
	`l£ek
(
¦ave
->
»¶dbfd
,¦ave->
»¶dboff
,
SEEK_SET
);

809 
buæ’
 = 
	`»ad
(
¦ave
->
»¶dbfd
,
buf
,
PROTO_IOBUF_LEN
);

810 ià(
buæ’
 <= 0) {

811 
	`£rv”Log
(
LL_WARNING
,"Readƒrror sending DBo slave: %s",

812 (
buæ’
 =ğ0è? "´em©u» EOF" : 
	`¡»¼Ü
(
”ºo
));

813 
	`ä“Cl›Á
(
¦ave
);

816 ià((
nwr™‹n
 = 
	`wr™e
(
fd
,
buf
,
buæ’
)) == -1) {

817 ià(
”ºo
 !ğ
EAGAIN
) {

818 
	`£rv”Log
(
LL_WARNING
,"Writeƒrror sending DBo slave: %s",

819 
	`¡»¼Ü
(
”ºo
));

820 
	`ä“Cl›Á
(
¦ave
);

824 
¦ave
->
»¶dboff
 +ğ
nwr™‹n
;

825 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
nwr™‹n
;

826 ià(
¦ave
->
»¶dboff
 =ğ¦ave->
»¶dbsize
) {

827 
	`şo£
(
¦ave
->
»¶dbfd
);

828 
¦ave
->
»¶dbfd
 = -1;

829 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
¦ave
->
fd
,
AE_WRITABLE
);

830 
	`putSÏveOÆše
(
¦ave
);

832 
	}
}

848 
	$upd©eSÏvesWa™šgBg§ve
(
bg§v“¼
, 
ty³
) {

849 
li¡Node
 *
Ê
;

850 
¡¬tbg§ve
 = 0;

851 
mšÿ·
 = -1;

852 
li¡I‹r
 
li
;

854 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

855 (
Ê
 = 
	`li¡Next
(&
li
))) {

856 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

858 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

859 
¡¬tbg§ve
 = 1;

860 
mšÿ·
 = (mšÿ· =ğ-1è? 
¦ave
->
¦ave_ÿ·
 :

861 (
mšÿ·
 & 
¦ave
->
¦ave_ÿ·
);

862 } ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
) {

863 
»dis_¡©
 
buf
;

870 ià(
ty³
 =ğ
RDB_CHILD_TYPE_SOCKET
) {

871 
	`£rv”Log
(
LL_NOTICE
,

873 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

879 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

880 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 1;

881 
¦ave
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

883 ià(
bg§v“¼
 !ğ
C_OK
) {

884 
	`ä“Cl›Á
(
¦ave
);

885 
	`£rv”Log
(
LL_WARNING
,"SYNC failed. BGSAVE child„eturned‡nƒrror");

888 ià((
¦ave
->
»¶dbfd
 = 
	`İ’
(
£rv”
.
rdb_f’ame
,
O_RDONLY
)) == -1 ||

889 
	`»dis_f¡©
(
¦ave
->
»¶dbfd
,&
buf
) == -1) {

890 
	`ä“Cl›Á
(
¦ave
);

891 
	`£rv”Log
(
LL_WARNING
,"SYNC faed. Cª'ˆİ’/¡© DB‡á” BGSAVE: %s", 
	`¡»¼Ü
(
”ºo
));

894 
¦ave
->
»¶dboff
 = 0;

895 
¦ave
->
»¶dbsize
 = 
buf
.
¡_size
;

896 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_SEND_BULK
;

897 
¦ave
->
»¶´—mbË
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"$%lld\r\n",

898 (è
¦ave
->
»¶dbsize
);

900 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
¦ave
->
fd
,
AE_WRITABLE
);

901 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
¦ave
->
fd
, 
AE_WRITABLE
, 
£ndBulkToSÏve
, sÏveè=ğ
AE_ERR
) {

902 
	`ä“Cl›Á
(
¦ave
);

908 ià(
¡¬tbg§ve
è
	`¡¬tBg§veFÜR•liÿtiÚ
(
mšÿ·
);

909 
	}
}

915 
	$¦aveIsInHªdshakeS‹
() {

916  
£rv”
.
»¶_¡©e
 >ğ
REPL_STATE_RECEIVE_PONG
 &&

917 
£rv”
.
»¶_¡©e
 <ğ
REPL_STATE_RECEIVE_PSYNC
;

918 
	}
}

928 
	$»¶iÿtiÚS’dNewlšeToMa¡”
() {

929 
time_t
 
Ãwlše_£Á
;

930 ià(
	`time
(
NULL
è!ğ
Ãwlše_£Á
) {

931 
Ãwlše_£Á
 = 
	`time
(
NULL
);

932 ià(
	`wr™e
(
£rv”
.
»¶_Œªsãr_s
,"\n",1) == -1) {

936 
	}
}

940 
	$»¶iÿtiÚEm±yDbC®lback
(*
´ivd©a
) {

941 
	`UNUSED
(
´ivd©a
);

942 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

943 
	}
}

948 
	$»¶iÿtiÚC»©eMa¡”Cl›Á
(
fd
) {

949 
£rv”
.
ma¡”
 = 
	`ü—‹Cl›Á
(
fd
);

950 
£rv”
.
ma¡”
->
æags
 |ğ
CLIENT_MASTER
;

951 
£rv”
.
ma¡”
->
auth’tiÿ‹d
 = 1;

952 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECTED
;

953 
£rv”
.
ma¡”
->
»¶off
 = s”v”.
»¶_ma¡”_š™Ÿl_off£t
;

954 
	`memıy
(
£rv”
.
ma¡”
->
»¶runid
, s”v”.
»¶_ma¡”_runid
,

955 (
£rv”
.
»¶_ma¡”_runid
));

958 ià(
£rv”
.
ma¡”
->
»¶off
 == -1)

959 
£rv”
.
ma¡”
->
æags
 |ğ
CLIENT_PRE_PSYNC
;

960 
	}
}

963 
	#REPL_MAX_WRITTEN_BEFORE_FSYNC
 (1024*1024*8è

	)

964 
	$»adSyncBulkPaylßd
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

965 
buf
[4096];

966 
ssize_t
 
Ä—d
, 
»adËn
;

967 
off_t
 
Ëá
;

968 
	`UNUSED
(
–
);

969 
	`UNUSED
(
´ivd©a
);

970 
	`UNUSED
(
mask
);

974 
eofm¬k
[
CONFIG_RUN_ID_SIZE
];

975 
Ï¡by‹s
[
CONFIG_RUN_ID_SIZE
];

976 
u£m¬k
 = 0;

980 ià(
£rv”
.
»¶_Œªsãr_size
 == -1) {

981 ià(
	`syncR—dLše
(
fd
,
buf
,1024,
£rv”
.
»¶_syncio_timeout
*1000) == -1) {

982 
	`£rv”Log
(
LL_WARNING
,

984 
	`¡»¼Ü
(
”ºo
));

985 
”rÜ
;

988 ià(
buf
[0] == '-') {

989 
	`£rv”Log
(
LL_WARNING
,

991 
buf
+1);

992 
”rÜ
;

993 } ià(
buf
[0] == '\0') {

997 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

999 } ià(
buf
[0] != '$') {

1000 
	`£rv”Log
(
LL_WARNING
,"Bad…rÙocŞ from MASTER,hfœ¡ by‹ i nÙ '$' (w»ûived '%s'),‡» you su»hho¡‡nd…Üˆ¬right?", 
buf
);

1001 
”rÜ
;

1014 ià(
	`¡ºcmp
(
buf
+1,"EOF:",4è=ğ0 && 
	`¡¾’
(buf+5è>ğ
CONFIG_RUN_ID_SIZE
) {

1015 
u£m¬k
 = 1;

1016 
	`memıy
(
eofm¬k
,
buf
+5,
CONFIG_RUN_ID_SIZE
);

1017 
	`mem£t
(
Ï¡by‹s
,0,
CONFIG_RUN_ID_SIZE
);

1020 
£rv”
.
»¶_Œªsãr_size
 = 0;

1021 
	`£rv”Log
(
LL_NOTICE
,

1024 
u£m¬k
 = 0;

1025 
£rv”
.
»¶_Œªsãr_size
 = 
	`¡¹Ş
(
buf
+1,
NULL
,10);

1026 
	`£rv”Log
(
LL_NOTICE
,

1028 (è
£rv”
.
»¶_Œªsãr_size
);

1034 ià(
u£m¬k
) {

1035 
»adËn
 = (
buf
);

1037 
Ëá
 = 
£rv”
.
»¶_Œªsãr_size
 - s”v”.
»¶_Œªsãr_»ad
;

1038 
»adËn
 = (
Ëá
 < (sigÃd)(
buf
)) ?†eft : (signed)(buf);

1041 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
»adËn
);

1042 ià(
Ä—d
 <= 0) {

1043 
	`£rv”Log
(
LL_WARNING
,"I/Oƒrrorryingo sync with MASTER: %s",

1044 (
Ä—d
 =ğ-1è? 
	`¡»¼Ü
(
”ºo
) : "connection†ost");

1045 
	`ÿnûlR•liÿtiÚHªdshake
();

1048 
£rv”
.
¡©_Ãt_šput_by‹s
 +ğ
Ä—d
;

1052 
eof_»ached
 = 0;

1054 ià(
u£m¬k
) {

1056 ià(
Ä—d
 >ğ
CONFIG_RUN_ID_SIZE
) {

1057 
	`memıy
(
Ï¡by‹s
,
buf
+
Ä—d
-
CONFIG_RUN_ID_SIZE
,CONFIG_RUN_ID_SIZE);

1059 
»m
 = 
CONFIG_RUN_ID_SIZE
-
Ä—d
;

1060 
	`memmove
(
Ï¡by‹s
,Ï¡by‹s+
Ä—d
,
»m
);

1061 
	`memıy
(
Ï¡by‹s
+
»m
,
buf
,
Ä—d
);

1063 ià(
	`memcmp
(
Ï¡by‹s
,
eofm¬k
,
CONFIG_RUN_ID_SIZE
è=ğ0è
eof_»ached
 = 1;

1066 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1067 ià(
	`wr™e
(
£rv”
.
»¶_Œªsãr_fd
,
buf
,
Ä—d
) !=‚read) {

1068 
	`£rv”Log
(
LL_WARNING
,"Wr™”rÜ o¸shÜˆwr™wr™šgØthDB dum°fÃeded fÜ MASTER <-> SLAVE synchrÚiz©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1069 
”rÜ
;

1071 
£rv”
.
»¶_Œªsãr_»ad
 +ğ
Ä—d
;

1074 ià(
u£m¬k
 && 
eof_»ached
) {

1075 ià(
	`árunÿ‹
(
£rv”
.
»¶_Œªsãr_fd
,

1076 
£rv”
.
»¶_Œªsãr_»ad
 - 
CONFIG_RUN_ID_SIZE
) == -1)

1078 
	`£rv”Log
(
LL_WARNING
,"E¼ÜrunÿtšghRDB f»ûived fromhma¡” fÜ SYNC: %s", 
	`¡»¼Ü
(
”ºo
));

1079 
”rÜ
;

1086 ià(
£rv”
.
»¶_Œªsãr_»ad
 >=

1087 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 + 
REPL_MAX_WRITTEN_BEFORE_FSYNC
)

1089 
off_t
 
sync_size
 = 
£rv”
.
»¶_Œªsãr_»ad
 -

1090 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
;

1091 
	`rdb_fsync_¿nge
(
£rv”
.
»¶_Œªsãr_fd
,

1092 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
, 
sync_size
);

1093 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 +ğ
sync_size
;

1097 ià(!
u£m¬k
) {

1098 ià(
£rv”
.
»¶_Œªsãr_»ad
 =ğ£rv”.
»¶_Œªsãr_size
)

1099 
eof_»ached
 = 1;

1102 ià(
eof_»ached
) {

1103 ià(
	`»Çme
(
£rv”
.
»¶_Œªsãr_tmpfe
,£rv”.
rdb_f’ame
) == -1) {

1104 
	`£rv”Log
(
LL_WARNING
,"FaedryšgØ»Çmth‹m°DB iÁØdump.rdb iÀMASTER <-> SLAVE synchrÚiz©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1105 
	`ÿnûlR•liÿtiÚHªdshake
();

1108 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Flushing old data");

1109 
	`sigÇlFlushedDb
(-1);

1110 
	`em±yDb
(

1112 
£rv”
.
»¶_¦ave_Ïzy_æush
 ? 
EMPTYDB_ASYNC
 : 
EMPTYDB_NO_FLAGS
,

1113 
»¶iÿtiÚEm±yDbC®lback
);

1118 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
»¶_Œªsãr_s
,
AE_READABLE
);

1119 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Loading DB in memory");

1120 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
è!ğ
C_OK
) {

1121 
	`£rv”Log
(
LL_WARNING
,"Failedryingo†oadhe MASTER synchronization DB from disk");

1122 
	`ÿnûlR•liÿtiÚHªdshake
();

1126 
	`zä“
(
£rv”
.
»¶_Œªsãr_tmpfe
);

1127 
	`şo£
(
£rv”
.
»¶_Œªsãr_fd
);

1128 
	`»¶iÿtiÚC»©eMa¡”Cl›Á
(
£rv”
.
»¶_Œªsãr_s
);

1129 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Finished with success");

1133 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

1134 
»Œy
 = 10;

1136 
	`¡İAµ’dOÆy
();

1137 
»Œy
-- && 
	`¡¬tAµ’dOÆy
(è=ğ
C_ERR
) {

1138 
	`£rv”Log
(
LL_WARNING
,"Failedƒnablinghe AOF‡fter successful master synchronization! Trying it‡gain in one second.");

1139 
	`¦“p
(1);

1141 ià(!
»Œy
) {

1142 
	`£rv”Log
(
LL_WARNING
,"FATAL:his slave instance finishedhe synchronization with its master, buthe AOF can't beurned on. Exiting‚ow.");

1143 
	`ex™
(1);

1150 
”rÜ
:

1151 
	`ÿnûlR•liÿtiÚHªdshake
();

1153 
	}
}

1161 
	#SYNC_CMD_READ
 (1<<0)

	)

1162 
	#SYNC_CMD_WRITE
 (1<<1)

	)

1163 
	#SYNC_CMD_FULL
 (
SYNC_CMD_READ
|
SYNC_CMD_WRITE
)

	)

1164 *
	$£ndSynchrÚousCommªd
(
æags
, 
fd
, ...) {

1168 ià(
æags
 & 
SYNC_CMD_WRITE
) {

1169 *
¬g
;

1170 
va_li¡
 
­
;

1171 
sds
 
cmd
 = 
	`sd£m±y
();

1172 
	`va_¡¬t
(
­
,
fd
);

1175 
¬g
 = 
	`va_¬g
(
­
, *);

1176 ià(
¬g
 =ğ
NULL
) ;

1178 ià(
	`sd¦’
(
cmd
è!ğ0ècmd = 
	`sdsÿ’
(cmd," ",1);

1179 
cmd
 = 
	`sdsÿt
(cmd,
¬g
);

1181 
cmd
 = 
	`sdsÿ’
(cmd,"\r\n",2);

1184 ià(
	`syncWr™e
(
fd
,
cmd
,
	`sd¦’
(cmd),
£rv”
.
»¶_syncio_timeout
*1000)

1187 
	`sdsä“
(
cmd
);

1188  
	`sdsÿrštf
(
	`sd£m±y
(),"-Writingo master: %s",

1189 
	`¡»¼Ü
(
”ºo
));

1191 
	`sdsä“
(
cmd
);

1192 
	`va_’d
(
­
);

1196 ià(
æags
 & 
SYNC_CMD_READ
) {

1197 
buf
[256];

1199 ià(
	`syncR—dLše
(
fd
,
buf
,(buf),
£rv”
.
»¶_syncio_timeout
*1000)

1202  
	`sdsÿrštf
(
	`sd£m±y
(),"-Reading from master: %s",

1203 
	`¡»¼Ü
(
”ºo
));

1205 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1206  
	`sd¢ew
(
buf
);

1208  
NULL
;

1209 
	}
}

1258 
	#PSYNC_WRITE_ERROR
 0

	)

1259 
	#PSYNC_WAIT_REPLY
 1

	)

1260 
	#PSYNC_CONTINUE
 2

	)

1261 
	#PSYNC_FULLRESYNC
 3

	)

1262 
	#PSYNC_NOT_SUPPORTED
 4

	)

1263 
	$¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
, 
»ad_»¶y
) {

1264 *
psync_runid
;

1265 
psync_off£t
[32];

1266 
sds
 
»¶y
;

1269 ià(!
»ad_»¶y
) {

1275 
£rv”
.
»¶_ma¡”_š™Ÿl_off£t
 = -1;

1277 ià(
£rv”
.
ÿched_ma¡”
) {

1278 
psync_runid
 = 
£rv”
.
ÿched_ma¡”
->
»¶runid
;

1279 
	`¢´štf
(
psync_off£t
,Õsync_off£t),"%Îd", 
£rv”
.
ÿched_ma¡”
->
»¶off
+1);

1280 
	`£rv”Log
(
LL_NOTICE
,"Tryšg‡…¬tŸÈ»synchrÚiz©iÚ (»que¡ %s:%s).", 
psync_runid
, 
psync_off£t
);

1282 
	`£rv”Log
(
LL_NOTICE
,"Partial„esynchronization‚ot…ossible (no cached master)");

1283 
psync_runid
 = "?";

1284 
	`memıy
(
psync_off£t
,"-1",3);

1288 
»¶y
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"PSYNC",
psync_runid
,
psync_off£t
,
NULL
);

1289 ià(
»¶y
 !ğ
NULL
) {

1290 
	`£rv”Log
(
LL_WARNING
,"UÇbËØ£nd PSYNCØma¡”: %s",
»¶y
);

1291 
	`sdsä“
(
»¶y
);

1292 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
);

1293  
PSYNC_WRITE_ERROR
;

1295  
PSYNC_WAIT_REPLY
;

1299 
»¶y
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1300 ià(
	`sd¦’
(
»¶y
) == 0) {

1303 
	`sdsä“
(
»¶y
);

1304  
PSYNC_WAIT_REPLY
;

1307 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
);

1309 ià(!
	`¡ºcmp
(
»¶y
,"+FULLRESYNC",11)) {

1310 *
runid
 = 
NULL
, *
off£t
 = NULL;

1314 
runid
 = 
	`¡rchr
(
»¶y
,' ');

1315 ià(
runid
) {

1316 
runid
++;

1317 
off£t
 = 
	`¡rchr
(
runid
,' ');

1318 ià(
off£t
) offset++;

1320 ià(!
runid
 || !
off£t
 || (off£t-runid-1è!ğ
CONFIG_RUN_ID_SIZE
) {

1321 
	`£rv”Log
(
LL_WARNING
,

1327 
	`mem£t
(
£rv”
.
»¶_ma¡”_runid
,0,
CONFIG_RUN_ID_SIZE
+1);

1329 
	`memıy
(
£rv”
.
»¶_ma¡”_runid
, 
runid
, 
off£t
-runid-1);

1330 
£rv”
.
»¶_ma¡”_runid
[
CONFIG_RUN_ID_SIZE
] = '\0';

1331 
£rv”
.
»¶_ma¡”_š™Ÿl_off£t
 = 
	`¡¹Şl
(
off£t
,
NULL
,10);

1332 
	`£rv”Log
(
LL_NOTICE
,"Full„esync from master: %s:%lld",

1333 
£rv”
.
»¶_ma¡”_runid
,

1334 
£rv”
.
»¶_ma¡”_š™Ÿl_off£t
);

1337 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1338 
	`sdsä“
(
»¶y
);

1339  
PSYNC_FULLRESYNC
;

1342 ià(!
	`¡ºcmp
(
»¶y
,"+CONTINUE",9)) {

1344 
	`£rv”Log
(
LL_NOTICE
,

1346 
	`sdsä“
(
»¶y
);

1347 
	`»¶iÿtiÚResu¼eùCachedMa¡”
(
fd
);

1348  
PSYNC_CONTINUE
;

1355 ià(
	`¡ºcmp
(
»¶y
,"-ERR",4)) {

1357 
	`£rv”Log
(
LL_WARNING
,

1358 "UÃx³ùed„•lyØPSYNC from ma¡”: %s", 
»¶y
);

1360 
	`£rv”Log
(
LL_NOTICE
,

1362 "”rÜ s‹ (»¶y: %s)", 
»¶y
);

1364 
	`sdsä“
(
»¶y
);

1365 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1366  
PSYNC_NOT_SUPPORTED
;

1367 
	}
}

1369 
	$syncW™hMa¡”
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1370 
tmpfe
[256], *
”r
 = 
NULL
;

1371 
dfd
, 
maxŒ›s
 = 5;

1372 
sock”r
 = 0, 
psync_»suÉ
;

1373 
sockËn_t
 
”¾’
 = (
sock”r
);

1374 
	`UNUSED
(
–
);

1375 
	`UNUSED
(
´ivd©a
);

1376 
	`UNUSED
(
mask
);

1380 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_NONE
) {

1381 
	`şo£
(
fd
);

1386 ià(
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
sock”r
, &
”¾’
) == -1)

1387 
sock”r
 = 
”ºo
;

1388 ià(
sock”r
) {

1389 
	`£rv”Log
(
LL_WARNING
,"Error condition on socket for SYNC: %s",

1390 
	`¡»¼Ü
(
sock”r
));

1391 
”rÜ
;

1395 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTING
) {

1396 
	`£rv”Log
(
LL_NOTICE
,"Non blocking connect for SYNC firedheƒvent.");

1399 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_WRITABLE
);

1400 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_PONG
;

1403 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"PING",
NULL
);

1404 ià(
”r
è
wr™e_”rÜ
;

1409 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_PONG
) {

1410 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1417 ià(
”r
[0] != '+' &&

1418 
	`¡ºcmp
(
”r
,"-NOAUTH",7) != 0 &&

1419 
	`¡ºcmp
(
”r
,"-ERR operation‚ot…ermitted",28) != 0)

1421 
	`£rv”Log
(
LL_WARNING
,"E¼Ü„•lyØPING from ma¡”: '%s'",
”r
);

1422 
	`sdsä“
(
”r
);

1423 
”rÜ
;

1425 
	`£rv”Log
(
LL_NOTICE
,

1428 
	`sdsä“
(
”r
);

1429 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_AUTH
;

1433 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_AUTH
) {

1434 ià(
£rv”
.
ma¡”auth
) {

1435 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"AUTH",
£rv”
.
ma¡”auth
,
NULL
);

1436 ià(
”r
è
wr™e_”rÜ
;

1437 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_AUTH
;

1440 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_PORT
;

1445 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_AUTH
) {

1446 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1447 ià(
”r
[0] == '-') {

1448 
	`£rv”Log
(
LL_WARNING
,"UÇbËØAUTHØMASTER: %s",
”r
);

1449 
	`sdsä“
(
”r
);

1450 
”rÜ
;

1452 
	`sdsä“
(
”r
);

1453 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_PORT
;

1458 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_PORT
) {

1459 
sds
 
pÜt
 = 
	`sdsäomlÚglÚg
(
£rv”
.port);

1460 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"REPLCONF",

1461 "li¡’šg-pÜt",
pÜt
, 
NULL
);

1462 
	`sdsä“
(
pÜt
);

1463 ià(
”r
è
wr™e_”rÜ
;

1464 
	`sdsä“
(
”r
);

1465 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_PORT
;

1470 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_PORT
) {

1471 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1474 ià(
”r
[0] == '-') {

1475 
	`£rv”Log
(
LL_NOTICE
,"(Non critical) Master does‚ot understand "

1476 "REPLCONF†i¡’šg-pÜt: %s", 
”r
);

1478 
	`sdsä“
(
”r
);

1479 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_CAPA
;

1486 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_CAPA
) {

1487 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"REPLCONF",

1488 "ÿ·","eof",
NULL
);

1489 ià(
”r
è
wr™e_”rÜ
;

1490 
	`sdsä“
(
”r
);

1491 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_CAPA
;

1496 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_CAPA
) {

1497 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1500 ià(
”r
[0] == '-') {

1501 
	`£rv”Log
(
LL_NOTICE
,"(Non critical) Master does‚ot understand "

1502 "REPLCONF c­a: %s", 
”r
);

1504 
	`sdsä“
(
”r
);

1505 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_PSYNC
;

1513 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_PSYNC
) {

1514 ià(
	`¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
,0è=ğ
PSYNC_WRITE_ERROR
) {

1515 
”r
 = 
	`sd¢ew
("Writeƒrror sendinghe PSYNC command.");

1516 
wr™e_”rÜ
;

1518 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_PSYNC
;

1523 ià(
£rv”
.
»¶_¡©e
 !ğ
REPL_STATE_RECEIVE_PSYNC
) {

1524 
	`£rv”Log
(
LL_WARNING
,"syncWithMaster(): state machineƒrror, "

1526 
£rv”
.
»¶_¡©e
);

1527 
”rÜ
;

1530 
psync_»suÉ
 = 
	`¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
,1);

1531 ià(
psync_»suÉ
 =ğ
PSYNC_WAIT_REPLY
) ;

1536 ià(
psync_»suÉ
 =ğ
PSYNC_CONTINUE
) {

1537 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Master‡ccepted‡ Partial Resynchronization.");

1545 
	`discÚÃùSÏves
();

1546 
	`ä“R•liÿtiÚBacklog
();

1551 ià(
psync_»suÉ
 =ğ
PSYNC_NOT_SUPPORTED
) {

1552 
	`£rv”Log
(
LL_NOTICE
,"Retrying with SYNC...");

1553 ià(
	`syncWr™e
(
fd
,"SYNC\r\n",6,
£rv”
.
»¶_syncio_timeout
*1000) == -1) {

1554 
	`£rv”Log
(
LL_WARNING
,"I/Oƒrror writingo MASTER: %s",

1555 
	`¡»¼Ü
(
”ºo
));

1556 
”rÜ
;

1561 
maxŒ›s
--) {

1562 
	`¢´štf
(
tmpfe
,256,

1563 "‹mp-%d.%ld.rdb",()
£rv”
.
unixtime
,()
	`g‘pid
());

1564 
dfd
 = 
	`İ’
(
tmpfe
,
O_CREAT
|
O_WRONLY
|
O_EXCL
,0644);

1565 ià(
dfd
 != -1) ;

1566 
	`¦“p
(1);

1568 ià(
dfd
 == -1) {

1569 
	`£rv”Log
(
LL_WARNING
,"O³nšgh‹m°fÃeded fÜ MASTER <-> SLAVE synchrÚiz©iÚ: %s",
	`¡»¼Ü
(
”ºo
));

1570 
”rÜ
;

1574 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
, 
AE_READABLE
,
»adSyncBulkPaylßd
,
NULL
)

1575 =ğ
AE_ERR
)

1577 
	`£rv”Log
(
LL_WARNING
,

1579 
	`¡»¼Ü
(
”ºo
),
fd
);

1580 
”rÜ
;

1583 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_TRANSFER
;

1584 
£rv”
.
»¶_Œªsãr_size
 = -1;

1585 
£rv”
.
»¶_Œªsãr_»ad
 = 0;

1586 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 = 0;

1587 
£rv”
.
»¶_Œªsãr_fd
 = 
dfd
;

1588 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1589 
£rv”
.
»¶_Œªsãr_tmpfe
 = 
	`z¡rdup
(
tmpfe
);

1592 
”rÜ
:

1593 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
);

1594 
	`şo£
(
fd
);

1595 
£rv”
.
»¶_Œªsãr_s
 = -1;

1596 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1599 
wr™e_”rÜ
:

1600 
	`£rv”Log
(
LL_WARNING
,"S’dšg commªdØma¡” iÀ»¶iÿtiÚ hªdshake: %s", 
”r
);

1601 
	`sdsä“
(
”r
);

1602 
”rÜ
;

1603 
	}
}

1605 
	$cÚÃùW™hMa¡”
() {

1606 
fd
;

1608 
fd
 = 
	`ª‘TıNÚBlockBe¡EffÜtBšdCÚÃù
(
NULL
,

1609 
£rv”
.
ma¡”ho¡
,£rv”.
ma¡”pÜt
,
NET_FIRST_BIND_ADDR
);

1610 ià(
fd
 == -1) {

1611 
	`£rv”Log
(
LL_WARNING
,"Unableo connecto MASTER: %s",

1612 
	`¡»¼Ü
(
”ºo
));

1613  
C_ERR
;

1616 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
,
syncW™hMa¡”
,
NULL
) ==

1617 
AE_ERR
)

1619 
	`şo£
(
fd
);

1620 
	`£rv”Log
(
LL_WARNING
,"Can't create„eadableƒvent for SYNC");

1621  
C_ERR
;

1624 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1625 
£rv”
.
»¶_Œªsãr_s
 = 
fd
;

1626 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECTING
;

1627  
C_OK
;

1628 
	}
}

1634 
	$undoCÚÃùW™hMa¡”
() {

1635 
fd
 = 
£rv”
.
»¶_Œªsãr_s
;

1637 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
);

1638 
	`şo£
(
fd
);

1639 
£rv”
.
»¶_Œªsãr_s
 = -1;

1640 
	}
}

1645 
	$»¶iÿtiÚAbÜtSyncT¿nsãr
() {

1646 
	`£rv”As£¹
(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
);

1647 
	`undoCÚÃùW™hMa¡”
();

1648 
	`şo£
(
£rv”
.
»¶_Œªsãr_fd
);

1649 
	`uÆšk
(
£rv”
.
»¶_Œªsãr_tmpfe
);

1650 
	`zä“
(
£rv”
.
»¶_Œªsãr_tmpfe
);

1651 
	}
}

1661 
	$ÿnûlR•liÿtiÚHªdshake
() {

1662 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
) {

1663 
	`»¶iÿtiÚAbÜtSyncT¿nsãr
();

1664 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1665 } ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTING
 ||

1666 
	`¦aveIsInHªdshakeS‹
())

1668 
	`undoCÚÃùW™hMa¡”
();

1669 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1674 
	}
}

1677 
	$»¶iÿtiÚS‘Ma¡”
(*

, 
pÜt
) {

1678 
	`sdsä“
(
£rv”
.
ma¡”ho¡
);

1679 
£rv”
.
ma¡”ho¡
 = 
	`sd¢ew
(

);

1680 
£rv”
.
ma¡”pÜt
 = 
pÜt
;

1681 ià(
£rv”
.
ma¡”
è
	`ä“Cl›Á
(server.master);

1682 
	`discÚÃùAÎBlockedCl›Ás
();

1683 
	`discÚÃùSÏves
();

1684 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1685 
	`ä“R•liÿtiÚBacklog
();

1686 
	`ÿnûlR•liÿtiÚHªdshake
();

1687 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1688 
£rv”
.
ma¡”_»¶_off£t
 = 0;

1689 
£rv”
.
»¶_down_sšû
 = 0;

1690 
	}
}

1693 
	$»¶iÿtiÚUn£tMa¡”
() {

1694 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
) ;

1695 
	`sdsä“
(
£rv”
.
ma¡”ho¡
);

1696 
£rv”
.
ma¡”ho¡
 = 
NULL
;

1697 ià(
£rv”
.
ma¡”
) {

1698 ià(
	`li¡L’gth
(
£rv”
.
¦aves
) == 0) {

1703 
£rv”
.
ma¡”_»¶_off£t
 = s”v”.
ma¡”
->
»¶off
;

1704 
	`ä“R•liÿtiÚBacklog
();

1706 
	`ä“Cl›Á
(
£rv”
.
ma¡”
);

1708 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1709 
	`ÿnûlR•liÿtiÚHªdshake
();

1710 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_NONE
;

1711 
	}
}

1715 
	$»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
() {

1716 
£rv”
.
ma¡”
 = 
NULL
;

1717 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1718 
£rv”
.
»¶_down_sšû
 = s”v”.
unixtime
;

1722 
	}
}

1724 
	$¦aveofCommªd
(
ş›Á
 *
c
) {

1727 ià(
£rv”
.
şu¡”_’abËd
) {

1728 
	`addR•lyE¼Ü
(
c
,"SLAVEOF‚ot‡llowed in cluster mode.");

1734 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"no") &&

1735 !
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"one")) {

1736 ià(
£rv”
.
ma¡”ho¡
) {

1737 
	`»¶iÿtiÚUn£tMa¡”
();

1738 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1739 
	`£rv”Log
(
LL_NOTICE
,"MASTER MODEƒnabled (user„equest from '%s')",

1740 
ş›Á
);

1741 
	`sdsä“
(
ş›Á
);

1744 
pÜt
;

1746 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
pÜt
, 
NULL
è!ğ
C_OK
))

1750 ià(
£rv”
.
ma¡”ho¡
 && !
	`¡rÿ£cmp
(£rv”.ma¡”ho¡,
c
->
¬gv
[1]->
±r
)

1751 && 
£rv”
.
ma¡”pÜt
 =ğ
pÜt
) {

1752 
	`£rv”Log
(
LL_NOTICE
,"SLAVE OF would„esult into synchronization withhe master we‡re‡lready connected with. No operation…erformed.");

1753 
	`addR•lySds
(
c
,
	`sd¢ew
("+OK Already connectedo specified master\r\n"));

1758 
	`»¶iÿtiÚS‘Ma¡”
(
c
->
¬gv
[1]->
±r
, 
pÜt
);

1759 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1760 
	`£rv”Log
(
LL_NOTICE
,"SLAVE OF %s:%dƒnabled (user„equest from '%s')",

1761 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
, 
ş›Á
);

1762 
	`sdsä“
(
ş›Á
);

1764 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1765 
	}
}

1770 
	$rŞeCommªd
(
ş›Á
 *
c
) {

1771 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
) {

1772 
li¡I‹r
 
li
;

1773 
li¡Node
 *
Ê
;

1774 *
mbcouÁ
;

1775 
¦aves
 = 0;

1777 
	`addR•lyMuÉiBulkL’
(
c
,3);

1778 
	`addR•lyBulkCBufãr
(
c
,"master",6);

1779 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”_»¶_off£t
);

1780 
mbcouÁ
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1781 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1782 (
Ê
 = 
	`li¡Next
(&
li
))) {

1783 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1784 

[
NET_IP_STR_LEN
];

1786 ià(
	`ª‘P“rToSŒšg
(
¦ave
->
fd
,

,(),
NULL
) == -1) ;

1787 ià(
¦ave
->
»¶¡©e
 !ğ
SLAVE_STATE_ONLINE
) ;

1788 
	`addR•lyMuÉiBulkL’
(
c
,3);

1789 
	`addR•lyBulkCSŒšg
(
c
,

);

1790 
	`addR•lyBulkLÚgLÚg
(
c
,
¦ave
->
¦ave_li¡’šg_pÜt
);

1791 
	`addR•lyBulkLÚgLÚg
(
c
,
¦ave
->
»¶_ack_off
);

1792 
¦aves
++;

1794 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
mbcouÁ
,
¦aves
);

1796 *
¦ave¡©e
 = 
NULL
;

1798 
	`addR•lyMuÉiBulkL’
(
c
,5);

1799 
	`addR•lyBulkCBufãr
(
c
,"slave",5);

1800 
	`addR•lyBulkCSŒšg
(
c
,
£rv”
.
ma¡”ho¡
);

1801 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”pÜt
);

1802 ià(
	`¦aveIsInHªdshakeS‹
()) {

1803 
¦ave¡©e
 = "handshake";

1805 
£rv”
.
»¶_¡©e
) {

1806 
REPL_STATE_NONE
: 
¦ave¡©e
 = "none"; ;

1807 
REPL_STATE_CONNECT
: 
¦ave¡©e
 = "connect"; ;

1808 
REPL_STATE_CONNECTING
: 
¦ave¡©e
 = "connecting"; ;

1809 
REPL_STATE_TRANSFER
: 
¦ave¡©e
 = "sync"; ;

1810 
REPL_STATE_CONNECTED
: 
¦ave¡©e
 = "connected"; ;

1811 : 
¦ave¡©e
 = "unknown"; ;

1814 
	`addR•lyBulkCSŒšg
(
c
,
¦ave¡©e
);

1815 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”
 ? s”v”.ma¡”->
»¶off
 : -1);

1817 
	}
}

1822 
	$»¶iÿtiÚS’dAck
() {

1823 
ş›Á
 *
c
 = 
£rv”
.
ma¡”
;

1825 ià(
c
 !ğ
NULL
) {

1826 
c
->
æags
 |ğ
CLIENT_MASTER_FORCE_REPLY
;

1827 
	`addR•lyMuÉiBulkL’
(
c
,3);

1828 
	`addR•lyBulkCSŒšg
(
c
,"REPLCONF");

1829 
	`addR•lyBulkCSŒšg
(
c
,"ACK");

1830 
	`addR•lyBulkLÚgLÚg
(
c
,c->
»¶off
);

1831 
c
->
æags
 &ğ~
CLIENT_MASTER_FORCE_REPLY
;

1833 
	}
}

1855 
	$»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
) {

1856 
	`£rv”As£¹
(
£rv”
.
ma¡”
 !ğ
NULL
 && s”v”.
ÿched_ma¡”
 == NULL);

1857 
	`£rv”Log
(
LL_NOTICE
,"Cachinghe disconnected master state.");

1860 
	`uÆškCl›Á
(
c
);

1864 
£rv”
.
ÿched_ma¡”
 = s”v”.
ma¡”
;

1867 ià(
c
->
³”id
) {

1868 
	`sdsä“
(
c
->
³”id
);

1869 
c
->
³”id
 = 
NULL
;

1875 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

1876 
	}
}

1880 
	$»¶iÿtiÚDisÿrdCachedMa¡”
() {

1881 ià(
£rv”
.
ÿched_ma¡”
 =ğ
NULL
) ;

1883 
	`£rv”Log
(
LL_NOTICE
,"Discarding…reviously cached master state.");

1884 
£rv”
.
ÿched_ma¡”
->
æags
 &ğ~
CLIENT_MASTER
;

1885 
	`ä“Cl›Á
(
£rv”
.
ÿched_ma¡”
);

1886 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

1887 
	}
}

1895 
	$»¶iÿtiÚResu¼eùCachedMa¡”
(
Ãwfd
) {

1896 
£rv”
.
ma¡”
 = s”v”.
ÿched_ma¡”
;

1897 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

1898 
£rv”
.
ma¡”
->
fd
 = 
Ãwfd
;

1899 
£rv”
.
ma¡”
->
æags
 &ğ~(
CLIENT_CLOSE_AFTER_REPLY
|
CLIENT_CLOSE_ASAP
);

1900 
£rv”
.
ma¡”
->
auth’tiÿ‹d
 = 1;

1901 
£rv”
.
ma¡”
->
Ï¡š‹¿ùiÚ
 = s”v”.
unixtime
;

1902 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECTED
;

1905 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás
,£rv”.
ma¡”
);

1906 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
Ãwfd
, 
AE_READABLE
,

1907 
»adQu”yFromCl›Á
, 
£rv”
.
ma¡”
)) {

1908 
	`£rv”Log
(
LL_WARNING
,"E¼Ü„esu¼eùšghÿched ma¡”, impossibËØaddh»adabË hªdËr: %s", 
	`¡»¼Ü
(
”ºo
));

1909 
	`ä“Cl›ÁAsync
(
£rv”
.
ma¡”
);

1914 ià(
	`ş›ÁHasP’dšgR•l›s
(
£rv”
.
ma¡”
)) {

1915 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
Ãwfd
, 
AE_WRITABLE
,

1916 
£ndR•lyToCl›Á
, 
£rv”
.
ma¡”
)) {

1917 
	`£rv”Log
(
LL_WARNING
,"E¼Ü„esu¼eùšghÿched ma¡”, impossibËØaddhwr™abË hªdËr: %s", 
	`¡»¼Ü
(
”ºo
));

1918 
	`ä“Cl›ÁAsync
(
£rv”
.
ma¡”
);

1921 
	}
}

1928 
	$»äeshGoodSÏvesCouÁ
() {

1929 
li¡I‹r
 
li
;

1930 
li¡Node
 *
Ê
;

1931 
good
 = 0;

1933 ià(!
£rv”
.
»¶_mš_¦aves_to_wr™e
 ||

1934 !
£rv”
.
»¶_mš_¦aves_max_Ïg
) ;

1936 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1937 (
Ê
 = 
	`li¡Next
(&
li
))) {

1938 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1939 
time_t
 
Ïg
 = 
£rv”
.
unixtime
 - 
¦ave
->
»¶_ack_time
;

1941 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

1942 
Ïg
 <ğ
£rv”
.
»¶_mš_¦aves_max_Ïg
è
good
++;

1944 
£rv”
.
»¶_good_¦aves_couÁ
 = 
good
;

1945 
	}
}

1979 
	$»¶iÿtiÚSütCacheIn™
() {

1980 
£rv”
.
»¶_sütÿche_size
 = 10000;

1981 
£rv”
.
»¶_sütÿche_diù
 = 
	`diùC»©e
(&
»¶SütCacheDiùTy³
,
NULL
);

1982 
£rv”
.
»¶_sütÿche_fifo
 = 
	`li¡C»©e
();

1983 
	}
}

1996 
	$»¶iÿtiÚSütCacheFlush
() {

1997 
	`diùEm±y
(
£rv”
.
»¶_sütÿche_diù
,
NULL
);

1998 
	`li¡R–—£
(
£rv”
.
»¶_sütÿche_fifo
);

1999 
£rv”
.
»¶_sütÿche_fifo
 = 
	`li¡C»©e
();

2000 
	}
}

2004 
	$»¶iÿtiÚSütCacheAdd
(
sds
 
sha1
) {

2005 
»tv®
;

2006 
sds
 
key
 = 
	`sdsdup
(
sha1
);

2009 ià(
	`li¡L’gth
(
£rv”
.
»¶_sütÿche_fifo
è=ğ£rv”.
»¶_sütÿche_size
)

2011 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
£rv”
.
»¶_sütÿche_fifo
);

2012 
sds
 
Şde¡
 = 
	`li¡NodeV®ue
(
Ê
);

2014 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
»¶_sütÿche_diù
,
Şde¡
);

2015 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

2016 
	`li¡D–Node
(
£rv”
.
»¶_sütÿche_fifo
,
Ê
);

2020 
»tv®
 = 
	`diùAdd
(
£rv”
.
»¶_sütÿche_diù
,
key
,
NULL
);

2021 
	`li¡AddNodeH—d
(
£rv”
.
»¶_sütÿche_fifo
,
key
);

2022 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

2023 
	}
}

2027 
	$»¶iÿtiÚSütCacheExi¡s
(
sds
 
sha1
) {

2028  
	`diùFšd
(
£rv”
.
»¶_sütÿche_diù
,
sha1
è!ğ
NULL
;

2029 
	}
}

2061 
	$»¶iÿtiÚReque¡AckFromSÏves
() {

2062 
£rv”
.
g‘_ack_äom_¦aves
 = 1;

2063 
	}
}

2067 
	$»¶iÿtiÚCouÁAcksByOff£t
(
off£t
) {

2068 
li¡I‹r
 
li
;

2069 
li¡Node
 *
Ê
;

2070 
couÁ
 = 0;

2072 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2073 (
Ê
 = 
	`li¡Next
(&
li
))) {

2074 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2076 ià(
¦ave
->
»¶¡©e
 !ğ
SLAVE_STATE_ONLINE
) ;

2077 ià(
¦ave
->
»¶_ack_off
 >ğ
off£t
è
couÁ
++;

2079  
couÁ
;

2080 
	}
}

2084 
	$wa™Commªd
(
ş›Á
 *
c
) {

2085 
m¡ime_t
 
timeout
;

2086 
num»¶iÿs
, 
ack»¶iÿs
;

2087 
off£t
 = 
c
->
woff
;

2090 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[1],&
num»¶iÿs
,
NULL
è!ğ
C_OK
)

2092 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
timeout
,
UNIT_MILLISECONDS
)

2093 !ğ
C_OK
) ;

2096 
ack»¶iÿs
 = 
	`»¶iÿtiÚCouÁAcksByOff£t
(
c
->
woff
);

2097 ià(
ack»¶iÿs
 >ğ
num»¶iÿs
 || 
c
->
æags
 & 
CLIENT_MULTI
) {

2098 
	`addR•lyLÚgLÚg
(
c
,
ack»¶iÿs
);

2104 
c
->
bpİ
.
timeout
 =imeout;

2105 
c
->
bpİ
.
»¶off£t
 = 
off£t
;

2106 
c
->
bpİ
.
num»¶iÿs
 =‚umreplicas;

2107 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás_wa™šg_acks
,
c
);

2108 
	`blockCl›Á
(
c
,
BLOCKED_WAIT
);

2112 
	`»¶iÿtiÚReque¡AckFromSÏves
();

2113 
	}
}

2119 
	$unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
) {

2120 
li¡Node
 *
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_wa™šg_acks
,
c
);

2121 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

2122 
	`li¡D–Node
(
£rv”
.
ş›Ás_wa™šg_acks
,
Ê
);

2123 
	}
}

2127 
	$´oûssCl›ÁsWa™šgR•liÿs
() {

2128 
Ï¡_off£t
 = 0;

2129 
Ï¡_num»¶iÿs
 = 0;

2131 
li¡I‹r
 
li
;

2132 
li¡Node
 *
Ê
;

2134 
	`li¡Rewšd
(
£rv”
.
ş›Ás_wa™šg_acks
,&
li
);

2135 (
Ê
 = 
	`li¡Next
(&
li
))) {

2136 
ş›Á
 *
c
 = 
Ê
->
v®ue
;

2142 ià(
Ï¡_off£t
 &&†a¡_off£ˆ> 
c
->
bpİ
.
»¶off£t
 &&

2143 
Ï¡_num»¶iÿs
 > 
c
->
bpİ
.
num»¶iÿs
)

2145 
	`unblockCl›Á
(
c
);

2146 
	`addR•lyLÚgLÚg
(
c
,
Ï¡_num»¶iÿs
);

2148 
num»¶iÿs
 = 
	`»¶iÿtiÚCouÁAcksByOff£t
(
c
->
bpİ
.
»¶off£t
);

2150 ià(
num»¶iÿs
 >ğ
c
->
bpİ
.numreplicas) {

2151 
Ï¡_off£t
 = 
c
->
bpİ
.
»¶off£t
;

2152 
Ï¡_num»¶iÿs
 = 
num»¶iÿs
;

2153 
	`unblockCl›Á
(
c
);

2154 
	`addR•lyLÚgLÚg
(
c
,
num»¶iÿs
);

2158 
	}
}

2162 
	$»¶iÿtiÚG‘SÏveOff£t
() {

2163 
off£t
 = 0;

2165 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
) {

2166 ià(
£rv”
.
ma¡”
) {

2167 
off£t
 = 
£rv”
.
ma¡”
->
»¶off
;

2168 } ià(
£rv”
.
ÿched_ma¡”
) {

2169 
off£t
 = 
£rv”
.
ÿched_ma¡”
->
»¶off
;

2176 ià(
off£t
 < 0) offset = 0;

2177  
off£t
;

2178 
	}
}

2183 
	$»¶iÿtiÚCrÚ
() {

2184 
»¶iÿtiÚ_üÚ_loİs
 = 0;

2187 ià(
£rv”
.
ma¡”ho¡
 &&

2188 (
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTING
 ||

2189 
	`¦aveIsInHªdshakeS‹
()) &&

2190 (
	`time
(
NULL
)-
£rv”
.
»¶_Œªsãr_Ï¡io
è> s”v”.
»¶_timeout
)

2192 
	`£rv”Log
(
LL_WARNING
,"Timeout connectingohe MASTER...");

2193 
	`ÿnûlR•liÿtiÚHªdshake
();

2197 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
 &&

2198 (
	`time
(
NULL
)-
£rv”
.
»¶_Œªsãr_Ï¡io
è> s”v”.
»¶_timeout
)

2200 
	`£rv”Log
(
LL_WARNING
,"Timeout„eceiving bulk data from MASTER... Ifhe…roblem…ersistsryo sethe 'repl-timeout'…arameter in„edis.confo‡†arger value.");

2201 
	`ÿnûlR•liÿtiÚHªdshake
();

2205 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTED
 &&

2206 (
	`time
(
NULL
)-
£rv”
.
ma¡”
->
Ï¡š‹¿ùiÚ
è> s”v”.
»¶_timeout
)

2208 
	`£rv”Log
(
LL_WARNING
,"MASTERimeout:‚o data‚or PING„eceived...");

2209 
	`ä“Cl›Á
(
£rv”
.
ma¡”
);

2213 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECT
) {

2214 
	`£rv”Log
(
LL_NOTICE
,"Connectingo MASTER %s:%d",

2215 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

2216 ià(
	`cÚÃùW™hMa¡”
(è=ğ
C_OK
) {

2217 
	`£rv”Log
(
LL_NOTICE
,"MASTER <-> SLAVE sync started");

2224 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
ma¡”
 &&

2225 !(
£rv”
.
ma¡”
->
æags
 & 
CLIENT_PRE_PSYNC
))

2226 
	`»¶iÿtiÚS’dAck
();

2232 
li¡I‹r
 
li
;

2233 
li¡Node
 *
Ê
;

2234 
robj
 *
pšg_¬gv
[1];

2237 ià((
»¶iÿtiÚ_üÚ_loİs
 % 
£rv”
.
»¶_pšg_¦ave_³riod
) == 0) {

2238 
pšg_¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PING",4);

2239 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
, s”v”.
¦ave£ldb
,

2240 
pšg_¬gv
, 1);

2241 
	`deüRefCouÁ
(
pšg_¬gv
[0]);

2250 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2251 (
Ê
 = 
	`li¡Next
(&
li
))) {

2252 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2254 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
 ||

2255 (
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
 &&

2256 
£rv”
.
rdb_chd_ty³
 !ğ
RDB_CHILD_TYPE_SOCKET
))

2258 ià(
	`wr™e
(
¦ave
->
fd
, "\n", 1) == -1) {

2265 ià(
	`li¡L’gth
(
£rv”
.
¦aves
)) {

2266 
li¡I‹r
 
li
;

2267 
li¡Node
 *
Ê
;

2269 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2270 (
Ê
 = 
	`li¡Next
(&
li
))) {

2271 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2273 ià(
¦ave
->
»¶¡©e
 !ğ
SLAVE_STATE_ONLINE
) ;

2274 ià(
¦ave
->
æags
 & 
CLIENT_PRE_PSYNC
) ;

2275 ià((
£rv”
.
unixtime
 - 
¦ave
->
»¶_ack_time
è> s”v”.
»¶_timeout
)

2277 
	`£rv”Log
(
LL_WARNING
, "Disconnectingimedout slave: %s",

2278 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

2279 
	`ä“Cl›Á
(
¦ave
);

2286 ià(
	`li¡L’gth
(
£rv”
.
¦aves
è=ğ0 && s”v”.
»¶_backlog_time_lim™
 &&

2287 
£rv”
.
»¶_backlog
)

2289 
time_t
 
idË
 = 
£rv”
.
unixtime
 - s”v”.
»¶_no_¦aves_sšû
;

2291 ià(
idË
 > 
£rv”
.
»¶_backlog_time_lim™
) {

2292 
	`ä“R•liÿtiÚBacklog
();

2293 
	`£rv”Log
(
LL_NOTICE
,

2296 (è
£rv”
.
»¶_backlog_time_lim™
);

2303 ià(
	`li¡L’gth
(
£rv”
.
¦aves
) == 0 &&

2304 
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
 &&

2305 
	`li¡L’gth
(
£rv”
.
»¶_sütÿche_fifo
) != 0)

2307 
	`»¶iÿtiÚSütCacheFlush
();

2317 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

2318 
time_t
 
idË
, 
max_idË
 = 0;

2319 
¦aves_wa™šg
 = 0;

2320 
mšÿ·
 = -1;

2321 
li¡Node
 *
Ê
;

2322 
li¡I‹r
 
li
;

2324 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2325 (
Ê
 = 
	`li¡Next
(&
li
))) {

2326 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2327 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

2328 
idË
 = 
£rv”
.
unixtime
 - 
¦ave
->
Ï¡š‹¿ùiÚ
;

2329 ià(
idË
 > 
max_idË
) max_idle = idle;

2330 
¦aves_wa™šg
++;

2331 
mšÿ·
 = (mšÿ· =ğ-1è? 
¦ave
->
¦ave_ÿ·
 :

2332 (
mšÿ·
 & 
¦ave
->
¦ave_ÿ·
);

2336 ià(
¦aves_wa™šg
 && 
max_idË
 > 
£rv”
.
»¶_diskËss_sync_d–ay
) {

2339 
	`¡¬tBg§veFÜR•liÿtiÚ
(
mšÿ·
);

2344 
	`»äeshGoodSÏvesCouÁ
();

2345 
»¶iÿtiÚ_üÚ_loİs
++;

2346 
	}
}

	@rio.c

48 
	~"fmaüos.h
"

49 
	~<¡ršg.h
>

50 
	~<¡dio.h
>

51 
	~<uni¡d.h
>

52 
	~"rio.h
"

53 
	~"ut.h
"

54 
	~"üc64.h
"

55 
	~"cÚfig.h
"

56 
	~"£rv”.h
"

61 
size_t
 
	$rioBufãrWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

62 
r
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Ô->io.bufãr.±r,(*)
buf
,
Ën
);

63 
r
->
io
.
bufãr
.
pos
 +ğ
Ën
;

65 
	}
}

68 
size_t
 
	$rioBufãrR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

69 ià(
	`sd¦’
(
r
->
io
.
bufãr
.
±r
)-r->io.bufãr.
pos
 < 
Ën
)

71 
	`memıy
(
buf
,
r
->
io
.
bufãr
.
±r
+r->io.bufãr.
pos
,
Ën
);

72 
r
->
io
.
bufãr
.
pos
 +ğ
Ën
;

74 
	}
}

77 
off_t
 
	$rioBufãrT–l
(
rio
 *
r
) {

78  
r
->
io
.
bufãr
.
pos
;

79 
	}
}

83 
	$rioBufãrFlush
(
rio
 *
r
) {

84 
	`UNUSED
(
r
);

86 
	}
}

88 cÚ¡ 
rio
 
	grioBufãrIO
 = {

89 
rioBufãrR—d
,

90 
rioBufãrWr™e
,

91 
rioBufãrT–l
,

92 
rioBufãrFlush
,

93 
NULL
,

97 { { 
NULL
, 0 } }

100 
	$rioIn™W™hBufãr
(
rio
 *
r
, 
sds
 
s
) {

101 *
r
 = 
rioBufãrIO
;

102 
r
->
io
.
bufãr
.
±r
 = 
s
;

103 
r
->
io
.
bufãr
.
pos
 = 0;

104 
	}
}

109 
size_t
 
	$rioFeWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

110 
size_t
 
»tv®
;

112 
»tv®
 = 
	`fwr™e
(
buf
,
Ën
,1,
r
->
io
.
fe
.
å
);

113 
r
->
io
.
fe
.
bufã»d
 +ğ
Ën
;

115 ià(
r
->
io
.
fe
.
autosync
 &&

116 
r
->
io
.
fe
.
bufã»d
 >ğr->io.fe.
autosync
)

118 
	`fæush
(
r
->
io
.
fe
.
å
);

119 
	`aof_fsync
(
	`f’o
(
r
->
io
.
fe
.
å
));

120 
r
->
io
.
fe
.
bufã»d
 = 0;

122  
»tv®
;

123 
	}
}

126 
size_t
 
	$rioFeR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

127  
	`ä—d
(
buf
,
Ën
,1,
r
->
io
.
fe
.
å
);

128 
	}
}

131 
off_t
 
	$rioFeT–l
(
rio
 *
r
) {

132  
	`á–lo
(
r
->
io
.
fe
.
å
);

133 
	}
}

137 
	$rioFeFlush
(
rio
 *
r
) {

138  (
	`fæush
(
r
->
io
.
fe
.
å
) == 0) ? 1 : 0;

139 
	}
}

141 cÚ¡ 
rio
 
	grioFeIO
 = {

142 
rioFeR—d
,

143 
rioFeWr™e
,

144 
rioFeT–l
,

145 
rioFeFlush
,

146 
NULL
,

150 { { 
NULL
, 0 } }

153 
	$rioIn™W™hFe
(
rio
 *
r
, 
FILE
 *
å
) {

154 *
r
 = 
rioFeIO
;

155 
r
->
io
.
fe
.
å
 = fp;

156 
r
->
io
.
fe
.
bufã»d
 = 0;

157 
r
->
io
.
fe
.
autosync
 = 0;

158 
	}
}

169 
size_t
 
	$rioFd£tWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

170 
ssize_t
 
»tv®
;

171 
j
;

172 *
p
 = (*è
buf
;

173 
doæush
 = (
buf
 =ğ
NULL
 && 
Ën
 == 0);

177 ià(
Ën
) {

178 
r
->
io
.
fd£t
.
buf
 = 
	`sdsÿ’
Ô->io.fd£t.buf,buf,
Ën
);

179 
Ën
 = 0;

180 ià(
	`sd¦’
(
r
->
io
.
fd£t
.
buf
è> 
PROTO_IOBUF_LEN
è
doæush
 = 1;

183 ià(
doæush
) {

184 
p
 = (*è
r
->
io
.
fd£t
.
buf
;

185 
Ën
 = 
	`sd¦’
(
r
->
io
.
fd£t
.
buf
);

191 
Ën
) {

192 
size_t
 
couÁ
 = 
Ën
 < 1024 ?†en : 1024;

193 
brok’
 = 0;

194 
j
 = 0; j < 
r
->
io
.
fd£t
.
numfds
; j++) {

195 ià(
r
->
io
.
fd£t
.
¡©e
[
j
] != 0) {

197 
brok’
++;

203 
size_t
 
nwr™‹n
 = 0;

204 
nwr™‹n
 !ğ
couÁ
) {

205 
»tv®
 = 
	`wr™e
(
r
->
io
.
fd£t
.
fds
[
j
],
p
+
nwr™‹n
,
couÁ
-nwritten);

206 ià(
»tv®
 <= 0) {

211 ià(
»tv®
 =ğ-1 && 
”ºo
 =ğ
EWOULDBLOCK
è”ºØğ
ETIMEDOUT
;

214 
nwr™‹n
 +ğ
»tv®
;

217 ià(
nwr™‹n
 !ğ
couÁ
) {

219 
r
->
io
.
fd£t
.
¡©e
[
j
] = 
”ºo
;

220 ià(
r
->
io
.
fd£t
.
¡©e
[
j
] =ğ0èr->io.fd£t.¡©e[j] = 
EIO
;

223 ià(
brok’
 =ğ
r
->
io
.
fd£t
.
numfds
)  0;

224 
p
 +ğ
couÁ
;

225 
Ën
 -ğ
couÁ
;

226 
r
->
io
.
fd£t
.
pos
 +ğ
couÁ
;

229 ià(
doæush
è
	`sdsş—r
(
r
->
io
.
fd£t
.
buf
);

231 
	}
}

234 
size_t
 
	$rioFd£tR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

235 
	`UNUSED
(
r
);

236 
	`UNUSED
(
buf
);

237 
	`UNUSED
(
Ën
);

239 
	}
}

242 
off_t
 
	$rioFd£tT–l
(
rio
 *
r
) {

243  
r
->
io
.
fd£t
.
pos
;

244 
	}
}

248 
	$rioFd£tFlush
(
rio
 *
r
) {

251  
	`rioFd£tWr™e
(
r
,
NULL
,0);

252 
	}
}

254 cÚ¡ 
rio
 
	grioFd£tIO
 = {

255 
rioFd£tR—d
,

256 
rioFd£tWr™e
,

257 
rioFd£tT–l
,

258 
rioFd£tFlush
,

259 
NULL
,

263 { { 
NULL
, 0 } }

266 
	$rioIn™W™hFd£t
(
rio
 *
r
, *
fds
, 
numfds
) {

267 
j
;

269 *
r
 = 
rioFd£tIO
;

270 
r
->
io
.
fd£t
.
fds
 = 
	`zm®loc
(()*
numfds
);

271 
r
->
io
.
fd£t
.
¡©e
 = 
	`zm®loc
(()*
numfds
);

272 
	`memıy
(
r
->
io
.
fd£t
.
fds
,fds,()*
numfds
);

273 
j
 = 0; j < 
numfds
; j++è
r
->
io
.
fd£t
.
¡©e
[j] = 0;

274 
r
->
io
.
fd£t
.
numfds
 =‚umfds;

275 
r
->
io
.
fd£t
.
pos
 = 0;

276 
r
->
io
.
fd£t
.
buf
 = 
	`sd£m±y
();

277 
	}
}

280 
	$rioF»eFd£t
(
rio
 *
r
) {

281 
	`zä“
(
r
->
io
.
fd£t
.
fds
);

282 
	`zä“
(
r
->
io
.
fd£t
.
¡©e
);

283 
	`sdsä“
(
r
->
io
.
fd£t
.
buf
);

284 
	}
}

290 
	$rioG’”icUpd©eChecksum
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

291 
r
->
cksum
 = 
	`üc64
Ô->cksum,
buf
,
Ën
);

292 
	}
}

302 
	$rioS‘AutoSync
(
rio
 *
r
, 
off_t
 
by‹s
) {

303 
	`£rv”As£¹
(
r
->
»ad
 =ğ
rioFeIO
.read);

304 
r
->
io
.
fe
.
autosync
 = 
by‹s
;

305 
	}
}

313 
size_t
 
	$rioWr™eBulkCouÁ
(
rio
 *
r
, 
´efix
, 
couÁ
) {

314 
cbuf
[128];

315 
ş’
;

317 
cbuf
[0] = 
´efix
;

318 
ş’
 = 1+
	`Î2¡ršg
(
cbuf
+1,(cbuf)-1,
couÁ
);

319 
cbuf
[
ş’
++] = '\r';

320 
cbuf
[
ş’
++] = '\n';

321 ià(
	`rioWr™e
(
r
,
cbuf
,
ş’
) == 0)  0;

322  
ş’
;

323 
	}
}

326 
size_t
 
	$rioWr™eBulkSŒšg
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

327 
size_t
 
nwr™‹n
;

329 ià((
nwr™‹n
 = 
	`rioWr™eBulkCouÁ
(
r
,'$',
Ën
)) == 0)  0;

330 ià(
Ën
 > 0 && 
	`rioWr™e
(
r
,
buf
,len) == 0)  0;

331 ià(
	`rioWr™e
(
r
,"\r\n",2) == 0)  0;

332  
nwr™‹n
+
Ën
+2;

333 
	}
}

336 
size_t
 
	$rioWr™eBulkLÚgLÚg
(
rio
 *
r
, 
l
) {

337 
lbuf
[32];

338 
Î’
;

340 
Î’
 = 
	`Î2¡ršg
(
lbuf
,Öbuf),
l
);

341  
	`rioWr™eBulkSŒšg
(
r
,
lbuf
,
Î’
);

342 
	}
}

345 
size_t
 
	$rioWr™eBulkDoubË
(
rio
 *
r
, 
d
) {

346 
dbuf
[128];

347 
dËn
;

349 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

350  
	`rioWr™eBulkSŒšg
(
r
,
dbuf
,
dËn
);

351 
	}
}

	@rio.h

32 #iâdeà
__REDIS_RIO_H


33 
	#__REDIS_RIO_H


	)

35 
	~<¡dio.h
>

36 
	~<¡dšt.h
>

37 
	~"sds.h
"

39 
	s_rio
 {

43 
size_t
 (*
»ad
)(
	m_rio
 *, *
	mbuf
, size_ˆ
	mËn
);

44 
size_t
 (*
wr™e
)(
	m_rio
 *, cÚ¡ *
	mbuf
, size_ˆ
	mËn
);

45 
off_t
 (*
‹Î
)(
	m_rio
 *);

46 (*
	mæush
)(
	m_rio
 *);

52 (*
	mupd©e_cksum
)(
	m_rio
 *, cÚ¡ *
	mbuf
, 
size_t
 
	mËn
);

55 
ušt64_t
 
	mcksum
;

58 
size_t
 
	m´oûs£d_by‹s
;

61 
size_t
 
	mmax_´oûssšg_chunk
;

67 
sds
 
	m±r
;

68 
off_t
 
	mpos
;

69 } 
	mbufãr
;

72 
FILE
 *
	må
;

73 
off_t
 
	mbufã»d
;

74 
off_t
 
	mautosync
;

75 } 
	mfe
;

78 *
	mfds
;

79 *
	m¡©e
;

80 
	mnumfds
;

81 
off_t
 
	mpos
;

82 
sds
 
	mbuf
;

83 } 
	mfd£t
;

84 } 
	mio
;

87 
_rio
 
	trio
;

93 
šlše
 
size_t
 
	$rioWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

94 
Ën
) {

95 
size_t
 
by‹s_to_wr™e
 = (
r
->
max_´oûssšg_chunk
 &&„->max_´oûssšg_chunk < 
Ën
) ?„->max_processing_chunk :†en;

96 ià(
r
->
upd©e_cksum
èr->
	`upd©e_cksum
Ô,
buf
,
by‹s_to_wr™e
);

97 ià(
r
->
	`wr™e
Ô,
buf
,
by‹s_to_wr™e
) == 0)

99 
buf
 = (*)buà+ 
by‹s_to_wr™e
;

100 
Ën
 -ğ
by‹s_to_wr™e
;

101 
r
->
´oûs£d_by‹s
 +ğ
by‹s_to_wr™e
;

104 
	}
}

106 
šlše
 
size_t
 
	$rioR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

107 
Ën
) {

108 
size_t
 
by‹s_to_»ad
 = (
r
->
max_´oûssšg_chunk
 &&„->max_´oûssšg_chunk < 
Ën
) ?„->max_processing_chunk :†en;

109 ià(
r
->
	`»ad
Ô,
buf
,
by‹s_to_»ad
) == 0)

111 ià(
r
->
upd©e_cksum
èr->
	`upd©e_cksum
Ô,
buf
,
by‹s_to_»ad
);

112 
buf
 = (*)buà+ 
by‹s_to_»ad
;

113 
Ën
 -ğ
by‹s_to_»ad
;

114 
r
->
´oûs£d_by‹s
 +ğ
by‹s_to_»ad
;

117 
	}
}

119 
šlše
 
off_t
 
	$rioT–l
(
rio
 *
r
) {

120  
r
->
	`‹Î
(r);

121 
	}
}

123 
šlše
 
	$rioFlush
(
rio
 *
r
) {

124  
r
->
	`æush
(r);

125 
	}
}

127 
rioIn™W™hFe
(
rio
 *
r
, 
FILE
 *
å
);

128 
rioIn™W™hBufãr
(
rio
 *
r
, 
sds
 
s
);

129 
rioIn™W™hFd£t
(
rio
 *
r
, *
fds
, 
numfds
);

131 
rioF»eFd£t
(
rio
 *
r
);

133 
size_t
 
rioWr™eBulkCouÁ
(
rio
 *
r
, 
´efix
, 
couÁ
);

134 
size_t
 
rioWr™eBulkSŒšg
(
rio
 *
r
, cÚ¡ *
buf
, size_ˆ
Ën
);

135 
size_t
 
rioWr™eBulkLÚgLÚg
(
rio
 *
r
, 
l
);

136 
size_t
 
rioWr™eBulkDoubË
(
rio
 *
r
, 
d
);

138 
	g»disObjeù
;

139 
rioWr™eBulkObjeù
(
rio
 *
r
, 
»disObjeù
 *
obj
);

141 
rioG’”icUpd©eChecksum
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

142 
rioS‘AutoSync
(
rio
 *
r
, 
off_t
 
by‹s
);

	@scripting.c

30 
	~"£rv”.h
"

31 
	~"sha1.h
"

32 
	~"¿nd.h
"

33 
	~"şu¡”.h
"

35 
	~<lua.h
>

36 
	~<Ïuxlib.h
>

37 
	~<lu®ib.h
>

38 
	~<ùy³.h
>

39 
	~<m©h.h
>

41 *
»disPrÙocŞToLuaTy³_IÁ
(
lua_S‹
 *
lua
, *
»¶y
);

42 *
»disPrÙocŞToLuaTy³_Bulk
(
lua_S‹
 *
lua
, *
»¶y
);

43 *
»disPrÙocŞToLuaTy³_Stus
(
lua_S‹
 *
lua
, *
»¶y
);

44 *
»disPrÙocŞToLuaTy³_E¼Ü
(
lua_S‹
 *
lua
, *
»¶y
);

45 *
»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua_S‹
 *
lua
, *
»¶y
);

46 
»dis_m©h_¿ndom
 (
lua_S‹
 *
L
);

47 
»dis_m©h_¿ndom£ed
 (
lua_S‹
 *
L
);

48 
ldbIn™
();

49 
ldbDi§bË
(
ş›Á
 *
c
);

50 
ldbEÇbË
(
ş›Á
 *
c
);

51 
ev®G’”icCommªdW™hDebuggšg
(
ş›Á
 *
c
, 
ev®sha
);

52 
luaLdbLšeHook
(
lua_S‹
 *
lua
, 
lua_Debug
 *
¬
);

53 
ldbLog
(
sds
 
’Œy
);

54 
ldbLogRedisR•ly
(*
»¶y
);

55 
sds
 
ldbC©SckV®ue
(sd 
s
, 
lua_S‹
 *
lua
, 
idx
);

58 
	#LDB_BREAKPOINTS_MAX
 64

	)

59 
	#LDB_MAX_LEN_DEFAULT
 256

	)

60 
	sldbS‹
 {

61 
	mfd
;

62 
	maùive
;

63 
	mfÜked
;

64 
li¡
 *
	mlogs
;

65 
li¡
 *
	mŒaûs
;

66 
li¡
 *
	mchd»n
;

67 
	mbp
[
LDB_BREAKPOINTS_MAX
];

68 
	mbpcouÁ
;

69 
	m¡•
;

70 
	mluabp
;

71 
sds
 *
	m¤c
;

72 
	mlšes
;

73 
	mcu¼’še
;

74 
sds
 
	mcbuf
;

75 
size_t
 
	mmaxËn
;

76 
	mmaxËn_hšt_£Á
;

77 } 
	gldb
;

89 
	$sha1hex
(*
dige¡
, *
süt
, 
size_t
 
Ën
) {

90 
SHA1_CTX
 
ùx
;

91 
hash
[20];

92 *
c£t
 = "0123456789abcdef";

93 
j
;

95 
	`SHA1In™
(&
ùx
);

96 
	`SHA1Upd©e
(&
ùx
,(*)
süt
,
Ën
);

97 
	`SHA1Fš®
(
hash
,&
ùx
);

99 
j
 = 0; j < 20; j++) {

100 
dige¡
[
j
*2] = 
c£t
[((
hash
[j]&0xF0)>>4)];

101 
dige¡
[
j
*2+1] = 
c£t
[(
hash
[j]&0xF)];

103 
dige¡
[40] = '\0';

104 
	}
}

127 *
	$»disPrÙocŞToLuaTy³
(
lua_S‹
 *
lua
, * 
»¶y
) {

128 *
p
 = 
»¶y
;

130 *
p
) {

131 ':': 
p
 = 
	`»disPrÙocŞToLuaTy³_IÁ
(
lua
,
»¶y
); ;

132 '$': 
p
 = 
	`»disPrÙocŞToLuaTy³_Bulk
(
lua
,
»¶y
); ;

133 '+': 
p
 = 
	`»disPrÙocŞToLuaTy³_Stus
(
lua
,
»¶y
); ;

134 '-': 
p
 = 
	`»disPrÙocŞToLuaTy³_E¼Ü
(
lua
,
»¶y
); ;

135 '*': 
p
 = 
	`»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua
,
»¶y
); ;

137  
p
;

138 
	}
}

140 *
	$»disPrÙocŞToLuaTy³_IÁ
(
lua_S‹
 *
lua
, *
»¶y
) {

141 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

142 
v®ue
;

144 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
v®ue
);

145 
	`lua_pushnumb”
(
lua
,(
lua_Numb”
)
v®ue
);

146  
p
+2;

147 
	}
}

149 *
	$»disPrÙocŞToLuaTy³_Bulk
(
lua_S‹
 *
lua
, *
»¶y
) {

150 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

151 
bulkËn
;

153 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
bulkËn
);

154 ià(
bulkËn
 == -1) {

155 
	`lua_pushboŞ—n
(
lua
,0);

156  
p
+2;

158 
	`lua_pushl¡ršg
(
lua
,
p
+2,
bulkËn
);

159  
p
+2+
bulkËn
+2;

161 
	}
}

163 *
	$»disPrÙocŞToLuaTy³_Stus
(
lua_S‹
 *
lua
, *
»¶y
) {

164 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

166 
	`lua_ÃwbË
(
lua
);

167 
	`lua_push¡ršg
(
lua
,"ok");

168 
	`lua_pushl¡ršg
(
lua
,
»¶y
+1,
p
-reply-1);

169 
	`lua_£‰abË
(
lua
,-3);

170  
p
+2;

171 
	}
}

173 *
	$»disPrÙocŞToLuaTy³_E¼Ü
(
lua_S‹
 *
lua
, *
»¶y
) {

174 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

176 
	`lua_ÃwbË
(
lua
);

177 
	`lua_push¡ršg
(
lua
,"err");

178 
	`lua_pushl¡ršg
(
lua
,
»¶y
+1,
p
-reply-1);

179 
	`lua_£‰abË
(
lua
,-3);

180  
p
+2;

181 
	}
}

183 *
	$»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua_S‹
 *
lua
, *
»¶y
) {

184 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

185 
mbulkËn
;

186 
j
 = 0;

188 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
mbulkËn
);

189 
p
 += 2;

190 ià(
mbulkËn
 == -1) {

191 
	`lua_pushboŞ—n
(
lua
,0);

192  
p
;

194 
	`lua_ÃwbË
(
lua
);

195 
j
 = 0; j < 
mbulkËn
; j++) {

196 
	`lua_pushnumb”
(
lua
,
j
+1);

197 
p
 = 
	`»disPrÙocŞToLuaTy³
(
lua
,p);

198 
	`lua_£‰abË
(
lua
,-3);

200  
p
;

201 
	}
}

208 
	$luaPushE¼Ü
(
lua_S‹
 *
lua
, *
”rÜ
) {

209 
lua_Debug
 
dbg
;

213 ià(
ldb
.
aùive
 &&†db.
¡•
) {

214 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"<”rÜ> %s",
”rÜ
));

217 
	`lua_ÃwbË
(
lua
);

218 
	`lua_push¡ršg
(
lua
,"err");

221 if(
	`lua_g‘¡ack
(
lua
, 1, &
dbg
è&& 
	`lua_g‘šfo
(lua, "nSl", &dbg)) {

222 
sds
 
msg
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s: %d: %s",

223 
dbg
.
sourû
, dbg.
cu¼’še
, 
”rÜ
);

224 
	`lua_push¡ršg
(
lua
, 
msg
);

225 
	`sdsä“
(
msg
);

227 
	`lua_push¡ršg
(
lua
, 
”rÜ
);

229 
	`lua_£‰abË
(
lua
,-3);

230 
	}
}

236 
	$luaRai£E¼Ü
(
lua_S‹
 *
lua
) {

237 
	`lua_push¡ršg
(
lua
,"err");

238 
	`lua_g‘bË
(
lua
,-2);

239  
	`lua_”rÜ
(
lua
);

240 
	}
}

248 
	$luaSÜtA¼ay
(
lua_S‹
 *
lua
) {

250 
	`lua_g‘glob®
(
lua
,"table");

251 
	`lua_push¡ršg
(
lua
,"sort");

252 
	`lua_g‘bË
(
lua
,-2);

253 
	`lua_pushv®ue
(
lua
,-3);

254 ià(
	`lua_pÿÎ
(
lua
,1,0,0)) {

261 
	`lua_pİ
(
lua
,1);

262 
	`lua_push¡ršg
(
lua
,"sort");

263 
	`lua_g‘bË
(
lua
,-2);

264 
	`lua_pushv®ue
(
lua
,-3);

265 
	`lua_g‘glob®
(
lua
,"__redis__compare_helper");

267 
	`lua_ÿÎ
(
lua
,2,0);

270 
	`lua_pİ
(
lua
,1);

271 
	}
}

277 
	$luaR•lyToRedisR•ly
(
ş›Á
 *
c
, 
lua_S‹
 *
lua
) {

278 
t
 = 
	`lua_ty³
(
lua
,-1);

280 
t
) {

281 
LUA_TSTRING
:

282 
	`addR•lyBulkCBufãr
(
c
,(*)
	`lua_to¡ršg
(
lua
,-1),
	`lua_¡¾’
(lua,-1));

284 
LUA_TBOOLEAN
:

285 
	`addR•ly
(
c
,
	`lua_toboŞ—n
(
lua
,-1è? 
sh¬ed
.
cÚe
 : sh¬ed.
nuÎbulk
);

287 
LUA_TNUMBER
:

288 
	`addR•lyLÚgLÚg
(
c
,()
	`lua_tÚumb”
(
lua
,-1));

290 
LUA_TTABLE
:

295 
	`lua_push¡ršg
(
lua
,"err");

296 
	`lua_g‘bË
(
lua
,-2);

297 
t
 = 
	`lua_ty³
(
lua
,-1);

298 ià(
t
 =ğ
LUA_TSTRING
) {

299 
sds
 
”r
 = 
	`sd¢ew
(
	`lua_to¡ršg
(
lua
,-1));

300 
	`sdsm­ch¬s
(
”r
,"\r\n"," ",2);

301 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"-%s\r\n",
”r
));

302 
	`sdsä“
(
”r
);

303 
	`lua_pİ
(
lua
,2);

307 
	`lua_pİ
(
lua
,1);

308 
	`lua_push¡ršg
(
lua
,"ok");

309 
	`lua_g‘bË
(
lua
,-2);

310 
t
 = 
	`lua_ty³
(
lua
,-1);

311 ià(
t
 =ğ
LUA_TSTRING
) {

312 
sds
 
ok
 = 
	`sd¢ew
(
	`lua_to¡ršg
(
lua
,-1));

313 
	`sdsm­ch¬s
(
ok
,"\r\n"," ",2);

314 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"+%s\r\n",
ok
));

315 
	`sdsä“
(
ok
);

316 
	`lua_pİ
(
lua
,1);

318 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

319 
j
 = 1, 
mbulkËn
 = 0;

321 
	`lua_pİ
(
lua
,1);

323 
	`lua_pushnumb”
(
lua
,
j
++);

324 
	`lua_g‘bË
(
lua
,-2);

325 
t
 = 
	`lua_ty³
(
lua
,-1);

326 ià(
t
 =ğ
LUA_TNIL
) {

327 
	`lua_pİ
(
lua
,1);

330 
	`luaR•lyToRedisR•ly
(
c
, 
lua
);

331 
mbulkËn
++;

333 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
mbulkËn
);

337 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

339 
	`lua_pİ
(
lua
,1);

340 
	}
}

346 
	#LUA_CMD_OBJCACHE_SIZE
 32

	)

347 
	#LUA_CMD_OBJCACHE_MAX_LEN
 64

	)

348 
	$luaRedisG’”icCommªd
(
lua_S‹
 *
lua
, 
¿i£_”rÜ
) {

349 
j
, 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

350 
»disCommªd
 *
cmd
;

351 
ş›Á
 *
c
 = 
£rv”
.
lua_ş›Á
;

352 
sds
 
»¶y
;

355 
robj
 **
¬gv
 = 
NULL
;

356 
¬gv_size
 = 0;

357 
robj
 *
ÿched_objeùs
[
LUA_CMD_OBJCACHE_SIZE
];

358 
size_t
 
ÿched_objeùs_Ën
[
LUA_CMD_OBJCACHE_SIZE
];

359 
šu£
 = 0;

365 ià(
šu£
) {

366 *
»cursiÚ_w¬nšg
 =

369 
	`£rv”Log
(
LL_WARNING
,"%s",
»cursiÚ_w¬nšg
);

370 
	`luaPushE¼Ü
(
lua
,
»cursiÚ_w¬nšg
);

373 
šu£
++;

376 ià(
¬gc
 == 0) {

377 
	`luaPushE¼Ü
(
lua
,

379 
šu£
--;

380  
¿i£_”rÜ
 ? 
	`luaRai£E¼Ü
(
lua
) : 1;

384 ià(
¬gv_size
 < 
¬gc
) {

385 
¬gv
 = 
	`z»®loc
×rgv,(
robj
*)*
¬gc
);

386 
¬gv_size
 = 
¬gc
;

389 
j
 = 0; j < 
¬gc
; j++) {

390 *
obj_s
;

391 
size_t
 
obj_Ën
;

392 
dbuf
[64];

394 ià(
	`lua_ty³
(
lua
,
j
+1è=ğ
LUA_TNUMBER
) {

397 
lua_Numb”
 
num
 = 
	`lua_tÚumb”
(
lua
,
j
+1);

399 
obj_Ën
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",()
num
);

400 
obj_s
 = 
dbuf
;

402 
obj_s
 = (*)
	`lua_tŞ¡ršg
(
lua
,
j
+1,&
obj_Ën
);

403 ià(
obj_s
 =ğ
NULL
) ;

407 ià(
j
 < 
LUA_CMD_OBJCACHE_SIZE
 && 
ÿched_objeùs
[j] &&

408 
ÿched_objeùs_Ën
[
j
] >ğ
obj_Ën
)

410 
sds
 
s
 = 
ÿched_objeùs
[
j
]->
±r
;

411 
¬gv
[
j
] = 
ÿched_objeùs
[j];

412 
ÿched_objeùs
[
j
] = 
NULL
;

413 
	`memıy
(
s
,
obj_s
,
obj_Ën
+1);

414 
	`sds£’
(
s
, 
obj_Ën
);

416 
¬gv
[
j
] = 
	`ü—‹SŒšgObjeù
(
obj_s
, 
obj_Ën
);

423 ià(
j
 !ğ
¬gc
) {

424 
j
--;

425 
j
 >= 0) {

426 
	`deüRefCouÁ
(
¬gv
[
j
]);

427 
j
--;

429 
	`luaPushE¼Ü
(
lua
,

431 
šu£
--;

432  
¿i£_”rÜ
 ? 
	`luaRai£E¼Ü
(
lua
) : 1;

436 
c
->
¬gv
 =‡rgv;

437 
c
->
¬gc
 =‡rgc;

440 ià(
ldb
.
aùive
 &&†db.
¡•
) {

441 
sds
 
cmdlog
 = 
	`sd¢ew
("<redis>");

442 
j
 = 0; j < 
c
->
¬gc
; j++) {

443 ià(
j
 == 10) {

444 
cmdlog
 = 
	`sdsÿrštf
(cmdlog," ... (%d more)",

445 
c
->
¬gc
-
j
-1);

447 
cmdlog
 = 
	`sdsÿ’
(cmdlog," ",1);

448 
cmdlog
 = 
	`sdsÿtsds
(cmdlog,
c
->
¬gv
[
j
]->
±r
);

451 
	`ldbLog
(
cmdlog
);

455 
cmd
 = 
	`lookupCommªd
(
¬gv
[0]->
±r
);

456 ià(!
cmd
 || ((cmd->
¬™y
 > 0 && cmd->¬™y !ğ
¬gc
) ||

457 (
¬gc
 < -
cmd
->
¬™y
)))

459 ià(
cmd
)

460 
	`luaPushE¼Ü
(
lua
,

463 
	`luaPushE¼Ü
(
lua
,"Unknown Redis command called from Lua script");

464 
ş—nup
;

466 
c
->
cmd
 = c->
Ï¡cmd
 = cmd;

469 ià(
cmd
->
æags
 & 
CMD_NOSCRIPT
) {

470 
	`luaPushE¼Ü
(
lua
, "This Redis command is‚ot‡llowed from scripts");

471 
ş—nup
;

477 ià(
cmd
->
æags
 & 
CMD_WRITE
) {

478 ià(
£rv”
.
lua_¿ndom_dœty
 && !£rv”.
lua_»¶iÿ‹_commªds
) {

479 
	`luaPushE¼Ü
(
lua
,

481 
ş—nup
;

482 } ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¦ave_ro
 &&

483 !
£rv”
.
lßdšg
 &&

484 !(
£rv”
.
lua_ÿÎ”
->
æags
 & 
CLIENT_MASTER
))

486 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
ro¦av“¼
->
±r
);

487 
ş—nup
;

488 } ià(
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

489 
£rv”
.
§v•¬am¦’
 > 0 &&

490 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_ERR
)

492 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
bg§v“¼
->
±r
);

493 
ş—nup
;

501 ià(
£rv”
.
maxmemÜy
 && s”v”.
lua_wr™e_dœty
 == 0 &&

502 (
cmd
->
æags
 & 
CMD_DENYOOM
))

504 ià(
	`ä“MemÜyIfN“ded
(è=ğ
C_ERR
) {

505 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
oom”r
->
±r
);

506 
ş—nup
;

510 ià(
cmd
->
æags
 & 
CMD_RANDOM
è
£rv”
.
lua_¿ndom_dœty
 = 1;

511 ià(
cmd
->
æags
 & 
CMD_WRITE
è
£rv”
.
lua_wr™e_dœty
 = 1;

516 ià(
£rv”
.
şu¡”_’abËd
 && !£rv”.
lßdšg
 &&

517 !(
£rv”
.
lua_ÿÎ”
->
æags
 & 
CLIENT_MASTER
))

520 
c
->
æags
 &ğ~(
CLIENT_READONLY
|
CLIENT_ASKING
);

521 
c
->
æags
 |ğ
£rv”
.
lua_ÿÎ”
->æag & (
CLIENT_READONLY
|
CLIENT_ASKING
);

522 ià(
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,
NULL
,NULL) !=

523 
£rv”
.
şu¡”
->
my£lf
)

525 
	`luaPushE¼Ü
(
lua
,

528 
ş—nup
;

535 ià(
£rv”
.
lua_»¶iÿ‹_commªds
 &&

536 !
£rv”
.
lua_muÉi_em™‹d
 &&

537 
£rv”
.
lua_wr™e_dœty
 &&

538 
£rv”
.
lua_»¶
 !ğ
PROPAGATE_NONE
)

540 
	`execCommªdPrİag©eMuÉi
(
£rv”
.
lua_ÿÎ”
);

541 
£rv”
.
lua_muÉi_em™‹d
 = 1;

545 
ÿÎ_æags
 = 
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
;

546 ià(
£rv”
.
lua_»¶iÿ‹_commªds
) {

548 ià(
£rv”
.
lua_»¶
 & 
PROPAGATE_AOF
)

549 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_AOF
;

550 ià(
£rv”
.
lua_»¶
 & 
PROPAGATE_REPL
)

551 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_REPL
;

553 
	`ÿÎ
(
c
,
ÿÎ_æags
);

558 ià(
	`li¡L’gth
(
c
->
»¶y
è=ğ0 && c->
buåos
 < 
PROTO_REPLY_CHUNK_BYTES
) {

562 
c
->
buf
[c->
buåos
] = '\0';

563 
»¶y
 = 
c
->
buf
;

564 
c
->
buåos
 = 0;

566 
»¶y
 = 
	`sd¢ewËn
(
c
->
buf
,c->
buåos
);

567 
c
->
buåos
 = 0;

568 
	`li¡L’gth
(
c
->
»¶y
)) {

569 
sds
 
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

571 
»¶y
 = 
	`sdsÿtsds
Ô•ly,
o
);

572 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

575 ià(
¿i£_”rÜ
 && 
»¶y
[0] != '-')„aise_error = 0;

576 
	`»disPrÙocŞToLuaTy³
(
lua
,
»¶y
);

579 ià(
ldb
.
aùive
 &&†db.
¡•
)

580 
	`ldbLogRedisR•ly
(
»¶y
);

584 ià((
cmd
->
æags
 & 
CMD_SORT_FOR_SCRIPT
) &&

585 (
£rv”
.
lua_»¶iÿ‹_commªds
 == 0) &&

586 (
»¶y
[0] == '*' &&„eply[1] != '-')) {

587 
	`luaSÜtA¼ay
(
lua
);

589 ià(
»¶y
 !ğ
c
->
buf
è
	`sdsä“
(reply);

590 
c
->
»¶y_by‹s
 = 0;

592 
ş—nup
:

595 
j
 = 0; j < 
c
->
¬gc
; j++) {

596 
robj
 *
o
 = 
c
->
¬gv
[
j
];

601 ià(
j
 < 
LUA_CMD_OBJCACHE_SIZE
 &&

602 
o
->
»fcouÁ
 == 1 &&

603 (
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
 ||

604 
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
) &&

605 
	`sd¦’
(
o
->
±r
è<ğ
LUA_CMD_OBJCACHE_MAX_LEN
)

607 
sds
 
s
 = 
o
->
±r
;

608 ià(
ÿched_objeùs
[
j
]è
	`deüRefCouÁ
(cached_objects[j]);

609 
ÿched_objeùs
[
j
] = 
o
;

610 
ÿched_objeùs_Ën
[
j
] = 
	`sd§Îoc
(
s
);

612 
	`deüRefCouÁ
(
o
);

616 ià(
c
->
¬gv
 !=‡rgv) {

617 
	`zä“
(
c
->
¬gv
);

618 
¬gv
 = 
NULL
;

619 
¬gv_size
 = 0;

622 ià(
¿i£_”rÜ
) {

626 
šu£
--;

627  
	`luaRai£E¼Ü
(
lua
);

629 
šu£
--;

631 
	}
}

634 
	$luaRedisC®lCommªd
(
lua_S‹
 *
lua
) {

635  
	`luaRedisG’”icCommªd
(
lua
,1);

636 
	}
}

639 
	$luaRedisPC®lCommªd
(
lua_S‹
 *
lua
) {

640  
	`luaRedisG’”icCommªd
(
lua
,0);

641 
	}
}

645 
	$luaRedisSha1hexCommªd
(
lua_S‹
 *
lua
) {

646 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

647 
dige¡
[41];

648 
size_t
 
Ën
;

649 *
s
;

651 ià(
¬gc
 != 1) {

652 
	`lua_push¡ršg
(
lua
, "wrong‚umber of‡rguments");

653  
	`lua_”rÜ
(
lua
);

656 
s
 = (*)
	`lua_tŞ¡ršg
(
lua
,1,&
Ën
);

657 
	`sha1hex
(
dige¡
,
s
,
Ën
);

658 
	`lua_push¡ršg
(
lua
,
dige¡
);

660 
	}
}

669 
	$luaRedisR‘uºSšgËF›ldTabË
(
lua_S‹
 *
lua
, *
f›ld
) {

670 ià(
	`lua_g‘tİ
(
lua
è!ğ1 || 
	`lua_ty³
Öua,-1è!ğ
LUA_TSTRING
) {

671 
	`luaPushE¼Ü
(
lua
, "wrong‚umber orype of‡rguments");

675 
	`lua_ÃwbË
(
lua
);

676 
	`lua_push¡ršg
(
lua
, 
f›ld
);

677 
	`lua_pushv®ue
(
lua
, -3);

678 
	`lua_£‰abË
(
lua
, -3);

680 
	}
}

683 
	$luaRedisE¼ÜR•lyCommªd
(
lua_S‹
 *
lua
) {

684  
	`luaRedisR‘uºSšgËF›ldTabË
(
lua
,"err");

685 
	}
}

688 
	$luaRedisStusR•lyCommªd
(
lua_S‹
 *
lua
) {

689  
	`luaRedisR‘uºSšgËF›ldTabË
(
lua
,"ok");

690 
	}
}

698 
	$luaRedisR•liÿ‹CommªdsCommªd
(
lua_S‹
 *
lua
) {

699 ià(
£rv”
.
lua_wr™e_dœty
) {

700 
	`lua_pushboŞ—n
(
lua
,0);

702 
£rv”
.
lua_»¶iÿ‹_commªds
 = 1;

706 
	`»disS¿nd48
(
	`¿nd
());

707 
	`lua_pushboŞ—n
(
lua
,1);

710 
	}
}

717 
	$luaRedisB»akpoštCommªd
(
lua_S‹
 *
lua
) {

718 ià(
ldb
.
aùive
) {

719 
ldb
.
luabp
 = 1;

720 
	`lua_pushboŞ—n
(
lua
,1);

722 
	`lua_pushboŞ—n
(
lua
,0);

725 
	}
}

732 
	$luaRedisDebugCommªd
(
lua_S‹
 *
lua
) {

733 ià(!
ldb
.
aùive
)  0;

734 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

735 
sds
 
log
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"<debug>†š%d: ", 
ldb
.
cu¼’še
);

736 
¬gc
--) {

737 
log
 = 
	`ldbC©SckV®ue
Öog,
lua
,-1 - 
¬gc
);

738 ià(
¬gc
 !ğ0è
log
 = 
	`sdsÿ’
(log,", ",2);

740 
	`ldbLog
(
log
);

742 
	}
}

748 
	$luaRedisS‘R•lCommªd
(
lua_S‹
 *
lua
) {

749 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

750 
æags
;

752 ià(
£rv”
.
lua_»¶iÿ‹_commªds
 == 0) {

753 
	`lua_push¡ršg
(
lua
, "You can sethe„eplication behavior only‡fterurning on single commands„eplication with„edis.replicate_commands().");

754  
	`lua_”rÜ
(
lua
);

755 } ià(
¬gc
 != 1) {

756 
	`lua_push¡ršg
(
lua
, "redis.set_repl()„equireswo‡rguments.");

757  
	`lua_”rÜ
(
lua
);

760 
æags
 = 
	`lua_tÚumb”
(
lua
,-1);

761 ià((
æags
 & ~(
PROPAGATE_AOF
|
PROPAGATE_REPL
)) != 0) {

762 
	`lua_push¡ršg
(
lua
, "Invalid„eplication flags. Use REPL_AOF, REPL_SLAVE, REPL_ALL or REPL_NONE.");

763  
	`lua_”rÜ
(
lua
);

765 
£rv”
.
lua_»¶
 = 
æags
;

767 
	}
}

770 
	$luaLogCommªd
(
lua_S‹
 *
lua
) {

771 
j
, 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

772 
Ëv–
;

773 
sds
 
log
;

775 ià(
¬gc
 < 2) {

776 
	`lua_push¡ršg
(
lua
, "redis.log()„equireswo‡rguments or more.");

777  
	`lua_”rÜ
(
lua
);

778 } ià(!
	`lua_i¢umb”
(
lua
,-
¬gc
)) {

779 
	`lua_push¡ršg
(
lua
, "First‡rgument must be‡‚umber (log†evel).");

780  
	`lua_”rÜ
(
lua
);

782 
Ëv–
 = 
	`lua_tÚumb”
(
lua
,-
¬gc
);

783 ià(
Ëv–
 < 
LL_DEBUG
 ||†ev– > 
LL_WARNING
) {

784 
	`lua_push¡ršg
(
lua
, "Invalid debug†evel.");

785  
	`lua_”rÜ
(
lua
);

789 
log
 = 
	`sd£m±y
();

790 
j
 = 1; j < 
¬gc
; j++) {

791 
size_t
 
Ën
;

792 *
s
;

794 
s
 = (*)
	`lua_tŞ¡ršg
(
lua
,(-
¬gc
)+
j
,&
Ën
);

795 ià(
s
) {

796 ià(
j
 !ğ1è
log
 = 
	`sdsÿ’
(log," ",1);

797 
log
 = 
	`sdsÿ’
Öog,
s
,
Ën
);

800 
	`£rv”LogRaw
(
Ëv–
,
log
);

801 
	`sdsä“
(
log
);

803 
	}
}

809 
	$luaLßdLib
(
lua_S‹
 *
lua
, cÚ¡ *
libÇme
, 
lua_CFunùiÚ
 
luafunc
) {

810 
	`lua_pushcfunùiÚ
(
lua
, 
luafunc
);

811 
	`lua_push¡ršg
(
lua
, 
libÇme
);

812 
	`lua_ÿÎ
(
lua
, 1, 0);

813 
	}
}

815 
LUALIB_API
 (
luaİ’_cjsÚ
è(
lua_S‹
 *
L
);

816 
LUALIB_API
 (
luaİ’_¡ruù
è(
lua_S‹
 *
L
);

817 
LUALIB_API
 (
luaİ’_cmsg·ck
è(
lua_S‹
 *
L
);

818 
LUALIB_API
 (
luaİ’_b™
è(
lua_S‹
 *
L
);

820 
	$luaLßdLib¿r›s
(
lua_S‹
 *
lua
) {

821 
	`luaLßdLib
(
lua
, "", 
luaİ’_ba£
);

822 
	`luaLßdLib
(
lua
, 
LUA_TABLIBNAME
, 
luaİ’_bË
);

823 
	`luaLßdLib
(
lua
, 
LUA_STRLIBNAME
, 
luaİ’_¡ršg
);

824 
	`luaLßdLib
(
lua
, 
LUA_MATHLIBNAME
, 
luaİ’_m©h
);

825 
	`luaLßdLib
(
lua
, 
LUA_DBLIBNAME
, 
luaİ’_debug
);

826 
	`luaLßdLib
(
lua
, "cjsÚ", 
luaİ’_cjsÚ
);

827 
	`luaLßdLib
(
lua
, "¡ruù", 
luaİ’_¡ruù
);

828 
	`luaLßdLib
(
lua
, "cmsg·ck", 
luaİ’_cmsg·ck
);

829 
	`luaLßdLib
(
lua
, "b™", 
luaİ’_b™
);

832 
	`luaLßdLib
(
lua
, 
LUA_LOADLIBNAME
, 
luaİ’_·ckage
);

833 
	`luaLßdLib
(
lua
, 
LUA_OSLIBNAME
, 
luaİ’_os
);

835 
	}
}

839 
	$luaRemoveUnsuµÜ‹dFunùiÚs
(
lua_S‹
 *
lua
) {

840 
	`lua_pushn
(
lua
);

841 
	`lua_£tglob®
(
lua
,"loadfile");

842 
	`lua_pushn
(
lua
);

843 
	`lua_£tglob®
(
lua
,"dofile");

844 
	}
}

851 
	$sütšgEÇbËGlob®sPrÙeùiÚ
(
lua_S‹
 *
lua
) {

852 *
s
[32];

853 
sds
 
code
 = 
	`sd£m±y
();

854 
j
 = 0;

858 
s
[
j
++]="local dbg=debug\n";

859 
s
[
j
++]="local mt = {}\n";

860 
s
[
j
++]="setmetatable(_G, mt)\n";

861 
s
[
j
++]="mt.__newindex = function (t,‚, v)\n";

862 
s
[
j
++]=" if dbg.getinfo(2)hen\n";

863 
s
[
j
++]="†ocal w = dbg.getinfo(2, \"S\").what\n";

864 
s
[
j
++]=" if w ~= \"main\"‡nd w ~= \"C\"hen\n";

865 
s
[
j
++]="ƒrror(\"Script‡ttemptedo create global variable '\"..tostring(n)..\"'\", 2)\n";

866 
s
[
j
++]="ƒnd\n";

867 
s
[
j
++]="ƒnd\n";

868 
s
[
j
++]="„awset(t,‚, v)\n";

869 
s
[
j
++]="end\n";

870 
s
[
j
++]="mt.__index = function (t,‚)\n";

871 
s
[
j
++]=" if dbg.getinfo(2)‡nd dbg.getinfo(2, \"S\").what ~= \"C\"hen\n";

872 
s
[
j
++]="ƒrror(\"Script‡ttemptedo‡ccess‚onexistent global variable '\"..tostring(n)..\"'\", 2)\n";

873 
s
[
j
++]="ƒnd\n";

874 
s
[
j
++]="„eturn„awget(t,‚)\n";

875 
s
[
j
++]="end\n";

876 
s
[
j
++]="debug =‚il\n";

877 
s
[
j
++]=
NULL
;

879 
j
 = 0; 
s
[j] !ğ
NULL
; j++è
code
 = 
	`sdsÿ’
(code,s[j],
	`¡¾’
(s[j]));

880 
	`luaL_lßdbufãr
(
lua
,
code
,
	`sd¦’
(code),"@enable_strict_lua");

881 
	`lua_pÿÎ
(
lua
,0,0,0);

882 
	`sdsä“
(
code
);

883 
	}
}

895 
	$sütšgIn™
(
£tup
) {

896 
lua_S‹
 *
lua
 = 
	`lua_İ’
();

898 ià(
£tup
) {

899 
£rv”
.
lua_ş›Á
 = 
NULL
;

900 
£rv”
.
lua_ÿÎ”
 = 
NULL
;

901 
£rv”
.
lua_timedout
 = 0;

902 
£rv”
.
lua_®ways_»¶iÿ‹_commªds
 = 0;

903 
£rv”
.
lua_time_lim™
 = 
LUA_SCRIPT_TIME_LIMIT
;

904 
	`ldbIn™
();

907 
	`luaLßdLib¿r›s
(
lua
);

908 
	`luaRemoveUnsuµÜ‹dFunùiÚs
(
lua
);

913 
£rv”
.
lua_süts
 = 
	`diùC»©e
(&
shaSütObjeùDiùTy³
,
NULL
);

916 
	`lua_ÃwbË
(
lua
);

919 
	`lua_push¡ršg
(
lua
,"call");

920 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisC®lCommªd
);

921 
	`lua_£‰abË
(
lua
,-3);

924 
	`lua_push¡ršg
(
lua
,"pcall");

925 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisPC®lCommªd
);

926 
	`lua_£‰abË
(
lua
,-3);

929 
	`lua_push¡ršg
(
lua
,"log");

930 
	`lua_pushcfunùiÚ
(
lua
,
luaLogCommªd
);

931 
	`lua_£‰abË
(
lua
,-3);

933 
	`lua_push¡ršg
(
lua
,"LOG_DEBUG");

934 
	`lua_pushnumb”
(
lua
,
LL_DEBUG
);

935 
	`lua_£‰abË
(
lua
,-3);

937 
	`lua_push¡ršg
(
lua
,"LOG_VERBOSE");

938 
	`lua_pushnumb”
(
lua
,
LL_VERBOSE
);

939 
	`lua_£‰abË
(
lua
,-3);

941 
	`lua_push¡ršg
(
lua
,"LOG_NOTICE");

942 
	`lua_pushnumb”
(
lua
,
LL_NOTICE
);

943 
	`lua_£‰abË
(
lua
,-3);

945 
	`lua_push¡ršg
(
lua
,"LOG_WARNING");

946 
	`lua_pushnumb”
(
lua
,
LL_WARNING
);

947 
	`lua_£‰abË
(
lua
,-3);

950 
	`lua_push¡ršg
(
lua
, "sha1hex");

951 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisSha1hexCommªd
);

952 
	`lua_£‰abË
(
lua
, -3);

955 
	`lua_push¡ršg
(
lua
, "error_reply");

956 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisE¼ÜR•lyCommªd
);

957 
	`lua_£‰abË
(
lua
, -3);

958 
	`lua_push¡ršg
(
lua
, "status_reply");

959 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisStusR•lyCommªd
);

960 
	`lua_£‰abË
(
lua
, -3);

963 
	`lua_push¡ršg
(
lua
, "replicate_commands");

964 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisR•liÿ‹CommªdsCommªd
);

965 
	`lua_£‰abË
(
lua
, -3);

968 
	`lua_push¡ršg
(
lua
,"set_repl");

969 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisS‘R•lCommªd
);

970 
	`lua_£‰abË
(
lua
,-3);

972 
	`lua_push¡ršg
(
lua
,"REPL_NONE");

973 
	`lua_pushnumb”
(
lua
,
PROPAGATE_NONE
);

974 
	`lua_£‰abË
(
lua
,-3);

976 
	`lua_push¡ršg
(
lua
,"REPL_AOF");

977 
	`lua_pushnumb”
(
lua
,
PROPAGATE_AOF
);

978 
	`lua_£‰abË
(
lua
,-3);

980 
	`lua_push¡ršg
(
lua
,"REPL_SLAVE");

981 
	`lua_pushnumb”
(
lua
,
PROPAGATE_REPL
);

982 
	`lua_£‰abË
(
lua
,-3);

984 
	`lua_push¡ršg
(
lua
,"REPL_ALL");

985 
	`lua_pushnumb”
(
lua
,
PROPAGATE_AOF
|
PROPAGATE_REPL
);

986 
	`lua_£‰abË
(
lua
,-3);

989 
	`lua_push¡ršg
(
lua
,"breakpoint");

990 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisB»akpoštCommªd
);

991 
	`lua_£‰abË
(
lua
,-3);

994 
	`lua_push¡ršg
(
lua
,"debug");

995 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisDebugCommªd
);

996 
	`lua_£‰abË
(
lua
,-3);

999 
	`lua_£tglob®
(
lua
,"redis");

1002 
	`lua_g‘glob®
(
lua
,"math");

1004 
	`lua_push¡ršg
(
lua
,"random");

1005 
	`lua_pushcfunùiÚ
(
lua
,
»dis_m©h_¿ndom
);

1006 
	`lua_£‰abË
(
lua
,-3);

1008 
	`lua_push¡ršg
(
lua
,"randomseed");

1009 
	`lua_pushcfunùiÚ
(
lua
,
»dis_m©h_¿ndom£ed
);

1010 
	`lua_£‰abË
(
lua
,-3);

1012 
	`lua_£tglob®
(
lua
,"math");

1017 *
com·»_func
 = "function __redis__compare_helper(a,b)\n"

1022 
	`luaL_lßdbufãr
(
lua
,
com·»_func
,
	`¡¾’
(compare_func),"@cmp_func_def");

1023 
	`lua_pÿÎ
(
lua
,0,0,0);

1031 *
”rh_func
 = "local dbg = debug\n"

1043 
	`luaL_lßdbufãr
(
lua
,
”rh_func
,
	`¡¾’
(errh_func),"@err_handler_def");

1044 
	`lua_pÿÎ
(
lua
,0,0,0);

1051 ià(
£rv”
.
lua_ş›Á
 =ğ
NULL
) {

1052 
£rv”
.
lua_ş›Á
 = 
	`ü—‹Cl›Á
(-1);

1053 
£rv”
.
lua_ş›Á
->
æags
 |ğ
CLIENT_LUA
;

1059 
	`sütšgEÇbËGlob®sPrÙeùiÚ
(
lua
);

1061 
£rv”
.
lua
 =†ua;

1062 
	}
}

1066 
	$sütšgR–—£
() {

1067 
	`diùR–—£
(
£rv”
.
lua_süts
);

1068 
	`lua_şo£
(
£rv”
.
lua
);

1069 
	}
}

1071 
	$sütšgRe£t
() {

1072 
	`sütšgR–—£
();

1073 
	`sütšgIn™
(0);

1074 
	}
}

1078 
	$luaS‘Glob®A¼ay
(
lua_S‹
 *
lua
, *
v¬
, 
robj
 **
–ev
, 
–ec
) {

1079 
j
;

1081 
	`lua_ÃwbË
(
lua
);

1082 
j
 = 0; j < 
–ec
; j++) {

1083 
	`lua_pushl¡ršg
(
lua
,(*)
–ev
[
j
]->
±r
,
	`sd¦’
(elev[j]->ptr));

1084 
	`lua_¿w£ti
(
lua
,-2,
j
+1);

1086 
	`lua_£tglob®
(
lua
,
v¬
);

1087 
	}
}

1099 
	$»dis_m©h_¿ndom
 (
lua_S‹
 *
L
) {

1102 
lua_Numb”
 
r
 = (lua_Numb”)(
	`»disL¿nd48
()%
REDIS_LRAND48_MAX
) /

1103 (
lua_Numb”
)
REDIS_LRAND48_MAX
;

1104 
	`lua_g‘tİ
(
L
)) {

1106 
	`lua_pushnumb”
(
L
, 
r
);

1110 
u
 = 
	`luaL_checkšt
(
L
, 1);

1111 
	`luaL_¬gcheck
(
L
, 1<=
u
, 1, "interval isƒmpty");

1112 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
r
*
u
)+1);

1116 
l
 = 
	`luaL_checkšt
(
L
, 1);

1117 
u
 = 
	`luaL_checkšt
(
L
, 2);

1118 
	`luaL_¬gcheck
(
L
, 
l
<=
u
, 2, "interval isƒmpty");

1119 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
r
*(
u
-
l
+1))+l);

1122 :  
	`luaL_”rÜ
(
L
, "wrong‚umber of‡rguments");

1125 
	}
}

1127 
	$»dis_m©h_¿ndom£ed
 (
lua_S‹
 *
L
) {

1128 
	`»disS¿nd48
(
	`luaL_checkšt
(
L
, 1));

1130 
	}
}

1145 
	$luaC»©eFunùiÚ
(
ş›Á
 *
c
, 
lua_S‹
 *
lua
, *
funúame
, 
robj
 *
body
) {

1146 
sds
 
funcdef
 = 
	`sd£m±y
();

1148 
funcdef
 = 
	`sdsÿt
(funcdef,"function ");

1149 
funcdef
 = 
	`sdsÿ’
(funcdef,
funúame
,42);

1150 
funcdef
 = 
	`sdsÿ’
(funcdef,"() ",3);

1151 
funcdef
 = 
	`sdsÿ’
(funcdef,
body
->
±r
,
	`sd¦’
(body->ptr));

1152 
funcdef
 = 
	`sdsÿ’
(funcdef,"\nend",4);

1154 ià(
	`luaL_lßdbufãr
(
lua
,
funcdef
,
	`sd¦’
(funcdef),"@user_script")) {

1155 
	`addR•lyE¼ÜFÜm©
(
c
,"Error compiling script (new function): %s\n",

1156 
	`lua_to¡ršg
(
lua
,-1));

1157 
	`lua_pİ
(
lua
,1);

1158 
	`sdsä“
(
funcdef
);

1159  
C_ERR
;

1161 
	`sdsä“
(
funcdef
);

1162 ià(
	`lua_pÿÎ
(
lua
,0,0,0)) {

1163 
	`addR•lyE¼ÜFÜm©
(
c
,"Error„unning script (new function): %s\n",

1164 
	`lua_to¡ršg
(
lua
,-1));

1165 
	`lua_pİ
(
lua
,1);

1166  
C_ERR
;

1173 
»tv®
 = 
	`diùAdd
(
£rv”
.
lua_süts
,

1174 
	`sd¢ewËn
(
funúame
+2,40),
body
);

1175 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
»tv®
 =ğ
DICT_OK
);

1176 
	`šüRefCouÁ
(
body
);

1178  
C_OK
;

1179 
	}
}

1182 
	$luaMaskCouÁHook
(
lua_S‹
 *
lua
, 
lua_Debug
 *
¬
) {

1183 
–­£d
;

1184 
	`UNUSED
(
¬
);

1185 
	`UNUSED
(
lua
);

1187 
–­£d
 = 
	`m¡ime
(è- 
£rv”
.
lua_time_¡¬t
;

1188 ià(
–­£d
 >ğ
£rv”
.
lua_time_lim™
 && s”v”.
lua_timedout
 == 0) {

1189 
	`£rv”Log
(
LL_WARNING
,"Lu¨¦ow süˆd‘eùed: stÈšƒxecutiÚ‡á” %Îd mli£cÚds. You cªry klšghsüˆusšghSCRIPT KILL commªd.",
–­£d
);

1190 
£rv”
.
lua_timedout
 = 1;

1196 
	`«D–‘eFeEv’t
(
£rv”
.
–
, s”v”.
lua_ÿÎ”
->
fd
, 
AE_READABLE
);

1198 ià(
£rv”
.
lua_timedout
è
	`´oûssEv’tsWheBlocked
();

1199 ià(
£rv”
.
lua_kl
) {

1200 
	`£rv”Log
(
LL_WARNING
,"Lua script killed by user with SCRIPT KILL.");

1201 
	`lua_push¡ršg
(
lua
,"Script killed by user with SCRIPT KILL...");

1202 
	`lua_”rÜ
(
lua
);

1204 
	}
}

1206 
	$ev®G’”icCommªd
(
ş›Á
 *
c
, 
ev®sha
) {

1207 
lua_S‹
 *
lua
 = 
£rv”
.lua;

1208 
funúame
[43];

1209 
numkeys
;

1210 
d–hook
 = 0, 
”r
;

1214 
	`»disS¿nd48
(0);

1224 
£rv”
.
lua_¿ndom_dœty
 = 0;

1225 
£rv”
.
lua_wr™e_dœty
 = 0;

1226 
£rv”
.
lua_»¶iÿ‹_commªds
 = s”v”.
lua_®ways_»¶iÿ‹_commªds
;

1227 
£rv”
.
lua_muÉi_em™‹d
 = 0;

1228 
£rv”
.
lua_»¶
 = 
PROPAGATE_AOF
|
PROPAGATE_REPL
;

1231 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
numkeys
,
NULL
è!ğ
C_OK
)

1233 ià(
numkeys
 > (
c
->
¬gc
 - 3)) {

1234 
	`addR•lyE¼Ü
(
c
,"Number of keys can't be greaterhan‚umber of‡rgs");

1236 } ià(
numkeys
 < 0) {

1237 
	`addR•lyE¼Ü
(
c
,"Number of keys can't be‚egative");

1243 
funúame
[0] = 'f';

1244 
funúame
[1] = '_';

1245 ià(!
ev®sha
) {

1247 
	`sha1hex
(
funúame
+2,
c
->
¬gv
[1]->
±r
,
	`sd¦’
(c->argv[1]->ptr));

1250 
j
;

1251 *
sha
 = 
c
->
¬gv
[1]->
±r
;

1256 
j
 = 0; j < 40; j++)

1257 
funúame
[
j
+2] = (
sha
[j] >= 'A' && sha[j] <= 'Z') ?

1258 
sha
[
j
]+('a'-'A') : sha[j];

1259 
funúame
[42] = '\0';

1263 
	`lua_g‘glob®
(
lua
, "__redis__err__handler");

1266 
	`lua_g‘glob®
(
lua
, 
funúame
);

1267 ià(
	`lua_i¢
(
lua
,-1)) {

1268 
	`lua_pİ
(
lua
,1);

1272 ià(
ev®sha
) {

1273 
	`lua_pİ
(
lua
,1);

1274 
	`addR•ly
(
c
, 
sh¬ed
.
nosü‹¼
);

1277 ià(
	`luaC»©eFunùiÚ
(
c
,
lua
,
funúame
,c->
¬gv
[1]è=ğ
C_ERR
) {

1278 
	`lua_pİ
(
lua
,1);

1284 
	`lua_g‘glob®
(
lua
, 
funúame
);

1285 
	`£rv”As£¹
(!
	`lua_i¢
(
lua
,-1));

1290 
	`luaS‘Glob®A¼ay
(
lua
,"KEYS",
c
->
¬gv
+3,
numkeys
);

1291 
	`luaS‘Glob®A¼ay
(
lua
,"ARGV",
c
->
¬gv
+3+
numkeys
,c->
¬gc
-3-numkeys);

1294 
	`£ËùDb
(
£rv”
.
lua_ş›Á
,
c
->
db
->
id
);

1303 
£rv”
.
lua_ÿÎ”
 = 
c
;

1304 
£rv”
.
lua_time_¡¬t
 = 
	`m¡ime
();

1305 
£rv”
.
lua_kl
 = 0;

1306 ià(
£rv”
.
lua_time_lim™
 > 0 && s”v”.
ma¡”ho¡
 =ğ
NULL
 &&

1307 
ldb
.
aùive
 == 0)

1309 
	`lua_£thook
(
lua
,
luaMaskCouÁHook
,
LUA_MASKCOUNT
,100000);

1310 
d–hook
 = 1;

1311 } ià(
ldb
.
aùive
) {

1312 
	`lua_£thook
(
£rv”
.
lua
,
luaLdbLšeHook
,
LUA_MASKLINE
|
LUA_MASKCOUNT
,100000);

1313 
d–hook
 = 1;

1319 
”r
 = 
	`lua_pÿÎ
(
lua
,0,1,-2);

1322 ià(
d–hook
è
	`lua_£thook
(
lua
,
NULL
,0,0);

1323 ià(
£rv”
.
lua_timedout
) {

1324 
£rv”
.
lua_timedout
 = 0;

1327 
	`«C»©eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_READABLE
,

1328 
»adQu”yFromCl›Á
,
c
);

1330 
£rv”
.
lua_ÿÎ”
 = 
NULL
;

1338 
	#LUA_GC_CYCLE_PERIOD
 50

	)

1340 
gc_couÁ
 = 0;

1342 
gc_couÁ
++;

1343 ià(
gc_couÁ
 =ğ
LUA_GC_CYCLE_PERIOD
) {

1344 
	`lua_gc
(
lua
,
LUA_GCSTEP
,
LUA_GC_CYCLE_PERIOD
);

1345 
gc_couÁ
 = 0;

1349 ià(
”r
) {

1350 
	`addR•lyE¼ÜFÜm©
(
c
,"Error„unning script (callo %s): %s\n",

1351 
funúame
, 
	`lua_to¡ršg
(
lua
,-1));

1352 
	`lua_pİ
(
lua
,2);

1356 
	`luaR•lyToRedisR•ly
(
c
,
lua
);

1357 
	`lua_pİ
(
lua
,1);

1362 ià(
£rv”
.
lua_»¶iÿ‹_commªds
) {

1363 
	`´ev’tCommªdPrİag©iÚ
(
c
);

1364 ià(
£rv”
.
lua_muÉi_em™‹d
) {

1365 
robj
 *
´İ¬gv
[1];

1366 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("EXEC",4);

1367 
	`®soPrİag©e
(
£rv”
.
execCommªd
,
c
->
db
->
id
,
´İ¬gv
,1,

1368 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

1369 
	`deüRefCouÁ
(
´İ¬gv
[0]);

1383 ià(
ev®sha
 && !
£rv”
.
lua_»¶iÿ‹_commªds
) {

1384 ià(!
	`»¶iÿtiÚSütCacheExi¡s
(
c
->
¬gv
[1]->
±r
)) {

1388 
robj
 *
süt
 = 
	`diùF‘chV®ue
(
£rv”
.
lua_süts
,
c
->
¬gv
[1]->
±r
);

1390 
	`»¶iÿtiÚSütCacheAdd
(
c
->
¬gv
[1]->
±r
);

1391 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
süt
 != NULL);

1392 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,

1393 
	`»£tRefCouÁ
(
	`ü—‹SŒšgObjeù
("EVAL",4)));

1394 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,1,
süt
);

1395 
	`fÜûCommªdPrİag©iÚ
(
c
,
PROPAGATE_REPL
|
PROPAGATE_AOF
);

1398 
	}
}

1400 
	$ev®Commªd
(
ş›Á
 *
c
) {

1401 ià(!(
c
->
æags
 & 
CLIENT_LUA_DEBUG
))

1402 
	`ev®G’”icCommªd
(
c
,0);

1404 
	`ev®G’”icCommªdW™hDebuggšg
(
c
,0);

1405 
	}
}

1407 
	$ev®ShaCommªd
(
ş›Á
 *
c
) {

1408 ià(
	`sd¦’
(
c
->
¬gv
[1]->
±r
) != 40) {

1413 
	`addR•ly
(
c
, 
sh¬ed
.
nosü‹¼
);

1416 ià(!(
c
->
æags
 & 
CLIENT_LUA_DEBUG
))

1417 
	`ev®G’”icCommªd
(
c
,1);

1419 
	`addR•lyE¼Ü
(
c
,"Please use EVAL instead of EVALSHA for debugging");

1422 
	}
}

1424 
	$sütCommªd
(
ş›Á
 *
c
) {

1425 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"flush")) {

1426 
	`sütšgRe£t
();

1427 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1428 
	`»¶iÿtiÚSütCacheFlush
();

1429 
£rv”
.
dœty
++;

1430 } ià(
c
->
¬gc
 >ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"exists")) {

1431 
j
;

1433 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

1434 
j
 = 2; j < 
c
->
¬gc
; j++) {

1435 ià(
	`diùFšd
(
£rv”
.
lua_süts
,
c
->
¬gv
[
j
]->
±r
))

1436 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

1438 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1440 } ià(
c
->
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"load")) {

1441 
funúame
[43];

1442 
sds
 
sha
;

1444 
funúame
[0] = 'f';

1445 
funúame
[1] = '_';

1446 
	`sha1hex
(
funúame
+2,
c
->
¬gv
[2]->
±r
,
	`sd¦’
(c->argv[2]->ptr));

1447 
sha
 = 
	`sd¢ewËn
(
funúame
+2,40);

1448 ià(
	`diùFšd
(
£rv”
.
lua_süts
,
sha
è=ğ
NULL
) {

1449 ià(
	`luaC»©eFunùiÚ
(
c
,
£rv”
.
lua
,
funúame
,c->
¬gv
[2])

1450 =ğ
C_ERR
) {

1451 
	`sdsä“
(
sha
);

1455 
	`addR•lyBulkCBufãr
(
c
,
funúame
+2,40);

1456 
	`sdsä“
(
sha
);

1457 
	`fÜûCommªdPrİag©iÚ
(
c
,
PROPAGATE_REPL
|
PROPAGATE_AOF
);

1458 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"kill")) {

1459 ià(
£rv”
.
lua_ÿÎ”
 =ğ
NULL
) {

1460 
	`addR•lySds
(
c
,
	`sd¢ew
("-NOTBUSY No scripts inƒxecution„ight‚ow.\r\n"));

1461 } ià(
£rv”
.
lua_wr™e_dœty
) {

1462 
	`addR•lySds
(
c
,
	`sd¢ew
("-UNKILLABLE Sorryhe script‡lreadyƒxecuted write commands‡gainsthe dataset. You canƒither waithe scriptermination or killhe server in‡ hard way usinghe SHUTDOWN NOSAVE command.\r\n"));

1464 
£rv”
.
lua_kl
 = 1;

1465 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1467 } ià(
c
->
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"debug")) {

1468 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

1469 
	`addR•lyE¼Ü
(
c
,"SCRIPT DEBUG must be called outside‡…ipeline");

1472 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"no")) {

1473 
	`ldbDi§bË
(
c
);

1474 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1475 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"yes")) {

1476 
	`ldbEÇbË
(
c
);

1477 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1478 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"sync")) {

1479 
	`ldbEÇbË
(
c
);

1480 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1481 
c
->
æags
 |ğ
CLIENT_LUA_DEBUG_SYNC
;

1483 
	`addR•lyE¼Ü
(
c
,"Use SCRIPT DEBUG yes/sync/no");

1486 
	`addR•lyE¼Ü
(
c
, "Unknown SCRIPT subcommand or wrong # of‡rgs.");

1488 
	}
}

1495 
	$ldbIn™
() {

1496 
ldb
.
fd
 = -1;

1497 
ldb
.
aùive
 = 0;

1498 
ldb
.
logs
 = 
	`li¡C»©e
();

1499 
	`li¡S‘F»eM‘hod
(
ldb
.
logs
,((*)(*))
sdsä“
);

1500 
ldb
.
chd»n
 = 
	`li¡C»©e
();

1501 
ldb
.
¤c
 = 
NULL
;

1502 
ldb
.
lšes
 = 0;

1503 
ldb
.
cbuf
 = 
	`sd£m±y
();

1504 
	}
}

1507 
	$ldbFlushLog
(
li¡
 *
log
) {

1508 
li¡Node
 *
Ê
;

1510 (
Ê
 = 
	`li¡Fœ¡
(
log
)è!ğ
NULL
)

1511 
	`li¡D–Node
(
log
,
Ê
);

1512 
	}
}

1515 
	$ldbEÇbË
(
ş›Á
 *
c
) {

1516 
c
->
æags
 |ğ
CLIENT_LUA_DEBUG
;

1517 
	`ldbFlushLog
(
ldb
.
logs
);

1518 
ldb
.
fd
 = 
c
->fd;

1519 
ldb
.
¡•
 = 1;

1520 
ldb
.
bpcouÁ
 = 0;

1521 
ldb
.
luabp
 = 0;

1522 
	`sdsä“
(
ldb
.
cbuf
);

1523 
ldb
.
cbuf
 = 
	`sd£m±y
();

1524 
ldb
.
maxËn
 = 
LDB_MAX_LEN_DEFAULT
;

1525 
ldb
.
maxËn_hšt_£Á
 = 0;

1526 
	}
}

1531 
	$ldbDi§bË
(
ş›Á
 *
c
) {

1532 
c
->
æags
 &ğ~(
CLIENT_LUA_DEBUG
|
CLIENT_LUA_DEBUG_SYNC
);

1533 
	}
}

1536 
	$ldbLog
(
sds
 
’Œy
) {

1537 
	`li¡AddNodeTa
(
ldb
.
logs
,
’Œy
);

1538 
	}
}

1544 
	$ldbLogW™hMaxL’
(
sds
 
’Œy
) {

1545 
Œimmed
 = 0;

1546 ià(
ldb
.
maxËn
 && 
	`sd¦’
(
’Œy
) >†db.maxlen) {

1547 
	`sd¤ªge
(
’Œy
,0,
ldb
.
maxËn
-1);

1548 
’Œy
 = 
	`sdsÿ’
(entry," ...",4);

1549 
Œimmed
 = 1;

1551 
	`ldbLog
(
’Œy
);

1552 ià(
Œimmed
 && 
ldb
.
maxËn_hšt_£Á
 == 0) {

1553 
ldb
.
maxËn_hšt_£Á
 = 1;

1554 
	`ldbLog
(
	`sd¢ew
(

1557 
	}
}

1562 
	$ldbS’dLogs
() {

1563 
sds
 
´Ùo
 = 
	`sd£m±y
();

1564 
´Ùo
 = 
	`sdsÿtfmt
ÕrÙo,"*%i\r\n", ()
	`li¡L’gth
(
ldb
.
logs
));

1565 
	`li¡L’gth
(
ldb
.
logs
)) {

1566 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
ldb
.
logs
);

1567 
´Ùo
 = 
	`sdsÿ’
(proto,"+",1);

1568 
	`sdsm­ch¬s
(
Ê
->
v®ue
,"\r\n"," ",2);

1569 
´Ùo
 = 
	`sdsÿtsds
ÕrÙo,
Ê
->
v®ue
);

1570 
´Ùo
 = 
	`sdsÿ’
(proto,"\r\n",2);

1571 
	`li¡D–Node
(
ldb
.
logs
,
Ê
);

1573 ià(
	`wr™e
(
ldb
.
fd
,
´Ùo
,
	`sd¦’
(proto)) == -1) {

1578 
	`sdsä“
(
´Ùo
);

1579 
	}
}

1593 
	$ldbS¹SessiÚ
(
ş›Á
 *
c
) {

1594 
ldb
.
fÜked
 = (
c
->
æags
 & 
CLIENT_LUA_DEBUG_SYNC
) == 0;

1595 ià(
ldb
.
fÜked
) {

1596 
pid_t
 
ı
 = 
	`fÜk
();

1597 ià(
ı
 == -1) {

1598 
	`addR•lyE¼Ü
(
c
,"Fork() failed: can't„un EVAL in debugging mode.");

1600 } ià(
ı
 == 0) {

1602 
sigaùiÚ
 
aù
;

1603 
	`sigem±y£t
(&
aù
.
§_mask
);

1604 
aù
.
§_æags
 = 0;

1605 
aù
.
§_hªdËr
 = 
SIG_IGN
;

1606 
	`sigaùiÚ
(
SIGTERM
, &
aù
, 
NULL
);

1607 
	`sigaùiÚ
(
SIGINT
, &
aù
, 
NULL
);

1612 
	`£rv”Log
(
LL_WARNING
,"Redis forked for debuggingƒval");

1613 
	`şo£Li¡’šgSock‘s
(0);

1616 
	`li¡AddNodeTa
(
ldb
.
chd»n
,(*)()
ı
);

1617 
	`ä“Cl›ÁAsync
(
c
);

1621 
	`£rv”Log
(
LL_WARNING
,

1626 
	`ª‘Block
(
NULL
,
ldb
.
fd
);

1627 
	`ª‘S’dTimeout
(
NULL
,
ldb
.
fd
,5000);

1628 
ldb
.
aùive
 = 1;

1632 
sds
 
¤c¡ršg
 = 
	`sdsdup
(
c
->
¬gv
[1]->
±r
);

1633 
size_t
 
¤ş’
 = 
	`sd¦’
(
¤c¡ršg
);

1634 
¤ş’
 && (
¤c¡ršg
[srclen-1] == '\n' ||

1635 
¤c¡ršg
[
¤ş’
-1] == '\r'))

1637 
¤c¡ršg
[--
¤ş’
] = '\0';

1639 
	`sds£’
(
¤c¡ršg
,
¤ş’
);

1640 
ldb
.
¤c
 = 
	`sds¥l™Ën
(
¤c¡ršg
,
	`sd¦’
(¤c¡ršg),"\n",1,&ldb.
lšes
);

1641 
	`sdsä“
(
¤c¡ršg
);

1643 
	}
}

1647 
	$ldbEndSessiÚ
(
ş›Á
 *
c
) {

1649 
	`ldbLog
(
	`sd¢ew
("<endsession>"));

1650 
	`ldbS’dLogs
();

1653 ià(
ldb
.
fÜked
) {

1654 
	`wr™eToCl›Á
(
c
->
fd
, c, 0);

1655 
	`£rv”Log
(
LL_WARNING
,"Lua debugging session childƒxiting");

1656 
	`ex™FromChd
(0);

1658 
	`£rv”Log
(
LL_WARNING
,

1663 
	`ª‘NÚBlock
(
NULL
,
ldb
.
fd
);

1664 
	`ª‘S’dTimeout
(
NULL
,
ldb
.
fd
,0);

1668 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1671 
	`sdsä“¥l™»s
(
ldb
.
¤c
,ldb.
lšes
);

1672 
ldb
.
lšes
 = 0;

1673 
ldb
.
aùive
 = 0;

1674 
	}
}

1679 
	$ldbRemoveChd
(
pid_t
 
pid
) {

1680 
li¡Node
 *
Ê
 = 
	`li¡S—rchKey
(
ldb
.
chd»n
,(*)()
pid
);

1681 ià(
Ê
) {

1682 
	`li¡D–Node
(
ldb
.
chd»n
,
Ê
);

1686 
	}
}

1690 
	$ldbP’dšgChd»n
() {

1691  
	`li¡L’gth
(
ldb
.
chd»n
);

1692 
	}
}

1695 
	$ldbKlFÜkedSessiÚs
() {

1696 
li¡I‹r
 
li
;

1697 
li¡Node
 *
Ê
;

1699 
	`li¡Rewšd
(
ldb
.
chd»n
,&
li
);

1700 (
Ê
 = 
	`li¡Next
(&
li
))) {

1701 
pid_t
 
pid
 = (è
Ê
->
v®ue
;

1702 
	`£rv”Log
(
LL_WARNING
,"Klšg debuggšg sessiÚ %ld",()
pid
);

1703 
	`kl
(
pid
,
SIGKILL
);

1705 
	`li¡R–—£
(
ldb
.
chd»n
);

1706 
ldb
.
chd»n
 = 
	`li¡C»©e
();

1707 
	}
}

1711 
	$ev®G’”icCommªdW™hDebuggšg
(
ş›Á
 *
c
, 
ev®sha
) {

1712 ià(
	`ldbS¹SessiÚ
(
c
)) {

1713 
	`ev®G’”icCommªd
(
c
,
ev®sha
);

1714 
	`ldbEndSessiÚ
(
c
);

1716 
	`ldbDi§bË
(
c
);

1718 
	}
}

1722 *
	$ldbG‘SourûLše
(
lše
) {

1723 
idx
 = 
lše
-1;

1724 ià(
idx
 < 0 || idx >ğ
ldb
.
lšes
)  "<out of„ange source code†ine>";

1725  
ldb
.
¤c
[
idx
];

1726 
	}
}

1729 
	$ldbIsB»akpošt
(
lše
) {

1730 
j
;

1732 
j
 = 0; j < 
ldb
.
bpcouÁ
; j++)

1733 ià(
ldb
.
bp
[
j
] =ğ
lše
)  1;

1735 
	}
}

1740 
	$ldbAddB»akpošt
(
lše
) {

1741 ià(
lše
 <ğ0 ||†š> 
ldb
.
lšes
)  0;

1742 ià(!
	`ldbIsB»akpošt
(
lše
è&& 
ldb
.
bpcouÁ
 !ğ
LDB_BREAKPOINTS_MAX
) {

1743 
ldb
.
bp
[ldb.
bpcouÁ
++] = 
lše
;

1747 
	}
}

1751 
	$ldbD–B»akpošt
(
lše
) {

1752 
j
;

1754 
j
 = 0; j < 
ldb
.
bpcouÁ
; j++) {

1755 ià(
ldb
.
bp
[
j
] =ğ
lše
) {

1756 
ldb
.
bpcouÁ
--;

1757 
	`memmove
(
ldb
.
bp
+
j
,ldb.bp+j+1,ldb.
bpcouÁ
-j);

1762 
	}
}

1767 
sds
 *
	$ldbR•lP¬£Commªd
(*
¬gı
) {

1768 
sds
 *
¬gv
 = 
NULL
;

1769 
¬gc
 = 0;

1770 ià(
	`sd¦’
(
ldb
.
cbuf
è=ğ0è 
NULL
;

1774 
sds
 
cİy
 = 
	`sdsdup
(
ldb
.
cbuf
);

1775 *
p
 = 
cİy
;

1782 
p
 = 
	`¡rchr
Õ,'*'); ià(!pè
´ÙÛ¼
;

1783 *
¶’
 = 
p
+1;

1784 
p
 = 
	`¡r¡r
Õ,"\r\n"); ià(!pè
´ÙÛ¼
;

1785 *
p
 = '\0';… += 2;

1786 *
¬gı
 = 
	`©oi
(
¶’
);

1787 ià(*
¬gı
 <ğ0 || *¬gı > 1024è
´ÙÛ¼
;

1790 
¬gv
 = 
	`zm®loc
((
sds
)*(*
¬gı
));

1791 
¬gc
 = 0;

1792 
¬gc
 < *
¬gı
) {

1793 ià(*
p
 !ğ'$'è
´ÙÛ¼
;

1794 
¶’
 = 
p
+1;

1795 
p
 = 
	`¡r¡r
Õ,"\r\n"); ià(!pè
´ÙÛ¼
;

1796 *
p
 = '\0';… += 2;

1797 
¦’
 = 
	`©oi
(
¶’
);

1798 ià(
¦’
 <ğ0 || sËÀ> 1024è
´ÙÛ¼
;

1799 
¬gv
[
¬gc
++] = 
	`sd¢ewËn
(
p
,
¦’
);

1800 
p
 +ğ
¦’
;

1801 ià(
p
[0] !ğ'\r' ||…[1] !ğ'\n'è
´ÙÛ¼
;

1802 
p
 += 2;

1804 
	`sdsä“
(
cİy
);

1805  
¬gv
;

1807 
´ÙÛ¼
:

1808 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1809 
	`sdsä“
(
cİy
);

1810  
NULL
;

1811 
	}
}

1814 
	$ldbLogSourûLše
(
Êum
) {

1815 *
lše
 = 
	`ldbG‘SourûLše
(
Êum
);

1816 *
´efix
;

1817 
bp
 = 
	`ldbIsB»akpošt
(
Êum
);

1818 
cu¼’t
 = 
ldb
.
cu¼’še
 =ğ
Êum
;

1820 ià(
cu¼’t
 && 
bp
)

1821 
´efix
 = "->#";

1822 ià(
cu¼’t
)

1823 
´efix
 = "-> ";

1824 ià(
bp
)

1825 
´efix
 = " #";

1827 
´efix
 = " ";

1828 
sds
 
thi¦še
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%s%-3d %s", 
´efix
, 
Êum
, 
lše
);

1829 
	`ldbLog
(
thi¦še
);

1830 
	}
}

1837 
	$ldbLi¡
(
¬ound
, 
cÚ‹xt
) {

1838 
j
;

1840 
j
 = 1; j <ğ
ldb
.
lšes
; j++) {

1841 ià(
¬ound
 !ğ0 && 
	`abs
×round-
j
è> 
cÚ‹xt
) ;

1842 
	`ldbLogSourûLše
(
j
);

1844 
	}
}

1853 
	#LDB_MAX_VALUES_DEPTH
 (
LUA_MINSTACK
/2)

	)

1854 
sds
 
	$ldbC©SckV®ueRec
(
sds
 
s
, 
lua_S‹
 *
lua
, 
idx
, 
Ëv–
) {

1855 
t
 = 
	`lua_ty³
(
lua
,
idx
);

1857 ià(
Ëv–
++ =ğ
LDB_MAX_VALUES_DEPTH
)

1858  
	`sdsÿt
(
s
,"<max„ecursion†evel„eached! Nestedable?>");

1860 
t
) {

1861 
LUA_TSTRING
:

1863 
size_t
 
¡¾
;

1864 *
¡½
 = (*)
	`lua_tŞ¡ršg
(
lua
,
idx
,&
¡¾
);

1865 
s
 = 
	`sdsÿŒ•r
(s,
¡½
,
¡¾
);

1868 
LUA_TBOOLEAN
:

1869 
s
 = 
	`sdsÿt
(s,
	`lua_toboŞ—n
(
lua
,
idx
) ? "true" : "false");

1871 
LUA_TNUMBER
:

1872 
s
 = 
	`sdsÿrštf
(s,"%g",()
	`lua_tÚumb”
(
lua
,
idx
));

1874 
LUA_TNIL
:

1875 
s
 = 
	`sdsÿ’
(s,"nil",3);

1877 
LUA_TTABLE
:

1879 
ex³ùed_šdex
 = 1;

1880 
is_¬¿y
 = 1;

1884 
sds
 
»´1
 = 
	`sd£m±y
();

1885 
sds
 
»´2
 = 
	`sd£m±y
();

1886 
	`lua_pushn
(
lua
);

1887 
	`lua_Ãxt
(
lua
,
idx
-1)) {

1889 ià(
is_¬¿y
 &&

1890 (
	`lua_ty³
(
lua
,-2è!ğ
LUA_TNUMBER
 ||

1891 
	`lua_tÚumb”
(
lua
,-2è!ğ
ex³ùed_šdex
)è
is_¬¿y
 = 0;

1894 
»´1
 = 
	`ldbC©SckV®ueRec
Ô•r1,
lua
,-1,
Ëv–
);

1895 
»´1
 = 
	`sdsÿ’
(repr1,"; ",2);

1897 
»´2
 = 
	`sdsÿ’
(repr2,"[",1);

1898 
»´2
 = 
	`ldbC©SckV®ueRec
Ô•r2,
lua
,-2,
Ëv–
);

1899 
»´2
 = 
	`sdsÿ’
(repr2,"]=",2);

1900 
»´2
 = 
	`ldbC©SckV®ueRec
Ô•r2,
lua
,-1,
Ëv–
);

1901 
»´2
 = 
	`sdsÿ’
(repr2,"; ",2);

1902 
	`lua_pİ
(
lua
,1);

1903 
ex³ùed_šdex
++;

1906 ià(
	`sd¦’
(
»´1
)è
	`sd¤ªge
(repr1,0,-3);

1907 ià(
	`sd¦’
(
»´2
)è
	`sd¤ªge
(repr2,0,-3);

1909 
s
 = 
	`sdsÿ’
(s,"{",1);

1910 
s
 = 
	`sdsÿtsds
(s,
is_¬¿y
 ? 
»´1
 : 
»´2
);

1911 
s
 = 
	`sdsÿ’
(s,"}",1);

1912 
	`sdsä“
(
»´1
);

1913 
	`sdsä“
(
»´2
);

1916 
LUA_TFUNCTION
:

1917 
LUA_TUSERDATA
:

1918 
LUA_TTHREAD
:

1919 
LUA_TLIGHTUSERDATA
:

1921 cÚ¡ *
p
 = 
	`lua_tİoš‹r
(
lua
,
idx
);

1922 *
ty³Çme
 = "unknown";

1923 ià(
t
 =ğ
LUA_TFUNCTION
è
ty³Çme
 = "function";

1924 ià(
t
 =ğ
LUA_TUSERDATA
è
ty³Çme
 = "userdata";

1925 ià(
t
 =ğ
LUA_TTHREAD
è
ty³Çme
 = "thread";

1926 ià(
t
 =ğ
LUA_TLIGHTUSERDATA
è
ty³Çme
 = "light-userdata";

1927 
s
 = 
	`sdsÿrštf
(s,"\"%s@%p\"",
ty³Çme
,
p
);

1931 
s
 = 
	`sdsÿt
(s,"\"<unknown-lua-type>\"");

1934  
s
;

1935 
	}
}

1939 
sds
 
	$ldbC©SckV®ue
(
sds
 
s
, 
lua_S‹
 *
lua
, 
idx
) {

1940  
	`ldbC©SckV®ueRec
(
s
,
lua
,
idx
,0);

1941 
	}
}

1946 
	$ldbLogSckV®ue
(
lua_S‹
 *
lua
, *
´efix
) {

1947 
sds
 
s
 = 
	`sd¢ew
(
´efix
);

1948 
s
 = 
	`ldbC©SckV®ue
(s,
lua
,-1);

1949 
	`ldbLogW™hMaxL’
(
s
);

1950 
	}
}

1952 *
ldbRedisPrÙocŞToHumª_IÁ
(
sds
 *
o
, *
»¶y
);

1953 *
ldbRedisPrÙocŞToHumª_Bulk
(
sds
 *
o
, *
»¶y
);

1954 *
ldbRedisPrÙocŞToHumª_Stus
(
sds
 *
o
, *
»¶y
);

1955 *
ldbRedisPrÙocŞToHumª_MuÉiBulk
(
sds
 *
o
, *
»¶y
);

1962 *
	$ldbRedisPrÙocŞToHumª
(
sds
 *
o
, *
»¶y
) {

1963 *
p
 = 
»¶y
;

1964 *
p
) {

1965 ':': 
p
 = 
	`ldbRedisPrÙocŞToHumª_IÁ
(
o
,
»¶y
); ;

1966 '$': 
p
 = 
	`ldbRedisPrÙocŞToHumª_Bulk
(
o
,
»¶y
); ;

1967 '+': 
p
 = 
	`ldbRedisPrÙocŞToHumª_Stus
(
o
,
»¶y
); ;

1968 '-': 
p
 = 
	`ldbRedisPrÙocŞToHumª_Stus
(
o
,
»¶y
); ;

1969 '*': 
p
 = 
	`ldbRedisPrÙocŞToHumª_MuÉiBulk
(
o
,
»¶y
); ;

1971  
p
;

1972 
	}
}

1977 *
	$ldbRedisPrÙocŞToHumª_IÁ
(
sds
 *
o
, *
»¶y
) {

1978 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

1979 *
o
 = 
	`sdsÿ’
(*o,
»¶y
+1,
p
-reply-1);

1980  
p
+2;

1981 
	}
}

1983 *
	$ldbRedisPrÙocŞToHumª_Bulk
(
sds
 *
o
, *
»¶y
) {

1984 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

1985 
bulkËn
;

1987 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
bulkËn
);

1988 ià(
bulkËn
 == -1) {

1989 *
o
 = 
	`sdsÿ’
(*o,"NULL",4);

1990  
p
+2;

1992 *
o
 = 
	`sdsÿŒ•r
(*o,
p
+2,
bulkËn
);

1993  
p
+2+
bulkËn
+2;

1995 
	}
}

1997 *
	$ldbRedisPrÙocŞToHumª_Stus
(
sds
 *
o
, *
»¶y
) {

1998 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

2000 *
o
 = 
	`sdsÿŒ•r
(*o,
»¶y
,
p
-reply);

2001  
p
+2;

2002 
	}
}

2004 *
	$ldbRedisPrÙocŞToHumª_MuÉiBulk
(
sds
 *
o
, *
»¶y
) {

2005 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

2006 
mbulkËn
;

2007 
j
 = 0;

2009 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
mbulkËn
);

2010 
p
 += 2;

2011 ià(
mbulkËn
 == -1) {

2012 *
o
 = 
	`sdsÿ’
(*o,"NULL",4);

2013  
p
;

2015 *
o
 = 
	`sdsÿ’
(*o,"[",1);

2016 
j
 = 0; j < 
mbulkËn
; j++) {

2017 
p
 = 
	`ldbRedisPrÙocŞToHumª
(
o
,p);

2018 ià(
j
 !ğ
mbulkËn
-1è*
o
 = 
	`sdsÿ’
(*o,",",1);

2020 *
o
 = 
	`sdsÿ’
(*o,"]",1);

2021  
p
;

2022 
	}
}

2027 
	$ldbLogRedisR•ly
(*
»¶y
) {

2028 
sds
 
log
 = 
	`sd¢ew
("<reply> ");

2029 
	`ldbRedisPrÙocŞToHumª
(&
log
,
»¶y
);

2030 
	`ldbLogW™hMaxL’
(
log
);

2031 
	}
}

2036 
	$ldbPršt
(
lua_S‹
 *
lua
, *
v¬Çme
) {

2037 
lua_Debug
 
¬
;

2039 
l
 = 0;

2040 
	`lua_g‘¡ack
(
lua
,
l
,&
¬
) != 0) {

2041 
l
++;

2042 cÚ¡ *
Çme
;

2043 
i
 = 1;

2044 (
Çme
 = 
	`lua_g‘loÿl
(
lua
,&
¬
,
i
)è!ğ
NULL
) {

2045 
i
++;

2046 ià(
	`¡rcmp
(
v¬Çme
,
Çme
) == 0) {

2047 
	`ldbLogSckV®ue
(
lua
,"<value> ");

2048 
	`lua_pİ
(
lua
,1);

2051 
	`lua_pİ
(
lua
,1);

2057 ià(!
	`¡rcmp
(
v¬Çme
,"ARGV") || !strcmp(varname,"KEYS")) {

2058 
	`lua_g‘glob®
(
lua
, 
v¬Çme
);

2059 
	`ldbLogSckV®ue
(
lua
,"<value> ");

2060 
	`lua_pİ
(
lua
,1);

2062 
	`ldbLog
(
	`sd¢ew
("No such variable."));

2064 
	}
}

2068 
	$ldbPrštAÎ
(
lua_S‹
 *
lua
) {

2069 
lua_Debug
 
¬
;

2070 
v¬s
 = 0;

2072 ià(
	`lua_g‘¡ack
(
lua
,0,&
¬
) != 0) {

2073 cÚ¡ *
Çme
;

2074 
i
 = 1;

2075 (
Çme
 = 
	`lua_g‘loÿl
(
lua
,&
¬
,
i
)è!ğ
NULL
) {

2076 
i
++;

2077 ià(!
	`¡r¡r
(
Çme
,"(*temporary)")) {

2078 
sds
 
´efix
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"<v®ue> % ğ",
Çme
);

2079 
	`ldbLogSckV®ue
(
lua
,
´efix
);

2080 
	`sdsä“
(
´efix
);

2081 
v¬s
++;

2083 
	`lua_pİ
(
lua
,1);

2087 ià(
v¬s
 == 0) {

2088 
	`ldbLog
(
	`sd¢ew
("No†ocal variables inhe current context."));

2090 
	}
}

2093 
	$ldbB»ak
(
sds
 *
¬gv
, 
¬gc
) {

2094 ià(
¬gc
 == 1) {

2095 ià(
ldb
.
bpcouÁ
 == 0) {

2096 
	`ldbLog
(
	`sd¢ew
("No breakpoints set. Use 'b <line>'o‡dd one."));

2099 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"%˜b»akpošt £t:",
ldb
.
bpcouÁ
));

2100 
j
;

2101 
j
 = 0; j < 
ldb
.
bpcouÁ
; j++)

2102 
	`ldbLogSourûLše
(
ldb
.
bp
[
j
]);

2105 
j
;

2106 
j
 = 1; j < 
¬gc
; j++) {

2107 *
¬g
 = 
¬gv
[
j
];

2108 
lše
;

2109 ià(!
	`¡ršg2l
(
¬g
,
	`sd¦’
×rg),&
lše
)) {

2110 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"Inv®id‡rgum’t:'%s'",
¬g
));

2112 ià(
lše
 == 0) {

2113 
ldb
.
bpcouÁ
 = 0;

2114 
	`ldbLog
(
	`sd¢ew
("All breakpoints„emoved."));

2115 } ià(
lše
 > 0) {

2116 ià(
ldb
.
bpcouÁ
 =ğ
LDB_BREAKPOINTS_MAX
) {

2117 
	`ldbLog
(
	`sd¢ew
("Too many breakpoints set."));

2118 } ià(
	`ldbAddB»akpošt
(
lše
)) {

2119 
	`ldbLi¡
(
lše
,1);

2121 
	`ldbLog
(
	`sd¢ew
("Wrong†ine‚umber."));

2123 } ià(
lše
 < 0) {

2124 ià(
	`ldbD–B»akpošt
(-
lše
))

2125 
	`ldbLog
(
	`sd¢ew
("Breakpoint„emoved."));

2127 
	`ldbLog
(
	`sd¢ew
("No breakpoint inhe specified†ine."));

2132 
	}
}

2137 
	$ldbEv®
(
lua_S‹
 *
lua
, 
sds
 *
¬gv
, 
¬gc
) {

2139 
sds
 
code
 = 
	`sdsjošsds
(
¬gv
+1,
¬gc
-1," ",1);

2140 
sds
 
ex´
 = 
	`sdsÿtsds
(
	`sd¢ew
("»tuº "),
code
);

2143 ià(
	`luaL_lßdbufãr
(
lua
,
ex´
,
	`sd¦’
(expr),"@ldb_eval")) {

2144 
	`lua_pİ
(
lua
,1);

2146 ià(
	`luaL_lßdbufãr
(
lua
,
code
,
	`sd¦’
(code),"@ldb_eval")) {

2147 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"<”rÜ> %s",
	`lua_to¡ršg
(
lua
,-1)));

2148 
	`lua_pİ
(
lua
,1);

2149 
	`sdsä“
(
code
);

2155 
	`sdsä“
(
code
);

2156 
	`sdsä“
(
ex´
);

2157 ià(
	`lua_pÿÎ
(
lua
,0,1,0)) {

2158 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"<”rÜ> %s",
	`lua_to¡ršg
(
lua
,-1)));

2159 
	`lua_pİ
(
lua
,1);

2162 
	`ldbLogSckV®ue
(
lua
,"<retval> ");

2163 
	`lua_pİ
(
lua
,1);

2164 
	}
}

2170 
	$ldbRedis
(
lua_S‹
 *
lua
, 
sds
 *
¬gv
, 
¬gc
) {

2171 
j
, 
§ved_rc
 = 
£rv”
.
lua_»¶iÿ‹_commªds
;

2173 
	`lua_g‘glob®
(
lua
,"redis");

2174 
	`lua_push¡ršg
(
lua
,"call");

2175 
	`lua_g‘bË
(
lua
,-2);

2176 
j
 = 1; j < 
¬gc
; j++)

2177 
	`lua_pushl¡ršg
(
lua
,
¬gv
[
j
],
	`sd¦’
(argv[j]));

2178 
ldb
.
¡•
 = 1;

2179 
£rv”
.
lua_»¶iÿ‹_commªds
 = 1;

2180 
	`lua_pÿÎ
(
lua
,
¬gc
-1,1,0);

2181 
ldb
.
¡•
 = 0;

2182 
£rv”
.
lua_»¶iÿ‹_commªds
 = 
§ved_rc
;

2183 
	`lua_pİ
(
lua
,2);

2184 
	}
}

2188 
	$ldbT¿û
(
lua_S‹
 *
lua
) {

2189 
lua_Debug
 
¬
;

2190 
Ëv–
 = 0;

2192 
	`lua_g‘¡ack
(
lua
,
Ëv–
,&
¬
)) {

2193 
	`lua_g‘šfo
(
lua
,"SÆ",&
¬
);

2194 if(
	`¡r¡r
(
¬
.
shÜt_¤c
,"u£r_süt"è!ğ
NULL
) {

2195 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"%s %s:",

2196 (
Ëv–
 == 0) ? "In" : "From",

2197 
¬
.
Çme
 ?‡r.name : "top†evel"));

2198 
	`ldbLogSourûLše
(
¬
.
cu¼’še
);

2200 
Ëv–
++;

2202 ià(
Ëv–
 == 0) {

2203 
	`ldbLog
(
	`sd¢ew
("<error> Can't„etrieve Lua stack."));

2205 
	}
}

2209 
	$ldbMaxËn
(
sds
 *
¬gv
, 
¬gc
) {

2210 ià(
¬gc
 == 2) {

2211 
Ãwv®
 = 
	`©oi
(
¬gv
[1]);

2212 
ldb
.
maxËn_hšt_£Á
 = 1;

2213 ià(
Ãwv®
 != 0 &&‚ewval <= 60)‚ewval = 60;

2214 
ldb
.
maxËn
 = 
Ãwv®
;

2216 ià(
ldb
.
maxËn
) {

2217 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"<v®ue>„•l› ¬Œunÿ‹d‡ˆ%d by‹s.",()
ldb
.
maxËn
));

2219 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"<value>„eplies‡re unlimited."));

2221 
	}
}

2226 
	$ldbR•l
(
lua_S‹
 *
lua
) {

2227 
sds
 *
¬gv
;

2228 
¬gc
;

2233 (
¬gv
 = 
	`ldbR•lP¬£Commªd
(&
¬gc
)è=ğ
NULL
) {

2234 
buf
[1024];

2235 
Ä—d
 = 
	`»ad
(
ldb
.
fd
,
buf
,(buf));

2236 ià(
Ä—d
 <= 0) {

2239 
ldb
.
¡•
 = 0;

2240 
ldb
.
bpcouÁ
 = 0;

2241  
C_ERR
;

2243 
ldb
.
cbuf
 = 
	`sdsÿ’
Ödb.cbuf,
buf
,
Ä—d
);

2247 
	`sdsä“
(
ldb
.
cbuf
);

2248 
ldb
.
cbuf
 = 
	`sd£m±y
();

2251 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"h") || !strcasecmp(argv[0],"help")) {

2252 
	`ldbLog
(
	`sd¢ew
("Redis Lua debugger help:"));

2253 
	`ldbLog
(
	`sd¢ew
("[h]elp Showhis help."));

2254 
	`ldbLog
(
	`sd¢ew
("[s]tep Run current†ine‡nd stop‡gain."));

2255 
	`ldbLog
(
	`sd¢ew
("[n]ext Alias for step."));

2256 
	`ldbLog
(
	`sd¢ew
("[c]continue Runill‚ext breakpoint."));

2257 
	`ldbLog
(
	`sd¢ew
("[l]list List source code‡round current†ine."));

2258 
	`ldbLog
(
	`sd¢ew
("[l]list [line] List source code‡round [line]."));

2259 
	`ldbLog
(
	`sd¢ew
("†ine = 0 means: current…osition."));

2260 
	`ldbLog
(
	`sd¢ew
("[l]list [line] [ctx] Inhis form [ctx] specifies how many†ines"));

2261 
	`ldbLog
(
	`sd¢ew
("o show before/after [line]."));

2262 
	`ldbLog
(
	`sd¢ew
("[w]hole List‡ll source code. Alias for 'list 1 1000000'."));

2263 
	`ldbLog
(
	`sd¢ew
("[p]rint Show‡llhe†ocal variables."));

2264 
	`ldbLog
(
	`sd¢ew
("[p]rint <var> Showhe value ofhe specified variable."));

2265 
	`ldbLog
(
	`sd¢ew
(" Can‡lso show global vars KEYS‡nd ARGV."));

2266 
	`ldbLog
(
	`sd¢ew
("[b]reak Show‡ll breakpoints."));

2267 
	`ldbLog
(
	`sd¢ew
("[b]reak <line> Add‡ breakpointohe specified†ine."));

2268 
	`ldbLog
(
	`sd¢ew
("[b]reak -<line> Remove breakpoint fromhe specified†ine."));

2269 
	`ldbLog
(
	`sd¢ew
("[b]reak 0 Remove‡ll breakpoints."));

2270 
	`ldbLog
(
	`sd¢ew
("[t]race Show‡ backtrace."));

2271 
	`ldbLog
(
	`sd¢ew
("[e]eval <code> Execute some Lua code (in‡ different callframe)."));

2272 
	`ldbLog
(
	`sd¢ew
("[r]edis <cmd> Execute‡ Redis command."));

2273 
	`ldbLog
(
	`sd¢ew
("[m]axlen [len] Trim†ogged Redis„eplies‡nd Lua var dumpso†en."));

2274 
	`ldbLog
(
	`sd¢ew
(" Specifying zero‡s <len> means unlimited."));

2275 
	`ldbLog
(
	`sd¢ew
("[a]abort Stopheƒxecution ofhe script. In sync"));

2276 
	`ldbLog
(
	`sd¢ew
(" mode dataset changes will be„etained."));

2277 
	`ldbLog
(
	`sd¢ew
(""));

2278 
	`ldbLog
(
	`sd¢ew
("Debugger functions you can call from Lua scripts:"));

2279 
	`ldbLog
(
	`sd¢ew
("redis.debug() Produce†ogs inhe debugger console."));

2280 
	`ldbLog
(
	`sd¢ew
("redis.breakpoint() Stopƒxecution†ike ifhere was‡ breakpoing."));

2281 
	`ldbLog
(
	`sd¢ew
(" inhe‚ext†ine of code."));

2282 
	`ldbS’dLogs
();

2283 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"s") || !strcasecmp(argv[0],"step") ||

2284 !
	`¡rÿ£cmp
(
¬gv
[0],"n") || !strcasecmp(argv[0],"next")) {

2285 
ldb
.
¡•
 = 1;

2287 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"c") || !strcasecmp(argv[0],"continue")){

2289 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"t") || !strcasecmp(argv[0],"trace")) {

2290 
	`ldbT¿û
(
lua
);

2291 
	`ldbS’dLogs
();

2292 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"m") || !strcasecmp(argv[0],"maxlen")) {

2293 
	`ldbMaxËn
(
¬gv
,
¬gc
);

2294 
	`ldbS’dLogs
();

2295 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"b") || !strcasecmp(argv[0],"break")) {

2296 
	`ldbB»ak
(
¬gv
,
¬gc
);

2297 
	`ldbS’dLogs
();

2298 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"e") || !strcasecmp(argv[0],"eval")) {

2299 
	`ldbEv®
(
lua
,
¬gv
,
¬gc
);

2300 
	`ldbS’dLogs
();

2301 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"a") || !strcasecmp(argv[0],"abort")) {

2302 
	`lua_push¡ršg
(
lua
, "script‡borted for user„equest");

2303 
	`lua_”rÜ
(
lua
);

2304 } ià(
¬gc
 > 1 &&

2305 (!
	`¡rÿ£cmp
(
¬gv
[0],"r") || !strcasecmp(argv[0],"redis"))) {

2306 
	`ldbRedis
(
lua
,
¬gv
,
¬gc
);

2307 
	`ldbS’dLogs
();

2308 } ià((!
	`¡rÿ£cmp
(
¬gv
[0],"p") || !strcasecmp(argv[0],"print"))) {

2309 ià(
¬gc
 == 2)

2310 
	`ldbPršt
(
lua
,
¬gv
[1]);

2312 
	`ldbPrštAÎ
(
lua
);

2313 
	`ldbS’dLogs
();

2314 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"l") || !strcasecmp(argv[0],"list")){

2315 
¬ound
 = 
ldb
.
cu¼’še
, 
ùx
 = 5;

2316 ià(
¬gc
 > 1) {

2317 
num
 = 
	`©oi
(
¬gv
[1]);

2318 ià(
num
 > 0è
¬ound
 =‚um;

2320 ià(
¬gc
 > 2è
ùx
 = 
	`©oi
(
¬gv
[2]);

2321 
	`ldbLi¡
(
¬ound
,
ùx
);

2322 
	`ldbS’dLogs
();

2323 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"w") || !strcasecmp(argv[0],"whole")){

2324 
	`ldbLi¡
(1,1000000);

2325 
	`ldbS’dLogs
();

2327 
	`ldbLog
(
	`sd¢ew
("<error> Unknown Redis Lua debugger command or "

2329 
	`ldbS’dLogs
();

2333 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

2337 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

2338  
C_OK
;

2339 
	}
}

2343 
	$luaLdbLšeHook
(
lua_S‹
 *
lua
, 
lua_Debug
 *
¬
) {

2344 
	`lua_g‘¡ack
(
lua
,0,
¬
);

2345 
	`lua_g‘šfo
(
lua
,"Sl",
¬
);

2346 
ldb
.
cu¼’še
 = 
¬
->currentline;

2348 
bp
 = 
	`ldbIsB»akpošt
(
ldb
.
cu¼’še
è||†db.
luabp
;

2349 
timeout
 = 0;

2352 if(
	`¡r¡r
(
¬
->
shÜt_¤c
,"u£r_süt"è=ğ
NULL
) ;

2355 ià(
¬
->
ev’t
 =ğ
LUA_HOOKCOUNT
 && 
ldb
.
¡•
 =ğ0 && 
bp
 == 0) {

2356 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
£rv”
.
lua_time_¡¬t
;

2357 
m¡ime_t
 
tim–im™
 = 
£rv”
.
lua_time_lim™
 ?

2358 
£rv”
.
lua_time_lim™
 : 5000;

2359 ià(
–­£d
 >ğ
tim–im™
) {

2360 
timeout
 = 1;

2361 
ldb
.
¡•
 = 1;

2367 ià(
ldb
.
¡•
 || 
bp
) {

2368 *
»asÚ
 = "step over";

2369 ià(
bp
è
»asÚ
 = 
ldb
.
luabp
 ? "redis.breakpoint() called" :

2371 ià(
timeout
è
»asÚ
 = "timeout„eached, infinite†oop?";

2372 
ldb
.
¡•
 = 0;

2373 
ldb
.
luabp
 = 0;

2374 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),

2376 
ldb
.
cu¼’še
, 
»asÚ
));

2377 
	`ldbLogSourûLše
(
ldb
.
cu¼’še
);

2378 
	`ldbS’dLogs
();

2379 ià(
	`ldbR•l
(
lua
è=ğ
C_ERR
 && 
timeout
) {

2383 
	`lua_push¡ršg
(
lua
, "timeout during Lua debugging with client closing connection");

2384 
	`lua_”rÜ
(
lua
);

2386 
£rv”
.
lua_time_¡¬t
 = 
	`m¡ime
();

2388 
	}
}

	@sds.c

33 
	~<¡dio.h
>

34 
	~<¡dlib.h
>

35 
	~<¡ršg.h
>

36 
	~<ùy³.h
>

37 
	~<as£¹.h
>

38 
	~"sds.h
"

39 
	~"sd§Îoc.h
"

41 
šlše
 
	$sdsHdrSize
(
ty³
) {

42 
ty³
&
SDS_TYPE_MASK
) {

43 
SDS_TYPE_5
:

44  (
sdshdr5
);

45 
SDS_TYPE_8
:

46  (
sdshdr8
);

47 
SDS_TYPE_16
:

48  (
sdshdr16
);

49 
SDS_TYPE_32
:

50  (
sdshdr32
);

51 
SDS_TYPE_64
:

52  (
sdshdr64
);

55 
	}
}

57 
šlše
 
	$sdsReqTy³
(
size_t
 
¡ršg_size
) {

58 ià(
¡ršg_size
 < 1<<5)

59  
SDS_TYPE_5
;

60 ià(
¡ršg_size
 < 1<<8)

61  
SDS_TYPE_8
;

62 ià(
¡ršg_size
 < 1<<16)

63  
SDS_TYPE_16
;

64 ià(
¡ršg_size
 < 1ll<<32)

65  
SDS_TYPE_32
;

66  
SDS_TYPE_64
;

67 
	}
}

81 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

82 *
sh
;

83 
sds
 
s
;

84 
ty³
 = 
	`sdsReqTy³
(
š™Ën
);

87 ià(
ty³
 =ğ
SDS_TYPE_5
 && 
š™Ën
 =ğ0èty³ = 
SDS_TYPE_8
;

88 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

89 *
å
;

91 
sh
 = 
	`s_m®loc
(
hd¾’
+
š™Ën
+1);

92 ià(!
š™
)

93 
	`mem£t
(
sh
, 0, 
hd¾’
+
š™Ën
+1);

94 ià(
sh
 =ğ
NULL
)  NULL;

95 
s
 = (*)
sh
+
hd¾’
;

96 
å
 = ((*)
s
)-1;

97 
ty³
) {

98 
SDS_TYPE_5
: {

99 *
å
 = 
ty³
 | (
š™Ën
 << 
SDS_TYPE_BITS
);

102 
SDS_TYPE_8
: {

103 
	`SDS_HDR_VAR
(8,
s
);

104 
sh
->
Ën
 = 
š™Ën
;

105 
sh
->
®loc
 = 
š™Ën
;

106 *
å
 = 
ty³
;

109 
SDS_TYPE_16
: {

110 
	`SDS_HDR_VAR
(16,
s
);

111 
sh
->
Ën
 = 
š™Ën
;

112 
sh
->
®loc
 = 
š™Ën
;

113 *
å
 = 
ty³
;

116 
SDS_TYPE_32
: {

117 
	`SDS_HDR_VAR
(32,
s
);

118 
sh
->
Ën
 = 
š™Ën
;

119 
sh
->
®loc
 = 
š™Ën
;

120 *
å
 = 
ty³
;

123 
SDS_TYPE_64
: {

124 
	`SDS_HDR_VAR
(64,
s
);

125 
sh
->
Ën
 = 
š™Ën
;

126 
sh
->
®loc
 = 
š™Ën
;

127 *
å
 = 
ty³
;

131 ià(
š™Ën
 && 
š™
)

132 
	`memıy
(
s
, 
š™
, 
š™Ën
);

133 
s
[
š™Ën
] = '\0';

134  
s
;

135 
	}
}

139 
sds
 
	$sd£m±y
() {

140  
	`sd¢ewËn
("",0);

141 
	}
}

144 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

145 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

146  
	`sd¢ewËn
(
š™
, 
š™Ën
);

147 
	}
}

150 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

151  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

152 
	}
}

155 
	$sdsä“
(
sds
 
s
) {

156 ià(
s
 =ğ
NULL
) ;

157 
	`s_ä“
((*)
s
-
	`sdsHdrSize
(s[-1]));

158 
	}
}

174 
	$sdsupd©–’
(
sds
 
s
) {

175 
»®Ën
 = 
	`¡¾’
(
s
);

176 
	`sds£’
(
s
, 
»®Ën
);

177 
	}
}

183 
	$sdsş—r
(
sds
 
s
) {

184 
	`sds£’
(
s
, 0);

185 
s
[0] = '\0';

186 
	}
}

194 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

195 *
sh
, *
Ãwsh
;

196 
size_t
 
ava
 = 
	`sd§va
(
s
);

197 
size_t
 
Ën
, 
ÃwËn
;

198 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

199 
hd¾’
;

202 ià(
ava
 >ğ
addËn
è 
s
;

204 
Ën
 = 
	`sd¦’
(
s
);

205 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

206 
ÃwËn
 = (
Ën
+
addËn
);

207 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

208 
ÃwËn
 *= 2;

210 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

212 
ty³
 = 
	`sdsReqTy³
(
ÃwËn
);

217 ià(
ty³
 =ğ
SDS_TYPE_5
èty³ = 
SDS_TYPE_8
;

219 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

220 ià(
Şdty³
==
ty³
) {

221 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
ÃwËn
+1);

222 ià(
Ãwsh
 =ğ
NULL
)  NULL;

223 
s
 = (*)
Ãwsh
+
hd¾’
;

227 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
ÃwËn
+1);

228 ià(
Ãwsh
 =ğ
NULL
)  NULL;

229 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

230 
	`s_ä“
(
sh
);

231 
s
 = (*)
Ãwsh
+
hd¾’
;

232 
s
[-1] = 
ty³
;

233 
	`sds£’
(
s
, 
Ën
);

235 
	`sds£Îoc
(
s
, 
ÃwËn
);

236  
s
;

237 
	}
}

245 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

246 *
sh
, *
Ãwsh
;

247 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

248 
hd¾’
;

249 
size_t
 
Ën
 = 
	`sd¦’
(
s
);

250 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

252 
ty³
 = 
	`sdsReqTy³
(
Ën
);

253 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

254 ià(
Şdty³
==
ty³
) {

255 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
Ën
+1);

256 ià(
Ãwsh
 =ğ
NULL
)  NULL;

257 
s
 = (*)
Ãwsh
+
hd¾’
;

259 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
Ën
+1);

260 ià(
Ãwsh
 =ğ
NULL
)  NULL;

261 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

262 
	`s_ä“
(
sh
);

263 
s
 = (*)
Ãwsh
+
hd¾’
;

264 
s
[-1] = 
ty³
;

265 
	`sds£’
(
s
, 
Ën
);

267 
	`sds£Îoc
(
s
, 
Ën
);

268  
s
;

269 
	}
}

278 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

279 
size_t
 
®loc
 = 
	`sd§Îoc
(
s
);

280  
	`sdsHdrSize
(
s
[-1])+
®loc
+1;

281 
	}
}

285 *
	$sdsAÎocPŒ
(
sds
 
s
) {

286  (*è(
s
-
	`sdsHdrSize
(s[-1]));

287 
	}
}

312 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

313 
æags
 = 
s
[-1];

314 
size_t
 
Ën
;

315 
æags
&
SDS_TYPE_MASK
) {

316 
SDS_TYPE_5
: {

317 *
å
 = ((*)
s
)-1;

318 
ŞdËn
 = 
	`SDS_TYPE_5_LEN
(
æags
);

319 
	`as£¹
((
šü
 > 0 && 
ŞdËn
+incr < 32) || (incr < 0 && oldlen >= ()(-incr)));

320 *
å
 = 
SDS_TYPE_5
 | ((
ŞdËn
+
šü
è<< 
SDS_TYPE_BITS
);

321 
Ën
 = 
ŞdËn
+
šü
;

324 
SDS_TYPE_8
: {

325 
	`SDS_HDR_VAR
(8,
s
);

326 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

327 
Ën
 = (
sh
->ËÀ+ğ
šü
);

330 
SDS_TYPE_16
: {

331 
	`SDS_HDR_VAR
(16,
s
);

332 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

333 
Ën
 = (
sh
->ËÀ+ğ
šü
);

336 
SDS_TYPE_32
: {

337 
	`SDS_HDR_VAR
(32,
s
);

338 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= ()incr) || (incr < 0 && sh->len >= ()(-incr)));

339 
Ën
 = (
sh
->ËÀ+ğ
šü
);

342 
SDS_TYPE_64
: {

343 
	`SDS_HDR_VAR
(64,
s
);

344 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >ğ(
ušt64_t
)incr) || (incr < 0 && sh->len >= (uint64_t)(-incr)));

345 
Ën
 = (
sh
->ËÀ+ğ
šü
);

348 : 
Ën
 = 0;

350 
s
[
Ën
] = '\0';

351 
	}
}

358 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

359 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

361 ià(
Ën
 <ğ
cu¾’
è 
s
;

362 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

363 ià(
s
 =ğ
NULL
)  NULL;

366 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

367 
	`sds£’
(
s
, 
Ën
);

368  
s
;

369 
	}
}

376 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

377 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

379 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

380 ià(
s
 =ğ
NULL
)  NULL;

381 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

382 
	`sds£’
(
s
, 
cu¾’
+
Ën
);

383 
s
[
cu¾’
+
Ën
] = '\0';

384  
s
;

385 
	}
}

391 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

392  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

393 
	}
}

399 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

400  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

401 
	}
}

405 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

406 ià(
	`sd§Îoc
(
s
è< 
Ën
) {

407 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
	`sd¦’
(s));

408 ià(
s
 =ğ
NULL
)  NULL;

410 
	`memıy
(
s
, 
t
, 
Ën
);

411 
s
[
Ën
] = '\0';

412 
	`sds£’
(
s
, 
Ën
);

413  
s
;

414 
	}
}

418 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

419  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

420 
	}
}

428 
	#SDS_LLSTR_SIZE
 21

	)

429 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

430 *
p
, 
aux
;

431 
v
;

432 
size_t
 
l
;

436 
v
 = (
v®ue
 < 0) ? -value : value;

437 
p
 = 
s
;

439 *
p
++ = '0'+(
v
%10);

440 
v
 /= 10;

441 } 
v
);

442 ià(
v®ue
 < 0è*
p
++ = '-';

445 
l
 = 
p
-
s
;

446 *
p
 = '\0';

449 
p
--;

450 
s
 < 
p
) {

451 
aux
 = *
s
;

452 *
s
 = *
p
;

453 *
p
 = 
aux
;

454 
s
++;

455 
p
--;

457  
l
;

458 
	}
}

461 
	$sdsuÎ2¡r
(*
s
, 
v
) {

462 *
p
, 
aux
;

463 
size_t
 
l
;

467 
p
 = 
s
;

469 *
p
++ = '0'+(
v
%10);

470 
v
 /= 10;

471 } 
v
);

474 
l
 = 
p
-
s
;

475 *
p
 = '\0';

478 
p
--;

479 
s
 < 
p
) {

480 
aux
 = *
s
;

481 *
s
 = *
p
;

482 *
p
 = 
aux
;

483 
s
++;

484 
p
--;

486  
l
;

487 
	}
}

493 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

494 
buf
[
SDS_LLSTR_SIZE
];

495 
Ën
 = 
	`sd¦l2¡r
(
buf
,
v®ue
);

497  
	`sd¢ewËn
(
buf
,
Ën
);

498 
	}
}

501 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

502 
va_li¡
 
ıy
;

503 
¡©icbuf
[1024], *
buf
 = sticbuf, *
t
;

504 
size_t
 
buæ’
 = 
	`¡¾’
(
fmt
)*2;

508 ià(
buæ’
 > (
¡©icbuf
)) {

509 
buf
 = 
	`s_m®loc
(
buæ’
);

510 ià(
buf
 =ğ
NULL
)  NULL;

512 
buæ’
 = (
¡©icbuf
);

518 
buf
[
buæ’
-2] = '\0';

519 
	`va_cİy
(
ıy
,
­
);

520 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

521 
	`va_’d
(
ıy
);

522 ià(
buf
[
buæ’
-2] != '\0') {

523 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

524 
buæ’
 *= 2;

525 
buf
 = 
	`s_m®loc
(
buæ’
);

526 ià(
buf
 =ğ
NULL
)  NULL;

533 
t
 = 
	`sdsÿt
(
s
, 
buf
);

534 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

535  
t
;

536 
	}
}

554 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

555 
va_li¡
 
­
;

556 *
t
;

557 
	`va_¡¬t
(
­
, 
fmt
);

558 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

559 
	`va_’d
(
­
);

560  
t
;

561 
	}
}

579 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

580 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

581 cÚ¡ *
f
 = 
fmt
;

582 
i
;

583 
va_li¡
 
­
;

585 
	`va_¡¬t
(
­
,
fmt
);

586 
f
 = 
fmt
;

587 
i
 = 
š™Ën
;

588 *
f
) {

589 
Ãxt
, *
¡r
;

590 
size_t
 
l
;

591 
num
;

592 
unum
;

595 ià(
	`sd§va
(
s
)==0) {

596 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

599 *
f
) {

601 
Ãxt
 = *(
f
+1);

602 
f
++;

603 
Ãxt
) {

606 
¡r
 = 
	`va_¬g
(
­
,*);

607 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

608 ià(
	`sd§va
(
s
è< 
l
) {

609 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

611 
	`memıy
(
s
+
i
,
¡r
,
l
);

612 
	`sdsšş’
(
s
,
l
);

613 
i
 +ğ
l
;

617 ià(
Ãxt
 == 'i')

618 
num
 = 
	`va_¬g
(
­
,);

620 
num
 = 
	`va_¬g
(
­
,);

622 
buf
[
SDS_LLSTR_SIZE
];

623 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

624 ià(
	`sd§va
(
s
è< 
l
) {

625 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

627 
	`memıy
(
s
+
i
,
buf
,
l
);

628 
	`sdsšş’
(
s
,
l
);

629 
i
 +ğ
l
;

634 ià(
Ãxt
 == 'u')

635 
unum
 = 
	`va_¬g
(
­
,);

637 
unum
 = 
	`va_¬g
(
­
,);

639 
buf
[
SDS_LLSTR_SIZE
];

640 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

641 ià(
	`sd§va
(
s
è< 
l
) {

642 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

644 
	`memıy
(
s
+
i
,
buf
,
l
);

645 
	`sdsšş’
(
s
,
l
);

646 
i
 +ğ
l
;

650 
s
[
i
++] = 
Ãxt
;

651 
	`sdsšş’
(
s
,1);

656 
s
[
i
++] = *
f
;

657 
	`sdsšş’
(
s
,1);

660 
f
++;

662 
	`va_’d
(
­
);

665 
s
[
i
] = '\0';

666  
s
;

667 
	}
}

683 
sds
 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

684 *
¡¬t
, *
’d
, *
¥
, *
•
;

685 
size_t
 
Ën
;

687 
¥
 = 
¡¬t
 = 
s
;

688 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

689 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

690 
•
 > 
¥
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

691 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

692 ià(
s
 !ğ
¥
è
	`memmove
(s, sp, 
Ën
);

693 
s
[
Ën
] = '\0';

694 
	`sds£’
(
s
,
Ën
);

695  
s
;

696 
	}
}

714 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

715 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

717 ià(
Ën
 == 0) ;

718 ià(
¡¬t
 < 0) {

719 
¡¬t
 = 
Ën
+start;

720 ià(
¡¬t
 < 0) start = 0;

722 ià(
’d
 < 0) {

723 
’d
 = 
Ën
+end;

724 ià(
’d
 < 0)ƒnd = 0;

726 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

727 ià(
ÃwËn
 != 0) {

728 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

729 
ÃwËn
 = 0;

730 } ià(
’d
 >ğ(sigÃd)
Ën
) {

731 
’d
 = 
Ën
-1;

732 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

735 
¡¬t
 = 0;

737 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
s
, s+start,‚ewlen);

738 
s
[
ÃwËn
] = 0;

739 
	`sds£’
(
s
,
ÃwËn
);

740 
	}
}

743 
	$sd¡Şow”
(
sds
 
s
) {

744 
Ën
 = 
	`sd¦’
(
s
), 
j
;

746 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

747 
	}
}

750 
	$sd¡ouµ”
(
sds
 
s
) {

751 
Ën
 = 
	`sd¦’
(
s
), 
j
;

753 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

754 
	}
}

767 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

768 
size_t
 
l1
, 
l2
, 
mšËn
;

769 
cmp
;

771 
l1
 = 
	`sd¦’
(
s1
);

772 
l2
 = 
	`sd¦’
(
s2
);

773 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

774 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

775 ià(
cmp
 =ğ0è 
l1
-
l2
;

776  
cmp
;

777 
	}
}

795 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

796 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

797 
sds
 *
tok’s
;

799 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

801 
tok’s
 = 
	`s_m®loc
((
sds
)*
¦Ùs
);

802 ià(
tok’s
 =ğ
NULL
)  NULL;

804 ià(
Ën
 == 0) {

805 *
couÁ
 = 0;

806  
tok’s
;

808 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

810 ià(
¦Ùs
 < 
–em’ts
+2) {

811 
sds
 *
Ãwtok’s
;

813 
¦Ùs
 *= 2;

814 
Ãwtok’s
 = 
	`s_»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

815 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

816 
tok’s
 = 
Ãwtok’s
;

819 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

820 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

821 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

822 
–em’ts
++;

823 
¡¬t
 = 
j
+
£¶’
;

824 
j
 = j+
£¶’
-1;

828 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

829 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

830 
–em’ts
++;

831 *
couÁ
 = 
–em’ts
;

832  
tok’s
;

834 
ş—nup
:

836 
i
;

837 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

838 
	`s_ä“
(
tok’s
);

839 *
couÁ
 = 0;

840  
NULL
;

842 
	}
}

845 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

846 ià(!
tok’s
) ;

847 
couÁ
--)

848 
	`sdsä“
(
tok’s
[
couÁ
]);

849 
	`s_ä“
(
tok’s
);

850 
	}
}

858 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

859 
s
 = 
	`sdsÿ’
(s,"\"",1);

860 
Ën
--) {

861 *
p
) {

864 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

866 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

867 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

868 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

869 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

870 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

872 ià(
	`i¥ršt
(*
p
))

873 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

875 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

878 
p
++;

880  
	`sdsÿ’
(
s
,"\"",1);

881 
	}
}

885 
	$is_hex_dig™
(
c
) {

886  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

887 (
c
 >= 'A' && c <= 'F');

888 
	}
}

892 
	$hex_dig™_to_št
(
c
) {

893 
c
) {

912 
	}
}

933 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

934 cÚ¡ *
p
 = 
lše
;

935 *
cu¼’t
 = 
NULL
;

936 **
veùÜ
 = 
NULL
;

938 *
¬gc
 = 0;

941 *
p
 && 
	`is¥aû
(*p))…++;

942 ià(*
p
) {

944 
šq
=0;

945 
šsq
=0;

946 
dÚe
=0;

948 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

949 !
dÚe
) {

950 ià(
šq
) {

951 ià(*
p
 == '\\' && *(p+1) == 'x' &&

952 
	`is_hex_dig™
(*(
p
+2)) &&

953 
	`is_hex_dig™
(*(
p
+3)))

955 
by‹
;

957 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

958 
	`hex_dig™_to_št
(*(
p
+3));

959 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

960 
p
 += 3;

961 } ià(*
p
 == '\\' && *(p+1)) {

962 
c
;

964 
p
++;

965 *
p
) {

966 'n': 
c
 = '\n'; ;

967 'r': 
c
 = '\r'; ;

968 't': 
c
 = '\t'; ;

969 'b': 
c
 = '\b'; ;

970 'a': 
c
 = '\a'; ;

971 : 
c
 = *
p
; ;

973 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

974 } ià(*
p
 == '"') {

977 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

978 
dÚe
=1;

979 } ià(!*
p
) {

981 
”r
;

983 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

985 } ià(
šsq
) {

986 ià(*
p
 == '\\' && *(p+1) == '\'') {

987 
p
++;

988 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

989 } ià(*
p
 == '\'') {

992 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

993 
dÚe
=1;

994 } ià(!*
p
) {

996 
”r
;

998 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1001 *
p
) {

1007 
dÚe
=1;

1010 
šq
=1;

1013 
šsq
=1;

1016 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1020 ià(*
p
)…++;

1023 
veùÜ
 = 
	`s_»®loc
(veùÜ,((*
¬gc
)+1)*(*));

1024 
veùÜ
[*
¬gc
] = 
cu¼’t
;

1025 (*
¬gc
)++;

1026 
cu¼’t
 = 
NULL
;

1029 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`s_m®loc
((*));

1030  
veùÜ
;

1034 
”r
:

1035 (*
¬gc
)--)

1036 
	`sdsä“
(
veùÜ
[*
¬gc
]);

1037 
	`s_ä“
(
veùÜ
);

1038 ià(
cu¼’t
è
	`sdsä“
(current);

1039 *
¬gc
 = 0;

1040  
NULL
;

1041 
	}
}

1052 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

1053 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

1055 
j
 = 0; j < 
l
; j++) {

1056 
i
 = 0; i < 
£’
; i++) {

1057 ià(
s
[
j
] =ğ
äom
[
i
]) {

1058 
s
[
j
] = 
to
[
i
];

1063  
s
;

1064 
	}
}

1068 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
) {

1069 
sds
 
još
 = 
	`sd£m±y
();

1070 
j
;

1072 
j
 = 0; j < 
¬gc
; j++) {

1073 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

1074 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿt
(još,
£p
);

1076  
još
;

1077 
	}
}

1080 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

1081 
sds
 
još
 = 
	`sd£m±y
();

1082 
j
;

1084 
j
 = 0; j < 
¬gc
; j++) {

1085 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

1086 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

1088  
još
;

1089 
	}
}

1096 *
	$sds_m®loc
(
size_t
 
size
è{  
	`s_m®loc
(size); 
	}
}

1097 *
	$sds_»®loc
(*
±r
, 
size_t
 
size
è{  
	`s_»®loc
ÕŒ,size); 
	}
}

1098 
	$sds_ä“
(*
±r
è{ 
	`s_ä“
ÕŒ); 
	}
}

1100 #ià
defšed
(
SDS_TEST_MAIN
)

1101 
	~<¡dio.h
>

1102 
	~"‹¡h–p.h
"

1103 
	~"lim™s.h
"

1105 
	#UNUSED
(
x
è()(x)

	)

1106 
	$sdsTe¡
() {

1108 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

1110 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

1111 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

1113 
	`sdsä“
(
x
);

1114 
x
 = 
	`sd¢ewËn
("foo",2);

1115 
	`‹¡_cÚd
("Create‡ string with specified†ength",

1116 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

1118 
x
 = 
	`sdsÿt
(x,"bar");

1119 
	`‹¡_cÚd
("Strings concatenation",

1120 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

1122 
x
 = 
	`sdsıy
(x,"a");

1123 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

1124 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

1126 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

1127 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1128 
	`sd¦’
(
x
) == 33 &&

1129 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1131 
	`sdsä“
(
x
);

1132 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1133 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1134 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) == 0)

1136 
	`sdsä“
(
x
);

1137 
x
 = 
	`sd¢ew
("--");

1138 
x
 = 
	`sdsÿtfmt
(x, "H–lØ% WÜld %I,%I--", "Hi!", 
LLONG_MIN
,
LLONG_MAX
);

1139 
	`‹¡_cÚd
("sdscatfmt() seems working inhe base case",

1140 
	`sd¦’
(
x
) == 60 &&

1141 
	`memcmp
(
x
,"--Hello Hi! World -9223372036854775808,"

1143 
	`´štf
("[%s]\n",
x
);

1145 
	`sdsä“
(
x
);

1146 
x
 = 
	`sd¢ew
("--");

1147 
x
 = 
	`sdsÿtfmt
(x, "%u,%U--", 
UINT_MAX
, 
ULLONG_MAX
);

1148 
	`‹¡_cÚd
("sdscatfmt() seems working with unsigned‚umbers",

1149 
	`sd¦’
(
x
) == 35 &&

1150 
	`memcmp
(
x
,"--4294967295,18446744073709551615--",35) == 0)

1152 
	`sdsä“
(
x
);

1153 
x
 = 
	`sd¢ew
(" x ");

1154 
	`sd¡rim
(
x
," x");

1155 
	`‹¡_cÚd
("sdstrim() works when‡ll chars match",

1156 
	`sd¦’
(
x
) == 0)

1158 
	`sdsä“
(
x
);

1159 
x
 = 
	`sd¢ew
(" x ");

1160 
	`sd¡rim
(
x
," ");

1161 
	`‹¡_cÚd
("sdstrim() works when‡ single char„emains",

1162 
	`sd¦’
(
x
) == 1 && x[0] == 'x')

1164 
	`sdsä“
(
x
);

1165 
x
 = 
	`sd¢ew
("xxciaoyyy");

1166 
	`sd¡rim
(
x
,"xy");

1167 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1168 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1170 
y
 = 
	`sdsdup
(
x
);

1171 
	`sd¤ªge
(
y
,1,1);

1172 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1173 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1175 
	`sdsä“
(
y
);

1176 
y
 = 
	`sdsdup
(
x
);

1177 
	`sd¤ªge
(
y
,1,-1);

1178 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1179 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1181 
	`sdsä“
(
y
);

1182 
y
 = 
	`sdsdup
(
x
);

1183 
	`sd¤ªge
(
y
,-2,-1);

1184 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1185 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1187 
	`sdsä“
(
y
);

1188 
y
 = 
	`sdsdup
(
x
);

1189 
	`sd¤ªge
(
y
,2,1);

1190 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1191 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1193 
	`sdsä“
(
y
);

1194 
y
 = 
	`sdsdup
(
x
);

1195 
	`sd¤ªge
(
y
,1,100);

1196 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1197 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1199 
	`sdsä“
(
y
);

1200 
y
 = 
	`sdsdup
(
x
);

1201 
	`sd¤ªge
(
y
,100,100);

1202 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1203 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1205 
	`sdsä“
(
y
);

1206 
	`sdsä“
(
x
);

1207 
x
 = 
	`sd¢ew
("foo");

1208 
y
 = 
	`sd¢ew
("foa");

1209 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1211 
	`sdsä“
(
y
);

1212 
	`sdsä“
(
x
);

1213 
x
 = 
	`sd¢ew
("bar");

1214 
y
 = 
	`sd¢ew
("bar");

1215 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1217 
	`sdsä“
(
y
);

1218 
	`sdsä“
(
x
);

1219 
x
 = 
	`sd¢ew
("aar");

1220 
y
 = 
	`sd¢ew
("bar");

1221 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1223 
	`sdsä“
(
y
);

1224 
	`sdsä“
(
x
);

1225 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1226 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1227 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1228 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1231 
Şdä“
;

1232 *
p
;

1233 
¡•
 = 10, 
j
, 
i
;

1235 
	`sdsä“
(
x
);

1236 
	`sdsä“
(
y
);

1237 
x
 = 
	`sd¢ew
("0");

1238 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
	`sd¦’
(
x
è=ğ1 && 
	`sd§va
(x) == 0);

1242 
i
 = 0; i < 10; i++) {

1243 
ŞdËn
 = 
	`sd¦’
(
x
);

1244 
x
 = 
	`sdsMakeRoomFÜ
(x,
¡•
);

1245 
ty³
 = 
x
[-1]&
SDS_TYPE_MASK
;

1247 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èËn", 
	`sd¦’
(
x
è=ğ
ŞdËn
);

1248 ià(
ty³
 !ğ
SDS_TYPE_5
) {

1249 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èä“", 
	`sd§va
(
x
è>ğ
¡•
);

1250 
Şdä“
 = 
	`sd§va
(
x
);

1252 
p
 = 
x
+
ŞdËn
;

1253 
j
 = 0; j < 
¡•
; j++) {

1254 
p
[
j
] = 'A'+j;

1256 
	`sdsInüL’
(
x
,
¡•
);

1258 
	`‹¡_cÚd
("sdsMakeRoomFor() content",

1259 
	`memcmp
("0ABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJ",
x
,101) == 0);

1260 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èfš®†’gth",
	`sd¦’
(
x
)==101);

1262 
	`sdsä“
(
x
);

1265 
	`‹¡_»pÜt
()

1267 
	}
}

1270 #ifdeà
SDS_TEST_MAIN


1271 
	$maš
() {

1272  
	`sdsTe¡
();

1273 
	}
}

	@sds.h

33 #iâdeà
__SDS_H


34 
	#__SDS_H


	)

36 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

38 
	~<sys/ty³s.h
>

39 
	~<¡d¬g.h
>

40 
	~<¡dšt.h
>

42 *
	tsds
;

46 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr5
 {

47 
	gæags
;

48 
	gbuf
[];

50 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr8
 {

51 
ušt8_t
 
	gËn
;

52 
ušt8_t
 
	g®loc
;

53 
	gæags
;

54 
	gbuf
[];

56 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr16
 {

57 
ušt16_t
 
	gËn
;

58 
ušt16_t
 
	g®loc
;

59 
	gæags
;

60 
	gbuf
[];

62 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr32
 {

63 
ušt32_t
 
	gËn
;

64 
ušt32_t
 
	g®loc
;

65 
	gæags
;

66 
	gbuf
[];

68 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr64
 {

69 
ušt64_t
 
	gËn
;

70 
ušt64_t
 
	g®loc
;

71 
	gæags
;

72 
	gbuf
[];

75 
	#SDS_TYPE_5
 0

	)

76 
	#SDS_TYPE_8
 1

	)

77 
	#SDS_TYPE_16
 2

	)

78 
	#SDS_TYPE_32
 3

	)

79 
	#SDS_TYPE_64
 4

	)

80 
	#SDS_TYPE_MASK
 7

	)

81 
	#SDS_TYPE_BITS
 3

	)

82 
	#SDS_HDR_VAR
(
T
,
s
è
sdshdr
##T *
sh
 = (*)((s)-((sdshdr##T)));

	)

83 
	#SDS_HDR
(
T
,
s
è((
sdshdr
##T *)((s)-((sdshdr##T))))

	)

84 
	#SDS_TYPE_5_LEN
(
f
è((f)>>
SDS_TYPE_BITS
)

	)

86 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

87 
æags
 = 
s
[-1];

88 
æags
&
SDS_TYPE_MASK
) {

89 
SDS_TYPE_5
:

90  
	`SDS_TYPE_5_LEN
(
æags
);

91 
SDS_TYPE_8
:

92  
	`SDS_HDR
(8,
s
)->
Ën
;

93 
SDS_TYPE_16
:

94  
	`SDS_HDR
(16,
s
)->
Ën
;

95 
SDS_TYPE_32
:

96  
	`SDS_HDR
(32,
s
)->
Ën
;

97 
SDS_TYPE_64
:

98  
	`SDS_HDR
(64,
s
)->
Ën
;

101 
	}
}

103 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

104 
æags
 = 
s
[-1];

105 
æags
&
SDS_TYPE_MASK
) {

106 
SDS_TYPE_5
: {

109 
SDS_TYPE_8
: {

110 
	`SDS_HDR_VAR
(8,
s
);

111  
sh
->
®loc
 - sh->
Ën
;

113 
SDS_TYPE_16
: {

114 
	`SDS_HDR_VAR
(16,
s
);

115  
sh
->
®loc
 - sh->
Ën
;

117 
SDS_TYPE_32
: {

118 
	`SDS_HDR_VAR
(32,
s
);

119  
sh
->
®loc
 - sh->
Ën
;

121 
SDS_TYPE_64
: {

122 
	`SDS_HDR_VAR
(64,
s
);

123  
sh
->
®loc
 - sh->
Ën
;

127 
	}
}

129 
šlše
 
	$sds£’
(
sds
 
s
, 
size_t
 
ÃwËn
) {

130 
æags
 = 
s
[-1];

131 
æags
&
SDS_TYPE_MASK
) {

132 
SDS_TYPE_5
:

134 *
å
 = ((*)
s
)-1;

135 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

138 
SDS_TYPE_8
:

139 
	`SDS_HDR
(8,
s
)->
Ën
 = 
ÃwËn
;

141 
SDS_TYPE_16
:

142 
	`SDS_HDR
(16,
s
)->
Ën
 = 
ÃwËn
;

144 
SDS_TYPE_32
:

145 
	`SDS_HDR
(32,
s
)->
Ën
 = 
ÃwËn
;

147 
SDS_TYPE_64
:

148 
	`SDS_HDR
(64,
s
)->
Ën
 = 
ÃwËn
;

151 
	}
}

153 
šlše
 
	$sdsšş’
(
sds
 
s
, 
size_t
 
šc
) {

154 
æags
 = 
s
[-1];

155 
æags
&
SDS_TYPE_MASK
) {

156 
SDS_TYPE_5
:

158 *
å
 = ((*)
s
)-1;

159 
ÃwËn
 = 
	`SDS_TYPE_5_LEN
(
æags
)+
šc
;

160 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

163 
SDS_TYPE_8
:

164 
	`SDS_HDR
(8,
s
)->
Ën
 +ğ
šc
;

166 
SDS_TYPE_16
:

167 
	`SDS_HDR
(16,
s
)->
Ën
 +ğ
šc
;

169 
SDS_TYPE_32
:

170 
	`SDS_HDR
(32,
s
)->
Ën
 +ğ
šc
;

172 
SDS_TYPE_64
:

173 
	`SDS_HDR
(64,
s
)->
Ën
 +ğ
šc
;

176 
	}
}

179 
šlše
 
size_t
 
	$sd§Îoc
(cÚ¡ 
sds
 
s
) {

180 
æags
 = 
s
[-1];

181 
æags
&
SDS_TYPE_MASK
) {

182 
SDS_TYPE_5
:

183  
	`SDS_TYPE_5_LEN
(
æags
);

184 
SDS_TYPE_8
:

185  
	`SDS_HDR
(8,
s
)->
®loc
;

186 
SDS_TYPE_16
:

187  
	`SDS_HDR
(16,
s
)->
®loc
;

188 
SDS_TYPE_32
:

189  
	`SDS_HDR
(32,
s
)->
®loc
;

190 
SDS_TYPE_64
:

191  
	`SDS_HDR
(64,
s
)->
®loc
;

194 
	}
}

196 
šlše
 
	$sds£Îoc
(
sds
 
s
, 
size_t
 
ÃwËn
) {

197 
æags
 = 
s
[-1];

198 
æags
&
SDS_TYPE_MASK
) {

199 
SDS_TYPE_5
:

202 
SDS_TYPE_8
:

203 
	`SDS_HDR
(8,
s
)->
®loc
 = 
ÃwËn
;

205 
SDS_TYPE_16
:

206 
	`SDS_HDR
(16,
s
)->
®loc
 = 
ÃwËn
;

208 
SDS_TYPE_32
:

209 
	`SDS_HDR
(32,
s
)->
®loc
 = 
ÃwËn
;

211 
SDS_TYPE_64
:

212 
	`SDS_HDR
(64,
s
)->
®loc
 = 
ÃwËn
;

215 
	}
}

217 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

218 
sds
 
sd¢ew
(cÚ¡ *
š™
);

219 
sds
 
sd£m±y
();

220 
sds
 
sdsdup
(cÚ¡ sd 
s
);

221 
sdsä“
(
sds
 
s
);

222 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

223 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

224 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

225 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

226 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

227 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

229 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

230 #ifdeà
__GNUC__


231 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

232 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

234 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

237 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

238 
sds
 
	`sd¡rim
(sd 
s
, cÚ¡ *
c£t
);

239 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

240 
	`sdsupd©–’
(
sds
 
s
);

241 
	`sdsş—r
(
sds
 
s
);

242 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

243 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

244 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

245 
	`sd¡Şow”
(
sds
 
s
);

246 
	`sd¡ouµ”
(
sds
 
s
);

247 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

248 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

249 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

250 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

251 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
);

252 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

255 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

256 
	`sdsInüL’
(
sds
 
s
, 
šü
);

257 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

258 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

259 *
	`sdsAÎocPŒ
(
sds
 
s
);

265 *
	`sds_m®loc
(
size_t
 
size
);

266 *
	`sds_»®loc
(*
±r
, 
size_t
 
size
);

267 
	`sds_ä“
(*
±r
);

269 #ifdeà
REDIS_TEST


270 
	`sdsTe¡
(
¬gc
, *
¬gv
[]);

	@sdsalloc.h

39 
	~"zm®loc.h
"

40 
	#s_m®loc
 
zm®loc


	)

41 
	#s_»®loc
 
z»®loc


	)

42 
	#s_ä“
 
zä“


	)

	@sentinel.c

31 
	~"£rv”.h
"

32 
	~"hœedis.h
"

33 
	~"async.h
"

35 
	~<ùy³.h
>

36 
	~<¬·/š‘.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/wa™.h
>

39 
	~<fú.h
>

41 **
’vœÚ
;

43 
	#REDIS_SENTINEL_PORT
 26379

	)

48 
	s£Áš–Addr
 {

49 *
	m
;

50 
	mpÜt
;

51 } 
	t£Áš–Addr
;

54 
	#SRI_MASTER
 (1<<0)

	)

55 
	#SRI_SLAVE
 (1<<1)

	)

56 
	#SRI_SENTINEL
 (1<<2)

	)

57 
	#SRI_S_DOWN
 (1<<3è

	)

58 
	#SRI_O_DOWN
 (1<<4è

	)

59 
	#SRI_MASTER_DOWN
 (1<<5è

	)

61 
	#SRI_FAILOVER_IN_PROGRESS
 (1<<6è

	)

63 
	#SRI_PROMOTED
 (1<<7è

	)

64 
	#SRI_RECONF_SENT
 (1<<8è

	)

65 
	#SRI_RECONF_INPROG
 (1<<9è

	)

66 
	#SRI_RECONF_DONE
 (1<<10è

	)

67 
	#SRI_FORCE_FAILOVER
 (1<<11è

	)

68 
	#SRI_SCRIPT_KILL_SENT
 (1<<12è

	)

71 
	#SENTINEL_INFO_PERIOD
 10000

	)

72 
	#SENTINEL_PING_PERIOD
 1000

	)

73 
	#SENTINEL_ASK_PERIOD
 1000

	)

74 
	#SENTINEL_PUBLISH_PERIOD
 2000

	)

75 
	#SENTINEL_DEFAULT_DOWN_AFTER
 30000

	)

76 
	#SENTINEL_HELLO_CHANNEL
 "__£Áš–__:h–lo"

	)

77 
	#SENTINEL_TILT_TRIGGER
 2000

	)

78 
	#SENTINEL_TILT_PERIOD
 (
SENTINEL_PING_PERIOD
*30)

	)

79 
	#SENTINEL_DEFAULT_SLAVE_PRIORITY
 100

	)

80 
	#SENTINEL_SLAVE_RECONF_TIMEOUT
 10000

	)

81 
	#SENTINEL_DEFAULT_PARALLEL_SYNCS
 1

	)

82 
	#SENTINEL_MIN_LINK_RECONNECT_PERIOD
 15000

	)

83 
	#SENTINEL_DEFAULT_FAILOVER_TIMEOUT
 (60*3*1000)

	)

84 
	#SENTINEL_MAX_PENDING_COMMANDS
 100

	)

85 
	#SENTINEL_ELECTION_TIMEOUT
 10000

	)

86 
	#SENTINEL_MAX_DESYNC
 1000

	)

89 
	#SENTINEL_FAILOVER_STATE_NONE
 0

	)

90 
	#SENTINEL_FAILOVER_STATE_WAIT_START
 1

	)

91 
	#SENTINEL_FAILOVER_STATE_SELECT_SLAVE
 2

	)

92 
	#SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
 3

	)

93 
	#SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
 4

	)

94 
	#SENTINEL_FAILOVER_STATE_RECONF_SLAVES
 5

	)

95 
	#SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
 6

	)

97 
	#SENTINEL_MASTER_LINK_STATUS_UP
 0

	)

98 
	#SENTINEL_MASTER_LINK_STATUS_DOWN
 1

	)

103 
	#SENTINEL_NO_FLAGS
 0

	)

104 
	#SENTINEL_GENERATE_EVENT
 (1<<16)

	)

105 
	#SENTINEL_LEADER
 (1<<17)

	)

106 
	#SENTINEL_OBSERVER
 (1<<18)

	)

109 
	#SENTINEL_SCRIPT_NONE
 0

	)

110 
	#SENTINEL_SCRIPT_RUNNING
 1

	)

111 
	#SENTINEL_SCRIPT_MAX_QUEUE
 256

	)

112 
	#SENTINEL_SCRIPT_MAX_RUNNING
 16

	)

113 
	#SENTINEL_SCRIPT_MAX_RUNTIME
 60000

	)

114 
	#SENTINEL_SCRIPT_MAX_RETRY
 10

	)

115 
	#SENTINEL_SCRIPT_RETRY_DELAY
 30000

	)

118 
	#SENTINEL_SIMFAILURE_NONE
 0

	)

119 
	#SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION
 (1<<0)

	)

120 
	#SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION
 (1<<1)

	)

136 
	sš¡ªûLšk
 {

137 
	m»fcouÁ
;

138 
	mdiscÚÃùed
;

139 
	m³ndšg_commªds
;

140 
»disAsyncCÚ‹xt
 *
	mcc
;

141 
»disAsyncCÚ‹xt
 *
	mpc
;

142 
m¡ime_t
 
	mcc_cÚn_time
;

143 
m¡ime_t
 
	mpc_cÚn_time
;

144 
m¡ime_t
 
	mpc_Ï¡_aùiv™y
;

145 
m¡ime_t
 
	mÏ¡_ava_time
;

147 
m¡ime_t
 
	maù_pšg_time
;

152 
m¡ime_t
 
	mÏ¡_pšg_time
;

156 
m¡ime_t
 
	mÏ¡_pÚg_time
;

159 
m¡ime_t
 
	mÏ¡_»cÚn_time
;

161 } 
	tš¡ªûLšk
;

163 
	s£Áš–RedisIn¡ªû
 {

164 
	mæags
;

165 *
	mÇme
;

166 *
	mrunid
;

167 
ušt64_t
 
	mcÚfig_•och
;

168 
£Áš–Addr
 *
	maddr
;

169 
š¡ªûLšk
 *
	mlšk
;

170 
m¡ime_t
 
	mÏ¡_pub_time
;

171 
m¡ime_t
 
	mÏ¡_h–lo_time
;

174 
m¡ime_t
 
	mÏ¡_ma¡”_down_»¶y_time
;

176 
m¡ime_t
 
	ms_down_sšû_time
;

177 
m¡ime_t
 
	mo_down_sšû_time
;

178 
m¡ime_t
 
	mdown_aá”_³riod
;

179 
m¡ime_t
 
	mšfo_»äesh
;

186 
	mrŞe_»pÜ‹d
;

187 
m¡ime_t
 
	mrŞe_»pÜ‹d_time
;

188 
m¡ime_t
 
	m¦ave_cÚf_chªge_time
;

191 
diù
 *
	m£Áš–s
;

192 
diù
 *
	m¦aves
;

193 
	mquÜum
;

194 
	m·¿Î–_syncs
;

195 *
	mauth_·ss
;

198 
m¡ime_t
 
	mma¡”_lšk_down_time
;

199 
	m¦ave_´iÜ™y
;

200 
m¡ime_t
 
	m¦ave_»cÚf_£Á_time
;

201 
£Áš–RedisIn¡ªû
 *
	mma¡”
;

202 *
	m¦ave_ma¡”_ho¡
;

203 
	m¦ave_ma¡”_pÜt
;

204 
	m¦ave_ma¡”_lšk_¡©us
;

205 
	m¦ave_»¶_off£t
;

207 *
	mËad”
;

211 
ušt64_t
 
	mËad”_•och
;

212 
ušt64_t
 
	mçov”_•och
;

213 
	mçov”_¡©e
;

214 
m¡ime_t
 
	mçov”_¡©e_chªge_time
;

215 
m¡ime_t
 
	mçov”_¡¬t_time
;

216 
m¡ime_t
 
	mçov”_timeout
;

217 
m¡ime_t
 
	mçov”_d–ay_logged
;

219 
£Áš–RedisIn¡ªû
 *
	m´omÙed_¦ave
;

222 *
	mnÙifiÿtiÚ_süt
;

223 *
	mş›Á_»cÚfig_süt
;

224 
sds
 
	mšfo
;

225 } 
	t£Áš–RedisIn¡ªû
;

228 
	s£Áš–S‹
 {

229 
	mmyid
[
CONFIG_RUN_ID_SIZE
+1];

230 
ušt64_t
 
	mcu¼’t_•och
;

231 
diù
 *
	mma¡”s
;

234 
	mtt
;

235 
	mruÂšg_süts
;

236 
m¡ime_t
 
	mtt_¡¬t_time
;

237 
m¡ime_t
 
	m´evious_time
;

238 
li¡
 *
	msüts_queue
;

239 *
	mªnounû_
;

241 
	mªnounû_pÜt
;

243 
	msimçu»_æags
;

244 } 
	g£Áš–
;

247 
	s£Áš–SütJob
 {

248 
	mæags
;

249 
	m»Œy_num
;

250 **
	m¬gv
;

251 
m¡ime_t
 
	m¡¬t_time
;

256 
pid_t
 
	mpid
;

257 } 
	t£Áš–SütJob
;

264 
	s»disAeEv’ts
 {

265 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

266 
«Ev’tLoİ
 *
	mloİ
;

267 
	mfd
;

268 
	m»adšg
, 
	mwr™šg
;

269 } 
	t»disAeEv’ts
;

271 
	$»disAeR—dEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

272 (()
–
); (()
fd
); (()
mask
);

274 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

275 
	`»disAsyncHªdËR—d
(
e
->
cÚ‹xt
);

276 
	}
}

278 
	$»disAeWr™eEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

279 (()
–
); (()
fd
); (()
mask
);

281 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

282 
	`»disAsyncHªdËWr™e
(
e
->
cÚ‹xt
);

283 
	}
}

285 
	$»disAeAddR—d
(*
´ivd©a
) {

286 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

287 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

288 ià(!
e
->
»adšg
) {

289 
e
->
»adšg
 = 1;

290 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
,
»disAeR—dEv’t
,e);

292 
	}
}

294 
	$»disAeD–R—d
(*
´ivd©a
) {

295 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

296 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

297 ià(
e
->
»adšg
) {

298 
e
->
»adšg
 = 0;

299 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
);

301 
	}
}

303 
	$»disAeAddWr™e
(*
´ivd©a
) {

304 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

305 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

306 ià(!
e
->
wr™šg
) {

307 
e
->
wr™šg
 = 1;

308 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
,
»disAeWr™eEv’t
,e);

310 
	}
}

312 
	$»disAeD–Wr™e
(*
´ivd©a
) {

313 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

314 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

315 ià(
e
->
wr™šg
) {

316 
e
->
wr™šg
 = 0;

317 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
);

319 
	}
}

321 
	$»disAeCËªup
(*
´ivd©a
) {

322 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

323 
	`»disAeD–R—d
(
´ivd©a
);

324 
	`»disAeD–Wr™e
(
´ivd©a
);

325 
	`zä“
(
e
);

326 
	}
}

328 
	$»disAeA‰ach
(
«Ev’tLoİ
 *
loİ
, 
»disAsyncCÚ‹xt
 *
ac
) {

329 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

330 
»disAeEv’ts
 *
e
;

333 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

334  
C_ERR
;

337 
e
 = (
»disAeEv’ts
*)
	`zm®loc
((*e));

338 
e
->
cÚ‹xt
 = 
ac
;

339 
e
->
loİ
 =†oop;

340 
e
->
fd
 = 
c
->fd;

341 
e
->
»adšg
 =ƒ->
wr™šg
 = 0;

344 
ac
->
ev
.
addR—d
 = 
»disAeAddR—d
;

345 
ac
->
ev
.
d–R—d
 = 
»disAeD–R—d
;

346 
ac
->
ev
.
addWr™e
 = 
»disAeAddWr™e
;

347 
ac
->
ev
.
d–Wr™e
 = 
»disAeD–Wr™e
;

348 
ac
->
ev
.
ş—nup
 = 
»disAeCËªup
;

349 
ac
->
ev
.
d©a
 = 
e
;

351  
C_OK
;

352 
	}
}

356 
£Áš–LškE¡ablishedC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
);

357 
£Áš–DiscÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
);

358 
£Áš–ReûiveH–loMes§ges
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
);

359 
£Áš–RedisIn¡ªû
 *
£Áš–G‘Ma¡”ByName
(*
Çme
);

360 *
£Áš–G‘SubjeùiveL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

361 *
£Áš–G‘ObjeùiveL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

362 
ye¢Ùoi
(*
s
);

363 
š¡ªûLškCÚÃùiÚE¼Ü
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
);

364 cÚ¡ *
£Áš–RedisIn¡ªûTy³SŒ
(
£Áš–RedisIn¡ªû
 *
ri
);

365 
£Áš–AbÜtFaov”
(
£Áš–RedisIn¡ªû
 *
ri
);

366 
£Áš–Ev’t
(
Ëv–
, *
ty³
, 
£Áš–RedisIn¡ªû
 *
ri
, cÚ¡ *
fmt
, ...);

367 
£Áš–RedisIn¡ªû
 *
£Áš–S–eùSÏve
(£Áš–RedisIn¡ªû *
ma¡”
);

368 
£Áš–ScheduËSütExecutiÚ
(*
·th
, ...);

369 
£Áš–S¹Faov”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

370 
£Áš–DisÿrdR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
);

371 
£Áš–S’dSÏveOf
(
£Áš–RedisIn¡ªû
 *
ri
, *
ho¡
, 
pÜt
);

372 *
£Áš–VÙeL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
»q_•och
, *
»q_runid
, ušt64_ˆ*
Ëad”_•och
);

373 
£Áš–FlushCÚfig
();

374 
£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
();

375 
£Áš–S’dPšg
(
£Áš–RedisIn¡ªû
 *
ri
);

376 
£Áš–FÜûH–loUpd©eFÜMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

377 
£Áš–RedisIn¡ªû
 *
g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
diù
 *
š¡ªûs
, *

, 
pÜt
, *
runid
);

378 
£Áš–SimFau»C¿sh
();

382 
diùSdsHash
(cÚ¡ *
key
);

383 
diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

384 
»Ëa£S’tš–RedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
);

386 
	$diùIn¡ªûsV®De¡ruùÜ
 (*
´ivd©a
, *
obj
) {

387 
	`UNUSED
(
´ivd©a
);

388 
	`»Ëa£S’tš–RedisIn¡ªû
(
obj
);

389 
	}
}

395 
diùTy³
 
	gš¡ªûsDiùTy³
 = {

396 
diùSdsHash
,

397 
NULL
,

398 
NULL
,

399 
diùSdsKeyCom·»
,

400 
NULL
,

401 
diùIn¡ªûsV®De¡ruùÜ


408 
diùTy³
 
	gËad”VÙesDiùTy³
 = {

409 
diùSdsHash
,

410 
NULL
,

411 
NULL
,

412 
diùSdsKeyCom·»
,

413 
NULL
,

414 
NULL


419 
£Áš–Commªd
(
ş›Á
 *
c
);

420 
£Áš–InfoCommªd
(
ş›Á
 *
c
);

421 
£Áš–S‘Commªd
(
ş›Á
 *
c
);

422 
£Áš–PublishCommªd
(
ş›Á
 *
c
);

423 
£Áš–RŞeCommªd
(
ş›Á
 *
c
);

425 
»disCommªd
 
	g£Áš–cmds
[] = {

426 {"pšg",
pšgCommªd
,1,"",0,
NULL
,0,0,0,0,0},

427 {"£Áš–",
£Áš–Commªd
,-2,"",0,
NULL
,0,0,0,0,0},

428 {"subsüibe",
subsüibeCommªd
,-2,"",0,
NULL
,0,0,0,0,0},

429 {"unsubsüibe",
unsubsüibeCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

430 {"psubsüibe",
psubsüibeCommªd
,-2,"",0,
NULL
,0,0,0,0,0},

431 {"punsubsüibe",
punsubsüibeCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

432 {"publish",
£Áš–PublishCommªd
,3,"",0,
NULL
,0,0,0,0,0},

433 {"šfo",
£Áš–InfoCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

434 {"rŞe",
£Áš–RŞeCommªd
,1,"l",0,
NULL
,0,0,0,0,0},

435 {"ş›Á",
ş›ÁCommªd
,-2,"rs",0,
NULL
,0,0,0,0,0},

436 {"shutdown",
shutdownCommªd
,-1,"",0,
NULL
,0,0,0,0,0}

441 
	$š™S’tš–CÚfig
() {

442 
£rv”
.
pÜt
 = 
REDIS_SENTINEL_PORT
;

443 
	}
}

446 
	$š™S’tš–
() {

447 
j
;

451 
	`diùEm±y
(
£rv”
.
commªds
,
NULL
);

452 
j
 = 0; j < (
£Áš–cmds
)/(sentinelcmds[0]); j++) {

453 
»tv®
;

454 
»disCommªd
 *
cmd
 = 
£Áš–cmds
+
j
;

456 
»tv®
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
cmd
->
Çme
), cmd);

457 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

461 
£Áš–
.
cu¼’t_•och
 = 0;

462 
£Áš–
.
ma¡”s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

463 
£Áš–
.
tt
 = 0;

464 
£Áš–
.
tt_¡¬t_time
 = 0;

465 
£Áš–
.
´evious_time
 = 
	`m¡ime
();

466 
£Áš–
.
ruÂšg_süts
 = 0;

467 
£Áš–
.
süts_queue
 = 
	`li¡C»©e
();

468 
£Áš–
.
ªnounû_
 = 
NULL
;

469 
£Áš–
.
ªnounû_pÜt
 = 0;

470 
£Áš–
.
simçu»_æags
 = 
SENTINEL_SIMFAILURE_NONE
;

471 
	`mem£t
(
£Áš–
.
myid
,0,(sentinel.myid));

472 
	}
}

476 
	$£Áš–IsRuÂšg
() {

477 
j
;

479 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

480 
	`£rv”Log
(
LL_WARNING
,

482 
	`ex™
(1);

483 } ià(
	`acûss
(
£rv”
.
cÚfigfe
,
W_OK
) == -1) {

484 
	`£rv”Log
(
LL_WARNING
,

486 
£rv”
.
cÚfigfe
,
	`¡»¼Ü
(
”ºo
));

487 
	`ex™
(1);

493 
j
 = 0; j < 
CONFIG_RUN_ID_SIZE
; j++)

494 ià(
£Áš–
.
myid
[
j
] != 0) ;

496 ià(
j
 =ğ
CONFIG_RUN_ID_SIZE
) {

498 
	`g‘RªdomHexCh¬s
(
£Áš–
.
myid
,
CONFIG_RUN_ID_SIZE
);

499 
	`£Áš–FlushCÚfig
();

503 
	`£rv”Log
(
LL_WARNING
,"S’tš– ID i %s", 
£Áš–
.
myid
);

507 
	`£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
();

508 
	}
}

517 
£Áš–Addr
 *
	$ü—‹S’tš–Addr
(*
ho¡Çme
, 
pÜt
) {

518 

[
NET_IP_STR_LEN
];

519 
£Áš–Addr
 *
§
;

521 ià(
pÜt
 < 0 ||…ort > 65535) {

522 
”ºo
 = 
EINVAL
;

523  
NULL
;

525 ià(
	`ª‘ResŞve
(
NULL
,
ho¡Çme
,

,()è=ğ
ANET_ERR
) {

526 
”ºo
 = 
ENOENT
;

527  
NULL
;

529 
§
 = 
	`zm®loc
((*sa));

530 
§
->

 = 
	`sd¢ew
(ip);

531 
§
->
pÜt
 =…ort;

532  
§
;

533 
	}
}

536 
£Áš–Addr
 *
	$dupS’tš–Addr
(
£Áš–Addr
 *
¤c
) {

537 
£Áš–Addr
 *
§
;

539 
§
 = 
	`zm®loc
((*sa));

540 
§
->

 = 
	`sd¢ew
(
¤c
->ip);

541 
§
->
pÜt
 = 
¤c
->port;

542  
§
;

543 
	}
}

546 
	$»Ëa£S’tš–Addr
(
£Áš–Addr
 *
§
) {

547 
	`sdsä“
(
§
->

);

548 
	`zä“
(
§
);

549 
	}
}

552 
	$£Áš–AddrIsEqu®
(
£Áš–Addr
 *
a
, s’tš–Add¸*
b
) {

553  
a
->
pÜt
 =ğ
b
->pÜˆ&& !
	`¡rÿ£cmp
×->

,b->ip);

554 
	}
}

582 
	$£Áš–Ev’t
(
Ëv–
, *
ty³
, 
£Áš–RedisIn¡ªû
 *
ri
,

583 cÚ¡ *
fmt
, ...) {

584 
va_li¡
 
­
;

585 
msg
[
LOG_MAX_LEN
];

586 
robj
 *
chªÃl
, *
·ylßd
;

589 ià(
fmt
[0] == '%' && fmt[1] == '@') {

590 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?

591 
NULL
 : 
ri
->
ma¡”
;

593 ià(
ma¡”
) {

594 
	`¢´štf
(
msg
, (msg), "%s %s %s %d @ %s %s %d",

595 
	`£Áš–RedisIn¡ªûTy³SŒ
(
ri
),

596 
ri
->
Çme
,„i->
addr
->

,„i->addr->
pÜt
,

597 
ma¡”
->
Çme
, ma¡”->
addr
->

, ma¡”->addr->
pÜt
);

599 
	`¢´štf
(
msg
, (msg), "%s %s %s %d",

600 
	`£Áš–RedisIn¡ªûTy³SŒ
(
ri
),

601 
ri
->
Çme
,„i->
addr
->

,„i->addr->
pÜt
);

603 
fmt
 += 2;

605 
msg
[0] = '\0';

609 ià(
fmt
[0] != '\0') {

610 
	`va_¡¬t
(
­
, 
fmt
);

611 
	`v¢´štf
(
msg
+
	`¡¾’
(msg), (msg)-¡¾’(msg), 
fmt
, 
­
);

612 
	`va_’d
(
­
);

616 ià(
Ëv–
 >ğ
£rv”
.
v”bos™y
)

617 
	`£rv”Log
(
Ëv–
,"% %s",
ty³
,
msg
);

620 ià(
Ëv–
 !ğ
LL_DEBUG
) {

621 
chªÃl
 = 
	`ü—‹SŒšgObjeù
(
ty³
,
	`¡¾’
(type));

622 
·ylßd
 = 
	`ü—‹SŒšgObjeù
(
msg
,
	`¡¾’
(msg));

623 
	`pubsubPublishMes§ge
(
chªÃl
,
·ylßd
);

624 
	`deüRefCouÁ
(
chªÃl
);

625 
	`deüRefCouÁ
(
·ylßd
);

629 ià(
Ëv–
 =ğ
LL_WARNING
 && 
ri
 !ğ
NULL
) {

630 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?

631 
ri
 :„i->
ma¡”
;

632 ià(
ma¡”
 && ma¡”->
nÙifiÿtiÚ_süt
) {

633 
	`£Áš–ScheduËSütExecutiÚ
(
ma¡”
->
nÙifiÿtiÚ_süt
,

634 
ty³
,
msg
,
NULL
);

637 
	}
}

643 
	$£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
() {

644 
diùI‹¿tÜ
 *
di
;

645 
diùEÁry
 *
de
;

647 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

648 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

649 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

650 
	`£Áš–Ev’t
(
LL_WARNING
,"+mÚ™Ü",
ri
,"%@ quÜum %d",ri->
quÜum
);

652 
	`diùR–—£I‹¿tÜ
(
di
);

653 
	}
}

658 
	$£Áš–R–—£SütJob
(
£Áš–SütJob
 *
sj
) {

659 
j
 = 0;

661 
sj
->
¬gv
[
j
]è
	`sdsä“
(sj->argv[j++]);

662 
	`zä“
(
sj
->
¬gv
);

663 
	`zä“
(
sj
);

664 
	}
}

666 
	#SENTINEL_SCRIPT_MAX_ARGS
 16

	)

667 
	$£Áš–ScheduËSütExecutiÚ
(*
·th
, ...) {

668 
va_li¡
 
­
;

669 *
¬gv
[
SENTINEL_SCRIPT_MAX_ARGS
+1];

670 
¬gc
 = 1;

671 
£Áš–SütJob
 *
sj
;

673 
	`va_¡¬t
(
­
, 
·th
);

674 
¬gc
 < 
SENTINEL_SCRIPT_MAX_ARGS
) {

675 
¬gv
[
¬gc
] = 
	`va_¬g
(
­
,*);

676 ià(!
¬gv
[
¬gc
]) ;

677 
¬gv
[
¬gc
] = 
	`sd¢ew
(argv[argc]);

678 
¬gc
++;

680 
	`va_’d
(
­
);

681 
¬gv
[0] = 
	`sd¢ew
(
·th
);

683 
sj
 = 
	`zm®loc
((*sj));

684 
sj
->
æags
 = 
SENTINEL_SCRIPT_NONE
;

685 
sj
->
»Œy_num
 = 0;

686 
sj
->
¬gv
 = 
	`zm®loc
((*)*(
¬gc
+1));

687 
sj
->
¡¬t_time
 = 0;

688 
sj
->
pid
 = 0;

689 
	`memıy
(
sj
->
¬gv
,¬gv,(*)*(
¬gc
+1));

691 
	`li¡AddNodeTa
(
£Áš–
.
süts_queue
,
sj
);

694 ià(
	`li¡L’gth
(
£Áš–
.
süts_queue
è> 
SENTINEL_SCRIPT_MAX_QUEUE
) {

695 
li¡Node
 *
Ê
;

696 
li¡I‹r
 
li
;

698 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

699 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

700 
sj
 = 
Ê
->
v®ue
;

702 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ;

704 
	`li¡D–Node
(
£Áš–
.
süts_queue
,
Ê
);

705 
	`£Áš–R–—£SütJob
(
sj
);

708 
	`£rv”As£¹
(
	`li¡L’gth
(
£Áš–
.
süts_queue
) <=

709 
SENTINEL_SCRIPT_MAX_QUEUE
);

711 
	}
}

715 
li¡Node
 *
	$£Áš–G‘SütLi¡NodeByPid
(
pid_t
 
pid
) {

716 
li¡Node
 *
Ê
;

717 
li¡I‹r
 
li
;

719 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

720 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

721 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

723 ià((
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
è&& sj->
pid
 ==…id)

724  
Ê
;

726  
NULL
;

727 
	}
}

731 
	$£Áš–RunP’dšgSüts
() {

732 
li¡Node
 *
Ê
;

733 
li¡I‹r
 
li
;

734 
m¡ime_t
 
now
 = 
	`m¡ime
();

738 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

739 
£Áš–
.
ruÂšg_süts
 < 
SENTINEL_SCRIPT_MAX_RUNNING
 &&

740 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
)

742 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

743 
pid_t
 
pid
;

746 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ;

749 ià(
sj
->
¡¬t_time
 && sj->¡¬t_tim> 
now
) ;

751 
sj
->
æags
 |ğ
SENTINEL_SCRIPT_RUNNING
;

752 
sj
->
¡¬t_time
 = 
	`m¡ime
();

753 
sj
->
»Œy_num
++;

754 
pid
 = 
	`fÜk
();

756 ià(
pid
 == -1) {

760 
	`£Áš–Ev’t
(
LL_WARNING
,"-süt-”rÜ",
NULL
,

761 "% %d %d", 
sj
->
¬gv
[0], 99, 0);

762 
sj
->
æags
 &ğ~
SENTINEL_SCRIPT_RUNNING
;

763 
sj
->
pid
 = 0;

764 } ià(
pid
 == 0) {

766 
	`execve
(
sj
->
¬gv
[0],sj->¬gv,
’vœÚ
);

768 
	`_ex™
(2);

770 
£Áš–
.
ruÂšg_süts
++;

771 
sj
->
pid
 =…id;

772 
	`£Áš–Ev’t
(
LL_DEBUG
,"+süt-chd",
NULL
,"%ld",()
pid
);

775 
	}
}

784 
m¡ime_t
 
	$£Áš–SütR‘ryD–ay
(
»Œy_num
) {

785 
m¡ime_t
 
d–ay
 = 
SENTINEL_SCRIPT_RETRY_DELAY
;

787 
»Œy_num
-- > 1è
d–ay
 *= 2;

788  
d–ay
;

789 
	}
}

795 
	$£Áš–CŞËùT”mš©edSüts
() {

796 
¡©loc
;

797 
pid_t
 
pid
;

799 (
pid
 = 
	`wa™3
(&
¡©loc
,
WNOHANG
,
NULL
)) > 0) {

800 
ex™code
 = 
	`WEXITSTATUS
(
¡©loc
);

801 
bysigÇl
 = 0;

802 
li¡Node
 *
Ê
;

803 
£Áš–SütJob
 *
sj
;

805 ià(
	`WIFSIGNALED
(
¡©loc
)è
bysigÇl
 = 
	`WTERMSIG
(statloc);

806 
	`£Áš–Ev’t
(
LL_DEBUG
,"-süt-chd",
NULL
,"%ld %d %d",

807 ()
pid
, 
ex™code
, 
bysigÇl
);

809 
Ê
 = 
	`£Áš–G‘SütLi¡NodeByPid
(
pid
);

810 ià(
Ê
 =ğ
NULL
) {

811 
	`£rv”Log
(
LL_WARNING
,"wa™3(è»tuºed‡…id (%ldèwÿn'ˆfšd iÀou¸süt executiÚ queue!", ()
pid
);

814 
sj
 = 
Ê
->
v®ue
;

819 ià((
bysigÇl
 || 
ex™code
 == 1) &&

820 
sj
->
»Œy_num
 !ğ
SENTINEL_SCRIPT_MAX_RETRY
)

822 
sj
->
æags
 &ğ~
SENTINEL_SCRIPT_RUNNING
;

823 
sj
->
pid
 = 0;

824 
sj
->
¡¬t_time
 = 
	`m¡ime
() +

825 
	`£Áš–SütR‘ryD–ay
(
sj
->
»Œy_num
);

829 ià(
bysigÇl
 || 
ex™code
 != 0) {

830 
	`£Áš–Ev’t
(
LL_WARNING
,"-süt-”rÜ",
NULL
,

831 "% %d %d", 
sj
->
¬gv
[0], 
bysigÇl
, 
ex™code
);

833 
	`li¡D–Node
(
£Áš–
.
süts_queue
,
Ê
);

834 
	`£Áš–R–—£SütJob
(
sj
);

835 
£Áš–
.
ruÂšg_süts
--;

838 
	}
}

842 
	$£Áš–KlTimedoutSüts
() {

843 
li¡Node
 *
Ê
;

844 
li¡I‹r
 
li
;

845 
m¡ime_t
 
now
 = 
	`m¡ime
();

847 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

848 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

849 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

851 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
 &&

852 (
now
 - 
sj
->
¡¬t_time
è> 
SENTINEL_SCRIPT_MAX_RUNTIME
)

854 
	`£Áš–Ev’t
(
LL_WARNING
,"-süt-timeout",
NULL
,"%s %ld",

855 
sj
->
¬gv
[0], ()sj->
pid
);

856 
	`kl
(
sj
->
pid
,
SIGKILL
);

859 
	}
}

862 
	$£Áš–P’dšgSütsCommªd
(
ş›Á
 *
c
) {

863 
li¡Node
 *
Ê
;

864 
li¡I‹r
 
li
;

866 
	`addR•lyMuÉiBulkL’
(
c
,
	`li¡L’gth
(
£Áš–
.
süts_queue
));

867 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

868 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

869 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

870 
j
 = 0;

872 
	`addR•lyMuÉiBulkL’
(
c
,10);

874 
	`addR•lyBulkCSŒšg
(
c
,"argv");

875 
sj
->
¬gv
[
j
]) j++;

876 
	`addR•lyMuÉiBulkL’
(
c
,
j
);

877 
j
 = 0;

878 
sj
->
¬gv
[
j
]è
	`addR•lyBulkCSŒšg
(
c
,sj->argv[j++]);

880 
	`addR•lyBulkCSŒšg
(
c
,"flags");

881 
	`addR•lyBulkCSŒšg
(
c
,

882 (
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ? "running" : "scheduled");

884 
	`addR•lyBulkCSŒšg
(
c
,"pid");

885 
	`addR•lyBulkLÚgLÚg
(
c
,
sj
->
pid
);

887 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) {

888 
	`addR•lyBulkCSŒšg
(
c
,"run-time");

889 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
sj
->
¡¬t_time
);

891 
m¡ime_t
 
d–ay
 = 
sj
->
¡¬t_time
 ? (sj->¡¬t_time-
	`m¡ime
()) : 0;

892 ià(
d–ay
 < 0) delay = 0;

893 
	`addR•lyBulkCSŒšg
(
c
,"run-delay");

894 
	`addR•lyBulkLÚgLÚg
(
c
,
d–ay
);

897 
	`addR•lyBulkCSŒšg
(
c
,"retry-num");

898 
	`addR•lyBulkLÚgLÚg
(
c
,
sj
->
»Œy_num
);

900 
	}
}

914 
	$£Áš–C®lCl›ÁRecÚfSüt
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
rŞe
, *
¡©e
, 
£Áš–Addr
 *
äom
, s’tš–Add¸*
to
) {

915 
äompÜt
[32], 
tİÜt
[32];

917 ià(
ma¡”
->
ş›Á_»cÚfig_süt
 =ğ
NULL
) ;

918 
	`Î2¡ršg
(
äompÜt
,(äompÜt),
äom
->
pÜt
);

919 
	`Î2¡ršg
(
tİÜt
,ÑİÜt),
to
->
pÜt
);

920 
	`£Áš–ScheduËSütExecutiÚ
(
ma¡”
->
ş›Á_»cÚfig_süt
,

921 
ma¡”
->
Çme
,

922 (
rŞe
 =ğ
SENTINEL_LEADER
) ? "leader" : "observer",

923 
¡©e
, 
äom
->

, 
äompÜt
, 
to
->, 
tİÜt
, 
NULL
);

924 
	}
}

929 
š¡ªûLšk
 *
	$ü—‹In¡ªûLšk
() {

930 
š¡ªûLšk
 *
lšk
 = 
	`zm®loc
((*link));

932 
lšk
->
»fcouÁ
 = 1;

933 
lšk
->
discÚÃùed
 = 1;

934 
lšk
->
³ndšg_commªds
 = 0;

935 
lšk
->
cc
 = 
NULL
;

936 
lšk
->
pc
 = 
NULL
;

937 
lšk
->
cc_cÚn_time
 = 0;

938 
lšk
->
pc_cÚn_time
 = 0;

939 
lšk
->
Ï¡_»cÚn_time
 = 0;

940 
lšk
->
pc_Ï¡_aùiv™y
 = 0;

945 
lšk
->
aù_pšg_time
 = 
	`m¡ime
();

946 
lšk
->
Ï¡_pšg_time
 = 0;

947 
lšk
->
Ï¡_ava_time
 = 
	`m¡ime
();

948 
lšk
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

949  
lšk
;

950 
	}
}

953 
	$š¡ªûLškClo£CÚÃùiÚ
(
š¡ªûLšk
 *
lšk
, 
»disAsyncCÚ‹xt
 *
c
) {

954 ià(
c
 =ğ
NULL
) ;

956 ià(
lšk
->
cc
 =ğ
c
) {

957 
lšk
->
cc
 = 
NULL
;

958 
lšk
->
³ndšg_commªds
 = 0;

960 ià(
lšk
->
pc
 =ğ
c
èlšk->pøğ
NULL
;

961 
c
->
d©a
 = 
NULL
;

962 
lšk
->
discÚÃùed
 = 1;

963 
	`»disAsyncF»e
(
c
);

964 
	}
}

974 
š¡ªûLšk
 *
	$»Ëa£In¡ªûLšk
(
š¡ªûLšk
 *
lšk
, 
£Áš–RedisIn¡ªû
 *
ri
)

976 
	`£rv”As£¹
(
lšk
->
»fcouÁ
 > 0);

977 
lšk
->
»fcouÁ
--;

978 ià(
lšk
->
»fcouÁ
 != 0) {

979 ià(
ri
 &&„i->
lšk
->
cc
) {

985 
»disC®lback
 *
cb
;

986 
»disC®lbackLi¡
 *
ÿÎbacks
 = &
lšk
->
cc
->
»¶›s
;

988 
cb
 = 
ÿÎbacks
->
h—d
;

989 
cb
) {

990 ià(
cb
->
´ivd©a
 =ğ
ri
) {

991 
cb
->
â
 = 
£Áš–DisÿrdR•lyC®lback
;

992 
cb
->
´ivd©a
 = 
NULL
;

994 
cb
 = cb->
Ãxt
;

997  
lšk
;

1000 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
cc
);

1001 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
pc
);

1002 
	`zä“
(
lšk
);

1003  
NULL
;

1004 
	}
}

1018 
	$£Áš–TryCÚÃùiÚSh¬šg
(
£Áš–RedisIn¡ªû
 *
ri
) {

1019 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_SENTINEL
);

1020 
diùI‹¿tÜ
 *
di
;

1021 
diùEÁry
 *
de
;

1023 ià(
ri
->
runid
 =ğ
NULL
è 
C_ERR
;

1024 ià(
ri
->
lšk
->
»fcouÁ
 > 1è 
C_ERR
;

1026 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1027 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1028 
£Áš–RedisIn¡ªû
 *
ma¡”
 = 
	`diùG‘V®
(
de
), *
m©ch
;

1031 ià(
ma¡”
 =ğ
ri
->master) ;

1032 
m©ch
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
ma¡”
->
£Áš–s
,

1033 
NULL
,0,
ri
->
runid
);

1034 ià(
m©ch
 =ğ
NULL
) ;

1035 ià(
m©ch
 =ğ
ri
) ;

1039 
	`»Ëa£In¡ªûLšk
(
ri
->
lšk
,
NULL
);

1040 
ri
->
lšk
 = 
m©ch
->link;

1041 
m©ch
->
lšk
->
»fcouÁ
++;

1042  
C_OK
;

1044 
	`diùR–—£I‹¿tÜ
(
di
);

1045  
C_ERR
;

1046 
	}
}

1054 
	$£Áš–Upd©eS’tš–Add»ssInAÎMa¡”s
(
£Áš–RedisIn¡ªû
 *
ri
) {

1055 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_SENTINEL
);

1056 
diùI‹¿tÜ
 *
di
;

1057 
diùEÁry
 *
de
;

1058 
»cÚfigu»d
 = 0;

1060 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1061 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1062 
£Áš–RedisIn¡ªû
 *
ma¡”
 = 
	`diùG‘V®
(
de
), *
m©ch
;

1063 
m©ch
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
ma¡”
->
£Áš–s
,

1064 
NULL
,0,
ri
->
runid
);

1067 ià(
m©ch
 =ğ
NULL
) ;

1070 ià(
m©ch
->
lšk
->
cc
 !ğ
NULL
)

1071 
	`š¡ªûLškClo£CÚÃùiÚ
(
m©ch
->
lšk
,m©ch->lšk->
cc
);

1072 ià(
m©ch
->
lšk
->
pc
 !ğ
NULL
)

1073 
	`š¡ªûLškClo£CÚÃùiÚ
(
m©ch
->
lšk
,m©ch->lšk->
pc
);

1075 ià(
m©ch
 =ğ
ri
) ;

1079 
	`»Ëa£S’tš–Addr
(
m©ch
->
addr
);

1080 
m©ch
->
addr
 = 
	`dupS’tš–Addr
(
ri
->addr);

1081 
»cÚfigu»d
++;

1083 
	`diùR–—£I‹¿tÜ
(
di
);

1084 ià(
»cÚfigu»d
)

1085 
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–-add»ss-upd©e", 
ri
,

1086 "%@ %d‡dd™iÚ® m©chšg in¡ªûs", 
»cÚfigu»d
);

1087  
»cÚfigu»d
;

1088 
	}
}

1096 
	$š¡ªûLškCÚÃùiÚE¼Ü
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
) {

1097 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

1098 
pubsub
;

1100 ià(!
lšk
) ;

1102 
pubsub
 = (
lšk
->
pc
 =ğ
c
);

1103 ià(
pubsub
)

1104 
lšk
->
pc
 = 
NULL
;

1106 
lšk
->
cc
 = 
NULL
;

1107 
lšk
->
discÚÃùed
 = 1;

1108 
	}
}

1112 
	$£Áš–LškE¡ablishedC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

1113 ià(
¡©us
 !ğ
C_OK
è
	`š¡ªûLškCÚÃùiÚE¼Ü
(
c
);

1114 
	}
}

1116 
	$£Áš–DiscÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

1117 
	`UNUSED
(
¡©us
);

1118 
	`š¡ªûLškCÚÃùiÚE¼Ü
(
c
);

1119 
	}
}

1145 
£Áš–RedisIn¡ªû
 *
	$ü—‹S’tš–RedisIn¡ªû
(*
Çme
, 
æags
, *
ho¡Çme
, 
pÜt
, 
quÜum
, 
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1146 
£Áš–RedisIn¡ªû
 *
ri
;

1147 
£Áš–Addr
 *
addr
;

1148 
diù
 *
bË
 = 
NULL
;

1149 
¦av’ame
[
NET_PEER_ID_LEN
], *
sd¢ame
;

1151 
	`£rv”As£¹
(
æags
 & (
SRI_MASTER
|
SRI_SLAVE
|
SRI_SENTINEL
));

1152 
	`£rv”As£¹
((
æags
 & 
SRI_MASTER
è|| 
ma¡”
 !ğ
NULL
);

1155 
addr
 = 
	`ü—‹S’tš–Addr
(
ho¡Çme
,
pÜt
);

1156 ià(
addr
 =ğ
NULL
)  NULL;

1159 ià(
æags
 & 
SRI_SLAVE
) {

1160 
	`ª‘FÜm©Addr
(
¦av’ame
, (¦av’ame), 
ho¡Çme
, 
pÜt
);

1161 
Çme
 = 
¦av’ame
;

1168 ià(
æags
 & 
SRI_MASTER
è
bË
 = 
£Áš–
.
ma¡”s
;

1169 ià(
æags
 & 
SRI_SLAVE
è
bË
 = 
ma¡”
->
¦aves
;

1170 ià(
æags
 & 
SRI_SENTINEL
è
bË
 = 
ma¡”
->
£Áš–s
;

1171 
sd¢ame
 = 
	`sd¢ew
(
Çme
);

1172 ià(
	`diùFšd
(
bË
,
sd¢ame
)) {

1173 
	`»Ëa£S’tš–Addr
(
addr
);

1174 
	`sdsä“
(
sd¢ame
);

1175 
”ºo
 = 
EBUSY
;

1176  
NULL
;

1180 
ri
 = 
	`zm®loc
((*ri));

1183 
ri
->
æags
 = flags;

1184 
ri
->
Çme
 = 
sd¢ame
;

1185 
ri
->
runid
 = 
NULL
;

1186 
ri
->
cÚfig_•och
 = 0;

1187 
ri
->
addr
 =‡ddr;

1188 
ri
->
lšk
 = 
	`ü—‹In¡ªûLšk
();

1189 
ri
->
Ï¡_pub_time
 = 
	`m¡ime
();

1190 
ri
->
Ï¡_h–lo_time
 = 
	`m¡ime
();

1191 
ri
->
Ï¡_ma¡”_down_»¶y_time
 = 
	`m¡ime
();

1192 
ri
->
s_down_sšû_time
 = 0;

1193 
ri
->
o_down_sšû_time
 = 0;

1194 
ri
->
down_aá”_³riod
 = 
ma¡”
 ? master->down_after_period :

1195 
SENTINEL_DEFAULT_DOWN_AFTER
;

1196 
ri
->
ma¡”_lšk_down_time
 = 0;

1197 
ri
->
auth_·ss
 = 
NULL
;

1198 
ri
->
¦ave_´iÜ™y
 = 
SENTINEL_DEFAULT_SLAVE_PRIORITY
;

1199 
ri
->
¦ave_»cÚf_£Á_time
 = 0;

1200 
ri
->
¦ave_ma¡”_ho¡
 = 
NULL
;

1201 
ri
->
¦ave_ma¡”_pÜt
 = 0;

1202 
ri
->
¦ave_ma¡”_lšk_¡©us
 = 
SENTINEL_MASTER_LINK_STATUS_DOWN
;

1203 
ri
->
¦ave_»¶_off£t
 = 0;

1204 
ri
->
£Áš–s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1205 
ri
->
quÜum
 = quorum;

1206 
ri
->
·¿Î–_syncs
 = 
SENTINEL_DEFAULT_PARALLEL_SYNCS
;

1207 
ri
->
ma¡”
 = master;

1208 
ri
->
¦aves
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1209 
ri
->
šfo_»äesh
 = 0;

1212 
ri
->
Ëad”
 = 
NULL
;

1213 
ri
->
Ëad”_•och
 = 0;

1214 
ri
->
çov”_•och
 = 0;

1215 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

1216 
ri
->
çov”_¡©e_chªge_time
 = 0;

1217 
ri
->
çov”_¡¬t_time
 = 0;

1218 
ri
->
çov”_timeout
 = 
SENTINEL_DEFAULT_FAILOVER_TIMEOUT
;

1219 
ri
->
çov”_d–ay_logged
 = 0;

1220 
ri
->
´omÙed_¦ave
 = 
NULL
;

1221 
ri
->
nÙifiÿtiÚ_süt
 = 
NULL
;

1222 
ri
->
ş›Á_»cÚfig_süt
 = 
NULL
;

1223 
ri
->
šfo
 = 
NULL
;

1226 
ri
->
rŞe_»pÜ‹d
 =„i->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
);

1227 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

1228 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

1231 
	`diùAdd
(
bË
, 
ri
->
Çme
,„i);

1232  
ri
;

1233 
	}
}

1239 
	$»Ëa£S’tš–RedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

1241 
	`diùR–—£
(
ri
->
£Áš–s
);

1242 
	`diùR–—£
(
ri
->
¦aves
);

1245 
	`»Ëa£In¡ªûLšk
(
ri
->
lšk
,ri);

1248 
	`sdsä“
(
ri
->
Çme
);

1249 
	`sdsä“
(
ri
->
runid
);

1250 
	`sdsä“
(
ri
->
nÙifiÿtiÚ_süt
);

1251 
	`sdsä“
(
ri
->
ş›Á_»cÚfig_süt
);

1252 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

1253 
	`sdsä“
(
ri
->
Ëad”
);

1254 
	`sdsä“
(
ri
->
auth_·ss
);

1255 
	`sdsä“
(
ri
->
šfo
);

1256 
	`»Ëa£S’tš–Addr
(
ri
->
addr
);

1259 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& (ri->æag & 
SRI_PROMOTED
è&&„i->
ma¡”
)

1260 
ri
->
ma¡”
->
´omÙed_¦ave
 = 
NULL
;

1262 
	`zä“
(
ri
);

1263 
	}
}

1266 
£Áš–RedisIn¡ªû
 *
	$£Áš–RedisIn¡ªûLookupSÏve
(

1267 
£Áš–RedisIn¡ªû
 *
ri
, *

, 
pÜt
)

1269 
sds
 
key
;

1270 
£Áš–RedisIn¡ªû
 *
¦ave
;

1271 
buf
[
NET_PEER_ID_LEN
];

1273 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_MASTER
);

1274 
	`ª‘FÜm©Addr
(
buf
,(buf),

,
pÜt
);

1275 
key
 = 
	`sd¢ew
(
buf
);

1276 
¦ave
 = 
	`diùF‘chV®ue
(
ri
->
¦aves
,
key
);

1277 
	`sdsä“
(
key
);

1278  
¦ave
;

1279 
	}
}

1282 cÚ¡ *
	$£Áš–RedisIn¡ªûTy³SŒ
(
£Áš–RedisIn¡ªû
 *
ri
) {

1283 ià(
ri
->
æags
 & 
SRI_MASTER
)  "master";

1284 ià(
ri
->
æags
 & 
SRI_SLAVE
)  "slave";

1285 ià(
ri
->
æags
 & 
SRI_SENTINEL
)  "sentinel";

1287 
	}
}

1300 
	$»moveM©chšgS’tš–FromMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *
runid
) {

1301 
diùI‹¿tÜ
 *
di
;

1302 
diùEÁry
 *
de
;

1303 
»moved
 = 0;

1305 ià(
runid
 =ğ
NULL
)  0;

1307 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
ma¡”
->
£Áš–s
);

1308 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1309 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1311 ià(
ri
->
runid
 && 
	`¡rcmp
(ri->runid,runid) == 0) {

1312 
	`diùD–‘e
(
ma¡”
->
£Áš–s
,
ri
->
Çme
);

1313 
»moved
++;

1316 
	`diùR–—£I‹¿tÜ
(
di
);

1317  
»moved
;

1318 
	}
}

1326 
£Áš–RedisIn¡ªû
 *
	$g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
diù
 *
š¡ªûs
, *

, 
pÜt
, *
runid
) {

1327 
diùI‹¿tÜ
 *
di
;

1328 
diùEÁry
 *
de
;

1329 
£Áš–RedisIn¡ªû
 *
š¡ªû
 = 
NULL
;

1331 
	`£rv”As£¹
(

 || 
runid
);

1332 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1333 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1334 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1336 ià(
runid
 && !
ri
->runid) ;

1337 ià((
runid
 =ğ
NULL
 || 
	`¡rcmp
(
ri
->runid,„unid) == 0) &&

1338 (

 =ğ
NULL
 || (
	`¡rcmp
(
ri
->
addr
->ip, ip) == 0 &&

1339 
ri
->
addr
->
pÜt
 ==…ort)))

1341 
š¡ªû
 = 
ri
;

1345 
	`diùR–—£I‹¿tÜ
(
di
);

1346  
š¡ªû
;

1347 
	}
}

1350 
£Áš–RedisIn¡ªû
 *
	$£Áš–G‘Ma¡”ByName
(*
Çme
) {

1351 
£Áš–RedisIn¡ªû
 *
ri
;

1352 
sds
 
sd¢ame
 = 
	`sd¢ew
(
Çme
);

1354 
ri
 = 
	`diùF‘chV®ue
(
£Áš–
.
ma¡”s
,
sd¢ame
);

1355 
	`sdsä“
(
sd¢ame
);

1356  
ri
;

1357 
	}
}

1360 
	$£Áš–AddFÏgsToDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
, 
æags
) {

1361 
diùI‹¿tÜ
 *
di
;

1362 
diùEÁry
 *
de
;

1364 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1365 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1366 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1367 
ri
->
æags
 |= flags;

1369 
	`diùR–—£I‹¿tÜ
(
di
);

1370 
	}
}

1374 
	$£Áš–D–FÏgsToDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
, 
æags
) {

1375 
diùI‹¿tÜ
 *
di
;

1376 
diùEÁry
 *
de
;

1378 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1379 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1380 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1381 
ri
->
æags
 &= ~flags;

1383 
	`diùR–—£I‹¿tÜ
(
di
);

1384 
	}
}

1397 
	#SENTINEL_RESET_NO_SENTINELS
 (1<<0)

	)

1398 
	$£Áš–Re£tMa¡”
(
£Áš–RedisIn¡ªû
 *
ri
, 
æags
) {

1399 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_MASTER
);

1400 
	`diùR–—£
(
ri
->
¦aves
);

1401 
ri
->
¦aves
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1402 ià(!(
æags
 & 
SENTINEL_RESET_NO_SENTINELS
)) {

1403 
	`diùR–—£
(
ri
->
£Áš–s
);

1404 
ri
->
£Áš–s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1406 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
cc
);

1407 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
pc
);

1408 
ri
->
æags
 &ğ
SRI_MASTER
;

1409 ià(
ri
->
Ëad”
) {

1410 
	`sdsä“
(
ri
->
Ëad”
);

1411 
ri
->
Ëad”
 = 
NULL
;

1413 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

1414 
ri
->
çov”_¡©e_chªge_time
 = 0;

1415 
ri
->
çov”_¡¬t_time
 = 0;

1416 
ri
->
´omÙed_¦ave
 = 
NULL
;

1417 
	`sdsä“
(
ri
->
runid
);

1418 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

1419 
ri
->
runid
 = 
NULL
;

1420 
ri
->
¦ave_ma¡”_ho¡
 = 
NULL
;

1421 
ri
->
lšk
->
aù_pšg_time
 = 
	`m¡ime
();

1422 
ri
->
lšk
->
Ï¡_pšg_time
 = 0;

1423 
ri
->
lšk
->
Ï¡_ava_time
 = 
	`m¡ime
();

1424 
ri
->
lšk
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

1425 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

1426 
ri
->
rŞe_»pÜ‹d
 = 
SRI_MASTER
;

1427 ià(
æags
 & 
SENTINEL_GENERATE_EVENT
)

1428 
	`£Áš–Ev’t
(
LL_WARNING
,"+»£t-ma¡”",
ri
,"%@");

1429 
	}
}

1433 
	$£Áš–Re£tMa¡”sByP©‹º
(*
·‰”n
, 
æags
) {

1434 
diùI‹¿tÜ
 *
di
;

1435 
diùEÁry
 *
de
;

1436 
»£t
 = 0;

1438 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1439 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1440 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1442 ià(
ri
->
Çme
) {

1443 ià(
	`¡ršgm©ch
(
·‰”n
,
ri
->
Çme
,0)) {

1444 
	`£Áš–Re£tMa¡”
(
ri
,
æags
);

1445 
»£t
++;

1449 
	`diùR–—£I‹¿tÜ
(
di
);

1450  
»£t
;

1451 
	}
}

1460 
	$£Áš–Re£tMa¡”AndChªgeAdd»ss
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *

, 
pÜt
) {

1461 
£Áš–Addr
 *
Şdaddr
, *
Ãwaddr
;

1462 
£Áš–Addr
 **
¦aves
 = 
NULL
;

1463 
num¦aves
 = 0, 
j
;

1464 
diùI‹¿tÜ
 *
di
;

1465 
diùEÁry
 *
de
;

1467 
Ãwaddr
 = 
	`ü—‹S’tš–Addr
(

,
pÜt
);

1468 ià(
Ãwaddr
 =ğ
NULL
è 
C_ERR
;

1472 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

1473 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1474 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

1476 ià(
	`£Áš–AddrIsEqu®
(
¦ave
->
addr
,
Ãwaddr
)) ;

1477 
¦aves
 = 
	`z»®loc
(¦aves,(
£Áš–Addr
*)*(
num¦aves
+1));

1478 
¦aves
[
num¦aves
++] = 
	`ü—‹S’tš–Addr
(
¦ave
->
addr
->

,

1479 
¦ave
->
addr
->
pÜt
);

1481 
	`diùR–—£I‹¿tÜ
(
di
);

1486 ià(!
	`£Áš–AddrIsEqu®
(
Ãwaddr
,
ma¡”
->
addr
)) {

1487 
¦aves
 = 
	`z»®loc
(¦aves,(
£Áš–Addr
*)*(
num¦aves
+1));

1488 
¦aves
[
num¦aves
++] = 
	`ü—‹S’tš–Addr
(
ma¡”
->
addr
->

,

1489 
ma¡”
->
addr
->
pÜt
);

1493 
	`£Áš–Re£tMa¡”
(
ma¡”
,
SENTINEL_RESET_NO_SENTINELS
);

1494 
Şdaddr
 = 
ma¡”
->
addr
;

1495 
ma¡”
->
addr
 = 
Ãwaddr
;

1496 
ma¡”
->
o_down_sšû_time
 = 0;

1497 
ma¡”
->
s_down_sšû_time
 = 0;

1500 
j
 = 0; j < 
num¦aves
; j++) {

1501 
£Áš–RedisIn¡ªû
 *
¦ave
;

1503 
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,
¦aves
[
j
]->

,

1504 
¦aves
[
j
]->
pÜt
, 
ma¡”
->
quÜum
, master);

1505 
	`»Ëa£S’tš–Addr
(
¦aves
[
j
]);

1506 ià(
¦ave
è
	`£Áš–Ev’t
(
LL_NOTICE
,"+slave",slave,"%@");

1508 
	`zä“
(
¦aves
);

1512 
	`»Ëa£S’tš–Addr
(
Şdaddr
);

1513 
	`£Áš–FlushCÚfig
();

1514  
C_OK
;

1515 
	}
}

1519 
	$£Áš–RedisIn¡ªûNoDownFÜ
(
£Áš–RedisIn¡ªû
 *
ri
, 
m¡ime_t
 
ms
) {

1520 
m¡ime_t
 
mo¡_»ûÁ
;

1522 
mo¡_»ûÁ
 = 
ri
->
s_down_sšû_time
;

1523 ià(
ri
->
o_down_sšû_time
 > 
mo¡_»ûÁ
)

1524 
mo¡_»ûÁ
 = 
ri
->
o_down_sšû_time
;

1525  
mo¡_»ûÁ
 =ğ0 || (
	`m¡ime
(è- mo¡_»ûÁè> 
ms
;

1526 
	}
}

1530 
£Áš–Addr
 *
	$£Áš–G‘Cu¼’tMa¡”Add»ss
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1536 ià((
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) &&

1537 
ma¡”
->
´omÙed_¦ave
 &&

1538 
ma¡”
->
çov”_¡©e
 >ğ
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
)

1540  
ma¡”
->
´omÙed_¦ave
->
addr
;

1542  
ma¡”
->
addr
;

1544 
	}
}

1548 
	$£Áš–Prİag©eDownAá”P”iod
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1549 
diùI‹¿tÜ
 *
di
;

1550 
diùEÁry
 *
de
;

1551 
j
;

1552 
diù
 *
d
[] = {
ma¡”
->
¦aves
, ma¡”->
£Áš–s
, 
NULL
};

1554 
j
 = 0; 
d
[j]; j++) {

1555 
di
 = 
	`diùG‘I‹¿tÜ
(
d
[
j
]);

1556 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1557 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1558 
ri
->
down_aá”_³riod
 = 
ma¡”
->down_after_period;

1560 
	`diùR–—£I‹¿tÜ
(
di
);

1562 
	}
}

1564 *
	$£Áš–G‘In¡ªûTy³SŒšg
(
£Áš–RedisIn¡ªû
 *
ri
) {

1565 ià(
ri
->
æags
 & 
SRI_MASTER
)  "master";

1566 ià(
ri
->
æags
 & 
SRI_SLAVE
)  "slave";

1567 ià(
ri
->
æags
 & 
SRI_SENTINEL
)  "sentinel";

1569 
	}
}

1572 *
	$£Áš–HªdËCÚfigu¿tiÚ
(**
¬gv
, 
¬gc
) {

1573 
£Áš–RedisIn¡ªû
 *
ri
;

1575 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mÚ™Ü"è&& 
¬gc
 == 5) {

1577 
quÜum
 = 
	`©oi
(
¬gv
[4]);

1579 ià(
quÜum
 <= 0)  "Quorum must be 1 or greater.";

1580 ià(
	`ü—‹S’tš–RedisIn¡ªû
(
¬gv
[1],
SRI_MASTER
,argv[2],

1581 
	`©oi
(
¬gv
[3]),
quÜum
,
NULL
) == NULL)

1583 
”ºo
) {

1584 
EBUSY
:  "Duplicated master‚ame.";

1585 
ENOENT
:  "Can't„esolve master instance hostname.";

1586 
EINVAL
:  "Invalid…ort‚umber";

1589 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"down-aá”-mli£cÚds"è&& 
¬gc
 == 3) {

1591 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1592 ià(!
ri
)  "No such master with specified‚ame.";

1593 
ri
->
down_aá”_³riod
 = 
	`©oi
(
¬gv
[2]);

1594 ià(
ri
->
down_aá”_³riod
 <= 0)

1596 
	`£Áš–Prİag©eDownAá”P”iod
(
ri
);

1597 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"çov”-timeout"è&& 
¬gc
 == 3) {

1599 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1600 ià(!
ri
)  "No such master with specified‚ame.";

1601 
ri
->
çov”_timeout
 = 
	`©oi
(
¬gv
[2]);

1602 ià(
ri
->
çov”_timeout
 <= 0)

1604 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"·¿Î–-syncs"è&& 
¬gc
 == 3) {

1606 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1607 ià(!
ri
)  "No such master with specified‚ame.";

1608 
ri
->
·¿Î–_syncs
 = 
	`©oi
(
¬gv
[2]);

1609 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"nÙifiÿtiÚ-süt"è&& 
¬gc
 == 3) {

1611 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1612 ià(!
ri
)  "No such master with specified‚ame.";

1613 ià(
	`acûss
(
¬gv
[2],
X_OK
) == -1)

1615 
ri
->
nÙifiÿtiÚ_süt
 = 
	`sd¢ew
(
¬gv
[2]);

1616 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ş›Á-»cÚfig-süt"è&& 
¬gc
 == 3) {

1618 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1619 ià(!
ri
)  "No such master with specified‚ame.";

1620 ià(
	`acûss
(
¬gv
[2],
X_OK
) == -1)

1623 
ri
->
ş›Á_»cÚfig_süt
 = 
	`sd¢ew
(
¬gv
[2]);

1624 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auth-·ss"è&& 
¬gc
 == 3) {

1626 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1627 ià(!
ri
)  "No such master with specified‚ame.";

1628 
ri
->
auth_·ss
 = 
	`sd¢ew
(
¬gv
[2]);

1629 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cu¼’t-•och"è&& 
¬gc
 == 2) {

1631 
cu¼’t_•och
 = 
	`¡¹ouÎ
(
¬gv
[1],
NULL
,10);

1632 ià(
cu¼’t_•och
 > 
£Áš–
.current_epoch)

1633 
£Áš–
.
cu¼’t_•och
 = current_epoch;

1634 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"myid"è&& 
¬gc
 == 2) {

1635 ià(
	`¡¾’
(
¬gv
[1]è!ğ
CONFIG_RUN_ID_SIZE
)

1637 
	`memıy
(
£Áš–
.
myid
,
¬gv
[1],
CONFIG_RUN_ID_SIZE
);

1638 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cÚfig-•och"è&& 
¬gc
 == 3) {

1640 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1641 ià(!
ri
)  "No such master with specified‚ame.";

1642 
ri
->
cÚfig_•och
 = 
	`¡¹ouÎ
(
¬gv
[2],
NULL
,10);

1646 ià(
ri
->
cÚfig_•och
 > 
£Áš–
.
cu¼’t_•och
)

1647 
£Áš–
.
cu¼’t_•och
 = 
ri
->
cÚfig_•och
;

1648 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ëad”-•och"è&& 
¬gc
 == 3) {

1650 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1651 ià(!
ri
)  "No such master with specified‚ame.";

1652 
ri
->
Ëad”_•och
 = 
	`¡¹ouÎ
(
¬gv
[2],
NULL
,10);

1653 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"known-¦ave"è&& 
¬gc
 == 4) {

1654 
£Áš–RedisIn¡ªû
 *
¦ave
;

1657 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1658 ià(!
ri
)  "No such master with specified‚ame.";

1659 ià((
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,
¬gv
[2],

1660 
	`©oi
(
¬gv
[3]), 
ri
->
quÜum
,„i)è=ğ
NULL
)

1664 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"known-sentinel") &&

1665 (
¬gc
 == 4 ||‡rgc == 5)) {

1666 
£Áš–RedisIn¡ªû
 *
si
;

1668 ià(
¬gc
 == 5) {

1670 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1671 ià(!
ri
)  "No such master with specified‚ame.";

1672 ià((
si
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
¬gv
[4],
SRI_SENTINEL
,argv[2],

1673 
	`©oi
(
¬gv
[3]), 
ri
->
quÜum
,„i)è=ğ
NULL
)

1677 
si
->
runid
 = 
	`sd¢ew
(
¬gv
[4]);

1678 
	`£Áš–TryCÚÃùiÚSh¬šg
(
si
);

1680 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ªnounû-"è&& 
¬gc
 == 2) {

1682 ià(
	`¡¾’
(
¬gv
[1]))

1683 
£Áš–
.
ªnounû_
 = 
	`sd¢ew
(
¬gv
[1]);

1684 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ªnounû-pÜt"è&& 
¬gc
 == 2) {

1686 
£Áš–
.
ªnounû_pÜt
 = 
	`©oi
(
¬gv
[1]);

1690  
NULL
;

1691 
	}
}

1698 
	$»wr™eCÚfigS’tš–O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1699 
diùI‹¿tÜ
 *
di
, *
di2
;

1700 
diùEÁry
 *
de
;

1701 
sds
 
lše
;

1704 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "£Áš– myid %s", 
£Áš–
.
myid
);

1705 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1708 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1709 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1710 
£Áš–RedisIn¡ªû
 *
ma¡”
, *
ri
;

1711 
£Áš–Addr
 *
ma¡”_addr
;

1714 
ma¡”
 = 
	`diùG‘V®
(
de
);

1715 
ma¡”_addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ma¡”
);

1716 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"sentinel monitor %s %s %d %d",

1717 
ma¡”
->
Çme
, 
ma¡”_addr
->

, ma¡”_addr->
pÜt
,

1718 
ma¡”
->
quÜum
);

1719 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1722 ià(
ma¡”
->
down_aá”_³riod
 !ğ
SENTINEL_DEFAULT_DOWN_AFTER
) {

1723 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1725 
ma¡”
->
Çme
, (èma¡”->
down_aá”_³riod
);

1726 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1730 ià(
ma¡”
->
çov”_timeout
 !ğ
SENTINEL_DEFAULT_FAILOVER_TIMEOUT
) {

1731 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1733 
ma¡”
->
Çme
, (èma¡”->
çov”_timeout
);

1734 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1738 ià(
ma¡”
->
·¿Î–_syncs
 !ğ
SENTINEL_DEFAULT_PARALLEL_SYNCS
) {

1739 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1741 
ma¡”
->
Çme
, ma¡”->
·¿Î–_syncs
);

1742 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1746 ià(
ma¡”
->
nÙifiÿtiÚ_süt
) {

1747 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1749 
ma¡”
->
Çme
, ma¡”->
nÙifiÿtiÚ_süt
);

1750 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1754 ià(
ma¡”
->
ş›Á_»cÚfig_süt
) {

1755 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1757 
ma¡”
->
Çme
, ma¡”->
ş›Á_»cÚfig_süt
);

1758 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1762 ià(
ma¡”
->
auth_·ss
) {

1763 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1765 
ma¡”
->
Çme
, ma¡”->
auth_·ss
);

1766 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1770 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1772 
ma¡”
->
Çme
, (èma¡”->
cÚfig_•och
);

1773 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1776 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1778 
ma¡”
->
Çme
, (èma¡”->
Ëad”_•och
);

1779 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1782 
di2
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

1783 (
de
 = 
	`diùNext
(
di2
)è!ğ
NULL
) {

1784 
£Áš–Addr
 *
¦ave_addr
;

1786 
ri
 = 
	`diùG‘V®
(
de
);

1787 
¦ave_addr
 = 
ri
->
addr
;

1794 ià(
	`£Áš–AddrIsEqu®
(
¦ave_addr
,
ma¡”_addr
))

1795 
¦ave_addr
 = 
ma¡”
->
addr
;

1796 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1798 
ma¡”
->
Çme
, 
¦ave_addr
->

, sÏve_addr->
pÜt
);

1799 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1801 
	`diùR–—£I‹¿tÜ
(
di2
);

1804 
di2
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

1805 (
de
 = 
	`diùNext
(
di2
)è!ğ
NULL
) {

1806 
ri
 = 
	`diùG‘V®
(
de
);

1807 ià(
ri
->
runid
 =ğ
NULL
) ;

1808 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1810 
ma¡”
->
Çme
, 
ri
->
addr
->

,„i->addr->
pÜt
,„i->
runid
);

1811 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1813 
	`diùR–—£I‹¿tÜ
(
di2
);

1817 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1818 "£Áš– cu¼’t-•och %Îu", (è
£Áš–
.
cu¼’t_•och
);

1819 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1822 ià(
£Áš–
.
ªnounû_
) {

1823 
lše
 = 
	`sd¢ew
("sentinel‡nnounce-ip ");

1824 
lše
 = 
	`sdsÿŒ•r
Öše, 
£Áš–
.
ªnounû_
, 
	`sd¦’
(sentinel.announce_ip));

1825 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1829 ià(
£Áš–
.
ªnounû_pÜt
) {

1830 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"sentinel‡nnounce-port %d",

1831 
£Áš–
.
ªnounû_pÜt
);

1832 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1835 
	`diùR–—£I‹¿tÜ
(
di
);

1836 
	}
}

1845 
	$£Áš–FlushCÚfig
() {

1846 
fd
 = -1;

1847 
§ved_hz
 = 
£rv”
.
hz
;

1848 
»wr™e_¡©us
;

1850 
£rv”
.
hz
 = 
CONFIG_DEFAULT_HZ
;

1851 
»wr™e_¡©us
 = 
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
);

1852 
£rv”
.
hz
 = 
§ved_hz
;

1854 ià(
»wr™e_¡©us
 =ğ-1è
w”r
;

1855 ià((
fd
 = 
	`İ’
(
£rv”
.
cÚfigfe
,
O_RDONLY
)è=ğ-1è
w”r
;

1856 ià(
	`fsync
(
fd
è=ğ-1è
w”r
;

1857 ià(
	`şo£
(
fd
è=ğ
EOF
è
w”r
;

1860 
w”r
:

1861 ià(
fd
 !ğ-1è
	`şo£
(fd);

1862 
	`£rv”Log
(
LL_WARNING
,"WARNING: S’tš– wa nÙ‡bËØ§vthÃw cÚfigu¿tiÚ oÀdisk!!!: %s", 
	`¡»¼Ü
(
”ºo
));

1863 
	}
}

1873 
	$£Áš–S’dAuthIfN“ded
(
£Áš–RedisIn¡ªû
 *
ri
, 
»disAsyncCÚ‹xt
 *
c
) {

1874 *
auth_·ss
 = (
ri
->
æags
 & 
SRI_MASTER
) ?„i->auth_pass :

1875 
ri
->
ma¡”
->
auth_·ss
;

1877 ià(
auth_·ss
) {

1878 ià(
	`»disAsyncCommªd
(
c
, 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "AUTH %s",

1879 
auth_·ss
è=ğ
C_OK
è
ri
->
lšk
->
³ndšg_commªds
++;

1881 
	}
}

1889 
	$£Áš–S‘Cl›ÁName
(
£Áš–RedisIn¡ªû
 *
ri
, 
»disAsyncCÚ‹xt
 *
c
, *
ty³
) {

1890 
Çme
[64];

1892 
	`¢´štf
(
Çme
,Òame),"£Áš–-%.8s-%s",
£Áš–
.
myid
,
ty³
);

1893 ià(
	`»disAsyncCommªd
(
c
, 
£Áš–DisÿrdR•lyC®lback
, 
ri
,

1894 "CLIENT SETNAME %s", 
Çme
è=ğ
C_OK
)

1896 
ri
->
lšk
->
³ndšg_commªds
++;

1898 
	}
}

1903 
	$£Áš–RecÚÃùIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

1904 ià(
ri
->
lšk
->
discÚÃùed
 == 0) ;

1905 ià(
ri
->
addr
->
pÜt
 == 0) ;

1906 
š¡ªûLšk
 *
lšk
 = 
ri
->link;

1907 
m¡ime_t
 
now
 = 
	`m¡ime
();

1909 ià(
now
 - 
ri
->
lšk
->
Ï¡_»cÚn_time
 < 
SENTINEL_PING_PERIOD
) ;

1910 
ri
->
lšk
->
Ï¡_»cÚn_time
 = 
now
;

1913 ià(
lšk
->
cc
 =ğ
NULL
) {

1914 
lšk
->
cc
 = 
	`»disAsyncCÚÃùBšd
(
ri
->
addr
->

,ri->addr->
pÜt
,
NET_FIRST_BIND_ADDR
);

1915 ià(
lšk
->
cc
->
”r
) {

1916 
	`£Áš–Ev’t
(
LL_DEBUG
,"-cmd-lšk-»cÚÃùiÚ",
ri
,"%@ #%s",

1917 
lšk
->
cc
->
”r¡r
);

1918 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
cc
);

1920 
lšk
->
³ndšg_commªds
 = 0;

1921 
lšk
->
cc_cÚn_time
 = 
	`m¡ime
();

1922 
lšk
->
cc
->
d©a
 =†ink;

1923 
	`»disAeA‰ach
(
£rv”
.
–
,
lšk
->
cc
);

1924 
	`»disAsyncS‘CÚÃùC®lback
(
lšk
->
cc
,

1925 
£Áš–LškE¡ablishedC®lback
);

1926 
	`»disAsyncS‘DiscÚÃùC®lback
(
lšk
->
cc
,

1927 
£Áš–DiscÚÃùC®lback
);

1928 
	`£Áš–S’dAuthIfN“ded
(
ri
,
lšk
->
cc
);

1929 
	`£Áš–S‘Cl›ÁName
(
ri
,
lšk
->
cc
,"cmd");

1932 
	`£Áš–S’dPšg
(
ri
);

1936 ià((
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)è&& 
lšk
->
pc
 =ğ
NULL
) {

1937 
lšk
->
pc
 = 
	`»disAsyncCÚÃùBšd
(
ri
->
addr
->

,ri->addr->
pÜt
,
NET_FIRST_BIND_ADDR
);

1938 ià(
lšk
->
pc
->
”r
) {

1939 
	`£Áš–Ev’t
(
LL_DEBUG
,"-pubsub-lšk-»cÚÃùiÚ",
ri
,"%@ #%s",

1940 
lšk
->
pc
->
”r¡r
);

1941 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
pc
);

1943 
»tv®
;

1945 
lšk
->
pc_cÚn_time
 = 
	`m¡ime
();

1946 
lšk
->
pc
->
d©a
 =†ink;

1947 
	`»disAeA‰ach
(
£rv”
.
–
,
lšk
->
pc
);

1948 
	`»disAsyncS‘CÚÃùC®lback
(
lšk
->
pc
,

1949 
£Áš–LškE¡ablishedC®lback
);

1950 
	`»disAsyncS‘DiscÚÃùC®lback
(
lšk
->
pc
,

1951 
£Áš–DiscÚÃùC®lback
);

1952 
	`£Áš–S’dAuthIfN“ded
(
ri
,
lšk
->
pc
);

1953 
	`£Áš–S‘Cl›ÁName
(
ri
,
lšk
->
pc
,"pubsub");

1955 
»tv®
 = 
	`»disAsyncCommªd
(
lšk
->
pc
,

1956 
£Áš–ReûiveH–loMes§ges
, 
ri
, "SUBSCRIBE %s",

1957 
SENTINEL_HELLO_CHANNEL
);

1958 ià(
»tv®
 !ğ
C_OK
) {

1961 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
pc
);

1968 ià(
lšk
->
cc
 && (
ri
->
æags
 & 
SRI_SENTINEL
 ||†šk->
pc
))

1969 
lšk
->
discÚÃùed
 = 0;

1970 
	}
}

1979 
	$£Áš–Ma¡”LooksSªe
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1981 
ma¡”
->
æags
 & 
SRI_MASTER
 &&

1982 
ma¡”
->
rŞe_»pÜ‹d
 =ğ
SRI_MASTER
 &&

1983 (
ma¡”
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
)) == 0 &&

1984 (
	`m¡ime
(è- 
ma¡”
->
šfo_»äesh
è< 
SENTINEL_INFO_PERIOD
*2;

1985 
	}
}

1988 
	$£Áš–ReäeshIn¡ªûInfo
(
£Áš–RedisIn¡ªû
 *
ri
, cÚ¡ *
šfo
) {

1989 
sds
 *
lšes
;

1990 
numlšes
, 
j
;

1991 
rŞe
 = 0;

1994 
	`sdsä“
(
ri
->
šfo
);

1995 
ri
->
šfo
 = 
	`sd¢ew
(info);

1999 
ri
->
ma¡”_lšk_down_time
 = 0;

2002 
lšes
 = 
	`sds¥l™Ën
(
šfo
,
	`¡¾’
(šfo),"\r\n",2,&
numlšes
);

2003 
j
 = 0; j < 
numlšes
; j++) {

2004 
£Áš–RedisIn¡ªû
 *
¦ave
;

2005 
sds
 
l
 = 
lšes
[
j
];

2008 ià(
	`sd¦’
(
l
è>ğ47 && !
	`memcmp
(l,"run_id:",7)) {

2009 ià(
ri
->
runid
 =ğ
NULL
) {

2010 
ri
->
runid
 = 
	`sd¢ewËn
(
l
+7,40);

2012 ià(
	`¡ºcmp
(
ri
->
runid
,
l
+7,40) != 0) {

2013 
	`£Áš–Ev’t
(
LL_NOTICE
,"+»boÙ",
ri
,"%@");

2014 
	`sdsä“
(
ri
->
runid
);

2015 
ri
->
runid
 = 
	`sd¢ewËn
(
l
+7,40);

2022 ià((
ri
->
æags
 & 
SRI_MASTER
) &&

2023 
	`sd¦’
(
l
) >= 7 &&

2024 !
	`memcmp
(
l
,"¦ave",5è&& 
	`isdig™
(l[5]))

2026 *

, *
pÜt
, *
’d
;

2028 ià(
	`¡r¡r
(
l
,"="è=ğ
NULL
) {

2030 

 = 
	`¡rchr
(
l
,':'); if (!ip) ;

2031 

++;

2032 
pÜt
 = 
	`¡rchr
(

,','); if (!port) ;

2033 *
pÜt
 = '\0';

2034 
pÜt
++;

2035 
’d
 = 
	`¡rchr
(
pÜt
,','); if (!end) ;

2036 *
’d
 = '\0';

2039 

 = 
	`¡r¡r
(
l
,"ip="); if (!ip) ;

2040 

 += 3;

2041 
pÜt
 = 
	`¡r¡r
(
l
,"port="); if (!port) ;

2042 
pÜt
 += 5;

2044 
’d
 = 
	`¡rchr
(

,','); if (end) *end = '\0';

2045 
’d
 = 
	`¡rchr
(
pÜt
,','); if (end) *end = '\0';

2050 ià(
	`£Áš–RedisIn¡ªûLookupSÏve
(
ri
,

,
	`©oi
(
pÜt
)è=ğ
NULL
) {

2051 ià((
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,

,

2052 
	`©oi
(
pÜt
), 
ri
->
quÜum
,„i)è!ğ
NULL
)

2054 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave",
¦ave
,"%@");

2055 
	`£Áš–FlushCÚfig
();

2061 ià(
	`sd¦’
(
l
) >= 32 &&

2062 !
	`memcmp
(
l
,"master_link_down_since_seconds",30))

2064 
ri
->
ma¡”_lšk_down_time
 = 
	`¡¹Şl
(
l
+31,
NULL
,10)*1000;

2068 ià(!
	`memcmp
(
l
,"rŞe:ma¡”",11)è
rŞe
 = 
SRI_MASTER
;

2069 ià(!
	`memcmp
(
l
,"rŞe:¦ave",10)è
rŞe
 = 
SRI_SLAVE
;

2071 ià(
rŞe
 =ğ
SRI_SLAVE
) {

2073 ià(
	`sd¦’
(
l
è>ğ12 && !
	`memcmp
(l,"master_host:",12)) {

2074 ià(
ri
->
¦ave_ma¡”_ho¡
 =ğ
NULL
 ||

2075 
	`¡rÿ£cmp
(
l
+12,
ri
->
¦ave_ma¡”_ho¡
))

2077 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

2078 
ri
->
¦ave_ma¡”_ho¡
 = 
	`sd¢ew
(
l
+12);

2079 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

2084 ià(
	`sd¦’
(
l
è>ğ12 && !
	`memcmp
(l,"master_port:",12)) {

2085 
¦ave_ma¡”_pÜt
 = 
	`©oi
(
l
+12);

2087 ià(
ri
->
¦ave_ma¡”_pÜt
 != slave_master_port) {

2088 
ri
->
¦ave_ma¡”_pÜt
 = slave_master_port;

2089 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

2094 ià(
	`sd¦’
(
l
è>ğ19 && !
	`memcmp
(l,"master_link_status:",19)) {

2095 
ri
->
¦ave_ma¡”_lšk_¡©us
 =

2096 (
	`¡rÿ£cmp
(
l
+19,"up") == 0) ?

2097 
SENTINEL_MASTER_LINK_STATUS_UP
 :

2098 
SENTINEL_MASTER_LINK_STATUS_DOWN
;

2102 ià(
	`sd¦’
(
l
è>ğ15 && !
	`memcmp
(l,"slave_priority:",15))

2103 
ri
->
¦ave_´iÜ™y
 = 
	`©oi
(
l
+15);

2106 ià(
	`sd¦’
(
l
è>ğ18 && !
	`memcmp
(l,"slave_repl_offset:",18))

2107 
ri
->
¦ave_»¶_off£t
 = 
	`¡¹ouÎ
(
l
+18,
NULL
,10);

2110 
ri
->
šfo_»äesh
 = 
	`m¡ime
();

2111 
	`sdsä“¥l™»s
(
lšes
,
numlšes
);

2118 ià(
rŞe
 !ğ
ri
->
rŞe_»pÜ‹d
) {

2119 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

2120 
ri
->
rŞe_»pÜ‹d
 = 
rŞe
;

2121 ià(
rŞe
 =ğ
SRI_SLAVE
è
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

2124 
	`£Áš–Ev’t
(
LL_VERBOSE
,

2125 ((
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)è=ğ
rŞe
) ?

2127 
ri
, "%@‚ew„eported„ole is %s",

2128 
rŞe
 =ğ
SRI_MASTER
 ? "master" : "slave",

2129 
ri
->
æags
 & 
SRI_MASTER
 ? "master" : "slave");

2134 ià(
£Áš–
.
tt
) ;

2137 ià((
ri
->
æags
 & 
SRI_MASTER
è&& 
rŞe
 =ğ
SRI_SLAVE
) {

2144 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& 
rŞe
 =ğ
SRI_MASTER
) {

2147 ià((
ri
->
æags
 & 
SRI_PROMOTED
) &&

2148 (
ri
->
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) &&

2149 (
ri
->
ma¡”
->
çov”_¡©e
 ==

2150 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
))

2157 
ri
->
ma¡”
->
cÚfig_•och
 =„i->ma¡”->
çov”_•och
;

2158 
ri
->
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
;

2159 
ri
->
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

2160 
	`£Áš–FlushCÚfig
();

2161 
	`£Áš–Ev’t
(
LL_WARNING
,"+´omÙed-¦ave",
ri
,"%@");

2162 ià(
£Áš–
.
simçu»_æags
 &

2163 
SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION
)

2164 
	`£Áš–SimFau»C¿sh
();

2165 
	`£Áš–Ev’t
(
LL_WARNING
,"+failover-state-reconf-slaves",

2166 
ri
->
ma¡”
,"%@");

2167 
	`£Áš–C®lCl›ÁRecÚfSüt
(
ri
->
ma¡”
,
SENTINEL_LEADER
,

2168 "¡¬t",
ri
->
ma¡”
->
addr
,ri->addr);

2169 
	`£Áš–FÜûH–loUpd©eFÜMa¡”
(
ri
->
ma¡”
);

2174 
m¡ime_t
 
wa™_time
 = 
SENTINEL_PUBLISH_PERIOD
*4;

2176 ià(!(
ri
->
æags
 & 
SRI_PROMOTED
) &&

2177 
	`£Áš–Ma¡”LooksSªe
(
ri
->
ma¡”
) &&

2178 
	`£Áš–RedisIn¡ªûNoDownFÜ
(
ri
,
wa™_time
) &&

2179 
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
 > 
wa™_time
)

2181 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
,

2182 
ri
->
ma¡”
->
addr
->

,

2183 
ri
->
ma¡”
->
addr
->
pÜt
);

2184 ià(
»tv®
 =ğ
C_OK
)

2185 
	`£Áš–Ev’t
(
LL_NOTICE
,"+cÚv”t-to-¦ave",
ri
,"%@");

2191 ià((
ri
->
æags
 & 
SRI_SLAVE
) &&

2192 
rŞe
 =ğ
SRI_SLAVE
 &&

2193 (
ri
->
¦ave_ma¡”_pÜt
 !ğri->
ma¡”
->
addr
->
pÜt
 ||

2194 
	`¡rÿ£cmp
(
ri
->
¦ave_ma¡”_ho¡
,ri->
ma¡”
->
addr
->

)))

2196 
m¡ime_t
 
wa™_time
 = 
ri
->
ma¡”
->
çov”_timeout
;

2200 ià(
	`£Áš–Ma¡”LooksSªe
(
ri
->
ma¡”
) &&

2201 
	`£Áš–RedisIn¡ªûNoDownFÜ
(
ri
,
wa™_time
) &&

2202 
	`m¡ime
(è- 
ri
->
¦ave_cÚf_chªge_time
 > 
wa™_time
)

2204 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
,

2205 
ri
->
ma¡”
->
addr
->

,

2206 
ri
->
ma¡”
->
addr
->
pÜt
);

2207 ià(
»tv®
 =ğ
C_OK
)

2208 
	`£Áš–Ev’t
(
LL_NOTICE
,"+fix-¦ave-cÚfig",
ri
,"%@");

2214 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& 
rŞe
 == SRI_SLAVE &&

2215 (
ri
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
)))

2218 ià((
ri
->
æags
 & 
SRI_RECONF_SENT
) &&

2219 
ri
->
¦ave_ma¡”_ho¡
 &&

2220 
	`¡rcmp
(
ri
->
¦ave_ma¡”_ho¡
,

2221 
ri
->
ma¡”
->
´omÙed_¦ave
->
addr
->

) == 0 &&

2222 
ri
->
¦ave_ma¡”_pÜt
 =ğri->
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
)

2224 
ri
->
æags
 &ğ~
SRI_RECONF_SENT
;

2225 
ri
->
æags
 |ğ
SRI_RECONF_INPROG
;

2226 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-š´og",
ri
,"%@");

2230 ià((
ri
->
æags
 & 
SRI_RECONF_INPROG
) &&

2231 
ri
->
¦ave_ma¡”_lšk_¡©us
 =ğ
SENTINEL_MASTER_LINK_STATUS_UP
)

2233 
ri
->
æags
 &ğ~
SRI_RECONF_INPROG
;

2234 
ri
->
æags
 |ğ
SRI_RECONF_DONE
;

2235 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-dÚe",
ri
,"%@");

2238 
	}
}

2240 
	$£Áš–InfoR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2241 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2242 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2243 
»disR•ly
 *
r
;

2245 ià(!
»¶y
 || !
lšk
) ;

2246 
lšk
->
³ndšg_commªds
--;

2247 
r
 = 
»¶y
;

2249 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STRING
)

2250 
	`£Áš–ReäeshIn¡ªûInfo
(
ri
,
r
->
¡r
);

2251 
	}
}

2255 
	$£Áš–DisÿrdR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2256 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2257 
	`UNUSED
(
»¶y
);

2258 
	`UNUSED
(
´ivd©a
);

2260 ià(
lšk
èlšk->
³ndšg_commªds
--;

2261 
	}
}

2263 
	$£Áš–PšgR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2264 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2265 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2266 
»disR•ly
 *
r
;

2268 ià(!
»¶y
 || !
lšk
) ;

2269 
lšk
->
³ndšg_commªds
--;

2270 
r
 = 
»¶y
;

2272 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STATUS
 ||

2273 
r
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2276 ià(
	`¡ºcmp
(
r
->
¡r
,"PONG",4) == 0 ||

2277 
	`¡ºcmp
(
r
->
¡r
,"LOADING",7) == 0 ||

2278 
	`¡ºcmp
(
r
->
¡r
,"MASTERDOWN",10) == 0)

2280 
lšk
->
Ï¡_ava_time
 = 
	`m¡ime
();

2281 
lšk
->
aù_pšg_time
 = 0;

2285 ià(
	`¡ºcmp
(
r
->
¡r
,"BUSY",4) == 0 &&

2286 (
ri
->
æags
 & 
SRI_S_DOWN
) &&

2287 !(
ri
->
æags
 & 
SRI_SCRIPT_KILL_SENT
))

2289 ià(
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2290 
£Áš–DisÿrdR•lyC®lback
, 
ri
,

2291 "SCRIPT KILL"è=ğ
C_OK
)

2292 
ri
->
lšk
->
³ndšg_commªds
++;

2293 
ri
->
æags
 |ğ
SRI_SCRIPT_KILL_SENT
;

2297 
lšk
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

2298 
	}
}

2302 
	$£Áš–PublishR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2303 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2304 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2305 
»disR•ly
 *
r
;

2307 ià(!
»¶y
 || !
lšk
) ;

2308 
lšk
->
³ndšg_commªds
--;

2309 
r
 = 
»¶y
;

2313 ià(
r
->
ty³
 !ğ
REDIS_REPLY_ERROR
)

2314 
ri
->
Ï¡_pub_time
 = 
	`m¡ime
();

2315 
	}
}

2322 
	$£Áš–ProûssH–loMes§ge
(*
h–lo
, 
h–lo_Ën
) {

2326 
numtok’s
, 
pÜt
, 
»moved
, 
ma¡”_pÜt
;

2327 
ušt64_t
 
cu¼’t_•och
, 
ma¡”_cÚfig_•och
;

2328 **
tok’
 = 
	`sds¥l™Ën
(
h–lo
, 
h–lo_Ën
, ",", 1, &
numtok’s
);

2329 
£Áš–RedisIn¡ªû
 *
si
, *
ma¡”
;

2331 ià(
numtok’s
 == 8) {

2333 
ma¡”
 = 
	`£Áš–G‘Ma¡”ByName
(
tok’
[4]);

2334 ià(!
ma¡”
è
ş—nup
;

2337 
pÜt
 = 
	`©oi
(
tok’
[1]);

2338 
ma¡”_pÜt
 = 
	`©oi
(
tok’
[6]);

2339 
si
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(

2340 
ma¡”
->
£Áš–s
,
tok’
[0],
pÜt
,token[2]);

2341 
cu¼’t_•och
 = 
	`¡¹ouÎ
(
tok’
[3],
NULL
,10);

2342 
ma¡”_cÚfig_•och
 = 
	`¡¹ouÎ
(
tok’
[7],
NULL
,10);

2344 ià(!
si
) {

2348 
»moved
 = 
	`»moveM©chšgS’tš–FromMa¡”
(
ma¡”
,
tok’
[2]);

2349 ià(
»moved
) {

2350 
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–-add»ss-sw™ch",
ma¡”
,

2351 "%@ i°% pÜˆ%d fÜ %s", 
tok’
[0],
pÜt
,token[2]);

2357 
£Áš–RedisIn¡ªû
 *
Ùh”
 =

2358 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(

2359 
ma¡”
->
£Áš–s
, 
tok’
[0],
pÜt
,
NULL
);

2360 ià(
Ùh”
) {

2361 
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–-šv®id-addr",
Ùh”
,"%@");

2362 
Ùh”
->
addr
->
pÜt
 = 0;

2363 
	`£Áš–Upd©eS’tš–Add»ssInAÎMa¡”s
(
Ùh”
);

2368 
si
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
tok’
[2],
SRI_SENTINEL
,

2369 
tok’
[0],
pÜt
,
ma¡”
->
quÜum
,master);

2371 ià(
si
) {

2372 ià(!
»moved
è
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–",
si
,"%@");

2376 
si
->
runid
 = 
	`sd¢ew
(
tok’
[2]);

2377 
	`£Áš–TryCÚÃùiÚSh¬šg
(
si
);

2378 ià(
»moved
è
	`£Áš–Upd©eS’tš–Add»ssInAÎMa¡”s
(
si
);

2379 
	`£Áš–FlushCÚfig
();

2384 ià(
cu¼’t_•och
 > 
£Áš–
.current_epoch) {

2385 
£Áš–
.
cu¼’t_•och
 = current_epoch;

2386 
	`£Áš–FlushCÚfig
();

2387 
	`£Áš–Ev’t
(
LL_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

2388 (è
£Áš–
.
cu¼’t_•och
);

2392 ià(
si
 && 
ma¡”
->
cÚfig_•och
 < 
ma¡”_cÚfig_•och
) {

2393 
ma¡”
->
cÚfig_•och
 = 
ma¡”_cÚfig_•och
;

2394 ià(
ma¡”_pÜt
 !ğ
ma¡”
->
addr
->
pÜt
 ||

2395 
	`¡rcmp
(
ma¡”
->
addr
->

, 
tok’
[5]))

2397 
£Áš–Addr
 *
Şd_addr
;

2399 
	`£Áš–Ev’t
(
LL_WARNING
,"+cÚfig-upd©e-äom",
si
,"%@");

2400 
	`£Áš–Ev’t
(
LL_WARNING
,"+switch-master",

2401 
ma¡”
,"%s %s %d %s %d",

2402 
ma¡”
->
Çme
,

2403 
ma¡”
->
addr
->

, ma¡”->addr->
pÜt
,

2404 
tok’
[5], 
ma¡”_pÜt
);

2406 
Şd_addr
 = 
	`dupS’tš–Addr
(
ma¡”
->
addr
);

2407 
	`£Áš–Re£tMa¡”AndChªgeAdd»ss
(
ma¡”
, 
tok’
[5], 
ma¡”_pÜt
);

2408 
	`£Áš–C®lCl›ÁRecÚfSüt
(
ma¡”
,

2409 
SENTINEL_OBSERVER
,"start",

2410 
Şd_addr
,
ma¡”
->
addr
);

2411 
	`»Ëa£S’tš–Addr
(
Şd_addr
);

2416 ià(
si
èsi->
Ï¡_h–lo_time
 = 
	`m¡ime
();

2419 
ş—nup
:

2420 
	`sdsä“¥l™»s
(
tok’
,
numtok’s
);

2421 
	}
}

2426 
	$£Áš–ReûiveH–loMes§ges
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2427 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2428 
»disR•ly
 *
r
;

2429 
	`UNUSED
(
c
);

2431 ià(!
»¶y
 || !
ri
) ;

2432 
r
 = 
»¶y
;

2437 
ri
->
lšk
->
pc_Ï¡_aùiv™y
 = 
	`m¡ime
();

2441 ià(
r
->
ty³
 !ğ
REDIS_REPLY_ARRAY
 ||

2442 
r
->
–em’ts
 != 3 ||

2443 
r
->
–em’t
[0]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2444 
r
->
–em’t
[1]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2445 
r
->
–em’t
[2]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2446 
	`¡rcmp
(
r
->
–em’t
[0]->
¡r
,"message") != 0) ;

2449 ià(
	`¡r¡r
(
r
->
–em’t
[2]->
¡r
,
£Áš–
.
myid
è!ğ
NULL
) ;

2451 
	`£Áš–ProûssH–loMes§ge
(
r
->
–em’t
[2]->
¡r
,„->–em’t[2]->
Ën
);

2452 
	}
}

2465 
	$£Áš–S’dH–lo
(
£Áš–RedisIn¡ªû
 *
ri
) {

2466 

[
NET_IP_STR_LEN
];

2467 
·ylßd
[
NET_IP_STR_LEN
+1024];

2468 
»tv®
;

2469 *
ªnounû_
;

2470 
ªnounû_pÜt
;

2471 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?„i :„i->master;

2472 
£Áš–Addr
 *
ma¡”_addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ma¡”
);

2474 ià(
ri
->
lšk
->
discÚÃùed
è 
C_ERR
;

2478 ià(
£Áš–
.
ªnounû_
) {

2479 
ªnounû_
 = 
£Áš–
.announce_ip;

2481 ià(
	`ª‘SockName
(
ri
->
lšk
->
cc
->
c
.
fd
,

,(),
NULL
) == -1)

2482  
C_ERR
;

2483 
ªnounû_
 = 

;

2485 
ªnounû_pÜt
 = 
£Áš–
.announce_port ?

2486 
£Áš–
.
ªnounû_pÜt
 : 
£rv”
.
pÜt
;

2489 
	`¢´štf
(
·ylßd
,(payload),

2492 
ªnounû_
, 
ªnounû_pÜt
, 
£Áš–
.
myid
,

2493 (è
£Áš–
.
cu¼’t_•och
,

2495 
ma¡”
->
Çme
,
ma¡”_addr
->

,ma¡”_addr->
pÜt
,

2496 (è
ma¡”
->
cÚfig_•och
);

2497 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2498 
£Áš–PublishR•lyC®lback
, 
ri
, "PUBLISH %s %s",

2499 
SENTINEL_HELLO_CHANNEL
,
·ylßd
);

2500 ià(
»tv®
 !ğ
C_OK
è 
C_ERR
;

2501 
ri
->
lšk
->
³ndšg_commªds
++;

2502  
C_OK
;

2503 
	}
}

2507 
	$£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
) {

2508 
diùI‹¿tÜ
 *
di
;

2509 
diùEÁry
 *
de
;

2511 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
š¡ªûs
);

2512 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2513 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2514 ià(
ri
->
Ï¡_pub_time
 >ğ(
SENTINEL_PUBLISH_PERIOD
+1))

2515 
ri
->
Ï¡_pub_time
 -ğ(
SENTINEL_PUBLISH_PERIOD
+1);

2517 
	`diùR–—£I‹¿tÜ
(
di
);

2518 
	}
}

2528 
	$£Áš–FÜûH–loUpd©eFÜMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

2529 ià(!(
ma¡”
->
æags
 & 
SRI_MASTER
)è 
C_ERR
;

2530 ià(
ma¡”
->
Ï¡_pub_time
 >ğ(
SENTINEL_PUBLISH_PERIOD
+1))

2531 
ma¡”
->
Ï¡_pub_time
 -ğ(
SENTINEL_PUBLISH_PERIOD
+1);

2532 
	`£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
ma¡”
->
£Áš–s
);

2533 
	`£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
ma¡”
->
¦aves
);

2534  
C_OK
;

2535 
	}
}

2542 
	$£Áš–S’dPšg
(
£Áš–RedisIn¡ªû
 *
ri
) {

2543 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2544 
£Áš–PšgR•lyC®lback
, 
ri
, "PING");

2545 ià(
»tv®
 =ğ
C_OK
) {

2546 
ri
->
lšk
->
³ndšg_commªds
++;

2547 
ri
->
lšk
->
Ï¡_pšg_time
 = 
	`m¡ime
();

2551 ià(
ri
->
lšk
->
aù_pšg_time
 == 0)

2552 
ri
->
lšk
->
aù_pšg_time
 =„i->lšk->
Ï¡_pšg_time
;

2557 
	}
}

2561 
	$£Áš–S’dP”iodicCommªds
(
£Áš–RedisIn¡ªû
 *
ri
) {

2562 
m¡ime_t
 
now
 = 
	`m¡ime
();

2563 
m¡ime_t
 
šfo_³riod
, 
pšg_³riod
;

2564 
»tv®
;

2568 ià(
ri
->
lšk
->
discÚÃùed
) ;

2576 ià(
ri
->
lšk
->
³ndšg_commªds
 >=

2577 
SENTINEL_MAX_PENDING_COMMANDS
 * 
ri
->
lšk
->
»fcouÁ
) ;

2583 ià((
ri
->
æags
 & 
SRI_SLAVE
) &&

2584 (
ri
->
ma¡”
->
æags
 & (
SRI_O_DOWN
|
SRI_FAILOVER_IN_PROGRESS
))) {

2585 
šfo_³riod
 = 1000;

2587 
šfo_³riod
 = 
SENTINEL_INFO_PERIOD
;

2593 
pšg_³riod
 = 
ri
->
down_aá”_³riod
;

2594 ià(
pšg_³riod
 > 
SENTINEL_PING_PERIOD
)…ing_period = SENTINEL_PING_PERIOD;

2596 ià((
ri
->
æags
 & 
SRI_SENTINEL
) == 0 &&

2597 (
ri
->
šfo_»äesh
 == 0 ||

2598 (
now
 - 
ri
->
šfo_»äesh
è> 
šfo_³riod
))

2601 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2602 
£Áš–InfoR•lyC®lback
, 
ri
, "INFO");

2603 ià(
»tv®
 =ğ
C_OK
è
ri
->
lšk
->
³ndšg_commªds
++;

2604 } ià((
now
 - 
ri
->
lšk
->
Ï¡_pÚg_time
è> 
pšg_³riod
 &&

2605 (
now
 - 
ri
->
lšk
->
Ï¡_pšg_time
è> 
pšg_³riod
/2) {

2607 
	`£Áš–S’dPšg
(
ri
);

2608 } ià((
now
 - 
ri
->
Ï¡_pub_time
è> 
SENTINEL_PUBLISH_PERIOD
) {

2610 
	`£Áš–S’dH–lo
(
ri
);

2612 
	}
}

2616 cÚ¡ *
	$£Áš–Faov”S‹SŒ
(
¡©e
) {

2617 
¡©e
) {

2618 
SENTINEL_FAILOVER_STATE_NONE
:  "none";

2619 
SENTINEL_FAILOVER_STATE_WAIT_START
:  "wait_start";

2620 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
:  "select_slave";

2621 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
:  "send_slaveof_noone";

2622 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
:  "wait_promotion";

2623 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
:  "reconf_slaves";

2624 
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
:  "update_config";

2627 
	}
}

2630 
	$addR•lyS’tš–RedisIn¡ªû
(
ş›Á
 *
c
, 
£Áš–RedisIn¡ªû
 *
ri
) {

2631 *
æags
 = 
	`sd£m±y
();

2632 *
mbl
;

2633 
f›lds
 = 0;

2635 
mbl
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2637 
	`addR•lyBulkCSŒšg
(
c
,"name");

2638 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Çme
);

2639 
f›lds
++;

2641 
	`addR•lyBulkCSŒšg
(
c
,"ip");

2642 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
addr
->

);

2643 
f›lds
++;

2645 
	`addR•lyBulkCSŒšg
(
c
,"port");

2646 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
addr
->
pÜt
);

2647 
f›lds
++;

2649 
	`addR•lyBulkCSŒšg
(
c
,"runid");

2650 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
runid
 ?„i->runid : "");

2651 
f›lds
++;

2653 
	`addR•lyBulkCSŒšg
(
c
,"flags");

2654 ià(
ri
->
æags
 & 
SRI_S_DOWN
èæag ğ
	`sdsÿt
(flags,"s_down,");

2655 ià(
ri
->
æags
 & 
SRI_O_DOWN
èæag ğ
	`sdsÿt
(flags,"o_down,");

2656 ià(
ri
->
æags
 & 
SRI_MASTER
èæag ğ
	`sdsÿt
(flags,"master,");

2657 ià(
ri
->
æags
 & 
SRI_SLAVE
èæag ğ
	`sdsÿt
(flags,"slave,");

2658 ià(
ri
->
æags
 & 
SRI_SENTINEL
èæag ğ
	`sdsÿt
(flags,"sentinel,");

2659 ià(
ri
->
lšk
->
discÚÃùed
è
æags
 = 
	`sdsÿt
(flags,"disconnected,");

2660 ià(
ri
->
æags
 & 
SRI_MASTER_DOWN
èæag ğ
	`sdsÿt
(flags,"master_down,");

2661 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)

2662 
æags
 = 
	`sdsÿt
(flags,"failover_in_progress,");

2663 ià(
ri
->
æags
 & 
SRI_PROMOTED
èæag ğ
	`sdsÿt
(flags,"promoted,");

2664 ià(
ri
->
æags
 & 
SRI_RECONF_SENT
èæag ğ
	`sdsÿt
(flags,"reconf_sent,");

2665 ià(
ri
->
æags
 & 
SRI_RECONF_INPROG
èæag ğ
	`sdsÿt
(flags,"reconf_inprog,");

2666 ià(
ri
->
æags
 & 
SRI_RECONF_DONE
èæag ğ
	`sdsÿt
(flags,"reconf_done,");

2668 ià(
	`sd¦’
(
æags
è!ğ0è
	`sd¤ªge
(flags,0,-2);

2669 
	`addR•lyBulkCSŒšg
(
c
,
æags
);

2670 
	`sdsä“
(
æags
);

2671 
f›lds
++;

2673 
	`addR•lyBulkCSŒšg
(
c
,"link-pending-commands");

2674 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
lšk
->
³ndšg_commªds
);

2675 
f›lds
++;

2677 
	`addR•lyBulkCSŒšg
(
c
,"link-refcount");

2678 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
lšk
->
»fcouÁ
);

2679 
f›lds
++;

2681 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) {

2682 
	`addR•lyBulkCSŒšg
(
c
,"failover-state");

2683 
	`addR•lyBulkCSŒšg
(
c
,(*)
	`£Áš–Faov”S‹SŒ
(
ri
->
çov”_¡©e
));

2684 
f›lds
++;

2687 
	`addR•lyBulkCSŒšg
(
c
,"last-ping-sent");

2688 
	`addR•lyBulkLÚgLÚg
(
c
,

2689 
ri
->
lšk
->
aù_pšg_time
 ? (
	`m¡ime
() -„i->link->act_ping_time) : 0);

2690 
f›lds
++;

2692 
	`addR•lyBulkCSŒšg
(
c
,"last-ok-ping-reply");

2693 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_ava_time
);

2694 
f›lds
++;

2696 
	`addR•lyBulkCSŒšg
(
c
,"last-ping-reply");

2697 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_pÚg_time
);

2698 
f›lds
++;

2700 ià(
ri
->
æags
 & 
SRI_S_DOWN
) {

2701 
	`addR•lyBulkCSŒšg
(
c
,"s-down-time");

2702 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
()-
ri
->
s_down_sšû_time
);

2703 
f›lds
++;

2706 ià(
ri
->
æags
 & 
SRI_O_DOWN
) {

2707 
	`addR•lyBulkCSŒšg
(
c
,"o-down-time");

2708 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
()-
ri
->
o_down_sšû_time
);

2709 
f›lds
++;

2712 
	`addR•lyBulkCSŒšg
(
c
,"down-after-milliseconds");

2713 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
down_aá”_³riod
);

2714 
f›lds
++;

2717 ià(
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)) {

2718 
	`addR•lyBulkCSŒšg
(
c
,"info-refresh");

2719 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
šfo_»äesh
);

2720 
f›lds
++;

2722 
	`addR•lyBulkCSŒšg
(
c
,"role-reported");

2723 
	`addR•lyBulkCSŒšg
(
c
, (
ri
->
rŞe_»pÜ‹d
 =ğ
SRI_MASTER
) ? "master" :

2725 
f›lds
++;

2727 
	`addR•lyBulkCSŒšg
(
c
,"role-reported-time");

2728 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
);

2729 
f›lds
++;

2733 ià(
ri
->
æags
 & 
SRI_MASTER
) {

2734 
	`addR•lyBulkCSŒšg
(
c
,"config-epoch");

2735 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
cÚfig_•och
);

2736 
f›lds
++;

2738 
	`addR•lyBulkCSŒšg
(
c
,"num-slaves");

2739 
	`addR•lyBulkLÚgLÚg
(
c
,
	`diùSize
(
ri
->
¦aves
));

2740 
f›lds
++;

2742 
	`addR•lyBulkCSŒšg
(
c
,"num-other-sentinels");

2743 
	`addR•lyBulkLÚgLÚg
(
c
,
	`diùSize
(
ri
->
£Áš–s
));

2744 
f›lds
++;

2746 
	`addR•lyBulkCSŒšg
(
c
,"quorum");

2747 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
quÜum
);

2748 
f›lds
++;

2750 
	`addR•lyBulkCSŒšg
(
c
,"failover-timeout");

2751 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
çov”_timeout
);

2752 
f›lds
++;

2754 
	`addR•lyBulkCSŒšg
(
c
,"parallel-syncs");

2755 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
·¿Î–_syncs
);

2756 
f›lds
++;

2758 ià(
ri
->
nÙifiÿtiÚ_süt
) {

2759 
	`addR•lyBulkCSŒšg
(
c
,"notification-script");

2760 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
nÙifiÿtiÚ_süt
);

2761 
f›lds
++;

2764 ià(
ri
->
ş›Á_»cÚfig_süt
) {

2765 
	`addR•lyBulkCSŒšg
(
c
,"client-reconfig-script");

2766 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
ş›Á_»cÚfig_süt
);

2767 
f›lds
++;

2772 ià(
ri
->
æags
 & 
SRI_SLAVE
) {

2773 
	`addR•lyBulkCSŒšg
(
c
,"master-link-down-time");

2774 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
ma¡”_lšk_down_time
);

2775 
f›lds
++;

2777 
	`addR•lyBulkCSŒšg
(
c
,"master-link-status");

2778 
	`addR•lyBulkCSŒšg
(
c
,

2779 (
ri
->
¦ave_ma¡”_lšk_¡©us
 =ğ
SENTINEL_MASTER_LINK_STATUS_UP
) ?

2781 
f›lds
++;

2783 
	`addR•lyBulkCSŒšg
(
c
,"master-host");

2784 
	`addR•lyBulkCSŒšg
(
c
,

2785 
ri
->
¦ave_ma¡”_ho¡
 ?„i->slave_master_host : "?");

2786 
f›lds
++;

2788 
	`addR•lyBulkCSŒšg
(
c
,"master-port");

2789 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_ma¡”_pÜt
);

2790 
f›lds
++;

2792 
	`addR•lyBulkCSŒšg
(
c
,"slave-priority");

2793 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_´iÜ™y
);

2794 
f›lds
++;

2796 
	`addR•lyBulkCSŒšg
(
c
,"slave-repl-offset");

2797 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_»¶_off£t
);

2798 
f›lds
++;

2802 ià(
ri
->
æags
 & 
SRI_SENTINEL
) {

2803 
	`addR•lyBulkCSŒšg
(
c
,"last-hello-message");

2804 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
Ï¡_h–lo_time
);

2805 
f›lds
++;

2807 
	`addR•lyBulkCSŒšg
(
c
,"voted-leader");

2808 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Ëad”
 ?„i->leader : "?");

2809 
f›lds
++;

2811 
	`addR•lyBulkCSŒšg
(
c
,"voted-leader-epoch");

2812 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
Ëad”_•och
);

2813 
f›lds
++;

2816 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
mbl
,
f›lds
*2);

2817 
	}
}

2821 
	$addR•lyDiùOfRedisIn¡ªûs
(
ş›Á
 *
c
, 
diù
 *
š¡ªûs
) {

2822 
diùI‹¿tÜ
 *
di
;

2823 
diùEÁry
 *
de
;

2825 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

2826 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
š¡ªûs
));

2827 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2828 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2830 
	`addR•lyS’tš–RedisIn¡ªû
(
c
,
ri
);

2832 
	`diùR–—£I‹¿tÜ
(
di
);

2833 
	}
}

2838 
£Áš–RedisIn¡ªû
 *
	$£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
ş›Á
 *
c
,

2839 
robj
 *
Çme
)

2841 
£Áš–RedisIn¡ªû
 *
ri
;

2843 
ri
 = 
	`diùF‘chV®ue
(
£Áš–
.
ma¡”s
,
Çme
->
±r
);

2844 ià(!
ri
) {

2845 
	`addR•lyE¼Ü
(
c
,"No such master withhat‚ame");

2846  
NULL
;

2848  
ri
;

2849 
	}
}

2851 
	#SENTINEL_ISQR_OK
 0

	)

2852 
	#SENTINEL_ISQR_NOQUORUM
 (1<<0)

	)

2853 
	#SENTINEL_ISQR_NOAUTH
 (1<<1)

	)

2854 
	$£Áš–IsQuÜumR—chabË
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *
u§bË±r
) {

2855 
diùI‹¿tÜ
 *
di
;

2856 
diùEÁry
 *
de
;

2857 
u§bË
 = 1;

2858 
»suÉ
 = 
SENTINEL_ISQR_OK
;

2859 
vÙ”s
 = 
	`diùSize
(
ma¡”
->
£Áš–s
)+1;

2861 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

2862 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2863 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2865 ià(
ri
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
)) ;

2866 
u§bË
++;

2868 
	`diùR–—£I‹¿tÜ
(
di
);

2870 ià(
u§bË
 < ()
ma¡”
->
quÜum
è
»suÉ
 |ğ
SENTINEL_ISQR_NOQUORUM
;

2871 ià(
u§bË
 < 
vÙ”s
/2+1è
»suÉ
 |ğ
SENTINEL_ISQR_NOAUTH
;

2872 ià(
u§bË±r
è*u§bË±¸ğ
u§bË
;

2873  
»suÉ
;

2874 
	}
}

2876 
	$£Áš–Commªd
(
ş›Á
 *
c
) {

2877 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"masters")) {

2879 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

2880 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
£Áš–
.
ma¡”s
);

2881 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"master")) {

2883 
£Áš–RedisIn¡ªû
 *
ri
;

2885 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2886 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

2887 =ğ
NULL
) ;

2888 
	`addR•lyS’tš–RedisIn¡ªû
(
c
,
ri
);

2889 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"slaves")) {

2891 
£Áš–RedisIn¡ªû
 *
ri
;

2893 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2894 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2896 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
ri
->
¦aves
);

2897 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"sentinels")) {

2899 
£Áš–RedisIn¡ªû
 *
ri
;

2901 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2902 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2904 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
ri
->
£Áš–s
);

2905 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"is-master-down-by-addr")) {

2923 
£Áš–RedisIn¡ªû
 *
ri
;

2924 
»q_•och
;

2925 
ušt64_t
 
Ëad”_•och
 = 0;

2926 *
Ëad”
 = 
NULL
;

2927 
pÜt
;

2928 
isdown
 = 0;

2930 ià(
c
->
¬gc
 !ğ6è
num¬g£¼
;

2931 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
pÜt
,
NULL
è!ğ
C_OK
 ||

2932 
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
»q_•och
,
NULL
)

2933 !ğ
C_OK
)

2935 
ri
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
£Áš–
.
ma¡”s
,

2936 
c
->
¬gv
[2]->
±r
,
pÜt
,
NULL
);

2940 ià(!
£Áš–
.
tt
 && 
ri
 && (ri->
æags
 & 
SRI_S_DOWN
) &&

2941 (
ri
->
æags
 & 
SRI_MASTER
))

2942 
isdown
 = 1;

2946 ià(
ri
 &&„i->
æags
 & 
SRI_MASTER
 && 
	`¡rÿ£cmp
(
c
->
¬gv
[5]->
±r
,"*")) {

2947 
Ëad”
 = 
	`£Áš–VÙeL—d”
(
ri
,(
ušt64_t
)
»q_•och
,

2948 
c
->
¬gv
[5]->
±r
,

2949 &
Ëad”_•och
);

2954 
	`addR•lyMuÉiBulkL’
(
c
,3);

2955 
	`addR•ly
(
c
, 
isdown
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

2956 
	`addR•lyBulkCSŒšg
(
c
, 
Ëad”
 ?†eader : "*");

2957 
	`addR•lyLÚgLÚg
(
c
, ()
Ëad”_•och
);

2958 ià(
Ëad”
è
	`sdsä“
(leader);

2959 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reset")) {

2961 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2962 
	`addR•lyLÚgLÚg
(
c
,
	`£Áš–Re£tMa¡”sByP©‹º
(c->
¬gv
[2]->
±r
,
SENTINEL_GENERATE_EVENT
));

2963 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get-master-addr-by-name")) {

2965 
£Áš–RedisIn¡ªû
 *
ri
;

2967 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2968 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
c
->
¬gv
[2]->
±r
);

2969 ià(
ri
 =ğ
NULL
) {

2970 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

2972 
£Áš–Addr
 *
addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ri
);

2974 
	`addR•lyMuÉiBulkL’
(
c
,2);

2975 
	`addR•lyBulkCSŒšg
(
c
,
addr
->

);

2976 
	`addR•lyBulkLÚgLÚg
(
c
,
addr
->
pÜt
);

2978 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"failover")) {

2980 
£Áš–RedisIn¡ªû
 *
ri
;

2982 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2983 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2985 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) {

2986 
	`addR•lySds
(
c
,
	`sd¢ew
("-INPROG Failover‡lready in…rogress\r\n"));

2989 ià(
	`£Áš–S–eùSÏve
(
ri
è=ğ
NULL
) {

2990 
	`addR•lySds
(
c
,
	`sd¢ew
("-NOGOODSLAVE No suitable slaveo…romote\r\n"));

2993 
	`£rv”Log
(
LL_WARNING
,"Executing user„equested FAILOVER of '%s'",

2994 
ri
->
Çme
);

2995 
	`£Áš–S¹Faov”
(
ri
);

2996 
ri
->
æags
 |ğ
SRI_FORCE_FAILOVER
;

2997 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2998 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"pending-scripts")) {

3001 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

3002 
	`£Áš–P’dšgSütsCommªd
(
c
);

3003 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"monitor")) {

3005 
£Áš–RedisIn¡ªû
 *
ri
;

3006 
quÜum
, 
pÜt
;

3007 

[
NET_IP_STR_LEN
];

3009 ià(
c
->
¬gc
 !ğ6è
num¬g£¼
;

3010 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[5],&
quÜum
,"Invalid quorum")

3011 !ğ
C_OK
) ;

3012 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
pÜt
,"Invalid…ort")

3013 !ğ
C_OK
) ;

3015 ià(
quÜum
 <= 0) {

3016 
	`addR•lyE¼Ü
(
c
, "Quorum must be 1 or greater.");

3023 ià(
	`ª‘ResŞveIP
(
NULL
,
c
->
¬gv
[3]->
±r
,

,()è=ğ
ANET_ERR
) {

3024 
	`addR•lyE¼Ü
(
c
,"Invalid IP‡ddress specified");

3029 
ri
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
c
->
¬gv
[2]->
±r
,
SRI_MASTER
,

3030 
c
->
¬gv
[3]->
±r
,
pÜt
,
quÜum
,
NULL
);

3031 ià(
ri
 =ğ
NULL
) {

3032 
”ºo
) {

3033 
EBUSY
:

3034 
	`addR•lyE¼Ü
(
c
,"Duplicated master‚ame");

3036 
EINVAL
:

3037 
	`addR•lyE¼Ü
(
c
,"Invalid…ort‚umber");

3040 
	`addR•lyE¼Ü
(
c
,"Unspecifiedƒrror‡ddinghe instance");

3044 
	`£Áš–FlushCÚfig
();

3045 
	`£Áš–Ev’t
(
LL_WARNING
,"+mÚ™Ü",
ri
,"%@ quÜum %d",ri->
quÜum
);

3046 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3048 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"flushconfig")) {

3049 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

3050 
	`£Áš–FlushCÚfig
();

3051 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3053 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"remove")) {

3055 
£Áš–RedisIn¡ªû
 *
ri
;

3057 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

3058 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

3059 =ğ
NULL
) ;

3060 
	`£Áš–Ev’t
(
LL_WARNING
,"-mÚ™Ü",
ri
,"%@");

3061 
	`diùD–‘e
(
£Áš–
.
ma¡”s
,
c
->
¬gv
[2]->
±r
);

3062 
	`£Áš–FlushCÚfig
();

3063 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3064 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"ckquorum")) {

3066 
£Áš–RedisIn¡ªû
 *
ri
;

3067 
u§bË
;

3069 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

3070 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

3071 =ğ
NULL
) ;

3072 
»suÉ
 = 
	`£Áš–IsQuÜumR—chabË
(
ri
,&
u§bË
);

3073 ià(
»suÉ
 =ğ
SENTINEL_ISQR_OK
) {

3074 
	`addR•lySds
(
c
, 
	`sdsÿtfmt
(
	`sd£m±y
(),

3076 "ÿÀb»ached\r\n",
u§bË
));

3078 
sds
 
e
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),

3079 "-NOQUORUM %˜u§bË S’tš–s. ",
u§bË
);

3080 ià(
»suÉ
 & 
SENTINEL_ISQR_NOQUORUM
)

3081 
e
 = 
	`sdsÿt
(e,"Notƒnough‡vailable Sentinelso„eachhe"

3083 ià(
»suÉ
 & 
SENTINEL_ISQR_NOAUTH
) {

3084 ià(
»suÉ
 & 
SENTINEL_ISQR_NOQUORUM
è
e
 = 
	`sdsÿt
(e,". ");

3085 
e
 = 
	`sdsÿt
(e, "Notƒnough‡vailable Sentinelso„eachhe"

3088 
e
 = 
	`sdsÿt
(e,"\r\n");

3089 
	`addR•lySds
(
c
,
e
);

3091 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

3092 ià(
c
->
¬gc
 < 3 || c->¬gø% 2 =ğ0è
num¬g£¼
;

3093 
	`£Áš–S‘Commªd
(
c
);

3094 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"info-cache")) {

3096 ià(
c
->
¬gc
 < 2è
num¬g£¼
;

3097 
m¡ime_t
 
now
 = 
	`m¡ime
();

3102 
diùTy³
 
cİy_k“³r
 = 
š¡ªûsDiùTy³
;

3103 
cİy_k“³r
.
v®De¡ruùÜ
 = 
NULL
;

3104 
diù
 *
ma¡”s_loÿl
 = 
£Áš–
.
ma¡”s
;

3105 ià(
c
->
¬gc
 > 2) {

3106 
ma¡”s_loÿl
 = 
	`diùC»©e
(&
cİy_k“³r
, 
NULL
);

3108 
i
 = 2; i < 
c
->
¬gc
; i++) {

3109 
£Áš–RedisIn¡ªû
 *
ri
;

3110 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
c
->
¬gv
[
i
]->
±r
);

3111 ià(!
ri
) ;

3112 
	`diùAdd
(
ma¡”s_loÿl
, 
ri
->
Çme
,„i);

3124 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
ma¡”s_loÿl
) * 2);

3126 
diùI‹¿tÜ
 *
di
;

3127 
diùEÁry
 *
de
;

3128 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”s_loÿl
);

3129 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3130 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3131 
	`addR•lyBulkCBufãr
(
c
,
ri
->
Çme
,
	`¡¾’
(ri->name));

3132 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
ri
->
¦aves
) + 1);

3133 
	`addR•lyMuÉiBulkL’
(
c
,2);

3134 
	`addR•lyLÚgLÚg
(
c
, 
now
 - 
ri
->
šfo_»äesh
);

3135 ià(
ri
->
šfo
)

3136 
	`addR•lyBulkCBufãr
(
c
,
ri
->
šfo
,
	`sd¦’
(ri->info));

3138 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3140 
diùI‹¿tÜ
 *
sdi
;

3141 
diùEÁry
 *
sde
;

3142 
sdi
 = 
	`diùG‘I‹¿tÜ
(
ri
->
¦aves
);

3143 (
sde
 = 
	`diùNext
(
sdi
)è!ğ
NULL
) {

3144 
£Áš–RedisIn¡ªû
 *
¤i
 = 
	`diùG‘V®
(
sde
);

3145 
	`addR•lyMuÉiBulkL’
(
c
,2);

3146 
	`addR•lyLÚgLÚg
(
c
, 
now
 - 
¤i
->
šfo_»äesh
);

3147 ià(
¤i
->
šfo
)

3148 
	`addR•lyBulkCBufãr
(
c
,
¤i
->
šfo
,
	`sd¦’
(sri->info));

3150 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3152 
	`diùR–—£I‹¿tÜ
(
sdi
);

3154 
	`diùR–—£I‹¿tÜ
(
di
);

3155 ià(
ma¡”s_loÿl
 !ğ
£Áš–
.
ma¡”s
è
	`diùR–—£
(masters_local);

3156 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"simulate-failure")) {

3158 
j
;

3160 
£Áš–
.
simçu»_æags
 = 
SENTINEL_SIMFAILURE_NONE
;

3161 
j
 = 2; j < 
c
->
¬gc
; j++) {

3162 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"crash-after-election")) {

3163 
£Áš–
.
simçu»_æags
 |=

3164 
SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION
;

3165 
	`£rv”Log
(
LL_WARNING
,"Failure simulation:his Sentinel "

3168 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"crash-after-promotion")) {

3169 
£Áš–
.
simçu»_æags
 |=

3170 
SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION
;

3171 
	`£rv”Log
(
LL_WARNING
,"Failure simulation:his Sentinel "

3173 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"help")) {

3174 
	`addR•lyMuÉiBulkL’
(
c
,2);

3175 
	`addR•lyBulkCSŒšg
(
c
,"crash-after-election");

3176 
	`addR•lyBulkCSŒšg
(
c
,"crash-after-promotion");

3178 
	`addR•lyE¼Ü
(
c
,"Unknown failure simulation specified");

3182 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3184 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown sentinel subcommand '%s'",

3185 (*)
c
->
¬gv
[1]->
±r
);

3189 
num¬g£¼
:

3190 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for 'sentinel %s'",

3191 (*)
c
->
¬gv
[1]->
±r
);

3192 
	}
}

3194 
	#šfo_£ùiÚ_äom_»dis
(
£ùiÚ_Çme
) do { \

3195 ià(
def£ùiÚs
 || 
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,
£ùiÚ_Çme
)) { \

3196 
sds
 
»dis£ùiÚ
; \

3197 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n"); \

3198 
»dis£ùiÚ
 = 
	`g’RedisInfoSŒšg
(
£ùiÚ_Çme
); \

3199 
šfo
 = 
	`sdsÿ’
(šfo,
»dis£ùiÚ
,
	`sd¦’
(redissection)); \

3200 
	`sdsä“
(
»dis£ùiÚ
); \

3202 } 0)

	)

3205 
	$£Áš–InfoCommªd
(
ş›Á
 *
c
) {

3206 ià(
c
->
¬gc
 > 2) {

3207 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

3211 
def£ùiÚs
 = 0, 
®l£ùiÚs
 = 0;

3212 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : 
NULL
;

3213 ià(
£ùiÚ
) {

3214 
®l£ùiÚs
 = !
	`¡rÿ£cmp
(
£ùiÚ
,"all");

3215 
def£ùiÚs
 = !
	`¡rÿ£cmp
(
£ùiÚ
,"default");

3217 
def£ùiÚs
 = 1;

3220 
£ùiÚs
 = 0;

3221 
sds
 
šfo
 = 
	`sd£m±y
();

3223 
	`šfo_£ùiÚ_äom_»dis
("server");

3224 
	`šfo_£ùiÚ_äom_»dis
("clients");

3225 
	`šfo_£ùiÚ_äom_»dis
("cpu");

3226 
	`šfo_£ùiÚ_äom_»dis
("stats");

3228 ià(
def£ùiÚs
 || 
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"sentinel")) {

3229 
diùI‹¿tÜ
 *
di
;

3230 
diùEÁry
 *
de
;

3231 
ma¡”_id
 = 0;

3233 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3234 
šfo
 = 
	`sdsÿrštf
(info,

3241 
	`diùSize
(
£Áš–
.
ma¡”s
),

3242 
£Áš–
.
tt
,

3243 
£Áš–
.
ruÂšg_süts
,

3244 
	`li¡L’gth
(
£Áš–
.
süts_queue
),

3245 
£Áš–
.
simçu»_æags
);

3247 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

3248 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3249 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3250 *
¡©us
 = "ok";

3252 ià(
ri
->
æags
 & 
SRI_O_DOWN
è
¡©us
 = "odown";

3253 ià(
ri
->
æags
 & 
SRI_S_DOWN
è
¡©us
 = "sdown";

3254 
šfo
 = 
	`sdsÿrštf
(info,

3257 
ma¡”_id
++, 
ri
->
Çme
, 
¡©us
,

3258 
ri
->
addr
->

,„i->addr->
pÜt
,

3259 
	`diùSize
(
ri
->
¦aves
),

3260 
	`diùSize
(
ri
->
£Áš–s
)+1);

3262 
	`diùR–—£I‹¿tÜ
(
di
);

3265 
	`addR•lyBulkSds
(
c
, 
šfo
);

3266 
	}
}

3270 
	$£Áš–RŞeCommªd
(
ş›Á
 *
c
) {

3271 
diùI‹¿tÜ
 *
di
;

3272 
diùEÁry
 *
de
;

3274 
	`addR•lyMuÉiBulkL’
(
c
,2);

3275 
	`addR•lyBulkCBufãr
(
c
,"sentinel",8);

3276 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
£Áš–
.
ma¡”s
));

3278 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

3279 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3280 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3282 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Çme
);

3284 
	`diùR–—£I‹¿tÜ
(
di
);

3285 
	}
}

3288 
	$£Áš–S‘Commªd
(
ş›Á
 *
c
) {

3289 
£Áš–RedisIn¡ªû
 *
ri
;

3290 
j
, 
chªges
 = 0;

3291 *
İtiÚ
, *
v®ue
;

3293 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

3294 =ğ
NULL
) ;

3297 
j
 = 3; j < 
c
->
¬gc
; j += 2) {

3298 
İtiÚ
 = 
c
->
¬gv
[
j
]->
±r
;

3299 
v®ue
 = 
c
->
¬gv
[
j
+1]->
±r
;

3300 
robj
 *
o
 = 
c
->
¬gv
[
j
+1];

3301 
Î
;

3303 ià(!
	`¡rÿ£cmp
(
İtiÚ
,"down-after-milliseconds")) {

3305 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3306 
badfmt
;

3307 
ri
->
down_aá”_³riod
 = 
Î
;

3308 
	`£Áš–Prİag©eDownAá”P”iod
(
ri
);

3309 
chªges
++;

3310 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"failover-timeout")) {

3312 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3313 
badfmt
;

3314 
ri
->
çov”_timeout
 = 
Î
;

3315 
chªges
++;

3316 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"parallel-syncs")) {

3318 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3319 
badfmt
;

3320 
ri
->
·¿Î–_syncs
 = 
Î
;

3321 
chªges
++;

3322 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"notification-script")) {

3324 ià(
	`¡¾’
(
v®ue
è&& 
	`acûss
(v®ue,
X_OK
) == -1) {

3325 
	`addR•lyE¼Ü
(
c
,

3327 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3330 
	`sdsä“
(
ri
->
nÙifiÿtiÚ_süt
);

3331 
ri
->
nÙifiÿtiÚ_süt
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

3332 
chªges
++;

3333 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"client-reconfig-script")) {

3335 ià(
	`¡¾’
(
v®ue
è&& 
	`acûss
(v®ue,
X_OK
) == -1) {

3336 
	`addR•lyE¼Ü
(
c
,

3339 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3342 
	`sdsä“
(
ri
->
ş›Á_»cÚfig_süt
);

3343 
ri
->
ş›Á_»cÚfig_süt
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

3344 
chªges
++;

3345 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"auth-pass")) {

3347 
	`sdsä“
(
ri
->
auth_·ss
);

3348 
ri
->
auth_·ss
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

3349 
chªges
++;

3350 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"quorum")) {

3352 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3353 
badfmt
;

3354 
ri
->
quÜum
 = 
Î
;

3355 
chªges
++;

3357 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown option '%s' for SENTINEL SET",

3358 
İtiÚ
);

3359 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3362 
	`£Áš–Ev’t
(
LL_WARNING
,"+£t",
ri
,"%@ % %s",
İtiÚ
,
v®ue
);

3365 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3366 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3369 
badfmt
:

3370 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3371 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for SENTINEL SET '%s'",

3372 
v®ue
, 
İtiÚ
);

3373 
	}
}

3381 
	$£Áš–PublishCommªd
(
ş›Á
 *
c
) {

3382 ià(
	`¡rcmp
(
c
->
¬gv
[1]->
±r
,
SENTINEL_HELLO_CHANNEL
)) {

3383 
	`addR•lyE¼Ü
(
c
, "Only HELLO messages‡re‡ccepted by Sentinel instances.");

3386 
	`£Áš–ProûssH–loMes§ge
(
c
->
¬gv
[2]->
±r
,
	`sd¦’
(c->argv[2]->ptr));

3387 
	`addR•lyLÚgLÚg
(
c
,1);

3388 
	}
}

3393 
	$£Áš–CheckSubjeùiv–yDown
(
£Áš–RedisIn¡ªû
 *
ri
) {

3394 
m¡ime_t
 
–­£d
 = 0;

3396 ià(
ri
->
lšk
->
aù_pšg_time
)

3397 
–­£d
 = 
	`m¡ime
(è- 
ri
->
lšk
->
aù_pšg_time
;

3398 ià(
ri
->
lšk
->
discÚÃùed
)

3399 
–­£d
 = 
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_ava_time
;

3407 ià(
ri
->
lšk
->
cc
 &&

3408 (
	`m¡ime
(è- 
ri
->
lšk
->
cc_cÚn_time
) >

3409 
SENTINEL_MIN_LINK_RECONNECT_PERIOD
 &&

3410 
ri
->
lšk
->
aù_pšg_time
 != 0 &&

3413 (
	`m¡ime
(è- 
ri
->
lšk
->
aù_pšg_time
è> (ri->
down_aá”_³riod
/2) &&

3414 (
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_pÚg_time
è> (ri->
down_aá”_³riod
/2))

3416 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
cc
);

3424 ià(
ri
->
lšk
->
pc
 &&

3425 (
	`m¡ime
(è- 
ri
->
lšk
->
pc_cÚn_time
) >

3426 
SENTINEL_MIN_LINK_RECONNECT_PERIOD
 &&

3427 (
	`m¡ime
(è- 
ri
->
lšk
->
pc_Ï¡_aùiv™y
è> (
SENTINEL_PUBLISH_PERIOD
*3))

3429 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
pc
);

3438 ià(
–­£d
 > 
ri
->
down_aá”_³riod
 ||

3439 (
ri
->
æags
 & 
SRI_MASTER
 &&

3440 
ri
->
rŞe_»pÜ‹d
 =ğ
SRI_SLAVE
 &&

3441 
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
 >

3442 (
ri
->
down_aá”_³riod
+
SENTINEL_INFO_PERIOD
*2)))

3445 ià((
ri
->
æags
 & 
SRI_S_DOWN
) == 0) {

3446 
	`£Áš–Ev’t
(
LL_WARNING
,"+sdown",
ri
,"%@");

3447 
ri
->
s_down_sšû_time
 = 
	`m¡ime
();

3448 
ri
->
æags
 |ğ
SRI_S_DOWN
;

3452 ià(
ri
->
æags
 & 
SRI_S_DOWN
) {

3453 
	`£Áš–Ev’t
(
LL_WARNING
,"-sdown",
ri
,"%@");

3454 
ri
->
æags
 &ğ~(
SRI_S_DOWN
|
SRI_SCRIPT_KILL_SENT
);

3457 
	}
}

3465 
	$£Áš–CheckObjeùiv–yDown
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3466 
diùI‹¿tÜ
 *
di
;

3467 
diùEÁry
 *
de
;

3468 
quÜum
 = 0, 
odown
 = 0;

3470 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
) {

3472 
quÜum
 = 1;

3474 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3475 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3476 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3478 ià(
ri
->
æags
 & 
SRI_MASTER_DOWN
è
quÜum
++;

3480 
	`diùR–—£I‹¿tÜ
(
di
);

3481 ià(
quÜum
 >ğ
ma¡”
->quÜumè
odown
 = 1;

3485 ià(
odown
) {

3486 ià((
ma¡”
->
æags
 & 
SRI_O_DOWN
) == 0) {

3487 
	`£Áš–Ev’t
(
LL_WARNING
,"+odown",
ma¡”
,"%@ #quorum %d/%d",

3488 
quÜum
, 
ma¡”
->quorum);

3489 
ma¡”
->
æags
 |ğ
SRI_O_DOWN
;

3490 
ma¡”
->
o_down_sšû_time
 = 
	`m¡ime
();

3493 ià(
ma¡”
->
æags
 & 
SRI_O_DOWN
) {

3494 
	`£Áš–Ev’t
(
LL_WARNING
,"-odown",
ma¡”
,"%@");

3495 
ma¡”
->
æags
 &ğ~
SRI_O_DOWN
;

3498 
	}
}

3502 
	$£Áš–ReûiveIsMa¡”DownR•ly
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

3503 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

3504 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

3505 
»disR•ly
 *
r
;

3507 ià(!
»¶y
 || !
lšk
) ;

3508 
lšk
->
³ndšg_commªds
--;

3509 
r
 = 
»¶y
;

3514 ià(
r
->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&„->
–em’ts
 == 3 &&

3515 
r
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

3516 
r
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

3517 
r
->
–em’t
[2]->
ty³
 =ğ
REDIS_REPLY_INTEGER
)

3519 
ri
->
Ï¡_ma¡”_down_»¶y_time
 = 
	`m¡ime
();

3520 ià(
r
->
–em’t
[0]->
š‹g”
 == 1) {

3521 
ri
->
æags
 |ğ
SRI_MASTER_DOWN
;

3523 
ri
->
æags
 &ğ~
SRI_MASTER_DOWN
;

3525 ià(
	`¡rcmp
(
r
->
–em’t
[1]->
¡r
,"*")) {

3528 
	`sdsä“
(
ri
->
Ëad”
);

3529 ià(()
ri
->
Ëad”_•och
 !ğ
r
->
–em’t
[2]->
š‹g”
)

3530 
	`£rv”Log
(
LL_WARNING
,

3531 "% vÙed fÜ % %Îu", 
ri
->
Çme
,

3532 
r
->
–em’t
[1]->
¡r
,

3533 (è
r
->
–em’t
[2]->
š‹g”
);

3534 
ri
->
Ëad”
 = 
	`sd¢ew
(
r
->
–em’t
[1]->
¡r
);

3535 
ri
->
Ëad”_•och
 = 
r
->
–em’t
[2]->
š‹g”
;

3538 
	}
}

3544 
	#SENTINEL_ASK_FORCED
 (1<<0)

	)

3545 
	$£Áš–AskMa¡”S‹ToOth”S’tš–s
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
æags
) {

3546 
diùI‹¿tÜ
 *
di
;

3547 
diùEÁry
 *
de
;

3549 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3550 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3551 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3552 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
ri
->
Ï¡_ma¡”_down_»¶y_time
;

3553 
pÜt
[32];

3554 
»tv®
;

3557 ià(
–­£d
 > 
SENTINEL_ASK_PERIOD
*5) {

3558 
ri
->
æags
 &ğ~
SRI_MASTER_DOWN
;

3559 
	`sdsä“
(
ri
->
Ëad”
);

3560 
ri
->
Ëad”
 = 
NULL
;

3568 ià((
ma¡”
->
æags
 & 
SRI_S_DOWN
) == 0) ;

3569 ià(
ri
->
lšk
->
discÚÃùed
) ;

3570 ià(!(
æags
 & 
SENTINEL_ASK_FORCED
) &&

3571 
	`m¡ime
(è- 
ri
->
Ï¡_ma¡”_down_»¶y_time
 < 
SENTINEL_ASK_PERIOD
)

3575 
	`Î2¡ršg
(
pÜt
,ÕÜt),
ma¡”
->
addr
->port);

3576 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3577 
£Áš–ReûiveIsMa¡”DownR•ly
, 
ri
,

3579 
ma¡”
->
addr
->

, 
pÜt
,

3580 
£Áš–
.
cu¼’t_•och
,

3581 (
ma¡”
->
çov”_¡©e
 > 
SENTINEL_FAILOVER_STATE_NONE
) ?

3582 
£Áš–
.
myid
 : "*");

3583 ià(
»tv®
 =ğ
C_OK
è
ri
->
lšk
->
³ndšg_commªds
++;

3585 
	`diùR–—£I‹¿tÜ
(
di
);

3586 
	}
}

3591 
	$£Áš–SimFau»C¿sh
() {

3592 
	`£rv”Log
(
LL_WARNING
,

3594 
	`ex™
(99);

3595 
	}
}

3602 *
	$£Áš–VÙeL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
»q_•och
, *
»q_runid
, ušt64_ˆ*
Ëad”_•och
) {

3603 ià(
»q_•och
 > 
£Áš–
.
cu¼’t_•och
) {

3604 
£Áš–
.
cu¼’t_•och
 = 
»q_•och
;

3605 
	`£Áš–FlushCÚfig
();

3606 
	`£Áš–Ev’t
(
LL_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

3607 (è
£Áš–
.
cu¼’t_•och
);

3610 ià(
ma¡”
->
Ëad”_•och
 < 
»q_•och
 && 
£Áš–
.
cu¼’t_•och
 <=„eq_epoch)

3612 
	`sdsä“
(
ma¡”
->
Ëad”
);

3613 
ma¡”
->
Ëad”
 = 
	`sd¢ew
(
»q_runid
);

3614 
ma¡”
->
Ëad”_•och
 = 
£Áš–
.
cu¼’t_•och
;

3615 
	`£Áš–FlushCÚfig
();

3616 
	`£Áš–Ev’t
(
LL_WARNING
,"+vÙe-fÜ-Ëad”",
ma¡”
,"%s %llu",

3617 
ma¡”
->
Ëad”
, (èma¡”->
Ëad”_•och
);

3621 ià(
	`¡rÿ£cmp
(
ma¡”
->
Ëad”
,
£Áš–
.
myid
))

3622 
ma¡”
->
çov”_¡¬t_time
 = 
	`m¡ime
()+
	`¿nd
()%
SENTINEL_MAX_DESYNC
;

3625 *
Ëad”_•och
 = 
ma¡”
->leader_epoch;

3626  
ma¡”
->
Ëad”
 ? 
	`sd¢ew
(ma¡”->Ëad”è: 
NULL
;

3627 
	}
}

3629 
	s£Áš–L—d”
 {

3630 *
	mrunid
;

3631 
	mvÙes
;

3636 
	$£Áš–L—d”Inü
(
diù
 *
couÁ”s
, *
runid
) {

3637 
diùEÁry
 *
de
 = 
	`diùFšd
(
couÁ”s
,
runid
);

3638 
ušt64_t
 
Şdv®
;

3640 ià(
de
) {

3641 
Şdv®
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

3642 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,
Şdv®
+1);

3643  
Şdv®
+1;

3645 
de
 = 
	`diùAddRaw
(
couÁ”s
,
runid
);

3646 
	`£rv”As£¹
(
de
 !ğ
NULL
);

3647 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,1);

3650 
	}
}

3658 *
	$£Áš–G‘L—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
•och
) {

3659 
diù
 *
couÁ”s
;

3660 
diùI‹¿tÜ
 *
di
;

3661 
diùEÁry
 *
de
;

3662 
vÙ”s
 = 0, 
vÙ”s_quÜum
;

3663 *
myvÙe
;

3664 *
wšÃr
 = 
NULL
;

3665 
ušt64_t
 
Ëad”_•och
;

3666 
ušt64_t
 
max_vÙes
 = 0;

3668 
	`£rv”As£¹
(
ma¡”
->
æags
 & (
SRI_O_DOWN
|
SRI_FAILOVER_IN_PROGRESS
));

3669 
couÁ”s
 = 
	`diùC»©e
(&
Ëad”VÙesDiùTy³
,
NULL
);

3671 
vÙ”s
 = 
	`diùSize
(
ma¡”
->
£Áš–s
)+1;

3674 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3675 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3676 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3677 ià(
ri
->
Ëad”
 !ğ
NULL
 &&„i->
Ëad”_•och
 =ğ
£Áš–
.
cu¼’t_•och
)

3678 
	`£Áš–L—d”Inü
(
couÁ”s
,
ri
->
Ëad”
);

3680 
	`diùR–—£I‹¿tÜ
(
di
);

3685 
di
 = 
	`diùG‘I‹¿tÜ
(
couÁ”s
);

3686 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3687 
ušt64_t
 
vÙes
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

3689 ià(
vÙes
 > 
max_vÙes
) {

3690 
max_vÙes
 = 
vÙes
;

3691 
wšÃr
 = 
	`diùG‘Key
(
de
);

3694 
	`diùR–—£I‹¿tÜ
(
di
);

3699 ià(
wšÃr
)

3700 
myvÙe
 = 
	`£Áš–VÙeL—d”
(
ma¡”
,
•och
,
wšÃr
,&
Ëad”_•och
);

3702 
myvÙe
 = 
	`£Áš–VÙeL—d”
(
ma¡”
,
•och
,
£Áš–
.
myid
,&
Ëad”_•och
);

3704 ià(
myvÙe
 && 
Ëad”_•och
 =ğ
•och
) {

3705 
ušt64_t
 
vÙes
 = 
	`£Áš–L—d”Inü
(
couÁ”s
,
myvÙe
);

3707 ià(
vÙes
 > 
max_vÙes
) {

3708 
max_vÙes
 = 
vÙes
;

3709 
wšÃr
 = 
myvÙe
;

3713 
vÙ”s_quÜum
 = 
vÙ”s
/2+1;

3714 ià(
wšÃr
 && (
max_vÙes
 < 
vÙ”s_quÜum
 || max_vÙe < 
ma¡”
->
quÜum
))

3715 
wšÃr
 = 
NULL
;

3717 
wšÃr
 = wšÃ¸? 
	`sd¢ew
(wšÃrè: 
NULL
;

3718 
	`sdsä“
(
myvÙe
);

3719 
	`diùR–—£
(
couÁ”s
);

3720  
wšÃr
;

3721 
	}
}

3733 
	$£Áš–S’dSÏveOf
(
£Áš–RedisIn¡ªû
 *
ri
, *
ho¡
, 
pÜt
) {

3734 
pÜt¡r
[32];

3735 
»tv®
;

3737 
	`Î2¡ršg
(
pÜt¡r
,ÕÜt¡r),
pÜt
);

3741 ià(
ho¡
 =ğ
NULL
) {

3742 
ho¡
 = "NO";

3743 
	`memıy
(
pÜt¡r
,"ONE",4);

3756 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3757 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "MULTI");

3758 ià(
»tv®
 =ğ
C_ERR
) „etval;

3759 
ri
->
lšk
->
³ndšg_commªds
++;

3761 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3762 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "SLAVEOF % %s", 
ho¡
, 
pÜt¡r
);

3763 ià(
»tv®
 =ğ
C_ERR
) „etval;

3764 
ri
->
lšk
->
³ndšg_commªds
++;

3766 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3767 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "CONFIG REWRITE");

3768 ià(
»tv®
 =ğ
C_ERR
) „etval;

3769 
ri
->
lšk
->
³ndšg_commªds
++;

3776 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3777 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "CLIENT KILL TYPE‚ormal");

3778 ià(
»tv®
 =ğ
C_ERR
) „etval;

3779 
ri
->
lšk
->
³ndšg_commªds
++;

3781 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3782 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "EXEC");

3783 ià(
»tv®
 =ğ
C_ERR
) „etval;

3784 
ri
->
lšk
->
³ndšg_commªds
++;

3786  
C_OK
;

3787 
	}
}

3790 
	$£Áš–S¹Faov”
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3791 
	`£rv”As£¹
(
ma¡”
->
æags
 & 
SRI_MASTER
);

3793 
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_WAIT_START
;

3794 
ma¡”
->
æags
 |ğ
SRI_FAILOVER_IN_PROGRESS
;

3795 
ma¡”
->
çov”_•och
 = ++
£Áš–
.
cu¼’t_•och
;

3796 
	`£Áš–Ev’t
(
LL_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

3797 (è
£Áš–
.
cu¼’t_•och
);

3798 
	`£Áš–Ev’t
(
LL_WARNING
,"+Œy-çov”",
ma¡”
,"%@");

3799 
ma¡”
->
çov”_¡¬t_time
 = 
	`m¡ime
()+
	`¿nd
()%
SENTINEL_MAX_DESYNC
;

3800 
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3801 
	}
}

3814 
	$£Áš–S¹Faov”IfN“ded
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3816 ià(!(
ma¡”
->
æags
 & 
SRI_O_DOWN
))  0;

3819 ià(
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)  0;

3822 ià(
	`m¡ime
(è- 
ma¡”
->
çov”_¡¬t_time
 <

3823 
ma¡”
->
çov”_timeout
*2)

3825 ià(
ma¡”
->
çov”_d–ay_logged
 !ğma¡”->
çov”_¡¬t_time
) {

3826 
time_t
 
şock
 = (
ma¡”
->
çov”_¡¬t_time
 +

3827 
ma¡”
->
çov”_timeout
*2) / 1000;

3828 
ùimebuf
[26];

3830 
	`ùime_r
(&
şock
,
ùimebuf
);

3831 
ùimebuf
[24] = '\0';

3832 
ma¡”
->
çov”_d–ay_logged
 = ma¡”->
çov”_¡¬t_time
;

3833 
	`£rv”Log
(
LL_WARNING
,

3835 
ùimebuf
);

3840 
	`£Áš–S¹Faov”
(
ma¡”
);

3842 
	}
}

3876 
	$com·»SÏvesFÜPromÙiÚ
(cÚ¡ *
a
, cÚ¡ *
b
) {

3877 
£Áš–RedisIn¡ªû
 **
§
 = (£Áš–RedisIn¡ªû **)
a
,

3878 **
sb
 = (
£Áš–RedisIn¡ªû
 **)
b
;

3879 *
§_runid
, *
sb_runid
;

3881 ià((*
§
)->
¦ave_´iÜ™y
 !ğ(*
sb
)->slave_priority)

3882  (*
§
)->
¦ave_´iÜ™y
 - (*
sb
)->slave_priority;

3886 ià((*
§
)->
¦ave_»¶_off£t
 > (*
sb
)->slave_repl_offset) {

3888 } ià((*
§
)->
¦ave_»¶_off£t
 < (*
sb
)->slave_repl_offset) {

3896 
§_runid
 = (*
§
)->
runid
;

3897 
sb_runid
 = (*
sb
)->
runid
;

3898 ià(
§_runid
 =ğ
NULL
 && 
sb_runid
 == NULL)  0;

3899 ià(
§_runid
 =ğ
NULL
)  1;

3900 ià(
sb_runid
 =ğ
NULL
)  -1;

3901  
	`¡rÿ£cmp
(
§_runid
, 
sb_runid
);

3902 
	}
}

3904 
£Áš–RedisIn¡ªû
 *
	$£Áš–S–eùSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3905 
£Áš–RedisIn¡ªû
 **
š¡ªû
 =

3906 
	`zm®loc
((
š¡ªû
[0])*
	`diùSize
(
ma¡”
->
¦aves
));

3907 
£Áš–RedisIn¡ªû
 *
£Ëùed
 = 
NULL
;

3908 
š¡ªûs
 = 0;

3909 
diùI‹¿tÜ
 *
di
;

3910 
diùEÁry
 *
de
;

3911 
m¡ime_t
 
max_ma¡”_down_time
 = 0;

3913 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
)

3914 
max_ma¡”_down_time
 +ğ
	`m¡ime
(è- 
ma¡”
->
s_down_sšû_time
;

3915 
max_ma¡”_down_time
 +ğ
ma¡”
->
down_aá”_³riod
 * 10;

3917 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

3918 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3919 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

3920 
m¡ime_t
 
šfo_v®id™y_time
;

3922 ià(
¦ave
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
)) ;

3923 ià(
¦ave
->
lšk
->
discÚÃùed
) ;

3924 ià(
	`m¡ime
(è- 
¦ave
->
lšk
->
Ï¡_ava_time
 > 
SENTINEL_PING_PERIOD
*5) ;

3925 ià(
¦ave
->
¦ave_´iÜ™y
 == 0) ;

3930 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
)

3931 
šfo_v®id™y_time
 = 
SENTINEL_PING_PERIOD
*5;

3933 
šfo_v®id™y_time
 = 
SENTINEL_INFO_PERIOD
*3;

3934 ià(
	`m¡ime
(è- 
¦ave
->
šfo_»äesh
 > 
šfo_v®id™y_time
) ;

3935 ià(
¦ave
->
ma¡”_lšk_down_time
 > 
max_ma¡”_down_time
) ;

3936 
š¡ªû
[
š¡ªûs
++] = 
¦ave
;

3938 
	`diùR–—£I‹¿tÜ
(
di
);

3939 ià(
š¡ªûs
) {

3940 
	`qsÜt
(
š¡ªû
,
š¡ªûs
,(
£Áš–RedisIn¡ªû
*),

3941 
com·»SÏvesFÜPromÙiÚ
);

3942 
£Ëùed
 = 
š¡ªû
[0];

3944 
	`zä“
(
š¡ªû
);

3945  
£Ëùed
;

3946 
	}
}

3949 
	$£Áš–Faov”Wa™S¹
(
£Áš–RedisIn¡ªû
 *
ri
) {

3950 *
Ëad”
;

3951 
i¦—d”
;

3954 
Ëad”
 = 
	`£Áš–G‘L—d”
(
ri
,„i->
çov”_•och
);

3955 
i¦—d”
 = 
Ëad”
 && 
	`¡rÿ£cmp
Ö—d”,
£Áš–
.
myid
) == 0;

3956 
	`sdsä“
(
Ëad”
);

3960 ià(!
i¦—d”
 && !(
ri
->
æags
 & 
SRI_FORCE_FAILOVER
)) {

3961 
–eùiÚ_timeout
 = 
SENTINEL_ELECTION_TIMEOUT
;

3965 ià(
–eùiÚ_timeout
 > 
ri
->
çov”_timeout
)

3966 
–eùiÚ_timeout
 = 
ri
->
çov”_timeout
;

3968 ià(
	`m¡ime
(è- 
ri
->
çov”_¡¬t_time
 > 
–eùiÚ_timeout
) {

3969 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-nÙ-–eùed",
ri
,"%@");

3970 
	`£Áš–AbÜtFaov”
(
ri
);

3974 
	`£Áš–Ev’t
(
LL_WARNING
,"+–eùed-Ëad”",
ri
,"%@");

3975 ià(
£Áš–
.
simçu»_æags
 & 
SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION
)

3976 
	`£Áš–SimFau»C¿sh
();

3977 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
;

3978 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3979 
	`£Áš–Ev’t
(
LL_WARNING
,"+çov”-¡©e-£Ëù-¦ave",
ri
,"%@");

3980 
	}
}

3982 
	$£Áš–Faov”S–eùSÏve
(
£Áš–RedisIn¡ªû
 *
ri
) {

3983 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`£Áš–S–eùSÏve
(
ri
);

3987 ià(
¦ave
 =ğ
NULL
) {

3988 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-no-good-¦ave",
ri
,"%@");

3989 
	`£Áš–AbÜtFaov”
(
ri
);

3991 
	`£Áš–Ev’t
(
LL_WARNING
,"+£Ëùed-¦ave",
¦ave
,"%@");

3992 
¦ave
->
æags
 |ğ
SRI_PROMOTED
;

3993 
ri
->
´omÙed_¦ave
 = 
¦ave
;

3994 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
;

3995 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3996 
	`£Áš–Ev’t
(
LL_NOTICE
,"+failover-state-send-slaveof-noone",

3997 
¦ave
, "%@");

3999 
	}
}

4001 
	$£Áš–Faov”S’dSÏveOfNoOÃ
(
£Áš–RedisIn¡ªû
 *
ri
) {

4002 
»tv®
;

4007 ià(
ri
->
´omÙed_¦ave
->
lšk
->
discÚÃùed
) {

4008 ià(
	`m¡ime
(è- 
ri
->
çov”_¡©e_chªge_time
 >„i->
çov”_timeout
) {

4009 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-¦ave-timeout",
ri
,"%@");

4010 
	`£Áš–AbÜtFaov”
(
ri
);

4019 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
->
´omÙed_¦ave
,
NULL
,0);

4020 ià(
»tv®
 !ğ
C_OK
) ;

4021 
	`£Áš–Ev’t
(
LL_NOTICE
, "+failover-state-wait-promotion",

4022 
ri
->
´omÙed_¦ave
,"%@");

4023 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
;

4024 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4025 
	}
}

4029 
	$£Áš–Faov”Wa™PromÙiÚ
(
£Áš–RedisIn¡ªû
 *
ri
) {

4032 ià(
	`m¡ime
(è- 
ri
->
çov”_¡©e_chªge_time
 >„i->
çov”_timeout
) {

4033 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-¦ave-timeout",
ri
,"%@");

4034 
	`£Áš–AbÜtFaov”
(
ri
);

4036 
	}
}

4038 
	$£Áš–Faov”D‘eùEnd
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

4039 
nÙ_»cÚfigu»d
 = 0, 
timeout
 = 0;

4040 
diùI‹¿tÜ
 *
di
;

4041 
diùEÁry
 *
de
;

4042 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
ma¡”
->
çov”_¡©e_chªge_time
;

4046 ià(
ma¡”
->
´omÙed_¦ave
 =ğ
NULL
 ||

4047 
ma¡”
->
´omÙed_¦ave
->
æags
 & 
SRI_S_DOWN
) ;

4051 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4052 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4053 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4055 ià(
¦ave
->
æags
 & (
SRI_PROMOTED
|
SRI_RECONF_DONE
)) ;

4056 ià(
¦ave
->
æags
 & 
SRI_S_DOWN
) ;

4057 
nÙ_»cÚfigu»d
++;

4059 
	`diùR–—£I‹¿tÜ
(
di
);

4062 ià(
–­£d
 > 
ma¡”
->
çov”_timeout
) {

4063 
nÙ_»cÚfigu»d
 = 0;

4064 
timeout
 = 1;

4065 
	`£Áš–Ev’t
(
LL_WARNING
,"+çov”-’d-fÜ-timeout",
ma¡”
,"%@");

4068 ià(
nÙ_»cÚfigu»d
 == 0) {

4069 
	`£Áš–Ev’t
(
LL_WARNING
,"+çov”-’d",
ma¡”
,"%@");

4070 
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
;

4071 
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4077 ià(
timeout
) {

4078 
diùI‹¿tÜ
 *
di
;

4079 
diùEÁry
 *
de
;

4081 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4082 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4083 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4084 
»tv®
;

4086 ià(
¦ave
->
æags
 & (
SRI_RECONF_DONE
|
SRI_RECONF_SENT
)) ;

4087 ià(
¦ave
->
lšk
->
discÚÃùed
) ;

4089 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
¦ave
,

4090 
ma¡”
->
´omÙed_¦ave
->
addr
->

,

4091 
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
);

4092 ià(
»tv®
 =ğ
C_OK
) {

4093 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-£Á-be",
¦ave
,"%@");

4094 
¦ave
->
æags
 |ğ
SRI_RECONF_SENT
;

4097 
	`diùR–—£I‹¿tÜ
(
di
);

4099 
	}
}

4103 
	$£Áš–Faov”RecÚfNextSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

4104 
diùI‹¿tÜ
 *
di
;

4105 
diùEÁry
 *
de
;

4106 
š_´og»ss
 = 0;

4108 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4109 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4110 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4112 ià(
¦ave
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
))

4113 
š_´og»ss
++;

4115 
	`diùR–—£I‹¿tÜ
(
di
);

4117 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4118 
š_´og»ss
 < 
ma¡”
->
·¿Î–_syncs
 &&

4119 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

4121 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4122 
»tv®
;

4125 ià(
¦ave
->
æags
 & (
SRI_PROMOTED
|
SRI_RECONF_DONE
)) ;

4131 ià((
¦ave
->
æags
 & 
SRI_RECONF_SENT
) &&

4132 (
	`m¡ime
(è- 
¦ave
->
¦ave_»cÚf_£Á_time
) >

4133 
SENTINEL_SLAVE_RECONF_TIMEOUT
)

4135 
	`£Áš–Ev’t
(
LL_NOTICE
,"-¦ave-»cÚf-£Á-timeout",
¦ave
,"%@");

4136 
¦ave
->
æags
 &ğ~
SRI_RECONF_SENT
;

4137 
¦ave
->
æags
 |ğ
SRI_RECONF_DONE
;

4142 ià(
¦ave
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
)) ;

4143 ià(
¦ave
->
lšk
->
discÚÃùed
) ;

4146 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
¦ave
,

4147 
ma¡”
->
´omÙed_¦ave
->
addr
->

,

4148 
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
);

4149 ià(
»tv®
 =ğ
C_OK
) {

4150 
¦ave
->
æags
 |ğ
SRI_RECONF_SENT
;

4151 
¦ave
->
¦ave_»cÚf_£Á_time
 = 
	`m¡ime
();

4152 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-£Á",
¦ave
,"%@");

4153 
š_´og»ss
++;

4156 
	`diùR–—£I‹¿tÜ
(
di
);

4159 
	`£Áš–Faov”D‘eùEnd
(
ma¡”
);

4160 
	}
}

4165 
	$£Áš–Faov”Sw™chToPromÙedSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

4166 
£Áš–RedisIn¡ªû
 *
»f
 = 
ma¡”
->
´omÙed_¦ave
 ?

4167 
ma¡”
->
´omÙed_¦ave
 : master;

4169 
	`£Áš–Ev’t
(
LL_WARNING
,"+sw™ch-ma¡”",
ma¡”
,"%s %s %d %s %d",

4170 
ma¡”
->
Çme
, ma¡”->
addr
->

, ma¡”->addr->
pÜt
,

4171 
»f
->
addr
->

,„ef->addr->
pÜt
);

4173 
	`£Áš–Re£tMa¡”AndChªgeAdd»ss
(
ma¡”
,
»f
->
addr
->

,»f->addr->
pÜt
);

4174 
	}
}

4176 
	$£Áš–Faov”S‹Machše
(
£Áš–RedisIn¡ªû
 *
ri
) {

4177 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_MASTER
);

4179 ià(!(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)) ;

4181 
ri
->
çov”_¡©e
) {

4182 
SENTINEL_FAILOVER_STATE_WAIT_START
:

4183 
	`£Áš–Faov”Wa™S¹
(
ri
);

4185 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
:

4186 
	`£Áš–Faov”S–eùSÏve
(
ri
);

4188 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
:

4189 
	`£Áš–Faov”S’dSÏveOfNoOÃ
(
ri
);

4191 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
:

4192 
	`£Áš–Faov”Wa™PromÙiÚ
(
ri
);

4194 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
:

4195 
	`£Áš–Faov”RecÚfNextSÏve
(
ri
);

4198 
	}
}

4205 
	$£Áš–AbÜtFaov”
(
£Áš–RedisIn¡ªû
 *
ri
) {

4206 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
);

4207 
	`£rv”As£¹
(
ri
->
çov”_¡©e
 <ğ
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
);

4209 
ri
->
æags
 &ğ~(
SRI_FAILOVER_IN_PROGRESS
|
SRI_FORCE_FAILOVER
);

4210 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

4211 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4212 ià(
ri
->
´omÙed_¦ave
) {

4213 
ri
->
´omÙed_¦ave
->
æags
 &ğ~
SRI_PROMOTED
;

4214 
ri
->
´omÙed_¦ave
 = 
NULL
;

4216 
	}
}

4224 
	$£Áš–HªdËRedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

4227 
	`£Áš–RecÚÃùIn¡ªû
(
ri
);

4228 
	`£Áš–S’dP”iodicCommªds
(
ri
);

4234 ià(
£Áš–
.
tt
) {

4235 ià(
	`m¡ime
()-
£Áš–
.
tt_¡¬t_time
 < 
SENTINEL_TILT_PERIOD
) ;

4236 
£Áš–
.
tt
 = 0;

4237 
	`£Áš–Ev’t
(
LL_WARNING
,"-tt",
NULL
,"#tilt modeƒxited");

4241 
	`£Áš–CheckSubjeùiv–yDown
(
ri
);

4244 ià(
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)) {

4249 ià(
ri
->
æags
 & 
SRI_MASTER
) {

4250 
	`£Áš–CheckObjeùiv–yDown
(
ri
);

4251 ià(
	`£Áš–S¹Faov”IfN“ded
(
ri
))

4252 
	`£Áš–AskMa¡”S‹ToOth”S’tš–s
(
ri
,
SENTINEL_ASK_FORCED
);

4253 
	`£Áš–Faov”S‹Machše
(
ri
);

4254 
	`£Áš–AskMa¡”S‹ToOth”S’tš–s
(
ri
,
SENTINEL_NO_FLAGS
);

4256 
	}
}

4260 
	$£Áš–HªdËDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
) {

4261 
diùI‹¿tÜ
 *
di
;

4262 
diùEÁry
 *
de
;

4263 
£Áš–RedisIn¡ªû
 *
sw™ch_to_´omÙed
 = 
NULL
;

4266 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

4267 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4268 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

4270 
	`£Áš–HªdËRedisIn¡ªû
(
ri
);

4271 ià(
ri
->
æags
 & 
SRI_MASTER
) {

4272 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
ri
->
¦aves
);

4273 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
ri
->
£Áš–s
);

4274 ià(
ri
->
çov”_¡©e
 =ğ
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
) {

4275 
sw™ch_to_´omÙed
 = 
ri
;

4279 ià(
sw™ch_to_´omÙed
)

4280 
	`£Áš–Faov”Sw™chToPromÙedSÏve
(
sw™ch_to_´omÙed
);

4281 
	`diùR–—£I‹¿tÜ
(
di
);

4282 
	}
}

4303 
	$£Áš–CheckTtCÚd™iÚ
() {

4304 
m¡ime_t
 
now
 = 
	`m¡ime
();

4305 
m¡ime_t
 
d–
 = 
now
 - 
£Áš–
.
´evious_time
;

4307 ià(
d–
 < 0 || d– > 
SENTINEL_TILT_TRIGGER
) {

4308 
£Áš–
.
tt
 = 1;

4309 
£Áš–
.
tt_¡¬t_time
 = 
	`m¡ime
();

4310 
	`£Áš–Ev’t
(
LL_WARNING
,"+tt",
NULL
,"#tilt modeƒntered");

4312 
£Áš–
.
´evious_time
 = 
	`m¡ime
();

4313 
	}
}

4315 
	$£Áš–Tim”
() {

4316 
	`£Áš–CheckTtCÚd™iÚ
();

4317 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
£Áš–
.
ma¡”s
);

4318 
	`£Áš–RunP’dšgSüts
();

4319 
	`£Áš–CŞËùT”mš©edSüts
();

4320 
	`£Áš–KlTimedoutSüts
();

4328 
£rv”
.
hz
 = 
CONFIG_DEFAULT_HZ
 + 
	`¿nd
() % CONFIG_DEFAULT_HZ;

4329 
	}
}

	@server.c

30 
	~"£rv”.h
"

31 
	~"şu¡”.h
"

32 
	~"¦owlog.h
"

33 
	~"bio.h
"

34 
	~"Ï‹ncy.h
"

36 
	~<time.h
>

37 
	~<sigÇl.h
>

38 
	~<sys/wa™.h
>

39 
	~<”ºo.h
>

40 
	~<as£¹.h
>

41 
	~<ùy³.h
>

42 
	~<¡d¬g.h
>

43 
	~<¬·/š‘.h
>

44 
	~<sys/¡©.h
>

45 
	~<fú.h
>

46 
	~<sys/time.h
>

47 
	~<sys/»sourû.h
>

48 
	~<sys/uio.h
>

49 
	~<sys/un.h
>

50 
	~<lim™s.h
>

51 
	~<æßt.h
>

52 
	~<m©h.h
>

53 
	~<sys/»sourû.h
>

54 
	~<sys/ut¢ame.h
>

55 
	~<loÿË.h
>

56 
	~<sys/sock‘.h
>

60 
sh¬edObjeùsSŒuù
 
	gsh¬ed
;

66 
	gR_Z”o
, 
	gR_PosInf
, 
	gR_NegInf
, 
	gR_Nª
;

71 
»disS”v”
 
	g£rv”
;

125 
»disCommªd
 
	g»disCommªdTabË
[] = {

126 {"moduË",
moduËCommªd
,-2,"as",0,
NULL
,1,1,1,0,0},

127 {"g‘",
g‘Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

128 {"£t",
£tCommªd
,-3,"wm",0,
NULL
,1,1,1,0,0},

129 {"£Šx",
£ŠxCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

130 {"£‹x",
£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

131 {"p£‹x",
p£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

132 {"­³nd",
­³ndCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

133 {"¡¾’",
¡¾’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

134 {"d–",
d–Commªd
,-2,"w",0,
NULL
,1,-1,1,0,0},

135 {"uÆšk",
uÆškCommªd
,-2,"wF",0,
NULL
,1,-1,1,0,0},

136 {"exi¡s",
exi¡sCommªd
,-2,"rF",0,
NULL
,1,-1,1,0,0},

137 {"£tb™",
£tb™Commªd
,4,"wm",0,
NULL
,1,1,1,0,0},

138 {"g‘b™",
g‘b™Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

139 {"b™f›ld",
b™f›ldCommªd
,-2,"wm",0,
NULL
,1,1,1,0,0},

140 {"£Œªge",
£ŒªgeCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

141 {"g‘¿nge",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

142 {"sub¡r",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

143 {"šü",
šüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

144 {"deü",
deüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

145 {"mg‘",
mg‘Commªd
,-2,"r",0,
NULL
,1,-1,1,0,0},

146 {"½ush",
½ushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

147 {"Íush",
ÍushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

148 {"½ushx",
½ushxCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

149 {"Íushx",
ÍushxCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

150 {"lš£¹",
lš£¹Commªd
,5,"wm",0,
NULL
,1,1,1,0,0},

151 {"½İ",
½İCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

152 {"Íİ",
ÍİCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

153 {"b½İ",
b½İCommªd
,-3,"ws",0,
NULL
,1,1,1,0,0},

154 {"b½İÍush",
b½İÍushCommªd
,4,"wms",0,
NULL
,1,2,1,0,0},

155 {"bÍİ",
bÍİCommªd
,-3,"ws",0,
NULL
,1,-2,1,0,0},

156 {"Î’",
Î’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

157 {"lšdex",
lšdexCommªd
,3,"r",0,
NULL
,1,1,1,0,0},

158 {"l£t",
l£tCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

159 {"Ìªge",
ÌªgeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

160 {"Érim",
ÉrimCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

161 {"Ìem",
ÌemCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

162 {"½İÍush",
½İÍushCommªd
,3,"wm",0,
NULL
,1,2,1,0,0},

163 {"§dd",
§ddCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

164 {"¤em",
¤emCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

165 {"smove",
smoveCommªd
,4,"wF",0,
NULL
,1,2,1,0,0},

166 {"sismemb”",
sismemb”Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

167 {"sÿrd",
sÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

168 {"¥İ",
¥İCommªd
,-2,"wRF",0,
NULL
,1,1,1,0,0},

169 {"¤ªdmemb”",
¤ªdmemb”Commªd
,-2,"rR",0,
NULL
,1,1,1,0,0},

170 {"sš‹r",
sš‹rCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

171 {"sš‹r¡Üe",
sš‹r¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

172 {"suniÚ",
suniÚCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

173 {"suniÚ¡Üe",
suniÚ¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

174 {"sdiff",
sdiffCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

175 {"sdiff¡Üe",
sdiff¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

176 {"smemb”s",
sš‹rCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

177 {"ssÿn",
ssÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

178 {"zadd",
zaddCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

179 {"zšüby",
zšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

180 {"z»m",
z»mCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

181 {"z»m¿ngebyscÜe",
z»m¿ngebyscÜeCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

182 {"z»m¿ngeby¿nk",
z»m¿ngeby¿nkCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

183 {"z»m¿ngebyËx",
z»m¿ngebyËxCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

184 {"zuniÚ¡Üe",
zuniÚ¡ÜeCommªd
,-4,"wm",0,
zuniÚIÁ”G‘Keys
,0,0,0,0,0},

185 {"zš‹r¡Üe",
zš‹r¡ÜeCommªd
,-4,"wm",0,
zuniÚIÁ”G‘Keys
,0,0,0,0,0},

186 {"z¿nge",
z¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

187 {"z¿ngebyscÜe",
z¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

188 {"z»v¿ngebyscÜe",
z»v¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

189 {"z¿ngebyËx",
z¿ngebyËxCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

190 {"z»v¿ngebyËx",
z»v¿ngebyËxCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

191 {"zcouÁ",
zcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

192 {"zËxcouÁ",
zËxcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

193 {"z»v¿nge",
z»v¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

194 {"zÿrd",
zÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

195 {"zscÜe",
zscÜeCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

196 {"z¿nk",
z¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

197 {"z»v¿nk",
z»v¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

198 {"zsÿn",
zsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

199 {"h£t",
h£tCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

200 {"h£Šx",
h£ŠxCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

201 {"hg‘",
hg‘Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

202 {"hm£t",
hm£tCommªd
,-4,"wm",0,
NULL
,1,1,1,0,0},

203 {"hmg‘",
hmg‘Commªd
,-3,"r",0,
NULL
,1,1,1,0,0},

204 {"hšüby",
hšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

205 {"hšübyæßt",
hšübyæßtCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

206 {"hd–",
hd–Commªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

207 {"hËn",
hËnCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

208 {"h¡¾’",
h¡¾’Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

209 {"hkeys",
hkeysCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

210 {"hv®s",
hv®sCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

211 {"hg‘®l",
hg‘®lCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

212 {"hexi¡s",
hexi¡sCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

213 {"hsÿn",
hsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

214 {"šüby",
šübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

215 {"deüby",
deübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

216 {"šübyæßt",
šübyæßtCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

217 {"g‘£t",
g‘£tCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

218 {"m£t",
m£tCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

219 {"m£Šx",
m£ŠxCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

220 {"¿ndomkey",
¿ndomkeyCommªd
,1,"rR",0,
NULL
,0,0,0,0,0},

221 {"£Ëù",
£ËùCommªd
,2,"lF",0,
NULL
,0,0,0,0,0},

222 {"move",
moveCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

223 {"»Çme",
»ÇmeCommªd
,3,"w",0,
NULL
,1,2,1,0,0},

224 {"»Çm’x",
»Çm’xCommªd
,3,"wF",0,
NULL
,1,2,1,0,0},

225 {"expœe",
expœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

226 {"expœ—t",
expœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

227 {"³xpœe",
³xpœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

228 {"³xpœ—t",
³xpœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

229 {"keys",
keysCommªd
,2,"rS",0,
NULL
,0,0,0,0,0},

230 {"sÿn",
sÿnCommªd
,-2,"rR",0,
NULL
,0,0,0,0,0},

231 {"dbsize",
dbsizeCommªd
,1,"rF",0,
NULL
,0,0,0,0,0},

232 {"auth",
authCommªd
,2,"¦tF",0,
NULL
,0,0,0,0,0},

233 {"pšg",
pšgCommªd
,-1,"tF",0,
NULL
,0,0,0,0,0},

234 {"echo",
echoCommªd
,2,"F",0,
NULL
,0,0,0,0,0},

235 {"§ve",
§veCommªd
,1,"as",0,
NULL
,0,0,0,0,0},

236 {"bg§ve",
bg§veCommªd
,1,"a",0,
NULL
,0,0,0,0,0},

237 {"bg»wr™—of",
bg»wr™—ofCommªd
,1,"a",0,
NULL
,0,0,0,0,0},

238 {"shutdown",
shutdownCommªd
,-1,"®t",0,
NULL
,0,0,0,0,0},

239 {"Ï¡§ve",
Ï¡§veCommªd
,1,"RF",0,
NULL
,0,0,0,0,0},

240 {"ty³",
ty³Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

241 {"muÉi",
muÉiCommªd
,1,"sF",0,
NULL
,0,0,0,0,0},

242 {"exec",
execCommªd
,1,"sM",0,
NULL
,0,0,0,0,0},

243 {"disÿrd",
disÿrdCommªd
,1,"sF",0,
NULL
,0,0,0,0,0},

244 {"sync",
syncCommªd
,1,"¬s",0,
NULL
,0,0,0,0,0},

245 {"psync",
syncCommªd
,3,"¬s",0,
NULL
,0,0,0,0,0},

246 {"»¶cÚf",
»¶cÚfCommªd
,-1,"a¦t",0,
NULL
,0,0,0,0,0},

247 {"æushdb",
æushdbCommªd
,-1,"w",0,
NULL
,0,0,0,0,0},

248 {"æush®l",
æush®lCommªd
,-1,"w",0,
NULL
,0,0,0,0,0},

249 {"sÜt",
sÜtCommªd
,-2,"wm",0,
sÜtG‘Keys
,1,1,1,0,0},

250 {"šfo",
šfoCommªd
,-1,"É",0,
NULL
,0,0,0,0,0},

251 {"mÚ™Ü",
mÚ™ÜCommªd
,1,"as",0,
NULL
,0,0,0,0,0},

252 {"‰l",
‰lCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

253 {"touch",
touchCommªd
,-2,"rF",0,
NULL
,1,1,1,0,0},

254 {"±",
±Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

255 {"³rsi¡",
³rsi¡Commªd
,2,"wF",0,
NULL
,1,1,1,0,0},

256 {"¦aveof",
¦aveofCommªd
,3,"a¡",0,
NULL
,0,0,0,0,0},

257 {"rŞe",
rŞeCommªd
,1,"l¡",0,
NULL
,0,0,0,0,0},

258 {"debug",
debugCommªd
,-1,"as",0,
NULL
,0,0,0,0,0},

259 {"cÚfig",
cÚfigCommªd
,-2,"Ït",0,
NULL
,0,0,0,0,0},

260 {"subsüibe",
subsüibeCommªd
,-2,"p¦t",0,
NULL
,0,0,0,0,0},

261 {"unsubsüibe",
unsubsüibeCommªd
,-1,"p¦t",0,
NULL
,0,0,0,0,0},

262 {"psubsüibe",
psubsüibeCommªd
,-2,"p¦t",0,
NULL
,0,0,0,0,0},

263 {"punsubsüibe",
punsubsüibeCommªd
,-1,"p¦t",0,
NULL
,0,0,0,0,0},

264 {"publish",
publishCommªd
,3,"¶tF",0,
NULL
,0,0,0,0,0},

265 {"pubsub",
pubsubCommªd
,-2,"¶tR",0,
NULL
,0,0,0,0,0},

266 {"w©ch",
w©chCommªd
,-2,"sF",0,
NULL
,1,-1,1,0,0},

267 {"unw©ch",
unw©chCommªd
,1,"sF",0,
NULL
,0,0,0,0,0},

268 {"şu¡”",
şu¡”Commªd
,-2,"a",0,
NULL
,0,0,0,0,0},

269 {"»¡Üe",
»¡ÜeCommªd
,-4,"wm",0,
NULL
,1,1,1,0,0},

270 {"»¡Üe-askšg",
»¡ÜeCommªd
,-4,"wmk",0,
NULL
,1,1,1,0,0},

271 {"mig¿‹",
mig¿‹Commªd
,-6,"w",0,
mig¿‹G‘Keys
,0,0,0,0,0},

272 {"askšg",
askšgCommªd
,1,"F",0,
NULL
,0,0,0,0,0},

273 {"»adÚly",
»adÚlyCommªd
,1,"F",0,
NULL
,0,0,0,0,0},

274 {"»adwr™e",
»adwr™eCommªd
,1,"F",0,
NULL
,0,0,0,0,0},

275 {"dump",
dumpCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

276 {"objeù",
objeùCommªd
,3,"r",0,
NULL
,2,2,2,0,0},

277 {"ş›Á",
ş›ÁCommªd
,-2,"as",0,
NULL
,0,0,0,0,0},

278 {"ev®",
ev®Commªd
,-3,"s",0,
ev®G‘Keys
,0,0,0,0,0},

279 {"ev®sha",
ev®ShaCommªd
,-3,"s",0,
ev®G‘Keys
,0,0,0,0,0},

280 {"¦owlog",
¦owlogCommªd
,-2,"a",0,
NULL
,0,0,0,0,0},

281 {"süt",
sütCommªd
,-2,"s",0,
NULL
,0,0,0,0,0},

282 {"time",
timeCommªd
,1,"RF",0,
NULL
,0,0,0,0,0},

283 {"b™İ",
b™İCommªd
,-4,"wm",0,
NULL
,2,-1,1,0,0},

284 {"b™couÁ",
b™couÁCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

285 {"b™pos",
b™posCommªd
,-3,"r",0,
NULL
,1,1,1,0,0},

286 {"wa™",
wa™Commªd
,3,"s",0,
NULL
,0,0,0,0,0},

287 {"commªd",
commªdCommªd
,0,"É",0,
NULL
,0,0,0,0,0},

288 {"geßdd",
geßddCommªd
,-5,"wm",0,
NULL
,1,1,1,0,0},

289 {"geÜadius",
geÜadiusCommªd
,-6,"w",0,
NULL
,1,1,1,0,0},

290 {"geÜadiusbymemb”",
geÜadiusByMemb”Commªd
,-5,"w",0,
NULL
,1,1,1,0,0},

291 {"geohash",
geohashCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

292 {"geİos",
geİosCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

293 {"geodi¡",
geodi¡Commªd
,-4,"r",0,
NULL
,1,1,1,0,0},

294 {"pf£láe¡",
pf£láe¡Commªd
,1,"a",0,
NULL
,0,0,0,0,0},

295 {"pçdd",
pçddCommªd
,-2,"wmF",0,
NULL
,1,1,1,0,0},

296 {"pfcouÁ",
pfcouÁCommªd
,-2,"r",0,
NULL
,1,-1,1,0,0},

297 {"pfm”ge",
pfm”geCommªd
,-2,"wm",0,
NULL
,1,-1,1,0,0},

298 {"pfdebug",
pfdebugCommªd
,-3,"w",0,
NULL
,0,0,0,0,0},

299 {"Ï‹ncy",
Ï‹ncyCommªd
,-2,"a¦t",0,
NULL
,0,0,0,0,0}

306 
	$£rv”LogRaw
(
Ëv–
, cÚ¡ *
msg
) {

307 cÚ¡ 
sy¦ogLev–M­
[] = { 
LOG_DEBUG
, 
LOG_INFO
, 
LOG_NOTICE
, 
LOG_WARNING
 };

308 cÚ¡ *
c
 = ".-*#";

309 
FILE
 *
å
;

310 
buf
[64];

311 
¿wmode
 = (
Ëv–
 & 
LL_RAW
);

312 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

314 
Ëv–
 &= 0xff;

315 ià(
Ëv–
 < 
£rv”
.
v”bos™y
) ;

317 
å
 = 
log_to_¡dout
 ? 
¡dout
 : 
	`fİ’
(
£rv”
.
logfe
,"a");

318 ià(!
å
) ;

320 ià(
¿wmode
) {

321 
	`årštf
(
å
,"%s",
msg
);

323 
off
;

324 
timev®
 
tv
;

325 
rŞe_ch¬
;

326 
pid_t
 
pid
 = 
	`g‘pid
();

328 
	`g‘timeofday
(&
tv
,
NULL
);

329 
off
 = 
	`¡ráime
(
buf
,(buf),"%d %b %H:%M:%S.",
	`loÿÉime
(&
tv
.
tv_£c
));

330 
	`¢´štf
(
buf
+
off
,(buf)-off,"%03d",()
tv
.
tv_u£c
/1000);

331 ià(
£rv”
.
£Áš–_mode
) {

332 
rŞe_ch¬
 = 'X';

333 } ià(
pid
 !ğ
£rv”
.pid) {

334 
rŞe_ch¬
 = 'C';

336 
rŞe_ch¬
 = (
£rv”
.
ma¡”ho¡
 ? 'S':'M');

338 
	`årštf
(
å
,"%d:%c %s %c %s\n",

339 ()
	`g‘pid
(),
rŞe_ch¬
, 
buf
,
c
[
Ëv–
],
msg
);

341 
	`fæush
(
å
);

343 ià(!
log_to_¡dout
è
	`fşo£
(
å
);

344 ià(
£rv”
.
sy¦og_’abËd
è
	`sy¦og
(
sy¦ogLev–M­
[
Ëv–
], "%s", 
msg
);

345 
	}
}

350 
	$£rv”Log
(
Ëv–
, cÚ¡ *
fmt
, ...) {

351 
va_li¡
 
­
;

352 
msg
[
LOG_MAX_LEN
];

354 ià((
Ëv–
&0xffè< 
£rv”
.
v”bos™y
) ;

356 
	`va_¡¬t
(
­
, 
fmt
);

357 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

358 
	`va_’d
(
­
);

360 
	`£rv”LogRaw
(
Ëv–
,
msg
);

361 
	}
}

369 
	$£rv”LogFromHªdËr
(
Ëv–
, cÚ¡ *
msg
) {

370 
fd
;

371 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

372 
buf
[64];

374 ià((
Ëv–
&0xffè< 
£rv”
.
v”bos™y
 || (
log_to_¡dout
 && s”v”.
d«mÚize
))

376 
fd
 = 
log_to_¡dout
 ? 
STDOUT_FILENO
 :

377 
	`İ’
(
£rv”
.
logfe
, 
O_APPEND
|
O_CREAT
|
O_WRONLY
, 0644);

378 ià(
fd
 == -1) ;

379 
	`Î2¡ršg
(
buf
,(buf),
	`g‘pid
());

380 ià(
	`wr™e
(
fd
,
buf
,
	`¡¾’
(buf)è=ğ-1è
”r
;

381 ià(
	`wr™e
(
fd
,":sigÇl-hªdË¸(",17è=ğ-1è
”r
;

382 
	`Î2¡ršg
(
buf
,(buf),
	`time
(
NULL
));

383 ià(
	`wr™e
(
fd
,
buf
,
	`¡¾’
(buf)è=ğ-1è
”r
;

384 ià(
	`wr™e
(
fd
,"è",2è=ğ-1è
”r
;

385 ià(
	`wr™e
(
fd
,
msg
,
	`¡¾’
(msg)è=ğ-1è
”r
;

386 ià(
	`wr™e
(
fd
,"\n",1è=ğ-1è
”r
;

387 
”r
:

388 ià(!
log_to_¡dout
è
	`şo£
(
fd
);

389 
	}
}

392 
	$u¡ime
() {

393 
timev®
 
tv
;

394 
u¡
;

396 
	`g‘timeofday
(&
tv
, 
NULL
);

397 
u¡
 = (()
tv
.
tv_£c
)*1000000;

398 
u¡
 +ğ
tv
.
tv_u£c
;

399  
u¡
;

400 
	}
}

403 
m¡ime_t
 
	$m¡ime
() {

404  
	`u¡ime
()/1000;

405 
	}
}

411 
	$ex™FromChd
(
»tcode
) {

412 #ifdeà
COVERAGE_TEST


413 
	`ex™
(
»tcode
);

415 
	`_ex™
(
»tcode
);

417 
	}
}

425 
	$diùVªÏF»e
(*
´ivd©a
, *
v®
)

427 
	`DICT_NOTUSED
(
´ivd©a
);

428 
	`zä“
(
v®
);

429 
	}
}

431 
	$diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
)

433 
	`DICT_NOTUSED
(
´ivd©a
);

434 
	`li¡R–—£
((
li¡
*)
v®
);

435 
	}
}

437 
	$diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

438 cÚ¡ *
key2
)

440 
l1
,
l2
;

441 
	`DICT_NOTUSED
(
´ivd©a
);

443 
l1
 = 
	`sd¦’
((
sds
)
key1
);

444 
l2
 = 
	`sd¦’
((
sds
)
key2
);

445 ià(
l1
 !ğ
l2
)  0;

446  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

447 
	}
}

451 
	$diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
,

452 cÚ¡ *
key2
)

454 
	`DICT_NOTUSED
(
´ivd©a
);

456  
	`¡rÿ£cmp
(
key1
, 
key2
) == 0;

457 
	}
}

459 
	$diùObjeùDe¡ruùÜ
(*
´ivd©a
, *
v®
)

461 
	`DICT_NOTUSED
(
´ivd©a
);

463 ià(
v®
 =ğ
NULL
) ;

464 
	`deüRefCouÁ
(
v®
);

465 
	}
}

467 
	$diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
)

469 
	`DICT_NOTUSED
(
´ivd©a
);

471 
	`sdsä“
(
v®
);

472 
	}
}

474 
	$diùObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

475 cÚ¡ *
key2
)

477 cÚ¡ 
robj
 *
o1
 = 
key1
, *
o2
 = 
key2
;

478  
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

479 
	}
}

481 
	$diùObjHash
(cÚ¡ *
key
) {

482 cÚ¡ 
robj
 *
o
 = 
key
;

483  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

484 
	}
}

486 
	$diùSdsHash
(cÚ¡ *
key
) {

487  
	`diùG’HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

488 
	}
}

490 
	$diùSdsCa£Hash
(cÚ¡ *
key
) {

491  
	`diùG’Ca£HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

492 
	}
}

494 
	$diùEncObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

495 cÚ¡ *
key2
)

497 
robj
 *
o1
 = (robj*è
key1
, *
o2
 = (robj*è
key2
;

498 
cmp
;

500 ià(
o1
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

501 
o2
->
’codšg
 =ğ
OBJ_ENCODING_INT
)

502  
o1
->
±r
 =ğ
o2
->ptr;

504 
o1
 = 
	`g‘DecodedObjeù
(o1);

505 
o2
 = 
	`g‘DecodedObjeù
(o2);

506 
cmp
 = 
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

507 
	`deüRefCouÁ
(
o1
);

508 
	`deüRefCouÁ
(
o2
);

509  
cmp
;

510 
	}
}

512 
	$diùEncObjHash
(cÚ¡ *
key
) {

513 
robj
 *
o
 = (robj*è
key
;

515 ià(
	`sdsEncodedObjeù
(
o
)) {

516  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

518 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

519 
buf
[32];

520 
Ën
;

522 
Ën
 = 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

523  
	`diùG’HashFunùiÚ
((*)
buf
, 
Ën
);

525 
hash
;

527 
o
 = 
	`g‘DecodedObjeù
(o);

528 
hash
 = 
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

529 
	`deüRefCouÁ
(
o
);

530  
hash
;

533 
	}
}

537 
diùTy³
 
	gobjeùKeyPoš‹rV®ueDiùTy³
 = {

538 
diùEncObjHash
,

539 
NULL
,

540 
NULL
,

541 
diùEncObjKeyCom·»
,

542 
diùObjeùDe¡ruùÜ
,

543 
NULL


547 
diùTy³
 
	g£tDiùTy³
 = {

548 
diùSdsHash
,

549 
NULL
,

550 
NULL
,

551 
diùSdsKeyCom·»
,

552 
diùSdsDe¡ruùÜ
,

553 
NULL


557 
diùTy³
 
	gz£tDiùTy³
 = {

558 
diùSdsHash
,

559 
NULL
,

560 
NULL
,

561 
diùSdsKeyCom·»
,

562 
NULL
,

563 
NULL


567 
diùTy³
 
	gdbDiùTy³
 = {

568 
diùSdsHash
,

569 
NULL
,

570 
NULL
,

571 
diùSdsKeyCom·»
,

572 
diùSdsDe¡ruùÜ
,

573 
diùObjeùDe¡ruùÜ


577 
diùTy³
 
	gshaSütObjeùDiùTy³
 = {

578 
diùSdsCa£Hash
,

579 
NULL
,

580 
NULL
,

581 
diùSdsKeyCa£Com·»
,

582 
diùSdsDe¡ruùÜ
,

583 
diùObjeùDe¡ruùÜ


587 
diùTy³
 
	gkey±rDiùTy³
 = {

588 
diùSdsHash
,

589 
NULL
,

590 
NULL
,

591 
diùSdsKeyCom·»
,

592 
NULL
,

593 
NULL


597 
diùTy³
 
	gcommªdTabËDiùTy³
 = {

598 
diùSdsCa£Hash
,

599 
NULL
,

600 
NULL
,

601 
diùSdsKeyCa£Com·»
,

602 
diùSdsDe¡ruùÜ
,

603 
NULL


607 
diùTy³
 
	ghashDiùTy³
 = {

608 
diùSdsHash
,

609 
NULL
,

610 
NULL
,

611 
diùSdsKeyCom·»
,

612 
diùSdsDe¡ruùÜ
,

613 
diùSdsDe¡ruùÜ


619 
diùTy³
 
	gkeyli¡DiùTy³
 = {

620 
diùObjHash
,

621 
NULL
,

622 
NULL
,

623 
diùObjKeyCom·»
,

624 
diùObjeùDe¡ruùÜ
,

625 
diùLi¡De¡ruùÜ


630 
diùTy³
 
	gşu¡”NodesDiùTy³
 = {

631 
diùSdsHash
,

632 
NULL
,

633 
NULL
,

634 
diùSdsKeyCom·»
,

635 
diùSdsDe¡ruùÜ
,

636 
NULL


642 
diùTy³
 
	gşu¡”NodesBÏckLi¡DiùTy³
 = {

643 
diùSdsCa£Hash
,

644 
NULL
,

645 
NULL
,

646 
diùSdsKeyCa£Com·»
,

647 
diùSdsDe¡ruùÜ
,

648 
NULL


654 
diùTy³
 
	gmoduËsDiùTy³
 = {

655 
diùSdsCa£Hash
,

656 
NULL
,

657 
NULL
,

658 
diùSdsKeyCa£Com·»
,

659 
diùSdsDe¡ruùÜ
,

660 
NULL


664 
diùTy³
 
	gmig¿‹CacheDiùTy³
 = {

665 
diùSdsHash
,

666 
NULL
,

667 
NULL
,

668 
diùSdsKeyCom·»
,

669 
diùSdsDe¡ruùÜ
,

670 
NULL


676 
diùTy³
 
	g»¶SütCacheDiùTy³
 = {

677 
diùSdsCa£Hash
,

678 
NULL
,

679 
NULL
,

680 
diùSdsKeyCa£Com·»
,

681 
diùSdsDe¡ruùÜ
,

682 
NULL


685 
	$htN“dsResize
(
diù
 *dict) {

686 
size
, 
u£d
;

688 
size
 = 
	`diùSlÙs
(
diù
);

689 
u£d
 = 
	`diùSize
(
diù
);

690  (
size
 > 
DICT_HT_INITIAL_SIZE
 &&

691 (
u£d
*100/
size
 < 
HASHTABLE_MIN_FILL
));

692 
	}
}

696 
	$ŒyResizeHashTabËs
(
dbid
) {

697 ià(
	`htN“dsResize
(
£rv”
.
db
[
dbid
].
diù
))

698 
	`diùResize
(
£rv”
.
db
[
dbid
].
diù
);

699 ià(
	`htN“dsResize
(
£rv”
.
db
[
dbid
].
expœes
))

700 
	`diùResize
(
£rv”
.
db
[
dbid
].
expœes
);

701 
	}
}

710 
	$šüem’ÎyRehash
(
dbid
) {

712 ià(
	`diùIsRehashšg
(
£rv”
.
db
[
dbid
].
diù
)) {

713 
	`diùRehashMli£cÚds
(
£rv”
.
db
[
dbid
].
diù
,1);

717 ià(
	`diùIsRehashšg
(
£rv”
.
db
[
dbid
].
expœes
)) {

718 
	`diùRehashMli£cÚds
(
£rv”
.
db
[
dbid
].
expœes
,1);

722 
	}
}

730 
	$upd©eDiùResizePŞicy
() {

731 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1)

732 
	`diùEÇbËResize
();

734 
	`diùDi§bËResize
();

735 
	}
}

740 
	$ŒackIn¡ªÃousM‘ric
(
m‘ric
, 
cu¼’t_»adšg
) {

741 
t
 = 
	`m¡ime
(è- 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
;

742 
İs
 = 
cu¼’t_»adšg
 -

743 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
;

744 
İs_£c
;

746 
İs_£c
 = 
t
 > 0 ? (
İs
*1000/t) : 0;

748 
£rv”
.
š¡_m‘ric
[
m‘ric
].
§m¶es
[£rv”.š¡_m‘ric[m‘ric].
idx
] =

749 
İs_£c
;

750 
£rv”
.
š¡_m‘ric
[
m‘ric
].
idx
++;

751 
£rv”
.
š¡_m‘ric
[
m‘ric
].
idx
 %ğ
STATS_METRIC_SAMPLES
;

752 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
 = 
	`m¡ime
();

753 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
 = 
cu¼’t_»adšg
;

754 
	}
}

757 
	$g‘In¡ªÃousM‘ric
(
m‘ric
) {

758 
j
;

759 
sum
 = 0;

761 
j
 = 0; j < 
STATS_METRIC_SAMPLES
; j++)

762 
sum
 +ğ
£rv”
.
š¡_m‘ric
[
m‘ric
].
§m¶es
[
j
];

763  
sum
 / 
STATS_METRIC_SAMPLES
;

764 
	}
}

770 
	$ş›ÁsCrÚHªdËTimeout
(
ş›Á
 *
c
, 
m¡ime_t
 
now_ms
) {

771 
time_t
 
now
 = 
now_ms
/1000;

773 ià(
£rv”
.
maxidËtime
 &&

774 !(
c
->
æags
 & 
CLIENT_SLAVE
) &&

775 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

776 !(
c
->
æags
 & 
CLIENT_BLOCKED
) &&

777 !(
c
->
æags
 & 
CLIENT_PUBSUB
) &&

778 (
now
 - 
c
->
Ï¡š‹¿ùiÚ
 > 
£rv”
.
maxidËtime
))

780 
	`£rv”Log
(
LL_VERBOSE
,"Closing idle client");

781 
	`ä“Cl›Á
(
c
);

783 } ià(
c
->
æags
 & 
CLIENT_BLOCKED
) {

788 ià(
c
->
bpİ
.
timeout
 !ğ0 && c->bpİ.timeouˆ< 
now_ms
) {

790 
	`»¶yToBlockedCl›ÁTimedOut
(
c
);

791 
	`unblockCl›Á
(
c
);

792 } ià(
£rv”
.
şu¡”_’abËd
) {

795 ià(
	`şu¡”RedœeùBlockedCl›ÁIfN“ded
(
c
))

796 
	`unblockCl›Á
(
c
);

800 
	}
}

806 
	$ş›ÁsCrÚResizeQu”yBufãr
(
ş›Á
 *
c
) {

807 
size_t
 
qu”ybuf_size
 = 
	`sdsAÎocSize
(
c
->
qu”ybuf
);

808 
time_t
 
idËtime
 = 
£rv”
.
unixtime
 - 
c
->
Ï¡š‹¿ùiÚ
;

813 ià(((
qu”ybuf_size
 > 
PROTO_MBULK_BIG_ARG
) &&

814 (
qu”ybuf_size
/(
c
->
qu”ybuf_³ak
+1)) > 2) ||

815 (
qu”ybuf_size
 > 1024 && 
idËtime
 > 2))

818 ià(
	`sd§va
(
c
->
qu”ybuf
) > 1024) {

819 
c
->
qu”ybuf
 = 
	`sdsRemoveF»eS·û
(c->querybuf);

824 
c
->
qu”ybuf_³ak
 = 0;

826 
	}
}

828 
	#CLIENTS_CRON_MIN_ITERATIONS
 5

	)

829 
	$ş›ÁsCrÚ
() {

834 
numş›Ás
 = 
	`li¡L’gth
(
£rv”
.
ş›Ás
);

835 
™”©iÚs
 = 
numş›Ás
/
£rv”
.
hz
;

836 
m¡ime_t
 
now
 = 
	`m¡ime
();

841 ià(
™”©iÚs
 < 
CLIENTS_CRON_MIN_ITERATIONS
)

842 
™”©iÚs
 = (
numş›Ás
 < 
CLIENTS_CRON_MIN_ITERATIONS
) ?

843 
numş›Ás
 : 
CLIENTS_CRON_MIN_ITERATIONS
;

845 
	`li¡L’gth
(
£rv”
.
ş›Ás
è&& 
™”©iÚs
--) {

846 
ş›Á
 *
c
;

847 
li¡Node
 *
h—d
;

852 
	`li¡RÙ©e
(
£rv”
.
ş›Ás
);

853 
h—d
 = 
	`li¡Fœ¡
(
£rv”
.
ş›Ás
);

854 
c
 = 
	`li¡NodeV®ue
(
h—d
);

858 ià(
	`ş›ÁsCrÚHªdËTimeout
(
c
,
now
)) ;

859 ià(
	`ş›ÁsCrÚResizeQu”yBufãr
(
c
)) ;

861 
	}
}

866 
	$d©aba£sCrÚ
() {

869 ià(
£rv”
.
aùive_expœe_’abËd
 && s”v”.
ma¡”ho¡
 =ğ
NULL
)

870 
	`aùiveExpœeCyşe
(
ACTIVE_EXPIRE_CYCLE_SLOW
);

875 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

879 
»size_db
 = 0;

880 
»hash_db
 = 0;

881 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

882 
j
;

885 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
) dbs_per_call = server.dbnum;

888 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

889 
	`ŒyResizeHashTabËs
(
»size_db
 % 
£rv”
.
dbnum
);

890 
»size_db
++;

894 ià(
£rv”
.
aùiv”ehashšg
) {

895 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

896 
wÜk_dÚe
 = 
	`šüem’ÎyRehash
(
»hash_db
 % 
£rv”
.
dbnum
);

897 
»hash_db
++;

898 ià(
wÜk_dÚe
) {

906 
	}
}

912 
	$upd©eCachedTime
() {

913 
£rv”
.
unixtime
 = 
	`time
(
NULL
);

914 
£rv”
.
m¡ime
 = 
	`m¡ime
();

915 
	}
}

936 
	$£rv”CrÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

937 
j
;

938 
	`UNUSED
(
ev’tLoİ
);

939 
	`UNUSED
(
id
);

940 
	`UNUSED
(
ş›ÁD©a
);

944 ià(
£rv”
.
w©chdog_³riod
è
	`w©chdogScheduËSigÇl
(server.watchdog_period);

947 
	`upd©eCachedTime
();

949 
	`run_w™h_³riod
(100) {

950 
	`ŒackIn¡ªÃousM‘ric
(
STATS_METRIC_COMMAND
,
£rv”
.
¡©_numcommªds
);

951 
	`ŒackIn¡ªÃousM‘ric
(
STATS_METRIC_NET_INPUT
,

952 
£rv”
.
¡©_Ãt_šput_by‹s
);

953 
	`ŒackIn¡ªÃousM‘ric
(
STATS_METRIC_NET_OUTPUT
,

954 
£rv”
.
¡©_Ãt_ouut_by‹s
);

968 
£rv”
.
Ìuşock
 = 
	`g‘LRUClock
();

971 ià(
	`zm®loc_u£d_memÜy
(è> 
£rv”
.
¡©_³ak_memÜy
)

972 
£rv”
.
¡©_³ak_memÜy
 = 
	`zm®loc_u£d_memÜy
();

975 
£rv”
.
»sid’t_£t_size
 = 
	`zm®loc_g‘_rss
();

979 ià(
£rv”
.
shutdown_a§p
) {

980 ià(
	`´•¬eFÜShutdown
(
SHUTDOWN_NOFLAGS
è=ğ
C_OK
è
	`ex™
(0);

981 
	`£rv”Log
(
LL_WARNING
,"SIGTERM„eceived butƒrrorsryingo shut downhe server, checkhe†ogs for more information");

982 
£rv”
.
shutdown_a§p
 = 0;

986 
	`run_w™h_³riod
(5000) {

987 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

988 
size
, 
u£d
, 
vkeys
;

990 
size
 = 
	`diùSlÙs
(
£rv”
.
db
[
j
].
diù
);

991 
u£d
 = 
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

992 
vkeys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
expœes
);

993 ià(
u£d
 || 
vkeys
) {

994 
	`£rv”Log
(
LL_VERBOSE
,"DB %d: %Îd key (%Îd vŞ©eèš %Îd slÙ HT.",
j
,
u£d
,
vkeys
,
size
);

1001 ià(!
£rv”
.
£Áš–_mode
) {

1002 
	`run_w™h_³riod
(5000) {

1003 
	`£rv”Log
(
LL_VERBOSE
,

1005 
	`li¡L’gth
(
£rv”
.
ş›Ás
)-li¡L’gth(£rv”.
¦aves
),

1006 
	`li¡L’gth
(
£rv”
.
¦aves
),

1007 
	`zm®loc_u£d_memÜy
());

1012 
	`ş›ÁsCrÚ
();

1015 
	`d©aba£sCrÚ
();

1019 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1 &&

1020 
£rv”
.
aof_»wr™e_scheduËd
)

1022 
	`»wr™eAµ’dOÆyFeBackground
();

1026 ià(
£rv”
.
rdb_chd_pid
 !ğ-1 || s”v”.
aof_chd_pid
 != -1 ||

1027 
	`ldbP’dšgChd»n
())

1029 
¡©loc
;

1030 
pid_t
 
pid
;

1032 ià((
pid
 = 
	`wa™3
(&
¡©loc
,
WNOHANG
,
NULL
)) != 0) {

1033 
ex™code
 = 
	`WEXITSTATUS
(
¡©loc
);

1034 
bysigÇl
 = 0;

1036 ià(
	`WIFSIGNALED
(
¡©loc
)è
bysigÇl
 = 
	`WTERMSIG
(statloc);

1038 ià(
pid
 == -1) {

1039 
	`£rv”Log
(
LL_WARNING
,"wait3()„eturned‡nƒrror: %s. "

1041 
	`¡»¼Ü
(
”ºo
),

1042 (è
£rv”
.
rdb_chd_pid
,

1043 (è
£rv”
.
aof_chd_pid
);

1044 } ià(
pid
 =ğ
£rv”
.
rdb_chd_pid
) {

1045 
	`backgroundSaveDÚeHªdËr
(
ex™code
,
bysigÇl
);

1046 } ià(
pid
 =ğ
£rv”
.
aof_chd_pid
) {

1047 
	`backgroundRewr™eDÚeHªdËr
(
ex™code
,
bysigÇl
);

1049 ià(!
	`ldbRemoveChd
(
pid
)) {

1050 
	`£rv”Log
(
LL_WARNING
,

1052 ()
pid
);

1055 
	`upd©eDiùResizePŞicy
();

1060 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1061 
§v•¬am
 *
¥
 = 
£rv”
.
§v•¬ams
+
j
;

1067 ià(
£rv”
.
dœty
 >ğ
¥
->
chªges
 &&

1068 
£rv”
.
unixtime
-£rv”.
Ï¡§ve
 > 
¥
->
£cÚds
 &&

1069 (
£rv”
.
unixtime
-£rv”.
Ï¡bg§ve_Œy
 >

1070 
CONFIG_BGSAVE_RETRY_DELAY
 ||

1071 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_OK
))

1073 
	`£rv”Log
(
LL_NOTICE
,"%d changes in %d seconds. Saving...",

1074 
¥
->
chªges
, ()¥->
£cÚds
);

1075 
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
);

1081 ià(
£rv”
.
rdb_chd_pid
 == -1 &&

1082 
£rv”
.
aof_chd_pid
 == -1 &&

1083 
£rv”
.
aof_»wr™e_³rc
 &&

1084 
£rv”
.
aof_cu¼’t_size
 > s”v”.
aof_»wr™e_mš_size
)

1086 
ba£
 = 
£rv”
.
aof_»wr™e_ba£_size
 ?

1087 
£rv”
.
aof_»wr™e_ba£_size
 : 1;

1088 
growth
 = (
£rv”
.
aof_cu¼’t_size
*100/
ba£
) - 100;

1089 ià(
growth
 >ğ
£rv”
.
aof_»wr™e_³rc
) {

1090 
	`£rv”Log
(
LL_NOTICE
,"S¹šg‡utom©iø»wr™šg oàAOF oÀ%Îd%% growth",
growth
);

1091 
	`»wr™eAµ’dOÆyFeBackground
();

1099 ià(
£rv”
.
aof_æush_po¡pÚed_¡¬t
è
	`æushAµ’dOÆyFe
(0);

1105 
	`run_w™h_³riod
(1000) {

1106 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_ERR
)

1107 
	`æushAµ’dOÆyFe
(0);

1111 
	`ä“Cl›ÁsInAsyncF»eQueue
();

1114 
	`ş›ÁsA»Pau£d
();

1118 
	`run_w™h_³riod
(1000è
	`»¶iÿtiÚCrÚ
();

1121 
	`run_w™h_³riod
(100) {

1122 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”CrÚ
();

1126 
	`run_w™h_³riod
(100) {

1127 ià(
£rv”
.
£Áš–_mode
è
	`£Áš–Tim”
();

1131 
	`run_w™h_³riod
(1000) {

1132 
	`mig¿‹Clo£TimedoutSock‘s
();

1135 
£rv”
.
üÚloİs
++;

1136  1000/
£rv”
.
hz
;

1137 
	}
}

1142 
	$befÜeSË•
(
«Ev’tLoİ
 *
ev’tLoİ
) {

1143 
	`UNUSED
(
ev’tLoİ
);

1149 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”BefÜeSË•
();

1153 ià(
£rv”
.
aùive_expœe_’abËd
 && s”v”.
ma¡”ho¡
 =ğ
NULL
)

1154 
	`aùiveExpœeCyşe
(
ACTIVE_EXPIRE_CYCLE_FAST
);

1158 ià(
£rv”
.
g‘_ack_äom_¦aves
) {

1159 
robj
 *
¬gv
[3];

1161 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("REPLCONF",8);

1162 
¬gv
[1] = 
	`ü—‹SŒšgObjeù
("GETACK",6);

1163 
¬gv
[2] = 
	`ü—‹SŒšgObjeù
("*",1);

1164 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
, s”v”.
¦ave£ldb
, 
¬gv
, 3);

1165 
	`deüRefCouÁ
(
¬gv
[0]);

1166 
	`deüRefCouÁ
(
¬gv
[1]);

1167 
	`deüRefCouÁ
(
¬gv
[2]);

1168 
£rv”
.
g‘_ack_äom_¦aves
 = 0;

1173 ià(
	`li¡L’gth
(
£rv”
.
ş›Ás_wa™šg_acks
))

1174 
	`´oûssCl›ÁsWa™šgR•liÿs
();

1177 ià(
	`li¡L’gth
(
£rv”
.
unblocked_ş›Ás
))

1178 
	`´oûssUnblockedCl›Ás
();

1181 
	`æushAµ’dOÆyFe
(0);

1184 
	`hªdËCl›ÁsW™hP’dšgWr™es
();

1185 
	}
}

1189 
	$ü—‹Sh¬edObjeùs
() {

1190 
j
;

1192 
sh¬ed
.
ülf
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("\r\n"));

1193 
sh¬ed
.
ok
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+OK\r\n"));

1194 
sh¬ed
.
”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("-ERR\r\n"));

1195 
sh¬ed
.
em±ybulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$0\r\n\r\n"));

1196 
sh¬ed
.
cz”o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":0\r\n"));

1197 
sh¬ed
.
cÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":1\r\n"));

1198 
sh¬ed
.
úegÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":-1\r\n"));

1199 
sh¬ed
.
nuÎbulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$-1\r\n"));

1200 
sh¬ed
.
nuÎmuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*-1\r\n"));

1201 
sh¬ed
.
em±ymuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*0\r\n"));

1202 
sh¬ed
.
pÚg
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+PONG\r\n"));

1203 
sh¬ed
.
queued
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+QUEUED\r\n"));

1204 
sh¬ed
.
em±ysÿn
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*2\r\n$1\r\n0\r\n*0\r\n"));

1205 
sh¬ed
.
wrÚgty³”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1207 
sh¬ed
.
nokey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1209 
sh¬ed
.
syÁax”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1211 
sh¬ed
.
§meobjeù”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1213 
sh¬ed
.
outoäªg“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1215 
sh¬ed
.
nosü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1217 
sh¬ed
.
lßdšg”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1219 
sh¬ed
.
¦owsü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1221 
sh¬ed
.
ma¡”dowÃ¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1223 
sh¬ed
.
bg§v“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1225 
sh¬ed
.
ro¦av“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1227 
sh¬ed
.
nßuth”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1229 
sh¬ed
.
oom”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1231 
sh¬ed
.
exeÿbÜ‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1233 
sh¬ed
.
nÜ•liÿ£¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1235 
sh¬ed
.
busykey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1237 
sh¬ed
.
¥aû
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(" "));

1238 
sh¬ed
.
cŞÚ
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":"));

1239 
sh¬ed
.
¶us
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+"));

1241 
j
 = 0; j < 
PROTO_SHARED_SELECT_CMDS
; j++) {

1242 
diùid_¡r
[64];

1243 
diùid_Ën
;

1245 
diùid_Ën
 = 
	`Î2¡ršg
(
diùid_¡r
,(diùid_¡r),
j
);

1246 
sh¬ed
.
£Ëù
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

1247 
	`sdsÿrštf
(
	`sd£m±y
(),

1249 
diùid_Ën
, 
diùid_¡r
));

1251 
sh¬ed
.
mes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$7\r\nmessage\r\n",13);

1252 
sh¬ed
.
pmes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$8\r\npmessage\r\n",14);

1253 
sh¬ed
.
subsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$9\r\nsubscribe\r\n",15);

1254 
sh¬ed
.
unsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$11\r\nunsubscribe\r\n",18);

1255 
sh¬ed
.
psubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$10\r\npsubscribe\r\n",17);

1256 
sh¬ed
.
punsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$12\r\npunsubscribe\r\n",19);

1257 
sh¬ed
.
d–
 = 
	`ü—‹SŒšgObjeù
("DEL",3);

1258 
sh¬ed
.
uÆšk
 = 
	`ü—‹SŒšgObjeù
("UNLINK",6);

1259 
sh¬ed
.
½İ
 = 
	`ü—‹SŒšgObjeù
("RPOP",4);

1260 
sh¬ed
.
Íİ
 = 
	`ü—‹SŒšgObjeù
("LPOP",4);

1261 
sh¬ed
.
Íush
 = 
	`ü—‹SŒšgObjeù
("LPUSH",5);

1262 
j
 = 0; j < 
OBJ_SHARED_INTEGERS
; j++) {

1263 
sh¬ed
.
š‹g”s
[
j
] =

1264 
	`makeObjeùSh¬ed
(
	`ü—‹Objeù
(
OBJ_STRING
,(*)()
j
));

1265 
sh¬ed
.
š‹g”s
[
j
]->
’codšg
 = 
OBJ_ENCODING_INT
;

1267 
j
 = 0; j < 
OBJ_SHARED_BULKHDR_LEN
; j++) {

1268 
sh¬ed
.
mbulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

1269 
	`sdsÿrštf
(
	`sd£m±y
(),"*%d\r\n",
j
));

1270 
sh¬ed
.
bulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

1271 
	`sdsÿrštf
(
	`sd£m±y
(),"$%d\r\n",
j
));

1277 
sh¬ed
.
mš¡ršg
 = 
	`sd¢ew
("minstring");

1278 
sh¬ed
.
max¡ršg
 = 
	`sd¢ew
("maxstring");

1279 
	}
}

1281 
	$š™S”v”CÚfig
() {

1282 
j
;

1284 
	`g‘RªdomHexCh¬s
(
£rv”
.
runid
,
CONFIG_RUN_ID_SIZE
);

1285 
£rv”
.
cÚfigfe
 = 
NULL
;

1286 
£rv”
.
execubË
 = 
NULL
;

1287 
£rv”
.
hz
 = 
CONFIG_DEFAULT_HZ
;

1288 
£rv”
.
runid
[
CONFIG_RUN_ID_SIZE
] = '\0';

1289 
£rv”
.
¬ch_b™s
 = (() == 8) ? 64 : 32;

1290 
£rv”
.
pÜt
 = 
CONFIG_DEFAULT_SERVER_PORT
;

1291 
£rv”
.
tı_backlog
 = 
CONFIG_DEFAULT_TCP_BACKLOG
;

1292 
£rv”
.
bšdaddr_couÁ
 = 0;

1293 
£rv”
.
unixsock‘
 = 
NULL
;

1294 
£rv”
.
unixsock‘³rm
 = 
CONFIG_DEFAULT_UNIX_SOCKET_PERM
;

1295 
£rv”
.
fd_couÁ
 = 0;

1296 
£rv”
.
sofd
 = -1;

1297 
£rv”
.
´Ùeùed_mode
 = 
CONFIG_DEFAULT_PROTECTED_MODE
;

1298 
£rv”
.
dbnum
 = 
CONFIG_DEFAULT_DBNUM
;

1299 
£rv”
.
v”bos™y
 = 
CONFIG_DEFAULT_VERBOSITY
;

1300 
£rv”
.
maxidËtime
 = 
CONFIG_DEFAULT_CLIENT_TIMEOUT
;

1301 
£rv”
.
tık“·live
 = 
CONFIG_DEFAULT_TCP_KEEPALIVE
;

1302 
£rv”
.
aùive_expœe_’abËd
 = 1;

1303 
£rv”
.
ş›Á_max_qu”ybuf_Ën
 = 
PROTO_MAX_QUERYBUF_LEN
;

1304 
£rv”
.
§v•¬ams
 = 
NULL
;

1305 
£rv”
.
lßdšg
 = 0;

1306 
£rv”
.
logfe
 = 
	`z¡rdup
(
CONFIG_DEFAULT_LOGFILE
);

1307 
£rv”
.
sy¦og_’abËd
 = 
CONFIG_DEFAULT_SYSLOG_ENABLED
;

1308 
£rv”
.
sy¦og_id’t
 = 
	`z¡rdup
(
CONFIG_DEFAULT_SYSLOG_IDENT
);

1309 
£rv”
.
sy¦og_çc™y
 = 
LOG_LOCAL0
;

1310 
£rv”
.
d«mÚize
 = 
CONFIG_DEFAULT_DAEMONIZE
;

1311 
£rv”
.
su³rvi£d
 = 0;

1312 
£rv”
.
su³rvi£d_mode
 = 
SUPERVISED_NONE
;

1313 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

1314 
£rv”
.
aof_fsync
 = 
CONFIG_DEFAULT_AOF_FSYNC
;

1315 
£rv”
.
aof_no_fsync_Ú_»wr™e
 = 
CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
;

1316 
£rv”
.
aof_»wr™e_³rc
 = 
AOF_REWRITE_PERC
;

1317 
£rv”
.
aof_»wr™e_mš_size
 = 
AOF_REWRITE_MIN_SIZE
;

1318 
£rv”
.
aof_»wr™e_ba£_size
 = 0;

1319 
£rv”
.
aof_»wr™e_scheduËd
 = 0;

1320 
£rv”
.
aof_Ï¡_fsync
 = 
	`time
(
NULL
);

1321 
£rv”
.
aof_»wr™e_time_Ï¡
 = -1;

1322 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

1323 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_OK
;

1324 
£rv”
.
aof_d–ayed_fsync
 = 0;

1325 
£rv”
.
aof_fd
 = -1;

1326 
£rv”
.
aof_£Ëùed_db
 = -1;

1327 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = 0;

1328 
£rv”
.
aof_»wr™e_šüem’l_fsync
 = 
CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
;

1329 
£rv”
.
aof_lßd_Œunÿ‹d
 = 
CONFIG_DEFAULT_AOF_LOAD_TRUNCATED
;

1330 
£rv”
.
pidfe
 = 
NULL
;

1331 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
CONFIG_DEFAULT_RDB_FILENAME
);

1332 
£rv”
.
aof_f’ame
 = 
	`z¡rdup
(
CONFIG_DEFAULT_AOF_FILENAME
);

1333 
£rv”
.
»quœ•ass
 = 
NULL
;

1334 
£rv”
.
rdb_com´essiÚ
 = 
CONFIG_DEFAULT_RDB_COMPRESSION
;

1335 
£rv”
.
rdb_checksum
 = 
CONFIG_DEFAULT_RDB_CHECKSUM
;

1336 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 
CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
;

1337 
£rv”
.
aùiv”ehashšg
 = 
CONFIG_DEFAULT_ACTIVE_REHASHING
;

1338 
£rv”
.
nÙify_key¥aû_ev’ts
 = 0;

1339 
£rv”
.
maxş›Ás
 = 
CONFIG_DEFAULT_MAX_CLIENTS
;

1340 
£rv”
.
bpİ_blocked_ş›Ás
 = 0;

1341 
£rv”
.
maxmemÜy
 = 
CONFIG_DEFAULT_MAXMEMORY
;

1342 
£rv”
.
maxmemÜy_pŞicy
 = 
CONFIG_DEFAULT_MAXMEMORY_POLICY
;

1343 
£rv”
.
maxmemÜy_§m¶es
 = 
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
;

1344 
£rv”
.
lfu_log_çùÜ
 = 
CONFIG_DEFAULT_LFU_LOG_FACTOR
;

1345 
£rv”
.
lfu_deÿy_time
 = 
CONFIG_DEFAULT_LFU_DECAY_TIME
;

1346 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
OBJ_HASH_MAX_ZIPLIST_ENTRIES
;

1347 
£rv”
.
hash_max_zli¡_v®ue
 = 
OBJ_HASH_MAX_ZIPLIST_VALUE
;

1348 
£rv”
.
li¡_max_zli¡_size
 = 
OBJ_LIST_MAX_ZIPLIST_SIZE
;

1349 
£rv”
.
li¡_com´ess_d•th
 = 
OBJ_LIST_COMPRESS_DEPTH
;

1350 
£rv”
.
£t_max_št£t_’Œ›s
 = 
OBJ_SET_MAX_INTSET_ENTRIES
;

1351 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
OBJ_ZSET_MAX_ZIPLIST_ENTRIES
;

1352 
£rv”
.
z£t_max_zli¡_v®ue
 = 
OBJ_ZSET_MAX_ZIPLIST_VALUE
;

1353 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
;

1354 
£rv”
.
shutdown_a§p
 = 0;

1355 
£rv”
.
şu¡”_’abËd
 = 0;

1356 
£rv”
.
şu¡”_node_timeout
 = 
CLUSTER_DEFAULT_NODE_TIMEOUT
;

1357 
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 = 
CLUSTER_DEFAULT_MIGRATION_BARRIER
;

1358 
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 = 
CLUSTER_DEFAULT_SLAVE_VALIDITY
;

1359 
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
 = 
CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
;

1360 
£rv”
.
şu¡”_cÚfigfe
 = 
	`z¡rdup
(
CONFIG_DEFAULT_CLUSTER_CONFIG_FILE
);

1361 
£rv”
.
şu¡”_ªnounû_
 = 
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_IP
;

1362 
£rv”
.
şu¡”_ªnounû_pÜt
 = 
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT
;

1363 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 = 
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT
;

1364 
£rv”
.
mig¿‹_ÿched_sock‘s
 = 
	`diùC»©e
(&
mig¿‹CacheDiùTy³
,
NULL
);

1365 
£rv”
.
Ãxt_ş›Á_id
 = 1;

1366 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 = (1024*1024*2);

1367 
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
 = 
CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION
;

1368 
£rv”
.
Ïzyä“_Ïzy_expœe
 = 
CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE
;

1369 
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
 = 
CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL
;

1371 
£rv”
.
Ìuşock
 = 
	`g‘LRUClock
();

1372 
	`»£tS”v”SaveP¬ams
();

1374 
	`­³ndS”v”SaveP¬ams
(60*60,1);

1375 
	`­³ndS”v”SaveP¬ams
(300,100);

1376 
	`­³ndS”v”SaveP¬ams
(60,10000);

1379 
£rv”
.
ma¡”auth
 = 
NULL
;

1380 
£rv”
.
ma¡”ho¡
 = 
NULL
;

1381 
£rv”
.
ma¡”pÜt
 = 6379;

1382 
£rv”
.
ma¡”
 = 
NULL
;

1383 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

1384 
£rv”
.
»¶_ma¡”_š™Ÿl_off£t
 = -1;

1385 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_NONE
;

1386 
£rv”
.
»¶_syncio_timeout
 = 
CONFIG_REPL_SYNCIO_TIMEOUT
;

1387 
£rv”
.
»¶_£rve_¡®e_d©a
 = 
CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA
;

1388 
£rv”
.
»¶_¦ave_ro
 = 
CONFIG_DEFAULT_SLAVE_READ_ONLY
;

1389 
£rv”
.
»¶_¦ave_Ïzy_æush
 = 
CONFIG_DEFAULT_SLAVE_LAZY_FLUSH
;

1390 
£rv”
.
»¶_down_sšû
 = 0;

1391 
£rv”
.
»¶_di§bË_tı_nod–ay
 = 
CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY
;

1392 
£rv”
.
»¶_diskËss_sync
 = 
CONFIG_DEFAULT_REPL_DISKLESS_SYNC
;

1393 
£rv”
.
»¶_diskËss_sync_d–ay
 = 
CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY
;

1394 
£rv”
.
»¶_pšg_¦ave_³riod
 = 
CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD
;

1395 
£rv”
.
»¶_timeout
 = 
CONFIG_DEFAULT_REPL_TIMEOUT
;

1396 
£rv”
.
»¶_mš_¦aves_to_wr™e
 = 
CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE
;

1397 
£rv”
.
»¶_mš_¦aves_max_Ïg
 = 
CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG
;

1398 
£rv”
.
¦ave_´iÜ™y
 = 
CONFIG_DEFAULT_SLAVE_PRIORITY
;

1399 
£rv”
.
ma¡”_»¶_off£t
 = 0;

1402 
£rv”
.
»¶_backlog
 = 
NULL
;

1403 
£rv”
.
»¶_backlog_size
 = 
CONFIG_DEFAULT_REPL_BACKLOG_SIZE
;

1404 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

1405 
£rv”
.
»¶_backlog_idx
 = 0;

1406 
£rv”
.
»¶_backlog_off
 = 0;

1407 
£rv”
.
»¶_backlog_time_lim™
 = 
CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
;

1408 
£rv”
.
»¶_no_¦aves_sšû
 = 
	`time
(
NULL
);

1411 
j
 = 0; j < 
CLIENT_TYPE_OBUF_COUNT
; j++)

1412 
£rv”
.
ş›Á_obuf_lim™s
[
j
] = 
ş›ÁBufãrLim™sDeçuÉs
[j];

1415 
R_Z”o
 = 0.0;

1416 
R_PosInf
 = 1.0/
R_Z”o
;

1417 
R_NegInf
 = -1.0/
R_Z”o
;

1418 
R_Nª
 = 
R_Z”o
/R_Zero;

1423 
£rv”
.
commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

1424 
£rv”
.
Üig_commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

1425 
	`pİuÏ‹CommªdTabË
();

1426 
£rv”
.
d–Commªd
 = 
	`lookupCommªdByCSŒšg
("del");

1427 
£rv”
.
muÉiCommªd
 = 
	`lookupCommªdByCSŒšg
("multi");

1428 
£rv”
.
ÍushCommªd
 = 
	`lookupCommªdByCSŒšg
("lpush");

1429 
£rv”
.
ÍİCommªd
 = 
	`lookupCommªdByCSŒšg
("lpop");

1430 
£rv”
.
½İCommªd
 = 
	`lookupCommªdByCSŒšg
("rpop");

1431 
£rv”
.
¤emCommªd
 = 
	`lookupCommªdByCSŒšg
("srem");

1432 
£rv”
.
execCommªd
 = 
	`lookupCommªdByCSŒšg
("exec");

1435 
£rv”
.
¦owlog_log_¦ow”_thª
 = 
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
;

1436 
£rv”
.
¦owlog_max_Ën
 = 
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
;

1439 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 = 
CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD
;

1442 
£rv”
.
as£¹_çed
 = "<no‡ssertion failed>";

1443 
£rv”
.
as£¹_fe
 = "<no file>";

1444 
£rv”
.
as£¹_lše
 = 0;

1445 
£rv”
.
bug_»pÜt_¡¬t
 = 0;

1446 
£rv”
.
w©chdog_³riod
 = 0;

1447 
	}
}

1449 **
’vœÚ
;

1466 
	$»¡¬tS”v”
(
æags
, 
m¡ime_t
 
d–ay
) {

1467 
j
;

1471 ià(
	`acûss
(
£rv”
.
execubË
,
X_OK
è=ğ-1è 
C_ERR
;

1474 ià(
æags
 & 
RESTART_SERVER_CONFIG_REWRITE
 &&

1475 
£rv”
.
cÚfigfe
 &&

1476 
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
è=ğ-1è 
C_ERR
;

1479 ià(
æags
 & 
RESTART_SERVER_GRACEFULLY
 &&

1480 
	`´•¬eFÜShutdown
(
SHUTDOWN_NOFLAGS
è!ğ
C_OK
è 
C_ERR
;

1484 
j
 = 3; j < ()
£rv”
.
maxş›Ás
 + 1024; j++è
	`şo£
(j);

1487 ià(
d–ay
è
	`u¦“p
(delay*1000);

1488 
	`execve
(
£rv”
.
execubË
,£rv”.
exec_¬gv
,
’vœÚ
);

1491 
	`_ex™
(1);

1493  
C_ERR
;

1494 
	}
}

1504 
	$adju¡O³nFesLim™
() {

1505 
¾im_t
 
maxfes
 = 
£rv”
.
maxş›Ás
+
CONFIG_MIN_RESERVED_FDS
;

1506 
¾im™
 
lim™
;

1508 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
,&
lim™
) == -1) {

1509 
	`£rv”Log
(
LL_WARNING
,"Unableo obtainhe current NOFILE†imit (%s),‡ssuming 1024‡nd settinghe max clients configuration‡ccordingly.",

1510 
	`¡»¼Ü
(
”ºo
));

1511 
£rv”
.
maxş›Ás
 = 1024-
CONFIG_MIN_RESERVED_FDS
;

1513 
¾im_t
 
Şdlim™
 = 
lim™
.
¾im_cur
;

1517 ià(
Şdlim™
 < 
maxfes
) {

1518 
¾im_t
 
be¡lim™
;

1519 
£Œlim™_”rÜ
 = 0;

1523 
be¡lim™
 = 
maxfes
;

1524 
be¡lim™
 > 
Şdlim™
) {

1525 
¾im_t
 
deü_¡•
 = 16;

1527 
lim™
.
¾im_cur
 = 
be¡lim™
;

1528 
lim™
.
¾im_max
 = 
be¡lim™
;

1529 ià(
	`£Œlim™
(
RLIMIT_NOFILE
,&
lim™
) != -1) ;

1530 
£Œlim™_”rÜ
 = 
”ºo
;

1534 ià(
be¡lim™
 < 
deü_¡•
) ;

1535 
be¡lim™
 -ğ
deü_¡•
;

1540 ià(
be¡lim™
 < 
Şdlim™
) bestlimit = oldlimit;

1542 ià(
be¡lim™
 < 
maxfes
) {

1543 
Şd_maxş›Ás
 = 
£rv”
.
maxş›Ás
;

1544 
£rv”
.
maxş›Ás
 = 
be¡lim™
-
CONFIG_MIN_RESERVED_FDS
;

1545 ià(
£rv”
.
maxş›Ás
 < 1) {

1546 
	`£rv”Log
(
LL_WARNING
,"Your current 'ulimit -n' "

1550 (è
Şdlim™
,

1551 (è
maxfes
);

1552 
	`ex™
(1);

1554 
	`£rv”Log
(
LL_WARNING
,"You„equested maxclients of %d "

1556 
Şd_maxş›Ás
,

1557 (è
maxfes
);

1558 
	`£rv”Log
(
LL_WARNING
,"Server can't set maximum open files "

1560 (è
maxfes
, 
	`¡»¼Ü
(
£Œlim™_”rÜ
));

1561 
	`£rv”Log
(
LL_WARNING
,"Current maximum open files is %llu. "

1565 (è
be¡lim™
, 
£rv”
.
maxş›Ás
);

1567 
	`£rv”Log
(
LL_NOTICE
,"Increased maximum‚umber of open files "

1569 (è
maxfes
,

1570 (è
Şdlim™
);

1574 
	}
}

1578 
	$checkTıBacklogS‘tšgs
() {

1579 #ifdeà
HAVE_PROC_SOMAXCONN


1580 
FILE
 *
å
 = 
	`fİ’
("/proc/sys/net/core/somaxconn","r");

1581 
buf
[1024];

1582 ià(!
å
) ;

1583 ià(
	`fg‘s
(
buf
,(buf),
å
è!ğ
NULL
) {

1584 
somaxcÚn
 = 
	`©oi
(
buf
);

1585 ià(
somaxcÚn
 > 0 && somaxcÚÀ< 
£rv”
.
tı_backlog
) {

1586 
	`£rv”Log
(
LL_WARNING
,"WARNING: ThTCP backlog s‘tšg oà%d cªnÙ b’fÜûd beÿu£ /´oc/sys/Ãt/cÜe/somaxcÚÀi £ˆtØthlow” v®uoà%d.", 
£rv”
.
tı_backlog
, 
somaxcÚn
);

1589 
	`fşo£
(
å
);

1591 
	}
}

1611 
	$li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
) {

1612 
j
;

1616 ià(
£rv”
.
bšdaddr_couÁ
 =ğ0è£rv”.
bšdaddr
[0] = 
NULL
;

1617 
j
 = 0; j < 
£rv”
.
bšdaddr_couÁ
 || j == 0; j++) {

1618 ià(
£rv”
.
bšdaddr
[
j
] =ğ
NULL
) {

1621 
fds
[*
couÁ
] = 
	`ª‘Tı6S”v”
(
£rv”
.
Ã‹¼
,
pÜt
,
NULL
,

1622 
£rv”
.
tı_backlog
);

1623 ià(
fds
[*
couÁ
] !ğ
ANET_ERR
) {

1624 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1625 (*
couÁ
)++;

1628 
fds
[*
couÁ
] = 
	`ª‘TıS”v”
(
£rv”
.
Ã‹¼
,
pÜt
,
NULL
,

1629 
£rv”
.
tı_backlog
);

1630 ià(
fds
[*
couÁ
] !ğ
ANET_ERR
) {

1631 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1632 (*
couÁ
)++;

1638 ià(*
couÁ
 == 2) ;

1639 } ià(
	`¡rchr
(
£rv”
.
bšdaddr
[
j
],':')) {

1641 
fds
[*
couÁ
] = 
	`ª‘Tı6S”v”
(
£rv”
.
Ã‹¼
,
pÜt
,£rv”.
bšdaddr
[
j
],

1642 
£rv”
.
tı_backlog
);

1645 
fds
[*
couÁ
] = 
	`ª‘TıS”v”
(
£rv”
.
Ã‹¼
,
pÜt
,£rv”.
bšdaddr
[
j
],

1646 
£rv”
.
tı_backlog
);

1648 ià(
fds
[*
couÁ
] =ğ
ANET_ERR
) {

1649 
	`£rv”Log
(
LL_WARNING
,

1651 
£rv”
.
bšdaddr
[
j
] ? server.bindaddr[j] : "*",

1652 
pÜt
, 
£rv”
.
Ã‹¼
);

1653  
C_ERR
;

1655 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1656 (*
couÁ
)++;

1658  
C_OK
;

1659 
	}
}

1664 
	$»£tS”v”Sts
() {

1665 
j
;

1667 
£rv”
.
¡©_numcommªds
 = 0;

1668 
£rv”
.
¡©_numcÚÃùiÚs
 = 0;

1669 
£rv”
.
¡©_expœedkeys
 = 0;

1670 
£rv”
.
¡©_eviùedkeys
 = 0;

1671 
£rv”
.
¡©_key¥aû_mis£s
 = 0;

1672 
£rv”
.
¡©_key¥aû_h™s
 = 0;

1673 
£rv”
.
¡©_fÜk_time
 = 0;

1674 
£rv”
.
¡©_fÜk_¿‹
 = 0;

1675 
£rv”
.
¡©_»jeùed_cÚn
 = 0;

1676 
£rv”
.
¡©_sync_fuÎ
 = 0;

1677 
£rv”
.
¡©_sync_·¹Ÿl_ok
 = 0;

1678 
£rv”
.
¡©_sync_·¹Ÿl_”r
 = 0;

1679 
j
 = 0; j < 
STATS_METRIC_COUNT
; j++) {

1680 
£rv”
.
š¡_m‘ric
[
j
].
idx
 = 0;

1681 
£rv”
.
š¡_m‘ric
[
j
].
Ï¡_§m¶e_time
 = 
	`m¡ime
();

1682 
£rv”
.
š¡_m‘ric
[
j
].
Ï¡_§m¶e_couÁ
 = 0;

1683 
	`mem£t
(
£rv”
.
š¡_m‘ric
[
j
].
§m¶es
,0,

1684 (
£rv”
.
š¡_m‘ric
[
j
].
§m¶es
));

1686 
£rv”
.
¡©_Ãt_šput_by‹s
 = 0;

1687 
£rv”
.
¡©_Ãt_ouut_by‹s
 = 0;

1688 
£rv”
.
aof_d–ayed_fsync
 = 0;

1689 
	}
}

1691 
	$š™S”v”
() {

1692 
j
;

1694 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

1695 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

1696 
	`£tupSigÇlHªdËrs
();

1698 ià(
£rv”
.
sy¦og_’abËd
) {

1699 
	`İ’log
(
£rv”
.
sy¦og_id’t
, 
LOG_PID
 | 
LOG_NDELAY
 | 
LOG_NOWAIT
,

1700 
£rv”
.
sy¦og_çc™y
);

1703 
£rv”
.
pid
 = 
	`g‘pid
();

1704 
£rv”
.
cu¼’t_ş›Á
 = 
NULL
;

1705 
£rv”
.
ş›Ás
 = 
	`li¡C»©e
();

1706 
£rv”
.
ş›Ás_to_şo£
 = 
	`li¡C»©e
();

1707 
£rv”
.
¦aves
 = 
	`li¡C»©e
();

1708 
£rv”
.
mÚ™Üs
 = 
	`li¡C»©e
();

1709 
£rv”
.
ş›Ás_³ndšg_wr™e
 = 
	`li¡C»©e
();

1710 
£rv”
.
¦ave£ldb
 = -1;

1711 
£rv”
.
unblocked_ş›Ás
 = 
	`li¡C»©e
();

1712 
£rv”
.
»ady_keys
 = 
	`li¡C»©e
();

1713 
£rv”
.
ş›Ás_wa™šg_acks
 = 
	`li¡C»©e
();

1714 
£rv”
.
g‘_ack_äom_¦aves
 = 0;

1715 
£rv”
.
ş›Ás_·u£d
 = 0;

1716 
£rv”
.
sy¡em_memÜy_size
 = 
	`zm®loc_g‘_memÜy_size
();

1718 
	`ü—‹Sh¬edObjeùs
();

1719 
	`adju¡O³nFesLim™
();

1720 
£rv”
.
–
 = 
	`«C»©eEv’tLoİ
(£rv”.
maxş›Ás
+
CONFIG_FDSET_INCR
);

1721 
£rv”
.
db
 = 
	`zm®loc
((
»disDb
)*£rv”.
dbnum
);

1724 ià(
£rv”
.
pÜt
 != 0 &&

1725 
	`li¡’ToPÜt
(
£rv”
.
pÜt
,£rv”.
fd
,&£rv”.
fd_couÁ
è=ğ
C_ERR
)

1726 
	`ex™
(1);

1729 ià(
£rv”
.
unixsock‘
 !ğ
NULL
) {

1730 
	`uÆšk
(
£rv”
.
unixsock‘
);

1731 
£rv”
.
sofd
 = 
	`ª‘UnixS”v”
(£rv”.
Ã‹¼
,£rv”.
unixsock‘
,

1732 
£rv”
.
unixsock‘³rm
, s”v”.
tı_backlog
);

1733 ià(
£rv”
.
sofd
 =ğ
ANET_ERR
) {

1734 
	`£rv”Log
(
LL_WARNING
, "O³nšg Unix sock‘: %s", 
£rv”
.
Ã‹¼
);

1735 
	`ex™
(1);

1737 
	`ª‘NÚBlock
(
NULL
,
£rv”
.
sofd
);

1741 ià(
£rv”
.
fd_couÁ
 =ğ0 && s”v”.
sofd
 < 0) {

1742 
	`£rv”Log
(
LL_WARNING
, "Configuredo‚ot†isten‡nywhere,ƒxiting.");

1743 
	`ex™
(1);

1747 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1748 
£rv”
.
db
[
j
].
diù
 = 
	`diùC»©e
(&
dbDiùTy³
,
NULL
);

1749 
£rv”
.
db
[
j
].
expœes
 = 
	`diùC»©e
(&
key±rDiùTy³
,
NULL
);

1750 
£rv”
.
db
[
j
].
blockšg_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1751 
£rv”
.
db
[
j
].
»ady_keys
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

1752 
£rv”
.
db
[
j
].
w©ched_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1753 
£rv”
.
db
[
j
].
id
 = j;

1754 
£rv”
.
db
[
j
].
avg_‰l
 = 0;

1756 
	`eviùiÚPoŞAÎoc
();

1757 
£rv”
.
pubsub_chªÃls
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1758 
£rv”
.
pubsub_·‰”ns
 = 
	`li¡C»©e
();

1759 
	`li¡S‘F»eM‘hod
(
£rv”
.
pubsub_·‰”ns
,
ä“PubsubP©‹º
);

1760 
	`li¡S‘M©chM‘hod
(
£rv”
.
pubsub_·‰”ns
,
li¡M©chPubsubP©‹º
);

1761 
£rv”
.
üÚloİs
 = 0;

1762 
£rv”
.
rdb_chd_pid
 = -1;

1763 
£rv”
.
aof_chd_pid
 = -1;

1764 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_NONE
;

1765 
	`aofRewr™eBufãrRe£t
();

1766 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

1767 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

1768 
£rv”
.
Ï¡bg§ve_Œy
 = 0;

1769 
£rv”
.
rdb_§ve_time_Ï¡
 = -1;

1770 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1771 
£rv”
.
dœty
 = 0;

1772 
	`»£tS”v”Sts
();

1774 
£rv”
.
¡©_¡¬‰ime
 = 
	`time
(
NULL
);

1775 
£rv”
.
¡©_³ak_memÜy
 = 0;

1776 
£rv”
.
»sid’t_£t_size
 = 0;

1777 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_OK
;

1778 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
C_OK
;

1779 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 0;

1780 
£rv”
.
»¶_good_¦aves_couÁ
 = 0;

1781 
	`upd©eCachedTime
();

1786 ià(
	`«C»©eTimeEv’t
(
£rv”
.
–
, 1, 
£rv”CrÚ
, 
NULL
, NULLè=ğ
AE_ERR
) {

1787 
	`£rv”Pªic
("Can't createƒvent†oopimers.");

1788 
	`ex™
(1);

1793 
j
 = 0; j < 
£rv”
.
fd_couÁ
; j++) {

1794 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
fd
[
j
], 
AE_READABLE
,

1795 
acû±TıHªdËr
,
NULL
è=ğ
AE_ERR
)

1797 
	`£rv”Pªic
(

1801 ià(
£rv”
.
sofd
 > 0 && 
	`«C»©eFeEv’t
(£rv”.
–
,£rv”.sofd,
AE_READABLE
,

1802 
acû±UnixHªdËr
,
NULL
è=ğ
AE_ERR
è
	`£rv”Pªic
("Unrecoverableƒrror creating server.sofd fileƒvent.");

1805 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
) {

1806 
£rv”
.
aof_fd
 = 
	`İ’
(£rv”.
aof_f’ame
,

1807 
O_WRONLY
|
O_APPEND
|
O_CREAT
,0644);

1808 ià(
£rv”
.
aof_fd
 == -1) {

1809 
	`£rv”Log
(
LL_WARNING
, "Can't openhe‡ppend-only file: %s",

1810 
	`¡»¼Ü
(
”ºo
));

1811 
	`ex™
(1);

1819 ià(
£rv”
.
¬ch_b™s
 =ğ32 && s”v”.
maxmemÜy
 == 0) {

1820 
	`£rv”Log
(
LL_WARNING
,"Warning: 32 bit instance detected but‚o memory†imit set. Setting 3 GB maxmemory†imit with 'noeviction'…olicy‚ow.");

1821 
£rv”
.
maxmemÜy
 = 3072LL*(1024*1024);

1822 
£rv”
.
maxmemÜy_pŞicy
 = 
MAXMEMORY_NO_EVICTION
;

1825 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”In™
();

1826 
	`»¶iÿtiÚSütCacheIn™
();

1827 
	`sütšgIn™
(1);

1828 
	`¦owlogIn™
();

1829 
	`Ï‹ncyMÚ™ÜIn™
();

1830 
	`bioIn™
();

1831 
	}
}

1835 
	$pİuÏ‹CommªdTabË
() {

1836 
j
;

1837 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

1839 
j
 = 0; j < 
numcommªds
; j++) {

1840 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

1841 *
f
 = 
c
->
sæags
;

1842 
»tv®1
, 
»tv®2
;

1844 *
f
 != '\0') {

1845 *
f
) {

1846 'w': 
c
->
æags
 |ğ
CMD_WRITE
; ;

1847 'r': 
c
->
æags
 |ğ
CMD_READONLY
; ;

1848 'm': 
c
->
æags
 |ğ
CMD_DENYOOM
; ;

1849 'a': 
c
->
æags
 |ğ
CMD_ADMIN
; ;

1850 'p': 
c
->
æags
 |ğ
CMD_PUBSUB
; ;

1851 's': 
c
->
æags
 |ğ
CMD_NOSCRIPT
; ;

1852 'R': 
c
->
æags
 |ğ
CMD_RANDOM
; ;

1853 'S': 
c
->
æags
 |ğ
CMD_SORT_FOR_SCRIPT
; ;

1854 'l': 
c
->
æags
 |ğ
CMD_LOADING
; ;

1855 't': 
c
->
æags
 |ğ
CMD_STALE
; ;

1856 'M': 
c
->
æags
 |ğ
CMD_SKIP_MONITOR
; ;

1857 'k': 
c
->
æags
 |ğ
CMD_ASKING
; ;

1858 'F': 
c
->
æags
 |ğ
CMD_FAST
; ;

1859 : 
	`£rv”Pªic
("Unsupported command flag"); ;

1861 
f
++;

1864 
»tv®1
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

1867 
»tv®2
 = 
	`diùAdd
(
£rv”
.
Üig_commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

1868 
	`£rv”As£¹
(
»tv®1
 =ğ
DICT_OK
 && 
»tv®2
 == DICT_OK);

1870 
	}
}

1872 
	$»£tCommªdTabËSts
() {

1873 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

1874 
j
;

1876 
j
 = 0; j < 
numcommªds
; j++) {

1877 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

1879 
c
->
miüo£cÚds
 = 0;

1880 
c
->
ÿÎs
 = 0;

1882 
	}
}

1886 
	$»disOpA¼ayIn™
(
»disOpA¼ay
 *
ß
) {

1887 
ß
->
İs
 = 
NULL
;

1888 
ß
->
numİs
 = 0;

1889 
	}
}

1891 
	$»disOpA¼ayAµ’d
(
»disOpA¼ay
 *
ß
, 
»disCommªd
 *
cmd
, 
dbid
,

1892 
robj
 **
¬gv
, 
¬gc
, 
rg‘
)

1894 
»disOp
 *
İ
;

1896 
ß
->
İs
 = 
	`z»®loc
(ß->İs,(
»disOp
)*(ß->
numİs
+1));

1897 
İ
 = 
ß
->
İs
+ß->
numİs
;

1898 
İ
->
cmd
 = cmd;

1899 
İ
->
dbid
 = dbid;

1900 
İ
->
¬gv
 =‡rgv;

1901 
İ
->
¬gc
 =‡rgc;

1902 
İ
->
rg‘
 =arget;

1903 
ß
->
numİs
++;

1904  
ß
->
numİs
;

1905 
	}
}

1907 
	$»disOpA¼ayF»e
(
»disOpA¼ay
 *
ß
) {

1908 
ß
->
numİs
) {

1909 
j
;

1910 
»disOp
 *
İ
;

1912 
ß
->
numİs
--;

1913 
İ
 = 
ß
->
İs
+ß->
numİs
;

1914 
j
 = 0; j < 
İ
->
¬gc
; j++)

1915 
	`deüRefCouÁ
(
İ
->
¬gv
[
j
]);

1916 
	`zä“
(
İ
->
¬gv
);

1918 
	`zä“
(
ß
->
İs
);

1919 
	}
}

1923 
»disCommªd
 *
	$lookupCommªd
(
sds
 
Çme
) {

1924  
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

1925 
	}
}

1927 
»disCommªd
 *
	$lookupCommªdByCSŒšg
(*
s
) {

1928 
»disCommªd
 *
cmd
;

1929 
sds
 
Çme
 = 
	`sd¢ew
(
s
);

1931 
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

1932 
	`sdsä“
(
Çme
);

1933  
cmd
;

1934 
	}
}

1943 
»disCommªd
 *
	$lookupCommªdOrOrigš®
(
sds
 
Çme
) {

1944 
»disCommªd
 *
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

1946 ià(!
cmd
ècmd = 
	`diùF‘chV®ue
(
£rv”
.
Üig_commªds
,
Çme
);

1947  
cmd
;

1948 
	}
}

1961 
	$´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

1962 
æags
)

1964 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
 && 
æags
 & 
PROPAGATE_AOF
)

1965 
	`ãedAµ’dOÆyFe
(
cmd
,
dbid
,
¬gv
,
¬gc
);

1966 ià(
æags
 & 
PROPAGATE_REPL
)

1967 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
,
dbid
,
¬gv
,
¬gc
);

1968 
	}
}

1982 
	$®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

1983 
rg‘
)

1985 
robj
 **
¬gvcİy
;

1986 
j
;

1988 ià(
£rv”
.
lßdšg
) ;

1990 
¬gvcİy
 = 
	`zm®loc
((
robj
*)*
¬gc
);

1991 
j
 = 0; j < 
¬gc
; j++) {

1992 
¬gvcİy
[
j
] = 
¬gv
[j];

1993 
	`šüRefCouÁ
(
¬gv
[
j
]);

1995 
	`»disOpA¼ayAµ’d
(&
£rv”
.
®so_´İag©e
,
cmd
,
dbid
,
¬gvcİy
,
¬gc
,
rg‘
);

1996 
	}
}

2001 
	$fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
) {

2002 ià(
æags
 & 
PROPAGATE_REPL
è
c
->æag |ğ
CLIENT_FORCE_REPL
;

2003 ià(
æags
 & 
PROPAGATE_AOF
è
c
->æag |ğ
CLIENT_FORCE_AOF
;

2004 
	}
}

2009 
	$´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
) {

2010 
c
->
æags
 |ğ
CLIENT_PREVENT_PROP
;

2011 
	}
}

2014 
	$´ev’tCommªdAOF
(
ş›Á
 *
c
) {

2015 
c
->
æags
 |ğ
CLIENT_PREVENT_AOF_PROP
;

2016 
	}
}

2019 
	$´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
) {

2020 
c
->
æags
 |ğ
CLIENT_PREVENT_REPL_PROP
;

2021 
	}
}

2060 
	$ÿÎ
(
ş›Á
 *
c
, 
æags
) {

2061 
dœty
, 
¡¬t
, 
du¿tiÚ
;

2062 
ş›Á_Şd_æags
 = 
c
->
æags
;

2066 ià(
	`li¡L’gth
(
£rv”
.
mÚ™Üs
) &&

2067 !
£rv”
.
lßdšg
 &&

2068 !(
c
->
cmd
->
æags
 & (
CMD_SKIP_MONITOR
|
CMD_ADMIN
)))

2070 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

2075 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

2076 
»disOpA¼ay
 
´ev_®so_´İag©e
 = 
£rv”
.
®so_´İag©e
;

2077 
	`»disOpA¼ayIn™
(&
£rv”
.
®so_´İag©e
);

2080 
dœty
 = 
£rv”
.dirty;

2081 
¡¬t
 = 
	`u¡ime
();

2082 
c
->
cmd
->
	`´oc
(c);

2083 
du¿tiÚ
 = 
	`u¡ime
()-
¡¬t
;

2084 
dœty
 = 
£rv”
.dirty-dirty;

2085 ià(
dœty
 < 0) dirty = 0;

2089 ià(
£rv”
.
lßdšg
 && 
c
->
æags
 & 
CLIENT_LUA
)

2090 
æags
 &ğ~(
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
);

2095 ià(
c
->
æags
 & 
CLIENT_LUA
 && 
£rv”
.
lua_ÿÎ”
) {

2096 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
)

2097 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_REPL
;

2098 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
)

2099 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_AOF
;

2104 ià(
æags
 & 
CMD_CALL_SLOWLOG
 && 
c
->
cmd
->
´oc
 !ğ
execCommªd
) {

2105 *
Ï‹ncy_ev’t
 = (
c
->
cmd
->
æags
 & 
CMD_FAST
) ?

2107 
	`Ï‹ncyAddSam¶eIfN“ded
(
Ï‹ncy_ev’t
,
du¿tiÚ
/1000);

2108 
	`¦owlogPushEÁryIfN“ded
(
c
->
¬gv
,c->
¬gc
,
du¿tiÚ
);

2110 ià(
æags
 & 
CMD_CALL_STATS
) {

2111 
c
->
Ï¡cmd
->
miüo£cÚds
 +ğ
du¿tiÚ
;

2112 
c
->
Ï¡cmd
->
ÿÎs
++;

2116 ià(
æags
 & 
CMD_CALL_PROPAGATE
 &&

2117 (
c
->
æags
 & 
CLIENT_PREVENT_PROP
) != CLIENT_PREVENT_PROP)

2119 
´İag©e_æags
 = 
PROPAGATE_NONE
;

2123 ià(
dœty
è
´İag©e_æags
 |ğ(
PROPAGATE_AOF
|
PROPAGATE_REPL
);

2127 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
è
´İag©e_æags
 |ğ
PROPAGATE_REPL
;

2128 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
è
´İag©e_æags
 |ğ
PROPAGATE_AOF
;

2133 ià(
c
->
æags
 & 
CLIENT_PREVENT_REPL_PROP
 ||

2134 !(
æags
 & 
CMD_CALL_PROPAGATE_REPL
))

2135 
´İag©e_æags
 &ğ~
PROPAGATE_REPL
;

2136 ià(
c
->
æags
 & 
CLIENT_PREVENT_AOF_PROP
 ||

2137 !(
æags
 & 
CMD_CALL_PROPAGATE_AOF
))

2138 
´İag©e_æags
 &ğ~
PROPAGATE_AOF
;

2142 ià(
´İag©e_æags
 !ğ
PROPAGATE_NONE
)

2143 
	`´İag©e
(
c
->
cmd
,c->
db
->
id
,c->
¬gv
,c->
¬gc
,
´İag©e_æags
);

2148 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

2149 
c
->
æags
 |ğ
ş›Á_Şd_æags
 &

2150 (
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

2155 ià(
£rv”
.
®so_´İag©e
.
numİs
) {

2156 
j
;

2157 
»disOp
 *
rİ
;

2159 ià(
æags
 & 
CMD_CALL_PROPAGATE
) {

2160 
j
 = 0; j < 
£rv”
.
®so_´İag©e
.
numİs
; j++) {

2161 
rİ
 = &
£rv”
.
®so_´İag©e
.
İs
[
j
];

2162 
rg‘
 = 
rİ
->target;

2164 ià(!(
æags
&
CMD_CALL_PROPAGATE_AOF
)è
rg‘
 &ğ~
PROPAGATE_AOF
;

2165 ià(!(
æags
&
CMD_CALL_PROPAGATE_REPL
)è
rg‘
 &ğ~
PROPAGATE_REPL
;

2166 ià(
rg‘
)

2167 
	`´İag©e
(
rİ
->
cmd
,rİ->
dbid
,rİ->
¬gv
,rİ->
¬gc
,
rg‘
);

2170 
	`»disOpA¼ayF»e
(&
£rv”
.
®so_´İag©e
);

2172 
£rv”
.
®so_´İag©e
 = 
´ev_®so_´İag©e
;

2173 
£rv”
.
¡©_numcommªds
++;

2174 
	}
}

2184 
	$´oûssCommªd
(
ş›Á
 *
c
) {

2189 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"quit")) {

2190 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2191 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

2192  
C_ERR
;

2197 
c
->
cmd
 = c->
Ï¡cmd
 = 
	`lookupCommªd
(c->
¬gv
[0]->
±r
);

2198 ià(!
c
->
cmd
) {

2199 
	`æagT¿n§ùiÚ
(
c
);

2200 
	`addR•lyE¼ÜFÜm©
(
c
,"unknown command '%s'",

2201 (*)
c
->
¬gv
[0]->
±r
);

2202  
C_OK
;

2203 } ià((
c
->
cmd
->
¬™y
 > 0 && c->cmd->¬™y !ğc->
¬gc
) ||

2204 (
c
->
¬gc
 < -c->
cmd
->
¬™y
)) {

2205 
	`æagT¿n§ùiÚ
(
c
);

2206 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

2207 
c
->
cmd
->
Çme
);

2208  
C_OK
;

2212 ià(
£rv”
.
»quœ•ass
 && !
c
->
auth’tiÿ‹d
 && c->
cmd
->
´oc
 !ğ
authCommªd
)

2214 
	`æagT¿n§ùiÚ
(
c
);

2215 
	`addR•ly
(
c
,
sh¬ed
.
nßuth”r
);

2216  
C_OK
;

2223 ià(
£rv”
.
şu¡”_’abËd
 &&

2224 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

2225 !(
c
->
æags
 & 
CLIENT_LUA
 &&

2226 
£rv”
.
lua_ÿÎ”
->
æags
 & 
CLIENT_MASTER
) &&

2227 !(
c
->
cmd
->
g‘keys_´oc
 =ğ
NULL
 && c->cmd->
fœ¡key
 == 0 &&

2228 
c
->
cmd
->
´oc
 !ğ
execCommªd
))

2230 
hash¦Ù
;

2231 
”rÜ_code
;

2232 
şu¡”Node
 *
n
 = 
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,

2233 &
hash¦Ù
,&
”rÜ_code
);

2234 ià(
n
 =ğ
NULL
 ||‚ !ğ
£rv”
.
şu¡”
->
my£lf
) {

2235 ià(
c
->
cmd
->
´oc
 =ğ
execCommªd
) {

2236 
	`disÿrdT¿n§ùiÚ
(
c
);

2238 
	`æagT¿n§ùiÚ
(
c
);

2240 
	`şu¡”RedœeùCl›Á
(
c
,
n
,
hash¦Ù
,
”rÜ_code
);

2241  
C_OK
;

2250 ià(
£rv”
.
maxmemÜy
) {

2251 
»tv®
 = 
	`ä“MemÜyIfN“ded
();

2254 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
NULL
è 
C_ERR
;

2258 ià((
c
->
cmd
->
æags
 & 
CMD_DENYOOM
è&& 
»tv®
 =ğ
C_ERR
) {

2259 
	`æagT¿n§ùiÚ
(
c
);

2260 
	`addR•ly
(
c
, 
sh¬ed
.
oom”r
);

2261  
C_OK
;

2267 ià(((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

2268 
£rv”
.
§v•¬am¦’
 > 0 &&

2269 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_ERR
) ||

2270 
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_ERR
) &&

2271 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

2272 (
c
->
cmd
->
æags
 & 
CMD_WRITE
 ||

2273 
c
->
cmd
->
´oc
 =ğ
pšgCommªd
))

2275 
	`æagT¿n§ùiÚ
(
c
);

2276 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_OK
)

2277 
	`addR•ly
(
c
, 
sh¬ed
.
bg§v“¼
);

2279 
	`addR•lySds
(
c
,

2280 
	`sdsÿrštf
(
	`sd£m±y
(),

2282 
	`¡»¼Ü
(
£rv”
.
aof_Ï¡_wr™e_”ºo
)));

2283  
C_OK
;

2288 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

2289 
£rv”
.
»¶_mš_¦aves_to_wr™e
 &&

2290 
£rv”
.
»¶_mš_¦aves_max_Ïg
 &&

2291 
c
->
cmd
->
æags
 & 
CMD_WRITE
 &&

2292 
£rv”
.
»¶_good_¦aves_couÁ
 < s”v”.
»¶_mš_¦aves_to_wr™e
)

2294 
	`æagT¿n§ùiÚ
(
c
);

2295 
	`addR•ly
(
c
, 
sh¬ed
.
nÜ•liÿ£¼
);

2296  
C_OK
;

2301 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¦ave_ro
 &&

2302 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

2303 
c
->
cmd
->
æags
 & 
CMD_WRITE
)

2305 
	`addR•ly
(
c
, 
sh¬ed
.
ro¦av“¼
);

2306  
C_OK
;

2310 ià(
c
->
æags
 & 
CLIENT_PUBSUB
 &&

2311 
c
->
cmd
->
´oc
 !ğ
pšgCommªd
 &&

2312 
c
->
cmd
->
´oc
 !ğ
subsüibeCommªd
 &&

2313 
c
->
cmd
->
´oc
 !ğ
unsubsüibeCommªd
 &&

2314 
c
->
cmd
->
´oc
 !ğ
psubsüibeCommªd
 &&

2315 
c
->
cmd
->
´oc
 !ğ
punsubsüibeCommªd
) {

2316 
	`addR•lyE¼Ü
(
c
,"only (P)SUBSCRIBE / (P)UNSUBSCRIBE / PING / QUIT‡llowed inhis context");

2317  
C_OK
;

2322 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
 &&

2323 
£rv”
.
»¶_£rve_¡®e_d©a
 == 0 &&

2324 !(
c
->
cmd
->
æags
 & 
CMD_STALE
))

2326 
	`æagT¿n§ùiÚ
(
c
);

2327 
	`addR•ly
(
c
, 
sh¬ed
.
ma¡”dowÃ¼
);

2328  
C_OK
;

2333 ià(
£rv”
.
lßdšg
 && !(
c
->
cmd
->
æags
 & 
CMD_LOADING
)) {

2334 
	`addR•ly
(
c
, 
sh¬ed
.
lßdšg”r
);

2335  
C_OK
;

2339 ià(
£rv”
.
lua_timedout
 &&

2340 
c
->
cmd
->
´oc
 !ğ
authCommªd
 &&

2341 
c
->
cmd
->
´oc
 !ğ
»¶cÚfCommªd
 &&

2342 !(
c
->
cmd
->
´oc
 =ğ
shutdownCommªd
 &&

2343 
c
->
¬gc
 == 2 &&

2344 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'n') &&

2345 !(
c
->
cmd
->
´oc
 =ğ
sütCommªd
 &&

2346 
c
->
¬gc
 == 2 &&

2347 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'k'))

2349 
	`æagT¿n§ùiÚ
(
c
);

2350 
	`addR•ly
(
c
, 
sh¬ed
.
¦owsü‹¼
);

2351  
C_OK
;

2355 ià(
c
->
æags
 & 
CLIENT_MULTI
 &&

2356 
c
->
cmd
->
´oc
 !ğ
execCommªd
 && c->cmd->´oø!ğ
disÿrdCommªd
 &&

2357 
c
->
cmd
->
´oc
 !ğ
muÉiCommªd
 && c->cmd->´oø!ğ
w©chCommªd
)

2359 
	`queueMuÉiCommªd
(
c
);

2360 
	`addR•ly
(
c
,
sh¬ed
.
queued
);

2362 
	`ÿÎ
(
c
,
CMD_CALL_FULL
);

2363 
c
->
woff
 = 
£rv”
.
ma¡”_»¶_off£t
;

2364 ià(
	`li¡L’gth
(
£rv”
.
»ady_keys
))

2365 
	`hªdËCl›ÁsBlockedOnLi¡s
();

2367  
C_OK
;

2368 
	}
}

2374 
	$şo£Li¡’šgSock‘s
(
uÆšk_unix_sock‘
) {

2375 
j
;

2377 
j
 = 0; j < 
£rv”
.
fd_couÁ
; j++è
	`şo£
(£rv”.
fd
[j]);

2378 ià(
£rv”
.
sofd
 !ğ-1è
	`şo£
(server.sofd);

2379 ià(
£rv”
.
şu¡”_’abËd
)

2380 
j
 = 0; j < 
£rv”
.
cfd_couÁ
; j++è
	`şo£
(£rv”.
cfd
[j]);

2381 ià(
uÆšk_unix_sock‘
 && 
£rv”
.
unixsock‘
) {

2382 
	`£rv”Log
(
LL_NOTICE
,"Removinghe unix socket file.");

2383 
	`uÆšk
(
£rv”
.
unixsock‘
);

2385 
	}
}

2387 
	$´•¬eFÜShutdown
(
æags
) {

2388 
§ve
 = 
æags
 & 
SHUTDOWN_SAVE
;

2389 
no§ve
 = 
æags
 & 
SHUTDOWN_NOSAVE
;

2391 
	`£rv”Log
(
LL_WARNING
,"User„equested shutdown...");

2394 
	`ldbKlFÜkedSessiÚs
();

2399 ià(
£rv”
.
rdb_chd_pid
 != -1) {

2400 
	`£rv”Log
(
LL_WARNING
,"There is‡ child saving‡n .rdb. Killing it!");

2401 
	`kl
(
£rv”
.
rdb_chd_pid
,
SIGUSR1
);

2402 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

2405 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

2408 ià(
£rv”
.
aof_chd_pid
 != -1) {

2411 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_WAIT_REWRITE
) {

2412 
	`£rv”Log
(
LL_WARNING
, "Writing initial AOF, can'tƒxit.");

2413  
C_ERR
;

2415 
	`£rv”Log
(
LL_WARNING
,

2417 
	`kl
(
£rv”
.
aof_chd_pid
,
SIGUSR1
);

2420 
	`£rv”Log
(
LL_NOTICE
,"Calling fsync() onhe AOF file.");

2421 
	`aof_fsync
(
£rv”
.
aof_fd
);

2425 ià((
£rv”
.
§v•¬am¦’
 > 0 && !
no§ve
è|| 
§ve
) {

2426 
	`£rv”Log
(
LL_NOTICE
,"Savinghe final RDB snapshot beforeƒxiting.");

2428 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
è!ğ
C_OK
) {

2434 
	`£rv”Log
(
LL_WARNING
,"Errorryingo savehe DB, can'tƒxit.");

2435  
C_ERR
;

2440 ià(
£rv”
.
d«mÚize
 || s”v”.
pidfe
) {

2441 
	`£rv”Log
(
LL_NOTICE
,"Removinghe…id file.");

2442 
	`uÆšk
(
£rv”
.
pidfe
);

2447 
	`æushSÏvesOuutBufãrs
();

2450 
	`şo£Li¡’šgSock‘s
(1);

2451 
	`£rv”Log
(
LL_WARNING
,"%s is‚ow„eadyoƒxit, bye bye...",

2452 
£rv”
.
£Áš–_mode
 ? "Sentinel" : "Redis");

2453  
C_OK
;

2454 
	}
}

2467 
	$time_šd•’d’t_¡rcmp
(*
a
, *
b
) {

2468 
buç
[
CONFIG_AUTHPASS_MAX_LEN
], 
bufb
[CONFIG_AUTHPASS_MAX_LEN];

2473 
®’
 = 
	`¡¾’
(
a
);

2474 
bËn
 = 
	`¡¾’
(
b
);

2475 
j
;

2476 
diff
 = 0;

2481 ià(
®’
 > (
buç
è|| 
bËn
 > (
bufb
))  1;

2483 
	`mem£t
(
buç
,0,(bufa));

2484 
	`mem£t
(
bufb
,0,(bufb));

2487 
	`memıy
(
buç
,
a
,
®’
);

2488 
	`memıy
(
bufb
,
b
,
bËn
);

2492 
j
 = 0; j < (
buç
); j++) {

2493 
diff
 |ğ(
buç
[
j
] ^ 
bufb
[j]);

2496 
diff
 |ğ
®’
 ^ 
bËn
;

2497  
diff
;

2498 
	}
}

2500 
	$authCommªd
(
ş›Á
 *
c
) {

2501 ià(!
£rv”
.
»quœ•ass
) {

2502 
	`addR•lyE¼Ü
(
c
,"Client sent AUTH, but‚o…assword is set");

2503 } ià(!
	`time_šd•’d’t_¡rcmp
(
c
->
¬gv
[1]->
±r
, 
£rv”
.
»quœ•ass
)) {

2504 
c
->
auth’tiÿ‹d
 = 1;

2505 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2507 
c
->
auth’tiÿ‹d
 = 0;

2508 
	`addR•lyE¼Ü
(
c
,"invalid…assword");

2510 
	}
}

2514 
	$pšgCommªd
(
ş›Á
 *
c
) {

2516 ià(
c
->
¬gc
 > 2) {

2517 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

2518 
c
->
cmd
->
Çme
);

2522 ià(
c
->
æags
 & 
CLIENT_PUBSUB
) {

2523 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[2]);

2524 
	`addR•lyBulkCBufãr
(
c
,"pong",4);

2525 ià(
c
->
¬gc
 == 1)

2526 
	`addR•lyBulkCBufãr
(
c
,"",0);

2528 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2530 ià(
c
->
¬gc
 == 1)

2531 
	`addR•ly
(
c
,
sh¬ed
.
pÚg
);

2533 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2535 
	}
}

2537 
	$echoCommªd
(
ş›Á
 *
c
) {

2538 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2539 
	}
}

2541 
	$timeCommªd
(
ş›Á
 *
c
) {

2542 
timev®
 
tv
;

2546 
	`g‘timeofday
(&
tv
,
NULL
);

2547 
	`addR•lyMuÉiBulkL’
(
c
,2);

2548 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_£c
);

2549 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_u£c
);

2550 
	}
}

2553 
	$addR•lyCommªdFÏg
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
f
, *
»¶y
) {

2554 ià(
cmd
->
æags
 & 
f
) {

2555 
	`addR•lyStus
(
c
, 
»¶y
);

2559 
	}
}

2562 
	$addR•lyCommªd
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
) {

2563 ià(!
cmd
) {

2564 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

2567 
	`addR•lyMuÉiBulkL’
(
c
, 6);

2568 
	`addR•lyBulkCSŒšg
(
c
, 
cmd
->
Çme
);

2569 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
¬™y
);

2571 
æagcouÁ
 = 0;

2572 *
æagËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2573 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_WRITE
, "write");

2574 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_READONLY
, "readonly");

2575 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_DENYOOM
, "denyoom");

2576 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ADMIN
, "admin");

2577 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_PUBSUB
, "pubsub");

2578 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_NOSCRIPT
, "noscript");

2579 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_RANDOM
, "random");

2580 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SORT_FOR_SCRIPT
,"sort_for_script");

2581 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_LOADING
, "loading");

2582 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_STALE
, "stale");

2583 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SKIP_MONITOR
, "skip_monitor");

2584 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ASKING
, "asking");

2585 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_FAST
, "fast");

2586 ià((
cmd
->
g‘keys_´oc
 && !(cmd->
æags
 & 
CMD_MODULE
)) ||

2587 
cmd
->
æags
 & 
CMD_MODULE_GETKEYS
)

2589 
	`addR•lyStus
(
c
, "movablekeys");

2590 
æagcouÁ
 += 1;

2592 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
æagËn
, 
æagcouÁ
);

2594 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
fœ¡key
);

2595 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
Ï¡key
);

2596 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
key¡•
);

2598 
	}
}

2601 
	$commªdCommªd
(
ş›Á
 *
c
) {

2602 
diùI‹¿tÜ
 *
di
;

2603 
diùEÁry
 *
de
;

2605 ià(
c
->
¬gc
 == 1) {

2606 
	`addR•lyMuÉiBulkL’
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

2607 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
commªds
);

2608 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2609 
	`addR•lyCommªd
(
c
, 
	`diùG‘V®
(
de
));

2611 
	`diùR–—£I‹¿tÜ
(
di
);

2612 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "info")) {

2613 
i
;

2614 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

2615 
i
 = 2; i < 
c
->
¬gc
; i++) {

2616 
	`addR•lyCommªd
(
c
, 
	`diùF‘chV®ue
(
£rv”
.
commªds
, c->
¬gv
[
i
]->
±r
));

2618 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "couÁ"è&& c->
¬gc
 == 2) {

2619 
	`addR•lyLÚgLÚg
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

2620 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keys"è&& c->
¬gc
 >= 3) {

2621 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
c
->
¬gv
[2]->
±r
);

2622 *
keys
, 
numkeys
, 
j
;

2624 ià(!
cmd
) {

2625 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid command specified");

2627 } ià((
cmd
->
¬™y
 > 0 && cmd->¬™y !ğ
c
->
¬gc
-2) ||

2628 ((
c
->
¬gc
-2è< -
cmd
->
¬™y
))

2630 
	`addR•lyE¼Ü
(
c
,"Invalid‚umber of‡rguments specified for command");

2634 
keys
 = 
	`g‘KeysFromCommªd
(
cmd
,
c
->
¬gv
+2,c->
¬gc
-2,&
numkeys
);

2635 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

2636 
j
 = 0; j < 
numkeys
; j++è
	`addR•lyBulk
(
c
,c->
¬gv
[
keys
[j]+2]);

2637 
	`g‘KeysF»eResuÉ
(
keys
);

2639 
	`addR•lyE¼Ü
(
c
, "Unknown subcommand or wrong‚umber of‡rguments.");

2642 
	}
}

2646 
	$by‹sToHumª
(*
s
, 
n
) {

2647 
d
;

2649 ià(
n
 < 1024) {

2651 
	`¥rštf
(
s
,"%ÎuB",
n
);

2653 } ià(
n
 < (1024*1024)) {

2654 
d
 = ()
n
/(1024);

2655 
	`¥rštf
(
s
,"%.2fK",
d
);

2656 } ià(
n
 < (1024LL*1024*1024)) {

2657 
d
 = ()
n
/(1024*1024);

2658 
	`¥rštf
(
s
,"%.2fM",
d
);

2659 } ià(
n
 < (1024LL*1024*1024*1024)) {

2660 
d
 = ()
n
/(1024LL*1024*1024);

2661 
	`¥rštf
(
s
,"%.2fG",
d
);

2662 } ià(
n
 < (1024LL*1024*1024*1024*1024)) {

2663 
d
 = ()
n
/(1024LL*1024*1024*1024);

2664 
	`¥rštf
(
s
,"%.2fT",
d
);

2665 } ià(
n
 < (1024LL*1024*1024*1024*1024*1024)) {

2666 
d
 = ()
n
/(1024LL*1024*1024*1024*1024);

2667 
	`¥rštf
(
s
,"%.2fP",
d
);

2670 
	`¥rštf
(
s
,"%ÎuB",
n
);

2672 
	}
}

2677 
sds
 
	$g’RedisInfoSŒšg
(*
£ùiÚ
) {

2678 
sds
 
šfo
 = 
	`sd£m±y
();

2679 
time_t
 
u±ime
 = 
£rv”
.
unixtime
-£rv”.
¡©_¡¬‰ime
;

2680 
j
, 
numcommªds
;

2681 
ru§ge
 
£lf_ru
, 
c_ru
;

2682 
lŞ
, 
bib
;

2683 
®l£ùiÚs
 = 0, 
def£ùiÚs
 = 0;

2684 
£ùiÚs
 = 0;

2686 ià(
£ùiÚ
 =ğ
NULL
) section = "default";

2687 
®l£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"all") == 0;

2688 
def£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"default") == 0;

2690 
	`g‘ru§ge
(
RUSAGE_SELF
, &
£lf_ru
);

2691 
	`g‘ru§ge
(
RUSAGE_CHILDREN
, &
c_ru
);

2692 
	`g‘Cl›ÁsMaxBufãrs
(&
lŞ
,&
bib
);

2695 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"server")) {

2696 
ÿÎ_uÇme
 = 1;

2697 
ut¢ame
 
Çme
;

2698 *
mode
;

2700 ià(
£rv”
.
şu¡”_’abËd
è
mode
 = "cluster";

2701 ià(
£rv”
.
£Áš–_mode
è
mode
 = "sentinel";

2702 
mode
 = "standalone";

2704 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2706 ià(
ÿÎ_uÇme
) {

2708 
	`uÇme
(&
Çme
);

2709 
ÿÎ_uÇme
 = 0;

2712 
šfo
 = 
	`sdsÿrštf
(info,

2732 
REDIS_VERSION
,

2733 
	`»disG™SHA1
(),

2734 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

2735 (è
	`»disBudId
(),

2736 
mode
,

2737 
Çme
.
sy¢ame
,‚ame.
»Ëa£
,‚ame.
machše
,

2738 
£rv”
.
¬ch_b™s
,

2739 
	`«G‘ApiName
(),

2740 #ifdeà
__GNUC__


2741 
__GNUC__
,
__GNUC_MINOR__
,
__GNUC_PATCHLEVEL__
,

2745 (è
	`g‘pid
(),

2746 
£rv”
.
runid
,

2747 
£rv”
.
pÜt
,

2748 (
štmax_t
)
u±ime
,

2749 (
štmax_t
)(
u±ime
/(3600*24)),

2750 
£rv”
.
hz
,

2751 (è
£rv”
.
Ìuşock
,

2752 
£rv”
.
execubË
 ? server.executable : "",

2753 
£rv”
.
cÚfigfe
 ? server.configfile : "");

2757 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"clients")) {

2758 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2759 
šfo
 = 
	`sdsÿrštf
(info,

2765 
	`li¡L’gth
(
£rv”
.
ş›Ás
)-li¡L’gth(£rv”.
¦aves
),

2766 
lŞ
, 
bib
,

2767 
£rv”
.
bpİ_blocked_ş›Ás
);

2771 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"memory")) {

2772 
hmem
[64];

2773 
³ak_hmem
[64];

2774 
tÙ®_sy¡em_hmem
[64];

2775 
u£d_memÜy_lua_hmem
[64];

2776 
u£d_memÜy_rss_hmem
[64];

2777 
maxmemÜy_hmem
[64];

2778 
size_t
 
zm®loc_u£d
 = 
	`zm®loc_u£d_memÜy
();

2779 
size_t
 
tÙ®_sy¡em_mem
 = 
£rv”
.
sy¡em_memÜy_size
;

2780 cÚ¡ *
eviù_pŞicy
 = 
	`eviùPŞicyToSŒšg
();

2781 
memÜy_lua
 = ()
	`lua_gc
(
£rv”
.
lua
,
LUA_GCCOUNT
,0)*1024;

2787 ià(
zm®loc_u£d
 > 
£rv”
.
¡©_³ak_memÜy
)

2788 
£rv”
.
¡©_³ak_memÜy
 = 
zm®loc_u£d
;

2790 
	`by‹sToHumª
(
hmem
,
zm®loc_u£d
);

2791 
	`by‹sToHumª
(
³ak_hmem
,
£rv”
.
¡©_³ak_memÜy
);

2792 
	`by‹sToHumª
(
tÙ®_sy¡em_hmem
,
tÙ®_sy¡em_mem
);

2793 
	`by‹sToHumª
(
u£d_memÜy_lua_hmem
,
memÜy_lua
);

2794 
	`by‹sToHumª
(
u£d_memÜy_rss_hmem
,
£rv”
.
»sid’t_£t_size
);

2795 
	`by‹sToHumª
(
maxmemÜy_hmem
,
£rv”
.
maxmemÜy
);

2797 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2798 
šfo
 = 
	`sdsÿrštf
(info,

2816 
zm®loc_u£d
,

2817 
hmem
,

2818 
£rv”
.
»sid’t_£t_size
,

2819 
u£d_memÜy_rss_hmem
,

2820 
£rv”
.
¡©_³ak_memÜy
,

2821 
³ak_hmem
,

2822 ()
tÙ®_sy¡em_mem
,

2823 
tÙ®_sy¡em_hmem
,

2824 
memÜy_lua
,

2825 
u£d_memÜy_lua_hmem
,

2826 
£rv”
.
maxmemÜy
,

2827 
maxmemÜy_hmem
,

2828 
eviù_pŞicy
,

2829 
	`zm®loc_g‘_äagm’tiÚ_¿tio
(
£rv”
.
»sid’t_£t_size
),

2830 
ZMALLOC_LIB
,

2831 
	`Ïzyä“G‘P’dšgObjeùsCouÁ
()

2836 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"persistence")) {

2837 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2838 
šfo
 = 
	`sdsÿrštf
(info,

2854 
£rv”
.
lßdšg
,

2855 
£rv”
.
dœty
,

2856 
£rv”
.
rdb_chd_pid
 != -1,

2857 (
štmax_t
)
£rv”
.
Ï¡§ve
,

2858 (
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_OK
) ? "ok" : "err",

2859 (
štmax_t
)
£rv”
.
rdb_§ve_time_Ï¡
,

2860 (
štmax_t
)((
£rv”
.
rdb_chd_pid
 == -1) ?

2861 -1 : 
	`time
(
NULL
)-
£rv”
.
rdb_§ve_time_¡¬t
),

2862 
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
,

2863 
£rv”
.
aof_chd_pid
 != -1,

2864 
£rv”
.
aof_»wr™e_scheduËd
,

2865 (
štmax_t
)
£rv”
.
aof_»wr™e_time_Ï¡
,

2866 (
štmax_t
)((
£rv”
.
aof_chd_pid
 == -1) ?

2867 -1 : 
	`time
(
NULL
)-
£rv”
.
aof_»wr™e_time_¡¬t
),

2868 (
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 =ğ
C_OK
) ? "ok" : "err",

2869 (
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_OK
) ? "ok" : "err");

2871 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

2872 
šfo
 = 
	`sdsÿrštf
(info,

2880 (è
£rv”
.
aof_cu¼’t_size
,

2881 (è
£rv”
.
aof_»wr™e_ba£_size
,

2882 
£rv”
.
aof_»wr™e_scheduËd
,

2883 
	`sd¦’
(
£rv”
.
aof_buf
),

2884 
	`aofRewr™eBufãrSize
(),

2885 
	`bioP’dšgJobsOfTy³
(
BIO_AOF_FSYNC
),

2886 
£rv”
.
aof_d–ayed_fsync
);

2889 ià(
£rv”
.
lßdšg
) {

2890 
³rc
;

2891 
time_t
 
‘a
, 
–­£d
;

2892 
off_t
 
»maššg_by‹s
 = 
£rv”
.
lßdšg_tÙ®_by‹s
-

2893 
£rv”
.
lßdšg_lßded_by‹s
;

2895 
³rc
 = (()
£rv”
.
lßdšg_lßded_by‹s
 /

2896 (
£rv”
.
lßdšg_tÙ®_by‹s
+1)) * 100;

2898 
–­£d
 = 
	`time
(
NULL
)-
£rv”
.
lßdšg_¡¬t_time
;

2899 ià(
–­£d
 == 0) {

2900 
‘a
 = 1;

2903 
‘a
 = (
–­£d
*
»maššg_by‹s
)/(
£rv”
.
lßdšg_lßded_by‹s
+1);

2906 
šfo
 = 
	`sdsÿrštf
(info,

2912 (
štmax_t
è
£rv”
.
lßdšg_¡¬t_time
,

2913 (è
£rv”
.
lßdšg_tÙ®_by‹s
,

2914 (è
£rv”
.
lßdšg_lßded_by‹s
,

2915 
³rc
,

2916 (
štmax_t
)
‘a


2922 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"stats")) {

2923 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2924 
šfo
 = 
	`sdsÿrštf
(info,

2945 
£rv”
.
¡©_numcÚÃùiÚs
,

2946 
£rv”
.
¡©_numcommªds
,

2947 
	`g‘In¡ªÃousM‘ric
(
STATS_METRIC_COMMAND
),

2948 
£rv”
.
¡©_Ãt_šput_by‹s
,

2949 
£rv”
.
¡©_Ãt_ouut_by‹s
,

2950 ()
	`g‘In¡ªÃousM‘ric
(
STATS_METRIC_NET_INPUT
)/1024,

2951 ()
	`g‘In¡ªÃousM‘ric
(
STATS_METRIC_NET_OUTPUT
)/1024,

2952 
£rv”
.
¡©_»jeùed_cÚn
,

2953 
£rv”
.
¡©_sync_fuÎ
,

2954 
£rv”
.
¡©_sync_·¹Ÿl_ok
,

2955 
£rv”
.
¡©_sync_·¹Ÿl_”r
,

2956 
£rv”
.
¡©_expœedkeys
,

2957 
£rv”
.
¡©_eviùedkeys
,

2958 
£rv”
.
¡©_key¥aû_h™s
,

2959 
£rv”
.
¡©_key¥aû_mis£s
,

2960 
	`diùSize
(
£rv”
.
pubsub_chªÃls
),

2961 
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
),

2962 
£rv”
.
¡©_fÜk_time
,

2963 
	`diùSize
(
£rv”
.
mig¿‹_ÿched_sock‘s
));

2967 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"replication")) {

2968 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2969 
šfo
 = 
	`sdsÿrštf
(info,

2972 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 ? "master" : "slave");

2973 ià(
£rv”
.
ma¡”ho¡
) {

2974 
¦ave_»¶_off£t
 = 1;

2976 ià(
£rv”
.
ma¡”
)

2977 
¦ave_»¶_off£t
 = 
£rv”
.
ma¡”
->
»¶off
;

2978 ià(
£rv”
.
ÿched_ma¡”
)

2979 
¦ave_»¶_off£t
 = 
£rv”
.
ÿched_ma¡”
->
»¶off
;

2981 
šfo
 = 
	`sdsÿrštf
(info,

2988 ,
£rv”
.
ma¡”ho¡
,

2989 
£rv”
.
ma¡”pÜt
,

2990 (
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTED
) ?

2992 
£rv”
.
ma¡”
 ?

2993 (()(
£rv”
.
unixtime
-£rv”.
ma¡”
->
Ï¡š‹¿ùiÚ
)) : -1,

2994 
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
,

2995 
¦ave_»¶_off£t


2998 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
) {

2999 
šfo
 = 
	`sdsÿrštf
(info,

3003 (
£rv”
.
»¶_Œªsãr_size
 - s”v”.
»¶_Œªsãr_»ad
),

3004 ()(
£rv”
.
unixtime
-£rv”.
»¶_Œªsãr_Ï¡io
)

3008 ià(
£rv”
.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
) {

3009 
šfo
 = 
	`sdsÿrštf
(info,

3011 (
štmax_t
)
£rv”
.
unixtime
-£rv”.
»¶_down_sšû
);

3013 
šfo
 = 
	`sdsÿrštf
(info,

3016 
£rv”
.
¦ave_´iÜ™y
,

3017 
£rv”
.
»¶_¦ave_ro
);

3020 
šfo
 = 
	`sdsÿrštf
(info,

3022 
	`li¡L’gth
(
£rv”
.
¦aves
));

3026 ià(
£rv”
.
»¶_mš_¦aves_to_wr™e
 &&

3027 
£rv”
.
»¶_mš_¦aves_max_Ïg
) {

3028 
šfo
 = 
	`sdsÿrštf
(info,

3030 
£rv”
.
»¶_good_¦aves_couÁ
);

3033 ià(
	`li¡L’gth
(
£rv”
.
¦aves
)) {

3034 
¦aveid
 = 0;

3035 
li¡Node
 *
Ê
;

3036 
li¡I‹r
 
li
;

3038 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

3039 (
Ê
 = 
	`li¡Next
(&
li
))) {

3040 
ş›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

3041 *
¡©e
 = 
NULL
;

3042 

[
NET_IP_STR_LEN
];

3043 
pÜt
;

3044 
Ïg
 = 0;

3046 ià(
	`ª‘P“rToSŒšg
(
¦ave
->
fd
,

,(),&
pÜt
) == -1) ;

3047 
¦ave
->
»¶¡©e
) {

3048 
SLAVE_STATE_WAIT_BGSAVE_START
:

3049 
SLAVE_STATE_WAIT_BGSAVE_END
:

3050 
¡©e
 = "wait_bgsave";

3052 
SLAVE_STATE_SEND_BULK
:

3053 
¡©e
 = "send_bulk";

3055 
SLAVE_STATE_ONLINE
:

3056 
¡©e
 = "online";

3059 ià(
¡©e
 =ğ
NULL
) ;

3060 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
)

3061 
Ïg
 = 
	`time
(
NULL
è- 
¦ave
->
»¶_ack_time
;

3063 
šfo
 = 
	`sdsÿrštf
(info,

3066 
¦aveid
,

,
¦ave
->
¦ave_li¡’šg_pÜt
,
¡©e
,

3067 
¦ave
->
»¶_ack_off
, 
Ïg
);

3068 
¦aveid
++;

3071 
šfo
 = 
	`sdsÿrštf
(info,

3077 
£rv”
.
ma¡”_»¶_off£t
,

3078 
£rv”
.
»¶_backlog
 !ğ
NULL
,

3079 
£rv”
.
»¶_backlog_size
,

3080 
£rv”
.
»¶_backlog_off
,

3081 
£rv”
.
»¶_backlog_hi¡Ën
);

3085 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cpu")) {

3086 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3087 
šfo
 = 
	`sdsÿrštf
(info,

3093 ()
£lf_ru
.
ru_¡ime
.
tv_£c
+()£lf_ru.ru_¡ime.
tv_u£c
/1000000,

3094 ()
£lf_ru
.
ru_utime
.
tv_£c
+()£lf_ru.ru_utime.
tv_u£c
/1000000,

3095 ()
c_ru
.
ru_¡ime
.
tv_£c
+()c_ru.ru_¡ime.
tv_u£c
/1000000,

3096 ()
c_ru
.
ru_utime
.
tv_£c
+()c_ru.ru_utime.
tv_u£c
/1000000);

3100 ià(
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"commandstats")) {

3101 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3102 
šfo
 = 
	`sdsÿrštf
(info, "# Commandstats\r\n");

3103 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

3104 
j
 = 0; j < 
numcommªds
; j++) {

3105 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

3107 ià(!
c
->
ÿÎs
) ;

3108 
šfo
 = 
	`sdsÿrštf
(info,

3110 
c
->
Çme
, c->
ÿÎs
, c->
miüo£cÚds
,

3111 (
c
->
ÿÎs
 =ğ0è? 0 : (()c->
miüo£cÚds
/c->calls));

3116 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cluster")) {

3117 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3118 
šfo
 = 
	`sdsÿrštf
(info,

3121 
£rv”
.
şu¡”_’abËd
);

3125 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"keyspace")) {

3126 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3127 
šfo
 = 
	`sdsÿrštf
(info, "# Keyspace\r\n");

3128 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

3129 
keys
, 
vkeys
;

3131 
keys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

3132 
vkeys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
expœes
);

3133 ià(
keys
 || 
vkeys
) {

3134 
šfo
 = 
	`sdsÿrštf
(info,

3136 
j
, 
keys
, 
vkeys
, 
£rv”
.
db
[j].
avg_‰l
);

3140  
šfo
;

3141 
	}
}

3143 
	$šfoCommªd
(
ş›Á
 *
c
) {

3144 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : "default";

3146 ià(
c
->
¬gc
 > 2) {

3147 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

3150 
	`addR•lyBulkSds
(
c
, 
	`g’RedisInfoSŒšg
(
£ùiÚ
));

3151 
	}
}

3153 
	$mÚ™ÜCommªd
(
ş›Á
 *
c
) {

3155 ià(
c
->
æags
 & 
CLIENT_SLAVE
) ;

3157 
c
->
æags
 |ğ(
CLIENT_SLAVE
|
CLIENT_MONITOR
);

3158 
	`li¡AddNodeTa
(
£rv”
.
mÚ™Üs
,
c
);

3159 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3160 
	}
}

3164 #ifdeà
__lšux__


3165 
	$lšuxOv”comm™MemÜyV®ue
() {

3166 
FILE
 *
å
 = 
	`fİ’
("/proc/sys/vm/overcommit_memory","r");

3167 
buf
[64];

3169 ià(!
å
)  -1;

3170 ià(
	`fg‘s
(
buf
,64,
å
è=ğ
NULL
) {

3171 
	`fşo£
(
å
);

3174 
	`fşo£
(
å
);

3176  
	`©oi
(
buf
);

3177 
	}
}

3179 
	$lšuxMemÜyW¬nšgs
() {

3180 ià(
	`lšuxOv”comm™MemÜyV®ue
() == 0) {

3181 
	`£rv”Log
(
LL_WARNING
,"WARNING overcommit_memory is seto 0! Background save may fail under†ow memory condition. To fixhis issue‡dd 'vm.overcommit_memory = 1'o /etc/sysctl.conf‡ndhen„eboot or„unhe command 'sysctl vm.overcommit_memory=1' forhisoakeƒffect.");

3183 ià(
	`THPIsEÇbËd
()) {

3184 
	`£rv”Log
(
LL_WARNING
,"WARNING you have Transparent Huge Pages (THP) supportƒnabled in your kernel. This will create†atency‡nd memory usage issues with Redis. To fixhis issue„unhe command 'echo‚ever > /sys/kernel/mm/transparent_hugepage/enabled'‡s„oot,‡nd‡dd ito your /etc/rc.local in ordero„etainhe setting‡fter‡„eboot. Redis must be„estarted‡fter THP is disabled.");

3186 
	}
}

3189 
	$ü—‹PidFe
() {

3192 ià(!
£rv”
.
pidfe
è£rv”.pidfğ
	`z¡rdup
(
CONFIG_DEFAULT_PID_FILE
);

3195 
FILE
 *
å
 = 
	`fİ’
(
£rv”
.
pidfe
,"w");

3196 ià(
å
) {

3197 
	`årštf
(
å
,"%d\n",()
	`g‘pid
());

3198 
	`fşo£
(
å
);

3200 
	}
}

3202 
	$d«mÚize
() {

3203 
fd
;

3205 ià(
	`fÜk
(è!ğ0è
	`ex™
(0);

3206 
	`£tsid
();

3211 ià((
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
, 0)) != -1) {

3212 
	`dup2
(
fd
, 
STDIN_FILENO
);

3213 
	`dup2
(
fd
, 
STDOUT_FILENO
);

3214 
	`dup2
(
fd
, 
STDERR_FILENO
);

3215 ià(
fd
 > 
STDERR_FILENO
è
	`şo£
(fd);

3217 
	}
}

3219 
	$v”siÚ
() {

3220 
	`´štf
("Redis server v=%s sha=%s:%d malloc=%s bits=%d build=%llx\n",

3221 
REDIS_VERSION
,

3222 
	`»disG™SHA1
(),

3223 
	`©oi
(
	`»disG™Dœty
()) > 0,

3224 
ZMALLOC_LIB
,

3226 (è
	`»disBudId
());

3227 
	`ex™
(0);

3228 
	}
}

3230 
	$u§ge
() {

3231 
	`årštf
(
¡d”r
,"Usage: ./redis-server [/path/to/redis.conf] [options]\n");

3232 
	`årštf
(
¡d”r
," ./redis-server - (read config from stdin)\n");

3233 
	`årštf
(
¡d”r
," ./redis-server -v or --version\n");

3234 
	`årštf
(
¡d”r
," ./redis-server -h or --help\n");

3235 
	`årštf
(
¡d”r
," ./redis-server --test-memory <megabytes>\n\n");

3236 
	`årštf
(
¡d”r
,"Examples:\n");

3237 
	`årštf
(
¡d”r
," ./redis-server (runhe server with default conf)\n");

3238 
	`årštf
(
¡d”r
," ./redis-server /etc/redis/6379.conf\n");

3239 
	`årštf
(
¡d”r
," ./redis-server --port 7777\n");

3240 
	`årštf
(
¡d”r
," ./redis-server --port 7777 --slaveof 127.0.0.1 8888\n");

3241 
	`årštf
(
¡d”r
," ./redis-server /etc/myredis.conf --loglevel verbose\n\n");

3242 
	`årštf
(
¡d”r
,"Sentinel mode:\n");

3243 
	`årštf
(
¡d”r
," ./redis-server /etc/sentinel.conf --sentinel\n");

3244 
	`ex™
(1);

3245 
	}
}

3247 
	$»disAsciiA¹
() {

3248 
	~"asciogo.h
"

3249 *
buf
 = 
	`zm®loc
(1024*16);

3250 *
mode
;

3252 ià(
£rv”
.
şu¡”_’abËd
è
mode
 = "cluster";

3253 ià(
£rv”
.
£Áš–_mode
è
mode
 = "sentinel";

3254 
mode
 = "standalone";

3256 ià(
£rv”
.
sy¦og_’abËd
) {

3257 
	`£rv”Log
(
LL_NOTICE
,

3259 
REDIS_VERSION
,

3260 
	`»disG™SHA1
(),

3261 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

3263 
mode
, 
£rv”
.
pÜt
,

3264 (è
	`g‘pid
()

3267 
	`¢´štf
(
buf
,1024*16,
ascii_logo
,

3268 
REDIS_VERSION
,

3269 
	`»disG™SHA1
(),

3270 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

3272 
mode
, 
£rv”
.
pÜt
,

3273 (è
	`g‘pid
()

3275 
	`£rv”LogRaw
(
LL_NOTICE
|
LL_RAW
,
buf
);

3277 
	`zä“
(
buf
);

3278 
	}
}

3280 
	$sigShutdownHªdËr
(
sig
) {

3281 *
msg
;

3283 
sig
) {

3284 
SIGINT
:

3285 
msg
 = "Received SIGINT scheduling shutdown...";

3287 
SIGTERM
:

3288 
msg
 = "Received SIGTERM scheduling shutdown...";

3291 
msg
 = "Received shutdown signal, scheduling shutdown...";

3298 ià(
£rv”
.
shutdown_a§p
 && 
sig
 =ğ
SIGINT
) {

3299 
	`£rv”LogFromHªdËr
(
LL_WARNING
, "You insist...ƒxiting‚ow.");

3300 
	`rdbRemoveTempFe
(
	`g‘pid
());

3301 
	`ex™
(1);

3302 } ià(
£rv”
.
lßdšg
) {

3303 
	`ex™
(0);

3306 
	`£rv”LogFromHªdËr
(
LL_WARNING
, 
msg
);

3307 
£rv”
.
shutdown_a§p
 = 1;

3308 
	}
}

3310 
	$£tupSigÇlHªdËrs
() {

3311 
sigaùiÚ
 
aù
;

3315 
	`sigem±y£t
(&
aù
.
§_mask
);

3316 
aù
.
§_æags
 = 0;

3317 
aù
.
§_hªdËr
 = 
sigShutdownHªdËr
;

3318 
	`sigaùiÚ
(
SIGTERM
, &
aù
, 
NULL
);

3319 
	`sigaùiÚ
(
SIGINT
, &
aù
, 
NULL
);

3321 #ifdeà
HAVE_BACKTRACE


3322 
	`sigem±y£t
(&
aù
.
§_mask
);

3323 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_RESETHAND
 | 
SA_SIGINFO
;

3324 
aù
.
§_sigaùiÚ
 = 
sig£gvHªdËr
;

3325 
	`sigaùiÚ
(
SIGSEGV
, &
aù
, 
NULL
);

3326 
	`sigaùiÚ
(
SIGBUS
, &
aù
, 
NULL
);

3327 
	`sigaùiÚ
(
SIGFPE
, &
aù
, 
NULL
);

3328 
	`sigaùiÚ
(
SIGILL
, &
aù
, 
NULL
);

3331 
	}
}

3333 
mem‹¡
(
size_t
 
megaby‹s
, 
·s£s
);

3337 
	$checkFÜS’tš–Mode
(
¬gc
, **
¬gv
) {

3338 
j
;

3340 ià(
	`¡r¡r
(
¬gv
[0],"»dis-£Áš–"è!ğ
NULL
)  1;

3341 
j
 = 1; j < 
¬gc
; j++)

3342 ià(!
	`¡rcmp
(
¬gv
[
j
],"--sentinel"))  1;

3344 
	}
}

3347 
	$lßdD©aFromDisk
() {

3348 
¡¬t
 = 
	`u¡ime
();

3349 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
) {

3350 ià(
	`lßdAµ’dOÆyFe
(
£rv”
.
aof_f’ame
è=ğ
C_OK
)

3351 
	`£rv”Log
(
LL_NOTICE
,"DB†ßded from‡µ’d oÆy fe: %.3à£cÚds",()(
	`u¡ime
()-
¡¬t
)/1000000);

3353 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
è=ğ
C_OK
) {

3354 
	`£rv”Log
(
LL_NOTICE
,"DB†oaded from disk: %.3f seconds",

3355 ()(
	`u¡ime
()-
¡¬t
)/1000000);

3356 } ià(
”ºo
 !ğ
ENOENT
) {

3357 
	`£rv”Log
(
LL_WARNING
,"F©®ƒ¼Ü†ßdšghDB: %s. Ex™šg.",
	`¡»¼Ü
(
”ºo
));

3358 
	`ex™
(1);

3361 
	}
}

3363 
	$»disOutOfMemÜyHªdËr
(
size_t
 
®loÿtiÚ_size
) {

3364 
	`£rv”Log
(
LL_WARNING
,"Out Of Memory‡llocating %zu bytes!",

3365 
®loÿtiÚ_size
);

3366 
	`£rv”Pªic
("Redis‡borting for OUT OF MEMORY");

3367 
	}
}

3369 
	$»disS‘ProcT™Ë
(*
t™Ë
) {

3370 #ifdeà
USE_SETPROCTITLE


3371 *
£rv”_mode
 = "";

3372 ià(
£rv”
.
şu¡”_’abËd
è
£rv”_mode
 = " [cluster]";

3373 ià(
£rv”
.
£Áš–_mode
è
£rv”_mode
 = " [sentinel]";

3375 
	`£roù™Ë
("%s %s:%d%s",

3376 
t™Ë
,

3377 
£rv”
.
bšdaddr_couÁ
 ? s”v”.
bšdaddr
[0] : "*",

3378 
£rv”
.
pÜt
,

3379 
£rv”_mode
);

3381 
	`UNUSED
(
t™Ë
);

3383 
	}
}

3389 
	$»disSu³rvi£dUp¡¬t
() {

3390 cÚ¡ *
up¡¬t_job
 = 
	`g‘’v
("UPSTART_JOB");

3392 ià(!
up¡¬t_job
) {

3393 
	`£rv”Log
(
LL_WARNING
,

3398 
	`£rv”Log
(
LL_NOTICE
, "supervised by upstart, will stopo signal„eadiness");

3399 
	`¿i£
(
SIGSTOP
);

3400 
	`un£‹nv
("UPSTART_JOB");

3402 
	}
}

3404 
	$»disSu³rvi£dSy¡emd
() {

3405 cÚ¡ *
nÙify_sock‘
 = 
	`g‘’v
("NOTIFY_SOCKET");

3406 
fd
 = 1;

3407 
sockaddr_un
 
su
;

3408 
iovec
 
iov
;

3409 
msghdr
 
hdr
;

3410 
£ndto_æags
 = 0;

3412 ià(!
nÙify_sock‘
) {

3413 
	`£rv”Log
(
LL_WARNING
,

3418 ià((
	`¡rchr
("@/", 
nÙify_sock‘
[0])è=ğ
NULL
 || 
	`¡¾’
(notify_socket) < 2) {

3422 
	`£rv”Log
(
LL_NOTICE
, "supervised by systemd, will signal„eadiness");

3423 ià((
fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_DGRAM
, 0)) == -1) {

3424 
	`£rv”Log
(
LL_WARNING
,

3425 "Cª'ˆcÚÃùØsy¡emd sock‘ %s", 
nÙify_sock‘
);

3429 
	`mem£t
(&
su
, 0, (su));

3430 
su
.
sun_çmy
 = 
AF_UNIX
;

3431 
	`¡ºıy
 (
su
.
sun_·th
, 
nÙify_sock‘
, (su.sun_path) -1);

3432 
su
.
sun_·th
[(su.sun_path) - 1] = '\0';

3434 ià(
nÙify_sock‘
[0] == '@')

3435 
su
.
sun_·th
[0] = '\0';

3437 
	`mem£t
(&
iov
, 0, (iov));

3438 
iov
.
iov_ba£
 = "READY=1";

3439 
iov
.
iov_Ën
 = 
	`¡¾’
("READY=1");

3441 
	`mem£t
(&
hdr
, 0, (hdr));

3442 
hdr
.
msg_Çme
 = &
su
;

3443 
hdr
.
msg_Çm–’
 = 
	`off£tof
(
sockaddr_un
, 
sun_·th
) +

3444 
	`¡¾’
(
nÙify_sock‘
);

3445 
hdr
.
msg_iov
 = &
iov
;

3446 
hdr
.
msg_iovËn
 = 1;

3448 
	`un£‹nv
("NOTIFY_SOCKET");

3449 #ifdeà
HAVE_MSG_NOSIGNAL


3450 
£ndto_æags
 |ğ
MSG_NOSIGNAL
;

3452 ià(
	`£ndmsg
(
fd
, &
hdr
, 
£ndto_æags
) < 0) {

3453 
	`£rv”Log
(
LL_WARNING
, "Can't send‚otificationo systemd");

3454 
	`şo£
(
fd
);

3457 
	`şo£
(
fd
);

3459 
	}
}

3461 
	$»disIsSu³rvi£d
(
mode
) {

3462 ià(
mode
 =ğ
SUPERVISED_AUTODETECT
) {

3463 cÚ¡ *
up¡¬t_job
 = 
	`g‘’v
("UPSTART_JOB");

3464 cÚ¡ *
nÙify_sock‘
 = 
	`g‘’v
("NOTIFY_SOCKET");

3466 ià(
up¡¬t_job
) {

3467 
	`»disSu³rvi£dUp¡¬t
();

3468 } ià(
nÙify_sock‘
) {

3469 
	`»disSu³rvi£dSy¡emd
();

3471 } ià(
mode
 =ğ
SUPERVISED_UPSTART
) {

3472  
	`»disSu³rvi£dUp¡¬t
();

3473 } ià(
mode
 =ğ
SUPERVISED_SYSTEMD
) {

3474  
	`»disSu³rvi£dSy¡emd
();

3478 
	}
}

3481 
	$maš
(
¬gc
, **
¬gv
) {

3482 
timev®
 
tv
;

3483 
j
;

3485 #ifdeà
REDIS_TEST


3486 ià(
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
¬gv
[1], "test")) {

3487 ià(!
	`¡rÿ£cmp
(
¬gv
[2], "ziplist")) {

3488  
	`zli¡Te¡
(
¬gc
, 
¬gv
);

3489 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "quicklist")) {

3490 
	`quickli¡Te¡
(
¬gc
, 
¬gv
);

3491 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "intset")) {

3492  
	`št£tTe¡
(
¬gc
, 
¬gv
);

3493 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "zipmap")) {

3494  
	`zm­Te¡
(
¬gc
, 
¬gv
);

3495 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "sha1test")) {

3496  
	`sha1Te¡
(
¬gc
, 
¬gv
);

3497 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "util")) {

3498  
	`utTe¡
(
¬gc
, 
¬gv
);

3499 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "sds")) {

3500  
	`sdsTe¡
(
¬gc
, 
¬gv
);

3501 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "endianconv")) {

3502  
	`’dŸncÚvTe¡
(
¬gc
, 
¬gv
);

3503 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "crc64")) {

3504  
	`üc64Te¡
(
¬gc
, 
¬gv
);

3512 #ifdeà
INIT_SETPROCTITLE_REPLACEMENT


3513 
	`¥t_š™
(
¬gc
, 
¬gv
);

3515 
	`£oÿË
(
LC_COLLATE
,"");

3516 
	`zm®loc_’abË_th»ad_§ãÃss
();

3517 
	`zm®loc_£t_oom_hªdËr
(
»disOutOfMemÜyHªdËr
);

3518 
	`¤ªd
(
	`time
(
NULL
)^
	`g‘pid
());

3519 
	`g‘timeofday
(&
tv
,
NULL
);

3520 
	`diùS‘HashFunùiÚS“d
(
tv
.
tv_£c
^tv.
tv_u£c
^
	`g‘pid
());

3521 
£rv”
.
£Áš–_mode
 = 
	`checkFÜS’tš–Mode
(
¬gc
,
¬gv
);

3522 
	`š™S”v”CÚfig
();

3523 
	`moduËIn™ModuËsSy¡em
();

3527 
£rv”
.
execubË
 = 
	`g‘AbsŞu‹P©h
(
¬gv
[0]);

3528 
£rv”
.
exec_¬gv
 = 
	`zm®loc
((*)*(
¬gc
+1));

3529 
£rv”
.
exec_¬gv
[
¬gc
] = 
NULL
;

3530 
j
 = 0; j < 
¬gc
; j++è
£rv”
.
exec_¬gv
[j] = 
	`z¡rdup
(
¬gv
[j]);

3535 ià(
£rv”
.
£Áš–_mode
) {

3536 
	`š™S’tš–CÚfig
();

3537 
	`š™S’tš–
();

3543 ià(
	`¡r¡r
(
¬gv
[0],"»dis-check-rdb"è!ğ
NULL
)

3544 
	`»dis_check_rdb_maš
(
¬gc
,
¬gv
);

3546 ià(
¬gc
 >= 2) {

3547 
j
 = 1;

3548 
sds
 
İtiÚs
 = 
	`sd£m±y
();

3549 *
cÚfigfe
 = 
NULL
;

3552 ià(
	`¡rcmp
(
¬gv
[1], "-v") == 0 ||

3553 
	`¡rcmp
(
¬gv
[1], "--v”siÚ"è=ğ0è
	`v”siÚ
();

3554 ià(
	`¡rcmp
(
¬gv
[1], "--help") == 0 ||

3555 
	`¡rcmp
(
¬gv
[1], "-h"è=ğ0è
	`u§ge
();

3556 ià(
	`¡rcmp
(
¬gv
[1], "--test-memory") == 0) {

3557 ià(
¬gc
 == 3) {

3558 
	`mem‹¡
(
	`©oi
(
¬gv
[2]),50);

3559 
	`ex™
(0);

3561 
	`årštf
(
¡d”r
,"Please specifyhe‡mount of memoryoest in megabytes.\n");

3562 
	`årštf
(
¡d”r
,"Example: ./redis-server --test-memory 4096\n\n");

3563 
	`ex™
(1);

3568 ià(
¬gv
[
j
][0] != '-' ||‡rgv[j][1] != '-') {

3569 
cÚfigfe
 = 
¬gv
[
j
];

3570 
£rv”
.
cÚfigfe
 = 
	`g‘AbsŞu‹P©h
(configfile);

3573 
	`zä“
(
£rv”
.
exec_¬gv
[
j
]);

3574 
£rv”
.
exec_¬gv
[
j
] = 
	`z¡rdup
(£rv”.
cÚfigfe
);

3575 
j
++;

3582 
j
 !ğ
¬gc
) {

3583 ià(
¬gv
[
j
][0] == '-' &&‡rgv[j][1] == '-') {

3585 ià(!
	`¡rcmp
(
¬gv
[
j
], "--check-rdb")) {

3587 
j
++;

3590 ià(
	`sd¦’
(
İtiÚs
)èİtiÚ ğ
	`sdsÿt
(options,"\n");

3591 
İtiÚs
 = 
	`sdsÿt
(İtiÚs,
¬gv
[
j
]+2);

3592 
İtiÚs
 = 
	`sdsÿt
(options," ");

3595 
İtiÚs
 = 
	`sdsÿŒ•r
(İtiÚs,
¬gv
[
j
],
	`¡¾’
(argv[j]));

3596 
İtiÚs
 = 
	`sdsÿt
(options," ");

3598 
j
++;

3600 ià(
£rv”
.
£Áš–_mode
 && 
cÚfigfe
 && *configfile == '-') {

3601 
	`£rv”Log
(
LL_WARNING
,

3603 
	`£rv”Log
(
LL_WARNING
,

3605 
	`ex™
(1);

3607 
	`»£tS”v”SaveP¬ams
();

3608 
	`lßdS”v”CÚfig
(
cÚfigfe
,
İtiÚs
);

3609 
	`sdsä“
(
İtiÚs
);

3611 
	`£rv”Log
(
LL_WARNING
, "W¬nšg:‚ØcÚfig f¥ecif›d, usšghdeçuÉ cÚfig. IÀÜd”Ø¥ecify‡ cÚfig fu£ % /·th/to/%s.cÚf", 
¬gv
[0], 
£rv”
.
£Áš–_mode
 ? "sentinel" : "redis");

3614 
£rv”
.
su³rvi£d
 = 
	`»disIsSu³rvi£d
(£rv”.
su³rvi£d_mode
);

3615 
background
 = 
£rv”
.
d«mÚize
 && !£rv”.
su³rvi£d
;

3616 ià(
background
è
	`d«mÚize
();

3618 
	`š™S”v”
();

3619 ià(
background
 || 
£rv”
.
pidfe
è
	`ü—‹PidFe
();

3620 
	`»disS‘ProcT™Ë
(
¬gv
[0]);

3621 
	`»disAsciiA¹
();

3622 
	`checkTıBacklogS‘tšgs
();

3624 ià(!
£rv”
.
£Áš–_mode
) {

3626 
	`£rv”Log
(
LL_WARNING
,"S”v” s¹ed, Redi v”siÚ " 
REDIS_VERSION
);

3627 #ifdeà
__lšux__


3628 
	`lšuxMemÜyW¬nšgs
();

3630 
	`moduËLßdFromQueue
();

3631 
	`lßdD©aFromDisk
();

3632 ià(
£rv”
.
şu¡”_’abËd
) {

3633 ià(
	`v”ifyClu¡”CÚfigW™hD©a
(è=ğ
C_ERR
) {

3634 
	`£rv”Log
(
LL_WARNING
,

3637 
	`ex™
(1);

3640 ià(
£rv”
.
fd_couÁ
 > 0)

3641 
	`£rv”Log
(
LL_NOTICE
,"Th£rv” i now„—dyØacû± cÚÃùiÚ Ú…Üˆ%d", 
£rv”
.
pÜt
);

3642 ià(
£rv”
.
sofd
 > 0)

3643 
	`£rv”Log
(
LL_NOTICE
,"Th£rv” i now„—dyØacû± cÚÃùiÚ © %s", 
£rv”
.
unixsock‘
);

3645 
	`£Áš–IsRuÂšg
();

3649 ià(
£rv”
.
maxmemÜy
 > 0 && server.maxmemory < 1024*1024) {

3650 
	`£rv”Log
(
LL_WARNING
,"WARNING: You s³cif›d‡ maxmemÜy v®uth© i Ës thª 1MB (cu¼’ˆv®ui %Îu by‹s). A» you su»hi i wh© you„—Îy wªt?", 
£rv”
.
maxmemÜy
);

3653 
	`«S‘BefÜeSË•Proc
(
£rv”
.
–
,
befÜeSË•
);

3654 
	`«Maš
(
£rv”
.
–
);

3655 
	`«D–‘eEv’tLoİ
(
£rv”
.
–
);

3657 
	}
}

	@server.h

30 #iâdeà
__REDIS_H


31 
	#__REDIS_H


	)

33 
	~"fmaüos.h
"

34 
	~"cÚfig.h
"

35 
	~"sŞ¬isfixes.h
"

36 
	~"rio.h
"

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<¡ršg.h
>

41 
	~<time.h
>

42 
	~<lim™s.h
>

43 
	~<uni¡d.h
>

44 
	~<”ºo.h
>

45 
	~<š‰y³s.h
>

46 
	~<±h»ad.h
>

47 
	~<sy¦og.h
>

48 
	~<Ãtš‘/š.h
>

49 
	~<lua.h
>

50 
	~<sigÇl.h
>

52 
	tm¡ime_t
;

54 
	~"«.h
"

55 
	~"sds.h
"

56 
	~"diù.h
"

57 
	~"adli¡.h
"

58 
	~"zm®loc.h
"

59 
	~"ª‘.h
"

60 
	~"zli¡.h
"

61 
	~"št£t.h
"

62 
	~"v”siÚ.h
"

63 
	~"ut.h
"

64 
	~"Ï‹ncy.h
"

65 
	~"¥¬klše.h
"

66 
	~"quickli¡.h
"

69 
	~"zm­.h
"

70 
	~"sha1.h
"

71 
	~"’dŸncÚv.h
"

72 
	~"üc64.h
"

75 
	#C_OK
 0

	)

76 
	#C_ERR
 -1

	)

79 
	#CONFIG_DEFAULT_HZ
 10

	)

80 
	#CONFIG_MIN_HZ
 1

	)

81 
	#CONFIG_MAX_HZ
 500

	)

82 
	#CONFIG_DEFAULT_SERVER_PORT
 6379

	)

83 
	#CONFIG_DEFAULT_TCP_BACKLOG
 511

	)

84 
	#CONFIG_DEFAULT_CLIENT_TIMEOUT
 0

	)

85 
	#CONFIG_DEFAULT_DBNUM
 16

	)

86 
	#CONFIG_MAX_LINE
 1024

	)

87 
	#CRON_DBS_PER_CALL
 16

	)

88 
	#NET_MAX_WRITES_PER_EVENT
 (1024*64)

	)

89 
	#PROTO_SHARED_SELECT_CMDS
 10

	)

90 
	#OBJ_SHARED_INTEGERS
 10000

	)

91 
	#OBJ_SHARED_BULKHDR_LEN
 32

	)

92 
	#LOG_MAX_LEN
 1024

	)

93 
	#AOF_REWRITE_PERC
 100

	)

94 
	#AOF_REWRITE_MIN_SIZE
 (64*1024*1024)

	)

95 
	#AOF_REWRITE_ITEMS_PER_CMD
 64

	)

96 
	#CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
 10000

	)

97 
	#CONFIG_DEFAULT_SLOWLOG_MAX_LEN
 128

	)

98 
	#CONFIG_DEFAULT_MAX_CLIENTS
 10000

	)

99 
	#CONFIG_AUTHPASS_MAX_LEN
 512

	)

100 
	#CONFIG_DEFAULT_SLAVE_PRIORITY
 100

	)

101 
	#CONFIG_DEFAULT_REPL_TIMEOUT
 60

	)

102 
	#CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD
 10

	)

103 
	#CONFIG_RUN_ID_SIZE
 40

	)

104 
	#RDB_EOF_MARK_SIZE
 40

	)

105 
	#CONFIG_DEFAULT_REPL_BACKLOG_SIZE
 (1024*1024è

	)

106 
	#CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
 (60*60è

	)

107 
	#CONFIG_REPL_BACKLOG_MIN_SIZE
 (1024*16è

	)

108 
	#CONFIG_BGSAVE_RETRY_DELAY
 5

	)

109 
	#CONFIG_DEFAULT_PID_FILE
 "/v¬/run/»dis.pid"

	)

110 
	#CONFIG_DEFAULT_SYSLOG_IDENT
 "»dis"

	)

111 
	#CONFIG_DEFAULT_CLUSTER_CONFIG_FILE
 "nodes.cÚf"

	)

112 
	#CONFIG_DEFAULT_CLUSTER_ANNOUNCE_IP
 
NULL


	)

113 
	#CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT
 0

	)

114 
	#CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT
 0

	)

115 
	#CONFIG_DEFAULT_DAEMONIZE
 0

	)

116 
	#CONFIG_DEFAULT_UNIX_SOCKET_PERM
 0

	)

117 
	#CONFIG_DEFAULT_TCP_KEEPALIVE
 300

	)

118 
	#CONFIG_DEFAULT_PROTECTED_MODE
 1

	)

119 
	#CONFIG_DEFAULT_LOGFILE
 ""

	)

120 
	#CONFIG_DEFAULT_SYSLOG_ENABLED
 0

	)

121 
	#CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
 1

	)

122 
	#CONFIG_DEFAULT_RDB_COMPRESSION
 1

	)

123 
	#CONFIG_DEFAULT_RDB_CHECKSUM
 1

	)

124 
	#CONFIG_DEFAULT_RDB_FILENAME
 "dump.rdb"

	)

125 
	#CONFIG_DEFAULT_REPL_DISKLESS_SYNC
 0

	)

126 
	#CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY
 5

	)

127 
	#CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA
 1

	)

128 
	#CONFIG_DEFAULT_SLAVE_READ_ONLY
 1

	)

129 
	#CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY
 0

	)

130 
	#CONFIG_DEFAULT_MAXMEMORY
 0

	)

131 
	#CONFIG_DEFAULT_MAXMEMORY_SAMPLES
 5

	)

132 
	#CONFIG_DEFAULT_LFU_LOG_FACTOR
 10

	)

133 
	#CONFIG_DEFAULT_LFU_DECAY_TIME
 1

	)

134 
	#CONFIG_DEFAULT_AOF_FILENAME
 "­³ndÚly.aof"

	)

135 
	#CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
 0

	)

136 
	#CONFIG_DEFAULT_AOF_LOAD_TRUNCATED
 1

	)

137 
	#CONFIG_DEFAULT_ACTIVE_REHASHING
 1

	)

138 
	#CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
 1

	)

139 
	#CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE
 0

	)

140 
	#CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG
 10

	)

141 
	#NET_IP_STR_LEN
 46

	)

142 
	#NET_PEER_ID_LEN
 (
NET_IP_STR_LEN
+32è

	)

143 
	#CONFIG_BINDADDR_MAX
 16

	)

144 
	#CONFIG_MIN_RESERVED_FDS
 32

	)

145 
	#CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD
 0

	)

146 
	#CONFIG_DEFAULT_SLAVE_LAZY_FLUSH
 0

	)

147 
	#CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION
 0

	)

148 
	#CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE
 0

	)

149 
	#CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL
 0

	)

151 
	#ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
 20

	)

152 
	#ACTIVE_EXPIRE_CYCLE_FAST_DURATION
 1000

	)

153 
	#ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
 25

	)

154 
	#ACTIVE_EXPIRE_CYCLE_SLOW
 0

	)

155 
	#ACTIVE_EXPIRE_CYCLE_FAST
 1

	)

158 
	#STATS_METRIC_SAMPLES
 16

	)

159 
	#STATS_METRIC_COMMAND
 0

	)

160 
	#STATS_METRIC_NET_INPUT
 1

	)

161 
	#STATS_METRIC_NET_OUTPUT
 2

	)

162 
	#STATS_METRIC_COUNT
 3

	)

165 
	#PROTO_MAX_QUERYBUF_LEN
 (1024*1024*1024è

	)

166 
	#PROTO_IOBUF_LEN
 (1024*16è

	)

167 
	#PROTO_REPLY_CHUNK_BYTES
 (16*1024è

	)

168 
	#PROTO_INLINE_MAX_SIZE
 (1024*64è

	)

169 
	#PROTO_MBULK_BIG_ARG
 (1024*32)

	)

170 
	#LONG_STR_SIZE
 21

	)

171 
	#AOF_AUTOSYNC_BYTES
 (1024*1024*32è

	)

177 
	#CONFIG_FDSET_INCR
 (
CONFIG_MIN_RESERVED_FDS
+96)

	)

180 
	#HASHTABLE_MIN_FILL
 10

	)

184 
	#CMD_WRITE
 (1<<0è

	)

185 
	#CMD_READONLY
 (1<<1è

	)

186 
	#CMD_DENYOOM
 (1<<2è

	)

187 
	#CMD_MODULE
 (1<<3è

	)

188 
	#CMD_ADMIN
 (1<<4è

	)

189 
	#CMD_PUBSUB
 (1<<5è

	)

190 
	#CMD_NOSCRIPT
 (1<<6è

	)

191 
	#CMD_RANDOM
 (1<<7è

	)

192 
	#CMD_SORT_FOR_SCRIPT
 (1<<8è

	)

193 
	#CMD_LOADING
 (1<<9è

	)

194 
	#CMD_STALE
 (1<<10è

	)

195 
	#CMD_SKIP_MONITOR
 (1<<11è

	)

196 
	#CMD_ASKING
 (1<<12è

	)

197 
	#CMD_FAST
 (1<<13è

	)

198 
	#CMD_MODULE_GETKEYS
 (1<<14è

	)

199 
	#CMD_MODULE_NO_CLUSTER
 (1<<15è

	)

202 
	#AOF_OFF
 0

	)

203 
	#AOF_ON
 1

	)

204 
	#AOF_WAIT_REWRITE
 2

	)

207 
	#CLIENT_SLAVE
 (1<<0è

	)

208 
	#CLIENT_MASTER
 (1<<1è

	)

209 
	#CLIENT_MONITOR
 (1<<2è

	)

210 
	#CLIENT_MULTI
 (1<<3è

	)

211 
	#CLIENT_BLOCKED
 (1<<4è

	)

212 
	#CLIENT_DIRTY_CAS
 (1<<5è

	)

213 
	#CLIENT_CLOSE_AFTER_REPLY
 (1<<6è

	)

214 
	#CLIENT_UNBLOCKED
 (1<<7è

	)

216 
	#CLIENT_LUA
 (1<<8è

	)

217 
	#CLIENT_ASKING
 (1<<9è

	)

218 
	#CLIENT_CLOSE_ASAP
 (1<<10)

	)

219 
	#CLIENT_UNIX_SOCKET
 (1<<11è

	)

220 
	#CLIENT_DIRTY_EXEC
 (1<<12è

	)

221 
	#CLIENT_MASTER_FORCE_REPLY
 (1<<13è

	)

222 
	#CLIENT_FORCE_AOF
 (1<<14è

	)

223 
	#CLIENT_FORCE_REPL
 (1<<15è

	)

224 
	#CLIENT_PRE_PSYNC
 (1<<16è

	)

225 
	#CLIENT_READONLY
 (1<<17è

	)

226 
	#CLIENT_PUBSUB
 (1<<18è

	)

227 
	#CLIENT_PREVENT_AOF_PROP
 (1<<19è

	)

228 
	#CLIENT_PREVENT_REPL_PROP
 (1<<20è

	)

229 
	#CLIENT_PREVENT_PROP
 (
CLIENT_PREVENT_AOF_PROP
|
CLIENT_PREVENT_REPL_PROP
)

	)

230 
	#CLIENT_PENDING_WRITE
 (1<<21è

	)

232 
	#CLIENT_REPLY_OFF
 (1<<22è

	)

233 
	#CLIENT_REPLY_SKIP_NEXT
 (1<<23è

	)

234 
	#CLIENT_REPLY_SKIP
 (1<<24è

	)

235 
	#CLIENT_LUA_DEBUG
 (1<<25è

	)

236 
	#CLIENT_LUA_DEBUG_SYNC
 (1<<26è

	)

237 
	#CLIENT_MODULE
 (1<<27è

	)

241 
	#BLOCKED_NONE
 0

	)

242 
	#BLOCKED_LIST
 1

	)

243 
	#BLOCKED_WAIT
 2

	)

246 
	#PROTO_REQ_INLINE
 1

	)

247 
	#PROTO_REQ_MULTIBULK
 2

	)

251 
	#CLIENT_TYPE_NORMAL
 0

	)

252 
	#CLIENT_TYPE_SLAVE
 1

	)

253 
	#CLIENT_TYPE_PUBSUB
 2

	)

254 
	#CLIENT_TYPE_MASTER
 3

	)

255 
	#CLIENT_TYPE_OBUF_COUNT
 3

	)

261 
	#REPL_STATE_NONE
 0

	)

262 
	#REPL_STATE_CONNECT
 1

	)

263 
	#REPL_STATE_CONNECTING
 2

	)

265 
	#REPL_STATE_RECEIVE_PONG
 3

	)

266 
	#REPL_STATE_SEND_AUTH
 4

	)

267 
	#REPL_STATE_RECEIVE_AUTH
 5

	)

268 
	#REPL_STATE_SEND_PORT
 6

	)

269 
	#REPL_STATE_RECEIVE_PORT
 7

	)

270 
	#REPL_STATE_SEND_CAPA
 8

	)

271 
	#REPL_STATE_RECEIVE_CAPA
 9

	)

272 
	#REPL_STATE_SEND_PSYNC
 10

	)

273 
	#REPL_STATE_RECEIVE_PSYNC
 11

	)

275 
	#REPL_STATE_TRANSFER
 12

	)

276 
	#REPL_STATE_CONNECTED
 13

	)

282 
	#SLAVE_STATE_WAIT_BGSAVE_START
 6

	)

283 
	#SLAVE_STATE_WAIT_BGSAVE_END
 7

	)

284 
	#SLAVE_STATE_SEND_BULK
 8

	)

285 
	#SLAVE_STATE_ONLINE
 9

	)

288 
	#SLAVE_CAPA_NONE
 0

	)

289 
	#SLAVE_CAPA_EOF
 (1<<0è

	)

292 
	#CONFIG_REPL_SYNCIO_TIMEOUT
 5

	)

295 
	#LIST_HEAD
 0

	)

296 
	#LIST_TAIL
 1

	)

299 
	#SORT_OP_GET
 0

	)

302 
	#LL_DEBUG
 0

	)

303 
	#LL_VERBOSE
 1

	)

304 
	#LL_NOTICE
 2

	)

305 
	#LL_WARNING
 3

	)

306 
	#LL_RAW
 (1<<10è

	)

307 
	#CONFIG_DEFAULT_VERBOSITY
 
LL_NOTICE


	)

310 
	#SUPERVISED_NONE
 0

	)

311 
	#SUPERVISED_AUTODETECT
 1

	)

312 
	#SUPERVISED_SYSTEMD
 2

	)

313 
	#SUPERVISED_UPSTART
 3

	)

316 
	#UNUSED
(
V
è((èV)

	)

318 
	#ZSKIPLIST_MAXLEVEL
 32

	)

319 
	#ZSKIPLIST_P
 0.25

	)

322 
	#AOF_FSYNC_NO
 0

	)

323 
	#AOF_FSYNC_ALWAYS
 1

	)

324 
	#AOF_FSYNC_EVERYSEC
 2

	)

325 
	#CONFIG_DEFAULT_AOF_FSYNC
 
AOF_FSYNC_EVERYSEC


	)

328 
	#OBJ_HASH_MAX_ZIPLIST_ENTRIES
 512

	)

329 
	#OBJ_HASH_MAX_ZIPLIST_VALUE
 64

	)

330 
	#OBJ_SET_MAX_INTSET_ENTRIES
 512

	)

331 
	#OBJ_ZSET_MAX_ZIPLIST_ENTRIES
 128

	)

332 
	#OBJ_ZSET_MAX_ZIPLIST_VALUE
 64

	)

335 
	#OBJ_LIST_MAX_ZIPLIST_SIZE
 -2

	)

336 
	#OBJ_LIST_COMPRESS_DEPTH
 0

	)

339 
	#CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
 3000

	)

342 
	#SET_OP_UNION
 0

	)

343 
	#SET_OP_DIFF
 1

	)

344 
	#SET_OP_INTER
 2

	)

349 
	#MAXMEMORY_FLAG_LRU
 (1<<0)

	)

350 
	#MAXMEMORY_FLAG_LFU
 (1<<1)

	)

351 
	#MAXMEMORY_FLAG_ALLKEYS
 (1<<2)

	)

352 
	#MAXMEMORY_FLAG_NO_SHARED_INTEGERS
 \

353 (
MAXMEMORY_FLAG_LRU
|
MAXMEMORY_FLAG_LFU
)

	)

355 
	#MAXMEMORY_VOLATILE_LRU
 ((0<<8)|
MAXMEMORY_FLAG_LRU
)

	)

356 
	#MAXMEMORY_VOLATILE_LFU
 ((1<<8)|
MAXMEMORY_FLAG_LFU
)

	)

357 
	#MAXMEMORY_VOLATILE_TTL
 (2<<8)

	)

358 
	#MAXMEMORY_VOLATILE_RANDOM
 (3<<8)

	)

359 
	#MAXMEMORY_ALLKEYS_LRU
 ((4<<8)|
MAXMEMORY_FLAG_LRU
|
MAXMEMORY_FLAG_ALLKEYS
)

	)

360 
	#MAXMEMORY_ALLKEYS_LFU
 ((5<<8)|
MAXMEMORY_FLAG_LFU
|
MAXMEMORY_FLAG_ALLKEYS
)

	)

361 
	#MAXMEMORY_ALLKEYS_RANDOM
 ((6<<8)|
MAXMEMORY_FLAG_ALLKEYS
)

	)

362 
	#MAXMEMORY_NO_EVICTION
 (7<<8)

	)

364 
	#CONFIG_DEFAULT_MAXMEMORY_POLICY
 
MAXMEMORY_NO_EVICTION


	)

367 
	#LUA_SCRIPT_TIME_LIMIT
 5000

	)

370 
	#UNIT_SECONDS
 0

	)

371 
	#UNIT_MILLISECONDS
 1

	)

374 
	#SHUTDOWN_NOFLAGS
 0

	)

375 
	#SHUTDOWN_SAVE
 1

	)

377 
	#SHUTDOWN_NOSAVE
 2

	)

380 
	#CMD_CALL_NONE
 0

	)

381 
	#CMD_CALL_SLOWLOG
 (1<<0)

	)

382 
	#CMD_CALL_STATS
 (1<<1)

	)

383 
	#CMD_CALL_PROPAGATE_AOF
 (1<<2)

	)

384 
	#CMD_CALL_PROPAGATE_REPL
 (1<<3)

	)

385 
	#CMD_CALL_PROPAGATE
 (
CMD_CALL_PROPAGATE_AOF
|
CMD_CALL_PROPAGATE_REPL
)

	)

386 
	#CMD_CALL_FULL
 (
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
 | 
CMD_CALL_PROPAGATE
)

	)

389 
	#PROPAGATE_NONE
 0

	)

390 
	#PROPAGATE_AOF
 1

	)

391 
	#PROPAGATE_REPL
 2

	)

394 
	#RDB_CHILD_TYPE_NONE
 0

	)

395 
	#RDB_CHILD_TYPE_DISK
 1

	)

396 
	#RDB_CHILD_TYPE_SOCKET
 2

	)

400 
	#NOTIFY_KEYSPACE
 (1<<0è

	)

401 
	#NOTIFY_KEYEVENT
 (1<<1è

	)

402 
	#NOTIFY_GENERIC
 (1<<2è

	)

403 
	#NOTIFY_STRING
 (1<<3è

	)

404 
	#NOTIFY_LIST
 (1<<4è

	)

405 
	#NOTIFY_SET
 (1<<5è

	)

406 
	#NOTIFY_HASH
 (1<<6è

	)

407 
	#NOTIFY_ZSET
 (1<<7è

	)

408 
	#NOTIFY_EXPIRED
 (1<<8è

	)

409 
	#NOTIFY_EVICTED
 (1<<9è

	)

410 
	#NOTIFY_ALL
 (
NOTIFY_GENERIC
 | 
NOTIFY_STRING
 | 
NOTIFY_LIST
 | 
NOTIFY_SET
 | 
NOTIFY_HASH
 | 
NOTIFY_ZSET
 | 
NOTIFY_EXPIRED
 | 
NOTIFY_EVICTED
è

	)

413 
	#NET_FIRST_BIND_ADDR
 (
£rv”
.
bšdaddr_couÁ
 ? s”v”.
bšdaddr
[0] : 
NULL
)

	)

418 
	#run_w™h_³riod
(
_ms_
èià((_ms_ <ğ1000/
£rv”
.
hz
è|| !(£rv”.
üÚloİs
%((_ms_)/(1000/£rv”.hz))))

	)

421 
	#£rv”As£¹W™hInfo
(
_c
,
_o
,
_e
è((_e)?()0 : (
	`_£rv”As£¹W™hInfo
(_c,_o,#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

422 
	#£rv”As£¹
(
_e
è((_e)?()0 : (
	`_£rv”As£¹
(#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

423 
	#£rv”Pªic
(
_e
è
	`_£rv”Pªic
(#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)

	)

432 
	#OBJ_STRING
 0

	)

433 
	#OBJ_LIST
 1

	)

434 
	#OBJ_SET
 2

	)

435 
	#OBJ_ZSET
 3

	)

436 
	#OBJ_HASH
 4

	)

449 
	#OBJ_MODULE
 5

	)

452 
	#REDISMODULE_TYPE_ENCVER_BITS
 10

	)

453 
	#REDISMODULE_TYPE_ENCVER_MASK
 ((1<<
REDISMODULE_TYPE_ENCVER_BITS
)-1)

	)

454 
	#REDISMODULE_TYPE_ENCVER
(
id
è(id & 
REDISMODULE_TYPE_ENCVER_MASK
)

	)

455 
	#REDISMODULE_TYPE_SIGN
(
id
è((id & ~((
ušt64_t
)
REDISMODULE_TYPE_ENCVER_MASK
)è>>
REDISMODULE_TYPE_ENCVER_BITS
)

	)

457 
	gRedisModuË
;

458 
	gRedisModuËIO
;

459 
	gRedisModuËDige¡
;

460 
	g»disObjeù
;

466 *(*
	tmoduËTy³LßdFunc
)(
	tRedisModuËIO
 *
	tio
, 
	t’cv”
);

467 (*
	tmoduËTy³SaveFunc
)(
	tRedisModuËIO
 *
	tio
, *
	tv®ue
);

468 (*
	tmoduËTy³Rewr™eFunc
)(
	tRedisModuËIO
 *
	tio
, 
	t»disObjeù
 *
	tkey
, *
	tv®ue
);

469 (*
	tmoduËTy³Dige¡Func
)(
	tRedisModuËDige¡
 *
	tdige¡
, *
	tv®ue
);

470 (*
	tmoduËTy³F»eFunc
)(*
	tv®ue
);

474 
	sRedisModuËTy³
 {

475 
ušt64_t
 
id
;

476 
RedisModuË
 *
moduË
;

477 
moduËTy³LßdFunc
 
rdb_lßd
;

478 
moduËTy³SaveFunc
 
rdb_§ve
;

479 
moduËTy³Rewr™eFunc
 
aof_»wr™e
;

480 
moduËTy³Dige¡Func
 
dige¡
;

481 
moduËTy³F»eFunc
 
ä“
;

482 
Çme
[10];

483 } 
	tmoduËTy³
;

500 
	smoduËV®ue
 {

501 
moduËTy³
 *
ty³
;

502 *
v®ue
;

503 } 
	tmoduËV®ue
;

508 
	sRedisModuËIO
 {

509 
size_t
 
by‹s
;

510 
rio
 *rio;

511 
moduËTy³
 *
ty³
;

512 
”rÜ
;

513 } 
	tRedisModuËIO
;

515 
	#moduËIn™IOCÚ‹xt
(
iov¬
,
mty³
,
riİŒ
) do { \

516 
iov¬
.
rio
 = 
riİŒ
; \

517 
iov¬
.
ty³
 = 
mty³
; \

518 
iov¬
.
by‹s
 = 0; \

519 
iov¬
.
”rÜ
 = 0; \

520 
	}
} 0);

	)

525 
	#OBJ_ENCODING_RAW
 0

	)

526 
	#OBJ_ENCODING_INT
 1

	)

527 
	#OBJ_ENCODING_HT
 2

	)

528 
	#OBJ_ENCODING_ZIPMAP
 3

	)

529 
	#OBJ_ENCODING_LINKEDLIST
 4

	)

530 
	#OBJ_ENCODING_ZIPLIST
 5

	)

531 
	#OBJ_ENCODING_INTSET
 6

	)

532 
	#OBJ_ENCODING_SKIPLIST
 7

	)

533 
	#OBJ_ENCODING_EMBSTR
 8

	)

534 
	#OBJ_ENCODING_QUICKLIST
 9

	)

536 
	#LRU_BITS
 24

	)

537 
	#LRU_CLOCK_MAX
 ((1<<
LRU_BITS
)-1è

	)

538 
	#LRU_CLOCK_RESOLUTION
 1000

	)

540 
	#OBJ_SHARED_REFCOUNT
 
INT_MAX


	)

541 
	s»disObjeù
 {

542 
	mty³
:4;

543 
	m’codšg
:4;

544 
	mÌu
:
LRU_BITS
;

547 
	m»fcouÁ
;

548 *
	m±r
;

549 } 
	trobj
;

555 
	#LRU_CLOCK
(è((1000/
£rv”
.
hz
 <ğ
LRU_CLOCK_RESOLUTION
è? s”v”.
Ìuşock
 : 
	`g‘LRUClock
())

	)

561 
	#š™SticSŒšgObjeù
(
_v¬
,
_±r
) do { \

562 
_v¬
.
»fcouÁ
 = 1; \

563 
_v¬
.
ty³
 = 
OBJ_STRING
; \

564 
_v¬
.
’codšg
 = 
OBJ_ENCODING_RAW
; \

565 
_v¬
.
±r
 = 
_±r
; \

566 } 0)

	)

568 
	geviùiÚPoŞEÁry
;

573 
	s»disDb
 {

574 
diù
 *
	mdiù
;

575 
diù
 *
	mexpœes
;

576 
diù
 *
	mblockšg_keys
;

577 
diù
 *
	m»ady_keys
;

578 
diù
 *
	mw©ched_keys
;

579 
	mid
;

580 
	mavg_‰l
;

581 } 
	t»disDb
;

584 
	smuÉiCmd
 {

585 
robj
 **
	m¬gv
;

586 
	m¬gc
;

587 
»disCommªd
 *
	mcmd
;

588 } 
	tmuÉiCmd
;

590 
	smuÉiS‹
 {

591 
muÉiCmd
 *
	mcommªds
;

592 
	mcouÁ
;

593 
	mmš»¶iÿs
;

594 
time_t
 
	mmš»¶iÿs_timeout
;

595 } 
	tmuÉiS‹
;

599 
	sblockšgS‹
 {

601 
m¡ime_t
 
	mtimeout
;

605 
diù
 *
	mkeys
;

607 
robj
 *
	mrg‘
;

611 
	mnum»¶iÿs
;

612 
	m»¶off£t
;

613 } 
	tblockšgS‹
;

626 
	s»adyLi¡
 {

627 
»disDb
 *
	mdb
;

628 
robj
 *
	mkey
;

629 } 
	t»adyLi¡
;

633 
	sş›Á
 {

634 
ušt64_t
 
	mid
;

635 
	mfd
;

636 
»disDb
 *
	mdb
;

637 
robj
 *
	mÇme
;

638 
sds
 
	mqu”ybuf
;

639 
size_t
 
	mqu”ybuf_³ak
;

640 
	m¬gc
;

641 
robj
 **
	m¬gv
;

642 
»disCommªd
 *
	mcmd
, *
	mÏ¡cmd
;

643 
	m»qty³
;

644 
	mmuÉibulkËn
;

645 
	mbulkËn
;

646 
li¡
 *
	m»¶y
;

647 
	m»¶y_by‹s
;

648 
size_t
 
	m£ÁËn
;

650 
time_t
 
	mùime
;

651 
time_t
 
	mÏ¡š‹¿ùiÚ
;

652 
time_t
 
	mobuf_soá_lim™_»ached_time
;

653 
	mæags
;

654 
	mauth’tiÿ‹d
;

655 
	m»¶¡©e
;

656 
	m»¶_put_Úlše_Ú_ack
;

657 
	m»¶dbfd
;

658 
off_t
 
	m»¶dboff
;

659 
off_t
 
	m»¶dbsize
;

660 
sds
 
	m»¶´—mbË
;

661 
	m»¶off
;

662 
	m»¶_ack_off
;

663 
	m»¶_ack_time
;

664 
	mpsync_š™Ÿl_off£t
;

667 
	m»¶runid
[
CONFIG_RUN_ID_SIZE
+1];

668 
	m¦ave_li¡’šg_pÜt
;

669 
	m¦ave_ÿ·
;

670 
muÉiS‹
 
	mm¡©e
;

671 
	mbty³
;

672 
blockšgS‹
 
	mbpİ
;

673 
	mwoff
;

674 
li¡
 *
	mw©ched_keys
;

675 
diù
 *
	mpubsub_chªÃls
;

676 
li¡
 *
	mpubsub_·‰”ns
;

677 
sds
 
	m³”id
;

680 
	mbuåos
;

681 
	mbuf
[
PROTO_REPLY_CHUNK_BYTES
];

682 } 
	tş›Á
;

684 
	s§v•¬am
 {

685 
time_t
 
	m£cÚds
;

686 
	mchªges
;

689 
	smoduËLßdQueueEÁry
 {

690 
sds
 
	m·th
;

691 
	m¬gc
;

692 
robj
 **
	m¬gv
;

695 
	ssh¬edObjeùsSŒuù
 {

696 
robj
 *
	mülf
, *
	mok
, *
	m”r
, *
	mem±ybulk
, *
	mcz”o
, *
	mcÚe
, *
	múegÚe
, *
	mpÚg
, *
	m¥aû
,

697 *
	mcŞÚ
, *
	mnuÎbulk
, *
	mnuÎmuÉibulk
, *
	mqueued
,

698 *
	mem±ymuÉibulk
, *
	mwrÚgty³”r
, *
	mnokey”r
, *
	msyÁax”r
, *
	m§meobjeù”r
,

699 *
	moutoäªg“¼
, *
	mnosü‹¼
, *
	mlßdšg”r
, *
	m¦owsü‹¼
, *
	mbg§v“¼
,

700 *
	mma¡”dowÃ¼
, *
	mro¦av“¼
, *
	mexeÿbÜ‹¼
, *
	mnßuth”r
, *
	mnÜ•liÿ£¼
,

701 *
	mbusykey”r
, *
	moom”r
, *
	m¶us
, *
	mmes§gebulk
, *
	mpmes§gebulk
, *
	msubsüibebulk
,

702 *
	munsubsüibebulk
, *
	mpsubsüibebulk
, *
	mpunsubsüibebulk
, *
	md–
, *
	muÆšk
,

703 *
	m½İ
, *
	mÍİ
, *
	mÍush
, *
	mem±ysÿn
,

704 *
	m£Ëù
[
PROTO_SHARED_SELECT_CMDS
],

705 *
	mš‹g”s
[
OBJ_SHARED_INTEGERS
],

706 *
	mmbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
],

707 *
	mbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
];

708 
sds
 
	mmš¡ršg
, 
	mmax¡ršg
;

712 
	szskli¡Node
 {

713 
sds
 
	m–e
;

714 
	mscÜe
;

715 
zskli¡Node
 *
	mbackw¬d
;

716 
	szskli¡Lev–
 {

717 
zskli¡Node
 *
	mfÜw¬d
;

718 
	m¥ª
;

719 } 
	mËv–
[];

720 } 
	tzskli¡Node
;

722 
	szskli¡
 {

723 
zskli¡Node
 *
	mh—d”
, *
	m
;

724 
	mËngth
;

725 
	mËv–
;

726 } 
	tzskli¡
;

728 
	sz£t
 {

729 
diù
 *
	mdiù
;

730 
zskli¡
 *
	mz¦
;

731 } 
	tz£t
;

733 
	sş›ÁBufãrLim™sCÚfig
 {

734 
	mh¬d_lim™_by‹s
;

735 
	msoá_lim™_by‹s
;

736 
time_t
 
	msoá_lim™_£cÚds
;

737 } 
	tş›ÁBufãrLim™sCÚfig
;

739 
ş›ÁBufãrLim™sCÚfig
 
ş›ÁBufãrLim™sDeçuÉs
[
CLIENT_TYPE_OBUF_COUNT
];

747 
	s»disOp
 {

748 
robj
 **
	m¬gv
;

749 
	m¬gc
, 
	mdbid
, 
	mrg‘
;

750 
»disCommªd
 *
	mcmd
;

751 } 
	t»disOp
;

760 
	s»disOpA¼ay
 {

761 
»disOp
 *
	mİs
;

762 
	mnumİs
;

763 } 
	t»disOpA¼ay
;

769 
	gşu¡”S‹
;

773 #ifdeà
_AIX


774 #undeà
hz


777 
	s»disS”v”
 {

779 
pid_t
 
	mpid
;

780 *
	mcÚfigfe
;

781 *
	mexecubË
;

782 **
	mexec_¬gv
;

783 
	mhz
;

784 
»disDb
 *
	mdb
;

785 
diù
 *
	mcommªds
;

786 
diù
 *
	mÜig_commªds
;

787 
«Ev’tLoİ
 *
	m–
;

788 
	mÌuşock
:
LRU_BITS
;

789 
	mshutdown_a§p
;

790 
	maùiv”ehashšg
;

791 *
	m»quœ•ass
;

792 *
	mpidfe
;

793 
	m¬ch_b™s
;

794 
	müÚloİs
;

795 
	mrunid
[
CONFIG_RUN_ID_SIZE
+1];

796 
	m£Áš–_mode
;

798 
diù
 *
	mmoduË­i
;

799 
li¡
 *
	mlßdmoduË_queue
;

801 
	mpÜt
;

802 
	mtı_backlog
;

803 *
	mbšdaddr
[
CONFIG_BINDADDR_MAX
];

804 
	mbšdaddr_couÁ
;

805 *
	munixsock‘
;

806 
mode_t
 
	munixsock‘³rm
;

807 
	mfd
[
CONFIG_BINDADDR_MAX
];

808 
	mfd_couÁ
;

809 
	msofd
;

810 
	mcfd
[
CONFIG_BINDADDR_MAX
];

811 
	mcfd_couÁ
;

812 
li¡
 *
	mş›Ás
;

813 
li¡
 *
	mş›Ás_to_şo£
;

814 
li¡
 *
	mş›Ás_³ndšg_wr™e
;

815 
li¡
 *
	m¦aves
, *
	mmÚ™Üs
;

816 
ş›Á
 *
	mcu¼’t_ş›Á
;

817 
	mş›Ás_·u£d
;

818 
m¡ime_t
 
	mş›Ás_·u£_’d_time
;

819 
	mÃ‹¼
[
ANET_ERR_LEN
];

820 
diù
 *
	mmig¿‹_ÿched_sock‘s
;

821 
ušt64_t
 
	mÃxt_ş›Á_id
;

822 
	m´Ùeùed_mode
;

824 
	mlßdšg
;

825 
off_t
 
	mlßdšg_tÙ®_by‹s
;

826 
off_t
 
	mlßdšg_lßded_by‹s
;

827 
time_t
 
	mlßdšg_¡¬t_time
;

828 
off_t
 
	mlßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

830 
»disCommªd
 *
	md–Commªd
, *
	mmuÉiCommªd
, *
	mÍushCommªd
, *
	mÍİCommªd
,

831 *
	m½İCommªd
, *
	m¤emCommªd
, *
	mexecCommªd
;

833 
time_t
 
	m¡©_¡¬‰ime
;

834 
	m¡©_numcommªds
;

835 
	m¡©_numcÚÃùiÚs
;

836 
	m¡©_expœedkeys
;

837 
	m¡©_eviùedkeys
;

838 
	m¡©_key¥aû_h™s
;

839 
	m¡©_key¥aû_mis£s
;

840 
size_t
 
	m¡©_³ak_memÜy
;

841 
	m¡©_fÜk_time
;

842 
	m¡©_fÜk_¿‹
;

843 
	m¡©_»jeùed_cÚn
;

844 
	m¡©_sync_fuÎ
;

845 
	m¡©_sync_·¹Ÿl_ok
;

846 
	m¡©_sync_·¹Ÿl_”r
;

847 
li¡
 *
	m¦owlog
;

848 
	m¦owlog_’Œy_id
;

849 
	m¦owlog_log_¦ow”_thª
;

850 
	m¦owlog_max_Ën
;

851 
size_t
 
	m»sid’t_£t_size
;

852 
	m¡©_Ãt_šput_by‹s
;

853 
	m¡©_Ãt_ouut_by‹s
;

857 
	mÏ¡_§m¶e_time
;

858 
	mÏ¡_§m¶e_couÁ
;

859 
	m§m¶es
[
STATS_METRIC_SAMPLES
];

860 
	midx
;

861 } 
	mš¡_m‘ric
[
STATS_METRIC_COUNT
];

863 
	mv”bos™y
;

864 
	mmaxidËtime
;

865 
	mtık“·live
;

866 
	maùive_expœe_’abËd
;

867 
size_t
 
	mş›Á_max_qu”ybuf_Ën
;

868 
	mdbnum
;

869 
	msu³rvi£d
;

870 
	msu³rvi£d_mode
;

871 
	md«mÚize
;

872 
ş›ÁBufãrLim™sCÚfig
 
	mş›Á_obuf_lim™s
[
CLIENT_TYPE_OBUF_COUNT
];

874 
	maof_¡©e
;

875 
	maof_fsync
;

876 *
	maof_f’ame
;

877 
	maof_no_fsync_Ú_»wr™e
;

878 
	maof_»wr™e_³rc
;

879 
off_t
 
	maof_»wr™e_mš_size
;

880 
off_t
 
	maof_»wr™e_ba£_size
;

881 
off_t
 
	maof_cu¼’t_size
;

882 
	maof_»wr™e_scheduËd
;

883 
pid_t
 
	maof_chd_pid
;

884 
li¡
 *
	maof_»wr™e_buf_blocks
;

885 
sds
 
	maof_buf
;

886 
	maof_fd
;

887 
	maof_£Ëùed_db
;

888 
time_t
 
	maof_æush_po¡pÚed_¡¬t
;

889 
time_t
 
	maof_Ï¡_fsync
;

890 
time_t
 
	maof_»wr™e_time_Ï¡
;

891 
time_t
 
	maof_»wr™e_time_¡¬t
;

892 
	maof_Ï¡bg»wr™e_¡©us
;

893 
	maof_d–ayed_fsync
;

894 
	maof_»wr™e_šüem’l_fsync
;

895 
	maof_Ï¡_wr™e_¡©us
;

896 
	maof_Ï¡_wr™e_”ºo
;

897 
	maof_lßd_Œunÿ‹d
;

899 
	maof_pe_wr™e_d©a_to_chd
;

900 
	maof_pe_»ad_d©a_äom_·»Á
;

901 
	maof_pe_wr™e_ack_to_·»Á
;

902 
	maof_pe_»ad_ack_äom_chd
;

903 
	maof_pe_wr™e_ack_to_chd
;

904 
	maof_pe_»ad_ack_äom_·»Á
;

905 
	maof_¡İ_£ndšg_diff
;

907 
sds
 
	maof_chd_diff
;

909 
	mdœty
;

910 
	mdœty_befÜe_bg§ve
;

911 
pid_t
 
	mrdb_chd_pid
;

912 
§v•¬am
 *
	m§v•¬ams
;

913 
	m§v•¬am¦’
;

914 *
	mrdb_f’ame
;

915 
	mrdb_com´essiÚ
;

916 
	mrdb_checksum
;

917 
time_t
 
	mÏ¡§ve
;

918 
time_t
 
	mÏ¡bg§ve_Œy
;

919 
time_t
 
	mrdb_§ve_time_Ï¡
;

920 
time_t
 
	mrdb_§ve_time_¡¬t
;

921 
	mrdb_chd_ty³
;

922 
	mÏ¡bg§ve_¡©us
;

923 
	m¡İ_wr™es_Ú_bg§ve_”r
;

924 
	mrdb_pe_wr™e_»suÉ_to_·»Á
;

925 
	mrdb_pe_»ad_»suÉ_äom_chd
;

927 
»disOpA¼ay
 
	m®so_´İag©e
;

929 *
	mlogfe
;

930 
	msy¦og_’abËd
;

931 *
	msy¦og_id’t
;

932 
	msy¦og_çc™y
;

934 
	m¦ave£ldb
;

935 
	mma¡”_»¶_off£t
;

936 
	m»¶_pšg_¦ave_³riod
;

937 *
	m»¶_backlog
;

938 
	m»¶_backlog_size
;

939 
	m»¶_backlog_hi¡Ën
;

940 
	m»¶_backlog_idx
;

941 
	m»¶_backlog_off
;

943 
time_t
 
	m»¶_backlog_time_lim™
;

945 
time_t
 
	m»¶_no_¦aves_sšû
;

947 
	m»¶_mš_¦aves_to_wr™e
;

948 
	m»¶_mš_¦aves_max_Ïg
;

949 
	m»¶_good_¦aves_couÁ
;

950 
	m»¶_diskËss_sync
;

951 
	m»¶_diskËss_sync_d–ay
;

953 *
	mma¡”auth
;

954 *
	mma¡”ho¡
;

955 
	mma¡”pÜt
;

956 
	m»¶_timeout
;

957 
ş›Á
 *
	mma¡”
;

958 
ş›Á
 *
	mÿched_ma¡”
;

959 
	m»¶_syncio_timeout
;

960 
	m»¶_¡©e
;

961 
off_t
 
	m»¶_Œªsãr_size
;

962 
off_t
 
	m»¶_Œªsãr_»ad
;

963 
off_t
 
	m»¶_Œªsãr_Ï¡_fsync_off
;

964 
	m»¶_Œªsãr_s
;

965 
	m»¶_Œªsãr_fd
;

966 *
	m»¶_Œªsãr_tmpfe
;

967 
time_t
 
	m»¶_Œªsãr_Ï¡io
;

968 
	m»¶_£rve_¡®e_d©a
;

969 
	m»¶_¦ave_ro
;

970 
time_t
 
	m»¶_down_sšû
;

971 
	m»¶_di§bË_tı_nod–ay
;

972 
	m¦ave_´iÜ™y
;

973 
	m»¶_ma¡”_runid
[
CONFIG_RUN_ID_SIZE
+1];

974 
	m»¶_ma¡”_š™Ÿl_off£t
;

975 
	m»¶_¦ave_Ïzy_æush
;

977 
diù
 *
	m»¶_sütÿche_diù
;

978 
li¡
 *
	m»¶_sütÿche_fifo
;

979 
	m»¶_sütÿche_size
;

981 
li¡
 *
	mş›Ás_wa™šg_acks
;

982 
	mg‘_ack_äom_¦aves
;

984 
	mmaxş›Ás
;

985 
	mmaxmemÜy
;

986 
	mmaxmemÜy_pŞicy
;

987 
	mmaxmemÜy_§m¶es
;

988 
	mlfu_log_çùÜ
;

989 
	mlfu_deÿy_time
;

991 
	mbpİ_blocked_ş›Ás
;

992 
li¡
 *
	munblocked_ş›Ás
;

993 
li¡
 *
	m»ady_keys
;

996 
	msÜt_desc
;

997 
	msÜt_®pha
;

998 
	msÜt_by·‰”n
;

999 
	msÜt_¡Üe
;

1001 
size_t
 
	mhash_max_zli¡_’Œ›s
;

1002 
size_t
 
	mhash_max_zli¡_v®ue
;

1003 
size_t
 
	m£t_max_št£t_’Œ›s
;

1004 
size_t
 
	mz£t_max_zli¡_’Œ›s
;

1005 
size_t
 
	mz£t_max_zli¡_v®ue
;

1006 
size_t
 
	mhÎ_¥¬£_max_by‹s
;

1008 
	mli¡_max_zli¡_size
;

1009 
	mli¡_com´ess_d•th
;

1011 
time_t
 
	munixtime
;

1012 
	mm¡ime
;

1014 
diù
 *
	mpubsub_chªÃls
;

1015 
li¡
 *
	mpubsub_·‰”ns
;

1016 
	mnÙify_key¥aû_ev’ts
;

1019 
	mşu¡”_’abËd
;

1020 
m¡ime_t
 
	mşu¡”_node_timeout
;

1021 *
	mşu¡”_cÚfigfe
;

1022 
şu¡”S‹
 *
	mşu¡”
;

1023 
	mşu¡”_mig¿tiÚ_b¬r›r
;

1024 
	mşu¡”_¦ave_v®id™y_çùÜ
;

1025 
	mşu¡”_»quœe_fuÎ_cov”age
;

1027 *
	mşu¡”_ªnounû_
;

1028 
	mşu¡”_ªnounû_pÜt
;

1029 
	mşu¡”_ªnounû_bus_pÜt
;

1031 
lua_S‹
 *
	mlua
;

1032 
ş›Á
 *
	mlua_ş›Á
;

1033 
ş›Á
 *
	mlua_ÿÎ”
;

1034 
diù
 *
	mlua_süts
;

1035 
m¡ime_t
 
	mlua_time_lim™
;

1036 
m¡ime_t
 
	mlua_time_¡¬t
;

1037 
	mlua_wr™e_dœty
;

1039 
	mlua_¿ndom_dœty
;

1041 
	mlua_»¶iÿ‹_commªds
;

1042 
	mlua_muÉi_em™‹d
;

1043 
	mlua_»¶
;

1044 
	mlua_timedout
;

1046 
	mlua_kl
;

1047 
	mlua_®ways_»¶iÿ‹_commªds
;

1049 
	mÏzyä“_Ïzy_eviùiÚ
;

1050 
	mÏzyä“_Ïzy_expœe
;

1051 
	mÏzyä“_Ïzy_£rv”_d–
;

1053 
	mÏ‹ncy_mÚ™Ü_th»shŞd
;

1054 
diù
 *
	mÏ‹ncy_ev’ts
;

1056 cÚ¡ *
	mas£¹_çed
;

1057 cÚ¡ *
	mas£¹_fe
;

1058 
	mas£¹_lše
;

1059 
	mbug_»pÜt_¡¬t
;

1060 
	mw©chdog_³riod
;

1062 
size_t
 
	msy¡em_memÜy_size
;

1065 
	spubsubP©‹º
 {

1066 
ş›Á
 *
	mş›Á
;

1067 
robj
 *
	m·‰”n
;

1068 } 
	tpubsubP©‹º
;

1070 
	t»disCommªdProc
(
	tş›Á
 *
	tc
);

1071 *
	t»disG‘KeysProc
(
	t»disCommªd
 *
	tcmd
, 
	trobj
 **
	t¬gv
, 
	t¬gc
, *
	tnumkeys
);

1072 
	s»disCommªd
 {

1073 *
	mÇme
;

1074 
»disCommªdProc
 *
	m´oc
;

1075 
	m¬™y
;

1076 *
	msæags
;

1077 
	mæags
;

1080 
»disG‘KeysProc
 *
	mg‘keys_´oc
;

1082 
	mfœ¡key
;

1083 
	mÏ¡key
;

1084 
	mkey¡•
;

1085 
	mmiüo£cÚds
, 
	mÿÎs
;

1088 
	s»disFunùiÚSym
 {

1089 *
	mÇme
;

1090 
	mpoš‹r
;

1093 
	s_»disSÜtObjeù
 {

1094 
robj
 *
	mobj
;

1096 
	mscÜe
;

1097 
robj
 *
	mcmpobj
;

1098 } 
	mu
;

1099 } 
	t»disSÜtObjeù
;

1101 
	s_»disSÜtO³¿tiÚ
 {

1102 
	mty³
;

1103 
robj
 *
	m·‰”n
;

1104 } 
	t»disSÜtO³¿tiÚ
;

1108 
robj
 *
	msubjeù
;

1109 
	m’codšg
;

1110 
	mdœeùiÚ
;

1111 
quickli¡I‹r
 *
	m™”
;

1112 } 
	tli¡Ty³I‹¿tÜ
;

1116 
li¡Ty³I‹¿tÜ
 *
	mli
;

1117 
quickli¡EÁry
 
	m’Œy
;

1118 } 
	tli¡Ty³EÁry
;

1122 
robj
 *
	msubjeù
;

1123 
	m’codšg
;

1124 
	mii
;

1125 
diùI‹¿tÜ
 *
	mdi
;

1126 } 
	t£tTy³I‹¿tÜ
;

1133 
robj
 *
	msubjeù
;

1134 
	m’codšg
;

1136 *
	måŒ
, *
	mv±r
;

1138 
diùI‹¿tÜ
 *
	mdi
;

1139 
diùEÁry
 *
	mde
;

1140 } 
	thashTy³I‹¿tÜ
;

1142 
	#OBJ_HASH_KEY
 1

	)

1143 
	#OBJ_HASH_VALUE
 2

	)

1149 
»disS”v”
 
£rv”
;

1150 
sh¬edObjeùsSŒuù
 
sh¬ed
;

1151 
diùTy³
 
objeùKeyPoš‹rV®ueDiùTy³
;

1152 
diùTy³
 
£tDiùTy³
;

1153 
diùTy³
 
z£tDiùTy³
;

1154 
diùTy³
 
şu¡”NodesDiùTy³
;

1155 
diùTy³
 
şu¡”NodesBÏckLi¡DiùTy³
;

1156 
diùTy³
 
dbDiùTy³
;

1157 
diùTy³
 
shaSütObjeùDiùTy³
;

1158 
R_Z”o
, 
R_PosInf
, 
R_NegInf
, 
R_Nª
;

1159 
diùTy³
 
hashDiùTy³
;

1160 
diùTy³
 
»¶SütCacheDiùTy³
;

1161 
diùTy³
 
key±rDiùTy³
;

1162 
diùTy³
 
moduËsDiùTy³
;

1169 
moduËIn™ModuËsSy¡em
();

1170 
moduËLßd
(cÚ¡ *
·th
, **
¬gv
, 
¬gc
);

1171 
moduËLßdFromQueue
();

1172 *
moduËG‘CommªdKeysVŸAPI
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1173 
moduËTy³
 *
moduËTy³LookupModuËByID
(
ušt64_t
 
id
);

1174 
moduËTy³NameByID
(*
Çme
, 
ušt64_t
 
moduËid
);

1177 
u¡ime
();

1178 
m¡ime
();

1179 
g‘RªdomHexCh¬s
(*
p
, 
Ën
);

1180 
ušt64_t
 
üc64
(ušt64_ˆ
üc
, cÚ¡ *
s
, ušt64_ˆ
l
);

1181 
ex™FromChd
(
»tcode
);

1182 
size_t
 
»disPİcouÁ
(*
s
, 
couÁ
);

1183 
»disS‘ProcT™Ë
(*
t™Ë
);

1186 
ş›Á
 *
ü—‹Cl›Á
(
fd
);

1187 
şo£TimedoutCl›Ás
();

1188 
ä“Cl›Á
(
ş›Á
 *
c
);

1189 
ä“Cl›ÁAsync
(
ş›Á
 *
c
);

1190 
»£tCl›Á
(
ş›Á
 *
c
);

1191 
£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1192 *
addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
);

1193 
£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
);

1194 
´oûssIÅutBufãr
(
ş›Á
 *
c
);

1195 
acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1196 
acû±TıHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1197 
acû±UnixHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1198 
»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1199 
addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
);

1200 
addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
);

1201 
addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
);

1202 
addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

1203 
addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
);

1204 
addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
);

1205 
addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
);

1206 
addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
);

1207 
addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
);

1208 
addR•lyDoubË
(
ş›Á
 *
c
, 
d
);

1209 
addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
);

1210 
addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

1211 
addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
);

1212 
cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
);

1213 *
dupCl›ÁR•lyV®ue
(*
o
);

1214 
g‘Cl›ÁsMaxBufãrs
(*
lÚge¡_ouut_li¡
,

1215 *
bigge¡_šput_bufãr
);

1216 *
g‘Cl›ÁP“rId
(
ş›Á
 *client);

1217 
sds
 
ÿtCl›ÁInfoSŒšg
(sd 
s
, 
ş›Á
 *client);

1218 
sds
 
g‘AÎCl›ÁsInfoSŒšg
();

1219 
»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...);

1220 
»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
);

1221 
»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
);

1222 
g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
);

1223 
ä“Cl›ÁsInAsyncF»eQueue
();

1224 
asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
);

1225 
g‘Cl›ÁTy³
(
ş›Á
 *
c
);

1226 
g‘Cl›ÁTy³ByName
(*
Çme
);

1227 *
g‘Cl›ÁTy³Name
(
şass
);

1228 
æushSÏvesOuutBufãrs
();

1229 
discÚÃùSÏves
();

1230 
li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
);

1231 
·u£Cl›Ás
(
m¡ime_t
 
du¿tiÚ
);

1232 
ş›ÁsA»Pau£d
();

1233 
´oûssEv’tsWheBlocked
();

1234 
hªdËCl›ÁsW™hP’dšgWr™es
();

1235 
ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
);

1236 
uÆškCl›Á
(
ş›Á
 *
c
);

1237 
wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
);

1239 #ifdeà
__GNUC__


1240 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

1241 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1242 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

1243 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1245 
	`addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

1246 
	`addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

1250 
	`li¡Ty³TryCÚv”siÚ
(
robj
 *
subjeù
,„obj *
v®ue
);

1251 
	`li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
);

1252 
robj
 *
	`li¡Ty³Pİ
Ôobj *
subjeù
, 
wh”e
);

1253 
	`li¡Ty³L’gth
(cÚ¡ 
robj
 *
subjeù
);

1254 
li¡Ty³I‹¿tÜ
 *
	`li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
, 
dœeùiÚ
);

1255 
	`li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
);

1256 
	`li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
);

1257 
robj
 *
	`li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
);

1258 
	`li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
);

1259 
	`li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
);

1260 
	`li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
);

1261 
	`li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
);

1262 
	`unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
);

1263 
	`hªdËCl›ÁsBlockedOnLi¡s
();

1264 
	`pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

1265 
	`sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
);

1268 
	`unw©chAÎKeys
(
ş›Á
 *
c
);

1269 
	`š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

1270 
	`ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

1271 
	`queueMuÉiCommªd
(
ş›Á
 *
c
);

1272 
	`touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
);

1273 
	`touchW©chedKeysOnFlush
(
dbid
);

1274 
	`disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
);

1275 
	`æagT¿n§ùiÚ
(
ş›Á
 *
c
);

1276 
	`execCommªdPrİag©eMuÉi
(
ş›Á
 *
c
);

1279 
	`deüRefCouÁ
(
robj
 *
o
);

1280 
	`deüRefCouÁVoid
(*
o
);

1281 
	`šüRefCouÁ
(
robj
 *
o
);

1282 
robj
 *
	`makeObjeùSh¬ed
Ôobj *
o
);

1283 
robj
 *
	`»£tRefCouÁ
Ôobj *
obj
);

1284 
	`ä“SŒšgObjeù
(
robj
 *
o
);

1285 
	`ä“Li¡Objeù
(
robj
 *
o
);

1286 
	`ä“S‘Objeù
(
robj
 *
o
);

1287 
	`ä“Z£tObjeù
(
robj
 *
o
);

1288 
	`ä“HashObjeù
(
robj
 *
o
);

1289 
robj
 *
	`ü—‹Objeù
(
ty³
, *
±r
);

1290 
robj
 *
	`ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

1291 
robj
 *
	`ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

1292 
robj
 *
	`ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

1293 
robj
 *
	`dupSŒšgObjeù
(cÚ¡„obj *
o
);

1294 
	`isSdsR•»£ÁabËAsLÚgLÚg
(
sds
 
s
, *
Îv®
);

1295 
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
ÎÚgv®
);

1296 
robj
 *
	`ŒyObjeùEncodšg
Ôobj *
o
);

1297 
robj
 *
	`g‘DecodedObjeù
Ôobj *
o
);

1298 
size_t
 
	`¡ršgObjeùL’
(
robj
 *
o
);

1299 
robj
 *
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

1300 
robj
 *
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
);

1301 
robj
 *
	`ü—‹Quickli¡Objeù
();

1302 
robj
 *
	`ü—‹Zli¡Objeù
();

1303 
robj
 *
	`ü—‹S‘Objeù
();

1304 
robj
 *
	`ü—‹IÁ£tObjeù
();

1305 
robj
 *
	`ü—‹HashObjeù
();

1306 
robj
 *
	`ü—‹Z£tObjeù
();

1307 
robj
 *
	`ü—‹Z£tZli¡Objeù
();

1308 
robj
 *
	`ü—‹ModuËObjeù
(
moduËTy³
 *
mt
, *
v®ue
);

1309 
	`g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1310 
	`checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
);

1311 
	`g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1312 
	`g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1313 
	`g‘DoubËFromObjeù
(cÚ¡ 
robj
 *
o
, *
rg‘
);

1314 
	`g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
);

1315 
	`g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
);

1316 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1317 *
	`¡rEncodšg
(
’codšg
);

1318 
	`com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1319 
	`cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1320 
	`equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1321 
	`e¡im©eObjeùIdËTime
(
robj
 *
o
);

1322 
	#sdsEncodedObjeù
(
obj±r
è(obj±r->
’codšg
 =ğ
OBJ_ENCODING_RAW
 || obj±r->’codšg =ğ
OBJ_ENCODING_EMBSTR
)

	)

1325 
ssize_t
 
	`syncWr™e
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1326 
ssize_t
 
	`syncR—d
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1327 
ssize_t
 
	`syncR—dLše
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1330 
	`»¶iÿtiÚF“dSÏves
(
li¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1331 
	`»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
li¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1332 
	`upd©eSÏvesWa™šgBg§ve
(
bg§v“¼
, 
ty³
);

1333 
	`»¶iÿtiÚCrÚ
();

1334 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

1335 
	`»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
);

1336 
	`»sizeR•liÿtiÚBacklog
(
Ãwsize
);

1337 
	`»¶iÿtiÚS‘Ma¡”
(*

, 
pÜt
);

1338 
	`»¶iÿtiÚUn£tMa¡”
();

1339 
	`»äeshGoodSÏvesCouÁ
();

1340 
	`»¶iÿtiÚSütCacheIn™
();

1341 
	`»¶iÿtiÚSütCacheFlush
();

1342 
	`»¶iÿtiÚSütCacheAdd
(
sds
 
sha1
);

1343 
	`»¶iÿtiÚSütCacheExi¡s
(
sds
 
sha1
);

1344 
	`´oûssCl›ÁsWa™šgR•liÿs
();

1345 
	`unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
);

1346 
	`»¶iÿtiÚCouÁAcksByOff£t
(
off£t
);

1347 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

1348 
	`»¶iÿtiÚG‘SÏveOff£t
();

1349 *
	`»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
);

1350 
	`g‘PsyncIn™ŸlOff£t
();

1351 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
ş›Á
 *
¦ave
, 
off£t
);

1354 
	`¡¬tLßdšg
(
FILE
 *
å
);

1355 
	`lßdšgProg»ss
(
off_t
 
pos
);

1356 
	`¡İLßdšg
();

1359 
	~"rdb.h
"

1362 
	`æushAµ’dOÆyFe
(
fÜû
);

1363 
	`ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1364 
	`aofRemoveTempFe
(
pid_t
 
chdpid
);

1365 
	`»wr™eAµ’dOÆyFeBackground
();

1366 
	`lßdAµ’dOÆyFe
(*
f’ame
);

1367 
	`¡İAµ’dOÆy
();

1368 
	`¡¬tAµ’dOÆy
();

1369 
	`backgroundRewr™eDÚeHªdËr
(
ex™code
, 
bysigÇl
);

1370 
	`aofRewr™eBufãrRe£t
();

1371 
	`aofRewr™eBufãrSize
();

1376 
	#ZADD_NONE
 0

	)

1377 
	#ZADD_INCR
 (1<<0è

	)

1378 
	#ZADD_NX
 (1<<1è

	)

1379 
	#ZADD_XX
 (1<<2è

	)

1382 
	#ZADD_NOP
 (1<<3è

	)

1383 
	#ZADD_NAN
 (1<<4è

	)

1384 
	#ZADD_ADDED
 (1<<5è

	)

1385 
	#ZADD_UPDATED
 (1<<6è

	)

1388 
	#ZADD_CH
 (1<<16è

	)

1392 
mš
, 
max
;

1393 
mšex
, 
maxex
;

1394 } 
	tz¿nge¥ec
;

1398 
sds
 
mš
, 
max
;

1399 
mšex
, 
maxex
;

1400 } 
	tzËx¿nge¥ec
;

1402 
zskli¡
 *
	`z¦C»©e
();

1403 
	`z¦F»e
(
zskli¡
 *
z¦
);

1404 
zskli¡Node
 *
	`z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
);

1405 *
	`zzlIn£¹
(*
zl
, 
sds
 
–e
, 
scÜe
);

1406 
	`z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
, 
zskli¡Node
 **
node
);

1407 
zskli¡Node
 *
	`z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

1408 
zskli¡Node
 *
	`z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

1409 
	`zzlG‘ScÜe
(*
¥Œ
);

1410 
	`zzlNext
(*
zl
, **
•Œ
, **
¥Œ
);

1411 
	`zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
);

1412 *
	`zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

1413 *
	`zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

1414 
	`z£tL’gth
(cÚ¡ 
robj
 *
zobj
);

1415 
	`z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
);

1416 
	`z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
);

1417 
	`z£tScÜe
(
robj
 *
zobj
, 
sds
 
memb”
, *
scÜe
);

1418 
	`z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
o
);

1419 
	`z£tAdd
(
robj
 *
zobj
, 
scÜe
, 
sds
 
–e
, *
æags
, *
ÃwscÜe
);

1420 
	`z£tRªk
(
robj
 *
zobj
, 
sds
 
–e
, 
»v”£
);

1421 
	`z£tD–
(
robj
 *
zobj
, 
sds
 
–e
);

1422 
sds
 
	`zli¡G‘Objeù
(*
¥Œ
);

1423 
	`z¦V®ueG‹Mš
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

1424 
	`z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

1425 
	`z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
);

1426 
	`z¦P¬£LexRªge
(
robj
 *
mš
,„obj *
max
, 
zËx¿nge¥ec
 *
¥ec
);

1427 *
	`zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

1428 *
	`zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

1429 
zskli¡Node
 *
	`z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

1430 
zskli¡Node
 *
	`z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

1431 
	`zzlLexV®ueG‹Mš
(*
p
, 
zËx¿nge¥ec
 *
¥ec
);

1432 
	`zzlLexV®ueL‹Max
(*
p
, 
zËx¿nge¥ec
 *
¥ec
);

1433 
	`z¦LexV®ueG‹Mš
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

1434 
	`z¦LexV®ueL‹Max
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

1437 
	`ä“MemÜyIfN“ded
();

1438 
	`´oûssCommªd
(
ş›Á
 *
c
);

1439 
	`£tupSigÇlHªdËrs
();

1440 
»disCommªd
 *
	`lookupCommªd
(
sds
 
Çme
);

1441 
»disCommªd
 *
	`lookupCommªdByCSŒšg
(*
s
);

1442 
»disCommªd
 *
	`lookupCommªdOrOrigš®
(
sds
 
Çme
);

1443 
	`ÿÎ
(
ş›Á
 *
c
, 
æags
);

1444 
	`´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
æags
);

1445 
	`®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
rg‘
);

1446 
	`fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
);

1447 
	`´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
);

1448 
	`´ev’tCommªdAOF
(
ş›Á
 *
c
);

1449 
	`´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
);

1450 
	`´•¬eFÜShutdown
();

1451 #ifdeà
__GNUC__


1452 
	$£rv”Log
(
Ëv–
, cÚ¡ *
fmt
, ...)

1453 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1455 
	`£rv”Log
(
Ëv–
, cÚ¡ *
fmt
, ...);

1457 
	`£rv”LogRaw
(
Ëv–
, cÚ¡ *
msg
);

1458 
	`£rv”LogFromHªdËr
(
Ëv–
, cÚ¡ *
msg
);

1459 
	`u§ge
();

1460 
	`upd©eDiùResizePŞicy
();

1461 
	`htN“dsResize
(
diù
 *dict);

1462 
	`pİuÏ‹CommªdTabË
();

1463 
	`»£tCommªdTabËSts
();

1464 
	`adju¡O³nFesLim™
();

1465 
	`şo£Li¡’šgSock‘s
(
uÆšk_unix_sock‘
);

1466 
	`upd©eCachedTime
();

1467 
	`»£tS”v”Sts
();

1468 
	`g‘LRUClock
();

1469 cÚ¡ *
	`eviùPŞicyToSŒšg
();

1471 
	#RESTART_SERVER_NONE
 0

	)

1472 
	#RESTART_SERVER_GRACEFULLY
 (1<<0è

	)

1473 
	#RESTART_SERVER_CONFIG_REWRITE
 (1<<1è

	)

1474 
	`»¡¬tS”v”
(
æags
, 
m¡ime_t
 
d–ay
);

1477 
robj
 *
	`£tTy³C»©e
(
sds
 
v®ue
);

1478 
	`£tTy³Add
(
robj
 *
subjeù
, 
sds
 
v®ue
);

1479 
	`£tTy³Remove
(
robj
 *
subjeù
, 
sds
 
v®ue
);

1480 
	`£tTy³IsMemb”
(
robj
 *
subjeù
, 
sds
 
v®ue
);

1481 
£tTy³I‹¿tÜ
 *
	`£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

1482 
	`£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
);

1483 
	`£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
);

1484 
sds
 
	`£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
);

1485 
	`£tTy³RªdomEËm’t
(
robj
 *
£tobj
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
);

1486 
	`£tTy³RªdomEËm’ts
(
robj
 *
£t
, 
couÁ
,„obj *
aux_£t
);

1487 
	`£tTy³Size
(cÚ¡ 
robj
 *
subjeù
);

1488 
	`£tTy³CÚv”t
(
robj
 *
subjeù
, 
’c
);

1491 
	#HASH_SET_TAKE_FIELD
 (1<<0)

	)

1492 
	#HASH_SET_TAKE_VALUE
 (1<<1)

	)

1493 
	#HASH_SET_COPY
 0

	)

1495 
	`hashTy³CÚv”t
(
robj
 *
o
, 
’c
);

1496 
	`hashTy³TryCÚv”siÚ
(
robj
 *
subjeù
,„obj **
¬gv
, 
¡¬t
, 
’d
);

1497 
	`hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
);

1498 
	`hashTy³Exi¡s
(
robj
 *
o
, 
sds
 
key
);

1499 
	`hashTy³D–‘e
(
robj
 *
o
, 
sds
 
key
);

1500 
	`hashTy³L’gth
(cÚ¡ 
robj
 *
o
);

1501 
hashTy³I‹¿tÜ
 *
	`hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

1502 
	`hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
);

1503 
	`hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
);

1504 
	`hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

1505 **
v¡r
,

1506 *
vËn
,

1507 *
vÎ
);

1508 
sds
 
	`hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
);

1509 
	`hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, **
v¡r
, *
vËn
, *
vÎ
);

1510 
sds
 
	`hashTy³Cu¼’tObjeùNewSds
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
);

1511 
robj
 *
	`hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
,„obj *
key
);

1512 
robj
 *
	`hashTy³G‘V®ueObjeù
Ôobj *
o
, 
sds
 
f›ld
);

1513 
	`hashTy³S‘
(
robj
 *
o
, 
sds
 
f›ld
, sd 
v®ue
, 
æags
);

1516 
	`pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
);

1517 
	`pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
);

1518 
	`ä“PubsubP©‹º
(*
p
);

1519 
	`li¡M©chPubsubP©‹º
(*
a
, *
b
);

1520 
	`pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
);

1523 
	`nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
);

1524 
	`key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
);

1525 
sds
 
	`key¥aûEv’tsFÏgsToSŒšg
(
æags
);

1528 
	`lßdS”v”CÚfig
(*
f’ame
, *
İtiÚs
);

1529 
	`­³ndS”v”SaveP¬ams
(
time_t
 
£cÚds
, 
chªges
);

1530 
	`»£tS”v”SaveP¬ams
();

1531 
»wr™eCÚfigS‹
;

1532 
	`»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
, 
sds
 
lše
, 
fÜû
);

1533 
	`»wr™eCÚfig
(*
·th
);

1536 
	`»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

1537 
	`´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
Ïzy
);

1538 
	`expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
);

1539 
	`g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
);

1540 
	`£tExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
wh’
);

1541 
robj
 *
	`lookupKey
(
»disDb
 *
db
,„obj *
key
, 
æags
);

1542 
robj
 *
	`lookupKeyR—d
(
»disDb
 *
db
,„obj *
key
);

1543 
robj
 *
	`lookupKeyWr™e
(
»disDb
 *
db
,„obj *
key
);

1544 
robj
 *
	`lookupKeyR—dOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

1545 
robj
 *
	`lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

1546 
robj
 *
	`lookupKeyR—dW™hFÏgs
(
»disDb
 *
db
,„obj *
key
, 
æags
);

1547 
	#LOOKUP_NONE
 0

	)

1548 
	#LOOKUP_NOTOUCH
 (1<<0)

	)

1549 
	`dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1550 
	`dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1551 
	`£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1552 
	`dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
);

1553 
robj
 *
	`dbRªdomKey
(
»disDb
 *
db
);

1554 
	`dbSyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

1555 
	`dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

1556 
robj
 *
	`dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
,„obj *
key
,„obj *
o
);

1558 
	#EMPTYDB_NO_FLAGS
 0

	)

1559 
	#EMPTYDB_ASYNC
 (1<<0è

	)

1560 
	`em±yDb
(
dbnum
, 
æags
, (
ÿÎback
)(*));

1562 
	`£ËùDb
(
ş›Á
 *
c
, 
id
);

1563 
	`sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
);

1564 
	`sigÇlFlushedDb
(
dbid
);

1565 
	`g‘KeysInSlÙ
(
hash¦Ù
, 
robj
 **
keys
, 
couÁ
);

1566 
	`couÁKeysInSlÙ
(
hash¦Ù
);

1567 
	`d–KeysInSlÙ
(
hash¦Ù
);

1568 
	`v”ifyClu¡”CÚfigW™hD©a
();

1569 
	`sÿnG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
o
, 
cursÜ
);

1570 
	`·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
);

1571 
	`¦ÙToKeyAdd
(
robj
 *
key
);

1572 
	`¦ÙToKeyD–
(
robj
 *
key
);

1573 
	`¦ÙToKeyFlush
();

1574 
	`dbAsyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

1575 
	`em±yDbAsync
(
»disDb
 *
db
);

1576 
	`¦ÙToKeyFlushAsync
();

1577 
size_t
 
	`Ïzyä“G‘P’dšgObjeùsCouÁ
();

1580 *
	`g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1581 
	`g‘KeysF»eResuÉ
(*
»suÉ
);

1582 *
	`zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1583 *
	`ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1584 *
	`sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1585 *
	`mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1588 
	`şu¡”In™
();

1589 
	`üc16
(cÚ¡ *
buf
, 
Ën
);

1590 
	`keyHashSlÙ
(*
key
, 
keyËn
);

1591 
	`şu¡”CrÚ
();

1592 
	`şu¡”Prİag©ePublish
(
robj
 *
chªÃl
,„obj *
mes§ge
);

1593 
	`mig¿‹Clo£TimedoutSock‘s
();

1594 
	`şu¡”BefÜeSË•
();

1597 
	`š™S’tš–CÚfig
();

1598 
	`š™S’tš–
();

1599 
	`£Áš–Tim”
();

1600 *
	`£Áš–HªdËCÚfigu¿tiÚ
(**
¬gv
, 
¬gc
);

1601 
	`£Áš–IsRuÂšg
();

1604 
	`»dis_check_rdb
(*
rdbf’ame
);

1605 
	`»dis_check_rdb_maš
(
¬gc
, **
¬gv
);

1608 
	`sütšgIn™
(
£tup
);

1609 
	`ldbRemoveChd
(
pid_t
 
pid
);

1610 
	`ldbKlFÜkedSessiÚs
();

1611 
	`ldbP’dšgChd»n
();

1614 
	`´oûssUnblockedCl›Ás
();

1615 
	`blockCl›Á
(
ş›Á
 *
c
, 
bty³
);

1616 
	`unblockCl›Á
(
ş›Á
 *
c
);

1617 
	`»¶yToBlockedCl›ÁTimedOut
(
ş›Á
 *
c
);

1618 
	`g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, 
m¡ime_t
 *
timeout
, 
un™
);

1619 
	`discÚÃùAÎBlockedCl›Ás
();

1622 
	`aùiveExpœeCyşe
(
ty³
);

1625 
	`eviùiÚPoŞAÎoc
();

1626 
	#LFU_INIT_VAL
 5

	)

1627 
	`LFUG‘TimeInMšu‹s
();

1628 
ušt8_t
 
	`LFULogInü
(ušt8_ˆ
v®ue
);

1631 *
	`»disG™SHA1
();

1632 *
	`»disG™Dœty
();

1633 
ušt64_t
 
	`»disBudId
();

1636 
	`authCommªd
(
ş›Á
 *
c
);

1637 
	`pšgCommªd
(
ş›Á
 *
c
);

1638 
	`echoCommªd
(
ş›Á
 *
c
);

1639 
	`commªdCommªd
(
ş›Á
 *
c
);

1640 
	`£tCommªd
(
ş›Á
 *
c
);

1641 
	`£ŠxCommªd
(
ş›Á
 *
c
);

1642 
	`£‹xCommªd
(
ş›Á
 *
c
);

1643 
	`p£‹xCommªd
(
ş›Á
 *
c
);

1644 
	`g‘Commªd
(
ş›Á
 *
c
);

1645 
	`d–Commªd
(
ş›Á
 *
c
);

1646 
	`uÆškCommªd
(
ş›Á
 *
c
);

1647 
	`exi¡sCommªd
(
ş›Á
 *
c
);

1648 
	`£tb™Commªd
(
ş›Á
 *
c
);

1649 
	`g‘b™Commªd
(
ş›Á
 *
c
);

1650 
	`b™f›ldCommªd
(
ş›Á
 *
c
);

1651 
	`£ŒªgeCommªd
(
ş›Á
 *
c
);

1652 
	`g‘¿ngeCommªd
(
ş›Á
 *
c
);

1653 
	`šüCommªd
(
ş›Á
 *
c
);

1654 
	`deüCommªd
(
ş›Á
 *
c
);

1655 
	`šübyCommªd
(
ş›Á
 *
c
);

1656 
	`deübyCommªd
(
ş›Á
 *
c
);

1657 
	`šübyæßtCommªd
(
ş›Á
 *
c
);

1658 
	`£ËùCommªd
(
ş›Á
 *
c
);

1659 
	`¿ndomkeyCommªd
(
ş›Á
 *
c
);

1660 
	`keysCommªd
(
ş›Á
 *
c
);

1661 
	`sÿnCommªd
(
ş›Á
 *
c
);

1662 
	`dbsizeCommªd
(
ş›Á
 *
c
);

1663 
	`Ï¡§veCommªd
(
ş›Á
 *
c
);

1664 
	`§veCommªd
(
ş›Á
 *
c
);

1665 
	`bg§veCommªd
(
ş›Á
 *
c
);

1666 
	`bg»wr™—ofCommªd
(
ş›Á
 *
c
);

1667 
	`shutdownCommªd
(
ş›Á
 *
c
);

1668 
	`moveCommªd
(
ş›Á
 *
c
);

1669 
	`»ÇmeCommªd
(
ş›Á
 *
c
);

1670 
	`»Çm’xCommªd
(
ş›Á
 *
c
);

1671 
	`ÍushCommªd
(
ş›Á
 *
c
);

1672 
	`½ushCommªd
(
ş›Á
 *
c
);

1673 
	`ÍushxCommªd
(
ş›Á
 *
c
);

1674 
	`½ushxCommªd
(
ş›Á
 *
c
);

1675 
	`lš£¹Commªd
(
ş›Á
 *
c
);

1676 
	`ÍİCommªd
(
ş›Á
 *
c
);

1677 
	`½İCommªd
(
ş›Á
 *
c
);

1678 
	`Î’Commªd
(
ş›Á
 *
c
);

1679 
	`lšdexCommªd
(
ş›Á
 *
c
);

1680 
	`ÌªgeCommªd
(
ş›Á
 *
c
);

1681 
	`ÉrimCommªd
(
ş›Á
 *
c
);

1682 
	`ty³Commªd
(
ş›Á
 *
c
);

1683 
	`l£tCommªd
(
ş›Á
 *
c
);

1684 
	`§ddCommªd
(
ş›Á
 *
c
);

1685 
	`¤emCommªd
(
ş›Á
 *
c
);

1686 
	`smoveCommªd
(
ş›Á
 *
c
);

1687 
	`sismemb”Commªd
(
ş›Á
 *
c
);

1688 
	`sÿrdCommªd
(
ş›Á
 *
c
);

1689 
	`¥İCommªd
(
ş›Á
 *
c
);

1690 
	`¤ªdmemb”Commªd
(
ş›Á
 *
c
);

1691 
	`sš‹rCommªd
(
ş›Á
 *
c
);

1692 
	`sš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

1693 
	`suniÚCommªd
(
ş›Á
 *
c
);

1694 
	`suniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

1695 
	`sdiffCommªd
(
ş›Á
 *
c
);

1696 
	`sdiff¡ÜeCommªd
(
ş›Á
 *
c
);

1697 
	`ssÿnCommªd
(
ş›Á
 *
c
);

1698 
	`syncCommªd
(
ş›Á
 *
c
);

1699 
	`æushdbCommªd
(
ş›Á
 *
c
);

1700 
	`æush®lCommªd
(
ş›Á
 *
c
);

1701 
	`sÜtCommªd
(
ş›Á
 *
c
);

1702 
	`ÌemCommªd
(
ş›Á
 *
c
);

1703 
	`½İÍushCommªd
(
ş›Á
 *
c
);

1704 
	`šfoCommªd
(
ş›Á
 *
c
);

1705 
	`mg‘Commªd
(
ş›Á
 *
c
);

1706 
	`mÚ™ÜCommªd
(
ş›Á
 *
c
);

1707 
	`expœeCommªd
(
ş›Á
 *
c
);

1708 
	`expœ—tCommªd
(
ş›Á
 *
c
);

1709 
	`³xpœeCommªd
(
ş›Á
 *
c
);

1710 
	`³xpœ—tCommªd
(
ş›Á
 *
c
);

1711 
	`g‘£tCommªd
(
ş›Á
 *
c
);

1712 
	`‰lCommªd
(
ş›Á
 *
c
);

1713 
	`touchCommªd
(
ş›Á
 *
c
);

1714 
	`±Commªd
(
ş›Á
 *
c
);

1715 
	`³rsi¡Commªd
(
ş›Á
 *
c
);

1716 
	`¦aveofCommªd
(
ş›Á
 *
c
);

1717 
	`rŞeCommªd
(
ş›Á
 *
c
);

1718 
	`debugCommªd
(
ş›Á
 *
c
);

1719 
	`m£tCommªd
(
ş›Á
 *
c
);

1720 
	`m£ŠxCommªd
(
ş›Á
 *
c
);

1721 
	`zaddCommªd
(
ş›Á
 *
c
);

1722 
	`zšübyCommªd
(
ş›Á
 *
c
);

1723 
	`z¿ngeCommªd
(
ş›Á
 *
c
);

1724 
	`z¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

1725 
	`z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

1726 
	`z¿ngebyËxCommªd
(
ş›Á
 *
c
);

1727 
	`z»v¿ngebyËxCommªd
(
ş›Á
 *
c
);

1728 
	`zcouÁCommªd
(
ş›Á
 *
c
);

1729 
	`zËxcouÁCommªd
(
ş›Á
 *
c
);

1730 
	`z»v¿ngeCommªd
(
ş›Á
 *
c
);

1731 
	`zÿrdCommªd
(
ş›Á
 *
c
);

1732 
	`z»mCommªd
(
ş›Á
 *
c
);

1733 
	`zscÜeCommªd
(
ş›Á
 *
c
);

1734 
	`z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

1735 
	`z»m¿ngebyËxCommªd
(
ş›Á
 *
c
);

1736 
	`muÉiCommªd
(
ş›Á
 *
c
);

1737 
	`execCommªd
(
ş›Á
 *
c
);

1738 
	`disÿrdCommªd
(
ş›Á
 *
c
);

1739 
	`bÍİCommªd
(
ş›Á
 *
c
);

1740 
	`b½İCommªd
(
ş›Á
 *
c
);

1741 
	`b½İÍushCommªd
(
ş›Á
 *
c
);

1742 
	`­³ndCommªd
(
ş›Á
 *
c
);

1743 
	`¡¾’Commªd
(
ş›Á
 *
c
);

1744 
	`z¿nkCommªd
(
ş›Á
 *
c
);

1745 
	`z»v¿nkCommªd
(
ş›Á
 *
c
);

1746 
	`h£tCommªd
(
ş›Á
 *
c
);

1747 
	`h£ŠxCommªd
(
ş›Á
 *
c
);

1748 
	`hg‘Commªd
(
ş›Á
 *
c
);

1749 
	`hm£tCommªd
(
ş›Á
 *
c
);

1750 
	`hmg‘Commªd
(
ş›Á
 *
c
);

1751 
	`hd–Commªd
(
ş›Á
 *
c
);

1752 
	`hËnCommªd
(
ş›Á
 *
c
);

1753 
	`h¡¾’Commªd
(
ş›Á
 *
c
);

1754 
	`z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
);

1755 
	`zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

1756 
	`zš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

1757 
	`zsÿnCommªd
(
ş›Á
 *
c
);

1758 
	`hkeysCommªd
(
ş›Á
 *
c
);

1759 
	`hv®sCommªd
(
ş›Á
 *
c
);

1760 
	`hg‘®lCommªd
(
ş›Á
 *
c
);

1761 
	`hexi¡sCommªd
(
ş›Á
 *
c
);

1762 
	`hsÿnCommªd
(
ş›Á
 *
c
);

1763 
	`cÚfigCommªd
(
ş›Á
 *
c
);

1764 
	`hšübyCommªd
(
ş›Á
 *
c
);

1765 
	`hšübyæßtCommªd
(
ş›Á
 *
c
);

1766 
	`subsüibeCommªd
(
ş›Á
 *
c
);

1767 
	`unsubsüibeCommªd
(
ş›Á
 *
c
);

1768 
	`psubsüibeCommªd
(
ş›Á
 *
c
);

1769 
	`punsubsüibeCommªd
(
ş›Á
 *
c
);

1770 
	`publishCommªd
(
ş›Á
 *
c
);

1771 
	`pubsubCommªd
(
ş›Á
 *
c
);

1772 
	`w©chCommªd
(
ş›Á
 *
c
);

1773 
	`unw©chCommªd
(
ş›Á
 *
c
);

1774 
	`şu¡”Commªd
(
ş›Á
 *
c
);

1775 
	`»¡ÜeCommªd
(
ş›Á
 *
c
);

1776 
	`mig¿‹Commªd
(
ş›Á
 *
c
);

1777 
	`askšgCommªd
(
ş›Á
 *
c
);

1778 
	`»adÚlyCommªd
(
ş›Á
 *
c
);

1779 
	`»adwr™eCommªd
(
ş›Á
 *
c
);

1780 
	`dumpCommªd
(
ş›Á
 *
c
);

1781 
	`objeùCommªd
(
ş›Á
 *
c
);

1782 
	`ş›ÁCommªd
(
ş›Á
 *
c
);

1783 
	`ev®Commªd
(
ş›Á
 *
c
);

1784 
	`ev®ShaCommªd
(
ş›Á
 *
c
);

1785 
	`sütCommªd
(
ş›Á
 *
c
);

1786 
	`timeCommªd
(
ş›Á
 *
c
);

1787 
	`b™İCommªd
(
ş›Á
 *
c
);

1788 
	`b™couÁCommªd
(
ş›Á
 *
c
);

1789 
	`b™posCommªd
(
ş›Á
 *
c
);

1790 
	`»¶cÚfCommªd
(
ş›Á
 *
c
);

1791 
	`wa™Commªd
(
ş›Á
 *
c
);

1792 
	`geÛncodeCommªd
(
ş›Á
 *
c
);

1793 
	`geodecodeCommªd
(
ş›Á
 *
c
);

1794 
	`geÜadiusByMemb”Commªd
(
ş›Á
 *
c
);

1795 
	`geÜadiusCommªd
(
ş›Á
 *
c
);

1796 
	`geßddCommªd
(
ş›Á
 *
c
);

1797 
	`geohashCommªd
(
ş›Á
 *
c
);

1798 
	`geİosCommªd
(
ş›Á
 *
c
);

1799 
	`geodi¡Commªd
(
ş›Á
 *
c
);

1800 
	`pf£láe¡Commªd
(
ş›Á
 *
c
);

1801 
	`pçddCommªd
(
ş›Á
 *
c
);

1802 
	`pfcouÁCommªd
(
ş›Á
 *
c
);

1803 
	`pfm”geCommªd
(
ş›Á
 *
c
);

1804 
	`pfdebugCommªd
(
ş›Á
 *
c
);

1805 
	`Ï‹ncyCommªd
(
ş›Á
 *
c
);

1806 
	`moduËCommªd
(
ş›Á
 *
c
);

1808 #ià
	`defšed
(
__GNUC__
)

1809 *
	$ÿÎoc
(
size_t
 
couÁ
, size_ˆ
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1810 
	$ä“
(*
±r
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1811 *
	$m®loc
(
size_t
 
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1812 *
	$»®loc
(*
±r
, 
size_t
 
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1816 
	`_£rv”As£¹W™hInfo
(cÚ¡ 
ş›Á
 *
c
, cÚ¡ 
robj
 *
o
, cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
);

1817 
	`_£rv”As£¹
(cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
);

1818 
	`_£rv”Pªic
(cÚ¡ *
msg
, cÚ¡ *
fe
, 
lše
);

1819 
	`bugR•ÜtS¹
();

1820 
	`£rv”LogObjeùDebugInfo
(cÚ¡ 
robj
 *
o
);

1821 
	`sig£gvHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
);

1822 
sds
 
	`g’RedisInfoSŒšg
(*
£ùiÚ
);

1823 
	`’abËW©chdog
(
³riod
);

1824 
	`di§bËW©chdog
();

1825 
	`w©chdogScheduËSigÇl
(
³riod
);

1826 
	`£rv”LogHexDump
(
Ëv–
, *
desü
, *
v®ue
, 
size_t
 
Ën
);

1827 
	`mem‹¡_´e£rvšg_‹¡
(*
m
, 
size_t
 
by‹s
, 
·s£s
);

1829 
	#»disDebug
(
fmt
, ...) \

1830 
	`´štf
("DEBUG %s:%d > " 
fmt
 "\n", 
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

1831 
	#»disDebugM¬k
() \

1832 
	`´štf
("-- MARK %s:%d --\n", 
__FILE__
, 
__LINE__
)

	)

	@setproctitle.c

28 #iâdeà
_GNU_SOURCE


29 
	#_GNU_SOURCE


	)

32 
	~<¡ddef.h
>

33 
	~<¡d¬g.h
>

34 
	~<¡dlib.h
>

35 
	~<¡dio.h
>

37 
	~<¡ršg.h
>

39 
	~<”ºo.h
>

41 #ià!
defšed
(
HAVE_SETPROCTITLE
)

42 
	#HAVE_SETPROCTITLE
 (
defšed
 
__N‘BSD__
 || defšed 
__F»eBSD__
 || defšed 
__O³nBSD__
)

	)

46 #ià!
HAVE_SETPROCTITLE


47 #ià(
defšed
 
__lšux
 || defšed 
__APPLE__
)

49 **
’vœÚ
;

53 cÚ¡ *
	m¬g0
;

56 *
	mba£
, *
	m’d
;

59 *
	mnul
;

61 
_BoŞ
 
	m»£t
;

62 
	m”rÜ
;

63 } 
	gSPT
;

66 #iâdeà
SPT_MIN


67 
	#SPT_MIN
(
a
, 
b
è((×è< (b))? (aè: (b))

	)

70 
šlše
 
size_t
 
	$¥t_mš
(
size_t
 
a
, size_ˆ
b
) {

71  
	`SPT_MIN
(
a
, 
b
);

72 
	}
}

79 
	$¥t_ş—»nv
() {

80 #ià
__GLIBC__


81 
	`ş—»nv
();

85 **
’vœÚ
;

86 **
tmp
;

88 ià(!(
tmp
 = 
	`m®loc
( *tmp)))

89  
”ºo
;

91 
tmp
[0] = 
NULL
;

92 
’vœÚ
 = 
tmp
;

96 
	}
}

99 
	$¥t_cİy’v
(*
Şd’v
[]) {

100 **
’vœÚ
;

101 *
eq
;

102 
i
, 
”rÜ
;

104 ià(
’vœÚ
 !ğ
Şd’v
)

107 ià((
”rÜ
 = 
	`¥t_ş—»nv
()))

108 
”rÜ
;

110 
i
 = 0; 
Şd’v
[i]; i++) {

111 ià(!(
eq
 = 
	`¡rchr
(
Şd’v
[
i
], '=')))

114 *
eq
 = '\0';

115 
”rÜ
 = (0 !ğ
	`£‹nv
(
Şd’v
[
i
], 
eq
 + 1, 1))? 
”ºo
 : 0;

116 *
eq
 = '=';

118 ià(
”rÜ
)

119 
”rÜ
;

123 
”rÜ
:

124 
’vœÚ
 = 
Şd’v
;

126  
”rÜ
;

127 
	}
}

130 
	$¥t_cİy¬gs
(
¬gc
, *
¬gv
[]) {

131 *
tmp
;

132 
i
;

134 
i
 = 1; i < 
¬gc
 || (˜>ğ¬gø&& 
¬gv
[i]); i++) {

135 ià(!
¬gv
[
i
])

138 ià(!(
tmp
 = 
	`¡rdup
(
¬gv
[
i
])))

139  
”ºo
;

141 
¬gv
[
i
] = 
tmp
;

145 
	}
}

148 
	$¥t_š™
(
¬gc
, *
¬gv
[]) {

149 **
’vp
 = 
’vœÚ
;

150 *
ba£
, *
’d
, *
nul
, *
tmp
;

151 
i
, 
”rÜ
;

153 ià(!(
ba£
 = 
¬gv
[0]))

156 
nul
 = &
ba£
[
	`¡¾’
(base)];

157 
’d
 = 
nul
 + 1;

159 
i
 = 0; i < 
¬gc
 || (˜>ğ¬gø&& 
¬gv
[i]); i++) {

160 ià(!
¬gv
[
i
] ||‡rgv[i] < 
’d
)

163 
’d
 = 
¬gv
[
i
] + 
	`¡¾’
(argv[i]) + 1;

166 
i
 = 0; 
’vp
[i]; i++) {

167 ià(
’vp
[
i
] < 
’d
)

170 
’d
 = 
’vp
[
i
] + 
	`¡¾’
(envp[i]) + 1;

173 ià(!(
SPT
.
¬g0
 = 
	`¡rdup
(
¬gv
[0])))

174 
sy”r
;

176 #ià
__GLIBC__


177 ià(!(
tmp
 = 
	`¡rdup
(
´og¿m_švoÿtiÚ_Çme
)))

178 
sy”r
;

180 
´og¿m_švoÿtiÚ_Çme
 = 
tmp
;

182 ià(!(
tmp
 = 
	`¡rdup
(
´og¿m_švoÿtiÚ_shÜt_Çme
)))

183 
sy”r
;

185 
´og¿m_švoÿtiÚ_shÜt_Çme
 = 
tmp
;

186 #–ià
__APPLE__


187 ià(!(
tmp
 = 
	`¡rdup
(
	`g‘´ogÇme
())))

188 
sy”r
;

190 
	`£rogÇme
(
tmp
);

194 ià((
”rÜ
 = 
	`¥t_cİy’v
(
’vp
)))

195 
”rÜ
;

197 ià((
”rÜ
 = 
	`¥t_cİy¬gs
(
¬gc
, 
¬gv
)))

198 
”rÜ
;

200 
SPT
.
nul
 =‚ul;

201 
SPT
.
ba£
 = base;

202 
SPT
.
’d
 =ƒnd;

205 
sy”r
:

206 
”rÜ
 = 
”ºo
;

207 
”rÜ
:

208 
SPT
.
”rÜ
 =ƒrror;

209 
	}
}

212 #iâdeà
SPT_MAXTITLE


213 
	#SPT_MAXTITLE
 255

	)

216 
	$£roù™Ë
(cÚ¡ *
fmt
, ...) {

217 
buf
[
SPT_MAXTITLE
 + 1];

218 
va_li¡
 
­
;

219 *
nul
;

220 
Ën
, 
”rÜ
;

222 ià(!
SPT
.
ba£
)

225 ià(
fmt
) {

226 
	`va_¡¬t
(
­
, 
fmt
);

227 
Ën
 = 
	`v¢´štf
(
buf
,  buf, 
fmt
, 
­
);

228 
	`va_’d
(
­
);

230 
Ën
 = 
	`¢´štf
(
buf
,  buf, "%s", 
SPT
.
¬g0
);

233 ià(
Ën
 <= 0)

234 { 
”rÜ
 = 
”ºo
; error; }

236 ià(!
SPT
.
»£t
) {

237 
	`mem£t
(
SPT
.
ba£
, 0, SPT.
’d
 - SPT.base);

238 
SPT
.
»£t
 = 1;

240 
	`mem£t
(
SPT
.
ba£
, 0, 
	`¥t_mš
( 
buf
, SPT.
’d
 - SPT.base));

243 
Ën
 = 
	`¥t_mš
Ö’, s±_mš( 
buf
, 
SPT
.
’d
 - SPT.
ba£
) - 1);

244 
	`memıy
(
SPT
.
ba£
, 
buf
, 
Ën
);

245 
nul
 = &
SPT
.
ba£
[
Ën
];

247 ià(
nul
 < 
SPT
.nul) {

248 *
SPT
.
nul
 = '.';

249 } ià(
nul
 =ğ
SPT
.nuÈ&& &nul[1] < SPT.
’d
) {

250 *
SPT
.
nul
 = ' ';

251 *++
nul
 = '\0';

255 
”rÜ
:

256 
SPT
.
”rÜ
 =ƒrror;

257 
	}
}

	@sha1.c

22 
	#SHA1HANDSOFF


	)

24 
	~<¡dio.h
>

25 
	~<¡ršg.h
>

26 
	~<¡dšt.h
>

27 
	~"sŞ¬isfixes.h
"

28 
	~"sha1.h
"

29 
	~"cÚfig.h
"

31 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

35 #ià
BYTE_ORDER
 =ğ
LITTLE_ENDIAN


36 
	#blk0
(
i
è(
block
->
l
[i] = (
	`rŞ
(block->l[i],24)&0xFF00FF00) \

37 |(
	`rŞ
(
block
->
l
[
i
],8)&0x00FF00FF))

	)

38 #–ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


39 
	#blk0
(
i
è
block
->
l
[i]

	)

43 
	#blk
(
i
è(
block
->
l
[i&15] = 
	`rŞ
(block->l[(i+13)&15]^block->l[(i+8)&15] \

44 ^
block
->
l
[(
i
+2)&15]^block->l[i&15],1))

	)

47 
	#R0
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk0
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

48 
	#R1
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

49 
	#R2
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0x6ED9EBA1+
	`rŞ
(v,5);wôŞ(w,30);

	)

50 
	#R3
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(((w|x)&y)|(w&x))+
	`blk
(i)+0x8F1BBCDC+
	`rŞ
(v,5);wôŞ(w,30);

	)

51 
	#R4
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0xCA62C1D6+
	`rŞ
(v,5);wôŞ(w,30);

	)

56 
	$SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64])

58 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

60 
c
[64];

61 
ušt32_t
 
l
[16];

62 } 
	tCHAR64LONG16
;

63 #ifdeà
SHA1HANDSOFF


64 
CHAR64LONG16
 
block
[1];

65 
	`memıy
(
block
, 
bufãr
, 64);

72 
CHAR64LONG16
* 
block
 = (cÚ¡ CHAR64LONG16*)
bufãr
;

75 
a
 = 
¡©e
[0];

76 
b
 = 
¡©e
[1];

77 
c
 = 
¡©e
[2];

78 
d
 = 
¡©e
[3];

79 
e
 = 
¡©e
[4];

81 
	`R0
(
a
,
b
,
c
,
d
,
e
, 0); R0(e,a,b,c,d, 1); R0(d,e,a,b,c, 2); R0(c,d,e,a,b, 3);

82 
	`R0
(
b
,
c
,
d
,
e
,
a
, 4); R0(a,b,c,d,e, 5); R0(e,a,b,c,d, 6); R0(d,e,a,b,c, 7);

83 
	`R0
(
c
,
d
,
e
,
a
,
b
, 8); R0(b,c,d,e,a, 9); R0(a,b,c,d,e,10); R0(e,a,b,c,d,11);

84 
	`R0
(
d
,
e
,
a
,
b
,
c
,12); R0(c,d,e,a,b,13); R0(b,c,d,e,a,14); R0(a,b,c,d,e,15);

85 
	`R1
(
e
,
a
,
b
,
c
,
d
,16); R1(d,e,a,b,c,17); R1(c,d,e,a,b,18); R1(b,c,d,e,a,19);

86 
	`R2
(
a
,
b
,
c
,
d
,
e
,20); R2(e,a,b,c,d,21); R2(d,e,a,b,c,22); R2(c,d,e,a,b,23);

87 
	`R2
(
b
,
c
,
d
,
e
,
a
,24); R2(a,b,c,d,e,25); R2(e,a,b,c,d,26); R2(d,e,a,b,c,27);

88 
	`R2
(
c
,
d
,
e
,
a
,
b
,28); R2(b,c,d,e,a,29); R2(a,b,c,d,e,30); R2(e,a,b,c,d,31);

89 
	`R2
(
d
,
e
,
a
,
b
,
c
,32); R2(c,d,e,a,b,33); R2(b,c,d,e,a,34); R2(a,b,c,d,e,35);

90 
	`R2
(
e
,
a
,
b
,
c
,
d
,36); R2(d,e,a,b,c,37); R2(c,d,e,a,b,38); R2(b,c,d,e,a,39);

91 
	`R3
(
a
,
b
,
c
,
d
,
e
,40); R3(e,a,b,c,d,41); R3(d,e,a,b,c,42); R3(c,d,e,a,b,43);

92 
	`R3
(
b
,
c
,
d
,
e
,
a
,44); R3(a,b,c,d,e,45); R3(e,a,b,c,d,46); R3(d,e,a,b,c,47);

93 
	`R3
(
c
,
d
,
e
,
a
,
b
,48); R3(b,c,d,e,a,49); R3(a,b,c,d,e,50); R3(e,a,b,c,d,51);

94 
	`R3
(
d
,
e
,
a
,
b
,
c
,52); R3(c,d,e,a,b,53); R3(b,c,d,e,a,54); R3(a,b,c,d,e,55);

95 
	`R3
(
e
,
a
,
b
,
c
,
d
,56); R3(d,e,a,b,c,57); R3(c,d,e,a,b,58); R3(b,c,d,e,a,59);

96 
	`R4
(
a
,
b
,
c
,
d
,
e
,60); R4(e,a,b,c,d,61); R4(d,e,a,b,c,62); R4(c,d,e,a,b,63);

97 
	`R4
(
b
,
c
,
d
,
e
,
a
,64); R4(a,b,c,d,e,65); R4(e,a,b,c,d,66); R4(d,e,a,b,c,67);

98 
	`R4
(
c
,
d
,
e
,
a
,
b
,68); R4(b,c,d,e,a,69); R4(a,b,c,d,e,70); R4(e,a,b,c,d,71);

99 
	`R4
(
d
,
e
,
a
,
b
,
c
,72); R4(c,d,e,a,b,73); R4(b,c,d,e,a,74); R4(a,b,c,d,e,75);

100 
	`R4
(
e
,
a
,
b
,
c
,
d
,76); R4(d,e,a,b,c,77); R4(c,d,e,a,b,78); R4(b,c,d,e,a,79);

102 
¡©e
[0] +ğ
a
;

103 
¡©e
[1] +ğ
b
;

104 
¡©e
[2] +ğ
c
;

105 
¡©e
[3] +ğ
d
;

106 
¡©e
[4] +ğ
e
;

108 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

109 #ifdeà
SHA1HANDSOFF


110 
	`mem£t
(
block
, '\0', (block));

112 
	}
}

117 
	$SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
)

120 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

121 
cÚ‹xt
->
¡©e
[1] = 0xEFCDAB89;

122 
cÚ‹xt
->
¡©e
[2] = 0x98BADCFE;

123 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

124 
cÚ‹xt
->
¡©e
[4] = 0xC3D2E1F0;

125 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

126 
	}
}

131 
	$SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
)

133 
ušt32_t
 
i
, 
j
;

135 
j
 = 
cÚ‹xt
->
couÁ
[0];

136 ià((
cÚ‹xt
->
couÁ
[0] +ğ
Ën
 << 3è< 
j
)

137 
cÚ‹xt
->
couÁ
[1]++;

138 
cÚ‹xt
->
couÁ
[1] +ğ(
Ën
>>29);

139 
j
 = (j >> 3) & 63;

140 ià((
j
 + 
Ën
) > 63) {

141 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64-j));

142 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

143  ; 
i
 + 63 < 
Ën
; i += 64) {

144 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, &
d©a
[
i
]);

146 
j
 = 0;

148 
i
 = 0;

149 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

150 
	}
}

155 
	$SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
)

157 
i
;

158 
fš®couÁ
[8];

159 
c
;

167 *
fı
 = &
fš®couÁ
[8];

169 
i
 = 0; i < 2; i++)

171 
ušt32_t
 
t
 = 
cÚ‹xt
->
couÁ
[
i
];

172 
j
;

174 
j
 = 0; j < 4; 
t
 >>= 8, j++)

175 *--
fı
 = (è
t
;

178 
i
 = 0; i < 8; i++) {

179 
fš®couÁ
[
i
] = ()((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)]

180 >> ((3-(
i
 & 3)) * 8) ) & 255);

183 
c
 = 0200;

184 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

185 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

186 
c
 = 0000;

187 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

189 
	`SHA1Upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

190 
i
 = 0; i < 20; i++) {

191 
dige¡
[
i
] = ()

192 ((
cÚ‹xt
->
¡©e
[
i
>>2] >> ((3-(i & 3)) * 8) ) & 255);

195 
	`mem£t
(
cÚ‹xt
, '\0', (*context));

196 
	`mem£t
(&
fš®couÁ
, '\0', (finalcount));

197 
	}
}

200 #ifdeà
REDIS_TEST


201 
	#BUFSIZE
 4096

	)

203 
	#UNUSED
(
x
è()(x)

	)

204 
	$sha1Te¡
(
¬gc
, **
¬gv
)

206 
SHA1_CTX
 
ùx
;

207 
hash
[20], 
buf
[
BUFSIZE
];

208 
i
;

210 
	`UNUSED
(
¬gc
);

211 
	`UNUSED
(
¬gv
);

213 
i
=0;i<
BUFSIZE
;i++)

214 
buf
[
i
] = i;

216 
	`SHA1In™
(&
ùx
);

217 
i
=0;i<1000;i++)

218 
	`SHA1Upd©e
(&
ùx
, 
buf
, 
BUFSIZE
);

219 
	`SHA1Fš®
(
hash
, &
ùx
);

221 
	`´štf
("SHA1=");

222 
i
=0;i<20;i++)

223 
	`´štf
("%02x", 
hash
[
i
]);

224 
	`´štf
("\n");

226 
	}
}

	@sha1.h

1 #iâdeà
SHA1_H


2 
	#SHA1_H


	)

11 
ušt32_t
 
	m¡©e
[5];

12 
ušt32_t
 
	mcouÁ
[2];

13 
	mbufãr
[64];

14 } 
	tSHA1_CTX
;

16 
SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64]);

17 
SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
);

18 
SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
);

19 
SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
);

21 #ifdeà
REDIS_TEST


22 
sha1Te¡
(
¬gc
, **
¬gv
);

	@slowlog.c

42 
	~"£rv”.h
"

43 
	~"¦owlog.h
"

48 
¦owlogEÁry
 *
	$¦owlogC»©eEÁry
(
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

49 
¦owlogEÁry
 *
£
 = 
	`zm®loc
((*se));

50 
j
, 
¦¬gc
 = 
¬gc
;

52 ià(
¦¬gc
 > 
SLOWLOG_ENTRY_MAX_ARGC
) slargc = SLOWLOG_ENTRY_MAX_ARGC;

53 
£
->
¬gc
 = 
¦¬gc
;

54 
£
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¦¬gc
);

55 
j
 = 0; j < 
¦¬gc
; j++) {

59 ià(
¦¬gc
 !ğ
¬gc
 && 
j
 == slargc-1) {

60 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

61 
	`sdsÿrštf
(
	`sd£m±y
(),"... (%d more‡rguments)",

62 
¬gc
-
¦¬gc
+1));

65 ià(
¬gv
[
j
]->
ty³
 =ğ
OBJ_STRING
 &&

66 
	`sdsEncodedObjeù
(
¬gv
[
j
]) &&

67 
	`sd¦’
(
¬gv
[
j
]->
±r
è> 
SLOWLOG_ENTRY_MAX_STRING
)

69 
sds
 
s
 = 
	`sd¢ewËn
(
¬gv
[
j
]->
±r
, 
SLOWLOG_ENTRY_MAX_STRING
);

71 
s
 = 
	`sdsÿrštf
(s,"... (%lu more bytes)",

73 
	`sd¦’
(
¬gv
[
j
]->
±r
è- 
SLOWLOG_ENTRY_MAX_STRING
);

74 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

76 
£
->
¬gv
[
j
] =‡rgv[j];

77 
	`šüRefCouÁ
(
¬gv
[
j
]);

81 
£
->
time
 = 
	`time
(
NULL
);

82 
£
->
du¿tiÚ
 = duration;

83 
£
->
id
 = 
£rv”
.
¦owlog_’Œy_id
++;

84  
£
;

85 
	}
}

91 
	$¦owlogF»eEÁry
(*
£±r
) {

92 
¦owlogEÁry
 *
£
 = 
£±r
;

93 
j
;

95 
j
 = 0; j < 
£
->
¬gc
; j++)

96 
	`deüRefCouÁ
(
£
->
¬gv
[
j
]);

97 
	`zä“
(
£
->
¬gv
);

98 
	`zä“
(
£
);

99 
	}
}

103 
	$¦owlogIn™
() {

104 
£rv”
.
¦owlog
 = 
	`li¡C»©e
();

105 
£rv”
.
¦owlog_’Œy_id
 = 0;

106 
	`li¡S‘F»eM‘hod
(
£rv”
.
¦owlog
,
¦owlogF»eEÁry
);

107 
	}
}

112 
	$¦owlogPushEÁryIfN“ded
(
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

113 ià(
£rv”
.
¦owlog_log_¦ow”_thª
 < 0) ;

114 ià(
du¿tiÚ
 >ğ
£rv”
.
¦owlog_log_¦ow”_thª
)

115 
	`li¡AddNodeH—d
(
£rv”
.
¦owlog
,
	`¦owlogC»©eEÁry
(
¬gv
,
¬gc
,
du¿tiÚ
));

118 
	`li¡L’gth
(
£rv”
.
¦owlog
è> s”v”.
¦owlog_max_Ën
)

119 
	`li¡D–Node
(
£rv”
.
¦owlog
,
	`li¡La¡
(server.slowlog));

120 
	}
}

123 
	$¦owlogRe£t
() {

124 
	`li¡L’gth
(
£rv”
.
¦owlog
) > 0)

125 
	`li¡D–Node
(
£rv”
.
¦owlog
,
	`li¡La¡
(server.slowlog));

126 
	}
}

130 
	$¦owlogCommªd
(
ş›Á
 *
c
) {

131 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"reset")) {

132 
	`¦owlogRe£t
();

133 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

134 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"len")) {

135 
	`addR•lyLÚgLÚg
(
c
,
	`li¡L’gth
(
£rv”
.
¦owlog
));

136 } ià((
c
->
¬gc
 == 2 || c->argc == 3) &&

137 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get"))

139 
couÁ
 = 10, 
£Á
 = 0;

140 
li¡I‹r
 
li
;

141 *
tÙ’Œ›s
;

142 
li¡Node
 *
Ê
;

143 
¦owlogEÁry
 *
£
;

145 ià(
c
->
¬gc
 == 3 &&

146 
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
couÁ
,
NULL
è!ğ
C_OK
)

149 
	`li¡Rewšd
(
£rv”
.
¦owlog
,&
li
);

150 
tÙ’Œ›s
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

151 
couÁ
-- && (
Ê
 = 
	`li¡Next
(&
li
))) {

152 
j
;

154 
£
 = 
Ê
->
v®ue
;

155 
	`addR•lyMuÉiBulkL’
(
c
,4);

156 
	`addR•lyLÚgLÚg
(
c
,
£
->
id
);

157 
	`addR•lyLÚgLÚg
(
c
,
£
->
time
);

158 
	`addR•lyLÚgLÚg
(
c
,
£
->
du¿tiÚ
);

159 
	`addR•lyMuÉiBulkL’
(
c
,
£
->
¬gc
);

160 
j
 = 0; j < 
£
->
¬gc
; j++)

161 
	`addR•lyBulk
(
c
,
£
->
¬gv
[
j
]);

162 
£Á
++;

164 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
tÙ’Œ›s
,
£Á
);

166 
	`addR•lyE¼Ü
(
c
,

169 
	}
}

	@slowlog.h

30 
	#SLOWLOG_ENTRY_MAX_ARGC
 32

	)

31 
	#SLOWLOG_ENTRY_MAX_STRING
 128

	)

34 
	s¦owlogEÁry
 {

35 
robj
 **
	m¬gv
;

36 
	m¬gc
;

37 
	mid
;

38 
	mdu¿tiÚ
;

39 
time_t
 
	mtime
;

40 } 
	t¦owlogEÁry
;

43 
¦owlogIn™
();

44 
¦owlogPushEÁryIfN“ded
(
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
);

47 
¦owlogCommªd
(
ş›Á
 *
c
);

	@solarisfixes.h

31 #ià
defšed
(
__sun
)

33 #ià
defšed
(
__GNUC__
)

34 
	~<m©h.h
>

35 #undeà
i¢ª


36 
	#i¢ª
(
x
) \

37 
	`__ex‹nsiÚ__
({ 
	`__ty³of
 (
x
è
__x_a
 = (x); \

38 
	`__butš_ex³ù
(
__x_a
 !ğ__x_a, 0); })

	)

40 #undeà
isfš™e


41 
	#isfš™e
(
x
) \

42 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_f
 = (x); \

43 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_f
 - __x_f), 1); })

	)

45 #undeà
isšf


46 
	#isšf
(
x
) \

47 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_i
 = (x); \

48 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_i
è&& !
	`isfš™e
(__x_i), 0); })

	)

50 
	#u_št
 
ušt


	)

51 
	#u_št32_t
 
ušt32_t


	)

	@sort.c

32 
	~"£rv”.h
"

33 
	~"pqsÜt.h
"

34 
	~<m©h.h
>

36 
zskli¡Node
* 
z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
);

38 
»disSÜtO³¿tiÚ
 *
	$ü—‹SÜtO³¿tiÚ
(
ty³
, 
robj
 *
·‰”n
) {

39 
»disSÜtO³¿tiÚ
 *
so
 = 
	`zm®loc
((*so));

40 
so
->
ty³
 =ype;

41 
so
->
·‰”n
 =…attern;

42  
so
;

43 
	}
}

61 
robj
 *
	$lookupKeyByP©‹º
(
»disDb
 *
db
, 
robj
 *
·‰”n
,„obj *
sub¡
) {

62 *
p
, *
f
, *
k
;

63 
sds
 
¥©
, 
ssub
;

64 
robj
 *
keyobj
, *
f›ldobj
 = 
NULL
, *
o
;

65 
´efixËn
, 
subËn
, 
po¡fixËn
, 
f›ldËn
;

69 
¥©
 = 
·‰”n
->
±r
;

70 ià(
¥©
[0] == '#' && spat[1] == '\0') {

71 
	`šüRefCouÁ
(
sub¡
);

72  
sub¡
;

78 
sub¡
 = 
	`g‘DecodedObjeù
(subst);

79 
ssub
 = 
sub¡
->
±r
;

83 
p
 = 
	`¡rchr
(
¥©
,'*');

84 ià(!
p
) {

85 
	`deüRefCouÁ
(
sub¡
);

86  
NULL
;

90 ià((
f
 = 
	`¡r¡r
(
p
+1, "->")è!ğ
NULL
 && *(f+2) != '\0') {

91 
f›ldËn
 = 
	`sd¦’
(
¥©
)-(
f
-spat)-2;

92 
f›ldobj
 = 
	`ü—‹SŒšgObjeù
(
f
+2,
f›ldËn
);

94 
f›ldËn
 = 0;

98 
´efixËn
 = 
p
-
¥©
;

99 
subËn
 = 
	`sd¦’
(
ssub
);

100 
po¡fixËn
 = 
	`sd¦’
(
¥©
)-(
´efixËn
+1)-(
f›ldËn
 ? fieldlen+2 : 0);

101 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
NULL
,
´efixËn
+
subËn
+
po¡fixËn
);

102 
k
 = 
keyobj
->
±r
;

103 
	`memıy
(
k
,
¥©
,
´efixËn
);

104 
	`memıy
(
k
+
´efixËn
,
ssub
,
subËn
);

105 
	`memıy
(
k
+
´efixËn
+
subËn
,
p
+1,
po¡fixËn
);

106 
	`deüRefCouÁ
(
sub¡
);

109 
o
 = 
	`lookupKeyR—d
(
db
,
keyobj
);

110 ià(
o
 =ğ
NULL
è
noobj
;

112 ià(
f›ldobj
) {

113 ià(
o
->
ty³
 !ğ
OBJ_HASH
è
noobj
;

117 
o
 = 
	`hashTy³G‘V®ueObjeù
(o, 
f›ldobj
->
±r
);

119 ià(
o
->
ty³
 !ğ
OBJ_STRING
è
noobj
;

123 
	`šüRefCouÁ
(
o
);

125 
	`deüRefCouÁ
(
keyobj
);

126 ià(
f›ldobj
è
	`deüRefCouÁ
(fieldobj);

127  
o
;

129 
noobj
:

130 
	`deüRefCouÁ
(
keyobj
);

131 ià(
f›ldËn
è
	`deüRefCouÁ
(
f›ldobj
);

132  
NULL
;

133 
	}
}

138 
	$sÜtCom·»
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

139 cÚ¡ 
»disSÜtObjeù
 *
so1
 = 
s1
, *
so2
 = 
s2
;

140 
cmp
;

142 ià(!
£rv”
.
sÜt_®pha
) {

144 ià(
so1
->
u
.
scÜe
 > 
so2
->u.score) {

145 
cmp
 = 1;

146 } ià(
so1
->
u
.
scÜe
 < 
so2
->u.score) {

147 
cmp
 = -1;

152 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

156 ià(
£rv”
.
sÜt_by·‰”n
) {

157 ià(!
so1
->
u
.
cmpobj
 || !
so2
->u.cmpobj) {

159 ià(
so1
->
u
.
cmpobj
 =ğ
so2
->u.cmpobj)

160 
cmp
 = 0;

161 ià(
so1
->
u
.
cmpobj
 =ğ
NULL
)

162 
cmp
 = -1;

164 
cmp
 = 1;

167 ià(
£rv”
.
sÜt_¡Üe
) {

168 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
u
.
cmpobj
,
so2
->u.cmpobj);

172 
cmp
 = 
	`¡rcŞl
(
so1
->
u
.
cmpobj
->
±r
,
so2
->u.cmpobj->ptr);

177 ià(
£rv”
.
sÜt_¡Üe
) {

178 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

180 
cmp
 = 
	`cŞÏ‹SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

184  
£rv”
.
sÜt_desc
 ? -
cmp
 : cmp;

185 
	}
}

189 
	$sÜtCommªd
(
ş›Á
 *
c
) {

190 
li¡
 *
İ”©iÚs
;

191 
ouu’
 = 0;

192 
desc
 = 0, 
®pha
 = 0;

193 
lim™_¡¬t
 = 0, 
lim™_couÁ
 = -1, 
¡¬t
, 
’d
;

194 
j
, 
dÚtsÜt
 = 0, 
veùÜËn
;

195 
g‘İ
 = 0;

196 
št_cÚv”tiÚ_”rÜ
 = 0;

197 
syÁax_”rÜ
 = 0;

198 
robj
 *
sÜtv®
, *
sÜtby
 = 
NULL
, *
¡Üekey
 = NULL;

199 
»disSÜtObjeù
 *
veùÜ
;

202 
sÜtv®
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

203 ià(
sÜtv®
 && sÜtv®->
ty³
 !ğ
OBJ_SET
 &&

204 
sÜtv®
->
ty³
 !ğ
OBJ_LIST
 &&

205 
sÜtv®
->
ty³
 !ğ
OBJ_ZSET
)

207 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

213 
İ”©iÚs
 = 
	`li¡C»©e
();

214 
	`li¡S‘F»eM‘hod
(
İ”©iÚs
,
zä“
);

215 
j
 = 2;

220 ià(
sÜtv®
)

221 
	`šüRefCouÁ
(
sÜtv®
);

223 
sÜtv®
 = 
	`ü—‹Quickli¡Objeù
();

226 
j
 < 
c
->
¬gc
) {

227 
Ëá¬gs
 = 
c
->
¬gc
-
j
-1;

228 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"asc")) {

229 
desc
 = 0;

230 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"desc")) {

231 
desc
 = 1;

232 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"alpha")) {

233 
®pha
 = 1;

234 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"lim™"è&& 
Ëá¬gs
 >= 2) {

235 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
j
+1], &
lim™_¡¬t
, 
NULL
)

236 !ğ
C_OK
) ||

237 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
j
+2], &
lim™_couÁ
, 
NULL
)

238 !ğ
C_OK
))

240 
syÁax_”rÜ
++;

243 
j
+=2;

244 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"¡Üe"è&& 
Ëá¬gs
 >= 1) {

245 
¡Üekey
 = 
c
->
¬gv
[
j
+1];

246 
j
++;

247 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"by"è&& 
Ëá¬gs
 >= 1) {

248 
sÜtby
 = 
c
->
¬gv
[
j
+1];

251 ià(
	`¡rchr
(
c
->
¬gv
[
j
+1]->
±r
,'*'è=ğ
NULL
) {

252 
dÚtsÜt
 = 1;

256 ià(
£rv”
.
şu¡”_’abËd
) {

257 
	`addR•lyE¼Ü
(
c
,"BY option of SORT denied in Cluster mode.");

258 
syÁax_”rÜ
++;

262 
j
++;

263 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"g‘"è&& 
Ëá¬gs
 >= 1) {

264 ià(
£rv”
.
şu¡”_’abËd
) {

265 
	`addR•lyE¼Ü
(
c
,"GET option of SORT denied in Cluster mode.");

266 
syÁax_”rÜ
++;

269 
	`li¡AddNodeTa
(
İ”©iÚs
,
	`ü—‹SÜtO³¿tiÚ
(

270 
SORT_OP_GET
,
c
->
¬gv
[
j
+1]));

271 
g‘İ
++;

272 
j
++;

274 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

275 
syÁax_”rÜ
++;

278 
j
++;

282 ià(
syÁax_”rÜ
) {

283 
	`deüRefCouÁ
(
sÜtv®
);

284 
	`li¡R–—£
(
İ”©iÚs
);

294 ià(
dÚtsÜt
 &&

295 
sÜtv®
->
ty³
 =ğ
OBJ_SET
 &&

296 (
¡Üekey
 || 
c
->
æags
 & 
CLIENT_LUA
))

299 
dÚtsÜt
 = 0;

300 
®pha
 = 1;

301 
sÜtby
 = 
NULL
;

305 ià(
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
)

306 
	`z£tCÚv”t
(
sÜtv®
, 
OBJ_ENCODING_SKIPLIST
);

309 
sÜtv®
->
ty³
) {

310 
OBJ_LIST
: 
veùÜËn
 = 
	`li¡Ty³L’gth
(
sÜtv®
); ;

311 
OBJ_SET
: 
veùÜËn
 = 
	`£tTy³Size
(
sÜtv®
); ;

312 
OBJ_ZSET
: 
veùÜËn
 = 
	`diùSize
(((
z£t
*)
sÜtv®
->
±r
)->
diù
); ;

313 : 
veùÜËn
 = 0; 
	`£rv”Pªic
("Bad SORType");

317 
¡¬t
 = (
lim™_¡¬t
 < 0) ? 0 :†imit_start;

318 
’d
 = (
lim™_couÁ
 < 0è? 
veùÜËn
-1 : 
¡¬t
+limit_count-1;

319 ià(
¡¬t
 >ğ
veùÜËn
) {

320 
¡¬t
 = 
veùÜËn
-1;

321 
’d
 = 
veùÜËn
-2;

323 ià(
’d
 >ğ
veùÜËn
)ƒnd = vectorlen-1;

335 ià((
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
 || sÜtv®->ty³ =ğ
OBJ_LIST
) &&

336 
dÚtsÜt
 &&

337 (
¡¬t
 !ğ0 || 
’d
 !ğ
veùÜËn
-1))

339 
veùÜËn
 = 
’d
-
¡¬t
+1;

343 
veùÜ
 = 
	`zm®loc
((
»disSÜtObjeù
)*
veùÜËn
);

344 
j
 = 0;

346 ià(
sÜtv®
->
ty³
 =ğ
OBJ_LIST
 && 
dÚtsÜt
) {

353 ià(
’d
 >ğ
¡¬t
) {

354 
li¡Ty³I‹¿tÜ
 *
li
;

355 
li¡Ty³EÁry
 
’Œy
;

356 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
sÜtv®
,

357 
desc
 ? ()(
	`li¡Ty³L’gth
(
sÜtv®
è- 
¡¬t
 - 1) : start,

358 
desc
 ? 
LIST_HEAD
 : 
LIST_TAIL
);

360 
j
 < 
veùÜËn
 && 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

361 
veùÜ
[
j
].
obj
 = 
	`li¡Ty³G‘
(&
’Œy
);

362 
veùÜ
[
j
].
u
.
scÜe
 = 0;

363 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

364 
j
++;

366 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

368 
’d
 -ğ
¡¬t
;

369 
¡¬t
 = 0;

371 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_LIST
) {

372 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
sÜtv®
,0,
LIST_TAIL
);

373 
li¡Ty³EÁry
 
’Œy
;

374 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

375 
veùÜ
[
j
].
obj
 = 
	`li¡Ty³G‘
(&
’Œy
);

376 
veùÜ
[
j
].
u
.
scÜe
 = 0;

377 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

378 
j
++;

380 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

381 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_SET
) {

382 
£tTy³I‹¿tÜ
 *
si
 = 
	`£tTy³In™I‹¿tÜ
(
sÜtv®
);

383 
sds
 
sd£Ë
;

384 (
sd£Ë
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

385 
veùÜ
[
j
].
obj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
sd£Ë
);

386 
veùÜ
[
j
].
u
.
scÜe
 = 0;

387 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

388 
j
++;

390 
	`£tTy³R–—£I‹¿tÜ
(
si
);

391 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
 && 
dÚtsÜt
) {

399 
z£t
 *
zs
 = 
sÜtv®
->
±r
;

400 
zskli¡
 *
z¦
 = 
zs
->zsl;

401 
zskli¡Node
 *
Ê
;

402 
sds
 
sd£Ë
;

403 
¿ng–’
 = 
veùÜËn
;

406 ià(
desc
) {

407 
z£’
 = 
	`diùSize
(((
z£t
*)
sÜtv®
->
±r
)->
diù
);

409 
Ê
 = 
z¦
->

;

410 ià(
¡¬t
 > 0)

411 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
z£’
-
¡¬t
);

413 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

414 ià(
¡¬t
 > 0)

415 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

418 
¿ng–’
--) {

419 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
Ê
 !ğ
NULL
);

420 
sd£Ë
 = 
Ê
->
–e
;

421 
veùÜ
[
j
].
obj
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

422 
veùÜ
[
j
].
u
.
scÜe
 = 0;

423 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

424 
j
++;

425 
Ê
 = 
desc
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

428 
’d
 -ğ
¡¬t
;

429 
¡¬t
 = 0;

430 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
) {

431 
diù
 *
£t
 = ((
z£t
*)
sÜtv®
->
±r
)->dict;

432 
diùI‹¿tÜ
 *
di
;

433 
diùEÁry
 *
£‹Ë
;

434 
sds
 
sd£Ë
;

435 
di
 = 
	`diùG‘I‹¿tÜ
(
£t
);

436 (
£‹Ë
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

437 
sd£Ë
 = 
	`diùG‘Key
(
£‹Ë
);

438 
veùÜ
[
j
].
obj
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

439 
veùÜ
[
j
].
u
.
scÜe
 = 0;

440 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

441 
j
++;

443 
	`diùR–—£I‹¿tÜ
(
di
);

445 
	`£rv”Pªic
("Unknownype");

447 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
j
 =ğ
veùÜËn
);

450 ià(
dÚtsÜt
 == 0) {

451 
j
 = 0; j < 
veùÜËn
; j++) {

452 
robj
 *
byv®
;

453 ià(
sÜtby
) {

455 
byv®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sÜtby
,
veùÜ
[
j
].
obj
);

456 ià(!
byv®
) ;

459 
byv®
 = 
veùÜ
[
j
].
obj
;

462 ià(
®pha
) {

463 ià(
sÜtby
è
veùÜ
[
j
].
u
.
cmpobj
 = 
	`g‘DecodedObjeù
(
byv®
);

465 ià(
	`sdsEncodedObjeù
(
byv®
)) {

466 *
•Œ
;

468 
veùÜ
[
j
].
u
.
scÜe
 = 
	`¡¹od
(
byv®
->
±r
,&
•Œ
);

469 ià(
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
 ||

470 
	`i¢ª
(
veùÜ
[
j
].
u
.
scÜe
))

472 
št_cÚv”tiÚ_”rÜ
 = 1;

474 } ià(
byv®
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

478 
veùÜ
[
j
].
u
.
scÜe
 = ()
byv®
->
±r
;

480 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,1 != 1);

486 ià(
sÜtby
) {

487 
	`deüRefCouÁ
(
byv®
);

492 ià(
dÚtsÜt
 == 0) {

493 
£rv”
.
sÜt_desc
 = 
desc
;

494 
£rv”
.
sÜt_®pha
 = 
®pha
;

495 
£rv”
.
sÜt_by·‰”n
 = 
sÜtby
 ? 1 : 0;

496 
£rv”
.
sÜt_¡Üe
 = 
¡Üekey
 ? 1 : 0;

497 ià(
sÜtby
 && (
¡¬t
 !ğ0 || 
’d
 !ğ
veùÜËn
-1))

498 
	`pqsÜt
(
veùÜ
,
veùÜËn
,(
»disSÜtObjeù
),
sÜtCom·»
, 
¡¬t
,
’d
);

500 
	`qsÜt
(
veùÜ
,
veùÜËn
,(
»disSÜtObjeù
),
sÜtCom·»
);

505 
ouu’
 = 
g‘İ
 ? g‘İ*(
’d
-
¡¬t
+1) :ƒnd-start+1;

506 ià(
št_cÚv”tiÚ_”rÜ
) {

507 
	`addR•lyE¼Ü
(
c
,"One or more scores can't be converted into double");

508 } ià(
¡Üekey
 =ğ
NULL
) {

510 
	`addR•lyMuÉiBulkL’
(
c
,
ouu’
);

511 
j
 = 
¡¬t
; j <ğ
’d
; j++) {

512 
li¡Node
 *
Ê
;

513 
li¡I‹r
 
li
;

515 ià(!
g‘İ
è
	`addR•lyBulk
(
c
,
veùÜ
[
j
].
obj
);

516 
	`li¡Rewšd
(
İ”©iÚs
,&
li
);

517 (
Ê
 = 
	`li¡Next
(&
li
))) {

518 
»disSÜtO³¿tiÚ
 *
sİ
 = 
Ê
->
v®ue
;

519 
robj
 *
v®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sİ
->
·‰”n
,

520 
veùÜ
[
j
].
obj
);

522 ià(
sİ
->
ty³
 =ğ
SORT_OP_GET
) {

523 ià(!
v®
) {

524 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

526 
	`addR•lyBulk
(
c
,
v®
);

527 
	`deüRefCouÁ
(
v®
);

531 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
sİ
->
ty³
 =ğ
SORT_OP_GET
);

536 
robj
 *
sobj
 = 
	`ü—‹Quickli¡Objeù
();

539 
j
 = 
¡¬t
; j <ğ
’d
; j++) {

540 
li¡Node
 *
Ê
;

541 
li¡I‹r
 
li
;

543 ià(!
g‘İ
) {

544 
	`li¡Ty³Push
(
sobj
,
veùÜ
[
j
].
obj
,
LIST_TAIL
);

546 
	`li¡Rewšd
(
İ”©iÚs
,&
li
);

547 (
Ê
 = 
	`li¡Next
(&
li
))) {

548 
»disSÜtO³¿tiÚ
 *
sİ
 = 
Ê
->
v®ue
;

549 
robj
 *
v®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sİ
->
·‰”n
,

550 
veùÜ
[
j
].
obj
);

552 ià(
sİ
->
ty³
 =ğ
SORT_OP_GET
) {

553 ià(!
v®
èv® = 
	`ü—‹SŒšgObjeù
("",0);

558 
	`li¡Ty³Push
(
sobj
,
v®
,
LIST_TAIL
);

559 
	`deüRefCouÁ
(
v®
);

562 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
sİ
->
ty³
 =ğ
SORT_OP_GET
);

567 ià(
ouu’
) {

568 
	`£tKey
(
c
->
db
,
¡Üekey
,
sobj
);

569 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"sÜt¡Üe",
¡Üekey
,

570 
c
->
db
->
id
);

571 
£rv”
.
dœty
 +ğ
ouu’
;

572 } ià(
	`dbD–‘e
(
c
->
db
,
¡Üekey
)) {

573 
	`sigÇlModif›dKey
(
c
->
db
,
¡Üekey
);

574 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
¡Üekey
,
c
->
db
->
id
);

575 
£rv”
.
dœty
++;

577 
	`deüRefCouÁ
(
sobj
);

578 
	`addR•lyLÚgLÚg
(
c
,
ouu’
);

582 
j
 = 0; j < 
veùÜËn
; j++)

583 
	`deüRefCouÁ
(
veùÜ
[
j
].
obj
);

585 
	`deüRefCouÁ
(
sÜtv®
);

586 
	`li¡R–—£
(
İ”©iÚs
);

587 
j
 = 0; j < 
veùÜËn
; j++) {

588 ià(
®pha
 && 
veùÜ
[
j
].
u
.
cmpobj
)

589 
	`deüRefCouÁ
(
veùÜ
[
j
].
u
.
cmpobj
);

591 
	`zä“
(
veùÜ
);

592 
	}
}

	@sparkline.c

33 
	~"£rv”.h
"

35 
	~<m©h.h
>

39 
	gch¬£t
[] = "_-`";

40 
	gch¬£t_fl
[] = "_o#";

41 
	gch¬£t_Ën
 = (
ch¬£t
)-1;

42 
	gÏb–_m¬gš_tİ
 = 1;

57 
£qu’û
 *
	$ü—‹S·rklšeSequ’û
() {

58 
£qu’û
 *
£q
 = 
	`zm®loc
((*seq));

59 
£q
->
Ëngth
 = 0;

60 
£q
->
§m¶es
 = 
NULL
;

61  
£q
;

62 
	}
}

65 
	$¥¬klšeSequ’ûAddSam¶e
(
£qu’û
 *
£q
, 
v®ue
, *
Ïb–
) {

66 
Ïb–
 = (Ïb– =ğ
NULL
 ||†ab–[0] =ğ'\0'è? NULL : 
	`z¡rdup
(label);

67 ià(
£q
->
Ëngth
 == 0) {

68 
£q
->
mš
 = seq->
max
 = 
v®ue
;

70 ià(
v®ue
 < 
£q
->
mš
) seq->min = value;

71 ià(
v®ue
 > 
£q
->
max
) seq->max = value;

73 
£q
->
§m¶es
 = 
	`z»®loc
(£q->§m¶es,(
§m¶e
)*(£q->
Ëngth
+1));

74 
£q
->
§m¶es
[£q->
Ëngth
].
v®ue
 = value;

75 
£q
->
§m¶es
[£q->
Ëngth
].
Ïb–
 =†abel;

76 
£q
->
Ëngth
++;

77 ià(
Ïb–
è
£q
->
Ïb–s
++;

78 
	}
}

81 
	$ä“S·rklšeSequ’û
(
£qu’û
 *
£q
) {

82 
j
;

84 
j
 = 0; j < 
£q
->
Ëngth
; j++)

85 
	`zä“
(
£q
->
§m¶es
[
j
].
Ïb–
);

86 
	`zä“
(
£q
->
§m¶es
);

87 
	`zä“
(
£q
);

88 
	}
}

97 
sds
 
	$¥¬klšeR’d”Rªge
(
sds
 
ouut
, 
£qu’û
 *
£q
, 
rows
, 
off£t
, 
Ën
, 
æags
) {

98 
j
;

99 
»lmax
 = 
£q
->
max
 - seq->
mš
;

100 
¡•s
 = 
ch¬£t_Ën
*
rows
;

101 
row
 = 0;

102 *
ch¬s
 = 
	`zm®loc
(
Ën
);

103 
loİ
 = 1;

104 
İt_fl
 = 
æags
 & 
SPARKLINE_FILL
;

105 
İt_log
 = 
æags
 & 
SPARKLINE_LOG_SCALE
;

107 ià(
İt_log
) {

108 
»lmax
 = 
	`log
(relmax+1);

109 } ià(
»lmax
 == 0) {

110 
»lmax
 = 1;

113 
loİ
) {

114 
loİ
 = 0;

115 
	`mem£t
(
ch¬s
,' ',
Ën
);

116 
j
 = 0; j < 
Ën
; j++) {

117 
§m¶e
 *
s
 = &
£q
->
§m¶es
[
j
+
off£t
];

118 
»lv®
 = 
s
->
v®ue
 - 
£q
->
mš
;

119 
¡•
;

121 ià(
İt_log
è
»lv®
 = 
	`log
(relval+1);

122 
¡•
 = (è(
»lv®
*
¡•s
)/
»lmax
;

123 ià(
¡•
 < 0) step = 0;

124 ià(
¡•
 >ğ
¡•s
) step = steps-1;

126 ià(
row
 < 
rows
) {

128 
ch¬idx
 = 
¡•
-((
rows
-
row
-1)*
ch¬£t_Ën
);

129 
loİ
 = 1;

130 ià(
ch¬idx
 >ğ0 && ch¬idx < 
ch¬£t_Ën
) {

131 
ch¬s
[
j
] = 
İt_fl
 ? 
ch¬£t_fl
[
ch¬idx
] :

132 
ch¬£t
[
ch¬idx
];

133 } if(
İt_fl
 && 
ch¬idx
 >ğ
ch¬£t_Ën
) {

134 
ch¬s
[
j
] = '|';

138 ià(
£q
->
Ïb–s
 && 
row
-
rows
 < 
Ïb–_m¬gš_tİ
) {

139 
loİ
 = 1;

143 ià(
s
->
Ïb–
) {

144 
Ïb–_Ën
 = 
	`¡¾’
(
s
->
Ïb–
);

145 
Ïb–_ch¬
 = 
row
 - 
rows
 - 
Ïb–_m¬gš_tİ
;

147 ià(
Ïb–_Ën
 > 
Ïb–_ch¬
) {

148 
loİ
 = 1;

149 
ch¬s
[
j
] = 
s
->
Ïb–
[
Ïb–_ch¬
];

154 ià(
loİ
) {

155 
row
++;

156 
ouut
 = 
	`sdsÿ’
(ouut,
ch¬s
,
Ën
);

157 
ouut
 = 
	`sdsÿ’
(output,"\n",1);

160 
	`zä“
(
ch¬s
);

161  
ouut
;

162 
	}
}

165 
sds
 
	$¥¬klšeR’d”
(
sds
 
ouut
, 
£qu’û
 *
£q
, 
cŞumns
, 
rows
, 
æags
) {

166 
j
;

168 
j
 = 0; j < 
£q
->
Ëngth
; j +ğ
cŞumns
) {

169 
subËn
 = (
£q
->
Ëngth
-
j
è< 
cŞumns
 ? (seq->length-j) : columns;

171 ià(
j
 !ğ0è
ouut
 = 
	`sdsÿ’
(output,"\n",1);

172 
ouut
 = 
	`¥¬klšeR’d”Rªge
(ouut, 
£q
, 
rows
, 
j
, 
subËn
, 
æags
);

174  
ouut
;

175 
	}
}

	@sparkline.h

30 #iâdeà
__SPARKLINE_H


31 
	#__SPARKLINE_H


	)

34 
	s§m¶e
 {

35 
	mv®ue
;

36 *
	mÏb–
;

39 
	s£qu’û
 {

40 
	mËngth
;

41 
	mÏb–s
;

42 
§m¶e
 *
	m§m¶es
;

43 
	mmš
, 
	mmax
;

46 
	#SPARKLINE_NO_FLAGS
 0

	)

47 
	#SPARKLINE_FILL
 1

	)

48 
	#SPARKLINE_LOG_SCALE
 2

	)

50 
£qu’û
 *
ü—‹S·rklšeSequ’û
();

51 
¥¬klšeSequ’ûAddSam¶e
(
£qu’û
 *
£q
, 
v®ue
, *
Ïb–
);

52 
ä“S·rklšeSequ’û
(
£qu’û
 *
£q
);

53 
sds
 
¥¬klšeR’d”Rªge
(sd 
ouut
, 
£qu’û
 *
£q
, 
rows
, 
off£t
, 
Ën
, 
æags
);

54 
sds
 
¥¬klšeR’d”
(sd 
ouut
, 
£qu’û
 *
£q
, 
cŞumns
, 
rows
, 
æags
);

	@syncio.c

31 
	~"£rv”.h
"

43 
	#SYNCIO__RESOLUTION
 10

	)

49 
ssize_t
 
	$syncWr™e
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

50 
ssize_t
 
nwr™‹n
, 
»t
 = 
size
;

51 
¡¬t
 = 
	`m¡ime
();

52 
»maššg
 = 
timeout
;

55 
wa™
 = (
»maššg
 > 
SYNCIO__RESOLUTION
) ?

56 
»maššg
 : 
SYNCIO__RESOLUTION
;

57 
–­£d
;

61 
nwr™‹n
 = 
	`wr™e
(
fd
,
±r
,
size
);

62 ià(
nwr™‹n
 == -1) {

63 ià(
”ºo
 !ğ
EAGAIN
)  -1;

65 
±r
 +ğ
nwr™‹n
;

66 
size
 -ğ
nwr™‹n
;

68 ià(
size
 =ğ0è 
»t
;

71 
	`«Wa™
(
fd
,
AE_WRITABLE
,
wa™
);

72 
–­£d
 = 
	`m¡ime
(è- 
¡¬t
;

73 ià(
–­£d
 >ğ
timeout
) {

74 
”ºo
 = 
ETIMEDOUT
;

77 
»maššg
 = 
timeout
 - 
–­£d
;

79 
	}
}

85 
ssize_t
 
	$syncR—d
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

86 
ssize_t
 
Ä—d
, 
tÙ»ad
 = 0;

87 
¡¬t
 = 
	`m¡ime
();

88 
»maššg
 = 
timeout
;

90 ià(
size
 == 0)  0;

92 
wa™
 = (
»maššg
 > 
SYNCIO__RESOLUTION
) ?

93 
»maššg
 : 
SYNCIO__RESOLUTION
;

94 
–­£d
;

98 
Ä—d
 = 
	`»ad
(
fd
,
±r
,
size
);

99 ià(
Ä—d
 == 0)  -1;

100 ià(
Ä—d
 == -1) {

101 ià(
”ºo
 !ğ
EAGAIN
)  -1;

103 
±r
 +ğ
Ä—d
;

104 
size
 -ğ
Ä—d
;

105 
tÙ»ad
 +ğ
Ä—d
;

107 ià(
size
 =ğ0è 
tÙ»ad
;

110 
	`«Wa™
(
fd
,
AE_READABLE
,
wa™
);

111 
–­£d
 = 
	`m¡ime
(è- 
¡¬t
;

112 ià(
–­£d
 >ğ
timeout
) {

113 
”ºo
 = 
ETIMEDOUT
;

116 
»maššg
 = 
timeout
 - 
–­£d
;

118 
	}
}

125 
ssize_t
 
	$syncR—dLše
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

126 
ssize_t
 
Ä—d
 = 0;

128 
size
--;

129 
size
) {

130 
c
;

132 ià(
	`syncR—d
(
fd
,&
c
,1,
timeout
) == -1)  -1;

133 ià(
c
 == '\n') {

134 *
±r
 = '\0';

135 ià(
Ä—d
 && *(
±r
-1) == '\r') *(ptr-1) = '\0';

136  
Ä—d
;

138 *
±r
++ = 
c
;

139 *
±r
 = '\0';

140 
Ä—d
++;

142 
size
--;

144  
Ä—d
;

145 
	}
}

	@t_hash.c

30 
	~"£rv”.h
"

31 
	~<m©h.h
>

40 
	$hashTy³TryCÚv”siÚ
(
robj
 *
o
,„obj **
¬gv
, 
¡¬t
, 
’d
) {

41 
i
;

43 ià(
o
->
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
) ;

45 
i
 = 
¡¬t
; i <ğ
’d
; i++) {

46 ià(
	`sdsEncodedObjeù
(
¬gv
[
i
]) &&

47 
	`sd¦’
(
¬gv
[
i
]->
±r
è> 
£rv”
.
hash_max_zli¡_v®ue
)

49 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

53 
	}
}

57 
	$hashTy³G‘FromZli¡
(
robj
 *
o
, 
sds
 
f›ld
,

58 **
v¡r
,

59 *
vËn
,

60 *
vÎ
)

62 *
zl
, *
åŒ
 = 
NULL
, *
v±r
 = NULL;

63 
»t
;

65 
	`£rv”As£¹
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

67 
zl
 = 
o
->
±r
;

68 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

69 ià(
åŒ
 !ğ
NULL
) {

70 
åŒ
 = 
	`zli¡Fšd
(åŒ, (*)
f›ld
, 
	`sd¦’
(field), 1);

71 ià(
åŒ
 !ğ
NULL
) {

73 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

74 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

78 ià(
v±r
 !ğ
NULL
) {

79 
»t
 = 
	`zli¡G‘
(
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

80 
	`£rv”As£¹
(
»t
);

85 
	}
}

90 
sds
 
	$hashTy³G‘FromHashTabË
(
robj
 *
o
, 
sds
 
f›ld
) {

91 
diùEÁry
 *
de
;

93 
	`£rv”As£¹
(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

95 
de
 = 
	`diùFšd
(
o
->
±r
, 
f›ld
);

96 ià(
de
 =ğ
NULL
)  NULL;

97  
	`diùG‘V®
(
de
);

98 
	}
}

109 
	$hashTy³G‘V®ue
(
robj
 *
o
, 
sds
 
f›ld
, **
v¡r
, *
vËn
, *
vÎ
) {

110 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

111 *
v¡r
 = 
NULL
;

112 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, 
v¡r
, 
vËn
, 
vÎ
) == 0)

113  
C_OK
;

114 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

115 
sds
 
v®ue
;

116 ià((
v®ue
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
)è!ğ
NULL
) {

117 *
v¡r
 = (*è
v®ue
;

118 *
vËn
 = 
	`sd¦’
(
v®ue
);

119  
C_OK
;

122 
	`£rv”Pªic
("Unknown hashƒncoding");

124  
C_ERR
;

125 
	}
}

131 
robj
 *
	$hashTy³G‘V®ueObjeù
(
robj
 *
o
, 
sds
 
f›ld
) {

132 *
v¡r
;

133 
vËn
;

134 
vÎ
;

136 ià(
	`hashTy³G‘V®ue
(
o
,
f›ld
,&
v¡r
,&
vËn
,&
vÎ
è=ğ
C_ERR
è 
NULL
;

137 ià(
v¡r
è 
	`ü—‹SŒšgObjeù
((*)v¡r,
vËn
);

138  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

139 
	}
}

144 
size_t
 
	$hashTy³G‘V®ueL’gth
(
robj
 *
o
, 
sds
 
f›ld
) {

145 
size_t
 
Ën
 = 0;

146 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

147 *
v¡r
 = 
NULL
;

148 
vËn
 = 
UINT_MAX
;

149 
vÎ
 = 
LLONG_MAX
;

151 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)

152 
Ën
 = 
v¡r
 ? 
vËn
 : 
	`sdig™s10
(
vÎ
);

153 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

154 
sds
 
aux
;

156 ià((
aux
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
)è!ğ
NULL
)

157 
Ën
 = 
	`sd¦’
(
aux
);

159 
	`£rv”Pªic
("Unknown hashƒncoding");

161  
Ën
;

162 
	}
}

166 
	$hashTy³Exi¡s
(
robj
 *
o
, 
sds
 
f›ld
) {

167 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

168 *
v¡r
 = 
NULL
;

169 
vËn
 = 
UINT_MAX
;

170 
vÎ
 = 
LLONG_MAX
;

172 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)  1;

173 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

174 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
è!ğ
NULL
)  1;

176 
	`£rv”Pªic
("Unknown hashƒncoding");

179 
	}
}

199 
	#HASH_SET_TAKE_FIELD
 (1<<0)

	)

200 
	#HASH_SET_TAKE_VALUE
 (1<<1)

	)

201 
	#HASH_SET_COPY
 0

	)

202 
	$hashTy³S‘
(
robj
 *
o
, 
sds
 
f›ld
, sd 
v®ue
, 
æags
) {

203 
upd©e
 = 0;

205 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

206 *
zl
, *
åŒ
, *
v±r
;

208 
zl
 = 
o
->
±r
;

209 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

210 ià(
åŒ
 !ğ
NULL
) {

211 
åŒ
 = 
	`zli¡Fšd
(åŒ, (*)
f›ld
, 
	`sd¦’
(field), 1);

212 ià(
åŒ
 !ğ
NULL
) {

214 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

215 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

216 
upd©e
 = 1;

219 
zl
 = 
	`zli¡D–‘e
(zl, &
v±r
);

222 
zl
 = 
	`zli¡In£¹
(zl, 
v±r
, (*)
v®ue
,

223 
	`sd¦’
(
v®ue
));

227 ià(!
upd©e
) {

229 
zl
 = 
	`zli¡Push
(zl, (*)
f›ld
, 
	`sd¦’
(field),

230 
ZIPLIST_TAIL
);

231 
zl
 = 
	`zli¡Push
(zl, (*)
v®ue
, 
	`sd¦’
(value),

232 
ZIPLIST_TAIL
);

234 
o
->
±r
 = 
zl
;

237 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

238 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

239 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

240 
diùEÁry
 *
de
 = 
	`diùFšd
(
o
->
±r
,
f›ld
);

241 ià(
de
) {

242 
	`sdsä“
(
	`diùG‘V®
(
de
));

243 ià(
æags
 & 
HASH_SET_TAKE_VALUE
) {

244 
	`diùG‘V®
(
de
èğ
v®ue
;

245 
v®ue
 = 
NULL
;

247 
	`diùG‘V®
(
de
èğ
	`sdsdup
(
v®ue
);

249 
upd©e
 = 1;

251 
sds
 
f
,
v
;

252 ià(
æags
 & 
HASH_SET_TAKE_FIELD
) {

253 
f
 = 
f›ld
;

254 
f›ld
 = 
NULL
;

256 
f
 = 
	`sdsdup
(
f›ld
);

258 ià(
æags
 & 
HASH_SET_TAKE_VALUE
) {

259 
v
 = 
v®ue
;

260 
v®ue
 = 
NULL
;

262 
v
 = 
	`sdsdup
(
v®ue
);

264 
	`diùAdd
(
o
->
±r
,
f
,
v
);

267 
	`£rv”Pªic
("Unknown hashƒncoding");

272 ià(
æags
 & 
HASH_SET_TAKE_FIELD
 && 
f›ld
è
	`sdsä“
(field);

273 ià(
æags
 & 
HASH_SET_TAKE_VALUE
 && 
v®ue
è
	`sdsä“
(value);

274  
upd©e
;

275 
	}
}

279 
	$hashTy³D–‘e
(
robj
 *
o
, 
sds
 
f›ld
) {

280 
d–‘ed
 = 0;

282 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

283 *
zl
, *
åŒ
;

285 
zl
 = 
o
->
±r
;

286 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

287 ià(
åŒ
 !ğ
NULL
) {

288 
åŒ
 = 
	`zli¡Fšd
(åŒ, (*)
f›ld
, 
	`sd¦’
(field), 1);

289 ià(
åŒ
 !ğ
NULL
) {

290 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

291 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

292 
o
->
±r
 = 
zl
;

293 
d–‘ed
 = 1;

296 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

297 ià(
	`diùD–‘e
((
diù
*)
o
->
±r
, 
f›ld
è=ğ
C_OK
) {

298 
d–‘ed
 = 1;

301 ià(
	`htN“dsResize
(
o
->
±r
)è
	`diùResize
(o->ptr);

305 
	`£rv”Pªic
("Unknown hashƒncoding");

307  
d–‘ed
;

308 
	}
}

311 
	$hashTy³L’gth
(cÚ¡ 
robj
 *
o
) {

312 
Ëngth
 = 
ULONG_MAX
;

314 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

315 
Ëngth
 = 
	`zli¡L’
(
o
->
±r
) / 2;

316 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

317 
Ëngth
 = 
	`diùSize
((cÚ¡ 
diù
*)
o
->
±r
);

319 
	`£rv”Pªic
("Unknown hashƒncoding");

321  
Ëngth
;

322 
	}
}

324 
hashTy³I‹¿tÜ
 *
	$hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

325 
hashTy³I‹¿tÜ
 *
hi
 = 
	`zm®loc
((hashTypeIterator));

326 
hi
->
subjeù
 = subject;

327 
hi
->
’codšg
 = 
subjeù
->encoding;

329 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

330 
hi
->
åŒ
 = 
NULL
;

331 
hi
->
v±r
 = 
NULL
;

332 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

333 
hi
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

335 
	`£rv”Pªic
("Unknown hashƒncoding");

337  
hi
;

338 
	}
}

340 
	$hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
) {

341 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

342 
	`diùR–—£I‹¿tÜ
(
hi
->
di
);

343 
	`zä“
(
hi
);

344 
	}
}

348 
	$hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
) {

349 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

350 *
zl
;

351 *
åŒ
, *
v±r
;

353 
zl
 = 
hi
->
subjeù
->
±r
;

354 
åŒ
 = 
hi
->fptr;

355 
v±r
 = 
hi
->vptr;

357 ià(
åŒ
 =ğ
NULL
) {

359 
	`£rv”As£¹
(
v±r
 =ğ
NULL
);

360 
åŒ
 = 
	`zli¡Index
(
zl
, 0);

363 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

364 
åŒ
 = 
	`zli¡Next
(
zl
, 
v±r
);

366 ià(
åŒ
 =ğ
NULL
è 
C_ERR
;

369 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

370 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

373 
hi
->
åŒ
 = fptr;

374 
hi
->
v±r
 = vptr;

375 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

376 ià((
hi
->
de
 = 
	`diùNext
(hi->
di
)è=ğ
NULL
è 
C_ERR
;

378 
	`£rv”Pªic
("Unknown hashƒncoding");

380  
C_OK
;

381 
	}
}

385 
	$hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

386 **
v¡r
,

387 *
vËn
,

388 *
vÎ
)

390 
»t
;

392 
	`£rv”As£¹
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

394 ià(
wh©
 & 
OBJ_HASH_KEY
) {

395 
»t
 = 
	`zli¡G‘
(
hi
->
åŒ
, 
v¡r
, 
vËn
, 
vÎ
);

396 
	`£rv”As£¹
(
»t
);

398 
»t
 = 
	`zli¡G‘
(
hi
->
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

399 
	`£rv”As£¹
(
»t
);

401 
	}
}

406 
sds
 
	$hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

407 
	`£rv”As£¹
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

409 ià(
wh©
 & 
OBJ_HASH_KEY
) {

410  
	`diùG‘Key
(
hi
->
de
);

412  
	`diùG‘V®
(
hi
->
de
);

414 
	}
}

426 
	$hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, **
v¡r
, *
vËn
, *
vÎ
) {

427 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

428 *
v¡r
 = 
NULL
;

429 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, 
v¡r
, 
vËn
, 
vÎ
);

430 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

431 
sds
 
–e
 = 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
);

432 *
v¡r
 = (*è
–e
;

433 *
vËn
 = 
	`sd¦’
(
–e
);

435 
	`£rv”Pªic
("Unknown hashƒncoding");

437 
	}
}

441 
sds
 
	$hashTy³Cu¼’tObjeùNewSds
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

442 *
v¡r
;

443 
vËn
;

444 
vÎ
;

446 
	`hashTy³Cu¼’tObjeù
(
hi
,
wh©
,&
v¡r
,&
vËn
,&
vÎ
);

447 ià(
v¡r
è 
	`sd¢ewËn
(v¡r,
vËn
);

448  
	`sdsäomlÚglÚg
(
vÎ
);

449 
	}
}

451 
robj
 *
	$hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
, 
robj
 *
key
) {

452 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
);

453 ià(
o
 =ğ
NULL
) {

454 
o
 = 
	`ü—‹HashObjeù
();

455 
	`dbAdd
(
c
->
db
,
key
,
o
);

457 ià(
o
->
ty³
 !ğ
OBJ_HASH
) {

458 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

459  
NULL
;

462  
o
;

463 
	}
}

465 
	$hashTy³CÚv”tZli¡
(
robj
 *
o
, 
’c
) {

466 
	`£rv”As£¹
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

468 ià(
’c
 =ğ
OBJ_ENCODING_ZIPLIST
) {

471 } ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

472 
hashTy³I‹¿tÜ
 *
hi
;

473 
diù
 *dict;

474 
»t
;

476 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

477 
diù
 = 
	`diùC»©e
(&
hashDiùTy³
, 
NULL
);

479 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

480 
sds
 
key
, 
v®ue
;

482 
key
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_KEY
);

483 
v®ue
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_VALUE
);

484 
»t
 = 
	`diùAdd
(
diù
, 
key
, 
v®ue
);

485 ià(
»t
 !ğ
DICT_OK
) {

486 
	`£rv”LogHexDump
(
LL_WARNING
,"ziplist with dupƒlements dump",

487 
o
->
±r
,
	`zli¡BlobL’
(o->ptr));

488 
	`£rv”Pªic
("Ziplist corruption detected");

491 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

492 
	`zä“
(
o
->
±r
);

493 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

494 
o
->
±r
 = 
diù
;

496 
	`£rv”Pªic
("Unknown hashƒncoding");

498 
	}
}

500 
	$hashTy³CÚv”t
(
robj
 *
o
, 
’c
) {

501 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

502 
	`hashTy³CÚv”tZli¡
(
o
, 
’c
);

503 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

504 
	`£rv”Pªic
("Not implemented");

506 
	`£rv”Pªic
("Unknown hashƒncoding");

508 
	}
}

514 
	$h£tCommªd
(
ş›Á
 *
c
) {

515 
upd©e
;

516 
robj
 *
o
;

518 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

519 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

520 
upd©e
 = 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2]->
±r
,c->¬gv[3]->±r,
HASH_SET_COPY
);

521 
	`addR•ly
(
c
, 
upd©e
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
cÚe
);

522 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

523 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

524 
£rv”
.
dœty
++;

525 
	}
}

527 
	$h£ŠxCommªd
(
ş›Á
 *
c
) {

528 
robj
 *
o
;

529 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

530 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

532 ià(
	`hashTy³Exi¡s
(
o
, 
c
->
¬gv
[2]->
±r
)) {

533 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

535 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2]->
±r
,c->¬gv[3]->±r,
HASH_SET_COPY
);

536 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

537 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

538 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

539 
£rv”
.
dœty
++;

541 
	}
}

543 
	$hm£tCommªd
(
ş›Á
 *
c
) {

544 
i
;

545 
robj
 *
o
;

547 ià((
c
->
¬gc
 % 2) == 1) {

548 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for HMSET");

552 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

553 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,c->
¬gc
-1);

554 
i
 = 2; i < 
c
->
¬gc
; i += 2) {

555 
	`hashTy³S‘
(
o
,
c
->
¬gv
[
i
]->
±r
,c->¬gv[i+1]->±r,
HASH_SET_COPY
);

557 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

558 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

559 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

560 
£rv”
.
dœty
++;

561 
	}
}

563 
	$hšübyCommªd
(
ş›Á
 *
c
) {

564 
v®ue
, 
šü
, 
Şdv®ue
;

565 
robj
 *
o
;

566 
sds
 
Ãw
;

567 *
v¡r
;

568 
vËn
;

570 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
C_OK
) ;

571 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

572 ià(
	`hashTy³G‘V®ue
(
o
,
c
->
¬gv
[2]->
±r
,&
v¡r
,&
vËn
,&
v®ue
è=ğ
C_OK
) {

573 ià(
v¡r
) {

574 ià(
	`¡ršg2Î
((*)
v¡r
,
vËn
,&
v®ue
) == 0) {

575 
	`addR•lyE¼Ü
(
c
,"hash value is‚ot‡n integer");

580 
v®ue
 = 0;

583 
Şdv®ue
 = 
v®ue
;

584 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

585 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

586 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

589 
v®ue
 +ğ
šü
;

590 
Ãw
 = 
	`sdsäomlÚglÚg
(
v®ue
);

591 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2]->
±r
,
Ãw
,
HASH_SET_TAKE_VALUE
);

592 
	`addR•lyLÚgLÚg
(
c
,
v®ue
);

593 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

594 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšüby",
c
->
¬gv
[1],c->
db
->
id
);

595 
£rv”
.
dœty
++;

596 
	}
}

598 
	$hšübyæßtCommªd
(
ş›Á
 *
c
) {

599 
v®ue
, 
šü
;

600 
Î
;

601 
robj
 *
o
;

602 
sds
 
Ãw
;

603 *
v¡r
;

604 
vËn
;

606 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
C_OK
) ;

607 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

608 ià(
	`hashTy³G‘V®ue
(
o
,
c
->
¬gv
[2]->
±r
,&
v¡r
,&
vËn
,&
Î
è=ğ
C_OK
) {

609 ià(
v¡r
) {

610 ià(
	`¡ršg2ld
((*)
v¡r
,
vËn
,&
v®ue
) == 0) {

611 
	`addR•lyE¼Ü
(
c
,"hash value is‚ot‡ float");

615 
v®ue
 = ()
Î
;

618 
v®ue
 = 0;

621 
v®ue
 +ğ
šü
;

623 
buf
[256];

624 
Ën
 = 
	`ld2¡ršg
(
buf
,(buf),
v®ue
,1);

625 
Ãw
 = 
	`sd¢ewËn
(
buf
,
Ën
);

626 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2]->
±r
,
Ãw
,
HASH_SET_TAKE_VALUE
);

627 
	`addR•lyBulkCBufãr
(
c
,
buf
,
Ën
);

628 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

629 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

630 
£rv”
.
dœty
++;

635 
robj
 *
aux
, *
Ãwobj
;

636 
aux
 = 
	`ü—‹SŒšgObjeù
("HSET",4);

637 
Ãwobj
 = 
	`ü—‹RawSŒšgObjeù
(
buf
,
Ën
);

638 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

639 
	`deüRefCouÁ
(
aux
);

640 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,3,
Ãwobj
);

641 
	`deüRefCouÁ
(
Ãwobj
);

642 
	}
}

644 
	$addHashF›ldToR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, 
sds
 
f›ld
) {

645 
»t
;

647 ià(
o
 =ğ
NULL
) {

648 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

652 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

653 *
v¡r
 = 
NULL
;

654 
vËn
 = 
UINT_MAX
;

655 
vÎ
 = 
LLONG_MAX
;

657 
»t
 = 
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
);

658 ià(
»t
 < 0) {

659 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

661 ià(
v¡r
) {

662 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

664 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

668 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

669 
sds
 
v®ue
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
);

670 ià(
v®ue
 =ğ
NULL
)

671 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

673 
	`addR•lyBulkCBufãr
(
c
, 
v®ue
, 
	`sd¦’
(value));

675 
	`£rv”Pªic
("Unknown hashƒncoding");

677 
	}
}

679 
	$hg‘Commªd
(
ş›Á
 *
c
) {

680 
robj
 *
o
;

682 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

683 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

685 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[2]->
±r
);

686 
	}
}

688 
	$hmg‘Commªd
(
ş›Á
 *
c
) {

689 
robj
 *
o
;

690 
i
;

694 
o
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

695 ià(
o
 !ğ
NULL
 && o->
ty³
 !ğ
OBJ_HASH
) {

696 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

700 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

701 
i
 = 2; i < 
c
->
¬gc
; i++) {

702 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[
i
]->
±r
);

704 
	}
}

706 
	$hd–Commªd
(
ş›Á
 *
c
) {

707 
robj
 *
o
;

708 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

710 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

711 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

713 
j
 = 2; j < 
c
->
¬gc
; j++) {

714 ià(
	`hashTy³D–‘e
(
o
,
c
->
¬gv
[
j
]->
±r
)) {

715 
d–‘ed
++;

716 ià(
	`hashTy³L’gth
(
o
) == 0) {

717 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

718 
key»moved
 = 1;

723 ià(
d–‘ed
) {

724 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

725 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hd–",
c
->
¬gv
[1],c->
db
->
id
);

726 ià(
key»moved
)

727 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

728 
c
->
db
->
id
);

729 
£rv”
.
dœty
 +ğ
d–‘ed
;

731 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

732 
	}
}

734 
	$hËnCommªd
(
ş›Á
 *
c
) {

735 
robj
 *
o
;

737 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

738 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

740 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³L’gth
(
o
));

741 
	}
}

743 
	$h¡¾’Commªd
(
ş›Á
 *
c
) {

744 
robj
 *
o
;

746 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

747 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

748 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³G‘V®ueL’gth
(
o
,c->
¬gv
[2]->
±r
));

749 
	}
}

751 
	$addHashI‹¿tÜCursÜToR•ly
(
ş›Á
 *
c
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

752 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

753 *
v¡r
 = 
NULL
;

754 
vËn
 = 
UINT_MAX
;

755 
vÎ
 = 
LLONG_MAX
;

757 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

758 ià(
v¡r
)

759 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

761 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

762 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

763 
sds
 
v®ue
 = 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
);

764 
	`addR•lyBulkCBufãr
(
c
, 
v®ue
, 
	`sd¦’
(value));

766 
	`£rv”Pªic
("Unknown hashƒncoding");

768 
	}
}

770 
	$g’”icHg‘®lCommªd
(
ş›Á
 *
c
, 
æags
) {

771 
robj
 *
o
;

772 
hashTy³I‹¿tÜ
 *
hi
;

773 
muÉl›r
 = 0;

774 
Ëngth
, 
couÁ
 = 0;

776 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


777 || 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

779 ià(
æags
 & 
OBJ_HASH_KEY
è
muÉl›r
++;

780 ià(
æags
 & 
OBJ_HASH_VALUE
è
muÉl›r
++;

782 
Ëngth
 = 
	`hashTy³L’gth
(
o
è* 
muÉl›r
;

783 
	`addR•lyMuÉiBulkL’
(
c
, 
Ëngth
);

785 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

786 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

787 ià(
æags
 & 
OBJ_HASH_KEY
) {

788 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_KEY
);

789 
couÁ
++;

791 ià(
æags
 & 
OBJ_HASH_VALUE
) {

792 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_VALUE
);

793 
couÁ
++;

797 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

798 
	`£rv”As£¹
(
couÁ
 =ğ
Ëngth
);

799 
	}
}

801 
	$hkeysCommªd
(
ş›Á
 *
c
) {

802 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
);

803 
	}
}

805 
	$hv®sCommªd
(
ş›Á
 *
c
) {

806 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_VALUE
);

807 
	}
}

809 
	$hg‘®lCommªd
(
ş›Á
 *
c
) {

810 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
|
OBJ_HASH_VALUE
);

811 
	}
}

813 
	$hexi¡sCommªd
(
ş›Á
 *
c
) {

814 
robj
 *
o
;

815 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

816 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

818 
	`addR•ly
(
c
, 
	`hashTy³Exi¡s
(
o
,c->
¬gv
[2]->
±r
è? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

819 
	}
}

821 
	$hsÿnCommªd
(
ş›Á
 *
c
) {

822 
robj
 *
o
;

823 
cursÜ
;

825 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
C_ERR
) ;

826 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

827 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

828 
	`sÿnG’”icCommªd
(
c
,
o
,
cursÜ
);

829 
	}
}

	@t_list.c

30 
	~"£rv”.h
"

41 
	$li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
) {

42 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

43 
pos
 = (
wh”e
 =ğ
LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

44 
v®ue
 = 
	`g‘DecodedObjeù
(value);

45 
size_t
 
Ën
 = 
	`sd¦’
(
v®ue
->
±r
);

46 
	`quickli¡Push
(
subjeù
->
±r
, 
v®ue
->±r, 
Ën
, 
pos
);

47 
	`deüRefCouÁ
(
v®ue
);

49 
	`£rv”Pªic
("Unknown†istƒncoding");

51 
	}
}

53 *
	$li¡PİSav”
(*
d©a
, 
sz
) {

54  
	`ü—‹SŒšgObjeù
((*)
d©a
,
sz
);

55 
	}
}

57 
robj
 *
	$li¡Ty³Pİ
(
robj
 *
subjeù
, 
wh”e
) {

58 
vlÚg
;

59 
robj
 *
v®ue
 = 
NULL
;

61 
ql_wh”e
 = 
wh”e
 =ğ
LIST_HEAD
 ? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

62 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

63 ià(
	`quickli¡PİCu¡om
(
subjeù
->
±r
, 
ql_wh”e
, (**)&
v®ue
,

64 
NULL
, &
vlÚg
, 
li¡PİSav”
)) {

65 ià(!
v®ue
)

66 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

69 
	`£rv”Pªic
("Unknown†istƒncoding");

71  
v®ue
;

72 
	}
}

74 
	$li¡Ty³L’gth
(cÚ¡ 
robj
 *
subjeù
) {

75 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

76  
	`quickli¡CouÁ
(
subjeù
->
±r
);

78 
	`£rv”Pªic
("Unknown†istƒncoding");

80 
	}
}

83 
li¡Ty³I‹¿tÜ
 *
	$li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
,

84 
dœeùiÚ
) {

85 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`zm®loc
((listTypeIterator));

86 
li
->
subjeù
 = subject;

87 
li
->
’codšg
 = 
subjeù
->encoding;

88 
li
->
dœeùiÚ
 = direction;

89 
li
->
™”
 = 
NULL
;

92 
™”_dœeùiÚ
 =

93 
dœeùiÚ
 =ğ
LIST_HEAD
 ? 
AL_START_TAIL
 : 
AL_START_HEAD
;

94 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

95 
li
->
™”
 = 
	`quickli¡G‘I‹¿tÜAtIdx
Öi->
subjeù
->
±r
,

96 
™”_dœeùiÚ
, 
šdex
);

98 
	`£rv”Pªic
("Unknown†istƒncoding");

100  
li
;

101 
	}
}

104 
	$li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
) {

105 
	`zä“
(
li
->
™”
);

106 
	`zä“
(
li
);

107 
	}
}

112 
	$li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
) {

114 
	`£rv”As£¹
(
li
->
subjeù
->
’codšg
 ==†i->encoding);

116 
’Œy
->
li
 =†i;

117 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

118  
	`quickli¡Next
(
li
->
™”
, &
’Œy
->entry);

120 
	`£rv”Pªic
("Unknown†istƒncoding");

123 
	}
}

126 
robj
 *
	$li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
) {

127 
robj
 *
v®ue
 = 
NULL
;

128 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

129 ià(
’Œy
->’Œy.
v®ue
) {

130 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
->entry.value,

131 
’Œy
->’Œy.
sz
);

133 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
->’Œy.
lÚgv®
);

136 
	`£rv”Pªic
("Unknown†istƒncoding");

138  
v®ue
;

139 
	}
}

141 
	$li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
) {

142 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

143 
v®ue
 = 
	`g‘DecodedObjeù
(value);

144 
sds
 
¡r
 = 
v®ue
->
±r
;

145 
size_t
 
Ën
 = 
	`sd¦’
(
¡r
);

146 ià(
wh”e
 =ğ
LIST_TAIL
) {

147 
	`quickli¡In£¹Aá”
((
quickli¡
 *)
’Œy
->entry.quicklist,

148 &
’Œy
->’Œy, 
¡r
, 
Ën
);

149 } ià(
wh”e
 =ğ
LIST_HEAD
) {

150 
	`quickli¡In£¹BefÜe
((
quickli¡
 *)
’Œy
->entry.quicklist,

151 &
’Œy
->’Œy, 
¡r
, 
Ën
);

153 
	`deüRefCouÁ
(
v®ue
);

155 
	`£rv”Pªic
("Unknown†istƒncoding");

157 
	}
}

160 
	$li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
) {

161 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

162 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,
	`sdsEncodedObjeù
(o));

163  
	`quickli¡Com·»
(
’Œy
->’Œy.
zi
,
o
->
±r
,
	`sd¦’
(o->ptr));

165 
	`£rv”Pªic
("Unknown†istƒncoding");

167 
	}
}

170 
	$li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
) {

171 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

172 
	`quickli¡D–EÁry
(
™”
->™”, &
’Œy
->entry);

174 
	`£rv”Pªic
("Unknown†istƒncoding");

176 
	}
}

179 
	$li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
) {

180 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
ty³
==
OBJ_LIST
);

181 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
’codšg
==
OBJ_ENCODING_ZIPLIST
);

183 ià(
’c
 =ğ
OBJ_ENCODING_QUICKLIST
) {

184 
size_t
 
zËn
 = 
£rv”
.
li¡_max_zli¡_size
;

185 
d•th
 = 
£rv”
.
li¡_com´ess_d•th
;

186 
subjeù
->
±r
 = 
	`quickli¡C»©eFromZli¡
(
zËn
, 
d•th
, subject->ptr);

187 
subjeù
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

189 
	`£rv”Pªic
("Unsupported†ist conversion");

191 
	}
}

197 
	$pushG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

198 
j
, 
pushed
 = 0;

199 
robj
 *
lobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

201 ià(
lobj
 &&†obj->
ty³
 !ğ
OBJ_LIST
) {

202 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

206 
j
 = 2; j < 
c
->
¬gc
; j++) {

207 ià(!
lobj
) {

208 
lobj
 = 
	`ü—‹Quickli¡Objeù
();

209 
	`quickli¡S‘O±iÚs
(
lobj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

210 
£rv”
.
li¡_com´ess_d•th
);

211 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
lobj
);

213 
	`li¡Ty³Push
(
lobj
,
c
->
¬gv
[
j
],
wh”e
);

214 
pushed
++;

216 
	`addR•lyLÚgLÚg
(
c
, (
lobj
 ? 
	`li¡Ty³L’gth
(lobj) : 0));

217 ià(
pushed
) {

218 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

220 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

221 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

223 
£rv”
.
dœty
 +ğ
pushed
;

224 
	}
}

226 
	$ÍushCommªd
(
ş›Á
 *
c
) {

227 
	`pushG’”icCommªd
(
c
,
LIST_HEAD
);

228 
	}
}

230 
	$½ushCommªd
(
ş›Á
 *
c
) {

231 
	`pushG’”icCommªd
(
c
,
LIST_TAIL
);

232 
	}
}

234 
	$pushxG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

235 
j
, 
pushed
 = 0;

236 
robj
 *
subjeù
;

238 ià((
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

239 
	`checkTy³
(
c
,
subjeù
,
OBJ_LIST
)) ;

241 
j
 = 2; j < 
c
->
¬gc
; j++) {

242 
	`li¡Ty³Push
(
subjeù
,
c
->
¬gv
[
j
],
wh”e
);

243 
pushed
++;

246 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
subjeù
));

248 ià(
pushed
) {

249 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

250 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

251 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

253 
£rv”
.
dœty
 +ğ
pushed
;

254 
	}
}

256 
	$ÍushxCommªd
(
ş›Á
 *
c
) {

257 
	`pushxG’”icCommªd
(
c
,
LIST_HEAD
);

258 
	}
}

260 
	$½ushxCommªd
(
ş›Á
 *
c
) {

261 
	`pushxG’”icCommªd
(
c
,
LIST_TAIL
);

262 
	}
}

264 
	$lš£¹Commªd
(
ş›Á
 *
c
) {

265 
wh”e
;

266 
robj
 *
subjeù
;

267 
li¡Ty³I‹¿tÜ
 *
™”
;

268 
li¡Ty³EÁry
 
’Œy
;

269 
š£¹ed
 = 0;

271 ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"after") == 0) {

272 
wh”e
 = 
LIST_TAIL
;

273 } ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"before") == 0) {

274 
wh”e
 = 
LIST_HEAD
;

276 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

280 ià((
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

281 
	`checkTy³
(
c
,
subjeù
,
OBJ_LIST
)) ;

284 
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

285 
	`li¡Ty³Next
(
™”
,&
’Œy
)) {

286 ià(
	`li¡Ty³Equ®
(&
’Œy
,
c
->
¬gv
[3])) {

287 
	`li¡Ty³In£¹
(&
’Œy
,
c
->
¬gv
[4],
wh”e
);

288 
š£¹ed
 = 1;

292 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

294 ià(
š£¹ed
) {

295 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

296 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"linsert",

297 
c
->
¬gv
[1],c->
db
->
id
);

298 
£rv”
.
dœty
++;

301 
	`addR•ly
(
c
,
sh¬ed
.
úegÚe
);

305 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
subjeù
));

306 
	}
}

308 
	$Î’Commªd
(
ş›Á
 *
c
) {

309 
robj
 *
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

310 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

311 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
o
));

312 
	}
}

314 
	$lšdexCommªd
(
ş›Á
 *
c
) {

315 
robj
 *
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

316 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

317 
šdex
;

318 
robj
 *
v®ue
 = 
NULL
;

320 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
C_OK
))

323 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

324 
quickli¡EÁry
 
’Œy
;

325 ià(
	`quickli¡Index
(
o
->
±r
, 
šdex
, &
’Œy
)) {

326 ià(
’Œy
.
v®ue
) {

327 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
.v®ue,’Œy.
sz
);

329 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
.
lÚgv®
);

331 
	`addR•lyBulk
(
c
,
v®ue
);

332 
	`deüRefCouÁ
(
v®ue
);

334 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

337 
	`£rv”Pªic
("Unknown†istƒncoding");

339 
	}
}

341 
	$l£tCommªd
(
ş›Á
 *
c
) {

342 
robj
 *
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
);

343 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

344 
šdex
;

345 
robj
 *
v®ue
 = 
c
->
¬gv
[3];

347 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
C_OK
))

350 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

351 
quickli¡
 *
ql
 = 
o
->
±r
;

352 
»¶aûd
 = 
	`quickli¡R•ÏûAtIndex
(
ql
, 
šdex
,

353 
v®ue
->
±r
, 
	`sd¦’
(value->ptr));

354 ià(!
»¶aûd
) {

355 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

357 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

358 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

359 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"l£t",
c
->
¬gv
[1],c->
db
->
id
);

360 
£rv”
.
dœty
++;

363 
	`£rv”Pªic
("Unknown†istƒncoding");

365 
	}
}

367 
	$pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

368 
robj
 *
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

369 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

371 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

372 ià(
v®ue
 =ğ
NULL
) {

373 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

375 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

377 
	`addR•lyBulk
(
c
,
v®ue
);

378 
	`deüRefCouÁ
(
v®ue
);

379 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

380 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

381 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

382 
c
->
¬gv
[1],c->
db
->
id
);

383 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

385 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

386 
£rv”
.
dœty
++;

388 
	}
}

390 
	$ÍİCommªd
(
ş›Á
 *
c
) {

391 
	`pİG’”icCommªd
(
c
,
LIST_HEAD
);

392 
	}
}

394 
	$½İCommªd
(
ş›Á
 *
c
) {

395 
	`pİG’”icCommªd
(
c
,
LIST_TAIL
);

396 
	}
}

398 
	$ÌªgeCommªd
(
ş›Á
 *
c
) {

399 
robj
 *
o
;

400 
¡¬t
, 
’d
, 
Î’
, 
¿ng–’
;

402 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
C_OK
) ||

403 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
C_OK
)) ;

405 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


406 || 
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) ;

407 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

410 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

411 ià(
’d
 < 0è’d = 
Î’
+end;

412 ià(
¡¬t
 < 0) start = 0;

416 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

417 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

420 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

421 
¿ng–’
 = (
’d
-
¡¬t
)+1;

424 
	`addR•lyMuÉiBulkL’
(
c
,
¿ng–’
);

425 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

426 
li¡Ty³I‹¿tÜ
 *
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
o
, 
¡¬t
, 
LIST_TAIL
);

428 
¿ng–’
--) {

429 
li¡Ty³EÁry
 
’Œy
;

430 
	`li¡Ty³Next
(
™”
, &
’Œy
);

431 
quickli¡EÁry
 *
qe
 = &
’Œy
.entry;

432 ià(
qe
->
v®ue
) {

433 
	`addR•lyBulkCBufãr
(
c
,
qe
->
v®ue
,qe->
sz
);

435 
	`addR•lyBulkLÚgLÚg
(
c
,
qe
->
lÚgv®
);

438 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

440 
	`£rv”Pªic
("Listƒncoding is‚ot QUICKLIST!");

442 
	}
}

444 
	$ÉrimCommªd
(
ş›Á
 *
c
) {

445 
robj
 *
o
;

446 
¡¬t
, 
’d
, 
Î’
, 
Érim
, 
¹rim
;

448 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
C_OK
) ||

449 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
C_OK
)) ;

451 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
ok
)è=ğ
NULL
 ||

452 
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) ;

453 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

456 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

457 ià(
’d
 < 0è’d = 
Î’
+end;

458 ià(
¡¬t
 < 0) start = 0;

462 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

464 
Érim
 = 
Î’
;

465 
¹rim
 = 0;

467 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

468 
Érim
 = 
¡¬t
;

469 
¹rim
 = 
Î’
-
’d
-1;

473 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

474 
	`quickli¡D–Rªge
(
o
->
±r
,0,
Érim
);

475 
	`quickli¡D–Rªge
(
o
->
±r
,-
¹rim
,rtrim);

477 
	`£rv”Pªic
("Unknown†istƒncoding");

480 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Érim",
c
->
¬gv
[1],c->
db
->
id
);

481 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

482 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

483 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

485 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

486 
£rv”
.
dœty
++;

487 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

488 
	}
}

490 
	$ÌemCommªd
(
ş›Á
 *
c
) {

491 
robj
 *
subjeù
, *
obj
;

492 
obj
 = 
c
->
¬gv
[3];

493 
tÜemove
;

494 
»moved
 = 0;

496 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
tÜemove
, 
NULL
è!ğ
C_OK
))

499 
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

500 ià(
subjeù
 =ğ
NULL
 || 
	`checkTy³
(
c
,subjeù,
OBJ_LIST
)) ;

502 
li¡Ty³I‹¿tÜ
 *
li
;

503 ià(
tÜemove
 < 0) {

504 
tÜemove
 = -toremove;

505 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,-1,
LIST_HEAD
);

507 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

510 
li¡Ty³EÁry
 
’Œy
;

511 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

512 ià(
	`li¡Ty³Equ®
(&
’Œy
,
obj
)) {

513 
	`li¡Ty³D–‘e
(
li
, &
’Œy
);

514 
£rv”
.
dœty
++;

515 
»moved
++;

516 ià(
tÜemove
 && 
»moved
 ==oremove) ;

519 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

521 ià(
»moved
) {

522 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

523 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"Ìem",
c
->
¬gv
[1],c->
db
->
id
);

526 ià(
	`li¡Ty³L’gth
(
subjeù
) == 0) {

527 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

528 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

531 
	`addR•lyLÚgLÚg
(
c
,
»moved
);

532 
	}
}

550 
	$½İÍushHªdËPush
(
ş›Á
 *
c
, 
robj
 *
d¡key
,„obj *
d¡obj
,„obj *
v®ue
) {

552 ià(!
d¡obj
) {

553 
d¡obj
 = 
	`ü—‹Quickli¡Objeù
();

554 
	`quickli¡S‘O±iÚs
(
d¡obj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

555 
£rv”
.
li¡_com´ess_d•th
);

556 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

558 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

559 
	`li¡Ty³Push
(
d¡obj
,
v®ue
,
LIST_HEAD
);

560 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Íush",
d¡key
,
c
->
db
->
id
);

562 
	`addR•lyBulk
(
c
,
v®ue
);

563 
	}
}

565 
	$½İÍushCommªd
(
ş›Á
 *
c
) {

566 
robj
 *
sobj
, *
v®ue
;

567 ià((
sobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

568 
	`checkTy³
(
c
,
sobj
,
OBJ_LIST
)) ;

570 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

573 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

575 
robj
 *
dobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

576 
robj
 *
touchedkey
 = 
c
->
¬gv
[1];

578 ià(
dobj
 && 
	`checkTy³
(
c
,dobj,
OBJ_LIST
)) ;

579 
v®ue
 = 
	`li¡Ty³Pİ
(
sobj
,
LIST_TAIL
);

583 
	`šüRefCouÁ
(
touchedkey
);

584 
	`½İÍushHªdËPush
(
c
,c->
¬gv
[2],
dobj
,
v®ue
);

587 
	`deüRefCouÁ
(
v®ue
);

590 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"½İ",
touchedkey
,
c
->
db
->
id
);

591 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

592 
	`dbD–‘e
(
c
->
db
,
touchedkey
);

593 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

594 
touchedkey
,
c
->
db
->
id
);

596 
	`sigÇlModif›dKey
(
c
->
db
,
touchedkey
);

597 
	`deüRefCouÁ
(
touchedkey
);

598 
£rv”
.
dœty
++;

600 
	}
}

625 
	$blockFÜKeys
(
ş›Á
 *
c
, 
robj
 **
keys
, 
numkeys
, 
m¡ime_t
 
timeout
,„obj *
rg‘
) {

626 
diùEÁry
 *
de
;

627 
li¡
 *
l
;

628 
j
;

630 
c
->
bpİ
.
timeout
 =imeout;

631 
c
->
bpİ
.
rg‘
 =arget;

633 ià(
rg‘
 !ğ
NULL
è
	`šüRefCouÁ
(target);

635 
j
 = 0; j < 
numkeys
; j++) {

637 ià(
	`diùAdd
(
c
->
bpİ
.
keys
,keys[
j
],
NULL
è!ğ
DICT_OK
) ;

638 
	`šüRefCouÁ
(
keys
[
j
]);

641 
de
 = 
	`diùFšd
(
c
->
db
->
blockšg_keys
,
keys
[
j
]);

642 ià(
de
 =ğ
NULL
) {

643 
»tv®
;

646 
l
 = 
	`li¡C»©e
();

647 
»tv®
 = 
	`diùAdd
(
c
->
db
->
blockšg_keys
,
keys
[
j
],
l
);

648 
	`šüRefCouÁ
(
keys
[
j
]);

649 
	`£rv”As£¹W™hInfo
(
c
,
keys
[
j
],
»tv®
 =ğ
DICT_OK
);

651 
l
 = 
	`diùG‘V®
(
de
);

653 
	`li¡AddNodeTa
(
l
,
c
);

655 
	`blockCl›Á
(
c
,
BLOCKED_LIST
);

656 
	}
}

660 
	$unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
) {

661 
diùEÁry
 *
de
;

662 
diùI‹¿tÜ
 *
di
;

663 
li¡
 *
l
;

665 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`diùSize
(c->
bpİ
.
keys
) != 0);

666 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

668 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

669 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

672 
l
 = 
	`diùF‘chV®ue
(
c
->
db
->
blockšg_keys
,
key
);

673 
	`£rv”As£¹W™hInfo
(
c
,
key
,
l
 !ğ
NULL
);

674 
	`li¡D–Node
(
l
,
	`li¡S—rchKey
Ö,
c
));

676 ià(
	`li¡L’gth
(
l
) == 0)

677 
	`diùD–‘e
(
c
->
db
->
blockšg_keys
,
key
);

679 
	`diùR–—£I‹¿tÜ
(
di
);

682 
	`diùEm±y
(
c
->
bpİ
.
keys
,
NULL
);

683 ià(
c
->
bpİ
.
rg‘
) {

684 
	`deüRefCouÁ
(
c
->
bpİ
.
rg‘
);

685 
c
->
bpİ
.
rg‘
 = 
NULL
;

687 
	}
}

696 
	$sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
) {

697 
»adyLi¡
 *
¾
;

700 ià(
	`diùFšd
(
db
->
blockšg_keys
,
key
è=ğ
NULL
) ;

703 ià(
	`diùFšd
(
db
->
»ady_keys
,
key
è!ğ
NULL
) ;

706 
¾
 = 
	`zm®loc
((*rl));

707 
¾
->
key
 = key;

708 
¾
->
db
 = db;

709 
	`šüRefCouÁ
(
key
);

710 
	`li¡AddNodeTa
(
£rv”
.
»ady_keys
,
¾
);

715 
	`šüRefCouÁ
(
key
);

716 
	`£rv”As£¹
(
	`diùAdd
(
db
->
»ady_keys
,
key
,
NULL
è=ğ
DICT_OK
);

717 
	}
}

738 
	$£rveCl›ÁBlockedOnLi¡
(
ş›Á
 *
»ûiv”
, 
robj
 *
key
,„obj *
d¡key
, 
»disDb
 *
db
,„obj *
v®ue
, 
wh”e
)

740 
robj
 *
¬gv
[3];

742 ià(
d¡key
 =ğ
NULL
) {

744 
¬gv
[0] = (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 :

745 
sh¬ed
.
½İ
;

746 
¬gv
[1] = 
key
;

747 
	`´İag©e
((
wh”e
 =ğ
LIST_HEAD
) ?

748 
£rv”
.
ÍİCommªd
 : s”v”.
½İCommªd
,

749 
db
->
id
,
¬gv
,2,
PROPAGATE_AOF
|
PROPAGATE_REPL
);

752 
	`addR•lyMuÉiBulkL’
(
»ûiv”
,2);

753 
	`addR•lyBulk
(
»ûiv”
,
key
);

754 
	`addR•lyBulk
(
»ûiv”
,
v®ue
);

757 
robj
 *
d¡obj
 =

758 
	`lookupKeyWr™e
(
»ûiv”
->
db
,
d¡key
);

759 ià(!(
d¡obj
 &&

760 
	`checkTy³
(
»ûiv”
,
d¡obj
,
OBJ_LIST
)))

763 
¬gv
[0] = 
sh¬ed
.
½İ
;

764 
¬gv
[1] = 
key
;

765 
	`´İag©e
(
£rv”
.
½İCommªd
,

766 
db
->
id
,
¬gv
,2,

767 
PROPAGATE_AOF
|

768 
PROPAGATE_REPL
);

769 
	`½İÍushHªdËPush
(
»ûiv”
,
d¡key
,
d¡obj
,

770 
v®ue
);

772 
¬gv
[0] = 
sh¬ed
.
Íush
;

773 
¬gv
[1] = 
d¡key
;

774 
¬gv
[2] = 
v®ue
;

775 
	`´İag©e
(
£rv”
.
ÍushCommªd
,

776 
db
->
id
,
¬gv
,3,

777 
PROPAGATE_AOF
|

778 
PROPAGATE_REPL
);

782  
C_ERR
;

785  
C_OK
;

786 
	}
}

798 
	$hªdËCl›ÁsBlockedOnLi¡s
() {

799 
	`li¡L’gth
(
£rv”
.
»ady_keys
) != 0) {

800 
li¡
 *
l
;

806 
l
 = 
£rv”
.
»ady_keys
;

807 
£rv”
.
»ady_keys
 = 
	`li¡C»©e
();

809 
	`li¡L’gth
(
l
) != 0) {

810 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

811 
»adyLi¡
 *
¾
 = 
Ê
->
v®ue
;

815 
	`diùD–‘e
(
¾
->
db
->
»ady_keys
,¾->
key
);

819 
robj
 *
o
 = 
	`lookupKeyWr™e
(
¾
->
db
,¾->
key
);

820 ià(
o
 !ğ
NULL
 && o->
ty³
 =ğ
OBJ_LIST
) {

821 
diùEÁry
 *
de
;

825 
de
 = 
	`diùFšd
(
¾
->
db
->
blockšg_keys
,¾->
key
);

826 ià(
de
) {

827 
li¡
 *
ş›Ás
 = 
	`diùG‘V®
(
de
);

828 
numş›Ás
 = 
	`li¡L’gth
(
ş›Ás
);

830 
numş›Ás
--) {

831 
li¡Node
 *
ş›Ánode
 = 
	`li¡Fœ¡
(
ş›Ás
);

832 
ş›Á
 *
»ûiv”
 = 
ş›Ánode
->
v®ue
;

833 
robj
 *
d¡key
 = 
»ûiv”
->
bpİ
.
rg‘
;

834 
wh”e
 = (
»ûiv”
->
Ï¡cmd
 &&

835 
»ûiv”
->
Ï¡cmd
->
´oc
 =ğ
bÍİCommªd
) ?

836 
LIST_HEAD
 : 
LIST_TAIL
;

837 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

839 ià(
v®ue
) {

843 ià(
d¡key
è
	`šüRefCouÁ
(dstkey);

844 
	`unblockCl›Á
(
»ûiv”
);

846 ià(
	`£rveCl›ÁBlockedOnLi¡
(
»ûiv”
,

847 
¾
->
key
,
d¡key
,¾->
db
,
v®ue
,

848 
wh”e
è=ğ
C_ERR
)

852 
	`li¡Ty³Push
(
o
,
v®ue
,
wh”e
);

855 ià(
d¡key
è
	`deüRefCouÁ
(dstkey);

856 
	`deüRefCouÁ
(
v®ue
);

863 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

864 
	`dbD–‘e
(
¾
->
db
,¾->
key
);

871 
	`deüRefCouÁ
(
¾
->
key
);

872 
	`zä“
(
¾
);

873 
	`li¡D–Node
(
l
,
Ê
);

875 
	`li¡R–—£
(
l
);

877 
	}
}

880 
	$blockšgPİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

881 
robj
 *
o
;

882 
m¡ime_t
 
timeout
;

883 
j
;

885 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[c->
¬gc
-1],&
timeout
,
UNIT_SECONDS
)

886 !ğ
C_OK
) ;

888 
j
 = 1; j < 
c
->
¬gc
-1; j++) {

889 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]);

890 ià(
o
 !ğ
NULL
) {

891 ià(
o
->
ty³
 !ğ
OBJ_LIST
) {

892 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

895 ià(
	`li¡Ty³L’gth
(
o
) != 0) {

897 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

898 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

899 
	`£rv”As£¹
(
v®ue
 !ğ
NULL
);

901 
	`addR•lyMuÉiBulkL’
(
c
,2);

902 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

903 
	`addR•lyBulk
(
c
,
v®ue
);

904 
	`deüRefCouÁ
(
v®ue
);

905 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,

906 
c
->
¬gv
[
j
],c->
db
->
id
);

907 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

908 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
]);

909 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

910 
c
->
¬gv
[
j
],c->
db
->
id
);

912 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

913 
£rv”
.
dœty
++;

916 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,

917 (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 : sh¬ed.
½İ
,

918 
c
->
¬gv
[
j
]);

927 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

928 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

933 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, c->
¬gc
 - 2, 
timeout
, 
NULL
);

934 
	}
}

936 
	$bÍİCommªd
(
ş›Á
 *
c
) {

937 
	`blockšgPİG’”icCommªd
(
c
,
LIST_HEAD
);

938 
	}
}

940 
	$b½İCommªd
(
ş›Á
 *
c
) {

941 
	`blockšgPİG’”icCommªd
(
c
,
LIST_TAIL
);

942 
	}
}

944 
	$b½İÍushCommªd
(
ş›Á
 *
c
) {

945 
m¡ime_t
 
timeout
;

947 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
timeout
,
UNIT_SECONDS
)

948 !ğ
C_OK
) ;

950 
robj
 *
key
 = 
	`lookupKeyWr™e
(
c
->
db
, c->
¬gv
[1]);

952 ià(
key
 =ğ
NULL
) {

953 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

956 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

959 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, 1, 
timeout
, c->argv[2]);

962 ià(
key
->
ty³
 !ğ
OBJ_LIST
) {

963 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

967 
	`£rv”As£¹W™hInfo
(
c
,
key
,
	`li¡Ty³L’gth
(key) > 0);

968 
	`½İÍushCommªd
(
c
);

971 
	}
}

	@t_set.c

30 
	~"£rv”.h
"

36 
suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

37 
robj
 *
d¡key
, 
İ
);

42 
robj
 *
	$£tTy³C»©e
(
sds
 
v®ue
) {

43 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,
NULL
è=ğ
C_OK
)

44  
	`ü—‹IÁ£tObjeù
();

45  
	`ü—‹S‘Objeù
();

46 
	}
}

52 
	$£tTy³Add
(
robj
 *
subjeù
, 
sds
 
v®ue
) {

53 
Îv®
;

54 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

55 
diù
 *
ht
 = 
subjeù
->
±r
;

56 
diùEÁry
 *
de
 = 
	`diùAddRaw
(
ht
,
v®ue
);

57 ià(
de
) {

58 
	`diùS‘Key
(
ht
,
de
,
	`sdsdup
(
v®ue
));

59 
	`diùS‘V®
(
ht
,
de
,
NULL
);

62 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

63 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
C_OK
) {

64 
ušt8_t
 
sucûss
 = 0;

65 
subjeù
->
±r
 = 
	`št£tAdd
(subjeù->±r,
Îv®
,&
sucûss
);

66 ià(
sucûss
) {

69 ià(
	`št£tL’
(
subjeù
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

70 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

75 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

79 
	`£rv”As£¹
(
	`diùAdd
(
subjeù
->
±r
,
	`sdsdup
(
v®ue
),
NULL
è=ğ
DICT_OK
);

83 
	`£rv”Pªic
("Unknown setƒncoding");

86 
	}
}

88 
	$£tTy³Remove
(
robj
 *
£tobj
, 
sds
 
v®ue
) {

89 
Îv®
;

90 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

91 ià(
	`diùD–‘e
(
£tobj
->
±r
,
v®ue
è=ğ
DICT_OK
) {

92 ià(
	`htN“dsResize
(
£tobj
->
±r
)è
	`diùResize
(setobj->ptr);

95 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

96 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
C_OK
) {

97 
sucûss
;

98 
£tobj
->
±r
 = 
	`št£tRemove
(£tobj->±r,
Îv®
,&
sucûss
);

99 ià(
sucûss
)  1;

102 
	`£rv”Pªic
("Unknown setƒncoding");

105 
	}
}

107 
	$£tTy³IsMemb”
(
robj
 *
subjeù
, 
sds
 
v®ue
) {

108 
Îv®
;

109 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

110  
	`diùFšd
((
diù
*)
subjeù
->
±r
,
v®ue
è!ğ
NULL
;

111 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

112 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
C_OK
) {

113  
	`št£tFšd
((
št£t
*)
subjeù
->
±r
,
Îv®
);

116 
	`£rv”Pªic
("Unknown setƒncoding");

119 
	}
}

121 
£tTy³I‹¿tÜ
 *
	$£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

122 
£tTy³I‹¿tÜ
 *
si
 = 
	`zm®loc
((setTypeIterator));

123 
si
->
subjeù
 = subject;

124 
si
->
’codšg
 = 
subjeù
->encoding;

125 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

126 
si
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

127 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

128 
si
->
ii
 = 0;

130 
	`£rv”Pªic
("Unknown setƒncoding");

132  
si
;

133 
	}
}

135 
	$£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
) {

136 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

137 
	`diùR–—£I‹¿tÜ
(
si
->
di
);

138 
	`zä“
(
si
);

139 
	}
}

154 
	$£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
) {

155 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

156 
diùEÁry
 *
de
 = 
	`diùNext
(
si
->
di
);

157 ià(
de
 =ğ
NULL
)  -1;

158 *
sd£Ë
 = 
	`diùG‘Key
(
de
);

159 *
Î–e
 = -123456789;

160 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

161 ià(!
	`št£tG‘
(
si
->
subjeù
->
±r
,si->
ii
++,
Î–e
))

163 *
sd£Ë
 = 
NULL
;

165 
	`£rv”Pªic
("Wrong setƒncoding in setTypeNext");

167  
si
->
’codšg
;

168 
	}
}

177 
sds
 
	$£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
) {

178 
št64_t
 
š‹Ë
;

179 
sds
 
sd£Ë
;

180 
’codšg
;

182 
’codšg
 = 
	`£tTy³Next
(
si
,&
sd£Ë
,&
š‹Ë
);

183 
’codšg
) {

184 -1:  
NULL
;

185 
OBJ_ENCODING_INTSET
:

186  
	`sdsäomlÚglÚg
(
š‹Ë
);

187 
OBJ_ENCODING_HT
:

188  
	`sdsdup
(
sd£Ë
);

190 
	`£rv”Pªic
("Unsupportedƒncoding");

192  
NULL
;

193 
	}
}

208 
	$£tTy³RªdomEËm’t
(
robj
 *
£tobj
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
) {

209 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

210 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£tobj
->
±r
);

211 *
sd£Ë
 = 
	`diùG‘Key
(
de
);

212 *
Î–e
 = -123456789;

213 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

214 *
Î–e
 = 
	`št£tRªdom
(
£tobj
->
±r
);

215 *
sd£Ë
 = 
NULL
;

217 
	`£rv”Pªic
("Unknown setƒncoding");

219  
£tobj
->
’codšg
;

220 
	}
}

222 
	$£tTy³Size
(cÚ¡ 
robj
 *
subjeù
) {

223 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

224  
	`diùSize
((cÚ¡ 
diù
*)
subjeù
->
±r
);

225 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

226  
	`št£tL’
((cÚ¡ 
št£t
*)
subjeù
->
±r
);

228 
	`£rv”Pªic
("Unknown setƒncoding");

230 
	}
}

235 
	$£tTy³CÚv”t
(
robj
 *
£tobj
, 
’c
) {

236 
£tTy³I‹¿tÜ
 *
si
;

237 
	`£rv”As£¹W™hInfo
(
NULL
,
£tobj
,£tobj->
ty³
 =ğ
OBJ_SET
 &&

238 
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
);

240 ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

241 
št64_t
 
š‹Ë
;

242 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

243 
sds
 
–em’t
;

246 
	`diùEx·nd
(
d
,
	`št£tL’
(
£tobj
->
±r
));

249 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

250 
	`£tTy³Next
(
si
,&
–em’t
,&
š‹Ë
) != -1) {

251 
–em’t
 = 
	`sdsäomlÚglÚg
(
š‹Ë
);

252 
	`£rv”As£¹
(
	`diùAdd
(
d
,
–em’t
,
NULL
è=ğ
DICT_OK
);

254 
	`£tTy³R–—£I‹¿tÜ
(
si
);

256 
£tobj
->
’codšg
 = 
OBJ_ENCODING_HT
;

257 
	`zä“
(
£tobj
->
±r
);

258 
£tobj
->
±r
 = 
d
;

260 
	`£rv”Pªic
("Unsupported set conversion");

262 
	}
}

264 
	$§ddCommªd
(
ş›Á
 *
c
) {

265 
robj
 *
£t
;

266 
j
, 
added
 = 0;

268 
£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

269 ià(
£t
 =ğ
NULL
) {

270 
£t
 = 
	`£tTy³C»©e
(
c
->
¬gv
[2]->
±r
);

271 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
£t
);

273 ià(
£t
->
ty³
 !ğ
OBJ_SET
) {

274 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

279 
j
 = 2; j < 
c
->
¬gc
; j++) {

280 ià(
	`£tTy³Add
(
£t
,
c
->
¬gv
[
j
]->
±r
)è
added
++;

282 ià(
added
) {

283 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

284 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[1],c->
db
->
id
);

286 
£rv”
.
dœty
 +ğ
added
;

287 
	`addR•lyLÚgLÚg
(
c
,
added
);

288 
	}
}

290 
	$¤emCommªd
(
ş›Á
 *
c
) {

291 
robj
 *
£t
;

292 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

294 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

295 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

297 
j
 = 2; j < 
c
->
¬gc
; j++) {

298 ià(
	`£tTy³Remove
(
£t
,
c
->
¬gv
[
j
]->
±r
)) {

299 
d–‘ed
++;

300 ià(
	`£tTy³Size
(
£t
) == 0) {

301 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

302 
key»moved
 = 1;

307 ià(
d–‘ed
) {

308 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

309 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

310 ià(
key»moved
)

311 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

312 
c
->
db
->
id
);

313 
£rv”
.
dœty
 +ğ
d–‘ed
;

315 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

316 
	}
}

318 
	$smoveCommªd
(
ş›Á
 *
c
) {

319 
robj
 *
¤c£t
, *
d¡£t
, *
–e
;

320 
¤c£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

321 
d¡£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

322 
–e
 = 
c
->
¬gv
[3];

325 ià(
¤c£t
 =ğ
NULL
) {

326 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

332 ià(
	`checkTy³
(
c
,
¤c£t
,
OBJ_SET
) ||

333 (
d¡£t
 && 
	`checkTy³
(
c
,d¡£t,
OBJ_SET
))) ;

336 ià(
¤c£t
 =ğ
d¡£t
) {

337 
	`addR•ly
(
c
,
	`£tTy³IsMemb”
(
¤c£t
,
–e
->
±r
) ?

338 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

343 ià(!
	`£tTy³Remove
(
¤c£t
,
–e
->
±r
)) {

344 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

347 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

350 ià(
	`£tTy³Size
(
¤c£t
) == 0) {

351 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

352 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

356 ià(!
d¡£t
) {

357 
d¡£t
 = 
	`£tTy³C»©e
(
–e
->
±r
);

358 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
d¡£t
);

361 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

362 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

363 
£rv”
.
dœty
++;

366 ià(
	`£tTy³Add
(
d¡£t
,
–e
->
±r
)) {

367 
£rv”
.
dœty
++;

368 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[2],c->
db
->
id
);

370 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

371 
	}
}

373 
	$sismemb”Commªd
(
ş›Á
 *
c
) {

374 
robj
 *
£t
;

376 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

377 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

379 ià(
	`£tTy³IsMemb”
(
£t
,
c
->
¬gv
[2]->
±r
))

380 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

382 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

383 
	}
}

385 
	$sÿrdCommªd
(
ş›Á
 *
c
) {

386 
robj
 *
o
;

388 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

389 
	`checkTy³
(
c
,
o
,
OBJ_SET
)) ;

391 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
o
));

392 
	}
}

400 
	#SPOP_MOVE_STRATEGY_MUL
 5

	)

402 
	$¥İW™hCouÁCommªd
(
ş›Á
 *
c
) {

403 
l
;

404 
couÁ
, 
size
;

405 
robj
 *
£t
;

408 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
C_OK
) ;

409 ià(
l
 >= 0) {

410 
couÁ
 = (è
l
;

412 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

418 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
))

419 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

423 ià(
couÁ
 == 0) {

424 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

428 
size
 = 
	`£tTy³Size
(
£t
);

431 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

432 
£rv”
.
dœty
 +ğ
couÁ
;

437 ià(
couÁ
 >ğ
size
) {

439 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,1,
NULL
,
SET_OP_UNION
);

442 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

443 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

446 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
sh¬ed
.
d–
,c->
¬gv
[1]);

447 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

448 
£rv”
.
dœty
++;

455 
robj
 *
´İ¬gv
[3];

456 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("SREM",4);

457 
´İ¬gv
[1] = 
c
->
¬gv
[1];

458 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

461 
sds
 
sd£Ë
;

462 
robj
 *
obj–e
;

463 
’codšg
;

464 
št64_t
 
Î–e
;

465 
»maššg
 = 
size
-
couÁ
;

474 ià(
»maššg
*
SPOP_MOVE_STRATEGY_MUL
 > 
couÁ
) {

475 
couÁ
--) {

477 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
sd£Ë
,&
Î–e
);

478 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

479 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

480 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

481 
£t
->
±r
 = 
	`št£tRemove
(£t->±r,
Î–e
,
NULL
);

483 
	`addR•lyBulkCBufãr
(
c
,
sd£Ë
,
	`sd¦’
(sdsele));

484 
obj–e
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

485 
	`£tTy³Remove
(
£t
,
sd£Ë
);

489 
´İ¬gv
[2] = 
obj–e
;

490 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

491 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

492 
	`deüRefCouÁ
(
obj–e
);

503 
robj
 *
Ãw£t
 = 
NULL
;

506 
»maššg
--) {

507 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
sd£Ë
,&
Î–e
);

508 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

509 
sd£Ë
 = 
	`sdsäomlÚglÚg
(
Î–e
);

511 
sd£Ë
 = 
	`sdsdup
(sdsele);

513 ià(!
Ãw£t
èÃw£ˆğ
	`£tTy³C»©e
(
sd£Ë
);

514 
	`£tTy³Add
(
Ãw£t
,
sd£Ë
);

515 
	`£tTy³Remove
(
£t
,
sd£Ë
);

516 
	`sdsä“
(
sd£Ë
);

520 
	`šüRefCouÁ
(
£t
);

521 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw£t
);

524 
£tTy³I‹¿tÜ
 *
si
;

525 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

526 (
’codšg
 = 
	`£tTy³Next
(
si
,&
sd£Ë
,&
Î–e
)) != -1) {

527 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

528 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

529 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

531 
	`addR•lyBulkCBufãr
(
c
,
sd£Ë
,
	`sd¦’
(sdsele));

532 
obj–e
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

536 
´İ¬gv
[2] = 
obj–e
;

537 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

538 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

539 
	`deüRefCouÁ
(
obj–e
);

541 
	`£tTy³R–—£I‹¿tÜ
(
si
);

542 
	`deüRefCouÁ
(
£t
);

549 
	`deüRefCouÁ
(
´İ¬gv
[0]);

550 
	`´ev’tCommªdPrİag©iÚ
(
c
);

551 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

552 
£rv”
.
dœty
++;

553 
	}
}

555 
	$¥İCommªd
(
ş›Á
 *
c
) {

556 
robj
 *
£t
, *
–e
, *
aux
;

557 
sds
 
sd£Ë
;

558 
št64_t
 
Î–e
;

559 
’codšg
;

561 ià(
c
->
¬gc
 == 3) {

562 
	`¥İW™hCouÁCommªd
(
c
);

564 } ià(
c
->
¬gc
 > 3) {

565 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

571 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

572 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

575 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
sd£Ë
,&
Î–e
);

578 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

579 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

580 
£t
->
±r
 = 
	`št£tRemove
(£t->±r,
Î–e
,
NULL
);

582 
–e
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

583 
	`£tTy³Remove
(
£t
,
–e
->
±r
);

586 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

589 
aux
 = 
	`ü—‹SŒšgObjeù
("SREM",4);

590 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,3,
aux
,c->
¬gv
[1],
–e
);

591 
	`deüRefCouÁ
(
aux
);

594 
	`addR•lyBulk
(
c
,
–e
);

595 
	`deüRefCouÁ
(
–e
);

598 ià(
	`£tTy³Size
(
£t
) == 0) {

599 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

600 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

604 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

605 
£rv”
.
dœty
++;

606 
	}
}

614 
	#SRANDMEMBER_SUB_STRATEGY_MUL
 3

	)

616 
	$¤ªdmemb”W™hCouÁCommªd
(
ş›Á
 *
c
) {

617 
l
;

618 
couÁ
, 
size
;

619 
uniq
 = 1;

620 
robj
 *
£t
;

621 
sds
 
–e
;

622 
št64_t
 
Î–e
;

623 
’codšg
;

625 
diù
 *
d
;

627 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
C_OK
) ;

628 ià(
l
 >= 0) {

629 
couÁ
 = (è
l
;

633 
couÁ
 = -
l
;

634 
uniq
 = 0;

637 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
))

638 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

639 
size
 = 
	`£tTy³Size
(
£t
);

642 ià(
couÁ
 == 0) {

643 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

651 ià(!
uniq
) {

652 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

653 
couÁ
--) {

654 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

655 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

656 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

658 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

667 ià(
couÁ
 >ğ
size
) {

668 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,1,
NULL
,
SET_OP_UNION
);

673 
d
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

684 ià(
couÁ
*
SRANDMEMBER_SUB_STRATEGY_MUL
 > 
size
) {

685 
£tTy³I‹¿tÜ
 *
si
;

688 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

689 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–e
,&
Î–e
)) != -1) {

690 
»tv®
 = 
DICT_ERR
;

692 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

693 
»tv®
 = 
	`diùAdd
(
d
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
),
NULL
);

695 
»tv®
 = 
	`diùAdd
(
d
,
	`ü—‹SŒšgObjeù
(
–e
,
	`sd¦’
ÓË)),
NULL
);

697 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

699 
	`£tTy³R–—£I‹¿tÜ
(
si
);

700 
	`£rv”As£¹
(
	`diùSize
(
d
è=ğ
size
);

703 
size
 > 
couÁ
) {

704 
diùEÁry
 *
de
;

706 
de
 = 
	`diùG‘RªdomKey
(
d
);

707 
	`diùD–‘e
(
d
,
	`diùG‘Key
(
de
));

708 
size
--;

717 
added
 = 0;

718 
robj
 *
obj–e
;

720 
added
 < 
couÁ
) {

721 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

722 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

723 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

725 
obj–e
 = 
	`ü—‹SŒšgObjeù
(
–e
,
	`sd¦’
(ele));

730 ià(
	`diùAdd
(
d
,
obj–e
,
NULL
è=ğ
DICT_OK
)

731 
added
++;

733 
	`deüRefCouÁ
(
obj–e
);

739 
diùI‹¿tÜ
 *
di
;

740 
diùEÁry
 *
de
;

742 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

743 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

744 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

745 
	`addR•lyBulk
(
c
,
	`diùG‘Key
(
de
));

746 
	`diùR–—£I‹¿tÜ
(
di
);

747 
	`diùR–—£
(
d
);

749 
	}
}

751 
	$¤ªdmemb”Commªd
(
ş›Á
 *
c
) {

752 
robj
 *
£t
;

753 
sds
 
–e
;

754 
št64_t
 
Î–e
;

755 
’codšg
;

757 ià(
c
->
¬gc
 == 3) {

758 
	`¤ªdmemb”W™hCouÁCommªd
(
c
);

760 } ià(
c
->
¬gc
 > 3) {

761 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

765 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

766 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

768 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

769 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

770 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

772 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

774 
	}
}

776 
	$qsÜtCom·»S‘sByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

777  
	`£tTy³Size
(*(
robj
**)
s1
)-£tTy³Size(*Ôobj**)
s2
);

778 
	}
}

782 
	$qsÜtCom·»S‘sByRevC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

783 
robj
 *
o1
 = *Ôobj**)
s1
, *
o2
 = *Ôobj**)
s2
;

785  (
o2
 ? 
	`£tTy³Size
(o2è: 0è- (
o1
 ? setTypeSize(o1) : 0);

786 
	}
}

788 
	$sš‹rG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
,

789 
£Šum
, 
robj
 *
d¡key
) {

790 
robj
 **
£ts
 = 
	`zm®loc
(Ôobj*)*
£Šum
);

791 
£tTy³I‹¿tÜ
 *
si
;

792 
robj
 *
d¡£t
 = 
NULL
;

793 
sds
 
–esds
;

794 
št64_t
 
štobj
;

795 *
»¶yËn
 = 
NULL
;

796 
j
, 
ÿrdš®™y
 = 0;

797 
’codšg
;

799 
j
 = 0; j < 
£Šum
; j++) {

800 
robj
 *
£tobj
 = 
d¡key
 ?

801 
	`lookupKeyWr™e
(
c
->
db
,
£tkeys
[
j
]) :

802 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

803 ià(!
£tobj
) {

804 
	`zä“
(
£ts
);

805 ià(
d¡key
) {

806 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

807 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

808 
£rv”
.
dœty
++;

810 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

812 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

816 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

817 
	`zä“
(
£ts
);

820 
£ts
[
j
] = 
£tobj
;

824 
	`qsÜt
(
£ts
,
£Šum
,(
robj
*),
qsÜtCom·»S‘sByC¬dš®™y
);

831 ià(!
d¡key
) {

832 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

836 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

842 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[0]);

843 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–esds
,&
štobj
)) != -1) {

844 
j
 = 1; j < 
£Šum
; j++) {

845 ià(
£ts
[
j
] == sets[0]) ;

846 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

848 ià(
£ts
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_INTSET
 &&

849 !
	`št£tFšd
((
št£t
*)
£ts
[
j
]->
±r
,
štobj
))

855 } ià(
£ts
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

856 
–esds
 = 
	`sdsäomlÚglÚg
(
štobj
);

857 ià(!
	`£tTy³IsMemb”
(
£ts
[
j
],
–esds
)) {

858 
	`sdsä“
(
–esds
);

861 
	`sdsä“
(
–esds
);

863 } ià(
’codšg
 =ğ
OBJ_ENCODING_HT
) {

864 ià(!
	`£tTy³IsMemb”
(
£ts
[
j
],
–esds
)) {

871 ià(
j
 =ğ
£Šum
) {

872 ià(!
d¡key
) {

873 ià(
’codšg
 =ğ
OBJ_ENCODING_HT
)

874 
	`addR•lyBulkCBufãr
(
c
,
–esds
,
	`sd¦’
(elesds));

876 
	`addR•lyBulkLÚgLÚg
(
c
,
štobj
);

877 
ÿrdš®™y
++;

879 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

880 
–esds
 = 
	`sdsäomlÚglÚg
(
štobj
);

881 
	`£tTy³Add
(
d¡£t
,
–esds
);

882 
	`sdsä“
(
–esds
);

884 
	`£tTy³Add
(
d¡£t
,
–esds
);

889 
	`£tTy³R–—£I‹¿tÜ
(
si
);

891 ià(
d¡key
) {

894 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

895 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

896 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

897 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

898 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"sinterstore",

899 
d¡key
,
c
->
db
->
id
);

901 
	`deüRefCouÁ
(
d¡£t
);

902 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

903 ià(
d–‘ed
)

904 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

905 
d¡key
,
c
->
db
->
id
);

907 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

908 
£rv”
.
dœty
++;

910 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
ÿrdš®™y
);

912 
	`zä“
(
£ts
);

913 
	}
}

915 
	$sš‹rCommªd
(
ş›Á
 *
c
) {

916 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
);

917 
	}
}

919 
	$sš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

920 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->argv[1]);

921 
	}
}

923 
	#SET_OP_UNION
 0

	)

924 
	#SET_OP_DIFF
 1

	)

925 
	#SET_OP_INTER
 2

	)

927 
	$suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

928 
robj
 *
d¡key
, 
İ
) {

929 
robj
 **
£ts
 = 
	`zm®loc
(Ôobj*)*
£Šum
);

930 
£tTy³I‹¿tÜ
 *
si
;

931 
robj
 *
d¡£t
 = 
NULL
;

932 
sds
 
–e
;

933 
j
, 
ÿrdš®™y
 = 0;

934 
diff_®go
 = 1;

936 
j
 = 0; j < 
£Šum
; j++) {

937 
robj
 *
£tobj
 = 
d¡key
 ?

938 
	`lookupKeyWr™e
(
c
->
db
,
£tkeys
[
j
]) :

939 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

940 ià(!
£tobj
) {

941 
£ts
[
j
] = 
NULL
;

944 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

945 
	`zä“
(
£ts
);

948 
£ts
[
j
] = 
£tobj
;

960 ià(
İ
 =ğ
SET_OP_DIFF
 && 
£ts
[0]) {

961 
®go_Úe_wÜk
 = 0, 
®go_two_wÜk
 = 0;

963 
j
 = 0; j < 
£Šum
; j++) {

964 ià(
£ts
[
j
] =ğ
NULL
) ;

966 
®go_Úe_wÜk
 +ğ
	`£tTy³Size
(
£ts
[0]);

967 
®go_two_wÜk
 +ğ
	`£tTy³Size
(
£ts
[
j
]);

972 
®go_Úe_wÜk
 /= 2;

973 
diff_®go
 = (
®go_Úe_wÜk
 <ğ
®go_two_wÜk
) ? 1 : 2;

975 ià(
diff_®go
 =ğ1 && 
£Šum
 > 1) {

979 
	`qsÜt
(
£ts
+1,
£Šum
-1,(
robj
*),

980 
qsÜtCom·»S‘sByRevC¬dš®™y
);

987 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

989 ià(
İ
 =ğ
SET_OP_UNION
) {

992 
j
 = 0; j < 
£Šum
; j++) {

993 ià(!
£ts
[
j
]) ;

995 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[
j
]);

996 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

997 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

998 
	`sdsä“
(
–e
);

1000 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1002 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
£ts
[0] && 
diff_®go
 == 1) {

1011 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[0]);

1012 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1013 
j
 = 1; j < 
£Šum
; j++) {

1014 ià(!
£ts
[
j
]) ;

1015 ià(
£ts
[
j
] == sets[0]) ;

1016 ià(
	`£tTy³IsMemb”
(
£ts
[
j
],
–e
)) ;

1018 ià(
j
 =ğ
£Šum
) {

1020 
	`£tTy³Add
(
d¡£t
,
–e
);

1021 
ÿrdš®™y
++;

1023 
	`sdsä“
(
–e
);

1025 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1026 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
£ts
[0] && 
diff_®go
 == 2) {

1034 
j
 = 0; j < 
£Šum
; j++) {

1035 ià(!
£ts
[
j
]) ;

1037 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[
j
]);

1038 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1039 ià(
j
 == 0) {

1040 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

1042 ià(
	`£tTy³Remove
(
d¡£t
,
–e
)è
ÿrdš®™y
--;

1044 
	`sdsä“
(
–e
);

1046 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1050 ià(
ÿrdš®™y
 == 0) ;

1055 ià(!
d¡key
) {

1056 
	`addR•lyMuÉiBulkL’
(
c
,
ÿrdš®™y
);

1057 
si
 = 
	`£tTy³In™I‹¿tÜ
(
d¡£t
);

1058 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1059 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

1060 
	`sdsä“
(
–e
);

1062 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1063 
	`deüRefCouÁ
(
d¡£t
);

1067 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

1068 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

1069 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

1070 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

1071 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,

1072 
İ
 =ğ
SET_OP_UNION
 ? "sunionstore" : "sdiffstore",

1073 
d¡key
,
c
->
db
->
id
);

1075 
	`deüRefCouÁ
(
d¡£t
);

1076 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1077 ià(
d–‘ed
)

1078 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

1079 
d¡key
,
c
->
db
->
id
);

1081 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

1082 
£rv”
.
dœty
++;

1084 
	`zä“
(
£ts
);

1085 
	}
}

1087 
	$suniÚCommªd
(
ş›Á
 *
c
) {

1088 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_UNION
);

1089 
	}
}

1091 
	$suniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

1092 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_UNION
);

1093 
	}
}

1095 
	$sdiffCommªd
(
ş›Á
 *
c
) {

1096 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_DIFF
);

1097 
	}
}

1099 
	$sdiff¡ÜeCommªd
(
ş›Á
 *
c
) {

1100 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_DIFF
);

1101 
	}
}

1103 
	$ssÿnCommªd
(
ş›Á
 *
c
) {

1104 
robj
 *
£t
;

1105 
cursÜ
;

1107 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
C_ERR
) ;

1108 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

1109 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

1110 
	`sÿnG’”icCommªd
(
c
,
£t
,
cursÜ
);

1111 
	}
}

	@t_string.c

30 
	~"£rv”.h
"

31 
	~<m©h.h
>

37 
	$checkSŒšgL’gth
(
ş›Á
 *
c
, 
size
) {

38 ià(
size
 > 512*1024*1024) {

39 
	`addR•lyE¼Ü
(
c
,"stringƒxceeds maximum‡llowed size (512MB)");

40  
C_ERR
;

42  
C_OK
;

43 
	}
}

61 
	#OBJ_SET_NO_FLAGS
 0

	)

62 
	#OBJ_SET_NX
 (1<<0è

	)

63 
	#OBJ_SET_XX
 (1<<1è

	)

64 
	#OBJ_SET_EX
 (1<<2è

	)

65 
	#OBJ_SET_PX
 (1<<3è

	)

67 
	$£tG’”icCommªd
(
ş›Á
 *
c
, 
æags
, 
robj
 *
key
,„obj *
v®
,„obj *
expœe
, 
un™
,„obj *
ok_»¶y
,„obj *
abÜt_»¶y
) {

68 
mli£cÚds
 = 0;

70 ià(
expœe
) {

71 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
expœe
, &
mli£cÚds
, 
NULL
è!ğ
C_OK
)

73 ià(
mli£cÚds
 <= 0) {

74 
	`addR•lyE¼ÜFÜm©
(
c
,"šv®idƒxpœtimš %s",c->
cmd
->
Çme
);

77 ià(
un™
 =ğ
UNIT_SECONDS
è
mli£cÚds
 *= 1000;

80 ià((
æags
 & 
OBJ_SET_NX
 && 
	`lookupKeyWr™e
(
c
->
db
,
key
è!ğ
NULL
) ||

81 (
æags
 & 
OBJ_SET_XX
 && 
	`lookupKeyWr™e
(
c
->
db
,
key
è=ğ
NULL
))

83 
	`addR•ly
(
c
, 
abÜt_»¶y
 ?‡bÜt_»¶y : 
sh¬ed
.
nuÎbulk
);

86 
	`£tKey
(
c
->
db
,
key
,
v®
);

87 
£rv”
.
dœty
++;

88 ià(
expœe
è
	`£tExpœe
(
c
->
db
,
key
,
	`m¡ime
()+
mli£cÚds
);

89 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
key
,
c
->
db
->
id
);

90 ià(
expœe
è
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

91 "expœe",
key
,
c
->
db
->
id
);

92 
	`addR•ly
(
c
, 
ok_»¶y
 ? ok_»¶y : 
sh¬ed
.
ok
);

93 
	}
}

96 
	$£tCommªd
(
ş›Á
 *
c
) {

97 
j
;

98 
robj
 *
expœe
 = 
NULL
;

99 
un™
 = 
UNIT_SECONDS
;

100 
æags
 = 
OBJ_SET_NO_FLAGS
;

102 
j
 = 3; j < 
c
->
¬gc
; j++) {

103 *
a
 = 
c
->
¬gv
[
j
]->
±r
;

104 
robj
 *
Ãxt
 = (
j
 =ğ
c
->
¬gc
-1è? 
NULL
 : c->
¬gv
[j+1];

106 ià((
a
[0] == 'n' ||‡[0] == 'N') &&

107 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

108 !(
æags
 & 
OBJ_SET_XX
))

110 
æags
 |ğ
OBJ_SET_NX
;

111 } ià((
a
[0] == 'x' ||‡[0] == 'X') &&

112 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

113 !(
æags
 & 
OBJ_SET_NX
))

115 
æags
 |ğ
OBJ_SET_XX
;

116 } ià((
a
[0] == 'e' ||‡[0] == 'E') &&

117 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

118 !(
æags
 & 
OBJ_SET_PX
è&& 
Ãxt
)

120 
æags
 |ğ
OBJ_SET_EX
;

121 
un™
 = 
UNIT_SECONDS
;

122 
expœe
 = 
Ãxt
;

123 
j
++;

124 } ià((
a
[0] == 'p' ||‡[0] == 'P') &&

125 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

126 !(
æags
 & 
OBJ_SET_EX
è&& 
Ãxt
)

128 
æags
 |ğ
OBJ_SET_PX
;

129 
un™
 = 
UNIT_MILLISECONDS
;

130 
expœe
 = 
Ãxt
;

131 
j
++;

133 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

138 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

139 
	`£tG’”icCommªd
(
c
,
æags
,c->
¬gv
[1],c->¬gv[2],
expœe
,
un™
,
NULL
,NULL);

140 
	}
}

142 
	$£ŠxCommªd
(
ş›Á
 *
c
) {

143 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

144 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NX
,c->
¬gv
[1],c->¬gv[2],
NULL
,0,
sh¬ed
.
cÚe
,sh¬ed.
cz”o
);

145 
	}
}

147 
	$£‹xCommªd
(
ş›Á
 *
c
) {

148 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

149 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_SECONDS
,
NULL
,NULL);

150 
	}
}

152 
	$p£‹xCommªd
(
ş›Á
 *
c
) {

153 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

154 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_MILLISECONDS
,
NULL
,NULL);

155 
	}
}

157 
	$g‘G’”icCommªd
(
ş›Á
 *
c
) {

158 
robj
 *
o
;

160 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
)

161  
C_OK
;

163 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

164 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

165  
C_ERR
;

167 
	`addR•lyBulk
(
c
,
o
);

168  
C_OK
;

170 
	}
}

172 
	$g‘Commªd
(
ş›Á
 *
c
) {

173 
	`g‘G’”icCommªd
(
c
);

174 
	}
}

176 
	$g‘£tCommªd
(
ş›Á
 *
c
) {

177 ià(
	`g‘G’”icCommªd
(
c
è=ğ
C_ERR
) ;

178 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

179 
	`£tKey
(
c
->
db
,c->
¬gv
[1],c->argv[2]);

180 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[1],c->
db
->
id
);

181 
£rv”
.
dœty
++;

182 
	}
}

184 
	$£ŒªgeCommªd
(
ş›Á
 *
c
) {

185 
robj
 *
o
;

186 
off£t
;

187 
sds
 
v®ue
 = 
c
->
¬gv
[3]->
±r
;

189 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
off£t
,
NULL
è!ğ
C_OK
)

192 ià(
off£t
 < 0) {

193 
	`addR•lyE¼Ü
(
c
,"offset is out of„ange");

197 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

198 ià(
o
 =ğ
NULL
) {

200 ià(
	`sd¦’
(
v®ue
) == 0) {

201 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

206 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
C_OK
)

209 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
off£t
+
	`sd¦’
(
v®ue
)));

210 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

212 
size_t
 
Ş’
;

215 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

219 
Ş’
 = 
	`¡ršgObjeùL’
(
o
);

220 ià(
	`sd¦’
(
v®ue
) == 0) {

221 
	`addR•lyLÚgLÚg
(
c
,
Ş’
);

226 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
C_OK
)

230 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

233 ià(
	`sd¦’
(
v®ue
) > 0) {

234 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
off£t
+
	`sd¦’
(
v®ue
));

235 
	`memıy
((*)
o
->
±r
+
off£t
,
v®ue
,
	`sd¦’
(value));

236 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

237 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,

238 "£Œªge",
c
->
¬gv
[1],c->
db
->
id
);

239 
£rv”
.
dœty
++;

241 
	`addR•lyLÚgLÚg
(
c
,
	`sd¦’
(
o
->
±r
));

242 
	}
}

244 
	$g‘¿ngeCommªd
(
ş›Á
 *
c
) {

245 
robj
 *
o
;

246 
¡¬t
, 
’d
;

247 *
¡r
, 
Îbuf
[32];

248 
size_t
 
¡¾’
;

250 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
C_OK
)

252 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
C_OK
)

254 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ybulk
)è=ğ
NULL
 ||

255 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

257 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

258 
¡r
 = 
Îbuf
;

259 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

261 
¡r
 = 
o
->
±r
;

262 
¡¾’
 = 
	`sd¦’
(
¡r
);

266 ià(
¡¬t
 < 0 && 
’d
 < 0 && start >ƒnd) {

267 
	`addR•ly
(
c
,
sh¬ed
.
em±ybulk
);

270 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

271 ià(
’d
 < 0è’d = 
¡¾’
+end;

272 ià(
¡¬t
 < 0) start = 0;

273 ià(
’d
 < 0)ƒnd = 0;

274 ià(()
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

278 ià(
¡¬t
 > 
’d
 || 
¡¾’
 == 0) {

279 
	`addR•ly
(
c
,
sh¬ed
.
em±ybulk
);

281 
	`addR•lyBulkCBufãr
(
c
,(*)
¡r
+
¡¬t
,
’d
-start+1);

283 
	}
}

285 
	$mg‘Commªd
(
ş›Á
 *
c
) {

286 
j
;

288 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-1);

289 
j
 = 1; j < 
c
->
¬gc
; j++) {

290 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

291 ià(
o
 =ğ
NULL
) {

292 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

294 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

295 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

297 
	`addR•lyBulk
(
c
,
o
);

301 
	}
}

303 
	$m£tG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

304 
j
, 
busykeys
 = 0;

306 ià((
c
->
¬gc
 % 2) == 0) {

307 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for MSET");

312 ià(
nx
) {

313 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

314 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]è!ğ
NULL
) {

315 
busykeys
++;

318 ià(
busykeys
) {

319 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

324 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

325 
c
->
¬gv
[
j
+1] = 
	`ŒyObjeùEncodšg
(c->argv[j+1]);

326 
	`£tKey
(
c
->
db
,c->
¬gv
[
j
],c->argv[j+1]);

327 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[
j
],c->
db
->
id
);

329 
£rv”
.
dœty
 +ğ(
c
->
¬gc
-1)/2;

330 
	`addR•ly
(
c
, 
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

331 
	}
}

333 
	$m£tCommªd
(
ş›Á
 *
c
) {

334 
	`m£tG’”icCommªd
(
c
,0);

335 
	}
}

337 
	$m£ŠxCommªd
(
ş›Á
 *
c
) {

338 
	`m£tG’”icCommªd
(
c
,1);

339 
	}
}

341 
	$šüDeüCommªd
(
ş›Á
 *
c
, 
šü
) {

342 
v®ue
, 
Şdv®ue
;

343 
robj
 *
o
, *
Ãw
;

345 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

346 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)) ;

347 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
C_OK
) ;

349 
Şdv®ue
 = 
v®ue
;

350 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

351 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

352 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

355 
v®ue
 +ğ
šü
;

357 ià(
o
 && o->
»fcouÁ
 =ğ1 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

358 (
v®ue
 < 0 || v®u>ğ
OBJ_SHARED_INTEGERS
) &&

359 
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
)

361 
Ãw
 = 
o
;

362 
o
->
±r
 = (*)(()
v®ue
);

364 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

365 ià(
o
) {

366 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

368 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

371 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

372 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šüby",
c
->
¬gv
[1],c->
db
->
id
);

373 
£rv”
.
dœty
++;

374 
	`addR•ly
(
c
,
sh¬ed
.
cŞÚ
);

375 
	`addR•ly
(
c
,
Ãw
);

376 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

377 
	}
}

379 
	$šüCommªd
(
ş›Á
 *
c
) {

380 
	`šüDeüCommªd
(
c
,1);

381 
	}
}

383 
	$deüCommªd
(
ş›Á
 *
c
) {

384 
	`šüDeüCommªd
(
c
,-1);

385 
	}
}

387 
	$šübyCommªd
(
ş›Á
 *
c
) {

388 
šü
;

390 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
C_OK
) ;

391 
	`šüDeüCommªd
(
c
,
šü
);

392 
	}
}

394 
	$deübyCommªd
(
ş›Á
 *
c
) {

395 
šü
;

397 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
C_OK
) ;

398 
	`šüDeüCommªd
(
c
,-
šü
);

399 
	}
}

401 
	$šübyæßtCommªd
(
ş›Á
 *
c
) {

402 
šü
, 
v®ue
;

403 
robj
 *
o
, *
Ãw
, *
aux
;

405 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

406 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)) ;

407 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
C_OK
 ||

408 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
šü
,
NULL
è!ğ
C_OK
)

411 
v®ue
 +ğ
šü
;

412 ià(
	`i¢ª
(
v®ue
è|| 
	`isšf
(value)) {

413 
	`addR•lyE¼Ü
(
c
,"increment would…roduce NaN or Infinity");

416 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

417 ià(
o
)

418 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

420 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

421 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

422 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

423 
£rv”
.
dœty
++;

424 
	`addR•lyBulk
(
c
,
Ãw
);

429 
aux
 = 
	`ü—‹SŒšgObjeù
("SET",3);

430 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

431 
	`deüRefCouÁ
(
aux
);

432 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,2,
Ãw
);

433 
	}
}

435 
	$­³ndCommªd
(
ş›Á
 *
c
) {

436 
size_t
 
tÙËn
;

437 
robj
 *
o
, *
­³nd
;

439 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

440 ià(
o
 =ğ
NULL
) {

442 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

443 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],c->argv[2]);

444 
	`šüRefCouÁ
(
c
->
¬gv
[2]);

445 
tÙËn
 = 
	`¡ršgObjeùL’
(
c
->
¬gv
[2]);

448 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

452 
­³nd
 = 
c
->
¬gv
[2];

453 
tÙËn
 = 
	`¡ršgObjeùL’
(
o
)+
	`sd¦’
(
­³nd
->
±r
);

454 ià(
	`checkSŒšgL’gth
(
c
,
tÙËn
è!ğ
C_OK
)

458 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

459 
o
->
±r
 = 
	`sdsÿ’
(o->±r,
­³nd
->±r,
	`sd¦’
(append->ptr));

460 
tÙËn
 = 
	`sd¦’
(
o
->
±r
);

462 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

463 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"­³nd",
c
->
¬gv
[1],c->
db
->
id
);

464 
£rv”
.
dœty
++;

465 
	`addR•lyLÚgLÚg
(
c
,
tÙËn
);

466 
	}
}

468 
	$¡¾’Commªd
(
ş›Á
 *
c
) {

469 
robj
 *
o
;

470 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

471 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

472 
	`addR•lyLÚgLÚg
(
c
,
	`¡ršgObjeùL’
(
o
));

473 
	}
}

	@t_zset.c

59 
	~"£rv”.h
"

60 
	~<m©h.h
>

66 
z¦LexV®ueG‹Mš
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

67 
z¦LexV®ueL‹Max
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

71 
zskli¡Node
 *
	$z¦C»©eNode
(
Ëv–
, 
scÜe
, 
sds
 
–e
) {

72 
zskli¡Node
 *
zn
 =

73 
	`zm®loc
((*
zn
)+
Ëv–
*(
zskli¡Lev–
));

74 
zn
->
scÜe
 = score;

75 
zn
->
–e
 =ƒle;

76  
zn
;

77 
	}
}

80 
zskli¡
 *
	$z¦C»©e
() {

81 
j
;

82 
zskli¡
 *
z¦
;

84 
z¦
 = 
	`zm®loc
((*zsl));

85 
z¦
->
Ëv–
 = 1;

86 
z¦
->
Ëngth
 = 0;

87 
z¦
->
h—d”
 = 
	`z¦C»©eNode
(
ZSKIPLIST_MAXLEVEL
,0,
NULL
);

88 
j
 = 0; j < 
ZSKIPLIST_MAXLEVEL
; j++) {

89 
z¦
->
h—d”
->
Ëv–
[
j
].
fÜw¬d
 = 
NULL
;

90 
z¦
->
h—d”
->
Ëv–
[
j
].
¥ª
 = 0;

92 
z¦
->
h—d”
->
backw¬d
 = 
NULL
;

93 
z¦
->

 = 
NULL
;

94  
z¦
;

95 
	}
}

100 
	$z¦F»eNode
(
zskli¡Node
 *
node
) {

101 
	`sdsä“
(
node
->
–e
);

102 
	`zä“
(
node
);

103 
	}
}

106 
	$z¦F»e
(
zskli¡
 *
z¦
) {

107 
zskli¡Node
 *
node
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
, *
Ãxt
;

109 
	`zä“
(
z¦
->
h—d”
);

110 
node
) {

111 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

112 
	`z¦F»eNode
(
node
);

113 
node
 = 
Ãxt
;

115 
	`zä“
(
z¦
);

116 
	}
}

122 
	$z¦RªdomLev–
() {

123 
Ëv–
 = 1;

124 (
	`¿ndom
()&0xFFFFè< (
ZSKIPLIST_P
 * 0xFFFF))

125 
Ëv–
 += 1;

126  (
Ëv–
<
ZSKIPLIST_MAXLEVEL
) ?†evel : ZSKIPLIST_MAXLEVEL;

127 
	}
}

132 
zskli¡Node
 *
	$z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
) {

133 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

134 
¿nk
[
ZSKIPLIST_MAXLEVEL
];

135 
i
, 
Ëv–
;

137 
	`£rv”As£¹
(!
	`i¢ª
(
scÜe
));

138 
x
 = 
z¦
->
h—d”
;

139 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

141 
¿nk
[
i
] = i =ğ(
z¦
->
Ëv–
-1) ? 0 :„ank[i+1];

142 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

143 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

144 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

145 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) < 0)))

147 
¿nk
[
i
] +ğ
x
->
Ëv–
[i].
¥ª
;

148 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

150 
upd©e
[
i
] = 
x
;

156 
Ëv–
 = 
	`z¦RªdomLev–
();

157 ià(
Ëv–
 > 
z¦
->level) {

158 
i
 = 
z¦
->
Ëv–
; i <†evel; i++) {

159 
¿nk
[
i
] = 0;

160 
upd©e
[
i
] = 
z¦
->
h—d”
;

161 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = 
z¦
->
Ëngth
;

163 
z¦
->
Ëv–
 =†evel;

165 
x
 = 
	`z¦C»©eNode
(
Ëv–
,
scÜe
,
–e
);

166 
i
 = 0; i < 
Ëv–
; i++) {

167 
x
->
Ëv–
[
i
].
fÜw¬d
 = 
upd©e
[i]->level[i].forward;

168 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
;

171 
x
->
Ëv–
[
i
].
¥ª
 = 
upd©e
[i]->Ëv–[i].¥ª - (
¿nk
[0] -„ank[i]);

172 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = (
¿nk
[0] -„ank[i]) + 1;

176 
i
 = 
Ëv–
; i < 
z¦
->level; i++) {

177 
upd©e
[
i
]->
Ëv–
[i].
¥ª
++;

180 
x
->
backw¬d
 = (
upd©e
[0] =ğ
z¦
->
h—d”
è? 
NULL
 : update[0];

181 ià(
x
->
Ëv–
[0].
fÜw¬d
)

182 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x;

184 
z¦
->

 = 
x
;

185 
z¦
->
Ëngth
++;

186  
x
;

187 
	}
}

190 
	$z¦D–‘eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
x
, zskli¡Nod**
upd©e
) {

191 
i
;

192 
i
 = 0; i < 
z¦
->
Ëv–
; i++) {

193 ià(
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 =ğ
x
) {

194 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 +ğ
x
->level[i].span - 1;

195 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
->level[i].forward;

197 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 -= 1;

200 ià(
x
->
Ëv–
[0].
fÜw¬d
) {

201 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x->backward;

203 
z¦
->

 = 
x
->
backw¬d
;

205 
z¦
->
Ëv–
 > 1 && z¦->
h—d”
->Ëv–[z¦->Ëv–-1].
fÜw¬d
 =ğ
NULL
)

206 
z¦
->
Ëv–
--;

207 
z¦
->
Ëngth
--;

208 
	}
}

218 
	$z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
, 
zskli¡Node
 **
node
) {

219 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

220 
i
;

222 
x
 = 
z¦
->
h—d”
;

223 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

224 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

225 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

226 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

227 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) < 0)))

229 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

231 
upd©e
[
i
] = 
x
;

235 
x
 = x->
Ëv–
[0].
fÜw¬d
;

236 ià(
x
 && 
scÜe
 =ğx->scÜ&& 
	`sdscmp
(x->
–e
,ele) == 0) {

237 
	`z¦D–‘eNode
(
z¦
, 
x
, 
upd©e
);

238 ià(!
node
)

239 
	`z¦F»eNode
(
x
);

241 *
node
 = 
x
;

245 
	}
}

247 
	$z¦V®ueG‹Mš
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

248  
¥ec
->
mšex
 ? (
v®ue
 > s³c->
mš
) : (value >= spec->min);

249 
	}
}

251 
	$z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

252  
¥ec
->
maxex
 ? (
v®ue
 < s³c->
max
) : (value <= spec->max);

253 
	}
}

256 
	$z¦IsInRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

257 
zskli¡Node
 *
x
;

260 ià(
¿nge
->
mš
 >„ªge->
max
 ||

261 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

263 
x
 = 
z¦
->

;

264 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueG‹Mš
(x->
scÜe
,
¿nge
))

266 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

267 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueL‹Max
(x->
scÜe
,
¿nge
))

270 
	}
}

274 
zskli¡Node
 *
	$z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

275 
zskli¡Node
 *
x
;

276 
i
;

279 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

281 
x
 = 
z¦
->
h—d”
;

282 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

284 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

285 !
	`z¦V®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

286 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

290 
x
 = x->
Ëv–
[0].
fÜw¬d
;

291 
	`£rv”As£¹
(
x
 !ğ
NULL
);

294 ià(!
	`z¦V®ueL‹Max
(
x
->
scÜe
,
¿nge
)è 
NULL
;

295  
x
;

296 
	}
}

300 
zskli¡Node
 *
	$z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

301 
zskli¡Node
 *
x
;

302 
i
;

305 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

307 
x
 = 
z¦
->
h—d”
;

308 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

310 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

311 
	`z¦V®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

312 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

316 
	`£rv”As£¹
(
x
 !ğ
NULL
);

319 ià(!
	`z¦V®ueG‹Mš
(
x
->
scÜe
,
¿nge
)è 
NULL
;

320  
x
;

321 
	}
}

327 
	$z¦D–‘eRªgeByScÜe
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

328 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

329 
»moved
 = 0;

330 
i
;

332 
x
 = 
z¦
->
h—d”
;

333 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

334 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
¿nge
->
mšex
 ?

335 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 <ğ
¿nge
->
mš
 :

336 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < 
¿nge
->
mš
))

337 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

338 
upd©e
[
i
] = 
x
;

342 
x
 = x->
Ëv–
[0].
fÜw¬d
;

345 
x
 &&

346 (
¿nge
->
maxex
 ? 
x
->
scÜe
 <„ªge->
max
 : x->score <=„ange->max))

348 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

349 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

350 
	`diùD–‘e
(
diù
,
x
->
–e
);

351 
	`z¦F»eNode
(
x
);

352 
»moved
++;

353 
x
 = 
Ãxt
;

355  
»moved
;

356 
	}
}

358 
	$z¦D–‘eRªgeByLex
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

359 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

360 
»moved
 = 0;

361 
i
;

364 
x
 = 
z¦
->
h—d”
;

365 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

366 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

367 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,
¿nge
))

368 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

369 
upd©e
[
i
] = 
x
;

373 
x
 = x->
Ëv–
[0].
fÜw¬d
;

376 
x
 && 
	`z¦LexV®ueL‹Max
(x->
–e
,
¿nge
)) {

377 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

378 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

379 
	`diùD–‘e
(
diù
,
x
->
–e
);

380 
	`z¦F»eNode
(
x
);

381 
»moved
++;

382 
x
 = 
Ãxt
;

384  
»moved
;

385 
	}
}

389 
	$z¦D–‘eRªgeByRªk
(
zskli¡
 *
z¦
, 
¡¬t
, 
’d
, 
diù
 *dict) {

390 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

391 
Œav”£d
 = 0, 
»moved
 = 0;

392 
i
;

394 
x
 = 
z¦
->
h—d”
;

395 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

396 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è< 
¡¬t
) {

397 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

398 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

400 
upd©e
[
i
] = 
x
;

403 
Œav”£d
++;

404 
x
 = x->
Ëv–
[0].
fÜw¬d
;

405 
x
 && 
Œav”£d
 <ğ
’d
) {

406 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

407 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

408 
	`diùD–‘e
(
diù
,
x
->
–e
);

409 
	`z¦F»eNode
(
x
);

410 
»moved
++;

411 
Œav”£d
++;

412 
x
 = 
Ãxt
;

414  
»moved
;

415 
	}
}

421 
	$z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
) {

422 
zskli¡Node
 *
x
;

423 
¿nk
 = 0;

424 
i
;

426 
x
 = 
z¦
->
h—d”
;

427 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

428 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

429 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

430 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

431 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) <= 0))) {

432 
¿nk
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

433 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

437 ià(
x
->
–e
 && 
	`sdscmp
(x->ele,ele) == 0) {

438  
¿nk
;

442 
	}
}

445 
zskli¡Node
* 
	$z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
) {

446 
zskli¡Node
 *
x
;

447 
Œav”£d
 = 0;

448 
i
;

450 
x
 = 
z¦
->
h—d”
;

451 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

452 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è<ğ
¿nk
)

454 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

455 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

457 ià(
Œav”£d
 =ğ
¿nk
) {

458  
x
;

461  
NULL
;

462 
	}
}

465 
	$z¦P¬£Rªge
(
robj
 *
mš
,„obj *
max
, 
z¿nge¥ec
 *
¥ec
) {

466 *
•Œ
;

467 
¥ec
->
mšex
 = s³c->
maxex
 = 0;

473 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

474 
¥ec
->
mš
 = ()mš->
±r
;

476 ià(((*)
mš
->
±r
)[0] == '(') {

477 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
+1,&
•Œ
);

478 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
C_ERR
;

479 
¥ec
->
mšex
 = 1;

481 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
,&
•Œ
);

482 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
C_ERR
;

485 ià(
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

486 
¥ec
->
max
 = ()max->
±r
;

488 ià(((*)
max
->
±r
)[0] == '(') {

489 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
+1,&
•Œ
);

490 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
C_ERR
;

491 
¥ec
->
maxex
 = 1;

493 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
,&
•Œ
);

494 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
C_ERR
;

498  
C_OK
;

499 
	}
}

516 
	$z¦P¬£LexRªgeI‹m
(
robj
 *
™em
, 
sds
 *
de¡
, *
ex
) {

517 *
c
 = 
™em
->
±r
;

519 
c
[0]) {

521 ià(
c
[1] !ğ'\0'è 
C_ERR
;

522 *
ex
 = 0;

523 *
de¡
 = 
sh¬ed
.
max¡ršg
;

524  
C_OK
;

526 ià(
c
[1] !ğ'\0'è 
C_ERR
;

527 *
ex
 = 0;

528 *
de¡
 = 
sh¬ed
.
mš¡ršg
;

529  
C_OK
;

531 *
ex
 = 1;

532 *
de¡
 = 
	`sd¢ewËn
(
c
+1,
	`sd¦’
(c)-1);

533  
C_OK
;

535 *
ex
 = 0;

536 *
de¡
 = 
	`sd¢ewËn
(
c
+1,
	`sd¦’
(c)-1);

537  
C_OK
;

539  
C_ERR
;

541 
	}
}

545 
	$z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
) {

546 ià(
¥ec
->
mš
 !ğ
sh¬ed
.
mš¡ršg
 &&

547 
¥ec
->
mš
 !ğ
sh¬ed
.
max¡ršg
è
	`sdsä“
(spec->min);

548 ià(
¥ec
->
max
 !ğ
sh¬ed
.
mš¡ršg
 &&

549 
¥ec
->
max
 !ğ
sh¬ed
.
max¡ršg
è
	`sdsä“
(spec->max);

550 
	}
}

557 
	$z¦P¬£LexRªge
(
robj
 *
mš
,„obj *
max
, 
zËx¿nge¥ec
 *
¥ec
) {

560 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
 ||

561 
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
è 
C_ERR
;

563 
¥ec
->
mš
 = s³c->
max
 = 
NULL
;

564 ià(
	`z¦P¬£LexRªgeI‹m
(
mš
, &
¥ec
->mš, &¥ec->
mšex
è=ğ
C_ERR
 ||

565 
	`z¦P¬£LexRªgeI‹m
(
max
, &
¥ec
->max, &¥ec->
maxex
è=ğ
C_ERR
) {

566 
	`z¦F»eLexRªge
(
¥ec
);

567  
C_ERR
;

569  
C_OK
;

571 
	}
}

576 
	$sdscm¶ex
(
sds
 
a
, sd 
b
) {

577 ià(
a
 =ğ
b
)  0;

578 ià(
a
 =ğ
sh¬ed
.
mš¡ršg
 || 
b
 =ğsh¬ed.
max¡ršg
)  -1;

579 ià(
a
 =ğ
sh¬ed
.
max¡ršg
 || 
b
 =ğsh¬ed.
mš¡ršg
)  1;

580  
	`sdscmp
(
a
,
b
);

581 
	}
}

583 
	$z¦LexV®ueG‹Mš
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

584  
¥ec
->
mšex
 ?

585 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
mš
) > 0) :

586 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
mš
) >= 0);

587 
	}
}

589 
	$z¦LexV®ueL‹Max
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

590  
¥ec
->
maxex
 ?

591 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
max
) < 0) :

592 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
max
) <= 0);

593 
	}
}

596 
	$z¦IsInLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

597 
zskli¡Node
 *
x
;

600 ià(
	`sdscm¶ex
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

601 (
	`sdscmp
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

602 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

604 
x
 = 
z¦
->

;

605 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueG‹Mš
(x->
–e
,
¿nge
))

607 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

608 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueL‹Max
(x->
–e
,
¿nge
))

611 
	}
}

615 
zskli¡Node
 *
	$z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

616 
zskli¡Node
 *
x
;

617 
i
;

620 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

622 
x
 = 
z¦
->
h—d”
;

623 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

625 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

626 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,
¿nge
))

627 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

631 
x
 = x->
Ëv–
[0].
fÜw¬d
;

632 
	`£rv”As£¹
(
x
 !ğ
NULL
);

635 ià(!
	`z¦LexV®ueL‹Max
(
x
->
–e
,
¿nge
)è 
NULL
;

636  
x
;

637 
	}
}

641 
zskli¡Node
 *
	$z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

642 
zskli¡Node
 *
x
;

643 
i
;

646 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

648 
x
 = 
z¦
->
h—d”
;

649 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

651 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

652 
	`z¦LexV®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,
¿nge
))

653 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

657 
	`£rv”As£¹
(
x
 !ğ
NULL
);

660 ià(!
	`z¦LexV®ueG‹Mš
(
x
->
–e
,
¿nge
)è 
NULL
;

661  
x
;

662 
	}
}

668 
	$zzlG‘ScÜe
(*
¥Œ
) {

669 *
v¡r
;

670 
vËn
;

671 
vlÚg
;

672 
buf
[128];

673 
scÜe
;

675 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

676 
	`£rv”As£¹
(
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

678 ià(
v¡r
) {

679 
	`memıy
(
buf
,
v¡r
,
vËn
);

680 
buf
[
vËn
] = '\0';

681 
scÜe
 = 
	`¡¹od
(
buf
,
NULL
);

683 
scÜe
 = 
vlÚg
;

686  
scÜe
;

687 
	}
}

690 
sds
 
	$zli¡G‘Objeù
(*
¥Œ
) {

691 *
v¡r
;

692 
vËn
;

693 
vlÚg
;

695 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

696 
	`£rv”As£¹
(
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

698 ià(
v¡r
) {

699  
	`sd¢ewËn
((*)
v¡r
,
vËn
);

701  
	`sdsäomlÚglÚg
(
vlÚg
);

703 
	}
}

706 
	$zzlCom·»EËm’ts
(*
•Œ
, *
c¡r
, 
ş’
) {

707 *
v¡r
;

708 
vËn
;

709 
vlÚg
;

710 
vbuf
[32];

711 
mšËn
, 
cmp
;

713 
	`£rv”As£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

714 ià(
v¡r
 =ğ
NULL
) {

716 
vËn
 = 
	`Î2¡ršg
((*)
vbuf
,(vbuf),
vlÚg
);

717 
v¡r
 = 
vbuf
;

720 
mšËn
 = (
vËn
 < 
ş’
) ? vlen : clen;

721 
cmp
 = 
	`memcmp
(
v¡r
,
c¡r
,
mšËn
);

722 ià(
cmp
 =ğ0è 
vËn
-
ş’
;

723  
cmp
;

724 
	}
}

726 
	$zzlL’gth
(*
zl
) {

727  
	`zli¡L’
(
zl
)/2;

728 
	}
}

732 
	$zzlNext
(*
zl
, **
•Œ
, **
¥Œ
) {

733 *
_•Œ
, *
_¥Œ
;

734 
	`£rv”As£¹
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

736 
_•Œ
 = 
	`zli¡Next
(
zl
,*
¥Œ
);

737 ià(
_•Œ
 !ğ
NULL
) {

738 
_¥Œ
 = 
	`zli¡Next
(
zl
,
_•Œ
);

739 
	`£rv”As£¹
(
_¥Œ
 !ğ
NULL
);

742 
_¥Œ
 = 
NULL
;

745 *
•Œ
 = 
_•Œ
;

746 *
¥Œ
 = 
_¥Œ
;

747 
	}
}

751 
	$zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
) {

752 *
_•Œ
, *
_¥Œ
;

753 
	`£rv”As£¹
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

755 
_¥Œ
 = 
	`zli¡P»v
(
zl
,*
•Œ
);

756 ià(
_¥Œ
 !ğ
NULL
) {

757 
_•Œ
 = 
	`zli¡P»v
(
zl
,
_¥Œ
);

758 
	`£rv”As£¹
(
_•Œ
 !ğ
NULL
);

761 
_•Œ
 = 
NULL
;

764 *
•Œ
 = 
_•Œ
;

765 *
¥Œ
 = 
_¥Œ
;

766 
	}
}

770 
	$zzlIsInRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

771 *
p
;

772 
scÜe
;

775 ià(
¿nge
->
mš
 >„ªge->
max
 ||

776 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

779 
p
 = 
	`zli¡Index
(
zl
,-1);

780 ià(
p
 =ğ
NULL
)  0;

781 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

782 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

785 
p
 = 
	`zli¡Index
(
zl
,1);

786 
	`£rv”As£¹
(
p
 !ğ
NULL
);

787 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

788 ià(!
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

792 
	}
}

796 *
	$zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

797 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

798 
scÜe
;

801 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

803 
•Œ
 !ğ
NULL
) {

804 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

805 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

807 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

808 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
)) {

810 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

811  
•Œ
;

812  
NULL
;

816 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

819  
NULL
;

820 
	}
}

824 *
	$zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

825 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

826 
scÜe
;

829 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

831 
•Œ
 !ğ
NULL
) {

832 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

833 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

835 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

836 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

838 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

839  
•Œ
;

840  
NULL
;

845 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

846 ià(
¥Œ
 !ğ
NULL
)

847 
	`£rv”As£¹
((
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
)è!ğ
NULL
);

849 
•Œ
 = 
NULL
;

852  
NULL
;

853 
	}
}

855 
	$zzlLexV®ueG‹Mš
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

856 
sds
 
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

857 
»s
 = 
	`z¦LexV®ueG‹Mš
(
v®ue
,
¥ec
);

858 
	`sdsä“
(
v®ue
);

859  
»s
;

860 
	}
}

862 
	$zzlLexV®ueL‹Max
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

863 
sds
 
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

864 
»s
 = 
	`z¦LexV®ueL‹Max
(
v®ue
,
¥ec
);

865 
	`sdsä“
(
v®ue
);

866  
»s
;

867 
	}
}

871 
	$zzlIsInLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

872 *
p
;

875 ià(
	`sdscm¶ex
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

876 (
	`sdscmp
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

877 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

880 
p
 = 
	`zli¡Index
(
zl
,-2);

881 ià(
p
 =ğ
NULL
)  0;

882 ià(!
	`zzlLexV®ueG‹Mš
(
p
,
¿nge
))

885 
p
 = 
	`zli¡Index
(
zl
,0);

886 
	`£rv”As£¹
(
p
 !ğ
NULL
);

887 ià(!
	`zzlLexV®ueL‹Max
(
p
,
¿nge
))

891 
	}
}

895 *
	$zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

896 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

899 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

901 
•Œ
 !ğ
NULL
) {

902 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
)) {

904 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
))

905  
•Œ
;

906  
NULL
;

910 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

911 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

912 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

915  
NULL
;

916 
	}
}

920 *
	$zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

921 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

924 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

926 
•Œ
 !ğ
NULL
) {

927 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

929 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
))

930  
•Œ
;

931  
NULL
;

936 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

937 ià(
¥Œ
 !ğ
NULL
)

938 
	`£rv”As£¹
((
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
)è!ğ
NULL
);

940 
•Œ
 = 
NULL
;

943  
NULL
;

944 
	}
}

946 *
	$zzlFšd
(*
zl
, 
sds
 
–e
, *
scÜe
) {

947 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

949 
•Œ
 !ğ
NULL
) {

950 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

951 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

953 ià(
	`zli¡Com·»
(
•Œ
,(*)
–e
,
	`sd¦’
(ele))) {

955 ià(
scÜe
 !ğ
NULL
è*scÜğ
	`zzlG‘ScÜe
(
¥Œ
);

956  
•Œ
;

960 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

962  
NULL
;

963 
	}
}

967 *
	$zzlD–‘e
(*
zl
, *
•Œ
) {

968 *
p
 = 
•Œ
;

971 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

972 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

973  
zl
;

974 
	}
}

976 *
	$zzlIn£¹At
(*
zl
, *
•Œ
, 
sds
 
–e
, 
scÜe
) {

977 *
¥Œ
;

978 
scÜebuf
[128];

979 
scÜ–’
;

980 
size_t
 
off£t
;

982 
scÜ–’
 = 
	`d2¡ršg
(
scÜebuf
,(scÜebuf),
scÜe
);

983 ià(
•Œ
 =ğ
NULL
) {

984 
zl
 = 
	`zli¡Push
(zl,(*)
–e
,
	`sd¦’
ÓË),
ZIPLIST_TAIL
);

985 
zl
 = 
	`zli¡Push
(zl,(*)
scÜebuf
,
scÜ–’
,
ZIPLIST_TAIL
);

988 
off£t
 = 
•Œ
-
zl
;

989 
zl
 = 
	`zli¡In£¹
(zl,
•Œ
,(*)
–e
,
	`sd¦’
(ele));

990 
•Œ
 = 
zl
+
off£t
;

993 
	`£rv”As£¹
((
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
);

994 
zl
 = 
	`zli¡In£¹
(zl,
¥Œ
,(*)
scÜebuf
,
scÜ–’
);

996  
zl
;

997 
	}
}

1001 *
	$zzlIn£¹
(*
zl
, 
sds
 
–e
, 
scÜe
) {

1002 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

1003 
s
;

1005 
•Œ
 !ğ
NULL
) {

1006 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1007 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

1008 
s
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1010 ià(
s
 > 
scÜe
) {

1014 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e
,
scÜe
);

1016 } ià(
s
 =ğ
scÜe
) {

1018 ià(
	`zzlCom·»EËm’ts
(
•Œ
,(*)
–e
,
	`sd¦’
(ele)) > 0) {

1019 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e
,
scÜe
);

1025 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

1029 ià(
•Œ
 =ğ
NULL
)

1030 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e
,
scÜe
);

1031  
zl
;

1032 
	}
}

1034 *
	$zzlD–‘eRªgeByScÜe
(*
zl
, 
z¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1035 *
•Œ
, *
¥Œ
;

1036 
scÜe
;

1037 
num
 = 0;

1039 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1041 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,
¿nge
);

1042 ià(
•Œ
 =ğ
NULL
è 
zl
;

1046 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1047 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1048 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

1050 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1051 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1052 
num
++;

1059 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1060  
zl
;

1061 
	}
}

1063 *
	$zzlD–‘eRªgeByLex
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1064 *
•Œ
, *
¥Œ
;

1065 
num
 = 0;

1067 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1069 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,
¿nge
);

1070 ià(
•Œ
 =ğ
NULL
è 
zl
;

1074 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1075 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

1077 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1078 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1079 
num
++;

1086 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1087  
zl
;

1088 
	}
}

1092 *
	$zzlD–‘eRªgeByRªk
(*
zl
, 
¡¬t
, 
’d
, *
d–‘ed
) {

1093 
num
 = (
’d
-
¡¬t
)+1;

1094 ià(
d–‘ed
è*d–‘ed = 
num
;

1095 
zl
 = 
	`zli¡D–‘eRªge
(zl,2*(
¡¬t
-1),2*
num
);

1096  
zl
;

1097 
	}
}

1103 
	$z£tL’gth
(cÚ¡ 
robj
 *
zobj
) {

1104 
Ëngth
 = -1;

1105 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1106 
Ëngth
 = 
	`zzlL’gth
(
zobj
->
±r
);

1107 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1108 
Ëngth
 = ((cÚ¡ 
z£t
*)
zobj
->
±r
)->
z¦
->length;

1110 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1112  
Ëngth
;

1113 
	}
}

1115 
	$z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
) {

1116 
z£t
 *
zs
;

1117 
zskli¡Node
 *
node
, *
Ãxt
;

1118 
sds
 
–e
;

1119 
scÜe
;

1121 ià(
zobj
->
’codšg
 ==ƒncoding) ;

1122 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1123 *
zl
 = 
zobj
->
±r
;

1124 *
•Œ
, *
¥Œ
;

1125 *
v¡r
;

1126 
vËn
;

1127 
vlÚg
;

1129 ià(
’codšg
 !ğ
OBJ_ENCODING_SKIPLIST
)

1130 
	`£rv”Pªic
("Unknownargetƒncoding");

1132 
zs
 = 
	`zm®loc
((*zs));

1133 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

1134 
zs
->
z¦
 = 
	`z¦C»©e
();

1136 
•Œ
 = 
	`zli¡Index
(
zl
,0);

1137 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
•Œ
 != NULL);

1138 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1139 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
¥Œ
 != NULL);

1141 
•Œ
 !ğ
NULL
) {

1142 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1143 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

1144 ià(
v¡r
 =ğ
NULL
)

1145 
–e
 = 
	`sdsäomlÚglÚg
(
vlÚg
);

1147 
–e
 = 
	`sd¢ewËn
((*)
v¡r
,
vËn
);

1149 
node
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1150 
	`£rv”As£¹
(
	`diùAdd
(
zs
->
diù
,
–e
,&
node
->
scÜe
è=ğ
DICT_OK
);

1151 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

1154 
	`zä“
(
zobj
->
±r
);

1155 
zobj
->
±r
 = 
zs
;

1156 
zobj
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

1157 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1158 *
zl
 = 
	`zli¡New
();

1160 ià(
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
)

1161 
	`£rv”Pªic
("Unknownargetƒncoding");

1165 
zs
 = 
zobj
->
±r
;

1166 
	`diùR–—£
(
zs
->
diù
);

1167 
node
 = 
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1168 
	`zä“
(
zs
->
z¦
->
h—d”
);

1169 
	`zä“
(
zs
->
z¦
);

1171 
node
) {

1172 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
node
->
–e
,node->
scÜe
);

1173 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

1174 
	`z¦F»eNode
(
node
);

1175 
node
 = 
Ãxt
;

1178 
	`zä“
(
zs
);

1179 
zobj
->
±r
 = 
zl
;

1180 
zobj
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1182 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1184 
	}
}

1189 
	$z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
) {

1190 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) ;

1191 
z£t
 *z£ˆğ
zobj
->
±r
;

1193 ià(
z£t
->
z¦
->
Ëngth
 <ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

1194 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

1195 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_ZIPLIST
);

1196 
	}
}

1202 
	$z£tScÜe
(
robj
 *
zobj
, 
sds
 
memb”
, *
scÜe
) {

1203 ià(!
zobj
 || !
memb”
è 
C_ERR
;

1205 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1206 ià(
	`zzlFšd
(
zobj
->
±r
, 
memb”
, 
scÜe
è=ğ
NULL
è 
C_ERR
;

1207 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1208 
z£t
 *
zs
 = 
zobj
->
±r
;

1209 
diùEÁry
 *
de
 = 
	`diùFšd
(
zs
->
diù
, 
memb”
);

1210 ià(
de
 =ğ
NULL
è 
C_ERR
;

1211 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1213 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1215  
C_OK
;

1216 
	}
}

1261 
	$z£tAdd
(
robj
 *
zobj
, 
scÜe
, 
sds
 
–e
, *
æags
, *
ÃwscÜe
) {

1263 
šü
 = (*
æags
 & 
ZADD_INCR
) != 0;

1264 
nx
 = (*
æags
 & 
ZADD_NX
) != 0;

1265 
xx
 = (*
æags
 & 
ZADD_XX
) != 0;

1266 *
æags
 = 0;

1267 
curscÜe
;

1270 ià(
	`i¢ª
(
scÜe
)) {

1271 *
æags
 = 
ZADD_NAN
;

1276 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1277 *
•Œ
;

1279 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
–e
,&
curscÜe
)è!ğ
NULL
) {

1281 ià(
nx
) {

1282 *
æags
 |ğ
ZADD_NOP
;

1287 ià(
šü
) {

1288 
scÜe
 +ğ
curscÜe
;

1289 ià(
	`i¢ª
(
scÜe
)) {

1290 *
æags
 |ğ
ZADD_NAN
;

1293 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1297 ià(
scÜe
 !ğ
curscÜe
) {

1298 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1299 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1300 *
æags
 |ğ
ZADD_UPDATED
;

1303 } ià(!
xx
) {

1306 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1307 ià(
	`zzlL’gth
(
zobj
->
±r
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1308 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1309 ià(
	`sd¦’
(
–e
è> 
£rv”
.
z£t_max_zli¡_v®ue
)

1310 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1311 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1312 *
æags
 |ğ
ZADD_ADDED
;

1315 *
æags
 |ğ
ZADD_NOP
;

1318 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1319 
z£t
 *
zs
 = 
zobj
->
±r
;

1320 
zskli¡Node
 *
znode
;

1321 
diùEÁry
 *
de
;

1323 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1324 ià(
de
 !ğ
NULL
) {

1326 ià(
nx
) {

1327 *
æags
 |ğ
ZADD_NOP
;

1330 
curscÜe
 = *(*)
	`diùG‘V®
(
de
);

1333 ià(
šü
) {

1334 
scÜe
 +ğ
curscÜe
;

1335 ià(
	`i¢ª
(
scÜe
)) {

1336 *
æags
 |ğ
ZADD_NAN
;

1339 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1343 ià(
scÜe
 !ğ
curscÜe
) {

1344 
zskli¡Node
 *
node
;

1345 
	`£rv”As£¹
(
	`z¦D–‘e
(
zs
->
z¦
,
curscÜe
,
–e
,&
node
));

1346 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
node
->
–e
);

1349 
node
->
–e
 = 
NULL
;

1350 
	`z¦F»eNode
(
node
);

1354 
	`diùG‘V®
(
de
èğ&
znode
->
scÜe
;

1355 *
æags
 |ğ
ZADD_UPDATED
;

1358 } ià(!
xx
) {

1359 
–e
 = 
	`sdsdup
(ele);

1360 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1361 
	`£rv”As£¹
(
	`diùAdd
(
zs
->
diù
,
–e
,&
znode
->
scÜe
è=ğ
DICT_OK
);

1362 *
æags
 |ğ
ZADD_ADDED
;

1363 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1366 *
æags
 |ğ
ZADD_NOP
;

1370 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1373 
	}
}

1377 
	$z£tD–
(
robj
 *
zobj
, 
sds
 
–e
) {

1378 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1379 *
•Œ
;

1381 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
–e
,
NULL
)) != NULL) {

1382 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1385 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1386 
z£t
 *
zs
 = 
zobj
->
±r
;

1387 
diùEÁry
 *
de
;

1388 
scÜe
;

1390 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1391 ià(
de
 !ğ
NULL
) {

1393 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1400 
»tv®1
 = 
	`diùD–‘e
(
zs
->
diù
,
–e
);

1403 
»tv®2
 = 
	`z¦D–‘e
(
zs
->
z¦
,
scÜe
,
–e
,
NULL
);

1405 
	`£rv”As£¹
(
»tv®1
 =ğ
DICT_OK
 && 
»tv®2
);

1407 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1411 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1414 
	}
}

1427 
	$z£tRªk
(
robj
 *
zobj
, 
sds
 
–e
, 
»v”£
) {

1428 
Î’
;

1429 
¿nk
;

1431 
Î’
 = 
	`z£tL’gth
(
zobj
);

1433 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1434 *
zl
 = 
zobj
->
±r
;

1435 *
•Œ
, *
¥Œ
;

1437 
•Œ
 = 
	`zli¡Index
(
zl
,0);

1438 
	`£rv”As£¹
(
•Œ
 !ğ
NULL
);

1439 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1440 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

1442 
¿nk
 = 1;

1443 
•Œ
 !ğ
NULL
) {

1444 ià(
	`zli¡Com·»
(
•Œ
,(*)
–e
,
	`sd¦’
(ele)))

1446 
¿nk
++;

1447 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

1450 ià(
•Œ
 !ğ
NULL
) {

1451 ià(
»v”£
)

1452  
Î’
-
¿nk
;

1454  
¿nk
-1;

1458 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1459 
z£t
 *
zs
 = 
zobj
->
±r
;

1460 
zskli¡
 *
z¦
 = 
zs
->zsl;

1461 
diùEÁry
 *
de
;

1462 
scÜe
;

1464 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1465 ià(
de
 !ğ
NULL
) {

1466 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1467 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
,
scÜe
,
–e
);

1469 
	`£rv”As£¹
(
¿nk
 != 0);

1470 ià(
»v”£
)

1471  
Î’
-
¿nk
;

1473  
¿nk
-1;

1478 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1480 
	}
}

1487 
	$zaddG’”icCommªd
(
ş›Á
 *
c
, 
æags
) {

1488 *
ÇÃ¼
 = "resulting score is‚ot‡‚umber (NaN)";

1489 
robj
 *
key
 = 
c
->
¬gv
[1];

1490 
robj
 *
zobj
;

1491 
sds
 
–e
;

1492 
scÜe
 = 0, *
scÜes
 = 
NULL
;

1493 
j
, 
–em’ts
;

1494 
scÜeidx
 = 0;

1498 
added
 = 0;

1499 
upd©ed
 = 0;

1500 
´oûs£d
 = 0;

1505 
scÜeidx
 = 2;

1506 
scÜeidx
 < 
c
->
¬gc
) {

1507 *
İt
 = 
c
->
¬gv
[
scÜeidx
]->
±r
;

1508 ià(!
	`¡rÿ£cmp
(
İt
,"nx")è
æags
 |ğ
ZADD_NX
;

1509 ià(!
	`¡rÿ£cmp
(
İt
,"xx")è
æags
 |ğ
ZADD_XX
;

1510 ià(!
	`¡rÿ£cmp
(
İt
,"ch")è
æags
 |ğ
ZADD_CH
;

1511 ià(!
	`¡rÿ£cmp
(
İt
,"šü")è
æags
 |ğ
ZADD_INCR
;

1513 
scÜeidx
++;

1517 
šü
 = (
æags
 & 
ZADD_INCR
) != 0;

1518 
nx
 = (
æags
 & 
ZADD_NX
) != 0;

1519 
xx
 = (
æags
 & 
ZADD_XX
) != 0;

1520 
ch
 = (
æags
 & 
ZADD_CH
) != 0;

1524 
–em’ts
 = 
c
->
¬gc
-
scÜeidx
;

1525 ià(
–em’ts
 % 2) {

1526 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1529 
–em’ts
 /= 2;

1532 ià(
nx
 && 
xx
) {

1533 
	`addR•lyE¼Ü
(
c
,

1538 ià(
šü
 && 
–em’ts
 > 1) {

1539 
	`addR•lyE¼Ü
(
c
,

1547 
scÜes
 = 
	`zm®loc
(()*
–em’ts
);

1548 
j
 = 0; j < 
–em’ts
; j++) {

1549 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
scÜeidx
+
j
*2],&
scÜes
[j],
NULL
)

1550 !ğ
C_OK
è
ş—nup
;

1554 
zobj
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
);

1555 ià(
zobj
 =ğ
NULL
) {

1556 ià(
xx
è
»¶y_to_ş›Á
;

1557 ià(
£rv”
.
z£t_max_zli¡_’Œ›s
 == 0 ||

1558 
£rv”
.
z£t_max_zli¡_v®ue
 < 
	`sd¦’
(
c
->
¬gv
[
scÜeidx
+1]->
±r
))

1560 
zobj
 = 
	`ü—‹Z£tObjeù
();

1562 
zobj
 = 
	`ü—‹Z£tZli¡Objeù
();

1564 
	`dbAdd
(
c
->
db
,
key
,
zobj
);

1566 ià(
zobj
->
ty³
 !ğ
OBJ_ZSET
) {

1567 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1568 
ş—nup
;

1572 
j
 = 0; j < 
–em’ts
; j++) {

1573 
ÃwscÜe
;

1574 
scÜe
 = 
scÜes
[
j
];

1575 
»tæags
 = 
æags
;

1577 
–e
 = 
c
->
¬gv
[
scÜeidx
+1+
j
*2]->
±r
;

1578 
»tv®
 = 
	`z£tAdd
(
zobj
, 
scÜe
, 
–e
, &
»tæags
, &
ÃwscÜe
);

1579 ià(
»tv®
 == 0) {

1580 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1581 
ş—nup
;

1583 ià(
»tæags
 & 
ZADD_ADDED
è
added
++;

1584 ià(
»tæags
 & 
ZADD_UPDATED
è
upd©ed
++;

1585 ià(!(
»tæags
 & 
ZADD_NOP
)è
´oûs£d
++;

1586 
scÜe
 = 
ÃwscÜe
;

1588 
£rv”
.
dœty
 +ğ(
added
+
upd©ed
);

1590 
»¶y_to_ş›Á
:

1591 ià(
šü
) {

1592 ià(
´oûs£d
)

1593 
	`addR•lyDoubË
(
c
,
scÜe
);

1595 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1597 
	`addR•lyLÚgLÚg
(
c
,
ch
 ? 
added
+
upd©ed
 :‡dded);

1600 
ş—nup
:

1601 
	`zä“
(
scÜes
);

1602 ià(
added
 || 
upd©ed
) {

1603 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1604 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

1605 
šü
 ? "zšü" : "zadd", 
key
, 
c
->
db
->
id
);

1607 
	}
}

1609 
	$zaddCommªd
(
ş›Á
 *
c
) {

1610 
	`zaddG’”icCommªd
(
c
,
ZADD_NONE
);

1611 
	}
}

1613 
	$zšübyCommªd
(
ş›Á
 *
c
) {

1614 
	`zaddG’”icCommªd
(
c
,
ZADD_INCR
);

1615 
	}
}

1617 
	$z»mCommªd
(
ş›Á
 *
c
) {

1618 
robj
 *
key
 = 
c
->
¬gv
[1];

1619 
robj
 *
zobj
;

1620 
d–‘ed
 = 0, 
key»moved
 = 0, 
j
;

1622 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

1623 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

1625 
j
 = 2; j < 
c
->
¬gc
; j++) {

1626 ià(
	`z£tD–
(
zobj
,
c
->
¬gv
[
j
]->
±r
)è
d–‘ed
++;

1627 ià(
	`z£tL’gth
(
zobj
) == 0) {

1628 
	`dbD–‘e
(
c
->
db
,
key
);

1629 
key»moved
 = 1;

1634 ià(
d–‘ed
) {

1635 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,"z»m",
key
,
c
->
db
->
id
);

1636 ià(
key»moved
)

1637 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1638 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1639 
£rv”
.
dœty
 +ğ
d–‘ed
;

1641 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1642 
	}
}

1645 
	#ZRANGE_RANK
 0

	)

1646 
	#ZRANGE_SCORE
 1

	)

1647 
	#ZRANGE_LEX
 2

	)

1648 
	$z»m¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
¿ng‘y³
) {

1649 
robj
 *
key
 = 
c
->
¬gv
[1];

1650 
robj
 *
zobj
;

1651 
key»moved
 = 0;

1652 
d–‘ed
 = 0;

1653 
z¿nge¥ec
 
¿nge
;

1654 
zËx¿nge¥ec
 
Ëx¿nge
;

1655 
¡¬t
, 
’d
, 
Î’
;

1658 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1659 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
C_OK
) ||

1660 (
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
C_OK
))

1662 } ià(
¿ng‘y³
 =ğ
ZRANGE_SCORE
) {

1663 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
C_OK
) {

1664 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

1667 } ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
) {

1668 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
Ëx¿nge
è!ğ
C_OK
) {

1669 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

1675 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

1676 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)è
ş—nup
;

1678 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1680 
Î’
 = 
	`z£tL’gth
(
zobj
);

1681 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

1682 ià(
’d
 < 0è’d = 
Î’
+end;

1683 ià(
¡¬t
 < 0) start = 0;

1687 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

1688 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1689 
ş—nup
;

1691 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

1695 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1696 
¿ng‘y³
) {

1697 
ZRANGE_RANK
:

1698 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByRªk
(zobj->±r,
¡¬t
+1,
’d
+1,&
d–‘ed
);

1700 
ZRANGE_SCORE
:

1701 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByScÜe
(zobj->±r,&
¿nge
,&
d–‘ed
);

1703 
ZRANGE_LEX
:

1704 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByLex
(zobj->±r,&
Ëx¿nge
,&
d–‘ed
);

1707 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1708 
	`dbD–‘e
(
c
->
db
,
key
);

1709 
key»moved
 = 1;

1711 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1712 
z£t
 *
zs
 = 
zobj
->
±r
;

1713 
¿ng‘y³
) {

1714 
ZRANGE_RANK
:

1715 
d–‘ed
 = 
	`z¦D–‘eRªgeByRªk
(
zs
->
z¦
,
¡¬t
+1,
’d
+1,zs->
diù
);

1717 
ZRANGE_SCORE
:

1718 
d–‘ed
 = 
	`z¦D–‘eRªgeByScÜe
(
zs
->
z¦
,&
¿nge
,zs->
diù
);

1720 
ZRANGE_LEX
:

1721 
d–‘ed
 = 
	`z¦D–‘eRªgeByLex
(
zs
->
z¦
,&
Ëx¿nge
,zs->
diù
);

1724 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1725 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1726 
	`dbD–‘e
(
c
->
db
,
key
);

1727 
key»moved
 = 1;

1730 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1734 ià(
d–‘ed
) {

1735 *
ev’t
[3] = {"zremrangebyrank","zremrangebyscore","zremrangebylex"};

1736 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1737 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,
ev’t
[
¿ng‘y³
],
key
,
c
->
db
->
id
);

1738 ià(
key»moved
)

1739 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1741 
£rv”
.
dœty
 +ğ
d–‘ed
;

1742 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1744 
ş—nup
:

1745 ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
è
	`z¦F»eLexRªge
(&
Ëx¿nge
);

1746 
	}
}

1748 
	$z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
) {

1749 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_RANK
);

1750 
	}
}

1752 
	$z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

1753 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_SCORE
);

1754 
	}
}

1756 
	$z»m¿ngebyËxCommªd
(
ş›Á
 *
c
) {

1757 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_LEX
);

1758 
	}
}

1761 
robj
 *
	msubjeù
;

1762 
	mty³
;

1763 
	m’codšg
;

1764 
	mweight
;

1768 
	u_™”£t
 {

1770 
št£t
 *
	mis
;

1771 
	mii
;

1772 } 
	mis
;

1774 
diù
 *
	mdiù
;

1775 
diùI‹¿tÜ
 *
	mdi
;

1776 
diùEÁry
 *
	mde
;

1777 } 
	mht
;

1778 } 
	m£t
;

1781 
	u_™”z£t
 {

1783 *
	mzl
;

1784 *
	m•Œ
, *
	m¥Œ
;

1785 } 
	mzl
;

1787 
z£t
 *
	mzs
;

1788 
zskli¡Node
 *
	mnode
;

1789 } 
	m¦
;

1790 } 
	mz£t
;

1791 } 
	m™”
;

1792 } 
	tz£tİ¤c
;

1801 
	#OPVAL_DIRTY_SDS
 1

	)

1802 
	#OPVAL_DIRTY_LL
 2

	)

1803 
	#OPVAL_VALID_LL
 4

	)

1807 
	mæags
;

1808 
	m_buf
[32];

1809 
sds
 
	m–e
;

1810 *
	me¡r
;

1811 
	m–’
;

1812 
	m–l
;

1813 
	mscÜe
;

1814 } 
	tz£tİv®
;

1816 
_™”£t
 
	t™”£t
;

1817 
_™”z£t
 
	t™”z£t
;

1819 
	$zuiIn™I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1820 ià(
İ
->
subjeù
 =ğ
NULL
)

1823 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1824 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1825 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1826 
™
->
is
.i ğ
İ
->
subjeù
->
±r
;

1827 
™
->
is
.
ii
 = 0;

1828 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1829 
™
->
ht
.
diù
 = 
İ
->
subjeù
->
±r
;

1830 
™
->
ht
.
di
 = 
	`diùG‘I‹¿tÜ
(
İ
->
subjeù
->
±r
);

1831 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1833 
	`£rv”Pªic
("Unknown setƒncoding");

1835 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1836 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1837 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1838 
™
->
zl
.zÈğ
İ
->
subjeù
->
±r
;

1839 
™
->
zl
.
•Œ
 = 
	`zli¡Index
(it->zl.zl,0);

1840 ià(
™
->
zl
.
•Œ
 !ğ
NULL
) {

1841 
™
->
zl
.
¥Œ
 = 
	`zli¡Next
(™->zl.zl,™->zl.
•Œ
);

1842 
	`£rv”As£¹
(
™
->
zl
.
¥Œ
 !ğ
NULL
);

1844 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1845 
™
->
¦
.
zs
 = 
İ
->
subjeù
->
±r
;

1846 
™
->
¦
.
node
 = it->¦.
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1848 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1851 
	`£rv”Pªic
("Unsupportedype");

1853 
	}
}

1855 
	$zuiCË¬I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1856 ià(
İ
->
subjeù
 =ğ
NULL
)

1859 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1860 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1861 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1862 
	`UNUSED
(
™
);

1863 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1864 
	`diùR–—£I‹¿tÜ
(
™
->
ht
.
di
);

1866 
	`£rv”Pªic
("Unknown setƒncoding");

1868 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1869 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1870 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1871 
	`UNUSED
(
™
);

1872 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1873 
	`UNUSED
(
™
);

1875 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1878 
	`£rv”Pªic
("Unsupportedype");

1880 
	}
}

1882 
	$zuiL’gth
(
z£tİ¤c
 *
İ
) {

1883 ià(
İ
->
subjeù
 =ğ
NULL
)

1886 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1887 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1888  
	`št£tL’
(
İ
->
subjeù
->
±r
);

1889 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1890 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1891  
	`diùSize
(
ht
);

1893 
	`£rv”Pªic
("Unknown setƒncoding");

1895 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1896 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1897  
	`zzlL’gth
(
İ
->
subjeù
->
±r
);

1898 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1899 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1900  
zs
->
z¦
->
Ëngth
;

1902 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1905 
	`£rv”Pªic
("Unsupportedype");

1907 
	}
}

1912 
	$zuiNext
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
) {

1913 ià(
İ
->
subjeù
 =ğ
NULL
)

1916 ià(
v®
->
æags
 & 
OPVAL_DIRTY_SDS
)

1917 
	`sdsä“
(
v®
->
–e
);

1919 
	`mem£t
(
v®
,0,(
z£tİv®
));

1921 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1922 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1923 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1924 
št64_t
 
–l
;

1926 ià(!
	`št£tG‘
(
™
->
is
.is,™->is.
ii
,&
–l
))

1928 
v®
->
–l
 =ƒll;

1929 
v®
->
scÜe
 = 1.0;

1932 
™
->
is
.
ii
++;

1933 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1934 ià(
™
->
ht
.
de
 =ğ
NULL
)

1936 
v®
->
–e
 = 
	`diùG‘Key
(
™
->
ht
.
de
);

1937 
v®
->
scÜe
 = 1.0;

1940 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1942 
	`£rv”Pªic
("Unknown setƒncoding");

1944 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1945 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1946 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1948 ià(
™
->
zl
.
•Œ
 =ğ
NULL
 || it->zl.
¥Œ
 == NULL)

1950 
	`£rv”As£¹
(
	`zli¡G‘
(
™
->
zl
.
•Œ
,&
v®
->
e¡r
,&v®->
–’
,&v®->
–l
));

1951 
v®
->
scÜe
 = 
	`zzlG‘ScÜe
(
™
->
zl
.
¥Œ
);

1954 
	`zzlNext
(
™
->
zl
.zl,&™->zl.
•Œ
,&™->zl.
¥Œ
);

1955 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1956 ià(
™
->
¦
.
node
 =ğ
NULL
)

1958 
v®
->
–e
 = 
™
->
¦
.
node
->ele;

1959 
v®
->
scÜe
 = 
™
->
¦
.
node
->score;

1962 
™
->
¦
.
node
 = it->¦.node->
Ëv–
[0].
fÜw¬d
;

1964 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1967 
	`£rv”Pªic
("Unsupportedype");

1970 
	}
}

1972 
	$zuiLÚgLÚgFromV®ue
(
z£tİv®
 *
v®
) {

1973 ià(!(
v®
->
æags
 & 
OPVAL_DIRTY_LL
)) {

1974 
v®
->
æags
 |ğ
OPVAL_DIRTY_LL
;

1976 ià(
v®
->
–e
 !ğ
NULL
) {

1977 ià(
	`¡ršg2Î
(
v®
->
–e
,
	`sd¦’
(v®->–e),&v®->
–l
))

1978 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1979 } ià(
v®
->
e¡r
 !ğ
NULL
) {

1980 ià(
	`¡ršg2Î
((*)
v®
->
e¡r
,v®->
–’
,&v®->
–l
))

1981 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1984 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1987  
v®
->
æags
 & 
OPVAL_VALID_LL
;

1988 
	}
}

1990 
sds
 
	$zuiSdsFromV®ue
(
z£tİv®
 *
v®
) {

1991 ià(
v®
->
–e
 =ğ
NULL
) {

1992 ià(
v®
->
e¡r
 !ğ
NULL
) {

1993 
v®
->
–e
 = 
	`sd¢ewËn
((*)v®->
e¡r
,v®->
–’
);

1995 
v®
->
–e
 = 
	`sdsäomlÚglÚg
(v®->
–l
);

1997 
v®
->
æags
 |ğ
OPVAL_DIRTY_SDS
;

1999  
v®
->
–e
;

2000 
	}
}

2004 
sds
 
	$zuiNewSdsFromV®ue
(
z£tİv®
 *
v®
) {

2005 ià(
v®
->
æags
 & 
OPVAL_DIRTY_SDS
) {

2007 
sds
 
–e
 = 
v®
->ele;

2008 
v®
->
æags
 &ğ~
OPVAL_DIRTY_SDS
;

2009 
v®
->
–e
 = 
NULL
;

2010  
–e
;

2011 } ià(
v®
->
–e
) {

2012  
	`sdsdup
(
v®
->
–e
);

2013 } ià(
v®
->
e¡r
) {

2014  
	`sd¢ewËn
((*)
v®
->
e¡r
,v®->
–’
);

2016  
	`sdsäomlÚglÚg
(
v®
->
–l
);

2018 
	}
}

2020 
	$zuiBufãrFromV®ue
(
z£tİv®
 *
v®
) {

2021 ià(
v®
->
e¡r
 =ğ
NULL
) {

2022 ià(
v®
->
–e
 !ğ
NULL
) {

2023 
v®
->
–’
 = 
	`sd¦’
(v®->
–e
);

2024 
v®
->
e¡r
 = (*)v®->
–e
;

2026 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),v®->
–l
);

2027 
v®
->
e¡r
 = v®->
_buf
;

2031 
	}
}

2035 
	$zuiFšd
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
, *
scÜe
) {

2036 ià(
İ
->
subjeù
 =ğ
NULL
)

2039 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

2040 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

2041 ià(
	`zuiLÚgLÚgFromV®ue
(
v®
) &&

2042 
	`št£tFšd
(
İ
->
subjeù
->
±r
,
v®
->
–l
))

2044 *
scÜe
 = 1.0;

2049 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

2050 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

2051 
	`zuiSdsFromV®ue
(
v®
);

2052 ià(
	`diùFšd
(
ht
,
v®
->
–e
è!ğ
NULL
) {

2053 *
scÜe
 = 1.0;

2059 
	`£rv”Pªic
("Unknown setƒncoding");

2061 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

2062 
	`zuiSdsFromV®ue
(
v®
);

2064 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2065 ià(
	`zzlFšd
(
İ
->
subjeù
->
±r
,
v®
->
–e
,
scÜe
è!ğ
NULL
) {

2071 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2072 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

2073 
diùEÁry
 *
de
;

2074 ià((
de
 = 
	`diùFšd
(
zs
->
diù
,
v®
->
–e
)è!ğ
NULL
) {

2075 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

2081 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2084 
	`£rv”Pªic
("Unsupportedype");

2086 
	}
}

2088 
	$zuiCom·»ByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

2089  
	`zuiL’gth
((
z£tİ¤c
*)
s1
è- zuiL’gth((z£tİ¤c*)
s2
);

2090 
	}
}

2092 
	#REDIS_AGGR_SUM
 1

	)

2093 
	#REDIS_AGGR_MIN
 2

	)

2094 
	#REDIS_AGGR_MAX
 3

	)

2095 
	#zuniÚIÁ”DiùV®ue
(
_e
è(
	`diùG‘V®
(_eè=ğ
NULL
 ? 1.0 : *(*)diùG‘V®(_e))

	)

2097 
šlše
 
	$zuniÚIÁ”Agg»g©e
(*
rg‘
, 
v®
, 
agg»g©e
) {

2098 ià(
agg»g©e
 =ğ
REDIS_AGGR_SUM
) {

2099 *
rg‘
 = *rg‘ + 
v®
;

2103 ià(
	`i¢ª
(*
rg‘
)) *target = 0.0;

2104 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MIN
) {

2105 *
rg‘
 = 
v®
 < *target ? val : *target;

2106 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MAX
) {

2107 *
rg‘
 = 
v®
 > *target ? val : *target;

2110 
	`£rv”Pªic
("Unknown ZUNION/INTER‡ggregateype");

2112 
	}
}

2114 
diùSdsHash
(cÚ¡ *
key
);

2115 
diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

2117 
diùTy³
 
	g£tAccumuÏtÜDiùTy³
 = {

2118 
diùSdsHash
,

2119 
NULL
,

2120 
NULL
,

2121 
diùSdsKeyCom·»
,

2122 
NULL
,

2123 
NULL


2126 
	$zuniÚIÁ”G’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
d¡key
, 
İ
) {

2127 
i
, 
j
;

2128 
£Šum
;

2129 
agg»g©e
 = 
REDIS_AGGR_SUM
;

2130 
z£tİ¤c
 *
¤c
;

2131 
z£tİv®
 
zv®
;

2132 
sds
 
tmp
;

2133 
max––’
 = 0;

2134 
robj
 *
d¡obj
;

2135 
z£t
 *
d¡z£t
;

2136 
zskli¡Node
 *
znode
;

2137 
touched
 = 0;

2140 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
£Šum
, 
NULL
è!ğ
C_OK
))

2143 ià(
£Šum
 < 1) {

2144 
	`addR•lyE¼Ü
(
c
,

2150 ià(
£Šum
 > 
c
->
¬gc
-3) {

2151 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2156 
¤c
 = 
	`zÿÎoc
((
z£tİ¤c
è* 
£Šum
);

2157 
i
 = 0, 
j
 = 3; i < 
£Šum
; i++, j++) {

2158 
robj
 *
obj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]);

2159 ià(
obj
 !ğ
NULL
) {

2160 ià(
obj
->
ty³
 !ğ
OBJ_ZSET
 && obj->ty³ !ğ
OBJ_SET
) {

2161 
	`zä“
(
¤c
);

2162 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

2166 
¤c
[
i
].
subjeù
 = 
obj
;

2167 
¤c
[
i
].
ty³
 = 
obj
->type;

2168 
¤c
[
i
].
’codšg
 = 
obj
->encoding;

2170 
¤c
[
i
].
subjeù
 = 
NULL
;

2174 
¤c
[
i
].
weight
 = 1.0;

2178 ià(
j
 < 
c
->
¬gc
) {

2179 
»maššg
 = 
c
->
¬gc
 - 
j
;

2181 
»maššg
) {

2182 ià(
»maššg
 >ğ(
£Šum
 + 1) &&

2183 !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"weights"))

2185 
j
++; 
»maššg
--;

2186 
i
 = 0; i < 
£Šum
; i++, 
j
++, 
»maššg
--) {

2187 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
],&
¤c
[
i
].
weight
,

2188 "weighˆv®ui nÙ‡ flßt"è!ğ
C_OK
)

2190 
	`zä“
(
¤c
);

2194 } ià(
»maššg
 >= 2 &&

2195 !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"aggregate"))

2197 
j
++; 
»maššg
--;

2198 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"sum")) {

2199 
agg»g©e
 = 
REDIS_AGGR_SUM
;

2200 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"min")) {

2201 
agg»g©e
 = 
REDIS_AGGR_MIN
;

2202 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"max")) {

2203 
agg»g©e
 = 
REDIS_AGGR_MAX
;

2205 
	`zä“
(
¤c
);

2206 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2209 
j
++; 
»maššg
--;

2211 
	`zä“
(
¤c
);

2212 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2220 
	`qsÜt
(
¤c
,
£Šum
,(
z£tİ¤c
),
zuiCom·»ByC¬dš®™y
);

2222 
d¡obj
 = 
	`ü—‹Z£tObjeù
();

2223 
d¡z£t
 = 
d¡obj
->
±r
;

2224 
	`mem£t
(&
zv®
, 0, (zval));

2226 ià(
İ
 =ğ
SET_OP_INTER
) {

2228 ià(
	`zuiL’gth
(&
¤c
[0]) > 0) {

2231 
	`zuiIn™I‹¿tÜ
(&
¤c
[0]);

2232 
	`zuiNext
(&
¤c
[0],&
zv®
)) {

2233 
scÜe
, 
v®ue
;

2235 
scÜe
 = 
¤c
[0].
weight
 * 
zv®
.score;

2236 ià(
	`i¢ª
(
scÜe
)) score = 0;

2238 
j
 = 1; j < 
£Šum
; j++) {

2241 ià(
¤c
[
j
].
subjeù
 == src[0].subject) {

2242 
v®ue
 = 
zv®
.
scÜe
*
¤c
[
j
].
weight
;

2243 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

2244 } ià(
	`zuiFšd
(&
¤c
[
j
],&
zv®
,&
v®ue
)) {

2245 
v®ue
 *ğ
¤c
[
j
].
weight
;

2246 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

2253 ià(
j
 =ğ
£Šum
) {

2254 
tmp
 = 
	`zuiNewSdsFromV®ue
(&
zv®
);

2255 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
tmp
);

2256 
	`diùAdd
(
d¡z£t
->
diù
,
tmp
,&
znode
->
scÜe
);

2257 ià(
	`sd¦’
(
tmp
è> 
max––’
) maxelelen = sdslen(tmp);

2260 
	`zuiCË¬I‹¿tÜ
(&
¤c
[0]);

2262 } ià(
İ
 =ğ
SET_OP_UNION
) {

2263 
diù
 *
accumuÏtÜ
 = 
	`diùC»©e
(&
£tAccumuÏtÜDiùTy³
,
NULL
);

2264 
diùI‹¿tÜ
 *
di
;

2265 
diùEÁry
 *
de
;

2266 
scÜe
;

2268 ià(
£Šum
) {

2271 
	`diùEx·nd
(
accumuÏtÜ
,
	`zuiL’gth
(&
¤c
[
£Šum
-1]));

2276 
i
 = 0; i < 
£Šum
; i++) {

2277 ià(
	`zuiL’gth
(&
¤c
[
i
]) == 0) ;

2279 
	`zuiIn™I‹¿tÜ
(&
¤c
[
i
]);

2280 
	`zuiNext
(&
¤c
[
i
],&
zv®
)) {

2282 
scÜe
 = 
¤c
[
i
].
weight
 * 
zv®
.score;

2283 ià(
	`i¢ª
(
scÜe
)) score = 0;

2286 
de
 = 
	`diùFšd
(
accumuÏtÜ
,
	`zuiSdsFromV®ue
(&
zv®
));

2288 ià(
de
 =ğ
NULL
) {

2289 
tmp
 = 
	`zuiNewSdsFromV®ue
(&
zv®
);

2293 ià(
	`sd¦’
(
tmp
è> 
max––’
) maxelelen = sdslen(tmp);

2295 
de
 = 
	`diùAddRaw
(
accumuÏtÜ
,
tmp
);

2296 
	`diùS‘DoubËV®
(
de
,
scÜe
);

2304 
	`zuniÚIÁ”Agg»g©e
(&
de
->
v
.
d
,
scÜe
,
agg»g©e
);

2307 
	`zuiCË¬I‹¿tÜ
(&
¤c
[
i
]);

2311 
di
 = 
	`diùG‘I‹¿tÜ
(
accumuÏtÜ
);

2316 
	`diùEx·nd
(
d¡z£t
->
diù
,
	`diùSize
(
accumuÏtÜ
));

2318 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2319 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

2320 
scÜe
 = 
	`diùG‘DoubËV®
(
de
);

2321 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
–e
);

2322 
	`diùAdd
(
d¡z£t
->
diù
,
–e
,&
znode
->
scÜe
);

2324 
	`diùR–—£I‹¿tÜ
(
di
);

2325 
	`diùR–—£
(
accumuÏtÜ
);

2327 
	`£rv”Pªic
("Unknown operator");

2330 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
))

2331 
touched
 = 1;

2332 ià(
d¡z£t
->
z¦
->
Ëngth
) {

2333 
	`z£tCÚv”tToZli¡IfN“ded
(
d¡obj
,
max––’
);

2334 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

2335 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
d¡obj
));

2336 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2337 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

2338 (
İ
 =ğ
SET_OP_UNION
) ? "zunionstore" : "zinterstore",

2339 
d¡key
,
c
->
db
->
id
);

2340 
£rv”
.
dœty
++;

2342 
	`deüRefCouÁ
(
d¡obj
);

2343 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

2344 ià(
touched
) {

2345 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2346 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
d¡key
,
c
->
db
->
id
);

2347 
£rv”
.
dœty
++;

2350 
	`zä“
(
¤c
);

2351 
	}
}

2353 
	$zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

2354 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_UNION
);

2355 
	}
}

2357 
	$zš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

2358 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_INTER
);

2359 
	}
}

2361 
	$z¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2362 
robj
 *
key
 = 
c
->
¬gv
[1];

2363 
robj
 *
zobj
;

2364 
w™hscÜes
 = 0;

2365 
¡¬t
;

2366 
’d
;

2367 
Î’
;

2368 
¿ng–’
;

2370 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
C_OK
) ||

2371 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
C_OK
)) ;

2373 ià(
c
->
¬gc
 =ğ5 && !
	`¡rÿ£cmp
(c->
¬gv
[4]->
±r
,"withscores")) {

2374 
w™hscÜes
 = 1;

2375 } ià(
c
->
¬gc
 >= 5) {

2376 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2380 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


2381 || 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

2384 
Î’
 = 
	`z£tL’gth
(
zobj
);

2385 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

2386 ià(
’d
 < 0è’d = 
Î’
+end;

2387 ià(
¡¬t
 < 0) start = 0;

2391 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

2392 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

2395 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

2396 
¿ng–’
 = (
’d
-
¡¬t
)+1;

2399 
	`addR•lyMuÉiBulkL’
(
c
, 
w™hscÜes
 ? (
¿ng–’
*2) :„angelen);

2401 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2402 *
zl
 = 
zobj
->
±r
;

2403 *
•Œ
, *
¥Œ
;

2404 *
v¡r
;

2405 
vËn
;

2406 
vlÚg
;

2408 ià(
»v”£
)

2409 
•Œ
 = 
	`zli¡Index
(
zl
,-2-(2*
¡¬t
));

2411 
•Œ
 = 
	`zli¡Index
(
zl
,2*
¡¬t
);

2413 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2414 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2416 
¿ng–’
--) {

2417 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
 && 
¥Œ
 != NULL);

2418 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2419 ià(
v¡r
 =ğ
NULL
)

2420 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2422 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2424 ià(
w™hscÜes
)

2425 
	`addR•lyDoubË
(
c
,
	`zzlG‘ScÜe
(
¥Œ
));

2427 ià(
»v”£
)

2428 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2430 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2433 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2434 
z£t
 *
zs
 = 
zobj
->
±r
;

2435 
zskli¡
 *
z¦
 = 
zs
->zsl;

2436 
zskli¡Node
 *
Ê
;

2437 
sds
 
–e
;

2440 ià(
»v”£
) {

2441 
Ê
 = 
z¦
->

;

2442 ià(
¡¬t
 > 0)

2443 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
Î’
-
¡¬t
);

2445 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

2446 ià(
¡¬t
 > 0)

2447 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

2450 
¿ng–’
--) {

2451 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
Ê
 !ğ
NULL
);

2452 
–e
 = 
Ê
->ele;

2453 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

2454 ià(
w™hscÜes
)

2455 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2456 
Ê
 = 
»v”£
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

2459 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2461 
	}
}

2463 
	$z¿ngeCommªd
(
ş›Á
 *
c
) {

2464 
	`z¿ngeG’”icCommªd
(
c
,0);

2465 
	}
}

2467 
	$z»v¿ngeCommªd
(
ş›Á
 *
c
) {

2468 
	`z¿ngeG’”icCommªd
(
c
,1);

2469 
	}
}

2472 
	$g’”icZ¿ngebyscÜeCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2473 
z¿nge¥ec
 
¿nge
;

2474 
robj
 *
key
 = 
c
->
¬gv
[1];

2475 
robj
 *
zobj
;

2476 
off£t
 = 0, 
lim™
 = -1;

2477 
w™hscÜes
 = 0;

2478 
¿ng–’
 = 0;

2479 *
»¶yËn
 = 
NULL
;

2480 
mšidx
, 
maxidx
;

2483 ià(
»v”£
) {

2485 
maxidx
 = 2; 
mšidx
 = 3;

2488 
mšidx
 = 2; 
maxidx
 = 3;

2491 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
C_OK
) {

2492 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2498 ià(
c
->
¬gc
 > 4) {

2499 
»maššg
 = 
c
->
¬gc
 - 4;

2500 
pos
 = 4;

2502 
»maššg
) {

2503 ià(
»maššg
 >ğ1 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"withscores")) {

2504 
pos
++; 
»maššg
--;

2505 
w™hscÜes
 = 1;

2506 } ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2507 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
)

2508 !ğ
C_OK
) ||

2509 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
)

2510 !ğ
C_OK
))

2514 
pos
 +ğ3; 
»maššg
 -= 3;

2516 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2523 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2524 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

2526 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2527 *
zl
 = 
zobj
->
±r
;

2528 *
•Œ
, *
¥Œ
;

2529 *
v¡r
;

2530 
vËn
;

2531 
vlÚg
;

2532 
scÜe
;

2535 ià(
»v”£
) {

2536 
•Œ
 = 
	`zzlLa¡InRªge
(
zl
,&
¿nge
);

2538 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2542 ià(
•Œ
 =ğ
NULL
) {

2543 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2548 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2549 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2554 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2558 
•Œ
 && 
off£t
--) {

2559 ià(
»v”£
) {

2560 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2562 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2566 
•Œ
 && 
lim™
--) {

2567 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2570 ià(
»v”£
) {

2571 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,&
¿nge
)) ;

2573 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) ;

2577 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2579 
¿ng–’
++;

2580 ià(
v¡r
 =ğ
NULL
) {

2581 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2583 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2586 ià(
w™hscÜes
) {

2587 
	`addR•lyDoubË
(
c
,
scÜe
);

2591 ià(
»v”£
) {

2592 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2594 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2597 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2598 
z£t
 *
zs
 = 
zobj
->
±r
;

2599 
zskli¡
 *
z¦
 = 
zs
->zsl;

2600 
zskli¡Node
 *
Ê
;

2603 ià(
»v”£
) {

2604 
Ê
 = 
	`z¦La¡InRªge
(
z¦
,&
¿nge
);

2606 
Ê
 = 
	`z¦Fœ¡InRªge
(
z¦
,&
¿nge
);

2610 ià(
Ê
 =ğ
NULL
) {

2611 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2618 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2622 
Ê
 && 
off£t
--) {

2623 ià(
»v”£
) {

2624 
Ê
 =†n->
backw¬d
;

2626 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2630 
Ê
 && 
lim™
--) {

2632 ià(
»v”£
) {

2633 ià(!
	`z¦V®ueG‹Mš
(
Ê
->
scÜe
,&
¿nge
)) ;

2635 ià(!
	`z¦V®ueL‹Max
(
Ê
->
scÜe
,&
¿nge
)) ;

2638 
¿ng–’
++;

2639 
	`addR•lyBulkCBufãr
(
c
,
Ê
->
–e
,
	`sd¦’
(ln->ele));

2641 ià(
w™hscÜes
) {

2642 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2646 ià(
»v”£
) {

2647 
Ê
 =†n->
backw¬d
;

2649 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2653 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2656 ià(
w™hscÜes
) {

2657 
¿ng–’
 *= 2;

2660 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2661 
	}
}

2663 
	$z¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2664 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,0);

2665 
	}
}

2667 
	$z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2668 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,1);

2669 
	}
}

2671 
	$zcouÁCommªd
(
ş›Á
 *
c
) {

2672 
robj
 *
key
 = 
c
->
¬gv
[1];

2673 
robj
 *
zobj
;

2674 
z¿nge¥ec
 
¿nge
;

2675 
couÁ
 = 0;

2678 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
C_OK
) {

2679 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2684 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2685 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) ;

2687 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2688 *
zl
 = 
zobj
->
±r
;

2689 *
•Œ
, *
¥Œ
;

2690 
scÜe
;

2693 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2696 ià(
•Œ
 =ğ
NULL
) {

2697 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2702 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2703 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2704 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
));

2707 
•Œ
) {

2708 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2711 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) {

2714 
couÁ
++;

2715 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2718 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2719 
z£t
 *
zs
 = 
zobj
->
±r
;

2720 
zskli¡
 *
z¦
 = 
zs
->zsl;

2721 
zskli¡Node
 *
zn
;

2722 
¿nk
;

2725 
zn
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
);

2728 ià(
zn
 !ğ
NULL
) {

2729 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2730 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2733 
zn
 = 
	`z¦La¡InRªge
(
z¦
, &
¿nge
);

2736 ià(
zn
 !ğ
NULL
) {

2737 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2738 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2742 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2745 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2746 
	}
}

2748 
	$zËxcouÁCommªd
(
ş›Á
 *
c
) {

2749 
robj
 *
key
 = 
c
->
¬gv
[1];

2750 
robj
 *
zobj
;

2751 
zËx¿nge¥ec
 
¿nge
;

2752 
couÁ
 = 0;

2755 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
C_OK
) {

2756 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2761 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2762 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
))

2764 
	`z¦F»eLexRªge
(&
¿nge
);

2768 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2769 *
zl
 = 
zobj
->
±r
;

2770 *
•Œ
, *
¥Œ
;

2773 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2776 ià(
•Œ
 =ğ
NULL
) {

2777 
	`z¦F»eLexRªge
(&
¿nge
);

2778 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2783 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2784 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
));

2787 
•Œ
) {

2789 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) {

2792 
couÁ
++;

2793 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2796 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2797 
z£t
 *
zs
 = 
zobj
->
±r
;

2798 
zskli¡
 *
z¦
 = 
zs
->zsl;

2799 
zskli¡Node
 *
zn
;

2800 
¿nk
;

2803 
zn
 = 
	`z¦Fœ¡InLexRªge
(
z¦
, &
¿nge
);

2806 ià(
zn
 !ğ
NULL
) {

2807 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2808 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2811 
zn
 = 
	`z¦La¡InLexRªge
(
z¦
, &
¿nge
);

2814 ià(
zn
 !ğ
NULL
) {

2815 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2816 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2820 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2823 
	`z¦F»eLexRªge
(&
¿nge
);

2824 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2825 
	}
}

2828 
	$g’”icZ¿ngebyËxCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2829 
zËx¿nge¥ec
 
¿nge
;

2830 
robj
 *
key
 = 
c
->
¬gv
[1];

2831 
robj
 *
zobj
;

2832 
off£t
 = 0, 
lim™
 = -1;

2833 
¿ng–’
 = 0;

2834 *
»¶yËn
 = 
NULL
;

2835 
mšidx
, 
maxidx
;

2838 ià(
»v”£
) {

2840 
maxidx
 = 2; 
mšidx
 = 3;

2843 
mšidx
 = 2; 
maxidx
 = 3;

2846 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
C_OK
) {

2847 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2853 ià(
c
->
¬gc
 > 4) {

2854 
»maššg
 = 
c
->
¬gc
 - 4;

2855 
pos
 = 4;

2857 
»maššg
) {

2858 ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2859 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
C_OK
) ||

2860 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
C_OK
)) ;

2861 
pos
 +ğ3; 
»maššg
 -= 3;

2863 
	`z¦F»eLexRªge
(&
¿nge
);

2864 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2871 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2872 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
))

2874 
	`z¦F»eLexRªge
(&
¿nge
);

2878 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2879 *
zl
 = 
zobj
->
±r
;

2880 *
•Œ
, *
¥Œ
;

2881 *
v¡r
;

2882 
vËn
;

2883 
vlÚg
;

2886 ià(
»v”£
) {

2887 
•Œ
 = 
	`zzlLa¡InLexRªge
(
zl
,&
¿nge
);

2889 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2893 ià(
•Œ
 =ğ
NULL
) {

2894 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2895 
	`z¦F»eLexRªge
(&
¿nge
);

2900 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2901 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2906 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2910 
•Œ
 && 
off£t
--) {

2911 ià(
»v”£
) {

2912 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2914 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2918 
•Œ
 && 
lim™
--) {

2920 ià(
»v”£
) {

2921 ià(!
	`zzlLexV®ueG‹Mš
(
•Œ
,&
¿nge
)) ;

2923 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) ;

2928 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2930 
¿ng–’
++;

2931 ià(
v¡r
 =ğ
NULL
) {

2932 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2934 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2938 ià(
»v”£
) {

2939 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2941 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2944 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2945 
z£t
 *
zs
 = 
zobj
->
±r
;

2946 
zskli¡
 *
z¦
 = 
zs
->zsl;

2947 
zskli¡Node
 *
Ê
;

2950 ià(
»v”£
) {

2951 
Ê
 = 
	`z¦La¡InLexRªge
(
z¦
,&
¿nge
);

2953 
Ê
 = 
	`z¦Fœ¡InLexRªge
(
z¦
,&
¿nge
);

2957 ià(
Ê
 =ğ
NULL
) {

2958 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2959 
	`z¦F»eLexRªge
(&
¿nge
);

2966 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2970 
Ê
 && 
off£t
--) {

2971 ià(
»v”£
) {

2972 
Ê
 =†n->
backw¬d
;

2974 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2978 
Ê
 && 
lim™
--) {

2980 ià(
»v”£
) {

2981 ià(!
	`z¦LexV®ueG‹Mš
(
Ê
->
–e
,&
¿nge
)) ;

2983 ià(!
	`z¦LexV®ueL‹Max
(
Ê
->
–e
,&
¿nge
)) ;

2986 
¿ng–’
++;

2987 
	`addR•lyBulkCBufãr
(
c
,
Ê
->
–e
,
	`sd¦’
(ln->ele));

2990 ià(
»v”£
) {

2991 
Ê
 =†n->
backw¬d
;

2993 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2997 
	`£rv”Pªic
("Unknown sorted setƒncoding");

3000 
	`z¦F»eLexRªge
(&
¿nge
);

3001 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

3002 
	}
}

3004 
	$z¿ngebyËxCommªd
(
ş›Á
 *
c
) {

3005 
	`g’”icZ¿ngebyËxCommªd
(
c
,0);

3006 
	}
}

3008 
	$z»v¿ngebyËxCommªd
(
ş›Á
 *
c
) {

3009 
	`g’”icZ¿ngebyËxCommªd
(
c
,1);

3010 
	}
}

3012 
	$zÿrdCommªd
(
ş›Á
 *
c
) {

3013 
robj
 *
key
 = 
c
->
¬gv
[1];

3014 
robj
 *
zobj
;

3016 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

3017 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

3019 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
zobj
));

3020 
	}
}

3022 
	$zscÜeCommªd
(
ş›Á
 *
c
) {

3023 
robj
 *
key
 = 
c
->
¬gv
[1];

3024 
robj
 *
zobj
;

3025 
scÜe
;

3027 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

3028 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

3030 ià(
	`z£tScÜe
(
zobj
,
c
->
¬gv
[2]->
±r
,&
scÜe
è=ğ
C_ERR
) {

3031 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3033 
	`addR•lyDoubË
(
c
,
scÜe
);

3035 
	}
}

3037 
	$z¿nkG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

3038 
robj
 *
key
 = 
c
->
¬gv
[1];

3039 
robj
 *
–e
 = 
c
->
¬gv
[2];

3040 
robj
 *
zobj
;

3041 
¿nk
;

3043 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

3044 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

3046 
	`£rv”As£¹W™hInfo
(
c
,
–e
,
	`sdsEncodedObjeù
(ele));

3047 
¿nk
 = 
	`z£tRªk
(
zobj
,
–e
->
±r
,
»v”£
);

3048 ià(
¿nk
 >= 0) {

3049 
	`addR•lyLÚgLÚg
(
c
,
¿nk
);

3051 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3053 
	}
}

3055 
	$z¿nkCommªd
(
ş›Á
 *
c
) {

3056 
	`z¿nkG’”icCommªd
(
c
, 0);

3057 
	}
}

3059 
	$z»v¿nkCommªd
(
ş›Á
 *
c
) {

3060 
	`z¿nkG’”icCommªd
(
c
, 1);

3061 
	}
}

3063 
	$zsÿnCommªd
(
ş›Á
 *
c
) {

3064 
robj
 *
o
;

3065 
cursÜ
;

3067 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
C_ERR
) ;

3068 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

3069 
	`checkTy³
(
c
,
o
,
OBJ_ZSET
)) ;

3070 
	`sÿnG’”icCommªd
(
c
,
o
,
cursÜ
);

3071 
	}
}

	@testhelp.h

39 #iâdeà
__TESTHELP_H


40 
	#__TESTHELP_H


	)

42 
	g__çed_‹¡s
 = 0;

43 
	g__‹¡_num
 = 0;

44 
	#‹¡_cÚd
(
desü
,
_c
) do { \

45 
__‹¡_num
++; 
	`´štf
("%d - %s: ", __‹¡_num, 
desü
); \

46 if(
_c
è
	`´štf
("PASSED\n"); {´štf("FAILED\n"); 
__çed_‹¡s
++;} \

47 } 0);

	)

48 
	#‹¡_»pÜt
() do { \

49 
	`´štf
("%de¡s, %d…as£d, %d faed\n", 
__‹¡_num
, \

50 
__‹¡_num
-
__çed_‹¡s
, __failed_tests); \

51 ià(
__çed_‹¡s
) { \

52 
	`´štf
("=== WARNING === We have failedests here...\n"); \

53 
	`ex™
(1); \

55 } 0);

	)

	@util.c

30 
	~"fmaüos.h
"

31 
	~<¡dlib.h
>

32 
	~<¡dio.h
>

33 
	~<¡ršg.h
>

34 
	~<ùy³.h
>

35 
	~<lim™s.h
>

36 
	~<m©h.h
>

37 
	~<uni¡d.h
>

38 
	~<sys/time.h
>

39 
	~<æßt.h
>

40 
	~<¡dšt.h
>

41 
	~<”ºo.h
>

43 
	~"ut.h
"

44 
	~"sha1.h
"

47 
	$¡ršgm©chËn
(cÚ¡ *
·‰”n
, 
·‰”nL’
,

48 cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
)

50 
·‰”nL’
) {

51 
·‰”n
[0]) {

53 
·‰”n
[1] == '*') {

54 
·‰”n
++;

55 
·‰”nL’
--;

57 ià(
·‰”nL’
 == 1)

59 
¡ršgL’
) {

60 ià(
	`¡ršgm©chËn
(
·‰”n
+1, 
·‰”nL’
-1,

61 
¡ršg
, 
¡ršgL’
, 
noÿ£
))

63 
¡ršg
++;

64 
¡ršgL’
--;

69 ià(
¡ršgL’
 == 0)

71 
¡ršg
++;

72 
¡ršgL’
--;

76 
nÙ
, 
m©ch
;

78 
·‰”n
++;

79 
·‰”nL’
--;

80 
nÙ
 = 
·‰”n
[0] == '^';

81 ià(
nÙ
) {

82 
·‰”n
++;

83 
·‰”nL’
--;

85 
m©ch
 = 0;

87 ià(
·‰”n
[0] == '\\') {

88 
·‰”n
++;

89 
·‰”nL’
--;

90 ià(
·‰”n
[0] =ğ
¡ršg
[0])

91 
m©ch
 = 1;

92 } ià(
·‰”n
[0] == ']') {

94 } ià(
·‰”nL’
 == 0) {

95 
·‰”n
--;

96 
·‰”nL’
++;

98 } ià(
·‰”n
[1] =ğ'-' && 
·‰”nL’
 >= 3) {

99 
¡¬t
 = 
·‰”n
[0];

100 
’d
 = 
·‰”n
[2];

101 
c
 = 
¡ršg
[0];

102 ià(
¡¬t
 > 
’d
) {

103 
t
 = 
¡¬t
;

104 
¡¬t
 = 
’d
;

105 
’d
 = 
t
;

107 ià(
noÿ£
) {

108 
¡¬t
 = 
	`tŞow”
(start);

109 
’d
 = 
	`tŞow”
(end);

110 
c
 = 
	`tŞow”
(c);

112 
·‰”n
 += 2;

113 
·‰”nL’
 -= 2;

114 ià(
c
 >ğ
¡¬t
 && c <ğ
’d
)

115 
m©ch
 = 1;

117 ià(!
noÿ£
) {

118 ià(
·‰”n
[0] =ğ
¡ršg
[0])

119 
m©ch
 = 1;

121 ià(
	`tŞow”
(()
·‰”n
[0]è=ğtŞow”(()
¡ršg
[0]))

122 
m©ch
 = 1;

125 
·‰”n
++;

126 
·‰”nL’
--;

128 ià(
nÙ
)

129 
m©ch
 = !match;

130 ià(!
m©ch
)

132 
¡ršg
++;

133 
¡ršgL’
--;

137 ià(
·‰”nL’
 >= 2) {

138 
·‰”n
++;

139 
·‰”nL’
--;

143 ià(!
noÿ£
) {

144 ià(
·‰”n
[0] !ğ
¡ršg
[0])

147 ià(
	`tŞow”
(()
·‰”n
[0]è!ğtŞow”(()
¡ršg
[0]))

150 
¡ršg
++;

151 
¡ršgL’
--;

154 
·‰”n
++;

155 
·‰”nL’
--;

156 ià(
¡ršgL’
 == 0) {

157 *
·‰”n
 == '*') {

158 
·‰”n
++;

159 
·‰”nL’
--;

164 ià(
·‰”nL’
 =ğ0 && 
¡ršgL’
 == 0)

167 
	}
}

169 
	$¡ršgm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
) {

170  
	`¡ršgm©chËn
(
·‰”n
,
	`¡¾’
Õ©‹º),
¡ršg
,¡¾’(¡ršg),
noÿ£
);

171 
	}
}

180 
	$memtŞl
(cÚ¡ *
p
, *
”r
) {

181 cÚ¡ *
u
;

182 
buf
[128];

183 
mul
;

184 
v®
;

185 
dig™s
;

187 ià(
”r
) *err = 0;

190 
u
 = 
p
;

191 ià(*
u
 == '-') u++;

192 *
u
 && 
	`isdig™
(*u)) u++;

193 ià(*
u
 =ğ'\0' || !
	`¡rÿ£cmp
(u,"b")) {

194 
mul
 = 1;

195 } ià(!
	`¡rÿ£cmp
(
u
,"k")) {

196 
mul
 = 1000;

197 } ià(!
	`¡rÿ£cmp
(
u
,"kb")) {

198 
mul
 = 1024;

199 } ià(!
	`¡rÿ£cmp
(
u
,"m")) {

200 
mul
 = 1000*1000;

201 } ià(!
	`¡rÿ£cmp
(
u
,"mb")) {

202 
mul
 = 1024*1024;

203 } ià(!
	`¡rÿ£cmp
(
u
,"g")) {

204 
mul
 = 1000L*1000*1000;

205 } ià(!
	`¡rÿ£cmp
(
u
,"gb")) {

206 
mul
 = 1024L*1024*1024;

208 ià(
”r
) *err = 1;

214 
dig™s
 = 
u
-
p
;

215 ià(
dig™s
 >ğ(
buf
)) {

216 ià(
”r
) *err = 1;

219 
	`memıy
(
buf
,
p
,
dig™s
);

220 
buf
[
dig™s
] = '\0';

222 *
’d±r
;

223 
”ºo
 = 0;

224 
v®
 = 
	`¡¹Şl
(
buf
,&
’d±r
,10);

225 ià((
v®
 =ğ0 && 
”ºo
 =ğ
EINVAL
è|| *
’d±r
 != '\0') {

226 ià(
”r
) *err = 1;

229  
v®
*
mul
;

230 
	}
}

234 
ušt32_t
 
	$dig™s10
(
ušt64_t
 
v
) {

235 ià(
v
 < 10)  1;

236 ià(
v
 < 100)  2;

237 ià(
v
 < 1000)  3;

238 ià(
v
 < 1000000000000UL) {

239 ià(
v
 < 100000000UL) {

240 ià(
v
 < 1000000) {

241 ià(
v
 < 10000)  4;

242  5 + (
v
 >= 100000);

244  7 + (
v
 >= 10000000UL);

246 ià(
v
 < 10000000000UL) {

247  9 + (
v
 >= 1000000000UL);

249  11 + (
v
 >= 100000000000UL);

251  12 + 
	`dig™s10
(
v
 / 1000000000000UL);

252 
	}
}

255 
ušt32_t
 
	$sdig™s10
(
št64_t
 
v
) {

256 ià(
v
 < 0) {

258 
ušt64_t
 
uv
 = (
v
 !ğ
LLONG_MIN
) ?

259 (
ušt64_t
)-
v
 : ((ušt64_tè
LLONG_MAX
)+1;

260  
	`dig™s10
(
uv
)+1;

262  
	`dig™s10
(
v
);

264 
	}
}

277 
	$Î2¡ršg
(*
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
) {

278 cÚ¡ 
dig™s
[201] =

284 
Ãg©ive
;

285 
v®ue
;

289 ià(
sv®ue
 < 0) {

290 ià(
sv®ue
 !ğ
LLONG_MIN
) {

291 
v®ue
 = -
sv®ue
;

293 
v®ue
 = ((è
LLONG_MAX
)+1;

295 
Ãg©ive
 = 1;

297 
v®ue
 = 
sv®ue
;

298 
Ãg©ive
 = 0;

302 
ušt32_t
 cÚ¡ 
Ëngth
 = 
	`dig™s10
(
v®ue
)+
Ãg©ive
;

303 ià(
Ëngth
 >ğ
d¡Ën
)  0;

306 
ušt32_t
 
Ãxt
 = 
Ëngth
;

307 
d¡
[
Ãxt
] = '\0';

308 
Ãxt
--;

309 
v®ue
 >= 100) {

310 cÚ¡ 
i
 = (
v®ue
 % 100) * 2;

311 
v®ue
 /= 100;

312 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

313 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

314 
Ãxt
 -= 2;

318 ià(
v®ue
 < 10) {

319 
d¡
[
Ãxt
] = '0' + (
ušt32_t
è
v®ue
;

321 
i
 = (
ušt32_t
è
v®ue
 * 2;

322 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

323 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

327 ià(
Ãg©ive
è
d¡
[0] = '-';

328  
Ëngth
;

329 
	}
}

343 
	$¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
) {

344 cÚ¡ *
p
 = 
s
;

345 
size_t
 
¶’
 = 0;

346 
Ãg©ive
 = 0;

347 
v
;

349 ià(
¶’
 =ğ
¦’
)

353 ià(
¦’
 =ğ1 && 
p
[0] == '0') {

354 ià(
v®ue
 !ğ
NULL
) *value = 0;

358 ià(
p
[0] == '-') {

359 
Ãg©ive
 = 1;

360 
p
++; 
¶’
++;

363 ià(
¶’
 =ğ
¦’
)

368 ià(
p
[0] >= '1' &&…[0] <= '9') {

369 
v
 = 
p
[0]-'0';

370 
p
++; 
¶’
++;

371 } ià(
p
[0] =ğ'0' && 
¦’
 == 1) {

372 *
v®ue
 = 0;

378 
¶’
 < 
¦’
 && 
p
[0] >= '0' &&…[0] <= '9') {

379 ià(
v
 > (
ULLONG_MAX
 / 10))

381 
v
 *= 10;

383 ià(
v
 > (
ULLONG_MAX
 - (
p
[0]-'0')))

385 
v
 +ğ
p
[0]-'0';

387 
p
++; 
¶’
++;

391 ià(
¶’
 < 
¦’
)

394 ià(
Ãg©ive
) {

395 ià(
v
 > (()(-(
LLONG_MIN
+1))+1))

397 ià(
v®ue
 !ğ
NULL
è*v®uğ-
v
;

399 ià(
v
 > 
LLONG_MAX
)

401 ià(
v®ue
 !ğ
NULL
è*v®uğ
v
;

404 
	}
}

409 
	$¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
) {

410 
Îv®
;

412 ià(!
	`¡ršg2Î
(
s
,
¦’
,&
Îv®
))

415 ià(
Îv®
 < 
LONG_MIN
 ||†lv® > 
LONG_MAX
)

418 *
lv®
 = ()
Îv®
;

420 
	}
}

429 
	$¡ršg2ld
(cÚ¡ *
s
, 
size_t
 
¦’
, *
dp
) {

430 
buf
[256];

431 
v®ue
;

432 *
•Œ
;

434 ià(
¦’
 >ğ(
buf
))  0;

435 
	`memıy
(
buf
,
s
,
¦’
);

436 
buf
[
¦’
] = '\0';

438 
”ºo
 = 0;

439 
v®ue
 = 
	`¡¹Şd
(
buf
, &
•Œ
);

440 ià(
	`is¥aû
(
buf
[0]è|| 
•Œ
[0] != '\0' ||

441 (
”ºo
 =ğ
ERANGE
 &&

442 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

443 
”ºo
 =ğ
EINVAL
 ||

444 
	`i¢ª
(
v®ue
))

447 ià(
dp
è*d°ğ
v®ue
;

449 
	}
}

456 
	$d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
) {

457 ià(
	`i¢ª
(
v®ue
)) {

458 
Ën
 = 
	`¢´štf
(
buf
,len,"nan");

459 } ià(
	`isšf
(
v®ue
)) {

460 ià(
v®ue
 < 0)

461 
Ën
 = 
	`¢´štf
(
buf
,len,"-inf");

463 
Ën
 = 
	`¢´štf
(
buf
,len,"inf");

464 } ià(
v®ue
 == 0) {

466 ià(1.0/
v®ue
 < 0)

467 
Ën
 = 
	`¢´štf
(
buf
,len,"-0");

469 
Ën
 = 
	`¢´štf
(
buf
,len,"0");

471 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

481 
mš
 = -4503599627370495;

482 
max
 = 4503599627370496;

483 ià(
v®ue
 > 
mš
 && v®u< 
max
 && value == (()(()value)))

484 
Ën
 = 
	`Î2¡ršg
(
buf
,Ën,()
v®ue
);

487 
Ën
 = 
	`¢´štf
(
buf
,Ën,"%.17g",
v®ue
);

490  
Ën
;

491 
	}
}

500 
	$ld2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
, 
humªä›ndly
) {

501 
size_t
 
l
;

503 ià(
	`isšf
(
v®ue
)) {

506 ià(
Ën
 < 5)  0;

507 ià(
v®ue
 > 0) {

508 
	`memıy
(
buf
,"inf",3);

509 
l
 = 3;

511 
	`memıy
(
buf
,"-inf",4);

512 
l
 = 4;

514 } ià(
humªä›ndly
) {

520 
l
 = 
	`¢´štf
(
buf
,
Ën
,"%.17Lf", 
v®ue
);

521 ià(
l
+1 > 
Ën
)  0;

523 ià(
	`¡rchr
(
buf
,'.'è!ğ
NULL
) {

524 *
p
 = 
buf
+
l
-1;

525 *
p
 == '0') {

526 
p
--;

527 
l
--;

529 ià(*
p
 =ğ'.'è
l
--;

532 
l
 = 
	`¢´štf
(
buf
,
Ën
,"%.17Lg", 
v®ue
);

533 ià(
l
+1 > 
Ën
)  0;

535 
buf
[
l
] = '\0';

536  
l
;

537 
	}
}

543 
	$g‘RªdomHexCh¬s
(*
p
, 
Ën
) {

544 *
ch¬£t
 = "0123456789abcdef";

545 
j
;

548 
£ed_š™Ÿlized
 = 0;

549 
£ed
[20];

550 
ušt64_t
 
couÁ”
 = 0;

552 ià(!
£ed_š™Ÿlized
) {

557 
FILE
 *
å
 = 
	`fİ’
("/dev/urandom","r");

558 ià(
å
 && 
	`ä—d
(
£ed
,(seed),1,fp) == 1)

559 
£ed_š™Ÿlized
 = 1;

560 ià(
å
è
	`fşo£
(fp);

563 ià(
£ed_š™Ÿlized
) {

564 
Ën
) {

565 
dige¡
[20];

566 
SHA1_CTX
 
ùx
;

567 
cİyËn
 = 
Ën
 > 20 ? 20 :†en;

569 
	`SHA1In™
(&
ùx
);

570 
	`SHA1Upd©e
(&
ùx
, 
£ed
, (seed));

571 
	`SHA1Upd©e
(&
ùx
, (*)&
couÁ”
,(counter));

572 
	`SHA1Fš®
(
dige¡
, &
ùx
);

573 
couÁ”
++;

575 
	`memıy
(
p
,
dige¡
,
cİyËn
);

577 
j
 = 0; j < 
cİyËn
; j++è
p
[j] = 
ch¬£t
[p[j] & 0x0F];

578 
Ën
 -ğ
cİyËn
;

579 
p
 +ğ
cİyËn
;

585 *
x
 = 
p
;

586 
l
 = 
Ën
;

587 
timev®
 
tv
;

588 
pid_t
 
pid
 = 
	`g‘pid
();

591 
	`g‘timeofday
(&
tv
,
NULL
);

592 ià(
l
 >ğ(
tv
.
tv_u£c
)) {

593 
	`memıy
(
x
,&
tv
.
tv_u£c
,(tv.tv_usec));

594 
l
 -ğ(
tv
.
tv_u£c
);

595 
x
 +ğ(
tv
.
tv_u£c
);

597 ià(
l
 >ğ(
tv
.
tv_£c
)) {

598 
	`memıy
(
x
,&
tv
.
tv_£c
,(tv.tv_sec));

599 
l
 -ğ(
tv
.
tv_£c
);

600 
x
 +ğ(
tv
.
tv_£c
);

602 ià(
l
 >ğ(
pid
)) {

603 
	`memıy
(
x
,&
pid
,(pid));

604 
l
 -ğ(
pid
);

605 
x
 +ğ(
pid
);

609 
j
 = 0; j < 
Ën
; j++) {

610 
p
[
j
] ^ğ
	`¿nd
();

611 
p
[
j
] = 
ch¬£t
[p[j] & 0x0F];

614 
	}
}

623 
sds
 
	$g‘AbsŞu‹P©h
(*
f’ame
) {

624 
cwd
[1024];

625 
sds
 
ab¥©h
;

626 
sds
 
»Í©h
 = 
	`sd¢ew
(
f’ame
);

628 
»Í©h
 = 
	`sd¡rim
(relpath," \r\n\t");

629 ià(
»Í©h
[0] == '/') „elpath;

632 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

633 
	`sdsä“
(
»Í©h
);

634  
NULL
;

636 
ab¥©h
 = 
	`sd¢ew
(
cwd
);

637 ià(
	`sd¦’
(
ab¥©h
) &&‡bspath[sdslen(abspath)-1] != '/')

638 
ab¥©h
 = 
	`sdsÿt
(abspath,"/");

646 
	`sd¦’
(
»Í©h
) >= 3 &&

647 
»Í©h
[0] == '.' &&„elpath[1] == '.' &&„elpath[2] == '/')

649 
	`sd¤ªge
(
»Í©h
,3,-1);

650 ià(
	`sd¦’
(
ab¥©h
) > 1) {

651 *
p
 = 
ab¥©h
 + 
	`sd¦’
(abspath)-2;

652 
ŒimËn
 = 1;

654 *
p
 != '/') {

655 
p
--;

656 
ŒimËn
++;

658 
	`sd¤ªge
(
ab¥©h
,0,-(
ŒimËn
+1));

663 
ab¥©h
 = 
	`sdsÿtsds
×b¥©h,
»Í©h
);

664 
	`sdsä“
(
»Í©h
);

665  
ab¥©h
;

666 
	}
}

672 
	$·thIsBa£Name
(*
·th
) {

673  
	`¡rchr
(
·th
,'/'è=ğ
NULL
 && strchr(path,'\\') == NULL;

674 
	}
}

676 #ifdeà
REDIS_TEST


677 
	~<as£¹.h
>

679 
	$‹¡_¡ršg2Î
() {

680 
buf
[32];

681 
v
;

684 
	`¡rıy
(
buf
,"+1");

685 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

688 
	`¡rıy
(
buf
," 1");

689 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

692 
	`¡rıy
(
buf
,"1 ");

693 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

696 
	`¡rıy
(
buf
,"01");

697 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

699 
	`¡rıy
(
buf
,"-1");

700 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

701 
	`as£¹
(
v
 == -1);

703 
	`¡rıy
(
buf
,"0");

704 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

705 
	`as£¹
(
v
 == 0);

707 
	`¡rıy
(
buf
,"1");

708 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

709 
	`as£¹
(
v
 == 1);

711 
	`¡rıy
(
buf
,"99");

712 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

713 
	`as£¹
(
v
 == 99);

715 
	`¡rıy
(
buf
,"-99");

716 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

717 
	`as£¹
(
v
 == -99);

719 
	`¡rıy
(
buf
,"-9223372036854775808");

720 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

721 
	`as£¹
(
v
 =ğ
LLONG_MIN
);

723 
	`¡rıy
(
buf
,"-9223372036854775809");

724 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

726 
	`¡rıy
(
buf
,"9223372036854775807");

727 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

728 
	`as£¹
(
v
 =ğ
LLONG_MAX
);

730 
	`¡rıy
(
buf
,"9223372036854775808");

731 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

732 
	}
}

734 
	$‹¡_¡ršg2l
() {

735 
buf
[32];

736 
v
;

739 
	`¡rıy
(
buf
,"+1");

740 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

743 
	`¡rıy
(
buf
,"01");

744 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

746 
	`¡rıy
(
buf
,"-1");

747 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

748 
	`as£¹
(
v
 == -1);

750 
	`¡rıy
(
buf
,"0");

751 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

752 
	`as£¹
(
v
 == 0);

754 
	`¡rıy
(
buf
,"1");

755 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

756 
	`as£¹
(
v
 == 1);

758 
	`¡rıy
(
buf
,"99");

759 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

760 
	`as£¹
(
v
 == 99);

762 
	`¡rıy
(
buf
,"-99");

763 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

764 
	`as£¹
(
v
 == -99);

766 #ià
LONG_MAX
 !ğ
LLONG_MAX


767 
	`¡rıy
(
buf
,"-2147483648");

768 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

769 
	`as£¹
(
v
 =ğ
LONG_MIN
);

771 
	`¡rıy
(
buf
,"-2147483649");

772 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

774 
	`¡rıy
(
buf
,"2147483647");

775 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

776 
	`as£¹
(
v
 =ğ
LONG_MAX
);

778 
	`¡rıy
(
buf
,"2147483648");

779 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

781 
	}
}

783 
	$‹¡_Î2¡ršg
() {

784 
buf
[32];

785 
v
;

786 
sz
;

788 
v
 = 0;

789 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

790 
	`as£¹
(
sz
 == 1);

791 
	`as£¹
(!
	`¡rcmp
(
buf
, "0"));

793 
v
 = -1;

794 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

795 
	`as£¹
(
sz
 == 2);

796 
	`as£¹
(!
	`¡rcmp
(
buf
, "-1"));

798 
v
 = 99;

799 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

800 
	`as£¹
(
sz
 == 2);

801 
	`as£¹
(!
	`¡rcmp
(
buf
, "99"));

803 
v
 = -99;

804 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

805 
	`as£¹
(
sz
 == 3);

806 
	`as£¹
(!
	`¡rcmp
(
buf
, "-99"));

808 
v
 = -2147483648;

809 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

810 
	`as£¹
(
sz
 == 11);

811 
	`as£¹
(!
	`¡rcmp
(
buf
, "-2147483648"));

813 
v
 = 
LLONG_MIN
;

814 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

815 
	`as£¹
(
sz
 == 20);

816 
	`as£¹
(!
	`¡rcmp
(
buf
, "-9223372036854775808"));

818 
v
 = 
LLONG_MAX
;

819 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

820 
	`as£¹
(
sz
 == 19);

821 
	`as£¹
(!
	`¡rcmp
(
buf
, "9223372036854775807"));

822 
	}
}

824 
	#UNUSED
(
x
è()(x)

	)

825 
	$utTe¡
(
¬gc
, **
¬gv
) {

826 
	`UNUSED
(
¬gc
);

827 
	`UNUSED
(
¬gv
);

829 
	`‹¡_¡ršg2Î
();

830 
	`‹¡_¡ršg2l
();

831 
	`‹¡_Î2¡ršg
();

833 
	}
}

	@util.h

30 #iâdeà
__REDIS_UTIL_H


31 
	#__REDIS_UTIL_H


	)

33 
	~<¡dšt.h
>

34 
	~"sds.h
"

36 
¡ršgm©chËn
(cÚ¡ *
p
, 
¶’
, cÚ¡ *
s
, 
¦’
, 
noÿ£
);

37 
¡ršgm©ch
(cÚ¡ *
p
, cÚ¡ *
s
, 
noÿ£
);

38 
memtŞl
(cÚ¡ *
p
, *
”r
);

39 
ušt32_t
 
dig™s10
(
ušt64_t
 
v
);

40 
ušt32_t
 
sdig™s10
(
št64_t
 
v
);

41 
Î2¡ršg
(*
s
, 
size_t
 
Ën
, 
v®ue
);

42 
¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

43 
¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

44 
¡ršg2ld
(cÚ¡ *
s
, 
size_t
 
¦’
, *
dp
);

45 
d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
);

46 
ld2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
, 
humªä›ndly
);

47 
sds
 
g‘AbsŞu‹P©h
(*
f’ame
);

48 
·thIsBa£Name
(*
·th
);

50 #ifdeà
REDIS_TEST


51 
utTe¡
(
¬gc
, **
¬gv
);

	@version.h

1 
	#REDIS_VERSION
 "999.999.999"

	)

	@ziplist.c

104 
	~<¡dio.h
>

105 
	~<¡dlib.h
>

106 
	~<¡ršg.h
>

107 
	~<¡dšt.h
>

108 
	~<lim™s.h
>

109 
	~"zm®loc.h
"

110 
	~"ut.h
"

111 
	~"zli¡.h
"

112 
	~"’dŸncÚv.h
"

113 
	~"»di§s£¹.h
"

115 
	#ZIP_END
 255

	)

116 
	#ZIP_BIGLEN
 254

	)

119 
	#ZIP_STR_MASK
 0xc0

	)

120 
	#ZIP_INT_MASK
 0x30

	)

121 
	#ZIP_STR_06B
 (0 << 6)

	)

122 
	#ZIP_STR_14B
 (1 << 6)

	)

123 
	#ZIP_STR_32B
 (2 << 6)

	)

124 
	#ZIP_INT_16B
 (0xc0 | 0<<4)

	)

125 
	#ZIP_INT_32B
 (0xc0 | 1<<4)

	)

126 
	#ZIP_INT_64B
 (0xc0 | 2<<4)

	)

127 
	#ZIP_INT_24B
 (0xc0 | 3<<4)

	)

128 
	#ZIP_INT_8B
 0xã

	)

130 
	#ZIP_INT_IMM_MASK
 0x0f

	)

131 
	#ZIP_INT_IMM_MIN
 0xf1

	)

132 
	#ZIP_INT_IMM_MAX
 0xfd

	)

133 
	#ZIP_INT_IMM_VAL
(
v
è(v & 
ZIP_INT_IMM_MASK
)

	)

135 
	#INT24_MAX
 0x7fffff

	)

136 
	#INT24_MIN
 (-
INT24_MAX
 - 1)

	)

139 
	#ZIP_IS_STR
(
’c
è((Óncè& 
ZIP_STR_MASK
è< ZIP_STR_MASK)

	)

142 
	#ZIPLIST_BYTES
(
zl
è(*((
ušt32_t
*)(zl)))

	)

143 
	#ZIPLIST_TAIL_OFFSET
(
zl
è(*((
ušt32_t
*)((zl)+(ušt32_t))))

	)

144 
	#ZIPLIST_LENGTH
(
zl
è(*((
ušt16_t
*)((zl)+(
ušt32_t
)*2)))

	)

145 
	#ZIPLIST_HEADER_SIZE
 ((
ušt32_t
)*2+(
ušt16_t
))

	)

146 
	#ZIPLIST_END_SIZE
 ((
ušt8_t
))

	)

147 
	#ZIPLIST_ENTRY_HEAD
(
zl
è((zl)+
ZIPLIST_HEADER_SIZE
)

	)

148 
	#ZIPLIST_ENTRY_TAIL
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl)))

	)

149 
	#ZIPLIST_ENTRY_END
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-1)

	)

153 
	#ZIPLIST_INCR_LENGTH
(
zl
,
šü
) { \

154 ià(
	`ZIPLIST_LENGTH
(
zl
è< 
UINT16_MAX
) \

155 
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(šŒev16ifbe(ZIPLIST_LENGTH(zl))+
šü
); \

156 }

	)

158 
	szËÁry
 {

159 
	m´ev¿wËnsize
, 
	m´ev¿wËn
;

160 
	mËnsize
, 
	mËn
;

161 
	mh—d”size
;

162 
	m’codšg
;

163 *
	mp
;

164 } 
	tzËÁry
;

166 
	#ZIPLIST_ENTRY_ZERO
(
zË
) { \

167 (
zË
)->
´ev¿wËnsize
 = (zË)->
´ev¿wËn
 = 0; \

168 (
zË
)->
Ënsize
 = (zË)->
Ën
 = (zË)->
h—d”size
 = 0; \

169 (
zË
)->
’codšg
 = 0; \

170 (
zË
)->
p
 = 
NULL
; \

171 }

	)

175 
	#ZIP_ENTRY_ENCODING
(
±r
, 
’codšg
) do { \

176 (
’codšg
èğ(
±r
[0]); \

177 ià((
’codšg
è< 
ZIP_STR_MASK
) (encoding) &= ZIP_STR_MASK; \

178 } 0)

	)

180 
zli¡R•r
(*
zl
);

183 
	$zIÁSize
(
’codšg
) {

184 
’codšg
) {

185 
ZIP_INT_8B
:  1;

186 
ZIP_INT_16B
:  2;

187 
ZIP_INT_24B
:  3;

188 
ZIP_INT_32B
:  4;

189 
ZIP_INT_64B
:  8;

192 
	`as£¹
(
NULL
);

194 
	}
}

198 
	$zEncodeL’gth
(*
p
, 
’codšg
, 
¿wËn
) {

199 
Ën
 = 1, 
buf
[5];

201 ià(
	`ZIP_IS_STR
(
’codšg
)) {

204 ià(
¿wËn
 <= 0x3f) {

205 ià(!
p
è 
Ën
;

206 
buf
[0] = 
ZIP_STR_06B
 | 
¿wËn
;

207 } ià(
¿wËn
 <= 0x3fff) {

208 
Ën
 += 1;

209 ià(!
p
è 
Ën
;

210 
buf
[0] = 
ZIP_STR_14B
 | ((
¿wËn
 >> 8) & 0x3f);

211 
buf
[1] = 
¿wËn
 & 0xff;

213 
Ën
 += 4;

214 ià(!
p
è 
Ën
;

215 
buf
[0] = 
ZIP_STR_32B
;

216 
buf
[1] = (
¿wËn
 >> 24) & 0xff;

217 
buf
[2] = (
¿wËn
 >> 16) & 0xff;

218 
buf
[3] = (
¿wËn
 >> 8) & 0xff;

219 
buf
[4] = 
¿wËn
 & 0xff;

223 ià(!
p
è 
Ën
;

224 
buf
[0] = 
’codšg
;

228 
	`memıy
(
p
,
buf
,
Ën
);

229  
Ën
;

230 
	}
}

236 
	#ZIP_DECODE_LENGTH
(
±r
, 
’codšg
, 
Ënsize
, 
Ën
) do { \

237 
	`ZIP_ENTRY_ENCODING
((
±r
), (
’codšg
)); \

238 ià((
’codšg
è< 
ZIP_STR_MASK
) { \

239 ià((
’codšg
è=ğ
ZIP_STR_06B
) { \

240 (
Ënsize
) = 1; \

241 (
Ën
èğ(
±r
)[0] & 0x3f; \

242 } ià((
’codšg
è=ğ
ZIP_STR_14B
) { \

243 (
Ënsize
) = 2; \

244 (
Ën
èğ(((
±r
)[0] & 0x3f) << 8) | (ptr)[1]; \

245 } ià(
’codšg
 =ğ
ZIP_STR_32B
) { \

246 (
Ënsize
) = 5; \

247 (
Ën
èğ((
±r
)[1] << 24) | \

248 ((
±r
)[2] << 16) | \

249 ((
±r
)[3] << 8) | \

250 ((
±r
)[4]); \

252 
	`as£¹
(
NULL
); \

255 (
Ënsize
) = 1; \

256 (
Ën
èğ
	`zIÁSize
(
’codšg
); \

258 } 0);

	)

262 
	$zP»vEncodeL’gth
(*
p
, 
Ën
) {

263 ià(
p
 =ğ
NULL
) {

264  (
Ën
 < 
ZIP_BIGLEN
) ? 1 : (len)+1;

266 ià(
Ën
 < 
ZIP_BIGLEN
) {

267 
p
[0] = 
Ën
;

270 
p
[0] = 
ZIP_BIGLEN
;

271 
	`memıy
(
p
+1,&
Ën
,(len));

272 
	`mem»v32ifbe
(
p
+1);

273  1+(
Ën
);

276 
	}
}

280 
	$zP»vEncodeL’gthFÜûL¬ge
(*
p
, 
Ën
) {

281 ià(
p
 =ğ
NULL
) ;

282 
p
[0] = 
ZIP_BIGLEN
;

283 
	`memıy
(
p
+1,&
Ën
,(len));

284 
	`mem»v32ifbe
(
p
+1);

285 
	}
}

289 
	#ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
) do { \

290 ià((
±r
)[0] < 
ZIP_BIGLEN
) { \

291 (
´evËnsize
) = 1; \

293 (
´evËnsize
) = 5; \

295 } 0);

	)

299 
	#ZIP_DECODE_PREVLEN
(
±r
, 
´evËnsize
, 
´evËn
) do { \

300 
	`ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
); \

301 ià((
´evËnsize
) == 1) { \

302 (
´evËn
èğ(
±r
)[0]; \

303 } ià((
´evËnsize
) == 5) { \

304 
	`as£¹
(((
´evËnsize
)) == 4); \

305 
	`memıy
(&(
´evËn
), ((*)(
±r
)) + 1, 4); \

306 
	`mem»v32ifbe
(&
´evËn
); \

308 } 0);

	)

312 
	$zP»vL’By‹Diff
(*
p
, 
Ën
) {

313 
´evËnsize
;

314 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

315  
	`zP»vEncodeL’gth
(
NULL
, 
Ën
è- 
´evËnsize
;

316 
	}
}

319 
	$zRawEÁryL’gth
(*
p
) {

320 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

321 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

322 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

323  
´evËnsize
 + 
Ënsize
 + 
Ën
;

324 
	}
}

328 
	$zTryEncodšg
(*
’Œy
, 
’ŒyËn
, *
v
, *
’codšg
) {

329 
v®ue
;

331 ià(
’ŒyËn
 >= 32 ||ƒntrylen == 0)  0;

332 ià(
	`¡ršg2Î
((*)
’Œy
,
’ŒyËn
,&
v®ue
)) {

335 ià(
v®ue
 >= 0 && value <= 12) {

336 *
’codšg
 = 
ZIP_INT_IMM_MIN
+
v®ue
;

337 } ià(
v®ue
 >ğ
INT8_MIN
 && v®u<ğ
INT8_MAX
) {

338 *
’codšg
 = 
ZIP_INT_8B
;

339 } ià(
v®ue
 >ğ
INT16_MIN
 && v®u<ğ
INT16_MAX
) {

340 *
’codšg
 = 
ZIP_INT_16B
;

341 } ià(
v®ue
 >ğ
INT24_MIN
 && v®u<ğ
INT24_MAX
) {

342 *
’codšg
 = 
ZIP_INT_24B
;

343 } ià(
v®ue
 >ğ
INT32_MIN
 && v®u<ğ
INT32_MAX
) {

344 *
’codšg
 = 
ZIP_INT_32B
;

346 *
’codšg
 = 
ZIP_INT_64B
;

348 *
v
 = 
v®ue
;

352 
	}
}

355 
	$zSaveIÁeg”
(*
p
, 
št64_t
 
v®ue
, 
’codšg
) {

356 
št16_t
 
i16
;

357 
št32_t
 
i32
;

358 
št64_t
 
i64
;

359 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

360 ((
št8_t
*)
p
)[0] = (št8_t)
v®ue
;

361 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

362 
i16
 = 
v®ue
;

363 
	`memıy
(
p
,&
i16
,(i16));

364 
	`mem»v16ifbe
(
p
);

365 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

366 
i32
 = 
v®ue
<<8;

367 
	`mem»v32ifbe
(&
i32
);

368 
	`memıy
(
p
,((
ušt8_t
*)&
i32
)+1,(i32)-(uint8_t));

369 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

370 
i32
 = 
v®ue
;

371 
	`memıy
(
p
,&
i32
,(i32));

372 
	`mem»v32ifbe
(
p
);

373 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

374 
i64
 = 
v®ue
;

375 
	`memıy
(
p
,&
i64
,(i64));

376 
	`mem»v64ifbe
(
p
);

377 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

380 
	`as£¹
(
NULL
);

382 
	}
}

385 
št64_t
 
	$zLßdIÁeg”
(*
p
, 
’codšg
) {

386 
št16_t
 
i16
;

387 
št32_t
 
i32
;

388 
št64_t
 
i64
, 
»t
 = 0;

389 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

390 
»t
 = ((
št8_t
*)
p
)[0];

391 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

392 
	`memıy
(&
i16
,
p
,(i16));

393 
	`mem»v16ifbe
(&
i16
);

394 
»t
 = 
i16
;

395 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

396 
	`memıy
(&
i32
,
p
,(i32));

397 
	`mem»v32ifbe
(&
i32
);

398 
»t
 = 
i32
;

399 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

400 
i32
 = 0;

401 
	`memıy
(((
ušt8_t
*)&
i32
)+1,
p
,(i32)-(uint8_t));

402 
	`mem»v32ifbe
(&
i32
);

403 
»t
 = 
i32
>>8;

404 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

405 
	`memıy
(&
i64
,
p
,(i64));

406 
	`mem»v64ifbe
(&
i64
);

407 
»t
 = 
i64
;

408 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

409 
»t
 = (
’codšg
 & 
ZIP_INT_IMM_MASK
)-1;

411 
	`as£¹
(
NULL
);

413  
»t
;

414 
	}
}

417 
	$zEÁry
(*
p
, 
zËÁry
 *
e
) {

419 
	`ZIP_DECODE_PREVLEN
(
p
, 
e
->
´ev¿wËnsize
,ƒ->
´ev¿wËn
);

420 
	`ZIP_DECODE_LENGTH
(
p
 + 
e
->
´ev¿wËnsize
,ƒ->
’codšg
,ƒ->
Ënsize
,ƒ->
Ën
);

421 
e
->
h—d”size
 =ƒ->
´ev¿wËnsize
 +ƒ->
Ënsize
;

422 
e
->
p
 =…;

423 
	}
}

426 *
	$zli¡New
() {

427 
by‹s
 = 
ZIPLIST_HEADER_SIZE
+1;

428 *
zl
 = 
	`zm®loc
(
by‹s
);

429 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
by‹s
);

430 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
ZIPLIST_HEADER_SIZE
);

431 
	`ZIPLIST_LENGTH
(
zl
) = 0;

432 
zl
[
by‹s
-1] = 
ZIP_END
;

433  
zl
;

434 
	}
}

437 *
	$zli¡Resize
(*
zl
, 
Ën
) {

438 
zl
 = 
	`z»®loc
(zl,
Ën
);

439 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
Ën
);

440 
zl
[
Ën
-1] = 
ZIP_END
;

441  
zl
;

442 
	}
}

464 *
	$__zli¡CasÿdeUpd©e
(*
zl
, *
p
) {

465 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
¿wËn
, 
¿wËnsize
;

466 
size_t
 
off£t
, 
noff£t
, 
exŒa
;

467 *
Å
;

468 
zËÁry
 
cur
, 
Ãxt
;

470 
p
[0] !ğ
ZIP_END
) {

471 
	`zEÁry
(
p
, &
cur
);

472 
¿wËn
 = 
cur
.
h—d”size
 + cur.
Ën
;

473 
¿wËnsize
 = 
	`zP»vEncodeL’gth
(
NULL
,
¿wËn
);

476 ià(
p
[
¿wËn
] =ğ
ZIP_END
) ;

477 
	`zEÁry
(
p
+
¿wËn
, &
Ãxt
);

480 ià(
Ãxt
.
´ev¿wËn
 =ğ
¿wËn
) ;

482 ià(
Ãxt
.
´ev¿wËnsize
 < 
¿wËnsize
) {

485 
off£t
 = 
p
-
zl
;

486 
exŒa
 = 
¿wËnsize
-
Ãxt
.
´ev¿wËnsize
;

487 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
exŒa
);

488 
p
 = 
zl
+
off£t
;

491 
Å
 = 
p
+
¿wËn
;

492 
noff£t
 = 
Å
-
zl
;

495 ià((
zl
+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl))è!ğ
Å
) {

496 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

497 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
exŒa
);

501 
	`memmove
(
Å
+
¿wËnsize
,

502 
Å
+
Ãxt
.
´ev¿wËnsize
,

503 
cu¾’
-
noff£t
-
Ãxt
.
´ev¿wËnsize
-1);

504 
	`zP»vEncodeL’gth
(
Å
,
¿wËn
);

507 
p
 +ğ
¿wËn
;

508 
cu¾’
 +ğ
exŒa
;

510 ià(
Ãxt
.
´ev¿wËnsize
 > 
¿wËnsize
) {

513 
	`zP»vEncodeL’gthFÜûL¬ge
(
p
+
¿wËn
,rawlen);

515 
	`zP»vEncodeL’gth
(
p
+
¿wËn
,rawlen);

522  
zl
;

523 
	}
}

526 *
	$__zli¡D–‘e
(*
zl
, *
p
, 
num
) {

527 
i
, 
tÙËn
, 
d–‘ed
 = 0;

528 
size_t
 
off£t
;

529 
Ãxtdiff
 = 0;

530 
zËÁry
 
fœ¡
, 

;

532 
	`zEÁry
(
p
, &
fœ¡
);

533 
i
 = 0; 
p
[0] !ğ
ZIP_END
 && i < 
num
; i++) {

534 
p
 +ğ
	`zRawEÁryL’gth
(p);

535 
d–‘ed
++;

538 
tÙËn
 = 
p
-
fœ¡
.p;

539 ià(
tÙËn
 > 0) {

540 ià(
p
[0] !ğ
ZIP_END
) {

545 
Ãxtdiff
 = 
	`zP»vL’By‹Diff
(
p
,
fœ¡
.
´ev¿wËn
);

546 
p
 -ğ
Ãxtdiff
;

547 
	`zP»vEncodeL’gth
(
p
,
fœ¡
.
´ev¿wËn
);

550 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

551 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))-
tÙËn
);

556 
	`zEÁry
(
p
, &

);

557 ià(
p
[

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

558 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

559 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

563 
	`memmove
(
fœ¡
.
p
,p,

564 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
))-(
p
-zl)-1);

567 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

568 
	`šŒev32ifbe
((
fœ¡
.
p
-
zl
)-fœ¡.
´ev¿wËn
);

572 
off£t
 = 
fœ¡
.
p
-
zl
;

573 
zl
 = 
	`zli¡Resize
(zl, 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-
tÙËn
+
Ãxtdiff
);

574 
	`ZIPLIST_INCR_LENGTH
(
zl
,-
d–‘ed
);

575 
p
 = 
zl
+
off£t
;

579 ià(
Ãxtdiff
 != 0)

580 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
);

582  
zl
;

583 
	}
}

586 *
	$__zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

587 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
»qËn
;

588 
´evËnsize
, 
´evËn
 = 0;

589 
size_t
 
off£t
;

590 
Ãxtdiff
 = 0;

591 
’codšg
 = 0;

592 
v®ue
 = 123456789;

595 
zËÁry
 

;

598 ià(
p
[0] !ğ
ZIP_END
) {

599 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

601 *
±a
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

602 ià(
±a
[0] !ğ
ZIP_END
) {

603 
´evËn
 = 
	`zRawEÁryL’gth
(
±a
);

608 ià(
	`zTryEncodšg
(
s
,
¦’
,&
v®ue
,&
’codšg
)) {

610 
»qËn
 = 
	`zIÁSize
(
’codšg
);

614 
»qËn
 = 
¦’
;

618 
»qËn
 +ğ
	`zP»vEncodeL’gth
(
NULL
,
´evËn
);

619 
»qËn
 +ğ
	`zEncodeL’gth
(
NULL
,
’codšg
,
¦’
);

624 
Ãxtdiff
 = (
p
[0] !ğ
ZIP_END
è? 
	`zP»vL’By‹Diff
Õ,
»qËn
) : 0;

627 
off£t
 = 
p
-
zl
;

628 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
»qËn
+
Ãxtdiff
);

629 
p
 = 
zl
+
off£t
;

632 ià(
p
[0] !ğ
ZIP_END
) {

634 
	`memmove
(
p
+
»qËn
,p-
Ãxtdiff
,
cu¾’
-
off£t
-1+nextdiff);

637 
	`zP»vEncodeL’gth
(
p
+
»qËn
,reqlen);

640 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

641 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
»qËn
);

646 
	`zEÁry
(
p
+
»qËn
, &

);

647 ià(
p
[
»qËn
+

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

648 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

649 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

653 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
p
-zl);

658 ià(
Ãxtdiff
 != 0) {

659 
off£t
 = 
p
-
zl
;

660 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
+
»qËn
);

661 
p
 = 
zl
+
off£t
;

665 
p
 +ğ
	`zP»vEncodeL’gth
Õ,
´evËn
);

666 
p
 +ğ
	`zEncodeL’gth
Õ,
’codšg
,
¦’
);

667 ià(
	`ZIP_IS_STR
(
’codšg
)) {

668 
	`memıy
(
p
,
s
,
¦’
);

670 
	`zSaveIÁeg”
(
p
,
v®ue
,
’codšg
);

672 
	`ZIPLIST_INCR_LENGTH
(
zl
,1);

673  
zl
;

674 
	}
}

691 *
	$zli¡M”ge
(**
fœ¡
, **
£cÚd
) {

693 ià(
fœ¡
 =ğ
NULL
 || *fœ¡ =ğNULL || 
£cÚd
 == NULL || *second == NULL)

694  
NULL
;

697 ià(*
fœ¡
 =ğ*
£cÚd
)

698  
NULL
;

700 
size_t
 
fœ¡_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
fœ¡
));

701 
size_t
 
fœ¡_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
fœ¡
));

703 
size_t
 
£cÚd_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
£cÚd
));

704 
size_t
 
£cÚd_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
£cÚd
));

706 
­³nd
;

707 *
sourû
, *
rg‘
;

708 
size_t
 
rg‘_by‹s
, 
sourû_by‹s
;

712 ià(
fœ¡_Ën
 >ğ
£cÚd_Ën
) {

714 
rg‘
 = *
fœ¡
;

715 
rg‘_by‹s
 = 
fœ¡_by‹s
;

716 
sourû
 = *
£cÚd
;

717 
sourû_by‹s
 = 
£cÚd_by‹s
;

718 
­³nd
 = 1;

721 
rg‘
 = *
£cÚd
;

722 
rg‘_by‹s
 = 
£cÚd_by‹s
;

723 
sourû
 = *
fœ¡
;

724 
sourû_by‹s
 = 
fœ¡_by‹s
;

725 
­³nd
 = 0;

729 
size_t
 
zlby‹s
 = 
fœ¡_by‹s
 + 
£cÚd_by‹s
 -

730 
ZIPLIST_HEADER_SIZE
 - 
ZIPLIST_END_SIZE
;

731 
size_t
 
zÎ’gth
 = 
fœ¡_Ën
 + 
£cÚd_Ën
;

734 
zÎ’gth
 = zÎ’gth < 
UINT16_MAX
 ? zllength : UINT16_MAX;

737 
size_t
 
fœ¡_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
fœ¡
));

738 
size_t
 
£cÚd_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
£cÚd
));

741 
rg‘
 = 
	`z»®loc
Ñ¬g‘, 
zlby‹s
);

742 ià(
­³nd
) {

746 
	`memıy
(
rg‘
 + 
rg‘_by‹s
 - 
ZIPLIST_END_SIZE
,

747 
sourû
 + 
ZIPLIST_HEADER_SIZE
,

748 
sourû_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

754 
	`memmove
(
rg‘
 + 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
,

755 
rg‘
 + 
ZIPLIST_HEADER_SIZE
,

756 
rg‘_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

757 
	`memıy
(
rg‘
, 
sourû
, 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
);

761 
	`ZIPLIST_BYTES
(
rg‘
èğ
	`šŒev32ifbe
(
zlby‹s
);

762 
	`ZIPLIST_LENGTH
(
rg‘
èğ
	`šŒev16ifbe
(
zÎ’gth
);

768 
	`ZIPLIST_TAIL_OFFSET
(
rg‘
èğ
	`šŒev32ifbe
(

769 (
fœ¡_by‹s
 - 
ZIPLIST_END_SIZE
) +

770 (
£cÚd_off£t
 - 
ZIPLIST_HEADER_SIZE
));

776 
rg‘
 = 
	`__zli¡CasÿdeUpd©e
Ñ¬g‘,¬g‘+
fœ¡_off£t
);

779 ià(
­³nd
) {

780 
	`zä“
(*
£cÚd
);

781 *
£cÚd
 = 
NULL
;

782 *
fœ¡
 = 
rg‘
;

784 
	`zä“
(*
fœ¡
);

785 *
fœ¡
 = 
NULL
;

786 *
£cÚd
 = 
rg‘
;

788  
rg‘
;

789 
	}
}

791 *
	$zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
) {

792 *
p
;

793 
p
 = (
wh”e
 =ğ
ZIPLIST_HEAD
è? 
	`ZIPLIST_ENTRY_HEAD
(
zl
è: 
	`ZIPLIST_ENTRY_END
(zl);

794  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

795 
	}
}

800 *
	$zli¡Index
(*
zl
, 
šdex
) {

801 *
p
;

802 
´evËnsize
, 
´evËn
 = 0;

803 ià(
šdex
 < 0) {

804 
šdex
 = (-index)-1;

805 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

806 ià(
p
[0] !ğ
ZIP_END
) {

807 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

808 
´evËn
 > 0 && 
šdex
--) {

809 
p
 -ğ
´evËn
;

810 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

814 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

815 
p
[0] !ğ
ZIP_END
 && 
šdex
--) {

816 
p
 +ğ
	`zRawEÁryL’gth
(p);

819  (
p
[0] =ğ
ZIP_END
 || 
šdex
 > 0è? 
NULL
 :…;

820 
	}
}

828 *
	$zli¡Next
(*
zl
, *
p
) {

829 ((è
zl
);

834 ià(
p
[0] =ğ
ZIP_END
) {

835  
NULL
;

838 
p
 +ğ
	`zRawEÁryL’gth
(p);

839 ià(
p
[0] =ğ
ZIP_END
) {

840  
NULL
;

843  
p
;

844 
	}
}

847 *
	$zli¡P»v
(*
zl
, *
p
) {

848 
´evËnsize
, 
´evËn
 = 0;

853 ià(
p
[0] =ğ
ZIP_END
) {

854 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

855  (
p
[0] =ğ
ZIP_END
è? 
NULL
 :…;

856 } ià(
p
 =ğ
	`ZIPLIST_ENTRY_HEAD
(
zl
)) {

857  
NULL
;

859 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

860 
	`as£¹
(
´evËn
 > 0);

861  
p
-
´evËn
;

863 
	}
}

869 
	$zli¡G‘
(*
p
, **
s¡r
, *
¦’
, *
sv®
) {

870 
zËÁry
 
’Œy
;

871 ià(
p
 =ğ
NULL
 ||…[0] =ğ
ZIP_END
)  0;

872 ià(
s¡r
è*s¡¸ğ
NULL
;

874 
	`zEÁry
(
p
, &
’Œy
);

875 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

876 ià(
s¡r
) {

877 *
¦’
 = 
’Œy
.
Ën
;

878 *
s¡r
 = 
p
+
’Œy
.
h—d”size
;

881 ià(
sv®
) {

882 *
sv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

886 
	}
}

889 *
	$zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

890  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

891 
	}
}

896 *
	$zli¡D–‘e
(*
zl
, **
p
) {

897 
size_t
 
off£t
 = *
p
-
zl
;

898 
zl
 = 
	`__zli¡D–‘e
(zl,*
p
,1);

904 *
p
 = 
zl
+
off£t
;

905  
zl
;

906 
	}
}

909 *
	$zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
) {

910 *
p
 = 
	`zli¡Index
(
zl
,
šdex
);

911  (
p
 =ğ
NULL
è? 
zl
 : 
	`__zli¡D–‘e
(zl,p,
num
);

912 
	}
}

916 
	$zli¡Com·»
(*
p
, *
s¡r
, 
¦’
) {

917 
zËÁry
 
’Œy
;

918 
£ncodšg
;

919 
zv®
, 
sv®
;

920 ià(
p
[0] =ğ
ZIP_END
)  0;

922 
	`zEÁry
(
p
, &
’Œy
);

923 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

925 ià(
’Œy
.
Ën
 =ğ
¦’
) {

926  
	`memcmp
(
p
+
’Œy
.
h—d”size
,
s¡r
,
¦’
) == 0;

933 ià(
	`zTryEncodšg
(
s¡r
,
¦’
,&
sv®
,&
£ncodšg
)) {

934 
zv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

935  
zv®
 =ğ
sv®
;

939 
	}
}

943 *
	$zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
) {

944 
skút
 = 0;

945 
v’codšg
 = 0;

946 
vÎ
 = 0;

948 
p
[0] !ğ
ZIP_END
) {

949 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

950 *
q
;

952 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

953 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

954 
q
 = 
p
 + 
´evËnsize
 + 
Ënsize
;

956 ià(
skút
 == 0) {

958 ià(
	`ZIP_IS_STR
(
’codšg
)) {

959 ià(
Ën
 =ğ
vËn
 && 
	`memcmp
(
q
, 
v¡r
, vlen) == 0) {

960  
p
;

966 ià(
v’codšg
 == 0) {

967 ià(!
	`zTryEncodšg
(
v¡r
, 
vËn
, &
vÎ
, &
v’codšg
)) {

971 
v’codšg
 = 
UCHAR_MAX
;

974 
	`as£¹
(
v’codšg
);

980 ià(
v’codšg
 !ğ
UCHAR_MAX
) {

981 
Î
 = 
	`zLßdIÁeg”
(
q
, 
’codšg
);

982 ià(
Î
 =ğ
vÎ
) {

983  
p
;

989 
skút
 = 
sk
;

992 
skút
--;

996 
p
 = 
q
 + 
Ën
;

999  
NULL
;

1000 
	}
}

1003 
	$zli¡L’
(*
zl
) {

1004 
Ën
 = 0;

1005 ià(
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)è< 
UINT16_MAX
) {

1006 
Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
));

1008 *
p
 = 
zl
+
ZIPLIST_HEADER_SIZE
;

1009 *
p
 !ğ
ZIP_END
) {

1010 
p
 +ğ
	`zRawEÁryL’gth
(p);

1011 
Ën
++;

1015 ià(
Ën
 < 
UINT16_MAX
è
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(len);

1017  
Ën
;

1018 
	}
}

1021 
size_t
 
	$zli¡BlobL’
(*
zl
) {

1022  
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
));

1023 
	}
}

1025 
	$zli¡R•r
(*
zl
) {

1026 *
p
;

1027 
šdex
 = 0;

1028 
zËÁry
 
’Œy
;

1030 
	`´štf
(

1034 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),

1035 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)),

1036 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(
zl
)));

1037 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

1038 *
p
 !ğ
ZIP_END
) {

1039 
	`zEÁry
(
p
, &
’Œy
);

1040 
	`´štf
(

1051 ()
p
,

1052 
šdex
,

1053 (è(
p
-
zl
),

1054 
’Œy
.
h—d”size
+’Œy.
Ën
,

1055 
’Œy
.
h—d”size
,

1056 
’Œy
.
´ev¿wËn
,

1057 
’Œy
.
´ev¿wËnsize
,

1058 
’Œy
.
Ën
);

1059 
p
 +ğ
’Œy
.
h—d”size
;

1060 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

1061 ià(
’Œy
.
Ën
 > 40) {

1062 ià(
	`fwr™e
(
p
,40,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1063 
	`´štf
("...");

1065 ià(
’Œy
.
Ën
 &&

1066 
	`fwr™e
(
p
,
’Œy
.
Ën
,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1069 
	`´štf
("%Îd", (è
	`zLßdIÁeg”
(
p
,
’Œy
.
’codšg
));

1071 
	`´štf
("\n");

1072 
p
 +ğ
’Œy
.
Ën
;

1073 
šdex
++;

1075 
	`´štf
("{end}\n\n");

1076 
	}
}

1078 #ifdeà
REDIS_TEST


1079 
	~<sys/time.h
>

1080 
	~"adli¡.h
"

1081 
	~"sds.h
"

1083 
	#debug
(
f
, ...è{ ià(
DEBUG
è
	`´štf
(f, 
__VA_ARGS__
); }

	)

1085 *
	$ü—‹Li¡
() {

1086 *
zl
 = 
	`zli¡New
();

1087 
zl
 = 
	`zli¡Push
(zl, (*)"foo", 3, 
ZIPLIST_TAIL
);

1088 
zl
 = 
	`zli¡Push
(zl, (*)"quux", 4, 
ZIPLIST_TAIL
);

1089 
zl
 = 
	`zli¡Push
(zl, (*)"h–lo", 5, 
ZIPLIST_HEAD
);

1090 
zl
 = 
	`zli¡Push
(zl, (*)"1024", 4, 
ZIPLIST_TAIL
);

1091  
zl
;

1092 
	}
}

1094 *
	$ü—‹IÁLi¡
() {

1095 *
zl
 = 
	`zli¡New
();

1096 
buf
[32];

1098 
	`¥rštf
(
buf
, "100");

1099 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1100 
	`¥rštf
(
buf
, "128000");

1101 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1102 
	`¥rštf
(
buf
, "-100");

1103 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1104 
	`¥rštf
(
buf
, "4294967296");

1105 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1106 
	`¥rštf
(
buf
, "non integer");

1107 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1108 
	`¥rštf
(
buf
, "much much†onger‚on integer");

1109 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1110  
zl
;

1111 
	}
}

1113 
	$u£c
() {

1114 
timev®
 
tv
;

1115 
	`g‘timeofday
(&
tv
,
NULL
);

1116  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

1117 
	}
}

1119 
	$¡»ss
(
pos
, 
num
, 
maxsize
, 
dnum
) {

1120 
i
,
j
,
k
;

1121 *
zl
;

1122 
pos¡r
[2][5] = { "HEAD", "TAIL" };

1123 
¡¬t
;

1124 
i
 = 0; i < 
maxsize
; i+=
dnum
) {

1125 
zl
 = 
	`zli¡New
();

1126 
j
 = 0; j < 
i
; j++) {

1127 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
ZIPLIST_TAIL
);

1131 
¡¬t
 = 
	`u£c
();

1132 
k
 = 0; k < 
num
; k++) {

1133 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
pos
);

1134 
zl
 = 
	`zli¡D–‘eRªge
(zl,0,1);

1136 
	`´štf
("List size: %8d, bytes: %8d, %dx…ush+pop (%s): %6lld usec\n",

1137 
i
,
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),
num
,
pos¡r
[
pos
],
	`u£c
()-
¡¬t
);

1138 
	`zä“
(
zl
);

1140 
	}
}

1142 *
	$pİ
(*
zl
, 
wh”e
) {

1143 *
p
, *
v¡r
;

1144 
vËn
;

1145 
vlÚg
;

1147 
p
 = 
	`zli¡Index
(
zl
,
wh”e
 =ğ
ZIPLIST_HEAD
 ? 0 : -1);

1148 ià(
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
)) {

1149 ià(
wh”e
 =ğ
ZIPLIST_HEAD
)

1150 
	`´štf
("Pop head: ");

1152 
	`´štf
("Popail: ");

1154 ià(
v¡r
) {

1155 ià(
vËn
 && 
	`fwr™e
(
v¡r
,vËn,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1158 
	`´štf
("%Îd", 
vlÚg
);

1161 
	`´štf
("\n");

1162  
	`zli¡D–‘e
(
zl
,&
p
);

1164 
	`´štf
("ERROR: Could‚ot…op\n");

1165 
	`ex™
(1);

1167 
	}
}

1169 
	$¿nd¡ršg
(*
rg‘
, 
mš
, 
max
) {

1170 
p
 = 0;

1171 
Ën
 = 
mš
+
	`¿nd
()%(
max
-min+1);

1172 
mšv®
, 
maxv®
;

1173 
	`¿nd
() % 3) {

1175 
mšv®
 = 0;

1176 
maxv®
 = 255;

1179 
mšv®
 = 48;

1180 
maxv®
 = 122;

1183 
mšv®
 = 48;

1184 
maxv®
 = 52;

1187 
	`as£¹
(
NULL
);

1190 
p
 < 
Ën
)

1191 
rg‘
[
p
++] = 
mšv®
+
	`¿nd
()%(
maxv®
-minval+1);

1192  
Ën
;

1193 
	}
}

1195 
	$v”ify
(*
zl
, 
zËÁry
 *
e
) {

1196 
Ën
 = 
	`zli¡L’
(
zl
);

1197 
zËÁry
 
_e
;

1199 
	`ZIPLIST_ENTRY_ZERO
(&
_e
);

1201 
i
 = 0; i < 
Ën
; i++) {

1202 
	`mem£t
(&
e
[
i
], 0, (
zËÁry
));

1203 
	`zEÁry
(
	`zli¡Index
(
zl
, 
i
), &
e
[i]);

1205 
	`mem£t
(&
_e
, 0, (
zËÁry
));

1206 
	`zEÁry
(
	`zli¡Index
(
zl
, -
Ën
+
i
), &
_e
);

1208 
	`as£¹
(
	`memcmp
(&
e
[
i
], &
_e
, (
zËÁry
)) == 0);

1210 
	}
}

1212 
	$zli¡Te¡
(
¬gc
, **
¬gv
) {

1213 *
zl
, *
p
;

1214 *
’Œy
;

1215 
–’
;

1216 
v®ue
;

1219 ià(
¬gc
 == 2)

1220 
	`¤ªd
(
	`©oi
(
¬gv
[1]));

1222 
zl
 = 
	`ü—‹IÁLi¡
();

1223 
	`zli¡R•r
(
zl
);

1225 
	`zä“
(
zl
);

1227 
zl
 = 
	`ü—‹Li¡
();

1228 
	`zli¡R•r
(
zl
);

1230 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1231 
	`zli¡R•r
(
zl
);

1233 
zl
 = 
	`pİ
(zl,
ZIPLIST_HEAD
);

1234 
	`zli¡R•r
(
zl
);

1236 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1237 
	`zli¡R•r
(
zl
);

1239 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1240 
	`zli¡R•r
(
zl
);

1242 
	`zä“
(
zl
);

1244 
	`´štf
("Getƒlement‡t index 3:\n");

1246 
zl
 = 
	`ü—‹Li¡
();

1247 
p
 = 
	`zli¡Index
(
zl
, 3);

1248 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1249 
	`´štf
("ERROR: Could‚ot‡ccess index 3\n");

1252 ià(
’Œy
) {

1253 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1254 
	`´štf
("\n");

1256 
	`´štf
("%Îd\n", 
v®ue
);

1258 
	`´štf
("\n");

1259 
	`zä“
(
zl
);

1262 
	`´štf
("Getƒlement‡t index 4 (out of„ange):\n");

1264 
zl
 = 
	`ü—‹Li¡
();

1265 
p
 = 
	`zli¡Index
(
zl
, 4);

1266 ià(
p
 =ğ
NULL
) {

1267 
	`´štf
("Noƒntry\n");

1269 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1272 
	`´štf
("\n");

1273 
	`zä“
(
zl
);

1276 
	`´štf
("Getƒlement‡t index -1 (lastƒlement):\n");

1278 
zl
 = 
	`ü—‹Li¡
();

1279 
p
 = 
	`zli¡Index
(
zl
, -1);

1280 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1281 
	`´štf
("ERROR: Could‚ot‡ccess index -1\n");

1284 ià(
’Œy
) {

1285 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1286 
	`´štf
("\n");

1288 
	`´štf
("%Îd\n", 
v®ue
);

1290 
	`´štf
("\n");

1291 
	`zä“
(
zl
);

1294 
	`´štf
("Getƒlement‡t index -4 (firstƒlement):\n");

1296 
zl
 = 
	`ü—‹Li¡
();

1297 
p
 = 
	`zli¡Index
(
zl
, -4);

1298 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1299 
	`´štf
("ERROR: Could‚ot‡ccess index -4\n");

1302 ià(
’Œy
) {

1303 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1304 
	`´štf
("\n");

1306 
	`´štf
("%Îd\n", 
v®ue
);

1308 
	`´štf
("\n");

1309 
	`zä“
(
zl
);

1312 
	`´štf
("Getƒlement‡t index -5 (reverse out of„ange):\n");

1314 
zl
 = 
	`ü—‹Li¡
();

1315 
p
 = 
	`zli¡Index
(
zl
, -5);

1316 ià(
p
 =ğ
NULL
) {

1317 
	`´štf
("Noƒntry\n");

1319 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1322 
	`´štf
("\n");

1323 
	`zä“
(
zl
);

1326 
	`´štf
("Iterate†ist from 0oƒnd:\n");

1328 
zl
 = 
	`ü—‹Li¡
();

1329 
p
 = 
	`zli¡Index
(
zl
, 0);

1330 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1331 
	`´štf
("Entry: ");

1332 ià(
’Œy
) {

1333 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1335 
	`´štf
("%Îd", 
v®ue
);

1337 
p
 = 
	`zli¡Next
(
zl
,p);

1338 
	`´štf
("\n");

1340 
	`´štf
("\n");

1341 
	`zä“
(
zl
);

1344 
	`´štf
("Iterate†ist from 1oƒnd:\n");

1346 
zl
 = 
	`ü—‹Li¡
();

1347 
p
 = 
	`zli¡Index
(
zl
, 1);

1348 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1349 
	`´štf
("Entry: ");

1350 ià(
’Œy
) {

1351 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1353 
	`´štf
("%Îd", 
v®ue
);

1355 
p
 = 
	`zli¡Next
(
zl
,p);

1356 
	`´štf
("\n");

1358 
	`´štf
("\n");

1359 
	`zä“
(
zl
);

1362 
	`´štf
("Iterate†ist from 2oƒnd:\n");

1364 
zl
 = 
	`ü—‹Li¡
();

1365 
p
 = 
	`zli¡Index
(
zl
, 2);

1366 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1367 
	`´štf
("Entry: ");

1368 ià(
’Œy
) {

1369 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1371 
	`´štf
("%Îd", 
v®ue
);

1373 
p
 = 
	`zli¡Next
(
zl
,p);

1374 
	`´štf
("\n");

1376 
	`´štf
("\n");

1377 
	`zä“
(
zl
);

1380 
	`´štf
("Iterate starting out of„ange:\n");

1382 
zl
 = 
	`ü—‹Li¡
();

1383 
p
 = 
	`zli¡Index
(
zl
, 4);

1384 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1385 
	`´štf
("Noƒntry\n");

1387 
	`´štf
("ERROR\n");

1389 
	`´štf
("\n");

1390 
	`zä“
(
zl
);

1393 
	`´štf
("Iterate from backo front:\n");

1395 
zl
 = 
	`ü—‹Li¡
();

1396 
p
 = 
	`zli¡Index
(
zl
, -1);

1397 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1398 
	`´štf
("Entry: ");

1399 ià(
’Œy
) {

1400 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1402 
	`´štf
("%Îd", 
v®ue
);

1404 
p
 = 
	`zli¡P»v
(
zl
,p);

1405 
	`´štf
("\n");

1407 
	`´štf
("\n");

1408 
	`zä“
(
zl
);

1411 
	`´štf
("Iterate from backo front, deleting‡ll items:\n");

1413 
zl
 = 
	`ü—‹Li¡
();

1414 
p
 = 
	`zli¡Index
(
zl
, -1);

1415 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1416 
	`´štf
("Entry: ");

1417 ià(
’Œy
) {

1418 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1420 
	`´štf
("%Îd", 
v®ue
);

1422 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1423 
p
 = 
	`zli¡P»v
(
zl
,p);

1424 
	`´štf
("\n");

1426 
	`´štf
("\n");

1427 
	`zä“
(
zl
);

1430 
	`´štf
("Delete inclusive„ange 0,0:\n");

1432 
zl
 = 
	`ü—‹Li¡
();

1433 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 1);

1434 
	`zli¡R•r
(
zl
);

1435 
	`zä“
(
zl
);

1438 
	`´štf
("Delete inclusive„ange 0,1:\n");

1440 
zl
 = 
	`ü—‹Li¡
();

1441 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 2);

1442 
	`zli¡R•r
(
zl
);

1443 
	`zä“
(
zl
);

1446 
	`´štf
("Delete inclusive„ange 1,2:\n");

1448 
zl
 = 
	`ü—‹Li¡
();

1449 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 2);

1450 
	`zli¡R•r
(
zl
);

1451 
	`zä“
(
zl
);

1454 
	`´štf
("Delete with start index out of„ange:\n");

1456 
zl
 = 
	`ü—‹Li¡
();

1457 
zl
 = 
	`zli¡D–‘eRªge
(zl, 5, 1);

1458 
	`zli¡R•r
(
zl
);

1459 
	`zä“
(
zl
);

1462 
	`´štf
("Delete with‚um overflow:\n");

1464 
zl
 = 
	`ü—‹Li¡
();

1465 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 5);

1466 
	`zli¡R•r
(
zl
);

1467 
	`zä“
(
zl
);

1470 
	`´štf
("Delete foo while iterating:\n");

1472 
zl
 = 
	`ü—‹Li¡
();

1473 
p
 = 
	`zli¡Index
(
zl
,0);

1474 
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
)) {

1475 ià(
’Œy
 && 
	`¡ºcmp
("foo",(*ëÁry,
–’
) == 0) {

1476 
	`´štf
("Delete foo\n");

1477 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1479 
	`´štf
("Entry: ");

1480 ià(
’Œy
) {

1481 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
) == 0)

1482 
	`³¼Ü
("fwrite");

1484 
	`´štf
("%Îd",
v®ue
);

1486 
p
 = 
	`zli¡Next
(
zl
,p);

1487 
	`´štf
("\n");

1490 
	`´štf
("\n");

1491 
	`zli¡R•r
(
zl
);

1492 
	`zä“
(
zl
);

1495 
	`´štf
("Regressionest for >255 byte strings:\n");

1497 
v1
[257] = {0}, 
v2
[257] = {0};

1498 
	`mem£t
(
v1
,'x',256);

1499 
	`mem£t
(
v2
,'y',256);

1500 
zl
 = 
	`zli¡New
();

1501 
zl
 = 
	`zli¡Push
(zl,(*)
v1
,
	`¡¾’
(v1),
ZIPLIST_TAIL
);

1502 
zl
 = 
	`zli¡Push
(zl,(*)
v2
,
	`¡¾’
(v2),
ZIPLIST_TAIL
);

1505 
p
 = 
	`zli¡Index
(
zl
,0);

1506 
	`as£¹
(
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
));

1507 
	`as£¹
(
	`¡ºcmp
(
v1
,(*)
’Œy
,
–’
) == 0);

1508 
p
 = 
	`zli¡Index
(
zl
,1);

1509 
	`as£¹
(
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
));

1510 
	`as£¹
(
	`¡ºcmp
(
v2
,(*)
’Œy
,
–’
) == 0);

1511 
	`´štf
("SUCCESS\n\n");

1512 
	`zä“
(
zl
);

1515 
	`´štf
("Regressionest deleting‚exto†astƒntries:\n");

1517 
v
[3][257] = {{0}};

1518 
zËÁry
 
e
[3] = {{.
´ev¿wËnsize
 = 0, .
´ev¿wËn
 = 0, .
Ënsize
 = 0,

1519 .
Ën
 = 0, .
h—d”size
 = 0, .
’codšg
 = 0, .
p
 = 
NULL
}};

1520 
size_t
 
i
;

1522 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1523 
	`mem£t
(
v
[
i
], 'a' + i, (v[0]));

1526 
v
[0][256] = '\0';

1527 
v
[1][ 1] = '\0';

1528 
v
[2][256] = '\0';

1530 
zl
 = 
	`zli¡New
();

1531 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1532 
zl
 = 
	`zli¡Push
(zl, (*è
v
[
i
], 
	`¡¾’
(v[i]), 
ZIPLIST_TAIL
);

1535 
	`v”ify
(
zl
, 
e
);

1537 
	`as£¹
(
e
[0].
´ev¿wËnsize
 == 1);

1538 
	`as£¹
(
e
[1].
´ev¿wËnsize
 == 5);

1539 
	`as£¹
(
e
[2].
´ev¿wËnsize
 == 1);

1542 *
p
 = 
e
[1].p;

1543 
zl
 = 
	`zli¡D–‘e
(zl, &
p
);

1545 
	`v”ify
(
zl
, 
e
);

1547 
	`as£¹
(
e
[0].
´ev¿wËnsize
 == 1);

1548 
	`as£¹
(
e
[1].
´ev¿wËnsize
 == 5);

1550 
	`´štf
("SUCCESS\n\n");

1551 
	`zä“
(
zl
);

1554 
	`´štf
("Create†ong†ist‡nd check indices:\n");

1556 
zl
 = 
	`zli¡New
();

1557 
buf
[32];

1558 
i
,
Ën
;

1559 
i
 = 0; i < 1000; i++) {

1560 
Ën
 = 
	`¥rštf
(
buf
,"%d",
i
);

1561 
zl
 = 
	`zli¡Push
(zl,(*)
buf
,
Ën
,
ZIPLIST_TAIL
);

1563 
i
 = 0; i < 1000; i++) {

1564 
p
 = 
	`zli¡Index
(
zl
,
i
);

1565 
	`as£¹
(
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
));

1566 
	`as£¹
(
i
 =ğ
v®ue
);

1568 
p
 = 
	`zli¡Index
(
zl
,-
i
-1);

1569 
	`as£¹
(
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
));

1570 
	`as£¹
(999-
i
 =ğ
v®ue
);

1572 
	`´štf
("SUCCESS\n\n");

1573 
	`zä“
(
zl
);

1576 
	`´štf
("Compare strings with ziplistƒntries:\n");

1578 
zl
 = 
	`ü—‹Li¡
();

1579 
p
 = 
	`zli¡Index
(
zl
,0);

1580 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1581 
	`´štf
("ERROR:‚ot \"hello\"\n");

1584 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1585 
	`´štf
("ERROR: \"hella\"\n");

1589 
p
 = 
	`zli¡Index
(
zl
,3);

1590 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1591 
	`´štf
("ERROR:‚ot \"1024\"\n");

1594 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1595 
	`´štf
("ERROR: \"1025\"\n");

1598 
	`´štf
("SUCCESS\n\n");

1599 
	`zä“
(
zl
);

1602 
	`´štf
("Mergeest:\n");

1605 
zl
 = 
	`ü—‹Li¡
();

1606 *
zl2
 = 
	`ü—‹Li¡
();

1608 *
zl3
 = 
	`zli¡New
();

1609 *
zl4
 = 
	`zli¡New
();

1611 ià(
	`zli¡M”ge
(&
zl4
, &zl4)) {

1612 
	`´štf
("ERROR: Allowed merging of one ziplist into itself.\n");

1617 
zl4
 = 
	`zli¡M”ge
(&
zl3
, &zl4);

1618 
	`zli¡R•r
(
zl4
);

1619 ià(
	`zli¡L’
(
zl4
)) {

1620 
	`´štf
("ERROR: Mergingwoƒmpty ziplists createdƒntries.\n");

1623 
	`zä“
(
zl4
);

1625 
zl2
 = 
	`zli¡M”ge
(&
zl
, &zl2);

1627 
	`zli¡R•r
(
zl2
);

1629 ià(
	`zli¡L’
(
zl2
) != 8) {

1630 
	`´štf
("ERROR: M”ged†’gth‚Ù 8, but: %u\n", 
	`zli¡L’
(
zl2
));

1634 
p
 = 
	`zli¡Index
(
zl2
,0);

1635 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1636 
	`´štf
("ERROR:‚ot \"hello\"\n");

1639 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1640 
	`´štf
("ERROR: \"hella\"\n");

1644 
p
 = 
	`zli¡Index
(
zl2
,3);

1645 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1646 
	`´štf
("ERROR:‚ot \"1024\"\n");

1649 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1650 
	`´štf
("ERROR: \"1025\"\n");

1654 
p
 = 
	`zli¡Index
(
zl2
,4);

1655 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1656 
	`´štf
("ERROR:‚ot \"hello\"\n");

1659 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1660 
	`´štf
("ERROR: \"hella\"\n");

1664 
p
 = 
	`zli¡Index
(
zl2
,7);

1665 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1666 
	`´štf
("ERROR:‚ot \"1024\"\n");

1669 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1670 
	`´štf
("ERROR: \"1025\"\n");

1673 
	`´štf
("SUCCESS\n\n");

1674 
	`zä“
(
zl
);

1677 
	`´štf
("Stress with„andom…ayloads of differentƒncoding:\n");

1679 
i
,
j
,
Ën
,
wh”e
;

1680 *
p
;

1681 
buf
[1024];

1682 
buæ’
;

1683 
li¡
 *
»f
;

1684 
li¡Node
 *
»âode
;

1687 *
s¡r
;

1688 
¦’
;

1689 
sv®
;

1691 
i
 = 0; i < 20000; i++) {

1692 
zl
 = 
	`zli¡New
();

1693 
»f
 = 
	`li¡C»©e
();

1694 
	`li¡S‘F»eM‘hod
(
»f
,((*)(*))
sdsä“
);

1695 
Ën
 = 
	`¿nd
() % 256;

1698 
j
 = 0; j < 
Ën
; j++) {

1699 
wh”e
 = (
	`¿nd
(è& 1è? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
;

1700 ià(
	`¿nd
() % 2) {

1701 
buæ’
 = 
	`¿nd¡ršg
(
buf
,1,(buf)-1);

1703 
	`¿nd
() % 3) {

1705 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) >> 20);

1708 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()));

1711 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) << 20);

1714 
	`as£¹
(
NULL
);

1719 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
buæ’
, 
wh”e
);

1722 ià(
wh”e
 =ğ
ZIPLIST_HEAD
) {

1723 
	`li¡AddNodeH—d
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1724 } ià(
wh”e
 =ğ
ZIPLIST_TAIL
) {

1725 
	`li¡AddNodeTa
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1727 
	`as£¹
(
NULL
);

1731 
	`as£¹
(
	`li¡L’gth
(
»f
è=ğ
	`zli¡L’
(
zl
));

1732 
j
 = 0; j < 
Ën
; j++) {

1735 
p
 = 
	`zli¡Index
(
zl
,
j
);

1736 
»âode
 = 
	`li¡Index
(
»f
,
j
);

1738 
	`as£¹
(
	`zli¡G‘
(
p
,&
s¡r
,&
¦’
,&
sv®
));

1739 ià(
s¡r
 =ğ
NULL
) {

1740 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",
sv®
);

1742 
buæ’
 = 
¦’
;

1743 
	`memıy
(
buf
,
s¡r
,
buæ’
);

1744 
buf
[
buæ’
] = '\0';

1746 
	`as£¹
(
	`memcmp
(
buf
,
	`li¡NodeV®ue
(
»âode
),
buæ’
) == 0);

1748 
	`zä“
(
zl
);

1749 
	`li¡R–—£
(
»f
);

1751 
	`´štf
("SUCCESS\n\n");

1754 
	`´štf
("Stress with variable ziplist size:\n");

1756 
	`¡»ss
(
ZIPLIST_HEAD
,100000,16384,256);

1757 
	`¡»ss
(
ZIPLIST_TAIL
,100000,16384,256);

1761 
	}
}

	@ziplist.h

31 #iâdeà
_ZIPLIST_H


32 
	#_ZIPLIST_H


	)

34 
	#ZIPLIST_HEAD
 0

	)

35 
	#ZIPLIST_TAIL
 1

	)

37 *
zli¡New
();

38 *
zli¡M”ge
(**
fœ¡
, **
£cÚd
);

39 *
zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
);

40 *
zli¡Index
(*
zl
, 
šdex
);

41 *
zli¡Next
(*
zl
, *
p
);

42 *
zli¡P»v
(*
zl
, *
p
);

43 
zli¡G‘
(*
p
, **
sv®
, *
¦’
, *
lv®
);

44 *
zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
);

45 *
zli¡D–‘e
(*
zl
, **
p
);

46 *
zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
);

47 
zli¡Com·»
(*
p
, *
s
, 
¦’
);

48 *
zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
);

49 
zli¡L’
(*
zl
);

50 
size_t
 
zli¡BlobL’
(*
zl
);

52 #ifdeà
REDIS_TEST


53 
zli¡Te¡
(
¬gc
, *
¬gv
[]);

	@zipmap.c

78 
	~<¡dio.h
>

79 
	~<¡ršg.h
>

80 
	~"zm®loc.h
"

81 
	~"’dŸncÚv.h
"

83 
	#ZIPMAP_BIGLEN
 254

	)

84 
	#ZIPMAP_END
 255

	)

88 
	#ZIPMAP_VALUE_MAX_FREE
 4

	)

93 
	#ZIPMAP_LEN_BYTES
(
_l
è(((_lè< 
ZIPMAP_BIGLEN
è? 1 : ()+1)

	)

96 *
	$zm­New
() {

97 *
zm
 = 
	`zm®loc
(2);

99 
zm
[0] = 0;

100 
zm
[1] = 
ZIPMAP_END
;

101  
zm
;

102 
	}
}

105 
	$zm­DecodeL’gth
(*
p
) {

106 
Ën
 = *
p
;

108 ià(
Ën
 < 
ZIPMAP_BIGLEN
) †en;

109 
	`memıy
(&
Ën
,
p
+1,());

110 
	`mem»v32ifbe
(&
Ën
);

111  
Ën
;

112 
	}
}

116 
	$zm­EncodeL’gth
(*
p
, 
Ën
) {

117 ià(
p
 =ğ
NULL
) {

118  
	`ZIPMAP_LEN_BYTES
(
Ën
);

120 ià(
Ën
 < 
ZIPMAP_BIGLEN
) {

121 
p
[0] = 
Ën
;

124 
p
[0] = 
ZIPMAP_BIGLEN
;

125 
	`memıy
(
p
+1,&
Ën
,(len));

126 
	`mem»v32ifbe
(
p
+1);

127  1+(
Ën
);

130 
	}
}

138 *
	$zm­LookupRaw
(*
zm
, *
key
, 
kËn
, *
tÙËn
) {

139 *
p
 = 
zm
+1, *
k
 = 
NULL
;

140 
l
,
Î’
;

142 *
p
 !ğ
ZIPMAP_END
) {

143 
ä“
;

146 
l
 = 
	`zm­DecodeL’gth
(
p
);

147 
Î’
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

148 ià(
key
 !ğ
NULL
 && 
k
 =ğNULL && 
l
 =ğ
kËn
 && !
	`memcmp
(
p
+
Î’
,key,l)) {

151 ià(
tÙËn
 !ğ
NULL
) {

152 
k
 = 
p
;

154  
p
;

157 
p
 +ğ
Î’
+
l
;

159 
l
 = 
	`zm­DecodeL’gth
(
p
);

160 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

161 
ä“
 = 
p
[0];

162 
p
 +ğ
l
+1+
ä“
;

164 ià(
tÙËn
 !ğ
NULL
è*tÙËÀğ()(
p
-
zm
)+1;

165  
k
;

166 
	}
}

168 
	$zm­RequœedL’gth
(
kËn
, 
vËn
) {

169 
l
;

171 
l
 = 
kËn
+
vËn
+3;

172 ià(
kËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

173 ià(
vËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

174  
l
;

175 
	}
}

178 
	$zm­RawKeyL’gth
(*
p
) {

179 
l
 = 
	`zm­DecodeL’gth
(
p
);

180  
	`zm­EncodeL’gth
(
NULL
,
l
) +†;

181 
	}
}

185 
	$zm­RawV®ueL’gth
(*
p
) {

186 
l
 = 
	`zm­DecodeL’gth
(
p
);

187 
u£d
;

189 
u£d
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

190 
u£d
 +ğ
p
[u£d] + 1 + 
l
;

191  
u£d
;

192 
	}
}

197 
	$zm­RawEÁryL’gth
(*
p
) {

198 
l
 = 
	`zm­RawKeyL’gth
(
p
);

199  
l
 + 
	`zm­RawV®ueL’gth
(
p
+l);

200 
	}
}

202 
šlše
 *
	$zm­Resize
(*
zm
, 
Ën
) {

203 
zm
 = 
	`z»®loc
(zm, 
Ën
);

204 
zm
[
Ën
-1] = 
ZIPMAP_END
;

205  
zm
;

206 
	}
}

211 *
	$zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
) {

212 
zmËn
, 
off£t
;

213 
ä“Ën
, 
»qËn
 = 
	`zm­RequœedL’gth
(
kËn
,
vËn
);

214 
em±y
, 
vem±y
;

215 *
p
;

217 
ä“Ën
 = 
»qËn
;

218 ià(
upd©e
) *update = 0;

219 
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

220 ià(
p
 =ğ
NULL
) {

222 
zm
 = 
	`zm­Resize
(zm, 
zmËn
+
»qËn
);

223 
p
 = 
zm
+
zmËn
-1;

224 
zmËn
 = zmËn+
»qËn
;

227 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]++;

231 ià(
upd©e
) *update = 1;

232 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

233 ià(
ä“Ën
 < 
»qËn
) {

237 
off£t
 = 
p
-
zm
;

238 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
+
»qËn
);

239 
p
 = 
zm
+
off£t
;

243 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

244 
zmËn
 = zmËn-
ä“Ën
+
»qËn
;

245 
ä“Ën
 = 
»qËn
;

253 
em±y
 = 
ä“Ën
-
»qËn
;

254 ià(
em±y
 >ğ
ZIPMAP_VALUE_MAX_FREE
) {

257 
off£t
 = 
p
-
zm
;

258 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

259 
zmËn
 -ğ
em±y
;

260 
zm
 = 
	`zm­Resize
(zm, 
zmËn
);

261 
p
 = 
zm
+
off£t
;

262 
vem±y
 = 0;

264 
vem±y
 = 
em±y
;

269 
p
 +ğ
	`zm­EncodeL’gth
Õ,
kËn
);

270 
	`memıy
(
p
,
key
,
kËn
);

271 
p
 +ğ
kËn
;

273 
p
 +ğ
	`zm­EncodeL’gth
Õ,
vËn
);

274 *
p
++ = 
vem±y
;

275 
	`memıy
(
p
,
v®
,
vËn
);

276  
zm
;

277 
	}
}

281 *
	$zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
) {

282 
zmËn
, 
ä“Ën
;

283 *
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

284 ià(
p
) {

285 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

286 
	`memmove
(
p
,…+
ä“Ën
, 
zmËn
-(Õ-
zm
)+freelen+1));

287 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
);

290 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]--;

292 ià(
d–‘ed
) *deleted = 1;

294 ià(
d–‘ed
) *deleted = 0;

296  
zm
;

297 
	}
}

300 *
	$zm­Rewšd
(*
zm
) {

301  
zm
+1;

302 
	}
}

315 *
	$zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
) {

316 ià(
zm
[0] =ğ
ZIPMAP_END
è 
NULL
;

317 ià(
key
) {

318 *
key
 = 
zm
;

319 *
kËn
 = 
	`zm­DecodeL’gth
(
zm
);

320 *
key
 +ğ
	`ZIPMAP_LEN_BYTES
(*
kËn
);

322 
zm
 +ğ
	`zm­RawKeyL’gth
(zm);

323 ià(
v®ue
) {

324 *
v®ue
 = 
zm
+1;

325 *
vËn
 = 
	`zm­DecodeL’gth
(
zm
);

326 *
v®ue
 +ğ
	`ZIPMAP_LEN_BYTES
(*
vËn
);

328 
zm
 +ğ
	`zm­RawV®ueL’gth
(zm);

329  
zm
;

330 
	}
}

334 
	$zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
) {

335 *
p
;

337 ià((
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
)) == NULL)  0;

338 
p
 +ğ
	`zm­RawKeyL’gth
(p);

339 *
vËn
 = 
	`zm­DecodeL’gth
(
p
);

340 *
v®ue
 = 
p
 + 
	`ZIPMAP_LEN_BYTES
(*
vËn
) + 1;

342 
	}
}

345 
	$zm­Exi¡s
(*
zm
, *
key
, 
kËn
) {

346  
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
) != NULL;

347 
	}
}

350 
	$zm­L’
(*
zm
) {

351 
Ën
 = 0;

352 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) {

353 
Ën
 = 
zm
[0];

355 *
p
 = 
	`zm­Rewšd
(
zm
);

356 (
p
 = 
	`zm­Next
Õ,
NULL
,NULL,NULL,NULL)è!ğNULLè
Ën
++;

359 ià(
Ën
 < 
ZIPMAP_BIGLEN
è
zm
[0] =†en;

361  
Ën
;

362 
	}
}

367 
size_t
 
	$zm­BlobL’
(*
zm
) {

368 
tÙËn
;

369 
	`zm­LookupRaw
(
zm
,
NULL
,0,&
tÙËn
);

370  
tÙËn
;

371 
	}
}

373 #ifdeà
REDIS_TEST


374 
	$zm­R•r
(*
p
) {

375 
l
;

377 
	`´štf
("{¡©u %u}",*
p
++);

379 ià(
p
[0] =ğ
ZIPMAP_END
) {

380 
	`´štf
("{end}");

383 
e
;

385 
l
 = 
	`zm­DecodeL’gth
(
p
);

386 
	`´štf
("{key %u}",
l
);

387 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

388 ià(
l
 !ğ0 && 
	`fwr™e
(
p
,l,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

389 
p
 +ğ
l
;

391 
l
 = 
	`zm­DecodeL’gth
(
p
);

392 
	`´štf
("{v®u%u}",
l
);

393 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

394 
e
 = *
p
++;

395 ià(
l
 !ğ0 && 
	`fwr™e
(
p
,l,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

396 
p
 +ğ
l
+
e
;

397 ià(
e
) {

398 
	`´štf
("[");

399 
e
--è
	`´štf
(".");

400 
	`´štf
("]");

404 
	`´štf
("\n");

405 
	}
}

407 
	#UNUSED
(
x
è()(x)

	)

408 
	$zm­Te¡
(
¬gc
, *
¬gv
[]) {

409 *
zm
;

411 
	`UNUSED
(
¬gc
);

412 
	`UNUSED
(
¬gv
);

414 
zm
 = 
	`zm­New
();

416 
zm
 = 
	`zm­S‘
(zm,(*è"Çme",4, (*è"foo",3,
NULL
);

417 
zm
 = 
	`zm­S‘
(zm,(*è"suºame",7, (*è"foo",3,
NULL
);

418 
zm
 = 
	`zm­S‘
(zm,(*è"age",3, (*è"foo",3,
NULL
);

419 
	`zm­R•r
(
zm
);

421 
zm
 = 
	`zm­S‘
(zm,(*è"h–lo",5, (*è"wÜld!",6,
NULL
);

422 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"b¬",3,
NULL
);

423 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"!",1,
NULL
);

424 
	`zm­R•r
(
zm
);

425 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"12345",5,
NULL
);

426 
	`zm­R•r
(
zm
);

427 
zm
 = 
	`zm­S‘
(zm,(*è"Ãw",3, (*è"xx",2,
NULL
);

428 
zm
 = 
	`zm­S‘
(zm,(*è"nov®",5, (*è"",0,
NULL
);

429 
	`zm­R•r
(
zm
);

430 
zm
 = 
	`zm­D–
(zm,(*è"Ãw",3,
NULL
);

431 
	`zm­R•r
(
zm
);

433 
	`´štf
("\nLook up†arge key:\n");

435 
buf
[512];

436 *
v®ue
;

437 
vËn
, 
i
;

438 
i
 = 0; i < 512; i++è
buf
[i] = 'a';

440 
zm
 = 
	`zm­S‘
(zm,
buf
,512,(*è"lÚg",4,
NULL
);

441 ià(
	`zm­G‘
(
zm
,
buf
,512,&
v®ue
,&
vËn
)) {

442 
	`´štf
(" <long key> is‡ssociatedohe %d bytes value: %.*s\n",

443 
vËn
, vËn, 
v®ue
);

447 
	`´štf
("\nPerform‡ direct†ookup:\n");

449 *
v®ue
;

450 
vËn
;

452 ià(
	`zm­G‘
(
zm
,(*è"foo",3,&
v®ue
,&
vËn
)) {

453 
	`´štf
(" foo is‡ssociatedohe %d bytes value: %.*s\n",

454 
vËn
, vËn, 
v®ue
);

457 
	`´štf
("\nIteratehroughƒlements:\n");

459 *
i
 = 
	`zm­Rewšd
(
zm
);

460 *
key
, *
v®ue
;

461 
kËn
, 
vËn
;

463 (
i
 = 
	`zm­Next
(i,&
key
,&
kËn
,&
v®ue
,&
vËn
)è!ğ
NULL
) {

464 
	`´štf
(" %d:%.* => %d:%.*s\n", 
kËn
, kËn, 
key
, 
vËn
, vËn, 
v®ue
);

468 
	}
}

	@zipmap.h

35 #iâdeà
_ZIPMAP_H


36 
	#_ZIPMAP_H


	)

38 *
zm­New
();

39 *
zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
);

40 *
zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
);

41 *
zm­Rewšd
(*
zm
);

42 *
zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
);

43 
zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
);

44 
zm­Exi¡s
(*
zm
, *
key
, 
kËn
);

45 
zm­L’
(*
zm
);

46 
size_t
 
zm­BlobL’
(*
zm
);

47 
zm­R•r
(*
p
);

49 #ifdeà
REDIS_TEST


50 
zm­Te¡
(
¬gc
, *
¬gv
[]);

	@zmalloc.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

38 
	$zlibc_ä“
(*
±r
) {

39 
	`ä“
(
±r
);

40 
	}
}

42 
	~<¡ršg.h
>

43 
	~<±h»ad.h
>

44 
	~"cÚfig.h
"

45 
	~"zm®loc.h
"

46 
	~"©omicv¬.h
"

48 #ifdeà
HAVE_MALLOC_SIZE


49 
	#PREFIX_SIZE
 (0)

	)

51 #ià
defšed
(
__sun
è|| defšed(
__¥¬c
è|| defšed(
__¥¬c__
)

52 
	#PREFIX_SIZE
 (())

	)

54 
	#PREFIX_SIZE
 ((
size_t
))

	)

59 #ià
defšed
(
USE_TCMALLOC
)

60 
	#m®loc
(
size
è
	`tc_m®loc
(size)

	)

61 
	#ÿÎoc
(
couÁ
,
size
è
	`tc_ÿÎoc
(couÁ,size)

	)

62 
	#»®loc
(
±r
,
size
è
	`tc_»®loc
ÕŒ,size)

	)

63 
	#ä“
(
±r
è
	`tc_ä“
ÕŒ)

	)

64 #–ià
defšed
(
USE_JEMALLOC
)

65 
	#m®loc
(
size
è
	`je_m®loc
(size)

	)

66 
	#ÿÎoc
(
couÁ
,
size
è
	`je_ÿÎoc
(couÁ,size)

	)

67 
	#»®loc
(
±r
,
size
è
	`je_»®loc
ÕŒ,size)

	)

68 
	#ä“
(
±r
è
	`je_ä“
ÕŒ)

	)

71 
	#upd©e_zm®loc_¡©_®loc
(
__n
) do { \

72 
size_t
 
_n
 = (
__n
); \

73 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

74 ià(
zm®loc_th»ad_§ã
) { \

75 
	`©omicInü
(
u£d_memÜy
,
__n
,
u£d_memÜy_mu‹x
); \

77 
u£d_memÜy
 +ğ
_n
; \

79 } 0)

	)

81 
	#upd©e_zm®loc_¡©_ä“
(
__n
) do { \

82 
size_t
 
_n
 = (
__n
); \

83 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

84 ià(
zm®loc_th»ad_§ã
) { \

85 
	`©omicDeü
(
u£d_memÜy
,
__n
,
u£d_memÜy_mu‹x
); \

87 
u£d_memÜy
 -ğ
_n
; \

89 } 0)

	)

91 
size_t
 
	gu£d_memÜy
 = 0;

92 
	gzm®loc_th»ad_§ã
 = 0;

93 
±h»ad_mu‹x_t
 
	gu£d_memÜy_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

95 
	$zm®loc_deçuÉ_oom
(
size_t
 
size
) {

96 
	`årštf
(
¡d”r
, "zmalloc: Out of memoryryingo‡llocate %zu bytes\n",

97 
size
);

98 
	`fæush
(
¡d”r
);

99 
	`abÜt
();

100 
	}
}

102 (*
zm®loc_oom_hªdËr
)(
size_t
èğ
zm®loc_deçuÉ_oom
;

104 *
	$zm®loc
(
size_t
 
size
) {

105 *
±r
 = 
	`m®loc
(
size
+
PREFIX_SIZE
);

107 ià(!
±r
è
	`zm®loc_oom_hªdËr
(
size
);

108 #ifdeà
HAVE_MALLOC_SIZE


109 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
±r
));

110  
±r
;

112 *((
size_t
*)
±r
èğ
size
;

113 
	`upd©e_zm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

114  (*)
±r
+
PREFIX_SIZE
;

116 
	}
}

118 *
	$zÿÎoc
(
size_t
 
size
) {

119 *
±r
 = 
	`ÿÎoc
(1, 
size
+
PREFIX_SIZE
);

121 ià(!
±r
è
	`zm®loc_oom_hªdËr
(
size
);

122 #ifdeà
HAVE_MALLOC_SIZE


123 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
±r
));

124  
±r
;

126 *((
size_t
*)
±r
èğ
size
;

127 
	`upd©e_zm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

128  (*)
±r
+
PREFIX_SIZE
;

130 
	}
}

132 *
	$z»®loc
(*
±r
, 
size_t
 
size
) {

133 #iâdeà
HAVE_MALLOC_SIZE


134 *
»®±r
;

136 
size_t
 
Şdsize
;

137 *
Ãw±r
;

139 ià(
±r
 =ğ
NULL
è 
	`zm®loc
(
size
);

140 #ifdeà
HAVE_MALLOC_SIZE


141 
Şdsize
 = 
	`zm®loc_size
(
±r
);

142 
Ãw±r
 = 
	`»®loc
(
±r
,
size
);

143 ià(!
Ãw±r
è
	`zm®loc_oom_hªdËr
(
size
);

145 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
);

146 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
Ãw±r
));

147  
Ãw±r
;

149 
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

150 
Şdsize
 = *((
size_t
*)
»®±r
);

151 
Ãw±r
 = 
	`»®loc
(
»®±r
,
size
+
PREFIX_SIZE
);

152 ià(!
Ãw±r
è
	`zm®loc_oom_hªdËr
(
size
);

154 *((
size_t
*)
Ãw±r
èğ
size
;

155 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
);

156 
	`upd©e_zm®loc_¡©_®loc
(
size
);

157  (*)
Ãw±r
+
PREFIX_SIZE
;

159 
	}
}

164 #iâdeà
HAVE_MALLOC_SIZE


165 
size_t
 
	$zm®loc_size
(*
±r
) {

166 *
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

167 
size_t
 
size
 = *((size_t*)
»®±r
);

170 ià(
size
&(()-1)) size += ()-(size&(()-1));

171  
size
+
PREFIX_SIZE
;

172 
	}
}

175 
	$zä“
(*
±r
) {

176 #iâdeà
HAVE_MALLOC_SIZE


177 *
»®±r
;

178 
size_t
 
Şdsize
;

181 ià(
±r
 =ğ
NULL
) ;

182 #ifdeà
HAVE_MALLOC_SIZE


183 
	`upd©e_zm®loc_¡©_ä“
(
	`zm®loc_size
(
±r
));

184 
	`ä“
(
±r
);

186 
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

187 
Şdsize
 = *((
size_t
*)
»®±r
);

188 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
+
PREFIX_SIZE
);

189 
	`ä“
(
»®±r
);

191 
	}
}

193 *
	$z¡rdup
(cÚ¡ *
s
) {

194 
size_t
 
l
 = 
	`¡¾’
(
s
)+1;

195 *
p
 = 
	`zm®loc
(
l
);

197 
	`memıy
(
p
,
s
,
l
);

198  
p
;

199 
	}
}

201 
size_t
 
	$zm®loc_u£d_memÜy
() {

202 
size_t
 
um
;

204 ià(
zm®loc_th»ad_§ã
) {

205 
	`©omicG‘
(
u£d_memÜy
,
um
,
u£d_memÜy_mu‹x
);

207 
um
 = 
u£d_memÜy
;

209  
um
;

210 
	}
}

212 
	$zm®loc_’abË_th»ad_§ãÃss
() {

213 
zm®loc_th»ad_§ã
 = 1;

214 
	}
}

216 
zm®loc_£t_oom_hªdËr
((*
oom_hªdËr
)(
size_t
)) {

217 
zm®loc_oom_hªdËr
 = 
oom_hªdËr
;

218 
	}
}

230 #ià
defšed
(
HAVE_PROC_STAT
)

231 
	~<uni¡d.h
>

232 
	~<sys/ty³s.h
>

233 
	~<sys/¡©.h
>

234 
	~<fú.h
>

236 
size_t
 
	$zm®loc_g‘_rss
() {

237 
·ge
 = 
	`syscÚf
(
_SC_PAGESIZE
);

238 
size_t
 
rss
;

239 
buf
[4096];

240 
f’ame
[256];

241 
fd
, 
couÁ
;

242 *
p
, *
x
;

244 
	`¢´štf
(
f’ame
,256,"/´oc/%d/¡©",
	`g‘pid
());

245 ià((
fd
 = 
	`İ’
(
f’ame
,
O_RDONLY
)) == -1)  0;

246 ià(
	`»ad
(
fd
,
buf
,4096) <= 0) {

247 
	`şo£
(
fd
);

250 
	`şo£
(
fd
);

252 
p
 = 
buf
;

253 
couÁ
 = 23;

254 
p
 && 
couÁ
--) {

255 
p
 = 
	`¡rchr
(p,' ');

256 ià(
p
)…++;

258 ià(!
p
)  0;

259 
x
 = 
	`¡rchr
(
p
,' ');

260 ià(!
x
)  0;

261 *
x
 = '\0';

263 
rss
 = 
	`¡¹Şl
(
p
,
NULL
,10);

264 
rss
 *ğ
·ge
;

265  
rss
;

266 
	}
}

267 #–ià
defšed
(
HAVE_TASKINFO
)

268 
	~<uni¡d.h
>

269 
	~<¡dio.h
>

270 
	~<¡dlib.h
>

271 
	~<sys/ty³s.h
>

272 
	~<sys/sysùl.h
>

273 
	~<mach/sk.h
>

274 
	~<mach/mach_š™.h
>

276 
size_t
 
	$zm®loc_g‘_rss
() {

277 
sk_t
 
sk
 = 
MACH_PORT_NULL
;

278 
sk_basic_šfo
 
t_šfo
;

279 
mach_msg_ty³_numb”_t
 
t_šfo_couÁ
 = 
TASK_BASIC_INFO_COUNT
;

281 ià(
	`sk_fÜ_pid
(
	`cu¼’t_sk
(), 
	`g‘pid
(), &
sk
è!ğ
KERN_SUCCESS
)

283 
	`sk_šfo
(
sk
, 
TASK_BASIC_INFO
, (
sk_šfo_t
)&
t_šfo
, &
t_šfo_couÁ
);

285  
t_šfo
.
»sid’t_size
;

286 
	}
}

288 
size_t
 
	$zm®loc_g‘_rss
() {

294  
	`zm®loc_u£d_memÜy
();

295 
	}
}

299 
	$zm®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
) {

300  ()
rss
/
	`zm®loc_u£d_memÜy
();

301 
	}
}

309 #ià
defšed
(
HAVE_PROC_SMAPS
)

310 
size_t
 
	$zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
) {

311 
lše
[1024];

312 
size_t
 
by‹s
 = 0;

313 
FILE
 *
å
 = 
	`fİ’
("/proc/self/smaps","r");

314 
æ’
 = 
	`¡¾’
(
f›ld
);

316 ià(!
å
)  0;

317 
	`fg‘s
(
lše
,Öše),
å
è!ğ
NULL
) {

318 ià(
	`¡ºcmp
(
lše
,
f›ld
,
æ’
) == 0) {

319 *
p
 = 
	`¡rchr
(
lše
,'k');

320 ià(
p
) {

321 *
p
 = '\0';

322 
by‹s
 +ğ
	`¡¹Ş
(
lše
+
æ’
,
NULL
,10) * 1024;

326 
	`fşo£
(
å
);

327  
by‹s
;

328 
	}
}

330 
size_t
 
	$zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
) {

331 ((è
f›ld
);

333 
	}
}

336 
size_t
 
	$zm®loc_g‘_´iv©e_dœty
() {

337  
	`zm®loc_g‘_sm­_by‹s_by_f›ld
("Private_Dirty:");

338 
	}
}

353 
size_t
 
	$zm®loc_g‘_memÜy_size
() {

354 #ià
	`defšed
(
__unix__
è|| defšed(
__unix
è|| defšed(
unix
) || \

355 (
	`defšed
(
__APPLE__
è&& defšed(
__MACH__
))

356 #ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_MEMSIZE
è|| defšed(
HW_PHYSMEM64
))

357 
mib
[2];

358 
mib
[0] = 
CTL_HW
;

359 #ià
	`defšed
(
HW_MEMSIZE
)

360 
mib
[1] = 
HW_MEMSIZE
;

361 #–ià
	`defšed
(
HW_PHYSMEM64
)

362 
mib
[1] = 
HW_PHYSMEM64
;

364 
št64_t
 
size
 = 0;

365 
size_t
 
Ën
 = (
size
);

366 ià(
	`sysùl
Ğ
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

367  (
size_t
)
size
;

370 #–ià
	`defšed
(
_SC_PHYS_PAGES
è&& defšed(
_SC_PAGESIZE
)

372  (
size_t
)
	`syscÚf
(
_SC_PHYS_PAGES
è* (size_t)syscÚf(
_SC_PAGESIZE
);

374 #–ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_PHYSMEM
è|| defšed(
HW_REALMEM
))

376 
mib
[2];

377 
mib
[0] = 
CTL_HW
;

378 #ià
	`defšed
(
HW_REALMEM
)

379 
mib
[1] = 
HW_REALMEM
;

380 #–ià
	`defšed
(
HW_PYSMEM
)

381 
mib
[1] = 
HW_PHYSMEM
;

383 
size
 = 0;

384 
size_t
 
Ën
 = (
size
);

385 ià(
	`sysùl
(
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

386  (
size_t
)
size
;

393 
	}
}

	@zmalloc.h

31 #iâdeà
__ZMALLOC_H


32 
	#__ZMALLOC_H


	)

35 
	#__x¡r
(
s
è
	`__¡r
(s)

	)

36 
	#__¡r
(
s
è#s

	)

38 #ià
defšed
(
USE_TCMALLOC
)

39 
	#ZMALLOC_LIB
 ("tcm®loc-" 
	`__x¡r
(
TC_VERSION_MAJOR
è"." __x¡r(
TC_VERSION_MINOR
))

	)

40 
	~<googË/tcm®loc.h
>

41 #ià(
TC_VERSION_MAJOR
 =ğ1 && 
TC_VERSION_MINOR
 >= 6) || (TC_VERSION_MAJOR > 1)

42 
	#HAVE_MALLOC_SIZE
 1

	)

43 
	#zm®loc_size
(
p
è
	`tc_m®loc_size
Õ)

	)

48 #–ià
defšed
(
USE_JEMALLOC
)

49 
	#ZMALLOC_LIB
 ("jem®loc-" 
	`__x¡r
(
JEMALLOC_VERSION_MAJOR
è"." __x¡r(
JEMALLOC_VERSION_MINOR
è"." __x¡r(
JEMALLOC_VERSION_BUGFIX
))

	)

50 
	~<jem®loc/jem®loc.h
>

51 #ià(
JEMALLOC_VERSION_MAJOR
 =ğ2 && 
JEMALLOC_VERSION_MINOR
 >= 1) || (JEMALLOC_VERSION_MAJOR > 2)

52 
	#HAVE_MALLOC_SIZE
 1

	)

53 
	#zm®loc_size
(
p
è
	`je_m®loc_u§bË_size
Õ)

	)

58 #–ià
defšed
(
__APPLE__
)

59 
	~<m®loc/m®loc.h
>

60 
	#HAVE_MALLOC_SIZE
 1

	)

61 
	#zm®loc_size
(
p
è
	`m®loc_size
Õ)

	)

64 #iâdeà
ZMALLOC_LIB


65 
	#ZMALLOC_LIB
 "libc"

	)

68 *
zm®loc
(
size_t
 
size
);

69 *
zÿÎoc
(
size_t
 
size
);

70 *
z»®loc
(*
±r
, 
size_t
 
size
);

71 
zä“
(*
±r
);

72 *
z¡rdup
(cÚ¡ *
s
);

73 
size_t
 
zm®loc_u£d_memÜy
();

74 
zm®loc_’abË_th»ad_§ãÃss
();

75 
zm®loc_£t_oom_hªdËr
((*
oom_hªdËr
)(
size_t
));

76 
	`zm®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
);

77 
size_t
 
	`zm®loc_g‘_rss
();

78 
size_t
 
	`zm®loc_g‘_´iv©e_dœty
();

79 
size_t
 
	`zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
);

80 
size_t
 
	`zm®loc_g‘_memÜy_size
();

81 
	`zlibc_ä“
(*
±r
);

83 #iâdeà
HAVE_MALLOC_SIZE


84 
size_t
 
	`zm®loc_size
(*
±r
);

	@/usr/include/arpa/inet.h

18 #iâdeà
_ARPA_INET_H


19 
	#_ARPA_INET_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<Ãtš‘/š.h
>

25 #iâdeà
__sockËn_t_defšed


26 
__sockËn_t
 
	tsockËn_t
;

27 
	#__sockËn_t_defšed


	)

30 
__BEGIN_DECLS


34 
š_addr_t
 
	$š‘_addr
 (cÚ¡ *
__ı
è
__THROW
;

37 
š_addr_t
 
	$š‘_Êaof
 (
š_addr
 
__š
è
__THROW
;

41 
š_addr
 
	$š‘_mak—ddr
 (
š_addr_t
 
__Ãt
, in_addr_ˆ
__ho¡
)

42 
__THROW
;

45 
š_addr_t
 
	$š‘_Ãtof
 (
š_addr
 
__š
è
__THROW
;

49 
š_addr_t
 
	$š‘_ÃtwÜk
 (cÚ¡ *
__ı
è
__THROW
;

53 *
	$š‘_Áß
 (
š_addr
 
__š
è
__THROW
;

58 
	$š‘_±Ú
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

59 *
__»¡riù
 
__buf
è
__THROW
;

64 cÚ¡ *
	$š‘_Áİ
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

65 *
__»¡riù
 
__buf
, 
sockËn_t
 
__Ën
)

66 
__THROW
;

70 #ifdeà
__USE_MISC


73 
	$š‘_©Ú
 (cÚ¡ *
__ı
, 
š_addr
 *
__šp
è
__THROW
;

77 *
	$š‘_Ã
 (
š_addr_t
 
__Ãt
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

82 *
	$š‘_Ãt_Áİ
 (
__af
, cÚ¡ *
__ı
, 
__b™s
,

83 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

88 
	$š‘_Ãt_±Ú
 (
__af
, cÚ¡ *
__ı
,

89 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

94 
	$š‘_n§p_addr
 (cÚ¡ *
__ı
,

95 *
__buf
, 
__Ën
è
__THROW
;

99 *
	$š‘_n§p_Áß
 (
__Ën
, cÚ¡ *
__ı
,

100 *
__buf
è
__THROW
;

103 
__END_DECLS


	@/usr/include/assert.h

22 #ifdef 
_ASSERT_H


24 #undeà
_ASSERT_H


25 #undeà
as£¹


26 #undeà
__ASSERT_VOID_CAST


28 #ifdef 
__USE_GNU


29 #undeà
as£¹_³¼Ü


34 
	#_ASSERT_H
 1

	)

35 
	~<ã©u»s.h
>

37 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,95)

38 
	#__ASSERT_VOID_CAST
 
¡©ic_ÿ¡
<>

	)

40 
	#__ASSERT_VOID_CAST
 ()

	)

48 #ifdef 
NDEBUG


50 
	#as£¹
(
ex´
è(
	`__ASSERT_VOID_CAST
 (0))

	)

58 #ifdef 
__USE_GNU


59 
	#as£¹_³¼Ü
(
”ºum
è(
	`__ASSERT_VOID_CAST
 (0))

	)

64 #iâdeà
_ASSERT_H_DECLS


65 
	#_ASSERT_H_DECLS


	)

66 
__BEGIN_DECLS


69 
	$__as£¹_ç
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
,

70 
__lše
, cÚ¡ *
__funùiÚ
)

71 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

74 
	$__as£¹_³¼Ü_ç
 (
__”ºum
, cÚ¡ *
__fe
,

75 
__lše
, cÚ¡ *
__funùiÚ
)

76 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

81 
	$__as£¹
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
, 
__lše
)

82 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

85 
__END_DECLS


88 
	#as£¹
(
ex´
) \

89 ((
ex´
) \

90 ? 
	`__ASSERT_VOID_CAST
 (0) \

91 : 
	`__as£¹_ç
 (
	`__STRING
(
ex´
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

93 #ifdef 
__USE_GNU


94 
	#as£¹_³¼Ü
(
”ºum
) \

95 (!(
”ºum
) \

96 ? 
	`__ASSERT_VOID_CAST
 (0) \

97 : 
	`__as£¹_³¼Ü_ç
 ((
”ºum
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

105 #ià
defšed
 
__ılu¥lus
 ? 
	`__GNUC_PREREQ
 (2, 6) : __GNUC_PREREQ (2, 4)

106 
	#__ASSERT_FUNCTION
 
__PRETTY_FUNCTION__


	)

108 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

109 
	#__ASSERT_FUNCTION
 
__func__


	)

111 
	#__ASSERT_FUNCTION
 ((cÚ¡ *è0)

	)

118 #ià
defšed
 
__USE_ISOC11
 && !defšed 
__ılu¥lus


120 #undeà
¡©ic_as£¹


121 
	#¡©ic_as£¹
 
_Stic_as£¹


	)

	@/usr/include/ctype.h

22 #iâdef 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 
	g__BEGIN_DECLS


30 #iâdeà
_ISb™


39 
	~<’dŸn.h
>

40 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


41 
	#_ISb™
(
b™
è(1 << (b™))

	)

43 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

48 
	m_ISuµ”
 = 
_ISb™
 (0),

49 
	m_ISlow”
 = 
_ISb™
 (1),

50 
	m_IS®pha
 = 
_ISb™
 (2),

51 
	m_ISdig™
 = 
_ISb™
 (3),

52 
	m_ISxdig™
 = 
_ISb™
 (4),

53 
	m_IS¥aû
 = 
_ISb™
 (5),

54 
	m_IS´št
 = 
_ISb™
 (6),

55 
	m_ISg¿ph
 = 
_ISb™
 (7),

56 
	m_ISbÏnk
 = 
_ISb™
 (8),

57 
	m_ISúŒl
 = 
_ISb™
 (9),

58 
	m_ISpunù
 = 
_ISb™
 (10),

59 
	m_IS®num
 = 
_ISb™
 (11)

79 cÚ¡ **
	$__ùy³_b_loc
 ()

80 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

81 cÚ¡ 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

83 cÚ¡ 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

87 #iâdeà
__ılu¥lus


88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

90 #–ià
defšed
 
__USE_EXTERN_INLINES


91 
	#__isùy³_f
(
ty³
) \

92 
__ex‹º_šlše
 \

93 
is
##
	`ty³
 (
__c
è
__THROW
 \

95  (*
	`__ùy³_b_loc
 ())[(è(
__c
)] & (è
_IS
##
ty³
; \

96 
	}

	)
}

99 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

100 
	#__tßscii
(
c
è((cè& 0x7fè

	)

102 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

104 
__BEGIN_NAMESPACE_STD


110 
__exùy³
 (
i§Êum
);

111 
__exùy³
 (
i§Íha
);

112 
__exùy³
 (
isúŒl
);

113 
__exùy³
 (
isdig™
);

114 
__exùy³
 (
i¦ow”
);

115 
__exùy³
 (
isg¿ph
);

116 
__exùy³
 (
i¥ršt
);

117 
__exùy³
 (
i¥unù
);

118 
__exùy³
 (
is¥aû
);

119 
__exùy³
 (
isuµ”
);

120 
__exùy³
 (
isxdig™
);

124 
	$tŞow”
 (
__c
è
__THROW
;

127 
	$touµ”
 (
__c
è
__THROW
;

129 
__END_NAMESPACE_STD


133 #ifdef 
__USE_ISOC99


134 
__BEGIN_NAMESPACE_C99


136 
	`__exùy³
 (
isbÏnk
);

138 
__END_NAMESPACE_C99


141 #ifdeà
__USE_GNU


143 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

146 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


150 
	$i§scii
 (
__c
è
__THROW
;

154 
	$tßscii
 (
__c
è
__THROW
;

158 
	`__exùy³
 (
_touµ”
);

159 
	`__exùy³
 (
_tŞow”
);

163 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

164 (
__ex‹nsiÚ__
 \

165 ({ 
__»s
; \

166 ià( (
c
) > 1) \

168 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

170 
__c
 = (
c
); \

171 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

174 
__»s
 = 
f
 
¬gs
; \

177 
__»s
 = (
a
)[(è(
c
)]; \

178 
__»s
; 
	}
}))

	)

180 #ià!
defšed
 
__NO_CTYPE


181 #ifdeà
__isùy³_f


182 
	$__isùy³_f
 (
®num
)

183 
	$__isùy³_f
 (
®pha
)

184 
	$__isùy³_f
 (
úŒl
)

185 
	$__isùy³_f
 (
dig™
)

186 
	$__isùy³_f
 (
low”
)

187 
	$__isùy³_f
 (
g¿ph
)

188 
	$__isùy³_f
 (
´št
)

189 
	$__isùy³_f
 (
punù
)

190 
	$__isùy³_f
 (
¥aû
)

191 
	$__isùy³_f
 (
uµ”
)

192 
	$__isùy³_f
 (
xdig™
)

193 #ifdeà
__USE_ISOC99


194 
	$__isùy³_f
 (
bÏnk
)

196 #–ià
defšed
 
__isùy³


197 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

198 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

199 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

200 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

201 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

202 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

203 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

204 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

205 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

206 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

207 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

208 #ifdeà
__USE_ISOC99


209 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

213 #ifdeà
__USE_EXTERN_INLINES


214 
__ex‹º_šlše
 

215 
	`__NTH
 (
	$tŞow”
 (
__c
))

217  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

218 
	}
}

220 
__ex‹º_šlše
 

221 
__NTH
 (
	$touµ”
 (
__c
))

223  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

224 
	}
}

227 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


228 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

229 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

232 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


233 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

234 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

236 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

237 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

243 #ifdeà
__USE_XOPEN2K8


257 
	~<xloÿË.h
>

261 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

262 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

264 
	#__exùy³_l
(
Çme
) \

265 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

271 
__exùy³_l
 (
i§Êum_l
);

272 
__exùy³_l
 (
i§Íha_l
);

273 
__exùy³_l
 (
isúŒl_l
);

274 
__exùy³_l
 (
isdig™_l
);

275 
__exùy³_l
 (
i¦ow”_l
);

276 
__exùy³_l
 (
isg¿ph_l
);

277 
__exùy³_l
 (
i¥ršt_l
);

278 
__exùy³_l
 (
i¥unù_l
);

279 
__exùy³_l
 (
is¥aû_l
);

280 
__exùy³_l
 (
isuµ”_l
);

281 
__exùy³_l
 (
isxdig™_l
);

283 
__exùy³_l
 (
isbÏnk_l
);

287 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

288 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

291 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

292 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

294 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


295 
	#__tŞow”_l
(
c
, 
loÿË
) \

296 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

297 
	#__touµ”_l
(
c
, 
loÿË
) \

298 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

299 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

300 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

304 #iâdeà
__NO_CTYPE


305 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

306 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

307 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

308 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

309 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

310 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

311 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

312 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

313 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

314 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

315 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

317 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

319 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


320 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

321 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

324 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

325 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

326 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

327 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

328 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

329 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

330 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

331 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

332 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

333 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

334 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

336 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

338 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


339 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

340 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

347 
__END_DECLS


	@/usr/include/dlfcn.h

19 #iâdef 
_DLFCN_H


20 
	#_DLFCN_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

27 
	~<b™s/dlfú.h
>

30 #ifdeà
__USE_GNU


35 
	#RTLD_NEXT
 ((*è-1l)

	)

40 
	#RTLD_DEFAULT
 ((*è0)

	)

44 
	tLmid_t
;

47 
	#LM_ID_BASE
 0

	)

48 
	#LM_ID_NEWLM
 -1

	)

52 
__BEGIN_DECLS


56 *
	$dlİ’
 (cÚ¡ *
__fe
, 
__mode
è
__THROWNL
;

60 
	$dlşo£
 (*
__hªdË
è
__THROWNL
 
	`__nÚnuÎ
 ((1));

64 *
	$dlsym
 (*
__»¡riù
 
__hªdË
,

65 cÚ¡ *
__»¡riù
 
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((2));

67 #ifdeà
__USE_GNU


69 *
	$dlmİ’
 (
Lmid_t
 
__nsid
, cÚ¡ *
__fe
, 
__mode
è
__THROWNL
;

73 *
	$dlvsym
 (*
__»¡riù
 
__hªdË
,

74 cÚ¡ *
__»¡riù
 
__Çme
,

75 cÚ¡ *
__»¡riù
 
__v”siÚ
)

76 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

82 *
	$dË¼Ü
 (è
__THROW
;

85 #ifdeà
__USE_GNU


90 cÚ¡ *
dli_âame
;

91 *
dli_fba£
;

92 cÚ¡ *
dli_¢ame
;

93 *
dli_§ddr
;

94 } 
	tDl_šfo
;

98 
	$dÏddr
 (cÚ¡ *
__add»ss
, 
Dl_šfo
 *
__šfo
)

99 
__THROW
 
	`__nÚnuÎ
 ((2));

102 
	$dÏddr1
 (cÚ¡ *
__add»ss
, 
Dl_šfo
 *
__šfo
,

103 **
__exŒa_šfo
, 
__æags
è
__THROW
 
	`__nÚnuÎ
 ((2));

111 
RTLD_DL_SYMENT
 = 1,

114 
RTLD_DL_LINKMAP
 = 2

123 
	$dlšfo
 (*
__»¡riù
 
__hªdË
,

124 
__»que¡
, *
__»¡riù
 
__¬g
)

125 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

131 
RTLD_DI_LMID
 = 1,

135 
RTLD_DI_LINKMAP
 = 2,

137 
RTLD_DI_CONFIGADDR
 = 3,

144 
RTLD_DI_SERINFO
 = 4,

145 
RTLD_DI_SERINFOSIZE
 = 5,

149 
RTLD_DI_ORIGIN
 = 6,

151 
RTLD_DI_PROFILENAME
 = 7,

152 
RTLD_DI_PROFILEOUT
 = 8,

157 
RTLD_DI_TLS_MODID
 = 9,

163 
RTLD_DI_TLS_DATA
 = 10,

165 
RTLD_DI_MAX
 = 10

173 *
dls_Çme
;

174 
dls_æags
;

175 } 
	tDl_£½©h
;

181 
size_t
 
dls_size
;

182 
dls_út
;

183 
Dl_£½©h
 
dls_£½©h
[1];

184 } 
	tDl_£ršfo
;

188 
__END_DECLS


	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_BSD


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_BSD
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

62 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


63 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

64 
	#htŞe16
(
x
è(x)

	)

65 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

66 
	#Ë16toh
(
x
è(x)

	)

68 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

69 
	#htŞe32
(
x
è(x)

	)

70 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

71 
	#Ë32toh
(
x
è(x)

	)

73 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

74 
	#htŞe64
(
x
è(x)

	)

75 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

76 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/errno.h

22 #iâdef 
_ERRNO_H


26 #iâdef 
__Ãed_Em©h


27 
	#_ERRNO_H
 1

	)

28 
	~<ã©u»s.h
>

31 
	g__BEGIN_DECLS


35 
	~<b™s/”ºo.h
>

36 #undeà
__Ãed_Em©h


38 #ifdef 
_ERRNO_H


45 #iâdef 
”ºo


46 
”ºo
;

49 #ifdeà
__USE_GNU


54 *
´og¿m_švoÿtiÚ_Çme
, *
´og¿m_švoÿtiÚ_shÜt_Çme
;

58 
	g__END_DECLS


66 #ià
defšed
 
__USE_GNU
 || defšed 
__Ãed_”rÜ_t


67 #iâdeà
__”rÜ_t_defšed


68 
	t”rÜ_t
;

69 
	#__”rÜ_t_defšed
 1

	)

71 #undeà
__Ãed_”rÜ_t


	@/usr/include/execinfo.h

18 #iâdeà
_EXECINFO_H


19 
	#_EXECINFO_H
 1

	)

21 
	~<ã©u»s.h
>

23 
__BEGIN_DECLS


27 
	$backŒaû
 (**
__¬¿y
, 
__size
è
	`__nÚnuÎ
 ((1));

32 **
	$backŒaû_symbŞs
 (*cÚ¡ *
__¬¿y
, 
__size
)

33 
__THROW
 
	`__nÚnuÎ
 ((1));

38 
	$backŒaû_symbŞs_fd
 (*cÚ¡ *
__¬¿y
, 
__size
, 
__fd
)

39 
__THROW
 
	`__nÚnuÎ
 ((1));

41 
__END_DECLS


	@/usr/include/fcntl.h

22 #iâdef 
_FCNTL_H


23 
	#_FCNTL_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


31 
	~<b™s/ty³s.h
>

35 
	~<b™s/fú.h
>

40 #iâdeà
__mode_t_defšed


41 
__mode_t
 
	tmode_t
;

42 
	#__mode_t_defšed


	)

45 #iâdeà
__off_t_defšed


46 #iâdeà
__USE_FILE_OFFSET64


47 
__off_t
 
	toff_t
;

49 
__off64_t
 
	toff_t
;

51 
	#__off_t_defšed


	)

54 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


55 
__off64_t
 
	toff64_t
;

56 
	#__off64_t_defšed


	)

59 #iâdeà
__pid_t_defšed


60 
__pid_t
 
	tpid_t
;

61 
	#__pid_t_defšed


	)

65 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


66 
	#__Ãed_time¥ec


	)

67 
	~<time.h
>

68 
	~<b™s/¡©.h
>

70 
	#S_IFMT
 
__S_IFMT


	)

71 
	#S_IFDIR
 
__S_IFDIR


	)

72 
	#S_IFCHR
 
__S_IFCHR


	)

73 
	#S_IFBLK
 
__S_IFBLK


	)

74 
	#S_IFREG
 
__S_IFREG


	)

75 #ifdeà
__S_IFIFO


76 
	#S_IFIFO
 
__S_IFIFO


	)

78 #ifdeà
__S_IFLNK


79 
	#S_IFLNK
 
__S_IFLNK


	)

81 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
è&& defšed 
__S_IFSOCK


82 
	#S_IFSOCK
 
__S_IFSOCK


	)

87 
	#S_ISUID
 
__S_ISUID


	)

88 
	#S_ISGID
 
__S_ISGID


	)

90 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


92 
	#S_ISVTX
 
__S_ISVTX


	)

95 
	#S_IRUSR
 
__S_IREAD


	)

96 
	#S_IWUSR
 
__S_IWRITE


	)

97 
	#S_IXUSR
 
__S_IEXEC


	)

99 
	#S_IRWXU
 (
__S_IREAD
|
__S_IWRITE
|
__S_IEXEC
)

	)

101 
	#S_IRGRP
 (
S_IRUSR
 >> 3è

	)

102 
	#S_IWGRP
 (
S_IWUSR
 >> 3è

	)

103 
	#S_IXGRP
 (
S_IXUSR
 >> 3è

	)

105 
	#S_IRWXG
 (
S_IRWXU
 >> 3)

	)

107 
	#S_IROTH
 (
S_IRGRP
 >> 3è

	)

108 
	#S_IWOTH
 (
S_IWGRP
 >> 3è

	)

109 
	#S_IXOTH
 (
S_IXGRP
 >> 3è

	)

111 
	#S_IRWXO
 (
S_IRWXG
 >> 3)

	)

114 #ifdef 
__USE_MISC


115 #iâdeà
R_OK


118 
	#R_OK
 4

	)

119 
	#W_OK
 2

	)

120 
	#X_OK
 1

	)

121 
	#F_OK
 0

	)

126 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


127 
	#SEEK_SET
 0

	)

128 
	#SEEK_CUR
 1

	)

129 
	#SEEK_END
 2

	)

137 
fú
 (
__fd
, 
__cmd
, ...);

145 #iâdeà
__USE_FILE_OFFSET64


146 
	$İ’
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

148 #ifdeà
__REDIRECT


149 
	`__REDIRECT
 (
İ’
, (cÚ¡ *
__fe
, 
__oæag
, ...), 
İ’64
)

150 
	`__nÚnuÎ
 ((1));

152 
	#İ’
 
İ’64


	)

155 #ifdeà
__USE_LARGEFILE64


156 
	$İ’64
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

159 #ifdeà
__USE_ATFILE


169 #iâdeà
__USE_FILE_OFFSET64


170 
	$İ’©
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

171 
	`__nÚnuÎ
 ((2));

173 #ifdeà
__REDIRECT


174 
	`__REDIRECT
 (
İ’©
, (
__fd
, cÚ¡ *
__fe
, 
__oæag
,

175 ...), 
İ’©64
è
	`__nÚnuÎ
 ((2));

177 
	#İ’©
 
İ’©64


	)

180 #ifdeà
__USE_LARGEFILE64


181 
	$İ’©64
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

182 
	`__nÚnuÎ
 ((2));

191 #iâdeà
__USE_FILE_OFFSET64


192 
	$ü—t
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

194 #ifdeà
__REDIRECT


195 
	`__REDIRECT
 (
ü—t
, (cÚ¡ *
__fe
, 
mode_t
 
__mode
),

196 
ü—t64
è
	`__nÚnuÎ
 ((1));

198 
	#ü—t
 
ü—t64


	)

201 #ifdeà
__USE_LARGEFILE64


202 
	$ü—t64
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

205 #ià!
defšed
 
F_LOCK
 && (defšed 
__USE_MISC
 || (defšed 
__USE_XOPEN_EXTENDED
 \

206 && !
defšed
 
__USE_POSIX
))

215 
	#F_ULOCK
 0

	)

216 
	#F_LOCK
 1

	)

217 
	#F_TLOCK
 2

	)

218 
	#F_TEST
 3

	)

220 #iâdeà
__USE_FILE_OFFSET64


221 
	`lockf
 (
__fd
, 
__cmd
, 
off_t
 
__Ën
);

223 #ifdeà
__REDIRECT


224 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
), 
lockf64
);

226 
	#lockf
 
lockf64


	)

229 #ifdeà
__USE_LARGEFILE64


230 
	`lockf64
 (
__fd
, 
__cmd
, 
off64_t
 
__Ën
);

234 #ifdeà
__USE_XOPEN2K


237 #iâdeà
__USE_FILE_OFFSET64


238 
	$posix_çdvi£
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
,

239 
__advi£
è
__THROW
;

241 #ifdeà
__REDIRECT_NTH


242 
	`__REDIRECT_NTH
 (
posix_çdvi£
, (
__fd
, 
__off64_t
 
__off£t
,

243 
__off64_t
 
__Ën
, 
__advi£
),

244 
posix_çdvi£64
);

246 
	#posix_çdvi£
 
posix_çdvi£64


	)

249 #ifdeà
__USE_LARGEFILE64


250 
	$posix_çdvi£64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
,

251 
__advi£
è
__THROW
;

259 #iâdeà
__USE_FILE_OFFSET64


260 
	`posix_çÎoÿ‹
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
);

262 #ifdeà
__REDIRECT


263 
	`__REDIRECT
 (
posix_çÎoÿ‹
, (
__fd
, 
__off64_t
 
__off£t
,

264 
__off64_t
 
__Ën
),

265 
posix_çÎoÿ‹64
);

267 
	#posix_çÎoÿ‹
 
posix_çÎoÿ‹64


	)

270 #ifdeà
__USE_LARGEFILE64


271 
	`posix_çÎoÿ‹64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
);

277 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ
 \

278 && 
defšed
 
__va_¬g_·ck_Ën


279 
	~<b™s/fú2.h
>

282 
__END_DECLS


	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

101 #undeà
__USE_ISOC11


102 #undeà
__USE_ISOC99


103 #undeà
__USE_ISOC95


104 #undeà
__USE_ISOCXX11


105 #undeà
__USE_POSIX


106 #undeà
__USE_POSIX2


107 #undeà
__USE_POSIX199309


108 #undeà
__USE_POSIX199506


109 #undeà
__USE_XOPEN


110 #undeà
__USE_XOPEN_EXTENDED


111 #undeà
__USE_UNIX98


112 #undeà
__USE_XOPEN2K


113 #undeà
__USE_XOPEN2KXSI


114 #undeà
__USE_XOPEN2K8


115 #undeà
__USE_XOPEN2K8XSI


116 #undeà
__USE_LARGEFILE


117 #undeà
__USE_LARGEFILE64


118 #undeà
__USE_FILE_OFFSET64


119 #undeà
__USE_BSD


120 #undeà
__USE_SVID


121 #undeà
__USE_MISC


122 #undeà
__USE_ATFILE


123 #undeà
__USE_GNU


124 #undeà
__USE_REENTRANT


125 #undeà
__USE_FORTIFY_LEVEL


126 #undeà
__KERNEL_STRICT_NAMES


130 #iâdeà
_LOOSE_KERNEL_NAMES


131 
	#__KERNEL_STRICT_NAMES


	)

141 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


142 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

143 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

145 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

150 #ifdeà
_GNU_SOURCE


151 #undeà
_ISOC95_SOURCE


152 
	#_ISOC95_SOURCE
 1

	)

153 #undeà
_ISOC99_SOURCE


154 
	#_ISOC99_SOURCE
 1

	)

155 #undeà
_ISOC11_SOURCE


156 
	#_ISOC11_SOURCE
 1

	)

157 #undeà
_POSIX_SOURCE


158 
	#_POSIX_SOURCE
 1

	)

159 #undeà
_POSIX_C_SOURCE


160 
	#_POSIX_C_SOURCE
 200809L

	)

161 #undeà
_XOPEN_SOURCE


162 
	#_XOPEN_SOURCE
 700

	)

163 #undeà
_XOPEN_SOURCE_EXTENDED


164 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

165 #undeà
_LARGEFILE64_SOURCE


166 
	#_LARGEFILE64_SOURCE
 1

	)

167 #undeà
_DEFAULT_SOURCE


168 
	#_DEFAULT_SOURCE
 1

	)

169 #undeà
_BSD_SOURCE


170 
	#_BSD_SOURCE
 1

	)

171 #undeà
_SVID_SOURCE


172 
	#_SVID_SOURCE
 1

	)

173 #undeà
_ATFILE_SOURCE


174 
	#_ATFILE_SOURCE
 1

	)

179 #ià(
defšed
 
_DEFAULT_SOURCE
 \

180 || (!
defšed
 
	g__STRICT_ANSI__
 \

181 && !
defšed
 
	g_ISOC99_SOURCE
 \

182 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

183 && !
defšed
 
	g_XOPEN_SOURCE
 \

184 && !
defšed
 
	g_BSD_SOURCE
 && !defšed 
	g_SVID_SOURCE
))

185 #undeà
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

187 #undeà
_BSD_SOURCE


188 
	#_BSD_SOURCE
 1

	)

189 #undeà
_SVID_SOURCE


190 
	#_SVID_SOURCE
 1

	)

194 #ià(
defšed
 
_ISOC11_SOURCE
 \

195 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

196 
	#__USE_ISOC11
 1

	)

200 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

201 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

202 
	#__USE_ISOC99
 1

	)

206 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

207 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

208 
	#__USE_ISOC95
 1

	)

215 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

216 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

217 
	#__USE_ISOCXX11
 1

	)

223 #ifdeà
_DEFAULT_SOURCE


224 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


225 
	#__USE_POSIX_IMPLICITLY
 1

	)

227 #undeà
_POSIX_SOURCE


228 
	#_POSIX_SOURCE
 1

	)

229 #undeà
_POSIX_C_SOURCE


230 
	#_POSIX_C_SOURCE
 200809L

	)

232 #ià((!
defšed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

233 !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

234 
	#_POSIX_SOURCE
 1

	)

235 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

236 
	#_POSIX_C_SOURCE
 2

	)

237 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

238 
	#_POSIX_C_SOURCE
 199506L

	)

239 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

240 
	#_POSIX_C_SOURCE
 200112L

	)

242 
	#_POSIX_C_SOURCE
 200809L

	)

244 
	#__USE_POSIX_IMPLICITLY
 1

	)

247 #ià
defšed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >ğ1 || defšed 
_XOPEN_SOURCE


248 
	#__USE_POSIX
 1

	)

251 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


252 
	#__USE_POSIX2
 1

	)

255 #ià(
_POSIX_C_SOURCE
 - 0) >= 199309L

256 
	#__USE_POSIX199309
 1

	)

259 #ià(
_POSIX_C_SOURCE
 - 0) >= 199506L

260 
	#__USE_POSIX199506
 1

	)

263 #ià(
_POSIX_C_SOURCE
 - 0) >= 200112L

264 
	#__USE_XOPEN2K
 1

	)

265 #undeà
__USE_ISOC95


266 
	#__USE_ISOC95
 1

	)

267 #undeà
__USE_ISOC99


268 
	#__USE_ISOC99
 1

	)

271 #ià(
_POSIX_C_SOURCE
 - 0) >= 200809L

272 
	#__USE_XOPEN2K8
 1

	)

273 #undeà
_ATFILE_SOURCE


274 
	#_ATFILE_SOURCE
 1

	)

277 #ifdef 
_XOPEN_SOURCE


278 
	#__USE_XOPEN
 1

	)

279 #ià(
_XOPEN_SOURCE
 - 0) >= 500

280 
	#__USE_XOPEN_EXTENDED
 1

	)

281 
	#__USE_UNIX98
 1

	)

282 #undeà
_LARGEFILE_SOURCE


283 
	#_LARGEFILE_SOURCE
 1

	)

284 #ià(
_XOPEN_SOURCE
 - 0) >= 600

285 #ià(
_XOPEN_SOURCE
 - 0) >= 700

286 
	#__USE_XOPEN2K8
 1

	)

287 
	#__USE_XOPEN2K8XSI
 1

	)

289 
	#__USE_XOPEN2K
 1

	)

290 
	#__USE_XOPEN2KXSI
 1

	)

291 #undeà
__USE_ISOC95


292 
	#__USE_ISOC95
 1

	)

293 #undeà
__USE_ISOC99


294 
	#__USE_ISOC99
 1

	)

297 #ifdeà
_XOPEN_SOURCE_EXTENDED


298 
	#__USE_XOPEN_EXTENDED
 1

	)

303 #ifdeà
_LARGEFILE_SOURCE


304 
	#__USE_LARGEFILE
 1

	)

307 #ifdeà
_LARGEFILE64_SOURCE


308 
	#__USE_LARGEFILE64
 1

	)

311 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

312 
	#__USE_FILE_OFFSET64
 1

	)

315 #ià
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE


316 
	#__USE_MISC
 1

	)

319 #ifdef 
_BSD_SOURCE


320 
	#__USE_BSD
 1

	)

323 #ifdef 
_SVID_SOURCE


324 
	#__USE_SVID
 1

	)

327 #ifdef 
_ATFILE_SOURCE


328 
	#__USE_ATFILE
 1

	)

331 #ifdef 
_GNU_SOURCE


332 
	#__USE_GNU
 1

	)

335 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


336 
	#__USE_REENTRANT
 1

	)

339 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

340 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

341 #ià
_FORTIFY_SOURCE
 > 1

342 
	#__USE_FORTIFY_LEVEL
 2

	)

344 
	#__USE_FORTIFY_LEVEL
 1

	)

347 
	#__USE_FORTIFY_LEVEL
 0

	)

352 
	~<¡dc-´edef.h
>

360 #undeà
__GNU_LIBRARY__


361 
	#__GNU_LIBRARY__
 6

	)

365 
	#__GLIBC__
 2

	)

366 
	#__GLIBC_MINOR__
 19

	)

368 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

369 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

372 #iâdeà
__ASSEMBLER__


373 #iâdeà
_SYS_CDEFS_H


374 
	~<sys/cdefs.h
>

379 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


380 
	#__USE_LARGEFILE
 1

	)

381 
	#__USE_LARGEFILE64
 1

	)

387 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

388 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

389 && 
defšed
 
	g__ex‹º_šlše


390 
	#__USE_EXTERN_INLINES
 1

	)

398 
	~<gnu/¡ubs.h
>

	@/usr/include/inttypes.h

22 #iâdeà
_INTTYPES_H


23 
	#_INTTYPES_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<¡dšt.h
>

30 #iâdeà
____gwch¬_t_defšed


31 #ifdeà
__ılu¥lus


32 
	#__gwch¬_t
 
wch¬_t


	)

33 #–ià
defšed
 
__WCHAR_TYPE__


34 
__WCHAR_TYPE__
 
	t__gwch¬_t
;

36 
	#__Ãed_wch¬_t


	)

37 
	~<¡ddef.h
>

38 
wch¬_t
 
	t__gwch¬_t
;

40 
	#____gwch¬_t_defšed
 1

	)

43 #ià
__WORDSIZE
 == 64

44 
	#__PRI64_PREFIX
 "l"

	)

45 
	#__PRIPTR_PREFIX
 "l"

	)

47 
	#__PRI64_PREFIX
 "Î"

	)

48 
	#__PRIPTR_PREFIX


	)

54 
	#PRId8
 "d"

	)

55 
	#PRId16
 "d"

	)

56 
	#PRId32
 "d"

	)

57 
	#PRId64
 
__PRI64_PREFIX
 "d"

	)

59 
	#PRIdLEAST8
 "d"

	)

60 
	#PRIdLEAST16
 "d"

	)

61 
	#PRIdLEAST32
 "d"

	)

62 
	#PRIdLEAST64
 
__PRI64_PREFIX
 "d"

	)

64 
	#PRIdFAST8
 "d"

	)

65 
	#PRIdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

66 
	#PRIdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

67 
	#PRIdFAST64
 
__PRI64_PREFIX
 "d"

	)

70 
	#PRIi8
 "i"

	)

71 
	#PRIi16
 "i"

	)

72 
	#PRIi32
 "i"

	)

73 
	#PRIi64
 
__PRI64_PREFIX
 "i"

	)

75 
	#PRIiLEAST8
 "i"

	)

76 
	#PRIiLEAST16
 "i"

	)

77 
	#PRIiLEAST32
 "i"

	)

78 
	#PRIiLEAST64
 
__PRI64_PREFIX
 "i"

	)

80 
	#PRIiFAST8
 "i"

	)

81 
	#PRIiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

82 
	#PRIiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

83 
	#PRIiFAST64
 
__PRI64_PREFIX
 "i"

	)

86 
	#PRIo8
 "o"

	)

87 
	#PRIo16
 "o"

	)

88 
	#PRIo32
 "o"

	)

89 
	#PRIo64
 
__PRI64_PREFIX
 "o"

	)

91 
	#PRIoLEAST8
 "o"

	)

92 
	#PRIoLEAST16
 "o"

	)

93 
	#PRIoLEAST32
 "o"

	)

94 
	#PRIoLEAST64
 
__PRI64_PREFIX
 "o"

	)

96 
	#PRIoFAST8
 "o"

	)

97 
	#PRIoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

98 
	#PRIoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

99 
	#PRIoFAST64
 
__PRI64_PREFIX
 "o"

	)

102 
	#PRIu8
 "u"

	)

103 
	#PRIu16
 "u"

	)

104 
	#PRIu32
 "u"

	)

105 
	#PRIu64
 
__PRI64_PREFIX
 "u"

	)

107 
	#PRIuLEAST8
 "u"

	)

108 
	#PRIuLEAST16
 "u"

	)

109 
	#PRIuLEAST32
 "u"

	)

110 
	#PRIuLEAST64
 
__PRI64_PREFIX
 "u"

	)

112 
	#PRIuFAST8
 "u"

	)

113 
	#PRIuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

114 
	#PRIuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

115 
	#PRIuFAST64
 
__PRI64_PREFIX
 "u"

	)

118 
	#PRIx8
 "x"

	)

119 
	#PRIx16
 "x"

	)

120 
	#PRIx32
 "x"

	)

121 
	#PRIx64
 
__PRI64_PREFIX
 "x"

	)

123 
	#PRIxLEAST8
 "x"

	)

124 
	#PRIxLEAST16
 "x"

	)

125 
	#PRIxLEAST32
 "x"

	)

126 
	#PRIxLEAST64
 
__PRI64_PREFIX
 "x"

	)

128 
	#PRIxFAST8
 "x"

	)

129 
	#PRIxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

130 
	#PRIxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

131 
	#PRIxFAST64
 
__PRI64_PREFIX
 "x"

	)

134 
	#PRIX8
 "X"

	)

135 
	#PRIX16
 "X"

	)

136 
	#PRIX32
 "X"

	)

137 
	#PRIX64
 
__PRI64_PREFIX
 "X"

	)

139 
	#PRIXLEAST8
 "X"

	)

140 
	#PRIXLEAST16
 "X"

	)

141 
	#PRIXLEAST32
 "X"

	)

142 
	#PRIXLEAST64
 
__PRI64_PREFIX
 "X"

	)

144 
	#PRIXFAST8
 "X"

	)

145 
	#PRIXFAST16
 
__PRIPTR_PREFIX
 "X"

	)

146 
	#PRIXFAST32
 
__PRIPTR_PREFIX
 "X"

	)

147 
	#PRIXFAST64
 
__PRI64_PREFIX
 "X"

	)

151 
	#PRIdMAX
 
__PRI64_PREFIX
 "d"

	)

152 
	#PRIiMAX
 
__PRI64_PREFIX
 "i"

	)

153 
	#PRIoMAX
 
__PRI64_PREFIX
 "o"

	)

154 
	#PRIuMAX
 
__PRI64_PREFIX
 "u"

	)

155 
	#PRIxMAX
 
__PRI64_PREFIX
 "x"

	)

156 
	#PRIXMAX
 
__PRI64_PREFIX
 "X"

	)

160 
	#PRIdPTR
 
__PRIPTR_PREFIX
 "d"

	)

161 
	#PRIiPTR
 
__PRIPTR_PREFIX
 "i"

	)

162 
	#PRIoPTR
 
__PRIPTR_PREFIX
 "o"

	)

163 
	#PRIuPTR
 
__PRIPTR_PREFIX
 "u"

	)

164 
	#PRIxPTR
 
__PRIPTR_PREFIX
 "x"

	)

165 
	#PRIXPTR
 
__PRIPTR_PREFIX
 "X"

	)

171 
	#SCNd8
 "hhd"

	)

172 
	#SCNd16
 "hd"

	)

173 
	#SCNd32
 "d"

	)

174 
	#SCNd64
 
__PRI64_PREFIX
 "d"

	)

176 
	#SCNdLEAST8
 "hhd"

	)

177 
	#SCNdLEAST16
 "hd"

	)

178 
	#SCNdLEAST32
 "d"

	)

179 
	#SCNdLEAST64
 
__PRI64_PREFIX
 "d"

	)

181 
	#SCNdFAST8
 "hhd"

	)

182 
	#SCNdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

183 
	#SCNdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

184 
	#SCNdFAST64
 
__PRI64_PREFIX
 "d"

	)

187 
	#SCNi8
 "hhi"

	)

188 
	#SCNi16
 "hi"

	)

189 
	#SCNi32
 "i"

	)

190 
	#SCNi64
 
__PRI64_PREFIX
 "i"

	)

192 
	#SCNiLEAST8
 "hhi"

	)

193 
	#SCNiLEAST16
 "hi"

	)

194 
	#SCNiLEAST32
 "i"

	)

195 
	#SCNiLEAST64
 
__PRI64_PREFIX
 "i"

	)

197 
	#SCNiFAST8
 "hhi"

	)

198 
	#SCNiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

199 
	#SCNiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

200 
	#SCNiFAST64
 
__PRI64_PREFIX
 "i"

	)

203 
	#SCNu8
 "hhu"

	)

204 
	#SCNu16
 "hu"

	)

205 
	#SCNu32
 "u"

	)

206 
	#SCNu64
 
__PRI64_PREFIX
 "u"

	)

208 
	#SCNuLEAST8
 "hhu"

	)

209 
	#SCNuLEAST16
 "hu"

	)

210 
	#SCNuLEAST32
 "u"

	)

211 
	#SCNuLEAST64
 
__PRI64_PREFIX
 "u"

	)

213 
	#SCNuFAST8
 "hhu"

	)

214 
	#SCNuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

215 
	#SCNuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

216 
	#SCNuFAST64
 
__PRI64_PREFIX
 "u"

	)

219 
	#SCNo8
 "hho"

	)

220 
	#SCNo16
 "ho"

	)

221 
	#SCNo32
 "o"

	)

222 
	#SCNo64
 
__PRI64_PREFIX
 "o"

	)

224 
	#SCNoLEAST8
 "hho"

	)

225 
	#SCNoLEAST16
 "ho"

	)

226 
	#SCNoLEAST32
 "o"

	)

227 
	#SCNoLEAST64
 
__PRI64_PREFIX
 "o"

	)

229 
	#SCNoFAST8
 "hho"

	)

230 
	#SCNoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

231 
	#SCNoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

232 
	#SCNoFAST64
 
__PRI64_PREFIX
 "o"

	)

235 
	#SCNx8
 "hhx"

	)

236 
	#SCNx16
 "hx"

	)

237 
	#SCNx32
 "x"

	)

238 
	#SCNx64
 
__PRI64_PREFIX
 "x"

	)

240 
	#SCNxLEAST8
 "hhx"

	)

241 
	#SCNxLEAST16
 "hx"

	)

242 
	#SCNxLEAST32
 "x"

	)

243 
	#SCNxLEAST64
 
__PRI64_PREFIX
 "x"

	)

245 
	#SCNxFAST8
 "hhx"

	)

246 
	#SCNxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

247 
	#SCNxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

248 
	#SCNxFAST64
 
__PRI64_PREFIX
 "x"

	)

252 
	#SCNdMAX
 
__PRI64_PREFIX
 "d"

	)

253 
	#SCNiMAX
 
__PRI64_PREFIX
 "i"

	)

254 
	#SCNoMAX
 
__PRI64_PREFIX
 "o"

	)

255 
	#SCNuMAX
 
__PRI64_PREFIX
 "u"

	)

256 
	#SCNxMAX
 
__PRI64_PREFIX
 "x"

	)

259 
	#SCNdPTR
 
__PRIPTR_PREFIX
 "d"

	)

260 
	#SCNiPTR
 
__PRIPTR_PREFIX
 "i"

	)

261 
	#SCNoPTR
 
__PRIPTR_PREFIX
 "o"

	)

262 
	#SCNuPTR
 
__PRIPTR_PREFIX
 "u"

	)

263 
	#SCNxPTR
 
__PRIPTR_PREFIX
 "x"

	)

266 
	g__BEGIN_DECLS


268 #ià
__WORDSIZE
 == 64

273 
	mquÙ
;

274 
	m»m
;

275 } 
	timaxdiv_t
;

282 
__ex‹nsiÚ__
 
	mquÙ
;

283 
__ex‹nsiÚ__
 
	m»m
;

284 } 
	timaxdiv_t
;

290 
štmax_t
 
	$imaxabs
 (
štmax_t
 
__n
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

293 
imaxdiv_t
 
	$imaxdiv
 (
štmax_t
 
__num”
, iÁmax_ˆ
__d’om
)

294 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

297 
štmax_t
 
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

298 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

301 
uštmax_t
 
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

302 ** 
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

305 
štmax_t
 
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

306 
__gwch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

307 
__THROW
;

310 
uštmax_t
 
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

311 
__gwch¬_t
 ** 
__»¡riù
 
__’d±r
, 
__ba£
)

312 
__THROW
;

314 #ifdeà
__USE_EXTERN_INLINES


316 #ià
__WORDSIZE
 == 64

318 
	$__¡¹Ş_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

319 **
__»¡riù
 
__’d±r
,

320 
__ba£
, 
__group
)

321 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

323 
__ex‹º_šlše
 
štmax_t


324 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

325 
ba£
))

327  
	`__¡¹Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

328 
	}
}

330 
	$__¡¹oul_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

331 ** 
__»¡riù
 
__’d±r
,

332 
__ba£
, 
__group
)

333 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

335 
__ex‹º_šlše
 
uštmax_t


336 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

337 
ba£
))

339  
	`__¡¹oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

340 
	}
}

342 
	$__wc¡Ş_š‹º®
 (cÚ¡ 
__gwch¬_t
 * 
__»¡riù
 
__ÅŒ
,

343 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

344 
__ba£
, 
__group
)

345 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

347 
__ex‹º_šlše
 
štmax_t


348 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

349 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

351  
	`__wc¡Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

352 
	}
}

354 
	$__wc¡oul_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

355 
__»¡riù
 
__ÅŒ
,

356 
__gwch¬_t
 **

357 
__»¡riù
 
__’d±r
,

358 
__ba£
, 
__group
)

359 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

361 
__ex‹º_šlše
 
uštmax_t


362 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

363 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

365  
	`__wc¡oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

366 
	}
}

370 
__ex‹nsiÚ__


371 
	$__¡¹Şl_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

372 **
__»¡riù
 
__’d±r
,

373 
__ba£
, 
__group
)

374 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

376 
__ex‹º_šlše
 
štmax_t


377 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

378 
ba£
))

380  
	`__¡¹Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

381 
	}
}

383 
__ex‹nsiÚ__


384 
	$__¡¹ouÎ_š‹º®
 (const *

385 
__»¡riù
 
__ÅŒ
,

387 
__»¡riù
 
__’d±r
,

388 
__ba£
,

389 
__group
)

390 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

392 
__ex‹º_šlše
 
uštmax_t


393 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

394 
ba£
))

396  
	`__¡¹ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

397 
	}
}

399 
__ex‹nsiÚ__


400 
	$__wc¡Şl_š‹º®
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

401 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

402 
__ba£
, 
__group
)

403 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

405 
__ex‹º_šlše
 
štmax_t


406 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

407 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

409  
	`__wc¡Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

410 
	}
}

413 
__ex‹nsiÚ__


414 
	$__wc¡ouÎ_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

415 
__»¡riù
 
__ÅŒ
,

416 
__gwch¬_t
 **

417 
__»¡riù
 
__’d±r
,

418 
__ba£
,

419 
__group
)

420 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

422 
__ex‹º_šlše
 
uštmax_t


423 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

424 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

426  
	`__wc¡ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

427 
	}
}

432 
	g__END_DECLS


	@/usr/include/limits.h

22 #iâdeà
_LIBC_LIMITS_H_


23 
	#_LIBC_LIMITS_H_
 1

	)

25 
	~<ã©u»s.h
>

31 
	#MB_LEN_MAX
 16

	)

36 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

41 #iâdeà
_LIMITS_H


42 
	#_LIMITS_H
 1

	)

44 
	~<b™s/wÜdsize.h
>

53 
	#CHAR_BIT
 8

	)

56 
	#SCHAR_MIN
 (-128)

	)

57 
	#SCHAR_MAX
 127

	)

60 
	#UCHAR_MAX
 255

	)

63 #ifdeà
__CHAR_UNSIGNED__


64 
	#CHAR_MIN
 0

	)

65 
	#CHAR_MAX
 
UCHAR_MAX


	)

67 
	#CHAR_MIN
 
SCHAR_MIN


	)

68 
	#CHAR_MAX
 
SCHAR_MAX


	)

72 
	#SHRT_MIN
 (-32768)

	)

73 
	#SHRT_MAX
 32767

	)

76 
	#USHRT_MAX
 65535

	)

79 
	#INT_MIN
 (-
INT_MAX
 - 1)

	)

80 
	#INT_MAX
 2147483647

	)

83 
	#UINT_MAX
 4294967295U

	)

86 #ià
__WORDSIZE
 == 64

87 
	#LONG_MAX
 9223372036854775807L

	)

89 
	#LONG_MAX
 2147483647L

	)

91 
	#LONG_MIN
 (-
LONG_MAX
 - 1L)

	)

94 #ià
__WORDSIZE
 == 64

95 
	#ULONG_MAX
 18446744073709551615UL

	)

97 
	#ULONG_MAX
 4294967295UL

	)

100 #ifdeà
__USE_ISOC99


103 
	#LLONG_MAX
 9223372036854775807LL

	)

104 
	#LLONG_MIN
 (-
LLONG_MAX
 - 1LL)

	)

107 
	#ULLONG_MAX
 18446744073709551615ULL

	)

121 #ià
defšed
 
__GNUC__
 && !defšed 
_GCC_LIMITS_H_


123 #šşude_Ãxˆ<
lim™s
.
h
>

129 #ià
defšed
 
__USE_ISOC99
 && defšed 
__GNUC__


130 #iâdeà
LLONG_MIN


131 
	#LLONG_MIN
 (-
LLONG_MAX
-1)

	)

133 #iâdeà
LLONG_MAX


134 
	#LLONG_MAX
 
__LONG_LONG_MAX__


	)

136 #iâdeà
ULLONG_MAX


137 
	#ULLONG_MAX
 (
LLONG_MAX
 * 2ULL + 1)

	)

141 #ifdef 
__USE_POSIX


143 
	~<b™s/posix1_lim.h
>

146 #ifdef 
__USE_POSIX2


147 
	~<b™s/posix2_lim.h
>

150 #ifdef 
__USE_XOPEN


151 
	~<b™s/xİ’_lim.h
>

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 199947

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@/usr/include/locale.h

22 #iâdef 
_LOCALE_H


23 
	#_LOCALE_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	#__Ãed_NULL


	)

28 
	~<¡ddef.h
>

29 
	~<b™s/loÿË.h
>

31 
	g__BEGIN_DECLS


35 
	#LC_CTYPE
 
__LC_CTYPE


	)

36 
	#LC_NUMERIC
 
__LC_NUMERIC


	)

37 
	#LC_TIME
 
__LC_TIME


	)

38 
	#LC_COLLATE
 
__LC_COLLATE


	)

39 
	#LC_MONETARY
 
__LC_MONETARY


	)

40 
	#LC_MESSAGES
 
__LC_MESSAGES


	)

41 
	#LC_ALL
 
__LC_ALL


	)

42 
	#LC_PAPER
 
__LC_PAPER


	)

43 
	#LC_NAME
 
__LC_NAME


	)

44 
	#LC_ADDRESS
 
__LC_ADDRESS


	)

45 
	#LC_TELEPHONE
 
__LC_TELEPHONE


	)

46 
	#LC_MEASUREMENT
 
__LC_MEASUREMENT


	)

47 
	#LC_IDENTIFICATION
 
__LC_IDENTIFICATION


	)

50 
__BEGIN_NAMESPACE_STD


53 
	slcÚv


57 *
	mdecim®_pošt
;

58 *
	mthou§nds_£p
;

64 *
	mgroupšg
;

70 *
	mšt_cu¼_symbŞ
;

71 *
	mcu¼’cy_symbŞ
;

72 *
	mmÚ_decim®_pošt
;

73 *
	mmÚ_thou§nds_£p
;

74 *
	mmÚ_groupšg
;

75 *
	mpos™ive_sign
;

76 *
	mÃg©ive_sign
;

77 
	mšt_äac_dig™s
;

78 
	mäac_dig™s
;

80 
	mp_cs_´eûdes
;

82 
	mp_£p_by_¥aû
;

84 
	mn_cs_´eûdes
;

86 
	mn_£p_by_¥aû
;

93 
	mp_sign_po¢
;

94 
	mn_sign_po¢
;

95 #ifdeà
__USE_ISOC99


97 
	mšt_p_cs_´eûdes
;

99 
	mšt_p_£p_by_¥aû
;

101 
	mšt_n_cs_´eûdes
;

103 
	mšt_n_£p_by_¥aû
;

110 
	mšt_p_sign_po¢
;

111 
	mšt_n_sign_po¢
;

113 
	m__št_p_cs_´eûdes
;

114 
	m__št_p_£p_by_¥aû
;

115 
	m__št_n_cs_´eûdes
;

116 
	m__št_n_£p_by_¥aû
;

117 
	m__št_p_sign_po¢
;

118 
	m__št_n_sign_po¢
;

124 *
	$£oÿË
 (
__ÿ‹gÜy
, cÚ¡ *
__loÿË
è
__THROW
;

127 
lcÚv
 *
	$loÿËcÚv
 (è
__THROW
;

129 
__END_NAMESPACE_STD


132 #ifdef 
__USE_XOPEN2K8


145 
	~<xloÿË.h
>

151 
__loÿË_t
 
	$ÃwloÿË
 (
__ÿ‹gÜy_mask
, cÚ¡ *
__loÿË
,

152 
__loÿË_t
 
__ba£
è
__THROW
;

158 
	#LC_CTYPE_MASK
 (1 << 
__LC_CTYPE
)

	)

159 
	#LC_NUMERIC_MASK
 (1 << 
__LC_NUMERIC
)

	)

160 
	#LC_TIME_MASK
 (1 << 
__LC_TIME
)

	)

161 
	#LC_COLLATE_MASK
 (1 << 
__LC_COLLATE
)

	)

162 
	#LC_MONETARY_MASK
 (1 << 
__LC_MONETARY
)

	)

163 
	#LC_MESSAGES_MASK
 (1 << 
__LC_MESSAGES
)

	)

164 
	#LC_PAPER_MASK
 (1 << 
__LC_PAPER
)

	)

165 
	#LC_NAME_MASK
 (1 << 
__LC_NAME
)

	)

166 
	#LC_ADDRESS_MASK
 (1 << 
__LC_ADDRESS
)

	)

167 
	#LC_TELEPHONE_MASK
 (1 << 
__LC_TELEPHONE
)

	)

168 
	#LC_MEASUREMENT_MASK
 (1 << 
__LC_MEASUREMENT
)

	)

169 
	#LC_IDENTIFICATION_MASK
 (1 << 
__LC_IDENTIFICATION
)

	)

170 
	#LC_ALL_MASK
 (
LC_CTYPE_MASK
 \

171 | 
LC_NUMERIC_MASK
 \

172 | 
LC_TIME_MASK
 \

173 | 
LC_COLLATE_MASK
 \

174 | 
LC_MONETARY_MASK
 \

175 | 
LC_MESSAGES_MASK
 \

176 | 
LC_PAPER_MASK
 \

177 | 
LC_NAME_MASK
 \

178 | 
LC_ADDRESS_MASK
 \

179 | 
LC_TELEPHONE_MASK
 \

180 | 
LC_MEASUREMENT_MASK
 \

181 | 
LC_IDENTIFICATION_MASK
 \

182 )

	)

186 
__loÿË_t
 
	$du¶oÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

190 
	$ä“loÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

197 
__loÿË_t
 
	$u£loÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

201 
	#LC_GLOBAL_LOCALE
 ((
__loÿË_t
è-1L)

	)

205 
__END_DECLS


	@/usr/include/math.h

23 #iâdef 
_MATH_H


24 
	#_MATH_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


32 
	~<b™s/huge_v®.h
>

33 #ifdeà
__USE_ISOC99


34 
	~<b™s/huge_v®f.h
>

35 
	~<b™s/huge_v®l.h
>

38 
	~<b™s/šf.h
>

41 
	~<b™s/Çn.h
>

45 
	~<b™s/m©hdef.h
>

52 
	#__MATHCALL
(
funùiÚ
,
suffix
, 
¬gs
) \

53 
	`__MATHDECL
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
)

	)

54 
	#__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

55 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
); \

56 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
)

	)

57 
	#__MATHCALLX
(
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

58 
	`__MATHDECLX
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
)

	)

59 
	#__MATHDECLX
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

60 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
); \

61 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
)

	)

62 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

63 
ty³
 
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
è
¬gs
 
__THROW


	)

65 
	#_MdoubË_
 

	)

66 
	#__MATH_PRECNAME
(
Çme
,
r
è
	`__CONCAT
Òame,r)

	)

67 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_STD


	)

68 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_STD


	)

69 
	~<b™s/m©hÿÎs.h
>

70 #undeà
_MdoubË_


71 #undeà
_MdoubË_BEGIN_NAMESPACE


72 #undeà
_MdoubË_END_NAMESPACE


73 #undeà
__MATH_PRECNAME


75 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_ISOC99


81 #iâdeà
_Mæßt_


82 
	#_Mæßt_
 

	)

84 
	#_MdoubË_
 
_Mæßt_


	)

85 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f
##
	)
r

86 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

87 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

88 
	~<b™s/m©hÿÎs.h
>

89 #undeà
_MdoubË_


90 #undeà
_MdoubË_BEGIN_NAMESPACE


91 #undeà
_MdoubË_END_NAMESPACE


92 #undeà
__MATH_PRECNAME


94 #ià!(
defšed
 
__NO_LONG_DOUBLE_MATH
 && defšed 
_LIBC
) \

95 || 
defšed
 
__LDBL_COMPAT


96 #ifdeà
__LDBL_COMPAT


98 #ifdeà
__USE_ISOC99


99 
	$__Ædbl_Ãx‰ow¬df
 (
__x
, 
__y
)

100 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

101 #ifdeà
__REDIRECT_NTH


102 
	`__REDIRECT_NTH
 (
Ãx‰ow¬df
, (
__x
, 
__y
),

103 
__Ædbl_Ãx‰ow¬df
)

104 
	`__©Œibu‹__
 ((
__cÚ¡__
));

105 
	`__REDIRECT_NTH
 (
Ãx‰ow¬d
, (
__x
, 
__y
),

106 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

107 
	`__REDIRECT_NTH
 (
Ãx‰ow¬dl
,

108 (
__x
, 
__y
),

109 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

113 #undeà
__MATHDECL_1


114 
	#__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
®Ÿs
) \

115 
ty³
 
	`__REDIRECT_NTH
(
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
), \

116 
¬gs
, 
®Ÿs
)

	)

117 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

118 
	`__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
	`__CONCAT
(funùiÚ,suffix))

	)

124 #iâdeà
_MlÚg_doubË_


125 
	#_MlÚg_doubË_
 

	)

127 
	#_MdoubË_
 
_MlÚg_doubË_


	)

128 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
l
##
	)
r

129 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

130 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

131 
	#__MATH_DECLARE_LDOUBLE
 1

	)

132 
	~<b™s/m©hÿÎs.h
>

133 #undeà
_MdoubË_


134 #undeà
_MdoubË_BEGIN_NAMESPACE


135 #undeà
_MdoubË_END_NAMESPACE


136 #undeà
__MATH_PRECNAME


141 #undeà
__MATHDECL_1


142 #undeà
__MATHDECL


143 #undeà
__MATHCALL


146 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


148 
signgam
;

153 #ifdeà
__USE_ISOC99


191 
FP_NAN
 =

192 
	#FP_NAN
 0

	)

193 
FP_NAN
,

194 
FP_INFINITE
 =

195 
	#FP_INFINITE
 1

	)

196 
FP_INFINITE
,

197 
FP_ZERO
 =

198 
	#FP_ZERO
 2

	)

199 
FP_ZERO
,

200 
FP_SUBNORMAL
 =

201 
	#FP_SUBNORMAL
 3

	)

202 
FP_SUBNORMAL
,

203 
FP_NORMAL
 =

204 
	#FP_NORMAL
 4

	)

205 
FP_NORMAL


209 #ifdeà
__NO_LONG_DOUBLE_MATH


210 
	#åşassify
(
x
) \

211 ( (
x
è=ğ (è? 
	`__åşassifyf
 (xè: 
	`__åşassify
 (x))

	)

213 
	#åşassify
(
x
) \

214 ( (
x
) ==  () \

215 ? 
	`__åşassifyf
 (
x
) \

216 :  (
x
) ==  () \

217 ? 
	`__åşassify
 (
x
è: 
	`__åşassifyl
 (x))

	)

221 #ifdeà
__NO_LONG_DOUBLE_MATH


222 
	#signb™
(
x
) \

223 ( (
x
è=ğ (è? 
	`__signb™f
 (xè: 
	`__signb™
 (x))

	)

225 
	#signb™
(
x
) \

226 ( (
x
) ==  () \

227 ? 
	`__signb™f
 (
x
) \

228 :  (
x
) ==  () \

229 ? 
	`__signb™
 (
x
è: 
	`__signb™l
 (x))

	)

233 #ifdeà
__NO_LONG_DOUBLE_MATH


234 
	#isfš™e
(
x
) \

235 ( (
x
è=ğ (è? 
	`__fš™ef
 (xè: 
	`__fš™e
 (x))

	)

237 
	#isfš™e
(
x
) \

238 ( (
x
) ==  () \

239 ? 
	`__fš™ef
 (
x
) \

240 :  (
x
) ==  () \

241 ? 
	`__fš™e
 (
x
è: 
	`__fš™–
 (x))

	)

245 
	#i¢Üm®
(
x
è(
	`åşassify
 (xè=ğ
FP_NORMAL
)

	)

249 #ifdeà
__NO_LONG_DOUBLE_MATH


250 
	#i¢ª
(
x
) \

251 ( (
x
è=ğ (è? 
	`__i¢ªf
 (xè: 
	`__i¢ª
 (x))

	)

253 
	#i¢ª
(
x
) \

254 ( (
x
) ==  () \

255 ? 
	`__i¢ªf
 (
x
) \

256 :  (
x
) ==  () \

257 ? 
	`__i¢ª
 (
x
è: 
	`__i¢ªl
 (x))

	)

261 #ifdeà
__NO_LONG_DOUBLE_MATH


262 
	#isšf
(
x
) \

263 ( (
x
è=ğ (è? 
	`__isšff
 (xè: 
	`__isšf
 (x))

	)

265 
	#isšf
(
x
) \

266 ( (
x
) ==  () \

267 ? 
	`__isšff
 (
x
) \

268 :  (
x
) ==  () \

269 ? 
	`__isšf
 (
x
è: 
	`__isšæ
 (x))

	)

273 
	#MATH_ERRNO
 1

	)

274 
	#MATH_ERREXCEPT
 2

	)

279 #iâdeà
__FAST_MATH__


280 
	#m©h_”rhªdlšg
 (
MATH_ERRNO
 | 
MATH_ERREXCEPT
)

	)

285 #ifdeà
__USE_GNU


287 #ifdeà
__NO_LONG_DOUBLE_MATH


288 
	#issigÇlšg
(
x
) \

289 ( (
x
è=ğ (è? 
	`__issigÇlšgf
 (xè: 
	`__issigÇlšg
 (x))

	)

291 
	#issigÇlšg
(
x
) \

292 ( (
x
) ==  () \

293 ? 
	`__issigÇlšgf
 (
x
) \

294 :  (
x
) ==  () \

295 ? 
	`__issigÇlšg
 (
x
è: 
	`__issigÇlšgl
 (x))

	)

299 #ifdef 
__USE_MISC


303 
_IEEE_
 = -1,

304 
_SVID_
,

305 
_XOPEN_
,

306 
_POSIX_
,

307 
_ISOC_


308 } 
	t_LIB_VERSION_TYPE
;

313 
_LIB_VERSION_TYPE
 
_LIB_VERSION
;

317 #ifdeà
__USE_SVID


323 #ifdeà
__ılu¥lus


324 
__exû±iÚ


326 
exû±iÚ


329 
ty³
;

330 *
Çme
;

331 
¬g1
;

332 
¬g2
;

333 
»tv®
;

334 
	}
};

336 #ifdeà
__ılu¥lus


337 
	$m©h”r
 (
__exû±iÚ
 *
__exc
è
	`throw
 ();

339 
	`m©h”r
 (
exû±iÚ
 *
__exc
);

342 
	#X_TLOSS
 1.41484755040568800000e+16

	)

345 
	#DOMAIN
 1

	)

346 
	#SING
 2

	)

347 
	#OVERFLOW
 3

	)

348 
	#UNDERFLOW
 4

	)

349 
	#TLOSS
 5

	)

350 
	#PLOSS
 6

	)

353 
	#HUGE
 3.40282347e+38F

	)

357 #ifdeà
__USE_XOPEN


359 
	#MAXFLOAT
 3.40282347e+38F

	)

366 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN


367 
	#M_E
 2.7182818284590452354

	)

368 
	#M_LOG2E
 1.4426950408889634074

	)

369 
	#M_LOG10E
 0.43429448190325182765

	)

370 
	#M_LN2
 0.69314718055994530942

	)

371 
	#M_LN10
 2.30258509299404568402

	)

372 
	#M_PI
 3.14159265358979323846

	)

373 
	#M_PI_2
 1.57079632679489661923

	)

374 
	#M_PI_4
 0.78539816339744830962

	)

375 
	#M_1_PI
 0.31830988618379067154

	)

376 
	#M_2_PI
 0.63661977236758134308

	)

377 
	#M_2_SQRTPI
 1.12837916709551257390

	)

378 
	#M_SQRT2
 1.41421356237309504880

	)

379 
	#M_SQRT1_2
 0.70710678118654752440

	)

385 #ifdeà
__USE_GNU


386 
	#M_El
 2.718281828459045235360287471352662498L

	)

387 
	#M_LOG2El
 1.442695040888963407359924681001892137L

	)

388 
	#M_LOG10El
 0.434294481903251827651128918916605082L

	)

389 
	#M_LN2l
 0.693147180559945309417232121458176568L

	)

390 
	#M_LN10l
 2.302585092994045684017991454684364208L

	)

391 
	#M_PIl
 3.141592653589793238462643383279502884L

	)

392 
	#M_PI_2l
 1.570796326794896619231321691639751442L

	)

393 
	#M_PI_4l
 0.785398163397448309615660845819875721L

	)

394 
	#M_1_PIl
 0.318309886183790671537767526745028724L

	)

395 
	#M_2_PIl
 0.636619772367581343075535053490057448L

	)

396 
	#M_2_SQRTPIl
 1.128379167095512573896158903121545172L

	)

397 
	#M_SQRT2l
 1.414213562373095048801688724209698079L

	)

398 
	#M_SQRT1_2l
 0.707106781186547524400844362104849039L

	)

405 #ià
defšed
 
__STRICT_ANSI__
 && !defšed 
__NO_MATH_INLINES


406 
	#__NO_MATH_INLINES
 1

	)

409 #ià
defšed
 
__USE_ISOC99
 && 
	`__GNUC_PREREQ
(2,97)

416 
	#isg»©”
(
x
, 
y
è
	`__butš_isg»©”
(x, y)

	)

417 
	#isg»©”equ®
(
x
, 
y
è
	`__butš_isg»©”equ®
(x, y)

	)

418 
	#i¦ess
(
x
, 
y
è
	`__butš_i¦ess
(x, y)

	)

419 
	#i¦es£qu®
(
x
, 
y
è
	`__butš_i¦es£qu®
(x, y)

	)

420 
	#i¦essg»©”
(
x
, 
y
è
	`__butš_i¦essg»©”
(x, y)

	)

421 
	#isunÜd”ed
(
u
, 
v
è
	`__butš_isunÜd”ed
(u, v)

	)

425 #ifdeà
__USE_EXTERN_INLINES


426 
	~<b™s/m©hšlše.h
>

431 #ià
defšed
 
__FINITE_MATH_ONLY__
 && __FINITE_MATH_ONLY__ > 0

432 
	~<b™s/m©h-fš™e.h
>

435 #ifdeà
__USE_ISOC99


439 #iâdeà
isg»©”


440 
	#isg»©”
(
x
, 
y
) \

441 (
__ex‹nsiÚ__
 \

442 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

443 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x > __y; 
	}
}))

	)

447 #iâdeà
isg»©”equ®


448 
	#isg»©”equ®
(
x
, 
y
) \

449 (
__ex‹nsiÚ__
 \

450 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

451 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x >ğ__y; }))

	)

455 #iâdeà
i¦ess


456 
	#i¦ess
(
x
, 
y
) \

457 (
__ex‹nsiÚ__
 \

458 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

459 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x < __y; }))

	)

463 #iâdeà
i¦es£qu®


464 
	#i¦es£qu®
(
x
, 
y
) \

465 (
__ex‹nsiÚ__
 \

466 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

467 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x <ğ__y; }))

	)

471 #iâdeà
i¦essg»©”


472 
	#i¦essg»©”
(
x
, 
y
) \

473 (
__ex‹nsiÚ__
 \

474 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

475 !
	`isunÜd”ed
 (
__x
, 
__y
è&& (__x < __y || __y < __x); }))

	)

479 #iâdeà
isunÜd”ed


480 
	#isunÜd”ed
(
u
, 
v
) \

481 (
__ex‹nsiÚ__
 \

482 ({ 
	`__ty³of__
(
u
è
__u
 = (u); __ty³of__(
v
è
__v
 = (v); \

483 
	`åşassify
 (
__u
è=ğ
FP_NAN
 || fpşassify (
__v
è=ğFP_NAN; }))

	)

488 
	g__END_DECLS


	@/usr/include/netdb.h

22 #iâdef 
_NETDB_H


23 
	#_NETDB_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<Ãtš‘/š.h
>

28 
	~<¡dšt.h
>

29 #ifdeà
__USE_MISC


32 
	~<½c/Ãtdb.h
>

35 #ifdeà
__USE_GNU


36 
	#__Ãed_sigev’t_t


	)

37 
	~<b™s/sigšfo.h
>

38 
	#__Ãed_time¥ec


	)

39 
	~<time.h
>

42 
	~<b™s/Ãtdb.h
>

45 
	#_PATH_HEQUIV
 "/‘c/ho¡s.equiv"

	)

46 
	#_PATH_HOSTS
 "/‘c/ho¡s"

	)

47 
	#_PATH_NETWORKS
 "/‘c/ÃtwÜks"

	)

48 
	#_PATH_NSSWITCH_CONF
 "/‘c/nssw™ch.cÚf"

	)

49 
	#_PATH_PROTOCOLS
 "/‘c/´ÙocŞs"

	)

50 
	#_PATH_SERVICES
 "/‘c/£rviûs"

	)

53 
	g__BEGIN_DECLS


55 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


58 
	#h_”ºo
 (*
	`__h_”ºo_loÿtiÚ
 ())

	)

61 *
	$__h_”ºo_loÿtiÚ
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

65 
	#HOST_NOT_FOUND
 1

	)

66 
	#TRY_AGAIN
 2

	)

68 
	#NO_RECOVERY
 3

	)

70 
	#NO_DATA
 4

	)

73 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


74 
	#NETDB_INTERNAL
 -1

	)

75 
	#NETDB_SUCCESS
 0

	)

76 
	#NO_ADDRESS
 
NO_DATA


	)

79 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_XOPEN_EXTENDED


81 
	#IPPORT_RESERVED
 1024

	)

84 #ifdeà
__USE_GNU


86 
	#SCOPE_DELIMITER
 '%'

	)

89 #ifdeà
__USE_MISC


92 
	$h”rÜ
 (cÚ¡ *
__¡r
è
__THROW
;

95 cÚ¡ *
	$h¡»¼Ü
 (
__”r_num
è
__THROW
;

100 
	sho¡’t


102 *
h_Çme
;

103 **
h_®Ÿ£s
;

104 
h_add¹y³
;

105 
h_Ëngth
;

106 **
h_addr_li¡
;

107 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


108 
	#h_addr
 
h_addr_li¡
[0]

	)

117 
	`£tho¡’t
 (
__¡ay_İ’
);

123 
	`’dho¡’t
 ();

130 
ho¡’t
 *
	`g‘ho¡’t
 ();

137 
ho¡’t
 *
	`g‘ho¡byaddr
 (cÚ¡ *
__addr
, 
__sockËn_t
 
__Ën
,

138 
__ty³
);

144 
ho¡’t
 *
	`g‘ho¡byÇme
 (cÚ¡ *
__Çme
);

146 #ifdeà
__USE_MISC


155 
ho¡’t
 *
	`g‘ho¡byÇme2
 (cÚ¡ *
__Çme
, 
__af
);

167 
	`g‘ho¡’t_r
 (
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

168 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

169 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

170 *
__»¡riù
 
__h_”ºİ
);

172 
	`g‘ho¡byaddr_r
 (cÚ¡ *
__»¡riù
 
__addr
, 
__sockËn_t
 
__Ën
,

173 
__ty³
,

174 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

175 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

176 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

177 *
__»¡riù
 
__h_”ºİ
);

179 
	`g‘ho¡byÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

180 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

181 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

182 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

183 *
__»¡riù
 
__h_”ºİ
);

185 
	`g‘ho¡byÇme2_r
 (cÚ¡ *
__»¡riù
 
__Çme
, 
__af
,

186 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

187 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

188 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

189 *
__»¡riù
 
__h_”ºİ
);

198 
	`£Š‘’t
 (
__¡ay_İ’
);

204 
	`’dÃ‹Á
 ();

211 
Ã‹Á
 *
	`g‘Ã‹Á
 ();

218 
Ã‹Á
 *
	`g‘Ãtbyaddr
 (
ušt32_t
 
__Ãt
, 
__ty³
);

224 
Ã‹Á
 *
	`g‘ÃtbyÇme
 (cÚ¡ *
__Çme
);

226 #ifdef 
__USE_MISC


237 
	`g‘Ã‹Á_r
 (
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

238 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

239 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

240 *
__»¡riù
 
__h_”ºİ
);

242 
	`g‘Ãtbyaddr_r
 (
ušt32_t
 
__Ãt
, 
__ty³
,

243 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

244 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

245 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

246 *
__»¡riù
 
__h_”ºİ
);

248 
	`g‘ÃtbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

249 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

250 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

251 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

252 *
__»¡riù
 
__h_”ºİ
);

257 
	s£rv’t


259 *
s_Çme
;

260 **
s_®Ÿ£s
;

261 
s_pÜt
;

262 *
s_´Ùo
;

270 
	`£t£rv’t
 (
__¡ay_İ’
);

276 
	`’d£rv’t
 ();

283 
£rv’t
 *
	`g‘£rv’t
 ();

290 
£rv’t
 *
	`g‘£rvbyÇme
 (cÚ¡ *
__Çme
, cÚ¡ *
__´Ùo
);

297 
£rv’t
 *
	`g‘£rvbypÜt
 (
__pÜt
, cÚ¡ *
__´Ùo
);

300 #ifdef 
__USE_MISC


308 
	`g‘£rv’t_r
 (
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

309 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

310 
£rv’t
 **
__»¡riù
 
__»suÉ
);

312 
	`g‘£rvbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

313 cÚ¡ *
__»¡riù
 
__´Ùo
,

314 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

315 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

316 
£rv’t
 **
__»¡riù
 
__»suÉ
);

318 
	`g‘£rvbypÜt_r
 (
__pÜt
, cÚ¡ *
__»¡riù
 
__´Ùo
,

319 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

320 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

321 
£rv’t
 **
__»¡riù
 
__»suÉ
);

326 
	s´ÙÛÁ


328 *
p_Çme
;

329 **
p_®Ÿ£s
;

330 
p_´Ùo
;

338 
	`£rÙÛÁ
 (
__¡ay_İ’
);

344 
	`’d´ÙÛÁ
 ();

351 
´ÙÛÁ
 *
	`g‘´ÙÛÁ
 ();

357 
´ÙÛÁ
 *
	`g‘´ÙobyÇme
 (cÚ¡ *
__Çme
);

363 
´ÙÛÁ
 *
	`g‘´Ùobynumb”
 (
__´Ùo
);

366 #ifdef 
__USE_MISC


374 
	`g‘´ÙÛÁ_r
 (
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

375 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

376 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

378 
	`g‘´ÙobyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

379 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

380 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

381 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

383 
	`g‘´Ùobynumb”_r
 (
__´Ùo
,

384 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

385 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

386 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

395 
	`£Š‘g»Á
 (cÚ¡ *
__Ãtgroup
);

403 
	`’dÃtg»Á
 ();

412 
	`g‘Ãtg»Á
 (**
__»¡riù
 
__ho¡p
,

413 **
__»¡riù
 
__u£½
,

414 **
__»¡riù
 
__domašp
);

423 
	`šÃtgr
 (cÚ¡ *
__Ãtgroup
, cÚ¡ *
__ho¡
,

424 cÚ¡ *
__u£r
, cÚ¡ *
__domaš
);

432 
	`g‘Ãtg»Á_r
 (**
__»¡riù
 
__ho¡p
,

433 **
__»¡riù
 
__u£½
,

434 **
__»¡riù
 
__domašp
,

435 *
__»¡riù
 
__bufãr
, 
size_t
 
__buæ’
);

439 #ifdeà
__USE_BSD


451 
	`rcmd
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

452 cÚ¡ *
__»¡riù
 
__locu£r
,

453 cÚ¡ *
__»¡riù
 
__»mu£r
,

454 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

463 
	`rcmd_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

464 cÚ¡ *
__»¡riù
 
__locu£r
,

465 cÚ¡ *
__»¡riù
 
__»mu£r
,

466 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

467 
§_çmy_t
 
__af
);

479 
	`»xec
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

480 cÚ¡ *
__»¡riù
 
__Çme
,

481 cÚ¡ *
__»¡riù
 
__·ss
,

482 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

491 
	`»xec_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

492 cÚ¡ *
__»¡riù
 
__Çme
,

493 cÚ¡ *
__»¡riù
 
__·ss
,

494 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

495 
§_çmy_t
 
__af
);

505 
	`ru£rok
 (cÚ¡ *
__rho¡
, 
__su£r
,

506 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

515 
	`ru£rok_af
 (cÚ¡ *
__rho¡
, 
__su£r
,

516 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

517 
§_çmy_t
 
__af
);

528 
	`œu£rok
 (
ušt32_t
 
__¿ddr
, 
__su£r
,

529 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

539 
	`œu£rok_af
 (cÚ¡ *
__¿ddr
, 
__su£r
,

540 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

541 
§_çmy_t
 
__af
);

551 
	`¼esvpÜt
 (*
__®pÜt
);

560 
	`¼esvpÜt_af
 (*
__®pÜt
, 
§_çmy_t
 
__af
);

565 #ifdef 
__USE_POSIX


567 
	saddršfo


569 
ai_æags
;

570 
ai_çmy
;

571 
ai_sockty³
;

572 
ai_´ÙocŞ
;

573 
sockËn_t
 
ai_add¾’
;

574 
sockaddr
 *
ai_addr
;

575 *
ai_ÿnÚÇme
;

576 
addršfo
 *
ai_Ãxt
;

579 #ifdeà
__USE_GNU


581 
	sgaicb


583 cÚ¡ *
¬_Çme
;

584 cÚ¡ *
¬_£rviû
;

585 cÚ¡ 
addršfo
 *
¬_»que¡
;

586 
addršfo
 *
¬_»suÉ
;

588 
__»tuº
;

589 
__glibc_»£rved
[5];

593 
	#GAI_WAIT
 0

	)

594 
	#GAI_NOWAIT
 1

	)

598 
	#AI_PASSIVE
 0x0001

	)

599 
	#AI_CANONNAME
 0x0002

	)

600 
	#AI_NUMERICHOST
 0x0004

	)

601 
	#AI_V4MAPPED
 0x0008

	)

602 
	#AI_ALL
 0x0010

	)

603 
	#AI_ADDRCONFIG
 0x0020

	)

605 #ifdeà
__USE_GNU


606 
	#AI_IDN
 0x0040

	)

609 
	#AI_CANONIDN
 0x0080

	)

610 
	#AI_IDN_ALLOW_UNASSIGNED
 0x0100

	)

612 
	#AI_IDN_USE_STD3_ASCII_RULES
 0x0200

	)

615 
	#AI_NUMERICSERV
 0x0400

	)

618 
	#EAI_BADFLAGS
 -1

	)

619 
	#EAI_NONAME
 -2

	)

620 
	#EAI_AGAIN
 -3

	)

621 
	#EAI_FAIL
 -4

	)

622 
	#EAI_FAMILY
 -6

	)

623 
	#EAI_SOCKTYPE
 -7

	)

624 
	#EAI_SERVICE
 -8

	)

625 
	#EAI_MEMORY
 -10

	)

626 
	#EAI_SYSTEM
 -11

	)

627 
	#EAI_OVERFLOW
 -12

	)

628 #ifdeà
__USE_GNU


629 
	#EAI_NODATA
 -5

	)

630 
	#EAI_ADDRFAMILY
 -9

	)

631 
	#EAI_INPROGRESS
 -100

	)

632 
	#EAI_CANCELED
 -101

	)

633 
	#EAI_NOTCANCELED
 -102

	)

634 
	#EAI_ALLDONE
 -103

	)

635 
	#EAI_INTR
 -104

	)

636 
	#EAI_IDN_ENCODE
 -105

	)

639 #ifdeà
__USE_MISC


640 
	#NI_MAXHOST
 1025

	)

641 
	#NI_MAXSERV
 32

	)

644 
	#NI_NUMERICHOST
 1

	)

645 
	#NI_NUMERICSERV
 2

	)

646 
	#NI_NOFQDN
 4

	)

647 
	#NI_NAMEREQD
 8

	)

648 
	#NI_DGRAM
 16

	)

649 #ifdeà
__USE_GNU


650 
	#NI_IDN
 32

	)

651 
	#NI_IDN_ALLOW_UNASSIGNED
 64

	)

653 
	#NI_IDN_USE_STD3_ASCII_RULES
 128

	)

662 
	`g‘addršfo
 (cÚ¡ *
__»¡riù
 
__Çme
,

663 cÚ¡ *
__»¡riù
 
__£rviû
,

664 cÚ¡ 
addršfo
 *
__»¡riù
 
__»q
,

665 
addršfo
 **
__»¡riù
 
__·i
);

668 
	$ä“addršfo
 (
addršfo
 *
__ai
è
__THROW
;

671 cÚ¡ *
	$gai_¡»¼Ü
 (
__ecode
è
__THROW
;

677 
	`g‘Çmešfo
 (cÚ¡ 
sockaddr
 *
__»¡riù
 
__§
,

678 
sockËn_t
 
__§Ën
, *
__»¡riù
 
__ho¡
,

679 
sockËn_t
 
__ho¡Ën
, *
__»¡riù
 
__£rv
,

680 
sockËn_t
 
__£rvËn
, 
__æags
);

683 #ifdeà
__USE_GNU


692 
	`g‘addršfo_a
 (
__mode
, 
gaicb
 *
__li¡
[
__»¡riù_¬r
],

693 
__’t
, 
sigev’t
 *
__»¡riù
 
__sig
);

703 
	`gai_su¥’d
 (cÚ¡ 
gaicb
 *cÚ¡ 
__li¡
[], 
__’t
,

704 cÚ¡ 
time¥ec
 *
__timeout
);

707 
	$gai_”rÜ
 (
gaicb
 *
__»q
è
__THROW
;

710 
	$gai_ÿnûl
 (
gaicb
 *
__gaicbp
è
__THROW
;

713 
__END_DECLS


	@/usr/include/netinet/in.h

18 #iâdef 
_NETINET_IN_H


19 
	#_NETINET_IN_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<¡dšt.h
>

23 
	~<sys/sock‘.h
>

24 
	~<b™s/ty³s.h
>

27 
__BEGIN_DECLS


30 
ušt32_t
 
	tš_addr_t
;

31 
	sš_addr


33 
š_addr_t
 
	ms_addr
;

37 
	~<b™s/š.h
>

42 
	mIPPROTO_IP
 = 0,

43 
	#IPPROTO_IP
 
IPPROTO_IP


	)

44 
	mIPPROTO_ICMP
 = 1,

45 
	#IPPROTO_ICMP
 
IPPROTO_ICMP


	)

46 
	mIPPROTO_IGMP
 = 2,

47 
	#IPPROTO_IGMP
 
IPPROTO_IGMP


	)

48 
	mIPPROTO_IPIP
 = 4,

49 
	#IPPROTO_IPIP
 
IPPROTO_IPIP


	)

50 
	mIPPROTO_TCP
 = 6,

51 
	#IPPROTO_TCP
 
IPPROTO_TCP


	)

52 
	mIPPROTO_EGP
 = 8,

53 
	#IPPROTO_EGP
 
IPPROTO_EGP


	)

54 
	mIPPROTO_PUP
 = 12,

55 
	#IPPROTO_PUP
 
IPPROTO_PUP


	)

56 
	mIPPROTO_UDP
 = 17,

57 
	#IPPROTO_UDP
 
IPPROTO_UDP


	)

58 
	mIPPROTO_IDP
 = 22,

59 
	#IPPROTO_IDP
 
IPPROTO_IDP


	)

60 
	mIPPROTO_TP
 = 29,

61 
	#IPPROTO_TP
 
IPPROTO_TP


	)

62 
	mIPPROTO_DCCP
 = 33,

63 
	#IPPROTO_DCCP
 
IPPROTO_DCCP


	)

64 
	mIPPROTO_IPV6
 = 41,

65 
	#IPPROTO_IPV6
 
IPPROTO_IPV6


	)

66 
	mIPPROTO_RSVP
 = 46,

67 
	#IPPROTO_RSVP
 
IPPROTO_RSVP


	)

68 
	mIPPROTO_GRE
 = 47,

69 
	#IPPROTO_GRE
 
IPPROTO_GRE


	)

70 
	mIPPROTO_ESP
 = 50,

71 
	#IPPROTO_ESP
 
IPPROTO_ESP


	)

72 
	mIPPROTO_AH
 = 51,

73 
	#IPPROTO_AH
 
IPPROTO_AH


	)

74 
	mIPPROTO_MTP
 = 92,

75 
	#IPPROTO_MTP
 
IPPROTO_MTP


	)

76 
	mIPPROTO_BEETPH
 = 94,

77 
	#IPPROTO_BEETPH
 
IPPROTO_BEETPH


	)

78 
	mIPPROTO_ENCAP
 = 98,

79 
	#IPPROTO_ENCAP
 
IPPROTO_ENCAP


	)

80 
	mIPPROTO_PIM
 = 103,

81 
	#IPPROTO_PIM
 
IPPROTO_PIM


	)

82 
	mIPPROTO_COMP
 = 108,

83 
	#IPPROTO_COMP
 
IPPROTO_COMP


	)

84 
	mIPPROTO_SCTP
 = 132,

85 
	#IPPROTO_SCTP
 
IPPROTO_SCTP


	)

86 
	mIPPROTO_UDPLITE
 = 136,

87 
	#IPPROTO_UDPLITE
 
IPPROTO_UDPLITE


	)

88 
	mIPPROTO_RAW
 = 255,

89 
	#IPPROTO_RAW
 
IPPROTO_RAW


	)

90 
	mIPPROTO_MAX


96 #iâdeà
__USE_KERNEL_IPV6_DEFS


99 
	mIPPROTO_HOPOPTS
 = 0,

100 
	#IPPROTO_HOPOPTS
 
IPPROTO_HOPOPTS


	)

101 
	mIPPROTO_ROUTING
 = 43,

102 
	#IPPROTO_ROUTING
 
IPPROTO_ROUTING


	)

103 
	mIPPROTO_FRAGMENT
 = 44,

104 
	#IPPROTO_FRAGMENT
 
IPPROTO_FRAGMENT


	)

105 
	mIPPROTO_ICMPV6
 = 58,

106 
	#IPPROTO_ICMPV6
 
IPPROTO_ICMPV6


	)

107 
	mIPPROTO_NONE
 = 59,

108 
	#IPPROTO_NONE
 
IPPROTO_NONE


	)

109 
	mIPPROTO_DSTOPTS
 = 60,

110 
	#IPPROTO_DSTOPTS
 
IPPROTO_DSTOPTS


	)

111 
	mIPPROTO_MH
 = 135

112 
	#IPPROTO_MH
 
IPPROTO_MH


	)

117 
ušt16_t
 
	tš_pÜt_t
;

122 
	mIPPORT_ECHO
 = 7,

123 
	mIPPORT_DISCARD
 = 9,

124 
	mIPPORT_SYSTAT
 = 11,

125 
	mIPPORT_DAYTIME
 = 13,

126 
	mIPPORT_NETSTAT
 = 15,

127 
	mIPPORT_FTP
 = 21,

128 
	mIPPORT_TELNET
 = 23,

129 
	mIPPORT_SMTP
 = 25,

130 
	mIPPORT_TIMESERVER
 = 37,

131 
	mIPPORT_NAMESERVER
 = 42,

132 
	mIPPORT_WHOIS
 = 43,

133 
	mIPPORT_MTP
 = 57,

135 
	mIPPORT_TFTP
 = 69,

136 
	mIPPORT_RJE
 = 77,

137 
	mIPPORT_FINGER
 = 79,

138 
	mIPPORT_TTYLINK
 = 87,

139 
	mIPPORT_SUPDUP
 = 95,

142 
	mIPPORT_EXECSERVER
 = 512,

143 
	mIPPORT_LOGINSERVER
 = 513,

144 
	mIPPORT_CMDSERVER
 = 514,

145 
	mIPPORT_EFSSERVER
 = 520,

148 
	mIPPORT_BIFFUDP
 = 512,

149 
	mIPPORT_WHOSERVER
 = 513,

150 
	mIPPORT_ROUTESERVER
 = 520,

153 
	mIPPORT_RESERVED
 = 1024,

156 
	mIPPORT_USERRESERVED
 = 5000

164 
	#IN_CLASSA
(
a
è((((
š_addr_t
)×)è& 0x80000000è=ğ0)

	)

165 
	#IN_CLASSA_NET
 0xff000000

	)

166 
	#IN_CLASSA_NSHIFT
 24

	)

167 
	#IN_CLASSA_HOST
 (0xfffffffà& ~
IN_CLASSA_NET
)

	)

168 
	#IN_CLASSA_MAX
 128

	)

170 
	#IN_CLASSB
(
a
è((((
š_addr_t
)×)è& 0xc0000000è=ğ0x80000000)

	)

171 
	#IN_CLASSB_NET
 0xffff0000

	)

172 
	#IN_CLASSB_NSHIFT
 16

	)

173 
	#IN_CLASSB_HOST
 (0xfffffffà& ~
IN_CLASSB_NET
)

	)

174 
	#IN_CLASSB_MAX
 65536

	)

176 
	#IN_CLASSC
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xc0000000)

	)

177 
	#IN_CLASSC_NET
 0xffffff00

	)

178 
	#IN_CLASSC_NSHIFT
 8

	)

179 
	#IN_CLASSC_HOST
 (0xfffffffà& ~
IN_CLASSC_NET
)

	)

181 
	#IN_CLASSD
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xe0000000)

	)

182 
	#IN_MULTICAST
(
a
è
	`IN_CLASSD
×)

	)

184 
	#IN_EXPERIMENTAL
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xe0000000)

	)

185 
	#IN_BADCLASS
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xf0000000)

	)

188 
	#INADDR_ANY
 ((
š_addr_t
è0x00000000)

	)

190 
	#INADDR_BROADCAST
 ((
š_addr_t
è0xffffffff)

	)

192 
	#INADDR_NONE
 ((
š_addr_t
è0xffffffff)

	)

195 
	#IN_LOOPBACKNET
 127

	)

197 #iâdeà
INADDR_LOOPBACK


198 
	#INADDR_LOOPBACK
 ((
š_addr_t
è0x7f000001è

	)

202 
	#INADDR_UNSPEC_GROUP
 ((
š_addr_t
è0xe0000000è

	)

203 
	#INADDR_ALLHOSTS_GROUP
 ((
š_addr_t
è0xe0000001è

	)

204 
	#INADDR_ALLRTRS_GROUP
 ((
š_addr_t
è0xe0000002è

	)

205 
	#INADDR_MAX_LOCAL_GROUP
 ((
š_addr_t
è0xe00000ffè

	)

207 #iâdeà
__USE_KERNEL_IPV6_DEFS


209 
	sš6_addr


213 
ušt8_t
 
	m__u6_addr8
[16];

214 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


215 
ušt16_t
 
	m__u6_addr16
[8];

216 
ušt32_t
 
	m__u6_addr32
[4];

218 } 
	m__š6_u
;

219 
	#s6_addr
 
__š6_u
.
__u6_addr8


	)

220 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


221 
	#s6_addr16
 
__š6_u
.
__u6_addr16


	)

222 
	#s6_addr32
 
__š6_u
.
__u6_addr32


	)

227 cÚ¡ 
š6_addr
 
š6addr_ªy
;

228 cÚ¡ 
š6_addr
 
š6addr_loİback
;

229 
	#IN6ADDR_ANY_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 } } }

	)

230 
	#IN6ADDR_LOOPBACK_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 } } }

	)

232 
	#INET_ADDRSTRLEN
 16

	)

233 
	#INET6_ADDRSTRLEN
 46

	)

237 
	ssockaddr_š


239 
__SOCKADDR_COMMON
 (
sš_
);

240 
š_pÜt_t
 
	msš_pÜt
;

241 
š_addr
 
	msš_addr
;

244 
	msš_z”o
[ (
sockaddr
) -

245 
__SOCKADDR_COMMON_SIZE
 -

246  (
š_pÜt_t
) -

247  (
š_addr
)];

250 #iâdeà
__USE_KERNEL_IPV6_DEFS


252 
	ssockaddr_š6


254 
__SOCKADDR_COMMON
 (
sš6_
);

255 
š_pÜt_t
 
	msš6_pÜt
;

256 
ušt32_t
 
	msš6_æowšfo
;

257 
š6_addr
 
	msš6_addr
;

258 
ušt32_t
 
	msš6_scİe_id
;

262 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


264 
	s_m»q


267 
š_addr
 
	mimr_muÉŸddr
;

270 
š_addr
 
	mimr_š‹rçû
;

273 
	s_m»q_sourû


276 
š_addr
 
	mimr_muÉŸddr
;

279 
š_addr
 
	mimr_š‹rçû
;

282 
š_addr
 
	mimr_sourûaddr
;

286 #iâdeà
__USE_KERNEL_IPV6_DEFS


288 
	sv6_m»q


291 
š6_addr
 
	mv6mr_muÉŸddr
;

294 
	mv6mr_š‹rçû
;

298 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


300 
	sgroup_»q


303 
ušt32_t
 
	mgr_š‹rçû
;

306 
sockaddr_¡Üage
 
	mgr_group
;

309 
	sgroup_sourû_»q


312 
ušt32_t
 
	mg¤_š‹rçû
;

315 
sockaddr_¡Üage
 
	mg¤_group
;

318 
sockaddr_¡Üage
 
	mg¤_sourû
;

323 
	s_msf‹r


326 
š_addr
 
	mimsf_muÉŸddr
;

329 
š_addr
 
	mimsf_š‹rçû
;

332 
ušt32_t
 
	mimsf_fmode
;

335 
ušt32_t
 
	mimsf_num¤c
;

337 
š_addr
 
	mimsf_¦i¡
[1];

340 
	#IP_MSFILTER_SIZE
(
num¤c
è( (
_msf‹r
) \

341 -  (
š_addr
) \

342 + (
num¤c
è*  (
š_addr
))

	)

344 
	sgroup_f‹r


347 
ušt32_t
 
	mgf_š‹rçû
;

350 
sockaddr_¡Üage
 
	mgf_group
;

353 
ušt32_t
 
	mgf_fmode
;

356 
ušt32_t
 
	mgf_num¤c
;

358 
sockaddr_¡Üage
 
	mgf_¦i¡
[1];

361 
	#GROUP_FILTER_SIZE
(
num¤c
è( (
group_f‹r
) \

362 -  (
sockaddr_¡Üage
) \

363 + ((
num¤c
) \

364 *  (
sockaddr_¡Üage
)))

	)

374 
ušt32_t
 
	$Áohl
 (
ušt32_t
 
__ÃÚg
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

375 
ušt16_t
 
	$Áohs
 (
ušt16_t
 
__ÃtshÜt
)

376 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

377 
ušt32_t
 
	$htÚl
 (
ušt32_t
 
__ho¡lÚg
)

378 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

379 
ušt16_t
 
	$htÚs
 (
ušt16_t
 
__ho¡shÜt
)

380 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

382 
	~<’dŸn.h
>

385 
	~<b™s/by‹sw­.h
>

387 #ifdeà
__OPTIMIZE__


391 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


394 
	#Áohl
(
x
è(x)

	)

395 
	#Áohs
(
x
è(x)

	)

396 
	#htÚl
(
x
è(x)

	)

397 
	#htÚs
(
x
è(x)

	)

399 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


400 
	#Áohl
(
x
è
	`__bsw­_32
 (x)

	)

401 
	#Áohs
(
x
è
	`__bsw­_16
 (x)

	)

402 
	#htÚl
(
x
è
	`__bsw­_32
 (x)

	)

403 
	#htÚs
(
x
è
	`__bsw­_16
 (x)

	)

408 #ifdeà
__GNUC__


409 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

410 (
__ex‹nsiÚ__
 \

411 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

412 
__a
->
s6_addr32
[0] == 0 \

413 && 
__a
->
s6_addr32
[1] == 0 \

414 && 
__a
->
s6_addr32
[2] == 0 \

415 && 
__a
->
s6_addr32
[3] =ğ0; 
	}
}))

	)

417 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

418 (
__ex‹nsiÚ__
 \

419 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

420 
__a
->
s6_addr32
[0] == 0 \

421 && 
__a
->
s6_addr32
[1] == 0 \

422 && 
__a
->
s6_addr32
[2] == 0 \

423 && 
__a
->
s6_addr32
[3] =ğ
	`htÚl
 (1); }))

	)

425 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

426 (
__ex‹nsiÚ__
 \

427 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

428 (
__a
->
s6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xã800000); }))

	)

430 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

431 (
__ex‹nsiÚ__
 \

432 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

433 (
__a
->
s6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xãc00000); }))

	)

435 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

436 (
__ex‹nsiÚ__
 \

437 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

438 
__a
->
s6_addr32
[0] == 0 \

439 && 
__a
->
s6_addr32
[1] == 0 \

440 && 
__a
->
s6_addr32
[2] =ğ
	`htÚl
 (0xffff); }))

	)

442 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

443 (
__ex‹nsiÚ__
 \

444 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

445 
__a
->
s6_addr32
[0] == 0 \

446 && 
__a
->
s6_addr32
[1] == 0 \

447 && 
__a
->
s6_addr32
[2] == 0 \

448 && 
	`Áohl
 (
__a
->
s6_addr32
[3]è> 1; }))

	)

450 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

451 (
__ex‹nsiÚ__
 \

452 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

453 cÚ¡ 
š6_addr
 *
__b
 = (cÚ¡ š6_add¸*è(
b
); \

454 
__a
->
s6_addr32
[0] =ğ
__b
->s6_addr32[0] \

455 && 
__a
->
s6_addr32
[1] =ğ
__b
->s6_addr32[1] \

456 && 
__a
->
s6_addr32
[2] =ğ
__b
->s6_addr32[2] \

457 && 
__a
->
s6_addr32
[3] =ğ
__b
->s6_addr32[3]; }))

	)

459 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

460 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

461 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

462 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

463 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ0)

	)

465 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

466 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

467 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

468 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

469 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ
	`htÚl
 (1))

	)

471 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

472 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

473 =ğ
	`htÚl
 (0xã800000))

	)

475 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

476 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

477 =ğ
	`htÚl
 (0xãc00000))

	)

479 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

480 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

481 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

482 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ
	`htÚl
 (0xffff)))

	)

484 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

485 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

486 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

487 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0) \

488 && (
	`Áohl
 (((cÚ¡ 
ušt32_t
 *è(
a
))[3]è> 1))

	)

490 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

491 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[0]) \

492 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[1]) \

493 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[2]) \

494 && (((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[3]))

	)

497 
	#IN6_IS_ADDR_MULTICAST
(
a
è(((cÚ¡ 
ušt8_t
 *è×))[0] =ğ0xff)

	)

499 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


501 
	$bšd»svpÜt
 (
__sockfd
, 
sockaddr_š
 *
__sock_š
è
__THROW
;

504 
	$bšd»svpÜt6
 (
__sockfd
, 
sockaddr_š6
 *
__sock_š
)

505 
__THROW
;

509 
	#IN6_IS_ADDR_MC_NODELOCAL
(
a
) \

510 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

511 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x1))

	)

513 
	#IN6_IS_ADDR_MC_LINKLOCAL
(
a
) \

514 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

515 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x2))

	)

517 
	#IN6_IS_ADDR_MC_SITELOCAL
(
a
) \

518 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

519 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x5))

	)

521 
	#IN6_IS_ADDR_MC_ORGLOCAL
(
a
) \

522 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

523 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x8))

	)

525 
	#IN6_IS_ADDR_MC_GLOBAL
(
a
) \

526 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

527 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0xe))

	)

530 #ifdeà
__USE_GNU


531 
cmsghdr
;

534 
	sš6_pktšfo


536 
š6_addr
 
i6_addr
;

537 
i6_ifšdex
;

541 
	s6_mtušfo


543 
sockaddr_š6
 
6m_addr
;

544 
ušt32_t
 
6m_mtu
;

549 
	$š‘6_İtiÚ_¥aû
 (
__nby‹s
)

550 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

551 
	$š‘6_İtiÚ_š™
 (*
__bp
, 
cmsghdr
 **
__cmsgp
,

552 
__ty³
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

553 
	$š‘6_İtiÚ_­³nd
 (
cmsghdr
 *
__cmsg
,

554 cÚ¡ 
ušt8_t
 *
__ty³p
, 
__muÉx
,

555 
__¶usy
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

556 
ušt8_t
 *
	$š‘6_İtiÚ_®loc
 (
cmsghdr
 *
__cmsg
, 
__d©®’
,

557 
__muÉx
, 
__¶usy
)

558 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

559 
	$š‘6_İtiÚ_Ãxt
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

560 
ušt8_t
 **
__Œp
)

561 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

562 
	$š‘6_İtiÚ_fšd
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

563 
ušt8_t
 **
__Œp
, 
__ty³
)

564 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

568 
	$š‘6_İt_š™
 (*
__extbuf
, 
sockËn_t
 
__ex’
è
__THROW
;

569 
	$š‘6_İt_­³nd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

570 
ušt8_t
 
__ty³
, 
sockËn_t
 
__Ën
, ušt8_ˆ
__®ign
,

571 **
__d©abuå
è
__THROW
;

572 
	$š‘6_İt_fšish
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
)

573 
__THROW
;

574 
	$š‘6_İt_£t_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

575 
sockËn_t
 
__v®Ën
è
__THROW
;

576 
	$š‘6_İt_Ãxt
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

577 
ušt8_t
 *
__ty³p
, 
sockËn_t
 *
__ËÅ
,

578 **
__d©abuå
è
__THROW
;

579 
	$š‘6_İt_fšd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

580 
ušt8_t
 
__ty³
, 
sockËn_t
 *
__ËÅ
,

581 **
__d©abuå
è
__THROW
;

582 
	$š‘6_İt_g‘_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

583 
sockËn_t
 
__v®Ën
è
__THROW
;

587 
sockËn_t
 
	$š‘6_¹h_¥aû
 (
__ty³
, 
__£gm’ts
è
__THROW
;

588 *
	$š‘6_¹h_š™
 (*
__bp
, 
sockËn_t
 
__bp_Ën
, 
__ty³
,

589 
__£gm’ts
è
__THROW
;

590 
	$š‘6_¹h_add
 (*
__bp
, cÚ¡ 
š6_addr
 *
__addr
è
__THROW
;

591 
	$š‘6_¹h_»v”£
 (cÚ¡ *
__š
, *
__out
è
__THROW
;

592 
	$š‘6_¹h_£gm’ts
 (cÚ¡ *
__bp
è
__THROW
;

593 
š6_addr
 *
	$š‘6_¹h_g‘addr
 (cÚ¡ *
__bp
, 
__šdex
)

594 
__THROW
;

600 
	$g‘v4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

601 
š_addr
 
__group
, 
ušt32_t
 *
__fmode
,

602 
ušt32_t
 *
__num¤c
, 
š_addr
 *
__¦i¡
)

603 
__THROW
;

606 
	$£tv4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

607 
š_addr
 
__group
, 
ušt32_t
 
__fmode
,

608 
ušt32_t
 
__num¤c
,

609 cÚ¡ 
š_addr
 *
__¦i¡
)

610 
__THROW
;

614 
	$g‘sourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

615 cÚ¡ 
sockaddr
 *
__group
,

616 
sockËn_t
 
__grou¶’
, 
ušt32_t
 *
__fmode
,

617 
ušt32_t
 *
__num¤c
,

618 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

621 
	$£tsourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

622 cÚ¡ 
sockaddr
 *
__group
,

623 
sockËn_t
 
__grou¶’
, 
ušt32_t
 
__fmode
,

624 
ušt32_t
 
__num¤c
,

625 cÚ¡ 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

628 
__END_DECLS


	@/usr/include/netinet/tcp.h

32 #iâdeà
_NETINET_TCP_H


33 
	#_NETINET_TCP_H
 1

	)

35 
	~<ã©u»s.h
>

40 
	#TCP_NODELAY
 1

	)

41 
	#TCP_MAXSEG
 2

	)

42 
	#TCP_CORK
 3

	)

43 
	#TCP_KEEPIDLE
 4

	)

44 
	#TCP_KEEPINTVL
 5

	)

45 
	#TCP_KEEPCNT
 6

	)

46 
	#TCP_SYNCNT
 7

	)

47 
	#TCP_LINGER2
 8

	)

48 
	#TCP_DEFER_ACCEPT
 9

	)

49 
	#TCP_WINDOW_CLAMP
 10

	)

50 
	#TCP_INFO
 11

	)

51 
	#TCP_QUICKACK
 12

	)

52 
	#TCP_CONGESTION
 13

	)

53 
	#TCP_MD5SIG
 14

	)

54 
	#TCP_COOKIE_TRANSACTIONS
 15

	)

55 
	#TCP_THIN_LINEAR_TIMEOUTS
 16

	)

56 
	#TCP_THIN_DUPACK
 17

	)

57 
	#TCP_USER_TIMEOUT
 18

	)

58 
	#TCP_REPAIR
 19

	)

59 
	#TCP_REPAIR_QUEUE
 20

	)

60 
	#TCP_QUEUE_SEQ
 21

	)

61 
	#TCP_REPAIR_OPTIONS
 22

	)

62 
	#TCP_FASTOPEN
 23

	)

63 
	#TCP_TIMESTAMP
 24

	)

65 #ifdeà
__USE_MISC


66 
	~<sys/ty³s.h
>

67 
	~<sys/sock‘.h
>

69 
u_št32_t
 
	ttı_£q
;

74 
	stıhdr


76 
__ex‹nsiÚ__
 union

80 
u_št16_t
 
	mth_¥Üt
;

81 
u_št16_t
 
	mth_dpÜt
;

82 
tı_£q
 
	mth_£q
;

83 
tı_£q
 
	mth_ack
;

84 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


85 
u_št8_t
 
	mth_x2
:4;

86 
u_št8_t
 
	mth_off
:4;

88 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


89 
u_št8_t
 
	mth_off
:4;

90 
u_št8_t
 
	mth_x2
:4;

92 
u_št8_t
 
	mth_æags
;

93 
	#TH_FIN
 0x01

	)

94 
	#TH_SYN
 0x02

	)

95 
	#TH_RST
 0x04

	)

96 
	#TH_PUSH
 0x08

	)

97 
	#TH_ACK
 0x10

	)

98 
	#TH_URG
 0x20

	)

99 
u_št16_t
 
	mth_wš
;

100 
u_št16_t
 
	mth_sum
;

101 
u_št16_t
 
	mth_u½
;

105 
u_št16_t
 
	msourû
;

106 
u_št16_t
 
	mde¡
;

107 
u_št32_t
 
	m£q
;

108 
u_št32_t
 
	mack_£q
;

109 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


110 
u_št16_t
 
	m»s1
:4;

111 
u_št16_t
 
	mdoff
:4;

112 
u_št16_t
 
	mfš
:1;

113 
u_št16_t
 
	msyn
:1;

114 
u_št16_t
 
	mr¡
:1;

115 
u_št16_t
 
	mpsh
:1;

116 
u_št16_t
 
	mack
:1;

117 
u_št16_t
 
	murg
:1;

118 
u_št16_t
 
	m»s2
:2;

119 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


120 
u_št16_t
 
	mdoff
:4;

121 
u_št16_t
 
	m»s1
:4;

122 
u_št16_t
 
	m»s2
:2;

123 
u_št16_t
 
	murg
:1;

124 
u_št16_t
 
	mack
:1;

125 
u_št16_t
 
	mpsh
:1;

126 
u_št16_t
 
	mr¡
:1;

127 
u_št16_t
 
	msyn
:1;

128 
u_št16_t
 
	mfš
:1;

132 
u_št16_t
 
	mwšdow
;

133 
u_št16_t
 
	mcheck
;

134 
u_št16_t
 
	murg_±r
;

141 
	mTCP_ESTABLISHED
 = 1,

142 
	mTCP_SYN_SENT
,

143 
	mTCP_SYN_RECV
,

144 
	mTCP_FIN_WAIT1
,

145 
	mTCP_FIN_WAIT2
,

146 
	mTCP_TIME_WAIT
,

147 
	mTCP_CLOSE
,

148 
	mTCP_CLOSE_WAIT
,

149 
	mTCP_LAST_ACK
,

150 
	mTCP_LISTEN
,

151 
	mTCP_CLOSING


154 
	#TCPOPT_EOL
 0

	)

155 
	#TCPOPT_NOP
 1

	)

156 
	#TCPOPT_MAXSEG
 2

	)

157 
	#TCPOLEN_MAXSEG
 4

	)

158 
	#TCPOPT_WINDOW
 3

	)

159 
	#TCPOLEN_WINDOW
 3

	)

160 
	#TCPOPT_SACK_PERMITTED
 4

	)

161 
	#TCPOLEN_SACK_PERMITTED
 2

	)

162 
	#TCPOPT_SACK
 5

	)

163 
	#TCPOPT_TIMESTAMP
 8

	)

164 
	#TCPOLEN_TIMESTAMP
 10

	)

165 
	#TCPOLEN_TSTAMP_APPA
 (
TCPOLEN_TIMESTAMP
+2è

	)

167 
	#TCPOPT_TSTAMP_HDR
 \

168 (
TCPOPT_NOP
<<24|TCPOPT_NOP<<16|
TCPOPT_TIMESTAMP
<<8|
TCPOLEN_TIMESTAMP
)

	)

176 
	#TCP_MSS
 512

	)

178 
	#TCP_MAXWIN
 65535

	)

180 
	#TCP_MAX_WINSHIFT
 14

	)

182 
	#SOL_TCP
 6

	)

185 
	#TCPI_OPT_TIMESTAMPS
 1

	)

186 
	#TCPI_OPT_SACK
 2

	)

187 
	#TCPI_OPT_WSCALE
 4

	)

188 
	#TCPI_OPT_ECN
 8

	)

189 
	#TCPI_OPT_ECN_SEEN
 16

	)

190 
	#TCPI_OPT_SYN_DATA
 32

	)

193 
	etı_ÿ_¡©e


195 
	mTCP_CA_O³n
 = 0,

196 
	mTCP_CA_DisÜd”
 = 1,

197 
	mTCP_CA_CWR
 = 2,

198 
	mTCP_CA_Recov”y
 = 3,

199 
	mTCP_CA_Loss
 = 4

202 
	stı_šfo


204 
u_št8_t
 
	mtıi_¡©e
;

205 
u_št8_t
 
	mtıi_ÿ_¡©e
;

206 
u_št8_t
 
	mtıi_»Œªsm™s
;

207 
u_št8_t
 
	mtıi_´obes
;

208 
u_št8_t
 
	mtıi_backoff
;

209 
u_št8_t
 
	mtıi_İtiÚs
;

210 
u_št8_t
 
	mtıi_¢d_wsÿË
 : 4, 
	mtıi_rcv_wsÿË
 : 4;

212 
u_št32_t
 
	mtıi_¹o
;

213 
u_št32_t
 
	mtıi_©o
;

214 
u_št32_t
 
	mtıi_¢d_mss
;

215 
u_št32_t
 
	mtıi_rcv_mss
;

217 
u_št32_t
 
	mtıi_uÇcked
;

218 
u_št32_t
 
	mtıi_§cked
;

219 
u_št32_t
 
	mtıi_lo¡
;

220 
u_št32_t
 
	mtıi_»Œªs
;

221 
u_št32_t
 
	mtıi_çck‘s
;

224 
u_št32_t
 
	mtıi_Ï¡_d©a_£Á
;

225 
u_št32_t
 
	mtıi_Ï¡_ack_£Á
;

226 
u_št32_t
 
	mtıi_Ï¡_d©a_»cv
;

227 
u_št32_t
 
	mtıi_Ï¡_ack_»cv
;

230 
u_št32_t
 
	mtıi_pmtu
;

231 
u_št32_t
 
	mtıi_rcv_s¡h»sh
;

232 
u_št32_t
 
	mtıi_¹t
;

233 
u_št32_t
 
	mtıi_¹tv¬
;

234 
u_št32_t
 
	mtıi_¢d_s¡h»sh
;

235 
u_št32_t
 
	mtıi_¢d_cwnd
;

236 
u_št32_t
 
	mtıi_advmss
;

237 
u_št32_t
 
	mtıi_»Üd”šg
;

239 
u_št32_t
 
	mtıi_rcv_¹t
;

240 
u_št32_t
 
	mtıi_rcv_¥aû
;

242 
u_št32_t
 
	mtıi_tÙ®_»Œªs
;

247 
	#TCP_MD5SIG_MAXKEYLEN
 80

	)

249 
	stı_md5sig


251 
sockaddr_¡Üage
 
	mtım_addr
;

252 
u_št16_t
 
	m__tım_·d1
;

253 
u_št16_t
 
	mtım_keyËn
;

254 
u_št32_t
 
	m__tım_·d2
;

255 
u_št8_t
 
	mtım_key
[
TCP_MD5SIG_MAXKEYLEN
];

259 
	stı_»·œ_İt


261 
u_št32_t
 
	mİt_code
;

262 
u_št32_t
 
	mİt_v®
;

268 
	mTCP_NO_QUEUE
,

269 
	mTCP_RECV_QUEUE
,

270 
	mTCP_SEND_QUEUE
,

271 
	mTCP_QUEUES_NR
,

275 
	#TCP_COOKIE_MIN
 8

	)

276 
	#TCP_COOKIE_MAX
 16

	)

277 
	#TCP_COOKIE_PAIR_SIZE
 (2*
TCP_COOKIE_MAX
)

	)

280 
	#TCP_COOKIE_IN_ALWAYS
 (1 << 0è

	)

281 
	#TCP_COOKIE_OUT_NEVER
 (1 << 1è

	)

285 
	#TCP_S_DATA_IN
 (1 << 2è

	)

286 
	#TCP_S_DATA_OUT
 (1 << 3è

	)

288 
	#TCP_MSS_DEFAULT
 536U

	)

289 
	#TCP_MSS_DESIRED
 1220U

	)

291 
	stı_cook›_Œª§ùiÚs


293 
u_št16_t
 
	mtıù_æags
;

294 
u_št8_t
 
	m__tıù_·d1
;

295 
u_št8_t
 
	mtıù_cook›_desœed
;

296 
u_št16_t
 
	mtıù_s_d©a_desœed
;

297 
u_št16_t
 
	mtıù_u£d
;

298 
u_št8_t
 
	mtıù_v®ue
[
TCP_MSS_DEFAULT
];

	@/usr/include/poll.h

1 
	~<sys/pŞl.h
>

	@/usr/include/pthread.h

18 #iâdeà
_PTHREAD_H


19 
	#_PTHREAD_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<’dŸn.h
>

23 
	~<sched.h
>

24 
	~<time.h
>

26 
	~<b™s/±h»adty³s.h
>

27 
	~<b™s/£tjmp.h
>

28 
	~<b™s/wÜdsize.h
>

34 
	mPTHREAD_CREATE_JOINABLE
,

35 
	#PTHREAD_CREATE_JOINABLE
 
PTHREAD_CREATE_JOINABLE


	)

36 
	mPTHREAD_CREATE_DETACHED


37 
	#PTHREAD_CREATE_DETACHED
 
PTHREAD_CREATE_DETACHED


	)

44 
	mPTHREAD_MUTEX_TIMED_NP
,

45 
	mPTHREAD_MUTEX_RECURSIVE_NP
,

46 
	mPTHREAD_MUTEX_ERRORCHECK_NP
,

47 
	mPTHREAD_MUTEX_ADAPTIVE_NP


48 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


50 
	mPTHREAD_MUTEX_NORMAL
 = 
PTHREAD_MUTEX_TIMED_NP
,

51 
	mPTHREAD_MUTEX_RECURSIVE
 = 
PTHREAD_MUTEX_RECURSIVE_NP
,

52 
	mPTHREAD_MUTEX_ERRORCHECK
 = 
PTHREAD_MUTEX_ERRORCHECK_NP
,

53 
	mPTHREAD_MUTEX_DEFAULT
 = 
PTHREAD_MUTEX_NORMAL


55 #ifdeà
__USE_GNU


57 , 
	mPTHREAD_MUTEX_FAST_NP
 = 
PTHREAD_MUTEX_TIMED_NP


62 #ifdeà
__USE_XOPEN2K


66 
	mPTHREAD_MUTEX_STALLED
,

67 
	mPTHREAD_MUTEX_STALLED_NP
 = 
PTHREAD_MUTEX_STALLED
,

68 
	mPTHREAD_MUTEX_ROBUST
,

69 
	mPTHREAD_MUTEX_ROBUST_NP
 = 
PTHREAD_MUTEX_ROBUST


74 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


78 
	mPTHREAD_PRIO_NONE
,

79 
	mPTHREAD_PRIO_INHERIT
,

80 
	mPTHREAD_PRIO_PROTECT


86 #ià
__PTHREAD_MUTEX_HAVE_ELISION
 == 1

87 
	#__PTHREAD_SPINS
 0, 0

	)

88 #–ià
__PTHREAD_MUTEX_HAVE_ELISION
 == 2

89 
	#__PTHREAD_SPINS
 { 0, 0 }

	)

91 
	#__PTHREAD_SPINS
 0

	)

94 #ifdeà
__PTHREAD_MUTEX_HAVE_PREV


95 
	#PTHREAD_MUTEX_INITIALIZER
 \

96 { { 0, 0, 0, 0, 0, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

97 #ifdeà
__USE_GNU


98 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

99 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

100 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

101 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

102 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

103 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

104 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

105 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

109 
	#PTHREAD_MUTEX_INITIALIZER
 \

110 { { 0, 0, 0, 0, 0, { 
__PTHREAD_SPINS
 } } }

	)

111 #ifdeà
__USE_GNU


112 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

113 { { 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

114 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

115 { { 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

116 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

117 { { 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

124 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


127 
	mPTHREAD_RWLOCK_PREFER_READER_NP
,

128 
	mPTHREAD_RWLOCK_PREFER_WRITER_NP
,

129 
	mPTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,

130 
	mPTHREAD_RWLOCK_DEFAULT_NP
 = 
PTHREAD_RWLOCK_PREFER_READER_NP


136 #iâdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


137 #ià
__WORDSIZE
 == 64

138 
	#__PTHREAD_RWLOCK_INT_FLAGS_SHARED
 1

	)

143 
	#PTHREAD_RWLOCK_INITIALIZER
 \

144 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 } }

	)

145 #ifdeà
__USE_GNU


146 #ifdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


147 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

149 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
 } }

	)

151 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


152 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

153 { { 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
, \

154 0, 0, 0, 0 } }

	)

156 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

157 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,\

158 0 } }

	)

168 
	mPTHREAD_INHERIT_SCHED
,

169 
	#PTHREAD_INHERIT_SCHED
 
PTHREAD_INHERIT_SCHED


	)

170 
	mPTHREAD_EXPLICIT_SCHED


171 
	#PTHREAD_EXPLICIT_SCHED
 
PTHREAD_EXPLICIT_SCHED


	)

178 
	mPTHREAD_SCOPE_SYSTEM
,

179 
	#PTHREAD_SCOPE_SYSTEM
 
PTHREAD_SCOPE_SYSTEM


	)

180 
	mPTHREAD_SCOPE_PROCESS


181 
	#PTHREAD_SCOPE_PROCESS
 
PTHREAD_SCOPE_PROCESS


	)

188 
	mPTHREAD_PROCESS_PRIVATE
,

189 
	#PTHREAD_PROCESS_PRIVATE
 
PTHREAD_PROCESS_PRIVATE


	)

190 
	mPTHREAD_PROCESS_SHARED


191 
	#PTHREAD_PROCESS_SHARED
 
PTHREAD_PROCESS_SHARED


	)

197 
	#PTHREAD_COND_INITIALIZER
 { { 0, 0, 0, 0, 0, (*è0, 0, 0 } }

	)

201 
	s_±h»ad_ş—nup_bufãr


203 (*
	m__routše
) (*);

204 *
	m__¬g
;

205 
	m__ÿnûÉy³
;

206 
_±h»ad_ş—nup_bufãr
 *
	m__´ev
;

212 
	mPTHREAD_CANCEL_ENABLE
,

213 
	#PTHREAD_CANCEL_ENABLE
 
PTHREAD_CANCEL_ENABLE


	)

214 
	mPTHREAD_CANCEL_DISABLE


215 
	#PTHREAD_CANCEL_DISABLE
 
PTHREAD_CANCEL_DISABLE


	)

219 
	mPTHREAD_CANCEL_DEFERRED
,

220 
	#PTHREAD_CANCEL_DEFERRED
 
PTHREAD_CANCEL_DEFERRED


	)

221 
	mPTHREAD_CANCEL_ASYNCHRONOUS


222 
	#PTHREAD_CANCEL_ASYNCHRONOUS
 
PTHREAD_CANCEL_ASYNCHRONOUS


	)

224 
	#PTHREAD_CANCELED
 ((*è-1)

	)

228 
	#PTHREAD_ONCE_INIT
 0

	)

231 #ifdeà
__USE_XOPEN2K


235 
	#PTHREAD_BARRIER_SERIAL_THREAD
 -1

	)

239 
__BEGIN_DECLS


244 
±h»ad_ü—‹
 (
±h»ad_t
 *
__»¡riù
 
__Ãwth»ad
,

245 cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

246 *(*
__¡¬t_routše
) (*),

247 *
__»¡riù
 
__¬g
è
__THROWNL
 
__nÚnuÎ
 ((1, 3));

253 
	$±h»ad_ex™
 (*
__»tv®
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

261 
	`±h»ad_još
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
);

263 #ifdeà
__USE_GNU


266 
	$±h»ad_Œyjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
è
__THROW
;

274 
	`±h»ad_timedjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
,

275 cÚ¡ 
time¥ec
 *
__ab¡ime
);

282 
	$±h»ad_d‘ach
 (
±h»ad_t
 
__th
è
__THROW
;

286 
±h»ad_t
 
	$±h»ad_£lf
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

289 
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
)

290 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

298 
	$±h»ad_©Œ_š™
 (
±h»ad_©Œ_t
 *
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

301 
	$±h»ad_©Œ_de¡roy
 (
±h»ad_©Œ_t
 *
__©Œ
)

302 
__THROW
 
	`__nÚnuÎ
 ((1));

305 
	$±h»ad_©Œ_g‘d‘ach¡©e
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

306 *
__d‘ach¡©e
)

307 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

310 
	$±h»ad_©Œ_£td‘ach¡©e
 (
±h»ad_©Œ_t
 *
__©Œ
,

311 
__d‘ach¡©e
)

312 
__THROW
 
	`__nÚnuÎ
 ((1));

316 
	$±h»ad_©Œ_g‘gu¬dsize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

317 
size_t
 *
__gu¬dsize
)

318 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

321 
	$±h»ad_©Œ_£tgu¬dsize
 (
±h»ad_©Œ_t
 *
__©Œ
,

322 
size_t
 
__gu¬dsize
)

323 
__THROW
 
	`__nÚnuÎ
 ((1));

327 
	$±h»ad_©Œ_g‘sched·¿m
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

328 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

329 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

332 
	$±h»ad_©Œ_£tsched·¿m
 (
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

333 cÚ¡ 
sched_·¿m
 *
__»¡riù


334 
__·¿m
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

337 
	$±h»ad_©Œ_g‘schedpŞicy
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


338 
__©Œ
, *
__»¡riù
 
__pŞicy
)

339 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

342 
	$±h»ad_©Œ_£tschedpŞicy
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__pŞicy
)

343 
__THROW
 
	`__nÚnuÎ
 ((1));

346 
	$±h»ad_©Œ_g‘šh”™sched
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


347 
__©Œ
, *
__»¡riù
 
__šh”™
)

348 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

351 
	$±h»ad_©Œ_£tšh”™sched
 (
±h»ad_©Œ_t
 *
__©Œ
,

352 
__šh”™
)

353 
__THROW
 
	`__nÚnuÎ
 ((1));

357 
	$±h»ad_©Œ_g‘scİe
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

358 *
__»¡riù
 
__scİe
)

359 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

362 
	$±h»ad_©Œ_£tscİe
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__scİe
)

363 
__THROW
 
	`__nÚnuÎ
 ((1));

366 
	$±h»ad_©Œ_g‘¡ackaddr
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


367 
__©Œ
, **
__»¡riù
 
__¡ackaddr
)

368 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__©Œibu‹_d•»ÿ‹d__
;

374 
	$±h»ad_©Œ_£t¡ackaddr
 (
±h»ad_©Œ_t
 *
__©Œ
,

375 *
__¡ackaddr
)

376 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
;

379 
	$±h»ad_©Œ_g‘¡acksize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


380 
__©Œ
, 
size_t
 *
__»¡riù
 
__¡acksize
)

381 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

386 
	$±h»ad_©Œ_£t¡acksize
 (
±h»ad_©Œ_t
 *
__©Œ
,

387 
size_t
 
__¡acksize
)

388 
__THROW
 
	`__nÚnuÎ
 ((1));

390 #ifdeà
__USE_XOPEN2K


392 
	$±h»ad_©Œ_g‘¡ack
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

393 **
__»¡riù
 
__¡ackaddr
,

394 
size_t
 *
__»¡riù
 
__¡acksize
)

395 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

400 
	$±h»ad_©Œ_£t¡ack
 (
±h»ad_©Œ_t
 *
__©Œ
, *
__¡ackaddr
,

401 
size_t
 
__¡acksize
è
__THROW
 
	`__nÚnuÎ
 ((1));

404 #ifdeà
__USE_GNU


407 
	$±h»ad_©Œ_£ffš™y_Å
 (
±h»ad_©Œ_t
 *
__©Œ
,

408 
size_t
 
__ıu£tsize
,

409 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

410 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

414 
	$±h»ad_©Œ_g‘affš™y_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

415 
size_t
 
__ıu£tsize
,

416 
ıu_£t_t
 *
__ıu£t
)

417 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

420 
	$±h»ad_g‘©Œ_deçuÉ_Å
 (
±h»ad_©Œ_t
 *
__©Œ
)

421 
__THROW
 
	`__nÚnuÎ
 ((1));

425 
	$±h»ad_£‰r_deçuÉ_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
)

426 
__THROW
 
	`__nÚnuÎ
 ((1));

431 
	$±h»ad_g‘©Œ_Å
 (
±h»ad_t
 
__th
, 
±h»ad_©Œ_t
 *
__©Œ
)

432 
__THROW
 
	`__nÚnuÎ
 ((2));

440 
	$±h»ad_£tsched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
, 
__pŞicy
,

441 cÚ¡ 
sched_·¿m
 *
__·¿m
)

442 
__THROW
 
	`__nÚnuÎ
 ((3));

445 
	$±h»ad_g‘sched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
,

446 *
__»¡riù
 
__pŞicy
,

447 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

448 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

451 
	$±h»ad_£tsched´io
 (
±h»ad_t
 
__rg‘_th»ad
, 
__´io
)

452 
__THROW
;

455 #ifdeà
__USE_GNU


457 
	$±h»ad_g‘Çme_Å
 (
±h»ad_t
 
__rg‘_th»ad
, *
__buf
,

458 
size_t
 
__buæ’
)

459 
__THROW
 
	`__nÚnuÎ
 ((2));

462 
	$±h»ad_£Šame_Å
 (
±h»ad_t
 
__rg‘_th»ad
, cÚ¡ *
__Çme
)

463 
__THROW
 
	`__nÚnuÎ
 ((2));

467 #ifdeà
__USE_UNIX98


469 
	$±h»ad_g‘cÚcu¼’cy
 (è
__THROW
;

472 
	$±h»ad_£tcÚcu¼’cy
 (
__Ëv–
è
__THROW
;

475 #ifdeà
__USE_GNU


480 
	$±h»ad_y›ld
 (è
__THROW
;

485 
	$±h»ad_£ffš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

486 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

487 
__THROW
 
	`__nÚnuÎ
 ((3));

490 
	$±h»ad_g‘affš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

491 
ıu_£t_t
 *
__ıu£t
)

492 
__THROW
 
	`__nÚnuÎ
 ((3));

505 
	`±h»ad_Úû
 (
±h»ad_Úû_t
 *
__Úû_cÚŒŞ
,

506 (*
__š™_routše
è()è
	`__nÚnuÎ
 ((1, 2));

517 
	`±h»ad_£tÿnûl¡©e
 (
__¡©e
, *
__Şd¡©e
);

521 
	`±h»ad_£tÿnûÉy³
 (
__ty³
, *
__Şdty³
);

524 
	`±h»ad_ÿnûl
 (
±h»ad_t
 
__th
);

529 
	`±h»ad_‹¡ÿnûl
 ();

538 
__jmp_buf
 
__ÿnûl_jmp_buf
;

539 
__mask_was_§ved
;

540 } 
__ÿnûl_jmp_buf
[1];

541 *
__·d
[4];

542 } 
	t__±h»ad_unwšd_buf_t
 
	t__©Œibu‹__
 ((
	t__®igÃd__
));

545 #iâdeà
__ş—nup_fù_©Œibu‹


546 
	#__ş—nup_fù_©Œibu‹


	)

551 
	s__±h»ad_ş—nup_äame


553 (*
__ÿnûl_routše
) (*);

554 *
__ÿnûl_¬g
;

555 
__do_™
;

556 
__ÿnûl_ty³
;

559 #ià
defšed
 
__GNUC__
 && defšed 
__EXCEPTIONS


560 #ifdeà
__ılu¥lus


562 şas 
	c__±h»ad_ş—nup_şass


564 (*
__ÿnûl_routše
) (*);

565 *
__ÿnûl_¬g
;

566 
__do_™
;

567 
__ÿnûl_ty³
;

569 
public
:

570 
	`__±h»ad_ş—nup_şass
 ((*
__fù
è(*), *
__¬g
)

571 : 
	`__ÿnûl_routše
 (
__fù
), 
	`__ÿnûl_¬g
 (
__¬g
), 
	$__do_™
 (1) { }

572 ~
	$__±h»ad_ş—nup_şass
 (è{ ià(
__do_™
è
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); 
	}
}

573 
	$__£tdo™
 (
__Ãwv®
è{ 
__do_™
 = __Ãwv®; 
	}
}

574 
	$__deãr
 (è{ 
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
,

575 &
__ÿnûl_ty³
); 
	}
}

576 
	$__»¡Üe
 (ècÚ¡ { 
	`±h»ad_£tÿnûÉy³
 (
__ÿnûl_ty³
, 0); 
	}
}

586 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

588 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
)

	)

592 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

593 
__şäame
.
	`__£tdo™
 (
execu‹
); \

594 } 0)

	)

596 #ifdeà
__USE_GNU


600 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

602 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
); \

603 
__şäame
.
	`__deãr
 ()

	)

608 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

609 
__şäame
.
	`__»¡Üe
 (); \

610 
__şäame
.
	`__£tdo™
 (
execu‹
); \

611 } 0)

	)

618 
__ex‹º_šlše
 

619 
	$__±h»ad_ş—nup_routše
 (
__±h»ad_ş—nup_äame
 *
__äame
)

621 ià(
__äame
->
__do_™
)

622 
__äame
->
	`__ÿnûl_routše
 (__äame->
__ÿnûl_¬g
);

623 
	}
}

632 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

634 
__±h»ad_ş—nup_äame
 
__şäame
 \

635 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

636 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

637 .
__do_™
 = 1 };

	)

641 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

642 
__şäame
.
__do_™
 = (
execu‹
); \

643 } 0)

	)

645 #ifdeà
__USE_GNU


649 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

651 
__±h»ad_ş—nup_äame
 
__şäame
 \

652 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

653 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

654 .
__do_™
 = 1 }; \

655 (è
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
, \

656 &
__şäame
.
__ÿnûl_ty³
)

	)

661 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

662 (è
	`±h»ad_£tÿnûÉy³
 (
__şäame
.
__ÿnûl_ty³
, 
NULL
); \

663 
__şäame
.
__do_™
 = (
execu‹
); \

664 } 0)

	)

675 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

677 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

678 (*
__ÿnûl_routše
è(*èğ(
routše
); \

679 *
__ÿnûl_¬g
 = (
¬g
); \

680 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

681 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

682 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

684 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

685 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

689 
	`__±h»ad_»gi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

690 dØ{

	)

691 
__±h»ad_»gi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

692 
__ş—nup_fù_©Œibu‹
;

696 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

699 
	`__±h»ad_uÄegi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

700 ià(
execu‹
) \

701 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

702 } 0)

	)

703 
	$__±h»ad_uÄegi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

704 
__ş—nup_fù_©Œibu‹
;

706 #ifdeà
__USE_GNU


710 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

712 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

713 (*
__ÿnûl_routše
è(*èğ(
routše
); \

714 *
__ÿnûl_¬g
 = (
¬g
); \

715 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

716 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

717 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

719 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

720 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

724 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (&
__ÿnûl_buf
); \

725 dØ{

	)

726 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

727 
__ş—nup_fù_©Œibu‹
;

732 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

735 
	`__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (&
__ÿnûl_buf
); \

736 ià(
execu‹
) \

737 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

738 
	}
} 0)

	)

739 
	$__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

740 
__ş—nup_fù_©Œibu‹
;

744 
	$__±h»ad_unwšd_Ãxt
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

745 
__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

746 #iâdeà
SHARED


747 
	`__©Œibu‹__
 ((
__w—k__
))

753 
__jmp_buf_g
;

754 
	$__sig£tjmp
 (
__jmp_buf_g
 *
__’v
, 
__§vemask
è
__THROWNL
;

760 
	$±h»ad_mu‹x_š™
 (
±h»ad_mu‹x_t
 *
__mu‹x
,

761 cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__mu‹x©Œ
)

762 
__THROW
 
	`__nÚnuÎ
 ((1));

765 
	$±h»ad_mu‹x_de¡roy
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

766 
__THROW
 
	`__nÚnuÎ
 ((1));

769 
	$±h»ad_mu‹x_Œylock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

770 
__THROWNL
 
	`__nÚnuÎ
 ((1));

773 
	$±h»ad_mu‹x_lock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

774 
__THROWNL
 
	`__nÚnuÎ
 ((1));

776 #ifdeà
__USE_XOPEN2K


778 
	$±h»ad_mu‹x_timedlock
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

779 cÚ¡ 
time¥ec
 *
__»¡riù


780 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

784 
	$±h»ad_mu‹x_uÆock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

785 
__THROWNL
 
	`__nÚnuÎ
 ((1));

789 
	$±h»ad_mu‹x_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x_t
 *

790 
__»¡riù
 
__mu‹x
,

791 *
__»¡riù
 
__´ioûšg
)

792 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

796 
	$±h»ad_mu‹x_£rioûšg
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

797 
__´ioûšg
,

798 *
__»¡riù
 
__Şd_ûšg
)

799 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

802 #ifdeà
__USE_XOPEN2K8


804 
	$±h»ad_mu‹x_cÚsi¡’t
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

805 
__THROW
 
	`__nÚnuÎ
 ((1));

806 #ifdeà
__USE_GNU


807 
	$±h»ad_mu‹x_cÚsi¡’t_Å
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

808 
__THROW
 
	`__nÚnuÎ
 ((1));

817 
	$±h»ad_mu‹x©Œ_š™
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

818 
__THROW
 
	`__nÚnuÎ
 ((1));

821 
	$±h»ad_mu‹x©Œ_de¡roy
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

822 
__THROW
 
	`__nÚnuÎ
 ((1));

825 
	$±h»ad_mu‹x©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

826 
__»¡riù
 
__©Œ
,

827 *
__»¡riù
 
__psh¬ed
)

828 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

831 
	$±h»ad_mu‹x©Œ_£sh¬ed
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

832 
__psh¬ed
)

833 
__THROW
 
	`__nÚnuÎ
 ((1));

835 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


837 
	$±h»ad_mu‹x©Œ_g‘ty³
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__»¡riù


838 
__©Œ
, *
__»¡riù
 
__kšd
)

839 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

844 
	$±h»ad_mu‹x©Œ_£‰y³
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
, 
__kšd
)

845 
__THROW
 
	`__nÚnuÎ
 ((1));

849 
	$±h»ad_mu‹x©Œ_g‘´ÙocŞ
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

850 
__»¡riù
 
__©Œ
,

851 *
__»¡riù
 
__´ÙocŞ
)

852 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

856 
	$±h»ad_mu‹x©Œ_£rÙocŞ
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

857 
__´ÙocŞ
)

858 
__THROW
 
	`__nÚnuÎ
 ((1));

861 
	$±h»ad_mu‹x©Œ_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

862 
__»¡riù
 
__©Œ
,

863 *
__»¡riù
 
__´ioûšg
)

864 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

867 
	$±h»ad_mu‹x©Œ_£rioûšg
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

868 
__´ioûšg
)

869 
__THROW
 
	`__nÚnuÎ
 ((1));

871 #ifdeà
__USE_XOPEN2K


873 
	$±h»ad_mu‹x©Œ_g‘robu¡
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

874 *
__robu¡Ãss
)

875 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

876 #ifdeà
__USE_GNU


877 
	$±h»ad_mu‹x©Œ_g‘robu¡_Å
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

878 *
__robu¡Ãss
)

879 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

883 
	$±h»ad_mu‹x©Œ_£Œobu¡
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

884 
__robu¡Ãss
)

885 
__THROW
 
	`__nÚnuÎ
 ((1));

886 #ifdeà
__USE_GNU


887 
	$±h»ad_mu‹x©Œ_£Œobu¡_Å
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

888 
__robu¡Ãss
)

889 
__THROW
 
	`__nÚnuÎ
 ((1));

894 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


899 
	$±h»ad_rwlock_š™
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

900 cÚ¡ 
±h»ad_rwlock©Œ_t
 *
__»¡riù


901 
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

904 
	$±h»ad_rwlock_de¡roy
 (
±h»ad_rwlock_t
 *
__rwlock
)

905 
__THROW
 
	`__nÚnuÎ
 ((1));

908 
	$±h»ad_rwlock_rdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

909 
__THROWNL
 
	`__nÚnuÎ
 ((1));

912 
	$±h»ad_rwlock_Œyrdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

913 
__THROWNL
 
	`__nÚnuÎ
 ((1));

915 #ifdeà
__USE_XOPEN2K


917 
	$±h»ad_rwlock_timedrdlock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

918 cÚ¡ 
time¥ec
 *
__»¡riù


919 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

923 
	$±h»ad_rwlock_w¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

924 
__THROWNL
 
	`__nÚnuÎ
 ((1));

927 
	$±h»ad_rwlock_Œyw¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

928 
__THROWNL
 
	`__nÚnuÎ
 ((1));

930 #ifdeà
__USE_XOPEN2K


932 
	$±h»ad_rwlock_timedw¾ock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

933 cÚ¡ 
time¥ec
 *
__»¡riù


934 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

938 
	$±h»ad_rwlock_uÆock
 (
±h»ad_rwlock_t
 *
__rwlock
)

939 
__THROWNL
 
	`__nÚnuÎ
 ((1));

945 
	$±h»ad_rwlock©Œ_š™
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

946 
__THROW
 
	`__nÚnuÎ
 ((1));

949 
	$±h»ad_rwlock©Œ_de¡roy
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

950 
__THROW
 
	`__nÚnuÎ
 ((1));

953 
	$±h»ad_rwlock©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

954 
__»¡riù
 
__©Œ
,

955 *
__»¡riù
 
__psh¬ed
)

956 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

959 
	$±h»ad_rwlock©Œ_£sh¬ed
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

960 
__psh¬ed
)

961 
__THROW
 
	`__nÚnuÎ
 ((1));

964 
	$±h»ad_rwlock©Œ_g‘kšd_Å
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

965 
__»¡riù
 
__©Œ
,

966 *
__»¡riù
 
__´ef
)

967 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

970 
	$±h»ad_rwlock©Œ_£tkšd_Å
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

971 
__´ef
è
__THROW
 
	`__nÚnuÎ
 ((1));

979 
	$±h»ad_cÚd_š™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

980 cÚ¡ 
±h»ad_cÚd©Œ_t
 *
__»¡riù
 
__cÚd_©Œ
)

981 
__THROW
 
	`__nÚnuÎ
 ((1));

984 
	$±h»ad_cÚd_de¡roy
 (
±h»ad_cÚd_t
 *
__cÚd
)

985 
__THROW
 
	`__nÚnuÎ
 ((1));

988 
	$±h»ad_cÚd_sigÇl
 (
±h»ad_cÚd_t
 *
__cÚd
)

989 
__THROWNL
 
	`__nÚnuÎ
 ((1));

992 
	$±h»ad_cÚd_brßdÿ¡
 (
±h»ad_cÚd_t
 *
__cÚd
)

993 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1000 
	$±h»ad_cÚd_wa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

1001 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
)

1002 
	`__nÚnuÎ
 ((1, 2));

1011 
	$±h»ad_cÚd_timedwa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

1012 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

1013 cÚ¡ 
time¥ec
 *
__»¡riù
 
__ab¡ime
)

1014 
	`__nÚnuÎ
 ((1, 2, 3));

1019 
	$±h»ad_cÚd©Œ_š™
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1020 
__THROW
 
	`__nÚnuÎ
 ((1));

1023 
	$±h»ad_cÚd©Œ_de¡roy
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1024 
__THROW
 
	`__nÚnuÎ
 ((1));

1027 
	$±h»ad_cÚd©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1028 
__»¡riù
 
__©Œ
,

1029 *
__»¡riù
 
__psh¬ed
)

1030 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1033 
	$±h»ad_cÚd©Œ_£sh¬ed
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1034 
__psh¬ed
è
__THROW
 
	`__nÚnuÎ
 ((1));

1036 #ifdeà
__USE_XOPEN2K


1038 
	$±h»ad_cÚd©Œ_g‘şock
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1039 
__»¡riù
 
__©Œ
,

1040 
__şockid_t
 *
__»¡riù
 
__şock_id
)

1041 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1044 
	$±h»ad_cÚd©Œ_£tşock
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1045 
__şockid_t
 
__şock_id
)

1046 
__THROW
 
	`__nÚnuÎ
 ((1));

1050 #ifdeà
__USE_XOPEN2K


1055 
	$±h»ad_¥š_š™
 (
±h»ad_¥šlock_t
 *
__lock
, 
__psh¬ed
)

1056 
__THROW
 
	`__nÚnuÎ
 ((1));

1059 
	$±h»ad_¥š_de¡roy
 (
±h»ad_¥šlock_t
 *
__lock
)

1060 
__THROW
 
	`__nÚnuÎ
 ((1));

1063 
	$±h»ad_¥š_lock
 (
±h»ad_¥šlock_t
 *
__lock
)

1064 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1067 
	$±h»ad_¥š_Œylock
 (
±h»ad_¥šlock_t
 *
__lock
)

1068 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1071 
	$±h»ad_¥š_uÆock
 (
±h»ad_¥šlock_t
 *
__lock
)

1072 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1079 
	$±h»ad_b¬r›r_š™
 (
±h»ad_b¬r›r_t
 *
__»¡riù
 
__b¬r›r
,

1080 cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *
__»¡riù


1081 
__©Œ
, 
__couÁ
)

1082 
__THROW
 
	`__nÚnuÎ
 ((1));

1085 
	$±h»ad_b¬r›r_de¡roy
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1086 
__THROW
 
	`__nÚnuÎ
 ((1));

1089 
	$±h»ad_b¬r›r_wa™
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1090 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1094 
	$±h»ad_b¬r›¿‰r_š™
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1095 
__THROW
 
	`__nÚnuÎ
 ((1));

1098 
	$±h»ad_b¬r›¿‰r_de¡roy
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1099 
__THROW
 
	`__nÚnuÎ
 ((1));

1102 
	$±h»ad_b¬r›¿‰r_g‘psh¬ed
 (cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *

1103 
__»¡riù
 
__©Œ
,

1104 *
__»¡riù
 
__psh¬ed
)

1105 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1108 
	$±h»ad_b¬r›¿‰r_£sh¬ed
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
,

1109 
__psh¬ed
)

1110 
__THROW
 
	`__nÚnuÎ
 ((1));

1122 
	`±h»ad_key_ü—‹
 (
±h»ad_key_t
 *
__key
,

1123 (*
__de¡r_funùiÚ
) (*))

1124 
__THROW
 
	`__nÚnuÎ
 ((1));

1127 
	$±h»ad_key_d–‘e
 (
±h»ad_key_t
 
__key
è
__THROW
;

1130 *
	$±h»ad_g‘¥ecific
 (
±h»ad_key_t
 
__key
è
__THROW
;

1133 
	$±h»ad_£t¥ecific
 (
±h»ad_key_t
 
__key
,

1134 cÚ¡ *
__poš‹r
è
__THROW
 ;

1137 #ifdeà
__USE_XOPEN2K


1139 
	$±h»ad_g‘ıuşockid
 (
±h»ad_t
 
__th»ad_id
,

1140 
__şockid_t
 *
__şock_id
)

1141 
__THROW
 
	`__nÚnuÎ
 ((2));

1156 
	`±h»ad_©fÜk
 ((*
__´•¬e
) (),

1157 (*
__·»Á
) (),

1158 (*
__chd
è()è
__THROW
;

1161 #ifdeà
__USE_EXTERN_INLINES


1163 
__ex‹º_šlše
 

1164 
	`__NTH
 (
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
))

1166  
__th»ad1
 =ğ
__th»ad2
;

1167 
	}
}

1170 
	g__END_DECLS


	@/usr/include/signal.h

22 #iâdef 
_SIGNAL_H


24 #ià!
defšed
 
__Ãed_sig_©omic_t
 && !defšed 
__Ãed_sig£t_t


25 
	#_SIGNAL_H


	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


32 
	~<b™s/sig£t.h
>

36 #ià
defšed
 
__Ãed_sig_©omic_t
 || defšed 
_SIGNAL_H


37 #iâdeà
__sig_©omic_t_defšed


38 
	#__sig_©omic_t_defšed


	)

39 
__BEGIN_NAMESPACE_STD


40 
__sig_©omic_t
 
	tsig_©omic_t
;

41 
	g__END_NAMESPACE_STD


43 #undeà
__Ãed_sig_©omic_t


46 #ià
defšed
 
__Ãed_sig£t_t
 || (defšed 
_SIGNAL_H
 && defšed 
__USE_POSIX
)

47 #iâdeà
__sig£t_t_defšed


48 
	#__sig£t_t_defšed


	)

49 
__sig£t_t
 
	tsig£t_t
;

51 #undeà
__Ãed_sig£t_t


54 #ifdeà
_SIGNAL_H


56 
	~<b™s/ty³s.h
>

57 
	~<b™s/signum.h
>

59 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


60 #iâdeà
__pid_t_defšed


61 
__pid_t
 
	tpid_t
;

62 
	#__pid_t_defšed


	)

64 #ifdeà
__USE_XOPEN


66 #iâdeà
__uid_t_defšed


67 
__uid_t
 
	tuid_t
;

68 
	#__uid_t_defšed


	)

72 #ifdeà
__USE_POSIX199309


74 
	#__Ãed_time¥ec


	)

75 
	~<time.h
>

78 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_XOPEN_EXTENDED


80 
	~<b™s/sigšfo.h
>

85 (*
	t__sighªdËr_t
) ();

90 
__sighªdËr_t
 
	$__sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

91 
__THROW
;

92 #ifdeà
__USE_GNU


93 
__sighªdËr_t
 
	$sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

94 
__THROW
;

100 
__BEGIN_NAMESPACE_STD


101 #ifdeà
__USE_BSD


102 
__sighªdËr_t
 
	$sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

103 
__THROW
;

106 #ifdeà
__REDIRECT_NTH


107 
__sighªdËr_t
 
	`__REDIRECT_NTH
 (
sigÇl
,

108 (
__sig
, 
__sighªdËr_t
 
__hªdËr
),

109 
__sysv_sigÇl
);

111 
	#sigÇl
 
__sysv_sigÇl


	)

114 
__END_NAMESPACE_STD


116 #ifdeà
__USE_XOPEN


119 
__sighªdËr_t
 
	$bsd_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

120 
__THROW
;

126 #ifdeà
__USE_POSIX


127 
	$kl
 (
__pid_t
 
__pid
, 
__sig
è
__THROW
;

130 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


134 
	$kÍg
 (
__pid_t
 
__pg½
, 
__sig
è
__THROW
;

137 
__BEGIN_NAMESPACE_STD


139 
	$¿i£
 (
__sig
è
__THROW
;

140 
__END_NAMESPACE_STD


142 #ifdeà
__USE_SVID


144 
__sighªdËr_t
 
	$ssigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

145 
__THROW
;

146 
	$gsigÇl
 (
__sig
è
__THROW
;

149 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN2K


151 
	`psigÇl
 (
__sig
, cÚ¡ *
__s
);

154 #ifdeà
__USE_XOPEN2K


156 
	`psigšfo
 (cÚ¡ 
sigšfo_t
 *
__pšfo
, cÚ¡ *
__s
);

167 
	`__sig·u£
 (
__sig_Ü_mask
, 
__is_sig
);

169 #ifdeà
__USE_XOPEN


170 #ifdeà
__GNUC__


171 
	$sig·u£
 (
__sig
è
	`__asm__
 ("__xpg_sigpause");

174 
	#sig·u£
(
sig
è
	`__sig·u£
 ((sig), 1)

	)

179 #ifdeà
__USE_BSD


186 
	#sigmask
(
sig
è
	`__sigmask
(sig)

	)

189 
	$sigblock
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

192 
	$sig£tmask
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

195 
	$sigg‘mask
 (è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

199 #ifdeà
__USE_MISC


200 
	#NSIG
 
_NSIG


	)

203 #ifdeà
__USE_GNU


204 
__sighªdËr_t
 
	tsighªdËr_t
;

208 #ifdeà
__USE_BSD


209 
__sighªdËr_t
 
	tsig_t
;

212 #ifdeà
__USE_POSIX


215 
	$sigem±y£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

218 
	$sigfl£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

221 
	$sigadd£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

224 
	$sigd–£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

227 
	$sigismemb”
 (cÚ¡ 
sig£t_t
 *
__£t
, 
__signo
)

228 
__THROW
 
	`__nÚnuÎ
 ((1));

230 #ifdeà
__USE_GNU


232 
	$sigi£m±y£t
 (cÚ¡ 
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

235 
	$sigªd£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

236 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

239 
	$sigÜ£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

240 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

245 
	~<b™s/sigaùiÚ.h
>

248 
	$sig´ocmask
 (
__how
, cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

249 
sig£t_t
 *
__»¡riù
 
__o£t
è
__THROW
;

256 
	$sigsu¥’d
 (cÚ¡ 
sig£t_t
 *
__£t
è
	`__nÚnuÎ
 ((1));

259 
	$sigaùiÚ
 (
__sig
, cÚ¡ 
sigaùiÚ
 *
__»¡riù
 
__aù
,

260 
sigaùiÚ
 *
__»¡riù
 
__ßù
è
__THROW
;

263 
	$sig³ndšg
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

270 
	$sigwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
, *__»¡riù 
__sig
)

271 
	`__nÚnuÎ
 ((1, 2));

273 #ifdeà
__USE_POSIX199309


278 
	$sigwa™šfo
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

279 
sigšfo_t
 *
__»¡riù
 
__šfo
è
	`__nÚnuÎ
 ((1));

286 
	$sigtimedwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

287 
sigšfo_t
 *
__»¡riù
 
__šfo
,

288 cÚ¡ 
time¥ec
 *
__»¡riù
 
__timeout
)

289 
	`__nÚnuÎ
 ((1));

293 
	$sigqueue
 (
__pid_t
 
__pid
, 
__sig
, cÚ¡ 
sigv®
 
__v®
)

294 
__THROW
;

299 #ifdeà
__USE_BSD


303 cÚ¡ *cÚ¡ 
_sys_sigli¡
[
_NSIG
];

304 cÚ¡ *cÚ¡ 
sys_sigli¡
[
_NSIG
];

307 
	ssigvec


309 
__sighªdËr_t
 
sv_hªdËr
;

310 
sv_mask
;

312 
sv_æags
;

313 
	#sv_Ú¡ack
 
sv_æags


	)

317 
	#SV_ONSTACK
 (1 << 0)

	)

318 
	#SV_INTERRUPT
 (1 << 1)

	)

319 
	#SV_RESETHAND
 (1 << 2)

	)

327 
	$sigvec
 (
__sig
, cÚ¡ 
sigvec
 *
__vec
,

328 
sigvec
 *
__ovec
è
__THROW
;

332 
	~<b™s/sigcÚ‹xt.h
>

335 
	$sig»tuº
 (
sigcÚ‹xt
 *
__sı
è
__THROW
;

340 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


341 
	#__Ãed_size_t


	)

342 
	~<¡ddef.h
>

347 
	$sigš‹¼u±
 (
__sig
, 
__š‹¼u±
è
__THROW
;

349 
	~<b™s/sig¡ack.h
>

350 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


352 
	~<sys/ucÚ‹xt.h
>

358 
	$sig¡ack
 (
sig¡ack
 *
__ss
, sig¡ack *
__oss
)

359 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

363 
	$sig®t¡ack
 (cÚ¡ 
sig®t¡ack
 *
__»¡riù
 
__ss
,

364 
sig®t¡ack
 *
__»¡riù
 
__oss
è
__THROW
;

368 #ifdeà
__USE_XOPEN_EXTENDED


372 
	$sighŞd
 (
__sig
è
__THROW
;

375 
	$sig»l£
 (
__sig
è
__THROW
;

378 
	$sigignÜe
 (
__sig
è
__THROW
;

381 
__sighªdËr_t
 
	$sig£t
 (
__sig
, 
__sighªdËr_t
 
__di¥
è
__THROW
;

384 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


387 
	~<b™s/±h»adty³s.h
>

388 
	~<b™s/sigth»ad.h
>

395 
	$__libc_cu¼’t_sig¹mš
 (è
__THROW
;

397 
	$__libc_cu¼’t_sig¹max
 (è
__THROW
;

401 
__END_DECLS


	@/usr/include/stdint.h

22 #iâdeà
_STDINT_H


23 
	#_STDINT_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/wch¬.h
>

27 
	~<b™s/wÜdsize.h
>

34 #iâdeà
__št8_t_defšed


35 
	#__št8_t_defšed


	)

36 sigÃd 
	tšt8_t
;

37 
	tšt16_t
;

38 
	tšt32_t
;

39 #ià
__WORDSIZE
 == 64

40 
	tšt64_t
;

42 
__ex‹nsiÚ__


43 
	tšt64_t
;

48 
	tušt8_t
;

49 
	tušt16_t
;

50 #iâdeà
__ušt32_t_defšed


51 
	tušt32_t
;

52 
	#__ušt32_t_defšed


	)

54 #ià
__WORDSIZE
 == 64

55 
	tušt64_t
;

57 
__ex‹nsiÚ__


58 
	tušt64_t
;

65 sigÃd 
	tšt_Ëa¡8_t
;

66 
	tšt_Ëa¡16_t
;

67 
	tšt_Ëa¡32_t
;

68 #ià
__WORDSIZE
 == 64

69 
	tšt_Ëa¡64_t
;

71 
__ex‹nsiÚ__


72 
	tšt_Ëa¡64_t
;

76 
	tušt_Ëa¡8_t
;

77 
	tušt_Ëa¡16_t
;

78 
	tušt_Ëa¡32_t
;

79 #ià
__WORDSIZE
 == 64

80 
	tušt_Ëa¡64_t
;

82 
__ex‹nsiÚ__


83 
	tušt_Ëa¡64_t
;

90 sigÃd 
	tšt_ç¡8_t
;

91 #ià
__WORDSIZE
 == 64

92 
	tšt_ç¡16_t
;

93 
	tšt_ç¡32_t
;

94 
	tšt_ç¡64_t
;

96 
	tšt_ç¡16_t
;

97 
	tšt_ç¡32_t
;

98 
__ex‹nsiÚ__


99 
	tšt_ç¡64_t
;

103 
	tušt_ç¡8_t
;

104 #ià
__WORDSIZE
 == 64

105 
	tušt_ç¡16_t
;

106 
	tušt_ç¡32_t
;

107 
	tušt_ç¡64_t
;

109 
	tušt_ç¡16_t
;

110 
	tušt_ç¡32_t
;

111 
__ex‹nsiÚ__


112 
	tušt_ç¡64_t
;

117 #ià
__WORDSIZE
 == 64

118 #iâdeà
__šŒ_t_defšed


119 
	tšŒ_t
;

120 
	#__šŒ_t_defšed


	)

122 
	tušŒ_t
;

124 #iâdeà
__šŒ_t_defšed


125 
	tšŒ_t
;

126 
	#__šŒ_t_defšed


	)

128 
	tušŒ_t
;

133 #ià
__WORDSIZE
 == 64

134 
	tštmax_t
;

135 
	tuštmax_t
;

137 
__ex‹nsiÚ__


138 
	tštmax_t
;

139 
__ex‹nsiÚ__


140 
	tuštmax_t
;

144 #ià
__WORDSIZE
 == 64

145 
	#__INT64_C
(
c
èø## 
L


	)

146 
	#__UINT64_C
(
c
èø## 
UL


	)

148 
	#__INT64_C
(
c
èø## 
LL


	)

149 
	#__UINT64_C
(
c
èø## 
ULL


	)

155 
	#INT8_MIN
 (-128)

	)

156 
	#INT16_MIN
 (-32767-1)

	)

157 
	#INT32_MIN
 (-2147483647-1)

	)

158 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

160 
	#INT8_MAX
 (127)

	)

161 
	#INT16_MAX
 (32767)

	)

162 
	#INT32_MAX
 (2147483647)

	)

163 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

166 
	#UINT8_MAX
 (255)

	)

167 
	#UINT16_MAX
 (65535)

	)

168 
	#UINT32_MAX
 (4294967295U)

	)

169 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

173 
	#INT_LEAST8_MIN
 (-128)

	)

174 
	#INT_LEAST16_MIN
 (-32767-1)

	)

175 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

176 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

178 
	#INT_LEAST8_MAX
 (127)

	)

179 
	#INT_LEAST16_MAX
 (32767)

	)

180 
	#INT_LEAST32_MAX
 (2147483647)

	)

181 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

184 
	#UINT_LEAST8_MAX
 (255)

	)

185 
	#UINT_LEAST16_MAX
 (65535)

	)

186 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

187 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

191 
	#INT_FAST8_MIN
 (-128)

	)

192 #ià
__WORDSIZE
 == 64

193 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

194 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

196 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

197 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

199 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

201 
	#INT_FAST8_MAX
 (127)

	)

202 #ià
__WORDSIZE
 == 64

203 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

204 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

206 
	#INT_FAST16_MAX
 (2147483647)

	)

207 
	#INT_FAST32_MAX
 (2147483647)

	)

209 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

212 
	#UINT_FAST8_MAX
 (255)

	)

213 #ià
__WORDSIZE
 == 64

214 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

215 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

217 
	#UINT_FAST16_MAX
 (4294967295U)

	)

218 
	#UINT_FAST32_MAX
 (4294967295U)

	)

220 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

224 #ià
__WORDSIZE
 == 64

225 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

226 
	#INTPTR_MAX
 (9223372036854775807L)

	)

227 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

229 
	#INTPTR_MIN
 (-2147483647-1)

	)

230 
	#INTPTR_MAX
 (2147483647)

	)

231 
	#UINTPTR_MAX
 (4294967295U)

	)

236 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

238 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

241 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

247 #ià
__WORDSIZE
 == 64

248 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

249 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

251 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

252 
	#PTRDIFF_MAX
 (2147483647)

	)

256 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

257 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

260 #ià
__WORDSIZE
 == 64

261 
	#SIZE_MAX
 (18446744073709551615UL)

	)

263 
	#SIZE_MAX
 (4294967295U)

	)

267 #iâdeà
WCHAR_MIN


269 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

270 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

274 
	#WINT_MIN
 (0u)

	)

275 
	#WINT_MAX
 (4294967295u)

	)

278 
	#INT8_C
(
c
è
	)
c

279 
	#INT16_C
(
c
è
	)
c

280 
	#INT32_C
(
c
è
	)
c

281 #ià
__WORDSIZE
 == 64

282 
	#INT64_C
(
c
èø## 
L


	)

284 
	#INT64_C
(
c
èø## 
LL


	)

288 
	#UINT8_C
(
c
è
	)
c

289 
	#UINT16_C
(
c
è
	)
c

290 
	#UINT32_C
(
c
èø## 
U


	)

291 #ià
__WORDSIZE
 == 64

292 
	#UINT64_C
(
c
èø## 
UL


	)

294 
	#UINT64_C
(
c
èø## 
ULL


	)

298 #ià
__WORDSIZE
 == 64

299 
	#INTMAX_C
(
c
èø## 
L


	)

300 
	#UINTMAX_C
(
c
èø## 
UL


	)

302 
	#INTMAX_C
(
c
èø## 
LL


	)

303 
	#UINTMAX_C
(
c
èø## 
ULL


	)

	@/usr/include/stdio.h

23 #iâdeà
_STDIO_H


25 #ià!
defšed
 
__Ãed_FILE
 && !defšed 
__Ãed___FILE


26 
	#_STDIO_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	~<b™s/ty³s.h
>

36 
	#__Ãed_FILE


	)

37 
	#__Ãed___FILE


	)

41 #ià!
defšed
 
__FILE_defšed
 && defšed 
__Ãed_FILE


44 
	g_IO_FILE
;

46 
__BEGIN_NAMESPACE_STD


48 
_IO_FILE
 
	tFILE
;

49 
	g__END_NAMESPACE_STD


50 #ià
defšed
 
__USE_LARGEFILE64
 || defšed 
__USE_SVID
 || defšed 
__USE_POSIX
 \

51 || 
defšed
 
	g__USE_BSD
 || defšed 
	g__USE_ISOC99
 || defšed 
	g__USE_XOPEN
 \

52 || 
defšed
 
__USE_POSIX2


53 
	$__USING_NAMESPACE_STD
(
FILE
)

56 
	#__FILE_defšed
 1

	)

58 #undeà
__Ãed_FILE


61 #ià!
defšed
 
____FILE_defšed
 && defšed 
__Ãed___FILE


64 
_IO_FILE
 
	t__FILE
;

66 
	#____FILE_defšed
 1

	)

68 #undeà
__Ãed___FILE


71 #ifdef 
_STDIO_H


72 
	#_STDIO_USES_IOSTREAM


	)

74 
	~<libio.h
>

76 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


77 #ifdeà
__GNUC__


78 #iâdeà
_VA_LIST_DEFINED


79 
_G_va_li¡
 
	tva_li¡
;

80 
	#_VA_LIST_DEFINED


	)

83 
	~<¡d¬g.h
>

87 #ifdeà
__USE_XOPEN2K8


88 #iâdeà
__off_t_defšed


89 #iâdeà
__USE_FILE_OFFSET64


90 
__off_t
 
	toff_t
;

92 
__off64_t
 
	toff_t
;

94 
	#__off_t_defšed


	)

96 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


97 
__off64_t
 
	toff64_t
;

98 
	#__off64_t_defšed


	)

101 #iâdeà
__ssize_t_defšed


102 
__ssize_t
 
	tssize_t
;

103 
	#__ssize_t_defšed


	)

108 
__BEGIN_NAMESPACE_STD


109 #iâdeà
__USE_FILE_OFFSET64


110 
_G_åos_t
 
	tåos_t
;

112 
_G_åos64_t
 
	tåos_t
;

114 
__END_NAMESPACE_STD


115 #ifdeà
__USE_LARGEFILE64


116 
_G_åos64_t
 
	tåos64_t
;

120 
	#_IOFBF
 0

	)

121 
	#_IOLBF
 1

	)

122 
	#_IONBF
 2

	)

126 #iâdeà
BUFSIZ


127 
	#BUFSIZ
 
_IO_BUFSIZ


	)

133 #iâdeà
EOF


134 
	#EOF
 (-1)

	)

140 
	#SEEK_SET
 0

	)

141 
	#SEEK_CUR
 1

	)

142 
	#SEEK_END
 2

	)

143 #ifdeà
__USE_GNU


144 
	#SEEK_DATA
 3

	)

145 
	#SEEK_HOLE
 4

	)

149 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


151 
	#P_tmpdœ
 "/tmp"

	)

164 
	~<b™s/¡dio_lim.h
>

168 
_IO_FILE
 *
¡dš
;

169 
_IO_FILE
 *
¡dout
;

170 
_IO_FILE
 *
¡d”r
;

172 
	#¡dš
 
¡dš


	)

173 
	#¡dout
 
¡dout


	)

174 
	#¡d”r
 
¡d”r


	)

176 
__BEGIN_NAMESPACE_STD


178 
	$»move
 (cÚ¡ *
__f’ame
è
__THROW
;

180 
	$»Çme
 (cÚ¡ *
__Şd
, cÚ¡ *
__Ãw
è
__THROW
;

181 
__END_NAMESPACE_STD


183 #ifdeà
__USE_ATFILE


185 
	$»Çm—t
 (
__Şdfd
, cÚ¡ *
__Şd
, 
__Ãwfd
,

186 cÚ¡ *
__Ãw
è
__THROW
;

189 
__BEGIN_NAMESPACE_STD


194 #iâdeà
__USE_FILE_OFFSET64


195 
FILE
 *
	$tmpfe
 (è
__wur
;

197 #ifdeà
__REDIRECT


198 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

200 
	#tmpfe
 
tmpfe64


	)

204 #ifdeà
__USE_LARGEFILE64


205 
FILE
 *
	$tmpfe64
 (è
__wur
;

209 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

210 
__END_NAMESPACE_STD


212 #ifdeà
__USE_MISC


215 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

219 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


227 *
	$‹m²am
 (cÚ¡ *
__dœ
, cÚ¡ *
__pfx
)

228 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

232 
__BEGIN_NAMESPACE_STD


237 
	`fşo£
 (
FILE
 *
__¡»am
);

242 
	`fæush
 (
FILE
 *
__¡»am
);

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_MISC


252 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

255 #ifdeà
__USE_GNU


262 
	`fşo£®l
 ();

266 
__BEGIN_NAMESPACE_STD


267 #iâdeà
__USE_FILE_OFFSET64


272 
FILE
 *
	$fİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

273 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

278 
FILE
 *
	$äeİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

279 cÚ¡ *
__»¡riù
 
__modes
,

280 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

282 #ifdeà
__REDIRECT


283 
FILE
 *
	`__REDIRECT
 (
fİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

284 cÚ¡ *
__»¡riù
 
__modes
), 
fİ’64
)

285 
__wur
;

286 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

287 cÚ¡ *
__»¡riù
 
__modes
,

288 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

289 
__wur
;

291 
	#fİ’
 
fİ’64


	)

292 
	#äeİ’
 
äeİ’64


	)

295 
__END_NAMESPACE_STD


296 #ifdeà
__USE_LARGEFILE64


297 
FILE
 *
	$fİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

298 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

299 
FILE
 *
	$äeİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

300 cÚ¡ *
__»¡riù
 
__modes
,

301 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

304 #ifdef 
__USE_POSIX


306 
FILE
 *
	$fdİ’
 (
__fd
, cÚ¡ *
__modes
è
__THROW
 
__wur
;

309 #ifdef 
__USE_GNU


312 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

313 cÚ¡ *
__»¡riù
 
__modes
,

314 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

317 #ifdeà
__USE_XOPEN2K8


319 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, cÚ¡ *
__modes
)

320 
__THROW
 
__wur
;

325 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

329 
__BEGIN_NAMESPACE_STD


332 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

336 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

337 
__modes
, 
size_t
 
__n
è
__THROW
;

338 
__END_NAMESPACE_STD


340 #ifdef 
__USE_BSD


343 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

344 
size_t
 
__size
è
__THROW
;

347 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

351 
__BEGIN_NAMESPACE_STD


356 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

357 cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

362 
	`´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

364 
	$¥rštf
 (*
__»¡riù
 
__s
,

365 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROWNL
;

371 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

372 
_G_va_li¡
 
__¬g
);

377 
	`v´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

379 
	$v¥rštf
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

380 
_G_va_li¡
 
__¬g
è
__THROWNL
;

381 
__END_NAMESPACE_STD


383 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_ISOC99
 || defšed 
__USE_UNIX98


384 
__BEGIN_NAMESPACE_C99


386 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

387 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

388 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

390 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

391 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

392 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

393 
__END_NAMESPACE_C99


396 #ifdeà
__USE_GNU


399 
	$va¥rštf
 (**
__»¡riù
 
__±r
, cÚ¡ *__»¡riù 
__f
,

400 
_G_va_li¡
 
__¬g
)

401 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

402 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

403 cÚ¡ *
__»¡riù
 
__fmt
, ...)

404 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

405 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

406 cÚ¡ *
__»¡riù
 
__fmt
, ...)

407 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

410 #ifdeà
__USE_XOPEN2K8


412 
	$vd´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
,

413 
_G_va_li¡
 
__¬g
)

414 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

415 
	$d´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
, ...)

416 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

420 
__BEGIN_NAMESPACE_STD


425 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

426 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

431 
	$sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

433 
	$ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

434 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

436 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

437 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

438 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

439 #ifdeà
__REDIRECT


443 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

444 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

445 
__isoc99_fsÿnf
è
__wur
;

446 
	`__REDIRECT
 (
sÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

447 
__isoc99_sÿnf
è
__wur
;

448 
	`__REDIRECT_NTH
 (
ssÿnf
, (cÚ¡ *
__»¡riù
 
__s
,

449 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

450 
__isoc99_ssÿnf
);

452 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

453 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

454 
	$__isoc99_sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

455 
	$__isoc99_ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

456 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

457 
	#fsÿnf
 
__isoc99_fsÿnf


	)

458 
	#sÿnf
 
__isoc99_sÿnf


	)

459 
	#ssÿnf
 
__isoc99_ssÿnf


	)

463 
__END_NAMESPACE_STD


465 #ifdef 
__USE_ISOC99


466 
__BEGIN_NAMESPACE_C99


471 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

472 
_G_va_li¡
 
__¬g
)

473 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

479 
	$vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

480 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

483 
	$vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

484 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

485 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

487 #ià!
defšed
 
__USE_GNU
 \

488 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

489 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

490 #ifdeà
__REDIRECT


494 
	`__REDIRECT
 (
vfsÿnf
,

495 (
FILE
 *
__»¡riù
 
__s
,

496 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

497 
__isoc99_vfsÿnf
)

498 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

499 
	`__REDIRECT
 (
vsÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
,

500 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

501 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

502 
	`__REDIRECT_NTH
 (
vssÿnf
,

503 (cÚ¡ *
__»¡riù
 
__s
,

504 cÚ¡ *
__»¡riù
 
__fÜm©
,

505 
_G_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

506 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

508 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

509 cÚ¡ *
__»¡riù
 
__fÜm©
,

510 
_G_va_li¡
 
__¬g
è
__wur
;

511 
	$__isoc99_vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
,

512 
_G_va_li¡
 
__¬g
è
__wur
;

513 
	$__isoc99_vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

514 cÚ¡ *
__»¡riù
 
__fÜm©
,

515 
_G_va_li¡
 
__¬g
è
__THROW
;

516 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

517 
	#vsÿnf
 
__isoc99_vsÿnf


	)

518 
	#vssÿnf
 
__isoc99_vssÿnf


	)

522 
__END_NAMESPACE_C99


526 
__BEGIN_NAMESPACE_STD


531 
	`fg‘c
 (
FILE
 *
__¡»am
);

532 
	`g‘c
 (
FILE
 *
__¡»am
);

538 
	`g‘ch¬
 ();

539 
__END_NAMESPACE_STD


543 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

545 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


550 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

551 
	`g‘ch¬_uÆocked
 ();

554 #ifdeà
__USE_MISC


561 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

565 
__BEGIN_NAMESPACE_STD


573 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

574 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

580 
	`putch¬
 (
__c
);

581 
__END_NAMESPACE_STD


585 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

587 #ifdeà
__USE_MISC


594 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

597 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


602 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

603 
	`putch¬_uÆocked
 (
__c
);

607 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 \

608 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

610 
	`g‘w
 (
FILE
 *
__¡»am
);

613 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

617 
__BEGIN_NAMESPACE_STD


622 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

623 
__wur
;

625 #ià!
defšed
 
__USE_ISOC11
 \

626 || (
defšed
 
__ılu¥lus
 && __cplusplus <= 201103L)

638 *
	$g‘s
 (*
__s
è
__wur
 
__©Œibu‹_d•»ÿ‹d__
;

640 
__END_NAMESPACE_STD


642 #ifdeà
__USE_GNU


649 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

650 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

654 #ifdef 
__USE_XOPEN2K8


665 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

666 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

667 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

668 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

669 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

670 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

678 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

679 
size_t
 *
__»¡riù
 
__n
,

680 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

684 
__BEGIN_NAMESPACE_STD


689 
	`åuts
 (cÚ¡ *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

695 
	`puts
 (cÚ¡ *
__s
);

702 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

709 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

710 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

715 
size_t
 
	`fwr™e
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

716 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

717 
__END_NAMESPACE_STD


719 #ifdeà
__USE_GNU


726 
	`åuts_uÆocked
 (cÚ¡ *
__»¡riù
 
__s
,

727 
FILE
 *
__»¡riù
 
__¡»am
);

730 #ifdeà
__USE_MISC


737 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

738 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

739 
size_t
 
	`fwr™e_uÆocked
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

740 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

744 
__BEGIN_NAMESPACE_STD


749 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

754 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

759 
	`»wšd
 (
FILE
 *
__¡»am
);

760 
__END_NAMESPACE_STD


767 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


768 #iâdeà
__USE_FILE_OFFSET64


773 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

778 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

780 #ifdeà
__REDIRECT


781 
	`__REDIRECT
 (
f£eko
,

782 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

783 
f£eko64
);

784 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

786 
	#f£eko
 
f£eko64


	)

787 
	#á–lo
 
á–lo64


	)

792 
__BEGIN_NAMESPACE_STD


793 #iâdeà
__USE_FILE_OFFSET64


798 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

803 
	`f£os
 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
);

805 #ifdeà
__REDIRECT


806 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

807 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

808 
	`__REDIRECT
 (
f£os
,

809 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
), 
f£os64
);

811 
	#fg‘pos
 
fg‘pos64


	)

812 
	#f£os
 
f£os64


	)

815 
__END_NAMESPACE_STD


817 #ifdeà
__USE_LARGEFILE64


818 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

819 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

820 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

821 
	`f£os64
 (
FILE
 *
__¡»am
, cÚ¡ 
åos64_t
 *
__pos
);

824 
__BEGIN_NAMESPACE_STD


826 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

828 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

830 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

831 
__END_NAMESPACE_STD


833 #ifdeà
__USE_MISC


835 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

836 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

837 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

841 
__BEGIN_NAMESPACE_STD


846 
	`³¼Ü
 (cÚ¡ *
__s
);

847 
__END_NAMESPACE_STD


853 
	~<b™s/sys_”¾i¡.h
>

856 #ifdef 
__USE_POSIX


858 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

861 #ifdeà
__USE_MISC


863 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

867 #ià(
defšed
 
__USE_POSIX2
 || defšed 
__USE_SVID
 || defšed 
__USE_BSD
 || \

868 
defšed
 
__USE_MISC
)

873 
FILE
 *
	$pİ’
 (cÚ¡ *
__commªd
, cÚ¡ *
__modes
è
__wur
;

879 
	`pşo£
 (
FILE
 *
__¡»am
);

883 #ifdef 
__USE_POSIX


885 *
	$ù”mid
 (*
__s
è
__THROW
;

889 #ifdeà
__USE_XOPEN


891 *
	`cu£rid
 (*
__s
);

895 #ifdef 
__USE_GNU


896 
ob¡ack
;

899 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

900 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

901 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

902 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

903 cÚ¡ *
__»¡riù
 
__fÜm©
,

904 
_G_va_li¡
 
__¬gs
)

905 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

909 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


913 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

917 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

920 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

923 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


927 
	#__Ãed_g‘İt


	)

928 
	~<g‘İt.h
>

933 #ifdeà
__USE_EXTERN_INLINES


934 
	~<b™s/¡dio.h
>

936 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


937 
	~<b™s/¡dio2.h
>

939 #ifdeà
__LDBL_COMPAT


940 
	~<b™s/¡dio-ldbl.h
>

943 
__END_DECLS


	@/usr/include/stdlib.h

22 #iâdef 
_STDLIB_H


24 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


29 
	#__Ãed_wch¬_t


	)

30 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

34 
	g__BEGIN_DECLS


36 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


37 
	#_STDLIB_H
 1

	)

39 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


41 
	~<b™s/wa™æags.h
>

42 
	~<b™s/wa™¡©us.h
>

44 #ifdeà
__USE_BSD


49 #ià
defšed
 
__GNUC__
 && !defšed 
__ılu¥lus


50 
	#__WAIT_INT
(
¡©us
) \

51 (
	`__ex‹nsiÚ__
 (((uniÚ { 
	`__ty³of
(
¡©us
è
__š
; 
__i
; }) \

52 { .
__š
 = (
¡©us
è}).
__i
))

	)

54 
	#__WAIT_INT
(
¡©us
è(*(*è&(¡©us))

	)

62 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2 || defšed 
__ılu¥lus


63 
	#__WAIT_STATUS
 *

	)

64 
	#__WAIT_STATUS_DEFN
 *

	)

69 
wa™
 *
	m__u±r
;

70 *
	m__Œ
;

71 } 
	t__WAIT_STATUS
 
	t__©Œibu‹__
 ((
	t__Œª¥¬’t_uniÚ__
));

72 
	#__WAIT_STATUS_DEFN
 *

	)

77 
	#__WAIT_INT
(
¡©us
è(¡©us)

	)

78 
	#__WAIT_STATUS
 *

	)

79 
	#__WAIT_STATUS_DEFN
 *

	)

84 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (
	`__WAIT_INT
 (¡©us))

	)

85 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (
	`__WAIT_INT
 (¡©us))

	)

86 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (
	`__WAIT_INT
 (¡©us))

	)

87 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (
	`__WAIT_INT
 (¡©us))

	)

88 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (
	`__WAIT_INT
 (¡©us))

	)

89 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (
	`__WAIT_INT
 (¡©us))

	)

90 #ifdeà
__WIFCONTINUED


91 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (
	`__WAIT_INT
 (¡©us))

	)

95 
__BEGIN_NAMESPACE_STD


99 
	mquÙ
;

100 
	m»m
;

101 } 
	tdiv_t
;

104 #iâdeà
__ldiv_t_defšed


107 
	mquÙ
;

108 
	m»m
;

109 } 
	tldiv_t
;

110 
	#__ldiv_t_defšed
 1

	)

112 
	g__END_NAMESPACE_STD


114 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


115 
__BEGIN_NAMESPACE_C99


117 
__ex‹nsiÚ__
 struct

119 
	mquÙ
;

120 
	m»m
;

121 } 
	tÎdiv_t
;

122 
	#__Îdiv_t_defšed
 1

	)

123 
	g__END_NAMESPACE_C99


128 
	#RAND_MAX
 2147483647

	)

133 
	#EXIT_FAILURE
 1

	)

134 
	#EXIT_SUCCESS
 0

	)

138 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

139 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

142 
__BEGIN_NAMESPACE_STD


144 
	$©of
 (cÚ¡ *
__ÅŒ
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

147 
	$©oi
 (cÚ¡ *
__ÅŒ
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

150 
	$©Ş
 (cÚ¡ *
__ÅŒ
)

151 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

152 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_MISC


155 
__BEGIN_NAMESPACE_C99


157 
__ex‹nsiÚ__
 
	$©Şl
 (cÚ¡ *
__ÅŒ
)

158 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

159 
__END_NAMESPACE_C99


162 
__BEGIN_NAMESPACE_STD


164 
	$¡¹od
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

165 **
__»¡riù
 
__’d±r
)

166 
__THROW
 
	`__nÚnuÎ
 ((1));

167 
__END_NAMESPACE_STD


169 #ifdef 
__USE_ISOC99


170 
__BEGIN_NAMESPACE_C99


172 
	$¡¹of
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

173 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1));

175 
	$¡¹Şd
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

176 **
__»¡riù
 
__’d±r
)

177 
__THROW
 
	`__nÚnuÎ
 ((1));

178 
__END_NAMESPACE_C99


181 
__BEGIN_NAMESPACE_STD


183 
	$¡¹Ş
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

184 **
__»¡riù
 
__’d±r
, 
__ba£
)

185 
__THROW
 
	`__nÚnuÎ
 ((1));

187 
	$¡¹oul
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

188 **
__»¡riù
 
__’d±r
, 
__ba£
)

189 
__THROW
 
	`__nÚnuÎ
 ((1));

190 
__END_NAMESPACE_STD


192 #ifdeà
__USE_BSD


194 
__ex‹nsiÚ__


195 
	$¡¹oq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

196 **
__»¡riù
 
__’d±r
, 
__ba£
)

197 
__THROW
 
	`__nÚnuÎ
 ((1));

199 
__ex‹nsiÚ__


200 
	$¡¹ouq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

201 **
__»¡riù
 
__’d±r
, 
__ba£
)

202 
__THROW
 
	`__nÚnuÎ
 ((1));

205 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_MISC


206 
__BEGIN_NAMESPACE_C99


208 
__ex‹nsiÚ__


209 
	$¡¹Şl
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

210 **
__»¡riù
 
__’d±r
, 
__ba£
)

211 
__THROW
 
	`__nÚnuÎ
 ((1));

213 
__ex‹nsiÚ__


214 
	$¡¹ouÎ
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

215 **
__»¡riù
 
__’d±r
, 
__ba£
)

216 
__THROW
 
	`__nÚnuÎ
 ((1));

217 
__END_NAMESPACE_C99


221 #ifdeà
__USE_GNU


235 
	~<xloÿË.h
>

239 
	$¡¹Ş_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

240 **
__»¡riù
 
__’d±r
, 
__ba£
,

241 
__loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4));

243 
	$¡¹oul_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

244 **
__»¡riù
 
__’d±r
,

245 
__ba£
, 
__loÿË_t
 
__loc
)

246 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

248 
__ex‹nsiÚ__


249 
	$¡¹Şl_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

250 **
__»¡riù
 
__’d±r
, 
__ba£
,

251 
__loÿË_t
 
__loc
)

252 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

254 
__ex‹nsiÚ__


255 
	$¡¹ouÎ_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

256 **
__»¡riù
 
__’d±r
,

257 
__ba£
, 
__loÿË_t
 
__loc
)

258 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

260 
	$¡¹od_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

261 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

262 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

264 
	$¡¹of_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

265 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

266 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

268 
	$¡¹Şd_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

269 **
__»¡riù
 
__’d±r
,

270 
__loÿË_t
 
__loc
)

271 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

275 #ifdeà
__USE_EXTERN_INLINES


276 
__BEGIN_NAMESPACE_STD


277 
__ex‹º_šlše
 

278 
	`__NTH
 (
	$©oi
 (cÚ¡ *
__ÅŒ
))

280  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

281 
	}
}

282 
__ex‹º_šlše
 

283 
__NTH
 (
	$©Ş
 (cÚ¡ *
__ÅŒ
))

285  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

286 
	}
}

287 
	g__END_NAMESPACE_STD


289 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_ISOC99


290 
__BEGIN_NAMESPACE_C99


291 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

292 
__NTH
 (
	$©Şl
 (cÚ¡ *
__ÅŒ
))

294  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

295 
	}
}

296 
	g__END_NAMESPACE_C99


301 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN_EXTENDED


305 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

308 
	$a64l
 (cÚ¡ *
__s
)

309 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

313 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_BSD


314 
	~<sys/ty³s.h
>

321 
	$¿ndom
 (è
__THROW
;

324 
	$¤ªdom
 (
__£ed
è
__THROW
;

330 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

331 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

335 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

338 #ifdeà
__USE_MISC


343 
	s¿ndom_d©a


345 
št32_t
 *
åŒ
;

346 
št32_t
 *
½Œ
;

347 
št32_t
 *
¡©e
;

348 
¿nd_ty³
;

349 
¿nd_deg
;

350 
¿nd_£p
;

351 
št32_t
 *
’d_±r
;

354 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

355 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

357 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

358 
__THROW
 
	`__nÚnuÎ
 ((2));

360 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

361 
size_t
 
__¡©–’
,

362 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

363 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

365 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

366 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

367 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

372 
__BEGIN_NAMESPACE_STD


374 
	$¿nd
 (è
__THROW
;

376 
	$¤ªd
 (
__£ed
è
__THROW
;

377 
__END_NAMESPACE_STD


379 #ifdeà
__USE_POSIX


381 
	$¿nd_r
 (*
__£ed
è
__THROW
;

385 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


389 
	$d¿nd48
 (è
__THROW
;

390 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

393 
	$Ìªd48
 (è
__THROW
;

394 
	$Äªd48
 (
__xsubi
[3])

395 
__THROW
 
	`__nÚnuÎ
 ((1));

398 
	$m¿nd48
 (è
__THROW
;

399 
	$j¿nd48
 (
__xsubi
[3])

400 
__THROW
 
	`__nÚnuÎ
 ((1));

403 
	$¤ªd48
 (
__£edv®
è
__THROW
;

404 *
	$£ed48
 (
__£ed16v
[3])

405 
__THROW
 
	`__nÚnuÎ
 ((1));

406 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

408 #ifdeà
__USE_MISC


412 
	sd¿nd48_d©a


414 
__x
[3];

415 
__Şd_x
[3];

416 
__c
;

417 
__š™
;

418 
__ex‹nsiÚ__
 
__a
;

423 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

424 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

425 
	$”ªd48_r
 (
__xsubi
[3],

426 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

427 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

430 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

431 *
__»¡riù
 
__»suÉ
)

432 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

433 
	$Äªd48_r
 (
__xsubi
[3],

434 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

435 *
__»¡riù
 
__»suÉ
)

436 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

439 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

440 *
__»¡riù
 
__»suÉ
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

442 
	$j¿nd48_r
 (
__xsubi
[3],

443 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

444 *
__»¡riù
 
__»suÉ
)

445 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

448 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

449 
__THROW
 
	`__nÚnuÎ
 ((2));

451 
	$£ed48_r
 (
__£ed16v
[3],

452 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$lcÚg48_r
 (
__·¿m
[7],

455 
d¿nd48_d©a
 *
__bufãr
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

462 #iâdeà
__m®loc_ªd_ÿÎoc_defšed


463 
	#__m®loc_ªd_ÿÎoc_defšed


	)

464 
__BEGIN_NAMESPACE_STD


466 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

468 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

469 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

470 
__END_NAMESPACE_STD


473 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


474 
__BEGIN_NAMESPACE_STD


480 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

481 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

483 
	$ä“
 (*
__±r
è
__THROW
;

484 
__END_NAMESPACE_STD


486 #ifdef 
__USE_MISC


488 
	$cä“
 (*
__±r
è
__THROW
;

491 #ià
defšed
 
__USE_GNU
 || defšed 
__USE_BSD
 || defšed 
__USE_MISC


492 
	~<®loÿ.h
>

495 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

496 || 
defšed
 
__USE_BSD


498 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

501 #ifdeà
__USE_XOPEN2K


503 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

504 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

507 #ifdeà
__USE_ISOC11


509 *
	$®igÃd_®loc
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

510 
__THROW
 
__©Œibu‹_m®loc__
 
	`__©Œibu‹_®loc_size__
 ((2)è
__wur
;

513 
__BEGIN_NAMESPACE_STD


515 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

519 
	`©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

521 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


523 #ifdeà
__ılu¥lus


524 "C++" 
	`©_quick_ex™
 ((*
__func
) ())

525 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

527 
	`©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

530 
__END_NAMESPACE_STD


532 #ifdef 
__USE_MISC


535 
	`Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

536 
__THROW
 
	`__nÚnuÎ
 ((1));

539 
__BEGIN_NAMESPACE_STD


543 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

545 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


549 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

551 
__END_NAMESPACE_STD


553 #ifdeà
__USE_ISOC99


554 
__BEGIN_NAMESPACE_C99


557 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

558 
__END_NAMESPACE_C99


562 
__BEGIN_NAMESPACE_STD


564 *
	$g‘’v
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

565 
__END_NAMESPACE_STD


567 #ifdeà
__USE_GNU


570 *
	$£cu»_g‘’v
 (cÚ¡ *
__Çme
)

571 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

574 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


578 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

581 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


584 
	$£‹nv
 (cÚ¡ *
__Çme
, cÚ¡ *
__v®ue
, 
__»¶aû
)

585 
__THROW
 
	`__nÚnuÎ
 ((2));

588 
	$un£‹nv
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

591 #ifdef 
__USE_MISC


595 
	$ş—»nv
 (è
__THROW
;

599 #ià
defšed
 
__USE_MISC
 \

600 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
)

606 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1));

609 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
 \

610 || 
defšed
 
__USE_XOPEN2K8


619 #iâdeà
__USE_FILE_OFFSET64


620 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

622 #ifdeà
__REDIRECT


623 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

624 
	`__nÚnuÎ
 ((1)è
__wur
;

626 
	#mk¡emp
 
mk¡emp64


	)

629 #ifdeà
__USE_LARGEFILE64


630 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

634 #ifdeà
__USE_MISC


641 #iâdeà
__USE_FILE_OFFSET64


642 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

644 #ifdeà
__REDIRECT


645 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

646 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

648 
	#mk¡emps
 
mk¡emps64


	)

651 #ifdeà
__USE_LARGEFILE64


652 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

653 
	`__nÚnuÎ
 ((1)è
__wur
;

657 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K8


663 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

666 #ifdeà
__USE_GNU


673 #iâdeà
__USE_FILE_OFFSET64


674 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

676 #ifdeà
__REDIRECT


677 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

678 
	`__nÚnuÎ
 ((1)è
__wur
;

680 
	#mko¡emp
 
mko¡emp64


	)

683 #ifdeà
__USE_LARGEFILE64


684 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

693 #iâdeà
__USE_FILE_OFFSET64


694 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

695 
	`__nÚnuÎ
 ((1)è
__wur
;

697 #ifdeà
__REDIRECT


698 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

699 
__æags
), 
mko¡emps64
)

700 
	`__nÚnuÎ
 ((1)è
__wur
;

702 
	#mko¡emps
 
mko¡emps64


	)

705 #ifdeà
__USE_LARGEFILE64


706 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

707 
	`__nÚnuÎ
 ((1)è
__wur
;

712 
__BEGIN_NAMESPACE_STD


717 
	$sy¡em
 (cÚ¡ *
__commªd
è
__wur
;

718 
__END_NAMESPACE_STD


721 #ifdef 
__USE_GNU


724 *
	$ÿnÚiÿlize_fe_Çme
 (cÚ¡ *
__Çme
)

725 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

728 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


734 *
	$»®·th
 (cÚ¡ *
__»¡riù
 
__Çme
,

735 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

740 #iâdeà
__COMPAR_FN_T


741 
	#__COMPAR_FN_T


	)

742 (*
	t__com·r_â_t
) (const *, const *);

744 #ifdef 
__USE_GNU


745 
__com·r_â_t
 
	tcom·risÚ_â_t
;

748 #ifdeà
__USE_GNU


749 (*
	t__com·r_d_â_t
) (const *, const *, *);

752 
__BEGIN_NAMESPACE_STD


755 *
	$b£¬ch
 (cÚ¡ *
__key
, cÚ¡ *
__ba£
,

756 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

757 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

759 #ifdeà
__USE_EXTERN_INLINES


760 
	~<b™s/¡dlib-b£¬ch.h
>

765 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

766 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

767 #ifdeà
__USE_GNU


768 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

769 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

770 
	`__nÚnuÎ
 ((1, 4));

775 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

776 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

777 
__END_NAMESPACE_STD


779 #ifdeà
__USE_ISOC99


780 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

781 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

785 
__BEGIN_NAMESPACE_STD


789 
div_t
 
	$div
 (
__num”
, 
__d’om
)

790 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

791 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

792 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

793 
__END_NAMESPACE_STD


795 #ifdeà
__USE_ISOC99


796 
__BEGIN_NAMESPACE_C99


797 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

798 
__d’om
)

799 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

800 
__END_NAMESPACE_C99


804 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

805 || 
defšed
 
__USE_SVID


812 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

813 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

818 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

819 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

824 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

825 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

828 #ifdeà
__USE_MISC


830 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

831 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

832 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

833 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

834 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

835 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

836 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

837 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

842 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

843 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

844 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

845 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

846 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

847 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

849 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

850 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

851 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

852 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

853 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

854 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

855 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

856 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

860 
__BEGIN_NAMESPACE_STD


863 
	$mbËn
 (cÚ¡ *
__s
, 
size_t
 
__n
è
__THROW
;

866 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

867 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

870 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
;

874 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

875 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

877 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

878 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

879 
__THROW
;

880 
__END_NAMESPACE_STD


883 #ifdeà
__USE_SVID


888 
	$½m©ch
 (cÚ¡ *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

892 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


899 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

900 *cÚ¡ *
__»¡riù
 
__tok’s
,

901 **
__»¡riù
 
__v®u•
)

902 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

906 #ifdeà
__USE_XOPEN


908 
	$£tkey
 (cÚ¡ *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

914 #ifdeà
__USE_XOPEN2KXSI


916 
	$posix_İ’±
 (
__oæag
è
__wur
;

919 #ifdeà
__USE_XOPEN


924 
	$g¿Á±
 (
__fd
è
__THROW
;

928 
	$uÆock±
 (
__fd
è
__THROW
;

933 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

936 #ifdeà
__USE_GNU


940 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

941 
__THROW
 
	`__nÚnuÎ
 ((2));

944 
	`g‘±
 ();

947 #ifdeà
__USE_BSD


951 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

952 
__THROW
 
	`__nÚnuÎ
 ((1));

955 
	~<b™s/¡dlib-æßt.h
>

958 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


959 
	~<b™s/¡dlib.h
>

961 #ifdeà
__LDBL_COMPAT


962 
	~<b™s/¡dlib-ldbl.h
>

966 #undeà
__Ãed_m®loc_ªd_ÿÎoc


968 
__END_DECLS


	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


30 
	#__Ãed_size_t


	)

31 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

39 #ià
defšed
 
__ılu¥lus
 && (__ılu¥lu >ğ199711L || 
__GNUC_PREREQ
 (4, 4))

40 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

44 
__BEGIN_NAMESPACE_STD


46 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

47 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

50 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

51 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

52 
__END_NAMESPACE_STD


57 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN


58 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

59 
__c
, 
size_t
 
__n
)

60 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

64 
__BEGIN_NAMESPACE_STD


66 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

69 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

70 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

73 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


76 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

77 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

79 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ifdeà
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


85  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


91  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

94 
	}
}

96 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

99 
__END_NAMESPACE_STD


101 #ifdeà
__USE_GNU


104 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


105 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

106 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

107 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

108 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

110 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

111 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

115 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


116 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

117 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

118 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

119 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

121 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

122 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

127 
__BEGIN_NAMESPACE_STD


129 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

132 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

133 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

137 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

138 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

140 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

141 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

144 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

151 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

152 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

154 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

155 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

156 
__THROW
 
	`__nÚnuÎ
 ((2));

157 
__END_NAMESPACE_STD


159 #ifdeà
__USE_XOPEN2K8


163 
	~<xloÿË.h
>

166 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

167 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

169 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

170 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

173 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 \

174 || 
defšed
 
__USE_XOPEN2K8


176 *
	$¡rdup
 (cÚ¡ *
__s
)

177 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

183 #ià
defšed
 
__USE_XOPEN2K8


184 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

185 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

188 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


190 
	#¡rdu·
(
s
) \

191 (
__ex‹nsiÚ__
 \

193 cÚ¡ *
__Şd
 = (
s
); \

194 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

195 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

196 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

197 
	}
}))

	)

200 
	#¡ºdu·
(
s
, 
n
) \

201 (
__ex‹nsiÚ__
 \

203 cÚ¡ *
__Şd
 = (
s
); \

204 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

205 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

206 
__Ãw
[
__Ën
] = '\0'; \

207 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

208 }))

	)

211 
	g__BEGIN_NAMESPACE_STD


213 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


216 *
¡rchr
 (*
__s
, 
__c
)

217 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

218 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

219 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

221 #ifdeà
__OPTIMIZE__


222 
__ex‹º_®ways_šlše
 *

223 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


225  
__butš_¡rchr
 (
__s
, 
__c
);

228 
__ex‹º_®ways_šlše
 const *

229 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


231  
__butš_¡rchr
 (
__s
, 
__c
);

236 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

237 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

240 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


243 *
	`¡¼chr
 (*
__s
, 
__c
)

244 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

245 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

246 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

248 #ifdeà
__OPTIMIZE__


249 
__ex‹º_®ways_šlše
 *

250 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


252  
	`__butš_¡¼chr
 (
__s
, 
__c
);

255 
__ex‹º_®ways_šlše
 const *

256 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


258  
	`__butš_¡¼chr
 (
__s
, 
__c
);

261 
	}
}

263 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

264 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

266 
__END_NAMESPACE_STD


268 #ifdeà
__USE_GNU


271 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


272 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

273 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

274 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

275 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

278 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

282 
__BEGIN_NAMESPACE_STD


285 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

286 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

289 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

290 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

292 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


295 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

296 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

297 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

298 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

300 #ifdeà
__OPTIMIZE__


301 
__ex‹º_®ways_šlše
 *

302 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


304  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

307 
__ex‹º_®ways_šlše
 const *

308 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


310  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

313 
	}
}

315 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

316 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

319 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


322 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

323 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

324 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

325 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

327 #ifdeà
__OPTIMIZE__


328 
__ex‹º_®ways_šlše
 *

329 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


331  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

334 
__ex‹º_®ways_šlše
 const *

335 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


337  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

340 
	}
}

342 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

343 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

348 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

349 
__THROW
 
	`__nÚnuÎ
 ((2));

350 
__END_NAMESPACE_STD


354 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

355 cÚ¡ *
__»¡riù
 
__d–im
,

356 **
__»¡riù
 
__§ve_±r
)

357 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

358 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


359 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

360 **
__»¡riù
 
__§ve_±r
)

361 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

364 #ifdeà
__USE_GNU


366 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


367 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

368 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

369 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

370 cÚ¡ *
__ÃedË
)

371 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

374 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

378 #ifdeà
__USE_GNU


382 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

383 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

384 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

388 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

389 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

390 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

391 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

392 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

393 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

397 
__BEGIN_NAMESPACE_STD


399 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

400 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

401 
__END_NAMESPACE_STD


403 #ifdef 
__USE_XOPEN2K8


406 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

407 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

411 
__BEGIN_NAMESPACE_STD


413 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

414 
__END_NAMESPACE_STD


415 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_MISC


423 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


426 #ifdeà
__REDIRECT_NTH


427 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

428 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

429 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

431 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

432 
__THROW
 
	`__nÚnuÎ
 ((2));

433 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

438 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

439 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

443 #ifdeà
__USE_XOPEN2K8


445 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

451 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

453 #ifdeà
__USE_BSD


455 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

462 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

463 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

466 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


469 *
	`šdex
 (*
__s
, 
__c
)

470 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

471 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

472 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

474 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


475 
__ex‹º_®ways_šlše
 *

476 
	`šdex
 (*
__s
, 
__c
è
__THROW


478  
	`__butš_šdex
 (
__s
, 
__c
);

481 
__ex‹º_®ways_šlše
 const *

482 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


484  
	`__butš_šdex
 (
__s
, 
__c
);

487 
	}
}

489 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

490 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


497 *
	`ršdex
 (*
__s
, 
__c
)

498 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

499 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

500 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

502 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


503 
__ex‹º_®ways_šlše
 *

504 
	`ršdex
 (*
__s
, 
__c
è
__THROW


506  
	`__butš_ršdex
 (
__s
, 
__c
);

509 
__ex‹º_®ways_šlše
 const *

510 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


512  
	`__butš_ršdex
 (
__s
, 
__c
);

515 
	}
}

517 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

518 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

523 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

527 #ifdef 
__USE_GNU


528 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

530 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

534 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

535 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

538 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

539 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

542 #ifdef 
__USE_GNU


545 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

546 
__loÿË_t
 
__loc
)

547 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

549 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

550 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

551 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

554 #ifdef 
__USE_BSD


557 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

558 cÚ¡ *
__»¡riù
 
__d–im
)

559 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

562 #ifdef 
__USE_XOPEN2K8


564 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

567 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

568 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

569 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

570 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

574 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

575 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

576 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

577 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

578 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

579 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

582 #ifdef 
__USE_GNU


584 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

585 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

588 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

591 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

593 #iâdeà
ba£Çme


598 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


599 "C++" *
	$ba£Çme
 (*
__f’ame
)

600 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

601 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

602 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

604 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

610 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

611 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

612 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ılu¥lus


632 
	~<b™s/¡ršg.h
>

635 
	~<b™s/¡ršg2.h
>

638 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


640 
	~<b™s/¡ršg3.h
>

644 
__END_DECLS


	@/usr/include/stropts.h

18 #iâdeà
_STROPTS_H


19 
	#_STROPTS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<b™s/ty³s.h
>

23 
	~<b™s/xt™y³s.h
>

25 #iâdeà
__gid_t_defšed


26 
__gid_t
 
	tgid_t
;

27 
	#__gid_t_defšed


	)

30 #iâdeà
__uid_t_defšed


31 
__uid_t
 
	tuid_t
;

32 
	#__uid_t_defšed


	)

35 
__t_sÿÏr_t
 
	tt_sÿÏr_t
;

36 
__t_usÿÏr_t
 
	tt_usÿÏr_t
;

39 
	~<b™s/¡rİts.h
>

42 
__BEGIN_DECLS


45 
	$i§¡»am
 (
__fdes
è
__THROW
;

51 
	`g‘msg
 (
__fdes
, 
¡rbuf
 *
__»¡riù
 
__ùÍŒ
,

52 
¡rbuf
 *
__»¡riù
 
__d©­Œ
,

53 *
__»¡riù
 
__æag¥
);

60 
	`g‘pmsg
 (
__fdes
, 
¡rbuf
 *
__»¡riù
 
__ùÍŒ
,

61 
¡rbuf
 *
__»¡riù
 
__d©­Œ
,

62 *
__»¡riù
 
__bªdp
, *__»¡riù 
__æag¥
);

67 
	$ioùl
 (
__fd
, 
__»que¡
, ...è
__THROW
;

73 
	`putmsg
 (
__fdes
, cÚ¡ 
¡rbuf
 *
__ùÍŒ
,

74 cÚ¡ 
¡rbuf
 *
__d©­Œ
, 
__æags
);

80 
	`pumsg
 (
__fdes
, cÚ¡ 
¡rbuf
 *
__ùÍŒ
,

81 cÚ¡ 
¡rbuf
 *
__d©­Œ
, 
__bªd
, 
__æags
);

85 
	$ç‰ach
 (
__fdes
, cÚ¡ *
__·th
è
__THROW
;

88 
	$fd‘ach
 (cÚ¡ *
__·th
è
__THROW
;

90 
__END_DECLS


	@/usr/include/syslog.h

1 
	~<sys/sy¦og.h
>

	@/usr/include/termios.h

22 #iâdef 
_TERMIOS_H


23 
	#_TERMIOS_H
 1

	)

25 
	~<ã©u»s.h
>

26 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


28 
	~<b™s/ty³s.h
>

29 #iâdeà
__pid_t_defšed


30 
__pid_t
 
	tpid_t
;

31 
	#__pid_t_defšed


	)

35 
	g__BEGIN_DECLS


39 
	~<b™s/‹rmios.h
>

41 #ifdeà
__USE_BSD


44 
	#CCEQ
(
v®
, 
c
è((cè=ğ(v®è&& (v®è!ğ
_POSIX_VDISABLE
)

	)

48 
¥“d_t
 
	$cfg‘o¥“d
 (cÚ¡ 
‹rmios
 *
__‹rmios_p
è
__THROW
;

51 
¥“d_t
 
	$cfg‘i¥“d
 (cÚ¡ 
‹rmios
 *
__‹rmios_p
è
__THROW
;

54 
	$cf£to¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

57 
	$cf£ti¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

59 #ifdef 
__USE_BSD


61 
	$cf£t¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

66 
	$tcg‘©Œ
 (
__fd
, 
‹rmios
 *
__‹rmios_p
è
__THROW
;

70 
	$tc£‰r
 (
__fd
, 
__İtiÚ®_aùiÚs
,

71 cÚ¡ 
‹rmios
 *
__‹rmios_p
è
__THROW
;

74 #ifdef 
__USE_BSD


76 
	$cfmak”aw
 (
‹rmios
 *
__‹rmios_p
è
__THROW
;

80 
	$tc£ndb»ak
 (
__fd
, 
__du¿tiÚ
è
__THROW
;

86 
	`tcd¿š
 (
__fd
);

90 
	$tcæush
 (
__fd
, 
__queue_£ËùÜ
è
__THROW
;

94 
	$tcæow
 (
__fd
, 
__aùiÚ
è
__THROW
;

97 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


99 
__pid_t
 
	$tcg‘sid
 (
__fd
è
__THROW
;

103 #ifdeà
__USE_BSD


104 
	~<sys/‰ydeçuÉs.h
>

107 
__END_DECLS


	@/usr/include/time.h

22 #iâdef 
_TIME_H


24 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

25 ! 
defšed
 
	g__Ãed_time¥ec
)

26 
	#_TIME_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


33 #ifdef 
_TIME_H


35 
	#__Ãed_size_t


	)

36 
	#__Ãed_NULL


	)

37 
	~<¡ddef.h
>

41 
	~<b™s/time.h
>

44 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


45 #iâdeà
CLK_TCK


46 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

52 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

53 
	#__şock_t_defšed
 1

	)

55 
	~<b™s/ty³s.h
>

57 
__BEGIN_NAMESPACE_STD


59 
__şock_t
 
	tşock_t
;

60 
	g__END_NAMESPACE_STD


61 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


62 
	$__USING_NAMESPACE_STD
(
şock_t
)

66 #undeà
__Ãed_şock_t


68 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

69 
	#__time_t_defšed
 1

	)

71 
	~<b™s/ty³s.h
>

73 
__BEGIN_NAMESPACE_STD


75 
__time_t
 
	ttime_t
;

76 
__END_NAMESPACE_STD


77 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC
 || defšed 
__USE_SVID


78 
	$__USING_NAMESPACE_STD
(
time_t
)

82 #undeà
__Ãed_time_t


84 #ià!
defšed
 
__şockid_t_defšed
 && \

85 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

86 
	#__şockid_t_defšed
 1

	)

88 
	~<b™s/ty³s.h
>

91 
__şockid_t
 
	tşockid_t
;

94 #undeà
__şockid_time_t


96 #ià!
defšed
 
__tim”_t_defšed
 && \

97 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

98 
	#__tim”_t_defšed
 1

	)

100 
	~<b™s/ty³s.h
>

103 
__tim”_t
 
	ttim”_t
;

106 #undeà
__Ãed_tim”_t


109 #ià(!
defšed
 
__time¥ec_defšed
 \

110 && ((
defšed
 
_TIME_H
 \

111 && (
defšed
 
__USE_POSIX199309
 || defšed 
__USE_MISC
 \

112 || 
defšed
 
__USE_ISOC11
)) \

113 || 
defšed
 
__Ãed_time¥ec
))

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
__sysÿÎ_¦Úg_t
 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_BSD


146 
tm_gmtoff
;

147 cÚ¡ *
tm_zÚe
;

149 
__tm_gmtoff
;

150 cÚ¡ *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 #ifdeà
__USE_ISOC11


182 
	#TIME_UTC
 1

	)

186 
__BEGIN_NAMESPACE_STD


189 
şock_t
 
	$şock
 (è
__THROW
;

192 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

195 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

196 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

199 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

205 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

206 cÚ¡ *
__»¡riù
 
__fÜm©
,

207 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

208 
__END_NAMESPACE_STD


210 #ifdeà
__USE_XOPEN


213 *
	$¡½time
 (cÚ¡ *
__»¡riù
 
__s
,

214 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
)

215 
__THROW
;

218 #ifdeà
__USE_XOPEN2K8


221 
	~<xloÿË.h
>

223 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

224 cÚ¡ *
__»¡riù
 
__fÜm©
,

225 cÚ¡ 
tm
 *
__»¡riù
 
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

229 #ifdeà
__USE_GNU


230 *
	$¡½time_l
 (cÚ¡ *
__»¡riù
 
__s
,

231 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
,

232 
__loÿË_t
 
__loc
è
__THROW
;

236 
__BEGIN_NAMESPACE_STD


239 
tm
 *
	$gmtime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

243 
tm
 *
	$loÿÉime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

244 
__END_NAMESPACE_STD


246 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


249 
tm
 *
	$gmtime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

250 
tm
 *
__»¡riù
 
__
è
__THROW
;

254 
tm
 *
	$loÿÉime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

255 
tm
 *
__»¡riù
 
__
è
__THROW
;

258 
__BEGIN_NAMESPACE_STD


261 *
	$asùime
 (cÚ¡ 
tm
 *
__
è
__THROW
;

264 *
	$ùime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

265 
__END_NAMESPACE_STD


267 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


272 *
	$asùime_r
 (cÚ¡ 
tm
 *
__»¡riù
 
__
,

273 *
__»¡riù
 
__buf
è
__THROW
;

276 *
	$ùime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

277 *
__»¡riù
 
__buf
è
__THROW
;

282 *
__tzÇme
[2];

283 
__daylight
;

284 
__timezÚe
;

287 #ifdef 
__USE_POSIX


289 *
tzÇme
[2];

293 
	$tz£t
 (è
__THROW
;

296 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


297 
daylight
;

298 
timezÚe
;

301 #ifdeà
__USE_SVID


304 
	$¡ime
 (cÚ¡ 
time_t
 *
__wh’
è
__THROW
;

310 
	#__i¦—p
(
y—r
) \

311 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

314 #ifdeà
__USE_MISC


319 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

322 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

325 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

329 #ifdeà
__USE_POSIX199309


334 
	`Çno¦“p
 (cÚ¡ 
time¥ec
 *
__»que¡ed_time
,

335 
time¥ec
 *
__»maššg
);

339 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

342 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

345 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, cÚ¡ 
time¥ec
 *
__
)

346 
__THROW
;

348 #ifdeà
__USE_XOPEN2K


353 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

354 cÚ¡ 
time¥ec
 *
__»q
,

355 
time¥ec
 *
__»m
);

358 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

363 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

364 
sigev’t
 *
__»¡riù
 
__evp
,

365 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

368 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

371 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

372 cÚ¡ 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

373 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

376 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

377 
__THROW
;

380 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

384 #ifdeà
__USE_ISOC11


386 
	$time¥ec_g‘
 (
time¥ec
 *
__ts
, 
__ba£
)

387 
__THROW
 
	`__nÚnuÎ
 ((1));

391 #ifdeà
__USE_XOPEN_EXTENDED


403 
g‘d©e_”r
;

412 
tm
 *
	`g‘d©e
 (cÚ¡ *
__¡ršg
);

415 #ifdeà
__USE_GNU


426 
	`g‘d©e_r
 (cÚ¡ *
__»¡riù
 
__¡ršg
,

427 
tm
 *
__»¡riù
 
__»sbuå
);

430 
__END_DECLS


	@/usr/include/ucontext.h

20 #iâdeà
_UCONTEXT_H


21 
	#_UCONTEXT_H
 1

	)

23 
	~<ã©u»s.h
>

26 
	~<sys/ucÚ‹xt.h
>

28 
__BEGIN_DECLS


31 
	$g‘cÚ‹xt
 (
ucÚ‹xt_t
 *
__uı
è
__THROWNL
;

34 
	$£tcÚ‹xt
 (cÚ¡ 
ucÚ‹xt_t
 *
__uı
è
__THROWNL
;

38 
	$sw­cÚ‹xt
 (
ucÚ‹xt_t
 *
__»¡riù
 
__ouı
,

39 cÚ¡ 
ucÚ‹xt_t
 *
__»¡riù
 
__uı
è
__THROWNL
;

47 
	`makecÚ‹xt
 (
ucÚ‹xt_t
 *
__uı
, (*
__func
) (),

48 
__¬gc
, ...è
__THROW
;

50 
__END_DECLS


	@/usr/include/unistd.h

22 #iâdef 
_UNISTD_H


23 
	#_UNISTD_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


32 #ifdeà
__USE_XOPEN2K8


34 
	#_POSIX_VERSION
 200809L

	)

35 #–ià
defšed
 
__USE_XOPEN2K


37 
	#_POSIX_VERSION
 200112L

	)

38 #–ià
defšed
 
__USE_POSIX199506


40 
	#_POSIX_VERSION
 199506L

	)

41 #–ià
defšed
 
__USE_POSIX199309


43 
	#_POSIX_VERSION
 199309L

	)

46 
	#_POSIX_VERSION
 199009L

	)

52 #ifdeà
__USE_XOPEN2K8


53 
	#__POSIX2_THIS_VERSION
 200809L

	)

55 #–ià
defšed
 
__USE_XOPEN2K


57 
	#__POSIX2_THIS_VERSION
 200112L

	)

58 #–ià
defšed
 
__USE_POSIX199506


60 
	#__POSIX2_THIS_VERSION
 199506L

	)

63 
	#__POSIX2_THIS_VERSION
 199209L

	)

67 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

71 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

75 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

79 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

83 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

86 #ifdeà
__USE_XOPEN2K8


87 
	#_XOPEN_VERSION
 700

	)

88 #–ià
defšed
 
__USE_XOPEN2K


89 
	#_XOPEN_VERSION
 600

	)

90 #–ià
defšed
 
__USE_UNIX98


91 
	#_XOPEN_VERSION
 500

	)

93 
	#_XOPEN_VERSION
 4

	)

97 
	#_XOPEN_XCU_VERSION
 4

	)

100 
	#_XOPEN_XPG2
 1

	)

101 
	#_XOPEN_XPG3
 1

	)

102 
	#_XOPEN_XPG4
 1

	)

105 
	#_XOPEN_UNIX
 1

	)

108 
	#_XOPEN_CRYPT
 1

	)

112 
	#_XOPEN_ENH_I18N
 1

	)

115 
	#_XOPEN_LEGACY
 1

	)

202 
	~<b™s/posix_İt.h
>

205 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


206 
	~<b™s/’vœÚm’ts.h
>

210 
	#STDIN_FILENO
 0

	)

211 
	#STDOUT_FILENO
 1

	)

212 
	#STDERR_FILENO
 2

	)

217 
	~<b™s/ty³s.h
>

219 #iâdef 
__ssize_t_defšed


220 
__ssize_t
 
	tssize_t
;

221 
	#__ssize_t_defšed


	)

224 
	#__Ãed_size_t


	)

225 
	#__Ãed_NULL


	)

226 
	~<¡ddef.h
>

228 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


231 #iâdeà
__gid_t_defšed


232 
__gid_t
 
	tgid_t
;

233 
	#__gid_t_defšed


	)

236 #iâdeà
__uid_t_defšed


237 
__uid_t
 
	tuid_t
;

238 
	#__uid_t_defšed


	)

241 #iâdeà
__off_t_defšed


242 #iâdeà
__USE_FILE_OFFSET64


243 
__off_t
 
	toff_t
;

245 
__off64_t
 
	toff_t
;

247 
	#__off_t_defšed


	)

249 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


250 
__off64_t
 
	toff64_t
;

251 
	#__off64_t_defšed


	)

254 #iâdeà
__u£cÚds_t_defšed


255 
__u£cÚds_t
 
	tu£cÚds_t
;

256 
	#__u£cÚds_t_defšed


	)

259 #iâdeà
__pid_t_defšed


260 
__pid_t
 
	tpid_t
;

261 
	#__pid_t_defšed


	)

265 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


266 #iâdeà
__šŒ_t_defšed


267 
__šŒ_t
 
	tšŒ_t
;

268 
	#__šŒ_t_defšed


	)

272 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN


273 #iâdeà
__sockËn_t_defšed


274 
__sockËn_t
 
	tsockËn_t
;

275 
	#__sockËn_t_defšed


	)

281 
	#R_OK
 4

	)

282 
	#W_OK
 2

	)

283 
	#X_OK
 1

	)

284 
	#F_OK
 0

	)

287 
	$acûss
 (cÚ¡ *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

289 #ifdeà
__USE_GNU


292 
	$euidacûss
 (cÚ¡ *
__Çme
, 
__ty³
)

293 
__THROW
 
	`__nÚnuÎ
 ((1));

296 
	$—cûss
 (cÚ¡ *
__Çme
, 
__ty³
)

297 
__THROW
 
	`__nÚnuÎ
 ((1));

300 #ifdeà
__USE_ATFILE


304 
	$çcûs§t
 (
__fd
, cÚ¡ *
__fe
, 
__ty³
, 
__æag
)

305 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

310 #iâdef 
_STDIO_H


311 
	#SEEK_SET
 0

	)

312 
	#SEEK_CUR
 1

	)

313 
	#SEEK_END
 2

	)

314 #ifdeà
__USE_GNU


315 
	#SEEK_DATA
 3

	)

316 
	#SEEK_HOLE
 4

	)

320 #ià
defšed
 
__USE_BSD
 && !defšed 
L_SET


322 
	#L_SET
 
SEEK_SET


	)

323 
	#L_INCR
 
SEEK_CUR


	)

324 
	#L_XTND
 
SEEK_END


	)

333 #iâdeà
__USE_FILE_OFFSET64


334 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

336 #ifdeà
__REDIRECT_NTH


337 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

338 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

339 
l£ek64
);

341 
	#l£ek
 
l£ek64


	)

344 #ifdeà
__USE_LARGEFILE64


345 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

346 
__THROW
;

353 
	`şo£
 (
__fd
);

360 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

366 
ssize_t
 
	$wr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
è
__wur
;

368 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


369 #iâdeà
__USE_FILE_OFFSET64


376 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

377 
__off_t
 
__off£t
è
__wur
;

384 
ssize_t
 
	$pwr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

385 
__off_t
 
__off£t
è
__wur
;

387 #ifdeà
__REDIRECT


388 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

389 
__off64_t
 
__off£t
),

390 
´—d64
è
__wur
;

391 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, cÚ¡ *
__buf
,

392 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

393 
pwr™e64
è
__wur
;

395 
	#´—d
 
´—d64


	)

396 
	#pwr™e
 
pwr™e64


	)

400 #ifdeà
__USE_LARGEFILE64


404 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

405 
__off64_t
 
__off£t
è
__wur
;

408 
ssize_t
 
	$pwr™e64
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

409 
__off64_t
 
__off£t
è
__wur
;

417 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

419 #ifdeà
__USE_GNU


422 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

432 
	$®¬m
 (
__£cÚds
è
__THROW
;

444 
	`¦“p
 (
__£cÚds
);

446 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

447 || 
defšed
 
__USE_BSD


452 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

453 
__THROW
;

460 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

469 
	`·u£
 ();

473 
	$chown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

474 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

476 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


478 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

483 
	$lchown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

484 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

488 #ifdeà
__USE_ATFILE


491 
	$fchowÇt
 (
__fd
, cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
,

492 
__gid_t
 
__group
, 
__æag
)

493 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

497 
	$chdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

499 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


501 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

511 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

513 #ifdef 
__USE_GNU


517 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

520 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

521 || 
defšed
 
__USE_BSD


525 *
	$g‘wd
 (*
__buf
)

526 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

531 
	$dup
 (
__fd
è
__THROW
 
__wur
;

534 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

536 #ifdeà
__USE_GNU


539 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

543 **
__’vœÚ
;

544 #ifdeà
__USE_GNU


545 **
’vœÚ
;

551 
	$execve
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[],

552 *cÚ¡ 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

554 #ifdeà
__USE_XOPEN2K8


557 
	$ãxecve
 (
__fd
, *cÚ¡ 
__¬gv
[], *cÚ¡ 
__’vp
[])

558 
__THROW
 
	`__nÚnuÎ
 ((2));

563 
	$execv
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[])

564 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

568 
	$exeşe
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

569 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

573 
	$exeş
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

574 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

578 
	$execvp
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[])

579 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

584 
	$exeşp
 (cÚ¡ *
__fe
, cÚ¡ *
__¬g
, ...)

585 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

587 #ifdeà
__USE_GNU


590 
	$execv³
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[],

591 *cÚ¡ 
__’vp
[])

592 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

596 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


598 
	$niû
 (
__šc
è
__THROW
 
__wur
;

603 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

609 
	~<b™s/cÚâame.h
>

612 
	$·thcÚf
 (cÚ¡ *
__·th
, 
__Çme
)

613 
__THROW
 
	`__nÚnuÎ
 ((1));

616 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

619 
	$syscÚf
 (
__Çme
è
__THROW
;

621 #ifdef 
__USE_POSIX2


623 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

628 
__pid_t
 
	$g‘pid
 (è
__THROW
;

631 
__pid_t
 
	$g‘µid
 (è
__THROW
;

634 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

637 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

638 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


639 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

646 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

648 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


660 
	$£g½
 (è
__THROW
;

667 
__pid_t
 
	$£tsid
 (è
__THROW
;

669 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


671 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

675 
__uid_t
 
	$g‘uid
 (è
__THROW
;

678 
__uid_t
 
	$g‘euid
 (è
__THROW
;

681 
__gid_t
 
	$g‘gid
 (è
__THROW
;

684 
__gid_t
 
	$g‘egid
 (è
__THROW
;

689 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

691 #ifdef 
__USE_GNU


693 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

700 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

702 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


705 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
 
__wur
;

708 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


710 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

717 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

719 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


722 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
 
__wur
;

725 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


727 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

730 #ifdeà
__USE_GNU


733 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

734 
__THROW
;

738 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

739 
__THROW
;

743 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

744 
__THROW
 
__wur
;

748 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

749 
__THROW
 
__wur
;

756 
__pid_t
 
	$fÜk
 (è
__THROWNL
;

758 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

759 || 
defšed
 
__USE_BSD


764 
__pid_t
 
	$vfÜk
 (è
__THROW
;

770 *
	$‰yÇme
 (
__fd
è
__THROW
;

774 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

775 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

779 
	$i§‰y
 (
__fd
è
__THROW
;

781 #ià
defšed
 
__USE_BSD
 \

782 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_UNIX98
)

785 
	$‰y¦Ù
 (è
__THROW
;

790 
	$lšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

791 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

793 #ifdeà
__USE_ATFILE


796 
	$lšk©
 (
__äomfd
, cÚ¡ *
__äom
, 
__tofd
,

797 cÚ¡ *
__to
, 
__æags
)

798 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

801 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


803 
	$symlšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

804 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

809 
ssize_t
 
	$»adlšk
 (cÚ¡ *
__»¡riù
 
__·th
,

810 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

811 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

814 #ifdeà
__USE_ATFILE


816 
	$symlšk©
 (cÚ¡ *
__äom
, 
__tofd
,

817 cÚ¡ *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

820 
ssize_t
 
	$»adlšk©
 (
__fd
, cÚ¡ *
__»¡riù
 
__·th
,

821 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

822 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

826 
	$uÆšk
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

828 #ifdeà
__USE_ATFILE


830 
	$uÆšk©
 (
__fd
, cÚ¡ *
__Çme
, 
__æag
)

831 
__THROW
 
	`__nÚnuÎ
 ((2));

835 
	$rmdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

839 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

842 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

849 *
	`g‘logš
 ();

850 #ià
defšed
 
__USE_REENTRANT
 || defšed 
__USE_POSIX199506


857 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

860 #ifdef 
__USE_BSD


862 
	$£ogš
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

866 #ifdef 
__USE_POSIX2


870 
	#__Ãed_g‘İt


	)

871 
	~<g‘İt.h
>

875 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


879 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

883 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_UNIX98
)

886 
	$£tho¡Çme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

887 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

891 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

897 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

898 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

899 
	$£tdomašÇme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

900 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

906 
	$vhªgup
 (è
__THROW
;

909 
	$»voke
 (cÚ¡ *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

917 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

918 
size_t
 
__off£t
, 
__sÿË
)

919 
__THROW
 
	`__nÚnuÎ
 ((1));

925 
	$acù
 (cÚ¡ *
__Çme
è
__THROW
;

929 *
	$g‘u£rsh–l
 (è
__THROW
;

930 
	$’du£rsh–l
 (è
__THROW
;

931 
	$£tu£rsh–l
 (è
__THROW
;

937 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

941 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

944 
	$chroÙ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

948 *
	$g‘·ss
 (cÚ¡ *
__´om±
è
	`__nÚnuÎ
 ((1));

956 
	`fsync
 (
__fd
);

959 #ifdeà
__USE_GNU


962 
	$syncfs
 (
__fd
è
__THROW
;

966 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


969 
	`g‘ho¡id
 ();

972 
	$sync
 (è
__THROW
;

975 #ià
defšed
 
__USE_BSD
 || !defšed 
__USE_XOPEN2K


978 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

983 
	$g‘dbËsize
 (è
__THROW
;

989 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


992 #iâdeà
__USE_FILE_OFFSET64


993 
	$Œunÿ‹
 (cÚ¡ *
__fe
, 
__off_t
 
__Ëngth
)

994 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

996 #ifdeà
__REDIRECT_NTH


997 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

998 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
),

999 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1001 
	#Œunÿ‹
 
Œunÿ‹64


	)

1004 #ifdeà
__USE_LARGEFILE64


1005 
	$Œunÿ‹64
 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
)

1006 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1011 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_POSIX199309
 \

1012 || 
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


1015 #iâdeà
__USE_FILE_OFFSET64


1016 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1018 #ifdeà
__REDIRECT_NTH


1019 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1020 
árunÿ‹64
è
__wur
;

1022 
	#árunÿ‹
 
árunÿ‹64


	)

1025 #ifdeà
__USE_LARGEFILE64


1026 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1032 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1033 || 
defšed
 
__USE_MISC


1037 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1043 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1047 #ifdeà
__USE_MISC


1058 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1063 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1075 
	#F_ULOCK
 0

	)

1076 
	#F_LOCK
 1

	)

1077 
	#F_TLOCK
 2

	)

1078 
	#F_TEST
 3

	)

1080 #iâdeà
__USE_FILE_OFFSET64


1081 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1083 #ifdeà
__REDIRECT


1084 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1085 
lockf64
è
__wur
;

1087 
	#lockf
 
lockf64


	)

1090 #ifdeà
__USE_LARGEFILE64


1091 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1096 #ifdeà
__USE_GNU


1101 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1102 (
__ex‹nsiÚ__
 \

1103 ({ 
__»suÉ
; \

1104 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1105 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1106 
__»suÉ
; 
	}
}))

	)

1109 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1112 
fd©async
 (
__fdes
);

1118 #ifdef 
__USE_XOPEN


1120 *
	$üy±
 (cÚ¡ *
__key
, cÚ¡ *
__§É
)

1121 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1125 
	$’üy±
 (*
__glibc_block
, 
__edæag
)

1126 
__THROW
 
	`__nÚnuÎ
 ((1));

1133 
	$swab
 (cÚ¡ *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1134 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1140 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K


1142 *
	$ù”mid
 (*
__s
è
__THROW
;

1147 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


1148 
	~<b™s/uni¡d.h
>

1151 
__END_DECLS


	@/usr/include/alloca.h

18 #iâdef 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

26 
	g__BEGIN_DECLS


29 #undeà
®loÿ


32 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

34 #ifdef 
__GNUC__


35 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

38 
__END_DECLS


	@/usr/include/getopt.h

19 #iâdeà
_GETOPT_H


21 #iâdeà
__Ãed_g‘İt


22 
	#_GETOPT_H
 1

	)

32 #ià!
defšed
 
__GNU_LIBRARY__


33 
	~<ùy³.h
>

36 #iâdeà
__THROW


37 #iâdeà
__GNUC_PREREQ


38 
	#__GNUC_PREREQ
(
maj
, 
mš
è(0)

	)

40 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

41 
	#__THROW
 
	`throw
 ()

	)

43 
	#__THROW


	)

47 #ifdef 
__ılu¥lus


57 *
İrg
;

71 
İtšd
;

76 
İ‹¼
;

80 
İtİt
;

82 #iâdeà
__Ãed_g‘İt


104 
	sİtiÚ


106 cÚ¡ *
	gÇme
;

109 
	ghas_¬g
;

110 *
	gæag
;

111 
	gv®
;

116 
	#no_¬gum’t
 0

	)

117 
	#»quœed_¬gum’t
 1

	)

118 
	#İtiÚ®_¬gum’t
 2

	)

146 #ifdeà
__GNU_LIBRARY__


150 
g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
, cÚ¡ *
__shÜtİts
)

151 
__THROW
;

153 #ià
defšed
 
__Ãed_g‘İt
 && defšed 
__USE_POSIX2
 \

154 && !
defšed
 
	g__USE_POSIX_IMPLICITLY
 && !defšed 
	g__USE_GNU


158 #ifdeà
__REDIRECT


159 
__REDIRECT_NTH
 (
g‘İt
, (
___¬gc
, *cÚ¡ *
___¬gv
,

160 cÚ¡ *
__shÜtİts
),

161 
__posix_g‘İt
);

163 
__posix_g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
,

164 cÚ¡ *
__shÜtİts
è
__THROW
;

165 
	#g‘İt
 
__posix_g‘İt


	)

169 
g‘İt
 ();

172 #iâdeà
__Ãed_g‘İt


173 
g‘İt_lÚg
 (
___¬gc
, *cÚ¡ *
___¬gv
,

174 cÚ¡ *
__shÜtİts
,

175 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

176 
__THROW
;

177 
g‘İt_lÚg_Úly
 (
___¬gc
, *cÚ¡ *
___¬gv
,

178 cÚ¡ *
__shÜtİts
,

179 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

180 
__THROW
;

184 #ifdef 
__ılu¥lus


189 #undeà
__Ãed_g‘İt


	@/usr/include/libio.h

28 #iâdeà
_IO_STDIO_H


29 
	#_IO_STDIO_H


	)

31 
	~<_G_cÚfig.h
>

33 
	#_IO_åos_t
 
_G_åos_t


	)

34 
	#_IO_åos64_t
 
_G_åos64_t


	)

35 
	#_IO_size_t
 
size_t


	)

36 
	#_IO_ssize_t
 
__ssize_t


	)

37 
	#_IO_off_t
 
__off_t


	)

38 
	#_IO_off64_t
 
__off64_t


	)

39 
	#_IO_pid_t
 
__pid_t


	)

40 
	#_IO_uid_t
 
__uid_t


	)

41 
	#_IO_icÚv_t
 
_G_icÚv_t


	)

42 
	#_IO_HAVE_ST_BLKSIZE
 
_G_HAVE_ST_BLKSIZE


	)

43 
	#_IO_BUFSIZ
 
_G_BUFSIZ


	)

44 
	#_IO_va_li¡
 
_G_va_li¡


	)

45 
	#_IO_wšt_t
 
wšt_t


	)

48 
	#__Ãed___va_li¡


	)

49 
	~<¡d¬g.h
>

50 #ifdeà
__GNUC_VA_LIST


51 #undeà
_IO_va_li¡


52 
	#_IO_va_li¡
 
__gnuc_va_li¡


	)

55 #iâdeà
__P


56 
	~<sys/cdefs.h
>

59 
	#_IO_UNIFIED_JUMPTABLES
 1

	)

61 #iâdeà
EOF


62 
	#EOF
 (-1)

	)

64 #iâdeà
NULL


65 #ià
defšed
 
__GNUG__
 && \

66 (
	g__GNUC__
 > 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 >= 8))

67 
	#NULL
 (
__nuÎ
)

	)

69 #ià!
defšed
(
__ılu¥lus
)

70 
	#NULL
 ((*)0)

	)

72 
	#NULL
 (0)

	)

77 
	#_IOS_INPUT
 1

	)

78 
	#_IOS_OUTPUT
 2

	)

79 
	#_IOS_ATEND
 4

	)

80 
	#_IOS_APPEND
 8

	)

81 
	#_IOS_TRUNC
 16

	)

82 
	#_IOS_NOCREATE
 32

	)

83 
	#_IOS_NOREPLACE
 64

	)

84 
	#_IOS_BIN
 128

	)

92 
	#_IO_MAGIC
 0xFBAD0000

	)

93 
	#_OLD_STDIO_MAGIC
 0xFABC0000

	)

94 
	#_IO_MAGIC_MASK
 0xFFFF0000

	)

95 
	#_IO_USER_BUF
 1

	)

96 
	#_IO_UNBUFFERED
 2

	)

97 
	#_IO_NO_READS
 4

	)

98 
	#_IO_NO_WRITES
 8

	)

99 
	#_IO_EOF_SEEN
 0x10

	)

100 
	#_IO_ERR_SEEN
 0x20

	)

101 
	#_IO_DELETE_DONT_CLOSE
 0x40

	)

102 
	#_IO_LINKED
 0x80

	)

103 
	#_IO_IN_BACKUP
 0x100

	)

104 
	#_IO_LINE_BUF
 0x200

	)

105 
	#_IO_TIED_PUT_GET
 0x400

	)

106 
	#_IO_CURRENTLY_PUTTING
 0x800

	)

107 
	#_IO_IS_APPENDING
 0x1000

	)

108 
	#_IO_IS_FILEBUF
 0x2000

	)

109 
	#_IO_BAD_SEEN
 0x4000

	)

110 
	#_IO_USER_LOCK
 0x8000

	)

112 
	#_IO_FLAGS2_MMAP
 1

	)

113 
	#_IO_FLAGS2_NOTCANCEL
 2

	)

114 #ifdeà
_LIBC


115 
	#_IO_FLAGS2_FORTIFY
 4

	)

117 
	#_IO_FLAGS2_USER_WBUF
 8

	)

118 #ifdeà
_LIBC


119 
	#_IO_FLAGS2_SCANF_STD
 16

	)

120 
	#_IO_FLAGS2_NOCLOSE
 32

	)

121 
	#_IO_FLAGS2_CLOEXEC
 64

	)

125 
	#_IO_SKIPWS
 01

	)

126 
	#_IO_LEFT
 02

	)

127 
	#_IO_RIGHT
 04

	)

128 
	#_IO_INTERNAL
 010

	)

129 
	#_IO_DEC
 020

	)

130 
	#_IO_OCT
 040

	)

131 
	#_IO_HEX
 0100

	)

132 
	#_IO_SHOWBASE
 0200

	)

133 
	#_IO_SHOWPOINT
 0400

	)

134 
	#_IO_UPPERCASE
 01000

	)

135 
	#_IO_SHOWPOS
 02000

	)

136 
	#_IO_SCIENTIFIC
 04000

	)

137 
	#_IO_FIXED
 010000

	)

138 
	#_IO_UNITBUF
 020000

	)

139 
	#_IO_STDIO
 040000

	)

140 
	#_IO_DONT_CLOSE
 0100000

	)

141 
	#_IO_BOOLALPHA
 0200000

	)

144 
_IO_jump_t
; 
	g_IO_FILE
;

147 #ifdeà
_IO_MTSAFE_IO


148 #ià
defšed
 
__GLIBC__
 && __GLIBC__ >= 2

149 
	~<b™s/¡dio-lock.h
>

154 
	t_IO_lock_t
;

160 
	s_IO_m¬k”
 {

161 
_IO_m¬k”
 *
	m_Ãxt
;

162 
_IO_FILE
 *
	m_sbuf
;

166 
	m_pos
;

168 
£t_¡»ampos
(
¡»ampos
 
¥
è{ 
	m_¥os
 = sp; }

169 
£t_off£t
(
off£t
è{ 
	m_pos
 = off£t; 
	m_¥os
 = (
¡»ampos
)(-2); }

170 
	mpublic
:

171 
¡»amm¬k”
(
¡»ambuf
 *
sb
);

172 ~
¡»amm¬k”
();

173 
§všg
(è{  
	m_¥os
 == -2; }

174 
d–
(
¡»amm¬k”
&);

175 
d–
();

180 
	e__codecvt_»suÉ


182 
	m__codecvt_ok
,

183 
	m__codecvt_·¹Ÿl
,

184 
	m__codecvt_”rÜ
,

185 
	m__codecvt_nocÚv


188 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


191 
	s_IO_codecvt


193 (*
	m__codecvt_de¡r
è(
	m_IO_codecvt
 *);

194 
__codecvt_»suÉ
 (*
__codecvt_do_out
è(
	m_IO_codecvt
 *,

195 
	m__mb¡©e_t
 *,

196 cÚ¡ 
	mwch¬_t
 *,

197 cÚ¡ 
	mwch¬_t
 *,

198 cÚ¡ 
	mwch¬_t
 **, *,

200 
__codecvt_»suÉ
 (*
__codecvt_do_unshiá
è(
	m_IO_codecvt
 *,

201 
	m__mb¡©e_t
 *, *,

203 
__codecvt_»suÉ
 (*
__codecvt_do_š
è(
	m_IO_codecvt
 *,

204 
	m__mb¡©e_t
 *,

206 cÚ¡ **, 
	mwch¬_t
 *,

207 
	mwch¬_t
 *, wchar_t **);

208 (*
	m__codecvt_do_’codšg
è(
	m_IO_codecvt
 *);

209 (*
	m__codecvt_do_®ways_nocÚv
è(
	m_IO_codecvt
 *);

210 (*
	m__codecvt_do_Ëngth
è(
	m_IO_codecvt
 *, 
	m__mb¡©e_t
 *,

211 cÚ¡ *, cÚ¡ *, 
	m_IO_size_t
);

212 (*
	m__codecvt_do_max_Ëngth
è(
	m_IO_codecvt
 *);

214 
_IO_icÚv_t
 
	m__cd_š
;

215 
_IO_icÚv_t
 
	m__cd_out
;

219 
	s_IO_wide_d©a


221 
wch¬_t
 *
	m_IO_»ad_±r
;

222 
wch¬_t
 *
	m_IO_»ad_’d
;

223 
wch¬_t
 *
	m_IO_»ad_ba£
;

224 
wch¬_t
 *
	m_IO_wr™e_ba£
;

225 
wch¬_t
 *
	m_IO_wr™e_±r
;

226 
wch¬_t
 *
	m_IO_wr™e_’d
;

227 
wch¬_t
 *
	m_IO_buf_ba£
;

228 
wch¬_t
 *
	m_IO_buf_’d
;

230 
wch¬_t
 *
	m_IO_§ve_ba£
;

231 
wch¬_t
 *
	m_IO_backup_ba£
;

233 
wch¬_t
 *
	m_IO_§ve_’d
;

235 
__mb¡©e_t
 
	m_IO_¡©e
;

236 
__mb¡©e_t
 
	m_IO_Ï¡_¡©e
;

237 
_IO_codecvt
 
	m_codecvt
;

239 
wch¬_t
 
	m_shÜtbuf
[1];

241 cÚ¡ 
_IO_jump_t
 *
	m_wide_vbË
;

245 
	s_IO_FILE
 {

246 
	m_æags
;

247 
	#_IO_fe_æags
 
_æags


	)

251 * 
	m_IO_»ad_±r
;

252 * 
	m_IO_»ad_’d
;

253 * 
	m_IO_»ad_ba£
;

254 * 
	m_IO_wr™e_ba£
;

255 * 
	m_IO_wr™e_±r
;

256 * 
	m_IO_wr™e_’d
;

257 * 
	m_IO_buf_ba£
;

258 * 
	m_IO_buf_’d
;

260 *
	m_IO_§ve_ba£
;

261 *
	m_IO_backup_ba£
;

262 *
	m_IO_§ve_’d
;

264 
_IO_m¬k”
 *
	m_m¬k”s
;

266 
_IO_FILE
 *
	m_chaš
;

268 
	m_f’o
;

270 
	m_blksize
;

272 
	m_æags2
;

274 
_IO_off_t
 
	m_Şd_off£t
;

276 
	#__HAVE_COLUMN


	)

278 
	m_cur_cŞumn
;

279 sigÃd 
	m_vbË_off£t
;

280 
	m_shÜtbuf
[1];

284 
_IO_lock_t
 *
	m_lock
;

285 #ifdeà
_IO_USE_OLD_IO_FILE


288 
	s_IO_FILE_com¶‘e


290 
_IO_FILE
 
	m_fe
;

292 #ià
defšed
 
_G_IO_IO_FILE_VERSION
 && _G_IO_IO_FILE_VERSION == 0x20001

293 
_IO_off64_t
 
	m_off£t
;

294 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


296 
_IO_codecvt
 *
	m_codecvt
;

297 
_IO_wide_d©a
 *
	m_wide_d©a
;

298 
_IO_FILE
 *
	m_ä“»s_li¡
;

299 *
	m_ä“»s_buf
;

300 
size_t
 
	m_ä“»s_size
;

302 *
	m__·d1
;

303 *
	m__·d2
;

304 *
	m__·d3
;

305 *
	m__·d4
;

306 
size_t
 
	m__·d5
;

308 
	m_mode
;

310 
	m_unu£d2
[15 *  (è- 4 *  (*è-  (
size_t
)];

314 #iâdeà
__ılu¥lus


315 
_IO_FILE
 
	t_IO_FILE
;

318 
	g_IO_FILE_¶us
;

320 
_IO_FILE_¶us
 
_IO_2_1_¡dš_
;

321 
_IO_FILE_¶us
 
_IO_2_1_¡dout_
;

322 
_IO_FILE_¶us
 
_IO_2_1_¡d”r_
;

323 #iâdeà
_LIBC


324 
	#_IO_¡dš
 ((
_IO_FILE
*)(&
_IO_2_1_¡dš_
))

	)

325 
	#_IO_¡dout
 ((
_IO_FILE
*)(&
_IO_2_1_¡dout_
))

	)

326 
	#_IO_¡d”r
 ((
_IO_FILE
*)(&
_IO_2_1_¡d”r_
))

	)

328 
_IO_FILE
 *
_IO_¡dš
 
©Œibu‹_hidd’
;

329 
_IO_FILE
 *
_IO_¡dout
 
©Œibu‹_hidd’
;

330 
_IO_FILE
 *
_IO_¡d”r
 
©Œibu‹_hidd’
;

338 
__ssize_t
 
	t__io_»ad_â
 (*
	t__cook›
, *
	t__buf
, 
	tsize_t
 
	t__nby‹s
);

346 
__ssize_t
 
	t__io_wr™e_â
 (*
	t__cook›
, cÚ¡ *
	t__buf
,

347 
	tsize_t
 
	t__n
);

355 
	t__io_£ek_â
 (*
	t__cook›
, 
	t_IO_off64_t
 *
	t__pos
, 
	t__w
);

358 
	t__io_şo£_â
 (*
	t__cook›
);

361 #ifdeà
_GNU_SOURCE


363 
__io_»ad_â
 
	tcook›_»ad_funùiÚ_t
;

364 
__io_wr™e_â
 
	tcook›_wr™e_funùiÚ_t
;

365 
__io_£ek_â
 
	tcook›_£ek_funùiÚ_t
;

366 
__io_şo£_â
 
	tcook›_şo£_funùiÚ_t
;

371 
__io_»ad_â
 *
	m»ad
;

372 
__io_wr™e_â
 *
	mwr™e
;

373 
__io_£ek_â
 *
	m£ek
;

374 
__io_şo£_â
 *
	mşo£
;

375 } 
	t_IO_cook›_io_funùiÚs_t
;

376 
_IO_cook›_io_funùiÚs_t
 
	tcook›_io_funùiÚs_t
;

378 
	g_IO_cook›_fe
;

381 
_IO_cook›_š™
 (
_IO_cook›_fe
 *
__cfe
, 
__»ad_wr™e
,

382 *
__cook›
, 
_IO_cook›_io_funùiÚs_t
 
__âs
);

386 #ifdeà
__ılu¥lus


390 
__und”æow
 (
_IO_FILE
 *);

391 
__uæow
 (
_IO_FILE
 *);

392 
__ov”æow
 (
_IO_FILE
 *, );

393 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


394 
_IO_wšt_t
 
__wund”æow
 (
_IO_FILE
 *);

395 
_IO_wšt_t
 
__wuæow
 (
_IO_FILE
 *);

396 
_IO_wšt_t
 
__wov”æow
 (
_IO_FILE
 *, _IO_wint_t);

399 #ià 
__GNUC__
 >= 3

400 
	#_IO_BE
(
ex´
, 
»s
è
	`__butš_ex³ù
 (Óx´),„es)

	)

402 
	#_IO_BE
(
ex´
, 
»s
èÓx´)

	)

405 
	#_IO_g‘c_uÆocked
(
_å
) \

406 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

407 ? 
	`__uæow
 (
_å
è: *(*è(_å)->
_IO_»ad_±r
++)

	)

408 
	#_IO_³ekc_uÆocked
(
_å
) \

409 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

410 && 
	`__und”æow
 (
_å
è=ğ
EOF
 ? EOF \

411 : *(*è(
_å
)->
_IO_»ad_±r
)

	)

412 
	#_IO_putc_uÆocked
(
_ch
, 
_å
) \

413 (
	`_IO_BE
 ((
_å
)->
_IO_wr™e_±r
 >ğ(_å)->
_IO_wr™e_’d
, 0) \

414 ? 
	`__ov”æow
 (
_å
, (è(
_ch
)) \

415 : (è(*(
_å
)->
_IO_wr™e_±r
++ = (
_ch
)))

	)

417 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


418 
	#_IO_g‘wc_uÆocked
(
_å
) \

419 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

420 || ((
_å
)->
_wide_d©a
->
_IO_»ad_±r
 \

421 >ğ(
_å
)->
_wide_d©a
->
_IO_»ad_’d
), 0) \

422 ? 
	`__wuæow
 (
_å
è: (
_IO_wšt_t
è*(_å)->
_wide_d©a
->
_IO_»ad_±r
++)

	)

423 
	#_IO_putwc_uÆocked
(
_wch
, 
_å
) \

424 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

425 || ((
_å
)->
_wide_d©a
->
_IO_wr™e_±r
 \

426 >ğ(
_å
)->
_wide_d©a
->
_IO_wr™e_’d
), 0) \

427 ? 
	`__wov”æow
 (
_å
, 
_wch
) \

428 : (
_IO_wšt_t
è(*(
_å
)->
_wide_d©a
->
_IO_wr™e_±r
++ = (
_wch
)))

	)

431 
	#_IO_ãof_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_EOF_SEEN
è!ğ0)

	)

432 
	#_IO_ã¼Ü_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_ERR_SEEN
è!ğ0)

	)

434 
_IO_g‘c
 (
_IO_FILE
 *
__å
);

435 
_IO_putc
 (
__c
, 
_IO_FILE
 *
__å
);

436 
_IO_ãof
 (
_IO_FILE
 *
__å
è
__THROW
;

437 
_IO_ã¼Ü
 (
_IO_FILE
 *
__å
è
__THROW
;

439 
_IO_³ekc_locked
 (
_IO_FILE
 *
__å
);

442 
	#_IO_PENDING_OUTPUT_COUNT
(
_å
) \

443 ((
_å
)->
_IO_wr™e_±r
 - (_å)->
_IO_wr™e_ba£
)

	)

445 
_IO_æockfe
 (
_IO_FILE
 *è
__THROW
;

446 
_IO_fuÆockfe
 (
_IO_FILE
 *è
__THROW
;

447 
_IO_árylockfe
 (
_IO_FILE
 *è
__THROW
;

449 #ifdeà
_IO_MTSAFE_IO


450 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_locked
 (_å)

	)

451 
	#_IO_æockfe
(
_å
) \

452 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_æockfe
 (_å)

	)

453 
	#_IO_fuÆockfe
(
_å
) \

454 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_fuÆockfe
 (_å)

	)

456 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_uÆocked
 (_å)

	)

457 
	#_IO_æockfe
(
_å
è

	)

458 
	#_IO_fuÆockfe
(
_å
è

	)

459 
	#_IO_árylockfe
(
_å
è

	)

460 
	#_IO_ş—nup_»giÚ_¡¬t
(
_fù
, 
_å
è

	)

461 
	#_IO_ş—nup_»giÚ_’d
(
_Do™
è

	)

464 
_IO_vfsÿnf
 (
_IO_FILE
 * 
__»¡riù
, const * __restrict,

465 
_IO_va_li¡
, *
__»¡riù
);

466 
_IO_vårštf
 (
_IO_FILE
 *
__»¡riù
, const *__restrict,

467 
_IO_va_li¡
);

468 
_IO_ssize_t
 
_IO_·dn
 (
_IO_FILE
 *, , _IO_ssize_t);

469 
_IO_size_t
 
_IO_sg‘n
 (
_IO_FILE
 *, *, _IO_size_t);

471 
_IO_off64_t
 
_IO_£ekoff
 (
_IO_FILE
 *, _IO_off64_t, , );

472 
_IO_off64_t
 
_IO_£ekpos
 (
_IO_FILE
 *, _IO_off64_t, );

474 
_IO_ä“_backup_¬—
 (
_IO_FILE
 *è
__THROW
;

476 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


477 
_IO_wšt_t
 
_IO_g‘wc
 (
_IO_FILE
 *
__å
);

478 
_IO_wšt_t
 
_IO_putwc
 (
wch¬_t
 
__wc
, 
_IO_FILE
 *
__å
);

479 
_IO_fwide
 (
_IO_FILE
 *
__å
, 
__mode
è
__THROW
;

480 #ià
__GNUC__
 >= 2

483 #ià
defšed
 
_LIBC
 && defšed 
SHARED


484 
	~<shlib-com·t.h
>

485 #ià
SHLIB_COMPAT
 (
libc
, 
GLIBC_2_0
, 
GLIBC_2_1
)

486 
	#_IO_fwide_maybe_šcom·tibË
 \

487 (
	`__butš_ex³ù
 (&
_IO_¡dš_u£d
 =ğ
NULL
, 0))

	)

488 cÚ¡ 
_IO_¡dš_u£d
;

489 
w—k_ex‹º
 (
_IO_¡dš_u£d
);

492 #iâdeà
_IO_fwide_maybe_šcom·tibË


493 
	#_IO_fwide_maybe_šcom·tibË
 (0)

	)

497 
	#_IO_fwide
(
__å
, 
__mode
) \

498 ({ 
__»suÉ
 = (
__mode
); \

499 ià(
__»suÉ
 < 0 && ! 
_IO_fwide_maybe_šcom·tibË
) \

501 ià((
__å
)->
_mode
 == 0) \

503 (
__å
)->
_mode
 = -1; \

504 
__»suÉ
 = (
__å
)->
_mode
; \

506 ià(
	`__butš_cÚ¡ªt_p
 (
__mode
) && (__mode) == 0) \

507 
__»suÉ
 = 
_IO_fwide_maybe_šcom·tibË
 ? -1 : (
__å
)->
_mode
; \

509 
__»suÉ
 = 
	`_IO_fwide
 (
__å
, __result); \

510 
__»suÉ
; })

	)

513 
_IO_vfwsÿnf
 (
_IO_FILE
 * 
__»¡riù
, cÚ¡ 
wch¬_t
 * __restrict,

514 
_IO_va_li¡
, *
__»¡riù
);

515 
_IO_vfw´štf
 (
_IO_FILE
 *
__»¡riù
, cÚ¡ 
wch¬_t
 *__restrict,

516 
_IO_va_li¡
);

517 
_IO_ssize_t
 
_IO_w·dn
 (
_IO_FILE
 *, 
wšt_t
, _IO_ssize_t);

518 
_IO_ä“_wbackup_¬—
 (
_IO_FILE
 *è
__THROW
;

521 #ifdeà
__LDBL_COMPAT


522 
	~<b™s/libio-ldbl.h
>

525 #ifdeà
__ılu¥lus


	@/usr/include/rpc/netdb.h

36 #iâdeà
_RPC_NETDB_H


37 
	#_RPC_NETDB_H
 1

	)

39 
	~<ã©u»s.h
>

41 
	#__Ãed_size_t


	)

42 
	~<¡ddef.h
>

44 
__BEGIN_DECLS


46 
	s½ûÁ


48 *
	mr_Çme
;

49 **
	mr_®Ÿ£s
;

50 
	mr_numb”
;

53 
	$£ŒpûÁ
 (
__¡ayİ’
è
__THROW
;

54 
	$’d½ûÁ
 (è
__THROW
;

55 
½ûÁ
 *
	$g‘½cbyÇme
 (cÚ¡ *
__Çme
è
__THROW
;

56 
½ûÁ
 *
	$g‘½cbynumb”
 (
__numb”
è
__THROW
;

57 
½ûÁ
 *
	$g‘½ûÁ
 (è
__THROW
;

59 #ifdeà
__USE_MISC


60 
	$g‘½cbyÇme_r
 (cÚ¡ *
__Çme
, 
½ûÁ
 *
__»suÉ_buf
,

61 *
__bufãr
, 
size_t
 
__buæ’
,

62 
½ûÁ
 **
__»suÉ
è
__THROW
;

64 
	$g‘½cbynumb”_r
 (
__numb”
, 
½ûÁ
 *
__»suÉ_buf
,

65 *
__bufãr
, 
size_t
 
__buæ’
,

66 
½ûÁ
 **
__»suÉ
è
__THROW
;

68 
	$g‘½ûÁ_r
 (
½ûÁ
 *
__»suÉ_buf
, *
__bufãr
,

69 
size_t
 
__buæ’
, 
½ûÁ
 **
__»suÉ
è
__THROW
;

72 
__END_DECLS


	@/usr/include/sched.h

19 #iâdef 
_SCHED_H


20 
	#_SCHED_H
 1

	)

22 
	~<ã©u»s.h
>

25 
	~<b™s/ty³s.h
>

27 
	#__Ãed_size_t


	)

28 
	~<¡ddef.h
>

30 
	#__Ãed_time_t


	)

31 
	#__Ãed_time¥ec


	)

32 
	~<time.h
>

34 #iâdeà
__pid_t_defšed


35 
__pid_t
 
	tpid_t
;

36 
	#__pid_t_defšed


	)

41 
	~<b™s/sched.h
>

43 
	#sched_´iÜ™y
 
__sched_´iÜ™y


	)

46 
__BEGIN_DECLS


49 
	$sched_£¬am
 (
__pid_t
 
__pid
, cÚ¡ 
sched_·¿m
 *
__·¿m
)

50 
__THROW
;

53 
	$sched_g‘·¿m
 (
__pid_t
 
__pid
, 
sched_·¿m
 *
__·¿m
è
__THROW
;

56 
	$sched_£tscheduËr
 (
__pid_t
 
__pid
, 
__pŞicy
,

57 cÚ¡ 
sched_·¿m
 *
__·¿m
è
__THROW
;

60 
	$sched_g‘scheduËr
 (
__pid_t
 
__pid
è
__THROW
;

63 
	$sched_y›ld
 (è
__THROW
;

66 
	$sched_g‘_´iÜ™y_max
 (
__®gÜ™hm
è
__THROW
;

69 
	$sched_g‘_´iÜ™y_mš
 (
__®gÜ™hm
è
__THROW
;

72 
	$sched_¼_g‘_š‹rv®
 (
__pid_t
 
__pid
, 
time¥ec
 *
__t
è
__THROW
;

75 #ifdeà
__USE_GNU


77 
	#CPU_SETSIZE
 
__CPU_SETSIZE


	)

78 
	#CPU_SET
(
ıu
, 
ıu£
è
	`__CPU_SET_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

79 
	#CPU_CLR
(
ıu
, 
ıu£
è
	`__CPU_CLR_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

80 
	#CPU_ISSET
(
ıu
, 
ıu£
è
	`__CPU_ISSET_S
 (ıu,  (
ıu_£t_t
), \

81 
ıu£
)

	)

82 
	#CPU_ZERO
(
ıu£
è
	`__CPU_ZERO_S
 ( (
ıu_£t_t
), cpu£)

	)

83 
	#CPU_COUNT
(
ıu£
è
	`__CPU_COUNT_S
 ( (
ıu_£t_t
), cpu£)

	)

85 
	#CPU_SET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_SET_S
 (ıu, s‘size, cpu£)

	)

86 
	#CPU_CLR_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_CLR_S
 (ıu, s‘size, cpu£)

	)

87 
	#CPU_ISSET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_ISSET_S
 (cpu, setsize, \

88 
ıu£
)

	)

89 
	#CPU_ZERO_S
(
£tsize
, 
ıu£
è
	`__CPU_ZERO_S
 (£tsize, cpu£)

	)

90 
	#CPU_COUNT_S
(
£tsize
, 
ıu£
è
	`__CPU_COUNT_S
 (£tsize, cpu£)

	)

92 
	#CPU_EQUAL
(
ıu£1
, 
ıu£2
) \

93 
	`__CPU_EQUAL_S
 ( (
ıu_£t_t
), 
ıu£1
, 
ıu£2
)

	)

94 
	#CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

95 
	`__CPU_EQUAL_S
 (
£tsize
, 
ıu£1
, 
ıu£2
)

	)

97 
	#CPU_AND
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

98 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

99 
	#CPU_OR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

100 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

101 
	#CPU_XOR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

102 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

103 
	#CPU_AND_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

104 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

105 
	#CPU_OR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

106 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

107 
	#CPU_XOR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

108 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

110 
	#CPU_ALLOC_SIZE
(
couÁ
è
	`__CPU_ALLOC_SIZE
 (couÁ)

	)

111 
	#CPU_ALLOC
(
couÁ
è
	`__CPU_ALLOC
 (couÁ)

	)

112 
	#CPU_FREE
(
ıu£t
è
	`__CPU_FREE
 (ıu£t)

	)

116 
	$sched_£ffš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

117 cÚ¡ 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

120 
	$sched_g‘affš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

121 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

124 
__END_DECLS


	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

54 
	#__STDC_ISO_10646__
 201103L

	)

57 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tŞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/_G_config.h

4 #iâdeà
_G_cÚfig_h


5 
	#_G_cÚfig_h
 1

	)

9 
	~<b™s/ty³s.h
>

10 
	#__Ãed_size_t


	)

11 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


12 
	#__Ãed_wch¬_t


	)

14 
	#__Ãed_NULL


	)

15 
	~<¡ddef.h
>

16 
	#__Ãed_mb¡©e_t


	)

17 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


18 
	#__Ãed_wšt_t


	)

20 
	~<wch¬.h
>

23 
__off_t
 
	m__pos
;

24 
__mb¡©e_t
 
	m__¡©e
;

25 } 
	t_G_åos_t
;

28 
__off64_t
 
	m__pos
;

29 
__mb¡©e_t
 
	m__¡©e
;

30 } 
	t_G_åos64_t
;

31 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


32 
	~<gcÚv.h
>

35 
__gcÚv_šfo
 
	m__cd
;

38 
__gcÚv_šfo
 
	m__cd
;

39 
__gcÚv_¡•_d©a
 
	m__d©a
;

40 } 
	m__combšed
;

41 } 
	t_G_icÚv_t
;

46 
	#_G_va_li¡
 
__gnuc_va_li¡


	)

48 
	#_G_HAVE_MMAP
 1

	)

49 
	#_G_HAVE_MREMAP
 1

	)

51 
	#_G_IO_IO_FILE_VERSION
 0x20001

	)

54 
	#_G_HAVE_ST_BLKSIZE
 
	`defšed
 (
_STATBUF_ST_BLKSIZE
)

	)

56 
	#_G_BUFSIZ
 8192

	)

	@/usr/include/gconv.h

22 #iâdeà
_GCONV_H


23 
	#_GCONV_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	#__Ãed_mb¡©e_t


	)

27 
	#__Ãed_wšt_t


	)

28 
	~<wch¬.h
>

29 
	#__Ãed_size_t


	)

30 
	#__Ãed_wch¬_t


	)

31 
	~<¡ddef.h
>

34 
	#__UNKNOWN_10646_CHAR
 ((
wch¬_t
è0xfffd)

	)

39 
	m__GCONV_OK
 = 0,

40 
	m__GCONV_NOCONV
,

41 
	m__GCONV_NODB
,

42 
	m__GCONV_NOMEM
,

44 
	m__GCONV_EMPTY_INPUT
,

45 
	m__GCONV_FULL_OUTPUT
,

46 
	m__GCONV_ILLEGAL_INPUT
,

47 
	m__GCONV_INCOMPLETE_INPUT
,

49 
	m__GCONV_ILLEGAL_DESCRIPTOR
,

50 
	m__GCONV_INTERNAL_ERROR


57 
	m__GCONV_IS_LAST
 = 0x0001,

58 
	m__GCONV_IGNORE_ERRORS
 = 0x0002,

59 
	m__GCONV_SWAP
 = 0x0004

64 
	g__gcÚv_¡•
;

65 
	g__gcÚv_¡•_d©a
;

66 
	g__gcÚv_lßded_objeù
;

67 
	g__gcÚv_Œªs_d©a
;

71 (*
	t__gcÚv_fù
è(
	t__gcÚv_¡•
 *, 
	t__gcÚv_¡•_d©a
 *,

73 **, 
	tsize_t
 *, , );

76 
	$wšt_t
 (*
	t__gcÚv_btowc_fù
è(
	t__gcÚv_¡•
 *, );

79 (*
	t__gcÚv_š™_fù
è(
	t__gcÚv_¡•
 *);

80 (*
	t__gcÚv_’d_fù
è(
	t__gcÚv_¡•
 *);

84 (*
	t__gcÚv_Œªs_fù
è(
	t__gcÚv_¡•
 *,

85 
	t__gcÚv_¡•_d©a
 *, *,

89 
	tsize_t
 *);

92 (*
	t__gcÚv_Œªs_cÚ‹xt_fù
) (*, const *,

97 (*
	t__gcÚv_Œªs_qu”y_fù
) (const *, const ***,

98 
	tsize_t
 *);

101 (*
	t__gcÚv_Œªs_š™_fù
) (**, const *);

102 (*
	t__gcÚv_Œªs_’d_fù
) (*);

104 
	s__gcÚv_Œªs_d©a


107 
__gcÚv_Œªs_fù
 
__Œªs_fù
;

108 
__gcÚv_Œªs_cÚ‹xt_fù
 
__Œªs_cÚ‹xt_fù
;

109 
__gcÚv_Œªs_’d_fù
 
__Œªs_’d_fù
;

110 *
__d©a
;

111 
__gcÚv_Œªs_d©a
 *
__Ãxt
;

116 
	s__gcÚv_¡•


118 
__gcÚv_lßded_objeù
 *
__shlib_hªdË
;

119 cÚ¡ *
__modÇme
;

121 
__couÁ”
;

123 *
__äom_Çme
;

124 *
__to_Çme
;

126 
__gcÚv_fù
 
__fù
;

127 
__gcÚv_btowc_fù
 
__btowc_fù
;

128 
__gcÚv_š™_fù
 
__š™_fù
;

129 
__gcÚv_’d_fù
 
__’d_fù
;

133 
__mš_Ãeded_äom
;

134 
__max_Ãeded_äom
;

135 
__mš_Ãeded_to
;

136 
__max_Ãeded_to
;

139 
__¡©eful
;

141 *
__d©a
;

146 
	s__gcÚv_¡•_d©a


148 *
__outbuf
;

149 *
__outbuãnd
;

153 
__æags
;

157 
__švoÿtiÚ_couÁ”
;

161 
__š‹º®_u£
;

163 
__mb¡©e_t
 *
__¡©•
;

164 
__mb¡©e_t
 
__¡©e
;

168 
__gcÚv_Œªs_d©a
 *
__Œªs
;

173 
	s__gcÚv_šfo


175 
size_t
 
__n¡•s
;

176 
__gcÚv_¡•
 *
__¡•s
;

177 
__ex‹nsiÚ__
 
__gcÚv_¡•_d©a
 
__d©a
 
__æex¬r
;

178 } *
	t__gcÚv_t
;

	@/usr/include/wchar.h

23 #iâdeà
_WCHAR_H


25 #ià!
defšed
 
__Ãed_mb¡©e_t
 && !defšed 
__Ãed_wšt_t


26 
	#_WCHAR_H
 1

	)

27 
	~<ã©u»s.h
>

30 #ifdeà
_WCHAR_H


32 
	#__Ãed___FILE


	)

33 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


34 
	#__Ãed_FILE


	)

36 
	~<¡dio.h
>

38 
	#__Ãed___va_li¡


	)

39 
	~<¡d¬g.h
>

41 
	~<b™s/wch¬.h
>

44 
	#__Ãed_size_t


	)

45 
	#__Ãed_wch¬_t


	)

46 
	#__Ãed_NULL


	)

48 #ià
defšed
 
_WCHAR_H
 || defšed 
__Ãed_wšt_t
 || !defšed 
__WINT_TYPE__


49 #undeà
__Ãed_wšt_t


50 
	#__Ãed_wšt_t


	)

51 
	~<¡ddef.h
>

55 #iâdeà
_WINT_T


60 
	#_WINT_T


	)

61 
	twšt_t
;

65 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES
 \

66 && 
defšed
 
__WINT_TYPE__


67 
__BEGIN_NAMESPACE_STD


68 
__WINT_TYPE__
 
	twšt_t
;

69 
	g__END_NAMESPACE_STD


74 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

75 
	#__CORRECT_ISO_CPP_WCHAR_H_PROTO


	)

79 #ià(
defšed
 
_WCHAR_H
 || defšed 
__Ãed_mb¡©e_t
è&& !defšed 
____mb¡©e_t_defšed


80 
	#____mb¡©e_t_defšed
 1

	)

84 
	m__couÁ
;

87 #ifdeà
__WINT_TYPE__


88 
__WINT_TYPE__
 
	m__wch
;

90 
wšt_t
 
	m__wch
;

92 
	m__wchb
[4];

93 } 
	m__v®ue
;

94 } 
	t__mb¡©e_t
;

96 #undeà
__Ãed_mb¡©e_t


101 #ifdeà
_WCHAR_H


103 #iâdeà
__mb¡©e_t_defšed


104 
__BEGIN_NAMESPACE_C99


106 
__mb¡©e_t
 
	tmb¡©e_t
;

107 
	g__END_NAMESPACE_C99


108 
	#__mb¡©e_t_defšed
 1

	)

111 #ifdeà
__USE_GNU


112 
	$__USING_NAMESPACE_C99
(
mb¡©e_t
)

115 #iâdeà
WCHAR_MIN


117 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

118 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

121 #iâdeà
WEOF


122 
	#WEOF
 (0xffffffffu)

	)

127 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_UNIX98


128 
	~<wùy³.h
>

132 
__BEGIN_DECLS


134 
__BEGIN_NAMESPACE_STD


137 
tm
;

138 
__END_NAMESPACE_STD


142 
	$__USING_NAMESPACE_STD
(
tm
)

145 
__BEGIN_NAMESPACE_STD


147 
wch¬_t
 *
	$wcsıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

148 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

150 
wch¬_t
 *
	$wc¢ıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

151 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

152 
__THROW
;

155 
wch¬_t
 *
	$wcsÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

156 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

158 
wch¬_t
 *
	$wc¢ÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

159 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

160 
__THROW
;

163 
	$wcscmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
)

164 
__THROW
 
__©Œibu‹_pu»__
;

166 
	$wc¢cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

167 
__THROW
 
__©Œibu‹_pu»__
;

168 
__END_NAMESPACE_STD


170 #ifdeà
__USE_XOPEN2K8


172 
	$wcsÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

175 
	$wc¢ÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

176 
size_t
 
__n
è
__THROW
;

180 
	~<xloÿË.h
>

182 
	$wcsÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

183 
__loÿË_t
 
__loc
è
__THROW
;

185 
	$wc¢ÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

186 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

189 
__BEGIN_NAMESPACE_STD


192 
	$wcscŞl
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

196 
size_t
 
	$wcsxäm
 (
wch¬_t
 *
__»¡riù
 
__s1
,

197 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

198 
__END_NAMESPACE_STD


200 #ifdeà
__USE_XOPEN2K8


206 
	$wcscŞl_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

207 
__loÿË_t
 
__loc
è
__THROW
;

212 
size_t
 
	$wcsxäm_l
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

213 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

216 
wch¬_t
 *
	$wcsdup
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_m®loc__
;

219 
__BEGIN_NAMESPACE_STD


221 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


222 "C++" 
wch¬_t
 *
	$wcschr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

223 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

224 "C++" cÚ¡ 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

225 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

227 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

228 
__THROW
 
__©Œibu‹_pu»__
;

231 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


232 "C++" 
wch¬_t
 *
	$wc¤chr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

233 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

234 "C++" cÚ¡ 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

235 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

237 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

238 
__THROW
 
__©Œibu‹_pu»__
;

240 
__END_NAMESPACE_STD


242 #ifdeà
__USE_GNU


245 
wch¬_t
 *
	$wcschºul
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__wc
)

246 
__THROW
 
__©Œibu‹_pu»__
;

249 
__BEGIN_NAMESPACE_STD


252 
size_t
 
	$wcsc¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__»jeù
)

253 
__THROW
 
__©Œibu‹_pu»__
;

256 
size_t
 
	$wcs¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

257 
__THROW
 
__©Œibu‹_pu»__
;

259 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


260 "C++" 
wch¬_t
 *
	$wc¥brk
 (
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

261 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

262 "C++" cÚ¡ 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
,

263 cÚ¡ 
wch¬_t
 *
__acû±
)

264 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

266 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

267 
__THROW
 
__©Œibu‹_pu»__
;

270 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


271 "C++" 
wch¬_t
 *
	$wcs¡r
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

272 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

273 "C++" cÚ¡ 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

274 cÚ¡ 
wch¬_t
 *
__ÃedË
)

275 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

277 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

278 
__THROW
 
__©Œibu‹_pu»__
;

282 
wch¬_t
 *
	$wc¡ok
 (
wch¬_t
 *
__»¡riù
 
__s
,

283 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__d–im
,

284 
wch¬_t
 **
__»¡riù
 
__±r
è
__THROW
;

287 
size_t
 
	$wc¦’
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_pu»__
;

288 
__END_NAMESPACE_STD


290 #ifdeà
__USE_XOPEN


292 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


293 "C++" 
wch¬_t
 *
	$wcswcs
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

294 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

295 "C++" cÚ¡ 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

296 cÚ¡ 
wch¬_t
 *
__ÃedË
)

297 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

299 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

300 
__THROW
 
__©Œibu‹_pu»__
;

304 #ifdeà
__USE_XOPEN2K8


306 
size_t
 
	$wc¢Ën
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__maxËn
)

307 
__THROW
 
__©Œibu‹_pu»__
;

311 
__BEGIN_NAMESPACE_STD


313 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


314 "C++" 
wch¬_t
 *
	$wmemchr
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

315 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

316 "C++" cÚ¡ 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
,

317 
size_t
 
__n
)

318 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

320 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

321 
__THROW
 
__©Œibu‹_pu»__
;

325 
	$wmemcmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

326 
__THROW
 
__©Œibu‹_pu»__
;

329 
wch¬_t
 *
	$wmemıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

330 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

334 
wch¬_t
 *
	$wmemmove
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

335 
__THROW
;

338 
wch¬_t
 *
	$wmem£t
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
è
__THROW
;

339 
__END_NAMESPACE_STD


341 #ifdeà
__USE_GNU


344 
wch¬_t
 *
	$wmempıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

345 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

346 
__THROW
;

350 
__BEGIN_NAMESPACE_STD


353 
wšt_t
 
	$btowc
 (
__c
è
__THROW
;

357 
	$wùob
 (
wšt_t
 
__c
è
__THROW
;

361 
	$mbsš™
 (cÚ¡ 
mb¡©e_t
 *
__ps
è
__THROW
 
__©Œibu‹_pu»__
;

365 
size_t
 
	$mb¹owc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

366 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

367 
mb¡©e_t
 *
__»¡riù
 
__p
è
__THROW
;

370 
size_t
 
	$wütomb
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wc
,

371 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

374 
size_t
 
	$__mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

375 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

376 
size_t
 
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

377 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

378 
__END_NAMESPACE_STD


380 #ifdeà
__USE_EXTERN_INLINES


386 
wšt_t
 
	$__btowc_®Ÿs
 (
__c
è
	`__asm
 ("btowc");

387 
__ex‹º_šlše
 
wšt_t


388 
	`__NTH
 (
	$btowc
 (
__c
))

389 {  (
	`__butš_cÚ¡ªt_p
 (
__c
) && __c >= '\0' && __c <= '\x7f'

390 ? (
wšt_t
è
__c
 : 
	`__btowc_®Ÿs
 (__c)); 
	}
}

392 
	$__wùob_®Ÿs
 (
wšt_t
 
__c
è
	`__asm
 ("wctob");

393 
__ex‹º_šlše
 

394 
	`__NTH
 (
	$wùob
 (
wšt_t
 
__wc
))

395 {  (
	`__butš_cÚ¡ªt_p
 (
__wc
è&& __wø>ğ
L
'\0' && __wc <= L'\x7f'

396 ? (è
__wc
 : 
	`__wùob_®Ÿs
 (__wc)); 
	}
}

398 
__ex‹º_šlše
 
size_t


399 
__NTH
 (
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

400 
mb¡©e_t
 *
__»¡riù
 
__ps
))

401 {  (
__ps
 !ğ
NULL


402 ? 
	`mb¹owc
 (
NULL
, 
__s
, 
__n
, 
__ps
è: 
	`__mb¾’
 (__s, __n, NULL)); 
	}
}

405 
__BEGIN_NAMESPACE_STD


408 
size_t
 
	$mb¤towcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

409 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

410 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

414 
size_t
 
	$wc¤tombs
 (*
__»¡riù
 
__d¡
,

415 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

416 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

417 
__END_NAMESPACE_STD


420 #ifdef 
__USE_XOPEN2K8


423 
size_t
 
	$mb¢¹owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

424 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

425 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

429 
size_t
 
	$wc¢¹ombs
 (*
__»¡riù
 
__d¡
,

430 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
,

431 
size_t
 
__nwc
, size_ˆ
__Ën
,

432 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

437 #ifdeà
__USE_XOPEN


439 
	$wcwidth
 (
wch¬_t
 
__c
è
__THROW
;

443 
	$wcswidth
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__n
è
__THROW
;

447 
__BEGIN_NAMESPACE_STD


450 
	$wc¡od
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

451 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

452 
__END_NAMESPACE_STD


454 #ifdeà
__USE_ISOC99


455 
__BEGIN_NAMESPACE_C99


457 
	$wc¡of
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

458 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

459 
	$wc¡Şd
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

460 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

461 
__END_NAMESPACE_C99


465 
__BEGIN_NAMESPACE_STD


468 
	$wc¡Ş
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

469 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

473 
	$wc¡oul
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

474 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

475 
__THROW
;

476 
__END_NAMESPACE_STD


478 #ifdeà
__USE_ISOC99


479 
__BEGIN_NAMESPACE_C99


482 
__ex‹nsiÚ__


483 
	$wc¡Şl
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

484 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

485 
__THROW
;

489 
__ex‹nsiÚ__


490 
	$wc¡ouÎ
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

491 
wch¬_t
 **
__»¡riù
 
__’d±r
,

492 
__ba£
è
__THROW
;

493 
__END_NAMESPACE_C99


496 #ifdeà
__USE_GNU


499 
__ex‹nsiÚ__


500 
	$wc¡oq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

501 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

502 
__THROW
;

506 
__ex‹nsiÚ__


507 
	$wc¡ouq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

508 
wch¬_t
 **
__»¡riù
 
__’d±r
,

509 
__ba£
è
__THROW
;

512 #ifdeà
__USE_GNU


526 
	~<xloÿË.h
>

530 
	$wc¡Ş_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

531 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
,

532 
__loÿË_t
 
__loc
è
__THROW
;

534 
	$wc¡oul_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

535 
wch¬_t
 **
__»¡riù
 
__’d±r
,

536 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

538 
__ex‹nsiÚ__


539 
	$wc¡Şl_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

540 
wch¬_t
 **
__»¡riù
 
__’d±r
,

541 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

543 
__ex‹nsiÚ__


544 
	$wc¡ouÎ_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

545 
wch¬_t
 **
__»¡riù
 
__’d±r
,

546 
__ba£
, 
__loÿË_t
 
__loc
)

547 
__THROW
;

549 
	$wc¡od_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

550 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

551 
__THROW
;

553 
	$wc¡of_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

554 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

555 
__THROW
;

557 
	$wc¡Şd_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

558 
wch¬_t
 **
__»¡riù
 
__’d±r
,

559 
__loÿË_t
 
__loc
è
__THROW
;

563 #ifdeà
__USE_XOPEN2K8


566 
wch¬_t
 *
	$wııy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

567 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

571 
wch¬_t
 *
	$wınıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

572 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

573 
__THROW
;

580 
__FILE
 *
	$İ’_wmem¡»am
 (
wch¬_t
 **
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
;

583 #ià
defšed
 
__USE_ISOC95
 || defšed 
__USE_UNIX98


584 
__BEGIN_NAMESPACE_STD


587 
	$fwide
 (
__FILE
 *
__å
, 
__mode
è
__THROW
;

594 
	`fw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

595 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

601 
	`w´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

604 
	$sw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

605 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

606 
__THROW
 ;

612 
	`vfw´štf
 (
__FILE
 *
__»¡riù
 
__s
,

613 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

614 
__gnuc_va_li¡
 
__¬g
)

620 
	`vw´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

621 
__gnuc_va_li¡
 
__¬g
)

625 
	$vsw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

626 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

627 
__gnuc_va_li¡
 
__¬g
)

628 
__THROW
 ;

635 
	`fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

636 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

642 
	`wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

645 
	$swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

646 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

647 
__THROW
 ;

649 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

650 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

651 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

652 #ifdeà
__REDIRECT


656 
	`__REDIRECT
 (
fwsÿnf
, (
__FILE
 *
__»¡riù
 
__¡»am
,

657 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

658 
__isoc99_fwsÿnf
)

660 
	`__REDIRECT
 (
wsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

661 
__isoc99_wsÿnf
)

663 
	`__REDIRECT_NTH
 (
swsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

664 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

665 ...), 
__isoc99_swsÿnf
)

668 
	`__isoc99_fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

669 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

670 
	`__isoc99_wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

671 
	$__isoc99_swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

672 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

673 
__THROW
;

674 
	#fwsÿnf
 
__isoc99_fwsÿnf


	)

675 
	#wsÿnf
 
__isoc99_wsÿnf


	)

676 
	#swsÿnf
 
__isoc99_swsÿnf


	)

680 
__END_NAMESPACE_STD


683 #ifdeà
__USE_ISOC99


684 
__BEGIN_NAMESPACE_C99


689 
	`vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

690 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

691 
__gnuc_va_li¡
 
__¬g
)

697 
	`vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

698 
__gnuc_va_li¡
 
__¬g
)

701 
	$vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

702 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

703 
__gnuc_va_li¡
 
__¬g
)

704 
__THROW
 ;

706 #ià!
defšed
 
__USE_GNU
 \

707 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

708 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

709 #ifdeà
__REDIRECT


710 
	`__REDIRECT
 (
vfwsÿnf
, (
__FILE
 *
__»¡riù
 
__s
,

711 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

712 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vfwsÿnf
)

714 
	`__REDIRECT
 (
vwsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

715 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vwsÿnf
)

717 
	`__REDIRECT_NTH
 (
vswsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

718 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

719 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vswsÿnf
)

722 
	`__isoc99_vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

723 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

724 
__gnuc_va_li¡
 
__¬g
);

725 
	`__isoc99_vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

726 
__gnuc_va_li¡
 
__¬g
);

727 
	$__isoc99_vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

728 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

729 
__gnuc_va_li¡
 
__¬g
è
__THROW
;

730 
	#vfwsÿnf
 
__isoc99_vfwsÿnf


	)

731 
	#vwsÿnf
 
__isoc99_vwsÿnf


	)

732 
	#vswsÿnf
 
__isoc99_vswsÿnf


	)

736 
__END_NAMESPACE_C99


740 
__BEGIN_NAMESPACE_STD


745 
wšt_t
 
	`fg‘wc
 (
__FILE
 *
__¡»am
);

746 
wšt_t
 
	`g‘wc
 (
__FILE
 *
__¡»am
);

752 
wšt_t
 
	`g‘wch¬
 ();

759 
wšt_t
 
	`åutwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

760 
wšt_t
 
	`putwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

766 
wšt_t
 
	`putwch¬
 (
wch¬_t
 
__wc
);

774 
wch¬_t
 *
	`fg‘ws
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

775 
__FILE
 *
__»¡riù
 
__¡»am
);

781 
	`åutws
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

782 
__FILE
 *
__»¡riù
 
__¡»am
);

789 
wšt_t
 
	`ung‘wc
 (wšt_ˆ
__wc
, 
__FILE
 *
__¡»am
);

790 
__END_NAMESPACE_STD


793 #ifdeà
__USE_GNU


801 
wšt_t
 
	`g‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

802 
wšt_t
 
	`g‘wch¬_uÆocked
 ();

810 
wšt_t
 
	`fg‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

818 
wšt_t
 
	`åutwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

827 
wšt_t
 
	`putwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

828 
wšt_t
 
	`putwch¬_uÆocked
 (
wch¬_t
 
__wc
);

837 
wch¬_t
 *
	`fg‘ws_uÆocked
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

838 
__FILE
 *
__»¡riù
 
__¡»am
);

846 
	`åutws_uÆocked
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

847 
__FILE
 *
__»¡riù
 
__¡»am
);

851 
__BEGIN_NAMESPACE_C99


855 
size_t
 
	$wcsáime
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

856 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

857 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

858 
__END_NAMESPACE_C99


860 #ifdeà
__USE_GNU


861 
	~<xloÿË.h
>

865 
size_t
 
	$wcsáime_l
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

866 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

867 cÚ¡ 
tm
 *
__»¡riù
 
__
,

868 
__loÿË_t
 
__loc
è
__THROW
;

877 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_GNU


878 
	#__Ãed_iswxxx


	)

879 
	~<wùy³.h
>

883 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


884 
	~<b™s/wch¬2.h
>

887 #ifdeà
__LDBL_COMPAT


888 
	~<b™s/wch¬-ldbl.h
>

891 
__END_DECLS


899 #undeà
__Ãed_mb¡©e_t


900 #undeà
__Ãed_wšt_t


	@/usr/include/wctype.h

23 #iâdeà
_WCTYPE_H


25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 #iâdeà
__Ãed_iswxxx


29 
	#_WCTYPE_H
 1

	)

32 
	#__Ãed_wšt_t


	)

33 
	~<wch¬.h
>

37 #iâdeà
WEOF


38 
	#WEOF
 (0xffffffffu)

	)

41 #undeà
__Ãed_iswxxx


46 #iâdeà
__iswxxx_defšed


47 
	#__iswxxx_defšed
 1

	)

49 
__BEGIN_NAMESPACE_C99


52 
	twùy³_t
;

53 
	g__END_NAMESPACE_C99


55 #iâdeà
_ISwb™


60 
	~<’dŸn.h
>

61 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


62 
	#_ISwb™
(
b™
è(1 << (b™))

	)

64 
	#_ISwb™
(
b™
) \

65 ((
b™
) < 8 ? () ((1UL << (bit)) << 24) \

66 : ((
b™
) < 16 ? () ((1UL << (bit)) << 8) \

67 : ((
b™
) < 24 ? () ((1UL << (bit)) >> 8) \

68 : (è((1UL << (
b™
)è>> 24))))

	)

73 
	m__ISwuµ”
 = 0,

74 
	m__ISwlow”
 = 1,

75 
	m__ISw®pha
 = 2,

76 
	m__ISwdig™
 = 3,

77 
	m__ISwxdig™
 = 4,

78 
	m__ISw¥aû
 = 5,

79 
	m__ISw´št
 = 6,

80 
	m__ISwg¿ph
 = 7,

81 
	m__ISwbÏnk
 = 8,

82 
	m__ISwúŒl
 = 9,

83 
	m__ISwpunù
 = 10,

84 
	m__ISw®num
 = 11,

86 
	m_ISwuµ”
 = 
_ISwb™
 (
__ISwuµ”
),

87 
	m_ISwlow”
 = 
_ISwb™
 (
__ISwlow”
),

88 
	m_ISw®pha
 = 
_ISwb™
 (
__ISw®pha
),

89 
	m_ISwdig™
 = 
_ISwb™
 (
__ISwdig™
),

90 
	m_ISwxdig™
 = 
_ISwb™
 (
__ISwxdig™
),

91 
	m_ISw¥aû
 = 
_ISwb™
 (
__ISw¥aû
),

92 
	m_ISw´št
 = 
_ISwb™
 (
__ISw´št
),

93 
	m_ISwg¿ph
 = 
_ISwb™
 (
__ISwg¿ph
),

94 
	m_ISwbÏnk
 = 
_ISwb™
 (
__ISwbÏnk
),

95 
	m_ISwúŒl
 = 
_ISwb™
 (
__ISwúŒl
),

96 
	m_ISwpunù
 = 
_ISwb™
 (
__ISwpunù
),

97 
	m_ISw®num
 = 
_ISwb™
 (
__ISw®num
)

102 
__BEGIN_DECLS


104 
__BEGIN_NAMESPACE_C99


111 
	$isw®num
 (
wšt_t
 
__wc
è
__THROW
;

117 
	$isw®pha
 (
wšt_t
 
__wc
è
__THROW
;

120 
	$iswúŒl
 (
wšt_t
 
__wc
è
__THROW
;

124 
	$iswdig™
 (
wšt_t
 
__wc
è
__THROW
;

128 
	$iswg¿ph
 (
wšt_t
 
__wc
è
__THROW
;

133 
	$iswlow”
 (
wšt_t
 
__wc
è
__THROW
;

136 
	$isw´št
 (
wšt_t
 
__wc
è
__THROW
;

141 
	$iswpunù
 (
wšt_t
 
__wc
è
__THROW
;

146 
	$isw¥aû
 (
wšt_t
 
__wc
è
__THROW
;

151 
	$iswuµ”
 (
wšt_t
 
__wc
è
__THROW
;

156 
	$iswxdig™
 (
wšt_t
 
__wc
è
__THROW
;

161 #ifdeà
__USE_ISOC99


162 
	$iswbÏnk
 (
wšt_t
 
__wc
è
__THROW
;

171 
wùy³_t
 
	$wùy³
 (cÚ¡ *
__´İ”ty
è
__THROW
;

175 
	$iswùy³
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
è
__THROW
;

176 
__END_NAMESPACE_C99


183 
__BEGIN_NAMESPACE_C99


186 cÚ¡ 
	t__št32_t
 *
	twù¿ns_t
;

187 
__END_NAMESPACE_C99


188 #ifdeà
__USE_GNU


189 
	$__USING_NAMESPACE_C99
(
wù¿ns_t
)

192 
__BEGIN_NAMESPACE_C99


194 
wšt_t
 
	$towlow”
 (
wšt_t
 
__wc
è
__THROW
;

197 
wšt_t
 
	$towuµ”
 (
wšt_t
 
__wc
è
__THROW
;

198 
__END_NAMESPACE_C99


200 
__END_DECLS


207 #ifdeà
_WCTYPE_H


213 
__BEGIN_DECLS


215 
__BEGIN_NAMESPACE_C99


218 
wù¿ns_t
 
	$wù¿ns
 (cÚ¡ *
__´İ”ty
è
__THROW
;

221 
wšt_t
 
	$towù¿ns
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
è
__THROW
;

222 
__END_NAMESPACE_C99


224 #ifdeà
__USE_XOPEN2K8


226 
	~<xloÿË.h
>

230 
	$isw®num_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

236 
	$isw®pha_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

239 
	$iswúŒl_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

243 
	$iswdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

247 
	$iswg¿ph_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

252 
	$iswlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

255 
	$isw´št_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

260 
	$iswpunù_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

265 
	$isw¥aû_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

270 
	$iswuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

275 
	$iswxdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

280 
	$iswbÏnk_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

284 
wùy³_t
 
	$wùy³_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

285 
__THROW
;

289 
	$iswùy³_l
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
, 
__loÿË_t
 
__loÿË
)

290 
__THROW
;

298 
wšt_t
 
	$towlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

301 
wšt_t
 
	$towuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

305 
wù¿ns_t
 
	$wù¿ns_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

306 
__THROW
;

309 
wšt_t
 
	$towù¿ns_l
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
,

310 
__loÿË_t
 
__loÿË
è
__THROW
;

314 
__END_DECLS


	@
1
.
1
/usr/include
150
1998
adlist.c
adlist.h
ae.c
ae.h
ae_epoll.c
ae_evport.c
ae_kqueue.c
ae_select.c
anet.c
anet.h
aof.c
asciilogo.h
atomicvar.h
bio.c
bio.h
bitops.c
blocked.c
cluster.c
cluster.h
config.c
config.h
crc16.c
crc64.c
crc64.h
db.c
debug.c
dict.c
dict.h
endianconv.c
endianconv.h
evict.c
expire.c
fmacros.h
geo.c
geo.h
geohash.c
geohash.h
geohash_helper.c
geohash_helper.h
help.h
hyperloglog.c
intset.c
intset.h
latency.c
latency.h
lazyfree.c
lzf.h
lzfP.h
lzf_c.c
lzf_d.c
memtest.c
module.c
modules/hellotype.c
modules/helloworld.c
multi.c
networking.c
notify.c
object.c
pqsort.c
pqsort.h
pubsub.c
quicklist.c
quicklist.h
rand.c
rand.h
rdb.c
rdb.h
redis-benchmark.c
redis-check-aof.c
redis-check-rdb.c
redis-cli.c
redisassert.h
redismodule.h
release.c
replication.c
rio.c
rio.h
scripting.c
sds.c
sds.h
sdsalloc.h
sentinel.c
server.c
server.h
setproctitle.c
sha1.c
sha1.h
slowlog.c
slowlog.h
solarisfixes.h
sort.c
sparkline.c
sparkline.h
syncio.c
t_hash.c
t_list.c
t_set.c
t_string.c
t_zset.c
testhelp.h
util.c
util.h
version.h
ziplist.c
ziplist.h
zipmap.c
zipmap.h
zmalloc.c
zmalloc.h
/usr/include/arpa/inet.h
/usr/include/assert.h
/usr/include/ctype.h
/usr/include/dlfcn.h
/usr/include/endian.h
/usr/include/errno.h
/usr/include/execinfo.h
/usr/include/fcntl.h
/usr/include/features.h
/usr/include/inttypes.h
/usr/include/limits.h
/usr/include/linux/version.h
/usr/include/locale.h
/usr/include/math.h
/usr/include/netdb.h
/usr/include/netinet/in.h
/usr/include/netinet/tcp.h
/usr/include/poll.h
/usr/include/pthread.h
/usr/include/signal.h
/usr/include/stdint.h
/usr/include/stdio.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/stropts.h
/usr/include/syslog.h
/usr/include/termios.h
/usr/include/time.h
/usr/include/ucontext.h
/usr/include/unistd.h
/usr/include/alloca.h
/usr/include/getopt.h
/usr/include/libio.h
/usr/include/rpc/netdb.h
/usr/include/sched.h
/usr/include/stdc-predef.h
/usr/include/xlocale.h
/usr/include/_G_config.h
/usr/include/gconv.h
/usr/include/wchar.h
/usr/include/wctype.h
